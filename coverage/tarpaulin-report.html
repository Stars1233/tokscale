<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","auth.rs"],"content":"use anyhow::{Context, Result};\nuse serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::io::Write;\nuse std::path::PathBuf;\n\nfn home_dir() -\u003e Result\u003cPathBuf\u003e {\n    dirs::home_dir().context(\"Could not determine home directory\")\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Credentials {\n    pub token: String,\n    pub username: String,\n    #[serde(rename = \"avatarUrl\", skip_serializing_if = \"Option::is_none\")]\n    pub avatar_url: Option\u003cString\u003e,\n    #[serde(rename = \"createdAt\")]\n    pub created_at: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct DeviceCodeResponse {\n    #[serde(rename = \"deviceCode\")]\n    device_code: String,\n    #[serde(rename = \"userCode\")]\n    user_code: String,\n    #[serde(rename = \"verificationUrl\")]\n    verification_url: String,\n    #[serde(rename = \"expiresIn\")]\n    #[allow(dead_code)]\n    expires_in: u64,\n    interval: u64,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PollResponse {\n    status: String,\n    token: Option\u003cString\u003e,\n    user: Option\u003cUserInfo\u003e,\n    #[allow(dead_code)]\n    error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct UserInfo {\n    username: String,\n    #[serde(rename = \"avatarUrl\")]\n    avatar_url: Option\u003cString\u003e,\n}\n\nfn get_credentials_path() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".config/tokscale/credentials.json\"))\n}\n\nfn ensure_config_dir() -\u003e Result\u003c()\u003e {\n    let config_dir = home_dir()?.join(\".config/tokscale\");\n\n    if !config_dir.exists() {\n        fs::create_dir_all(\u0026config_dir)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(\u0026config_dir, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n    Ok(())\n}\n\npub fn save_credentials(credentials: \u0026Credentials) -\u003e Result\u003c()\u003e {\n    ensure_config_dir()?;\n    let path = get_credentials_path()?;\n    let json = serde_json::to_string_pretty(credentials)?;\n\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::OpenOptionsExt;\n\n        let mut file = fs::OpenOptions::new()\n            .create(true)\n            .write(true)\n            .truncate(true)\n            .mode(0o600)\n            .open(\u0026path)?;\n        file.write_all(json.as_bytes())?;\n    }\n\n    #[cfg(not(unix))]\n    {\n        fs::write(\u0026path, json)?;\n    }\n\n    Ok(())\n}\n\npub fn load_credentials() -\u003e Option\u003cCredentials\u003e {\n    let path = get_credentials_path().ok()?;\n    if !path.exists() {\n        return None;\n    }\n\n    let content = fs::read_to_string(path).ok()?;\n    serde_json::from_str(\u0026content).ok()\n}\n\npub fn clear_credentials() -\u003e Result\u003cbool\u003e {\n    let path = get_credentials_path()?;\n    if path.exists() {\n        fs::remove_file(path)?;\n        Ok(true)\n    } else {\n        Ok(false)\n    }\n}\n\npub fn get_api_base_url() -\u003e String {\n    std::env::var(\"TOKSCALE_API_URL\").unwrap_or_else(|_| \"https://tokscale.ai\".to_string())\n}\n\nfn get_device_name() -\u003e String {\n    let hostname = hostname::get()\n        .ok()\n        .and_then(|h| h.into_string().ok())\n        .unwrap_or_else(|| \"unknown\".to_string());\n    format!(\"CLI on {}\", hostname)\n}\n\nfn open_browser(url: \u0026str) {\n    #[cfg(target_os = \"macos\")]\n    {\n        let _ = std::process::Command::new(\"open\").arg(url).spawn();\n    }\n\n    #[cfg(target_os = \"windows\")]\n    {\n        let _ = std::process::Command::new(\"cmd\")\n            .args([\"/C\", \"start\", \"\", url])\n            .spawn();\n    }\n\n    #[cfg(target_os = \"linux\")]\n    {\n        let _ = std::process::Command::new(\"xdg-open\").arg(url).spawn();\n    }\n}\n\npub async fn login() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    if let Some(creds) = load_credentials() {\n        println!(\n            \"\\n  {}\",\n            format!(\"Already logged in as {}\", creds.username.bold()).yellow()\n        );\n        println!(\n            \"{}\",\n            \"  Run 'tokscale logout' to sign out first.\\n\".bright_black()\n        );\n        return Ok(());\n    }\n\n    let base_url = get_api_base_url();\n\n    println!(\"\\n  {}\\n\", \"Tokscale - Login\".cyan());\n    println!(\"{}\", \"  Requesting authorization code...\".bright_black());\n\n    let client = reqwest::Client::builder()\n        .timeout(std::time::Duration::from_secs(30))\n        .build()?;\n\n    let device_code_response = client\n        .post(format!(\"{}/api/auth/device\", base_url))\n        .json(\u0026serde_json::json!({\n            \"deviceName\": get_device_name()\n        }))\n        .send()\n        .await?;\n\n    if !device_code_response.status().is_success() {\n        anyhow::bail!(\"Server returned {}\", device_code_response.status());\n    }\n\n    let device_data: DeviceCodeResponse = device_code_response.json().await?;\n\n    println!();\n    println!(\"{}\", \"  Open this URL in your browser:\".white());\n    println!(\"{}\", format!(\"  {}\\n\", device_data.verification_url).cyan());\n    println!(\"{}\", \"  Enter this code:\".white());\n    println!(\n        \"{}\\n\",\n        format!(\"  {}\", device_data.user_code).green().bold()\n    );\n\n    open_browser(\u0026device_data.verification_url);\n\n    println!(\"{}\", \"  Waiting for authorization...\".bright_black());\n\n    let poll_interval = std::time::Duration::from_secs(device_data.interval);\n    let max_attempts = 180;\n\n    for attempt in 0..max_attempts {\n        tokio::time::sleep(poll_interval).await;\n\n        let poll_response = client\n            .post(format!(\"{}/api/auth/device/poll\", base_url))\n            .json(\u0026serde_json::json!({\n                \"deviceCode\": device_data.device_code\n            }))\n            .send()\n            .await;\n\n        match poll_response {\n            Ok(response) =\u003e {\n                if let Ok(data) = response.json::\u003cPollResponse\u003e().await {\n                    if data.status == \"complete\" {\n                        if let (Some(token), Some(user)) = (data.token, data.user) {\n                            let credentials = Credentials {\n                                token,\n                                username: user.username.clone(),\n                                avatar_url: user.avatar_url,\n                                created_at: chrono::Utc::now().to_rfc3339(),\n                            };\n\n                            save_credentials(\u0026credentials)?;\n\n                            println!(\n                                \"\\n  {}\",\n                                format!(\"Success! Logged in as {}\", user.username.bold()).green()\n                            );\n                            println!(\n                                \"{}\",\n                                \"  You can now use 'tokscale submit' to share your usage.\\n\"\n                                    .bright_black()\n                            );\n                            return Ok(());\n                        }\n                    }\n\n                    if data.status == \"expired\" {\n                        anyhow::bail!(\"Authorization code expired. Please try again.\");\n                    }\n\n                    print!(\"{}\", \".\".bright_black());\n                    use std::io::Write;\n                    std::io::stdout().flush()?;\n                }\n            }\n            Err(_) =\u003e {\n                print!(\"{}\", \"!\".red());\n                use std::io::Write;\n                std::io::stdout().flush()?;\n            }\n        }\n\n        if attempt \u003e= max_attempts - 1 {\n            anyhow::bail!(\"Timeout: Authorization took too long. Please try again.\");\n        }\n    }\n\n    Ok(())\n}\n\npub fn logout() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    let credentials = load_credentials();\n\n    let Some(creds) = credentials else {\n        println!(\"\\n  {}\\n\", \"Not logged in.\".yellow());\n        return Ok(());\n    };\n\n    let username = creds.username;\n    let cleared = clear_credentials()?;\n\n    if cleared {\n        println!(\n            \"\\n  {}\\n\",\n            format!(\"Logged out from {}\", username.bold()).green()\n        );\n    } else {\n        anyhow::bail!(\"Failed to clear credentials.\");\n    }\n\n    Ok(())\n}\n\npub fn whoami() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    let Some(creds) = load_credentials() else {\n        println!(\"\\n  {}\", \"Not logged in.\".yellow());\n        println!(\n            \"{}\",\n            \"  Run 'tokscale login' to authenticate.\\n\".bright_black()\n        );\n        return Ok(());\n    };\n\n    println!(\"\\n  {}\\n\", \"Tokscale - Account Info\".cyan());\n    println!(\n        \"{}\",\n        format!(\"  Username:  {}\", creds.username.bold()).white()\n    );\n\n    if let Ok(created) = chrono::DateTime::parse_from_rfc3339(\u0026creds.created_at) {\n        println!(\n            \"{}\",\n            format!(\"  Logged in: {}\", created.format(\"%Y-%m-%d\")).bright_black()\n        );\n    }\n\n    println!();\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serial_test::serial;\n    use std::env;\n    use tempfile::TempDir;\n\n    #[test]\n    fn test_get_api_base_url_default() {\n        unsafe {\n            env::remove_var(\"TOKSCALE_API_URL\");\n        }\n        assert_eq!(get_api_base_url(), \"https://tokscale.ai\");\n    }\n\n    #[test]\n    #[serial]\n    fn test_get_api_base_url_custom() {\n        unsafe {\n            env::set_var(\"TOKSCALE_API_URL\", \"https://custom.api.url\");\n        }\n        assert_eq!(get_api_base_url(), \"https://custom.api.url\");\n        unsafe {\n            env::remove_var(\"TOKSCALE_API_URL\");\n        }\n    }\n\n    #[test]\n    fn test_credentials_serialization() {\n        let creds = Credentials {\n            token: \"test_token_123\".to_string(),\n            username: \"testuser\".to_string(),\n            avatar_url: Some(\"https://example.com/avatar.png\".to_string()),\n            created_at: \"2024-01-01T00:00:00Z\".to_string(),\n        };\n\n        let json = serde_json::to_string(\u0026creds).unwrap();\n        let deserialized: Credentials = serde_json::from_str(\u0026json).unwrap();\n\n        assert_eq!(deserialized.token, creds.token);\n        assert_eq!(deserialized.username, creds.username);\n        assert_eq!(deserialized.avatar_url, creds.avatar_url);\n        assert_eq!(deserialized.created_at, creds.created_at);\n    }\n\n    #[test]\n    fn test_credentials_serialization_without_avatar() {\n        let creds = Credentials {\n            token: \"test_token_456\".to_string(),\n            username: \"testuser2\".to_string(),\n            avatar_url: None,\n            created_at: \"2024-01-02T00:00:00Z\".to_string(),\n        };\n\n        let json = serde_json::to_string(\u0026creds).unwrap();\n        let deserialized: Credentials = serde_json::from_str(\u0026json).unwrap();\n\n        assert_eq!(deserialized.token, creds.token);\n        assert_eq!(deserialized.username, creds.username);\n        assert_eq!(deserialized.avatar_url, None);\n        assert_eq!(deserialized.created_at, creds.created_at);\n\n        assert!(!json.contains(\"avatarUrl\"));\n    }\n\n    #[test]\n    #[serial]\n    fn test_get_credentials_path() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let path = get_credentials_path().unwrap();\n        let expected = temp_dir.path().join(\".config/tokscale/credentials.json\");\n\n        assert_eq!(path, expected);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_save_credentials() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let creds = Credentials {\n            token: \"save_test_token\".to_string(),\n            username: \"saveuser\".to_string(),\n            avatar_url: Some(\"https://example.com/save.png\".to_string()),\n            created_at: \"2024-01-03T00:00:00Z\".to_string(),\n        };\n\n        save_credentials(\u0026creds).unwrap();\n\n        let path = get_credentials_path().unwrap();\n        assert!(path.exists());\n\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let metadata = fs::metadata(\u0026path).unwrap();\n            let permissions = metadata.permissions();\n            assert_eq!(permissions.mode() \u0026 0o777, 0o600);\n        }\n\n        let content = fs::read_to_string(\u0026path).unwrap();\n        let loaded: Credentials = serde_json::from_str(\u0026content).unwrap();\n        assert_eq!(loaded.token, creds.token);\n        assert_eq!(loaded.username, creds.username);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_load_credentials() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let creds = Credentials {\n            token: \"load_test_token\".to_string(),\n            username: \"loaduser\".to_string(),\n            avatar_url: None,\n            created_at: \"2024-01-04T00:00:00Z\".to_string(),\n        };\n\n        save_credentials(\u0026creds).unwrap();\n\n        let loaded = load_credentials().unwrap();\n\n        assert_eq!(loaded.token, creds.token);\n        assert_eq!(loaded.username, creds.username);\n        assert_eq!(loaded.avatar_url, creds.avatar_url);\n        assert_eq!(loaded.created_at, creds.created_at);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_load_credentials_nonexistent() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let loaded = load_credentials();\n        assert!(loaded.is_none());\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_clear_credentials() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let creds = Credentials {\n            token: \"clear_test_token\".to_string(),\n            username: \"clearuser\".to_string(),\n            avatar_url: None,\n            created_at: \"2024-01-05T00:00:00Z\".to_string(),\n        };\n\n        save_credentials(\u0026creds).unwrap();\n        let path = get_credentials_path().unwrap();\n        assert!(path.exists());\n\n        let cleared = clear_credentials().unwrap();\n        assert!(cleared);\n        assert!(!path.exists());\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_clear_credentials_nonexistent() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let cleared = clear_credentials().unwrap();\n        assert!(!cleared);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_ensure_config_dir() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let config_dir = temp_dir.path().join(\".config/tokscale\");\n        assert!(!config_dir.exists());\n\n        ensure_config_dir().unwrap();\n\n        assert!(config_dir.exists());\n\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let metadata = fs::metadata(\u0026config_dir).unwrap();\n            let permissions = metadata.permissions();\n            assert_eq!(permissions.mode() \u0026 0o777, 0o700);\n        }\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_save_and_load_roundtrip() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let original = Credentials {\n            token: \"roundtrip_token\".to_string(),\n            username: \"roundtripuser\".to_string(),\n            avatar_url: Some(\"https://example.com/roundtrip.png\".to_string()),\n            created_at: \"2024-01-06T12:34:56Z\".to_string(),\n        };\n\n        save_credentials(\u0026original).unwrap();\n        let loaded = load_credentials().unwrap();\n\n        assert_eq!(loaded.token, original.token);\n        assert_eq!(loaded.username, original.username);\n        assert_eq!(loaded.avatar_url, original.avatar_url);\n        assert_eq!(loaded.created_at, original.created_at);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":17}},{"line":8,"address":[],"length":0,"stats":{"Line":34}},{"line":51,"address":[],"length":0,"stats":{"Line":12}},{"line":52,"address":[],"length":0,"stats":{"Line":24}},{"line":55,"address":[],"length":0,"stats":{"Line":5}},{"line":56,"address":[],"length":0,"stats":{"Line":15}},{"line":58,"address":[],"length":0,"stats":{"Line":5}},{"line":59,"address":[],"length":0,"stats":{"Line":10}},{"line":63,"address":[],"length":0,"stats":{"Line":15}},{"line":66,"address":[],"length":0,"stats":{"Line":5}},{"line":69,"address":[],"length":0,"stats":{"Line":4}},{"line":70,"address":[],"length":0,"stats":{"Line":4}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":72,"address":[],"length":0,"stats":{"Line":12}},{"line":78,"address":[],"length":0,"stats":{"Line":8}},{"line":83,"address":[],"length":0,"stats":{"Line":8}},{"line":84,"address":[],"length":0,"stats":{"Line":12}},{"line":92,"address":[],"length":0,"stats":{"Line":4}},{"line":95,"address":[],"length":0,"stats":{"Line":3}},{"line":96,"address":[],"length":0,"stats":{"Line":9}},{"line":97,"address":[],"length":0,"stats":{"Line":3}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":8}},{"line":102,"address":[],"length":0,"stats":{"Line":6}},{"line":105,"address":[],"length":0,"stats":{"Line":2}},{"line":106,"address":[],"length":0,"stats":{"Line":4}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":116,"address":[],"length":0,"stats":{"Line":6}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}}],"covered":32,"coverable":128},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","commands","mod.rs"],"content":"pub mod wrapped;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","commands","wrapped.rs"],"content":"use crate::{auth, cursor};\nuse ab_glyph::{point, Font, FontArc, GlyphId, PxScale, ScaleFont};\nuse anyhow::{Context, Result};\nuse chrono::{Datelike, Duration, Local, NaiveDate, Utc};\nuse colored::Colorize;\nuse image::{imageops::FilterType, Rgba, RgbaImage};\nuse imageproc::drawing::draw_filled_circle_mut;\nuse std::cmp::Ordering;\nuse std::collections::HashMap;\nuse std::fs;\nuse std::path::{Path, PathBuf};\nuse tokio::runtime::Runtime;\nuse tokscale_core::{generate_graph, parse_local_sources, GroupBy, LocalParseOptions, ReportOptions};\n\nconst SCALE: i32 = 2;\nconst IMAGE_WIDTH: i32 = 1200 * SCALE;\nconst IMAGE_HEIGHT: i32 = 1200 * SCALE;\nconst PADDING: i32 = 56 * SCALE;\n\nconst TOKSCALE_LOGO_SVG_URL: \u0026str = \"https://tokscale.ai/tokscale-logo.svg\";\nconst TOKSCALE_LOGO_PNG_SIZE: i32 = 400;\nconst FIGTREE_REGULAR_FILE: \u0026str = \"Figtree-Regular.ttf\";\nconst FIGTREE_REGULAR_URL: \u0026str =\n    \"https://fonts.gstatic.com/s/figtree/v9/_Xmz-HUzqDCFdgfMsYiV_F7wfS-Bs_d_QF5e.ttf\";\nconst FIGTREE_BOLD_FILE: \u0026str = \"Figtree-Bold.ttf\";\nconst FIGTREE_BOLD_URL: \u0026str =\n    \"https://fonts.gstatic.com/s/figtree/v9/_Xmz-HUzqDCFdgfMsYiV_F7wfS-Bs_eYR15e.ttf\";\n\nconst PINNED_AGENTS: [\u0026str; 2] = [\"Sisyphus\", \"Planner-Sisyphus\"];\n\nconst COLOR_BACKGROUND: Rgba\u003cu8\u003e = Rgba([0x10, 0x12, 0x1C, 0xFF]);\nconst COLOR_TEXT_PRIMARY: Rgba\u003cu8\u003e = Rgba([0xFF, 0xFF, 0xFF, 0xFF]);\nconst COLOR_TEXT_SECONDARY: Rgba\u003cu8\u003e = Rgba([0x88, 0x88, 0x88, 0xFF]);\nconst COLOR_GRADE0: Rgba\u003cu8\u003e = Rgba([0x14, 0x1A, 0x25, 0xFF]);\nconst COLOR_GRADE1: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0x44]);\nconst COLOR_GRADE2: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0x88]);\nconst COLOR_GRADE3: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0xCC]);\nconst COLOR_GRADE4: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0xFF]);\nconst COLOR_SISYPHUS: Rgba\u003cu8\u003e = Rgba([0x00, 0xCE, 0xD1, 0xFF]);\n\n#[derive(Debug, Clone)]\npub struct WrappedOptions {\n    pub output: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub short: bool,\n    pub include_agents: bool,\n    pub pin_sisyphus: bool,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedData {\n    year: String,\n    active_days: i32,\n    total_tokens: i64,\n    total_cost: f64,\n    longest_streak: i32,\n    top_models: Vec\u003cWrappedRankedEntry\u003e,\n    top_clients: Vec\u003cWrappedRankedEntry\u003e,\n    top_agents: Option\u003cVec\u003cWrappedAgentEntry\u003e\u003e,\n    contributions: Vec\u003cWrappedContribution\u003e,\n    total_messages: i32,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedRankedEntry {\n    name: String,\n    cost: f64,\n    tokens: i64,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedAgentEntry {\n    name: String,\n    tokens: i64,\n    messages: i32,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedContribution {\n    date: String,\n    level: u8,\n}\n\n#[derive(Debug, Clone)]\nstruct FontSet {\n    regular: FontArc,\n    bold: FontArc,\n}\n\n#[derive(Debug, Clone)]\nstruct RenderOptions {\n    short: bool,\n    include_agents: bool,\n    pin_sisyphus: bool,\n}\n\npub fn run(options: WrappedOptions) -\u003e Result\u003cString\u003e {\n    let rt = Runtime::new()?;\n    rt.block_on(async move { generate_wrapped(options).await })\n}\n\nasync fn generate_wrapped(options: WrappedOptions) -\u003e Result\u003cString\u003e {\n    let data = load_wrapped_data(\u0026options).await?;\n\n    let agents_requested = options.include_agents;\n    let has_agent_data = data\n        .top_agents\n        .as_ref()\n        .map(|agents| !agents.is_empty())\n        .unwrap_or(false);\n    let opencode_enabled = options\n        .sources\n        .as_ref()\n        .map_or(true, |sources| sources.iter().any(|s| s == \"opencode\"));\n    let effective_include_agents = agents_requested \u0026\u0026 has_agent_data;\n\n    if agents_requested \u0026\u0026 opencode_enabled \u0026\u0026 !has_agent_data {\n        println!(\n            \"{}\",\n            format!(\"\\n  âš  No OpenCode agent data found for {}.\", data.year).yellow()\n        );\n        println!(\"{}\", \"    Falling back to clients view.\".bright_black());\n        println!(\n            \"{}\",\n            \"    Use --clients to always show clients view.\\n\".bright_black()\n        );\n    }\n\n    let image = generate_wrapped_image(\n        \u0026data,\n        \u0026RenderOptions {\n            short: options.short,\n            include_agents: effective_include_agents,\n            pin_sisyphus: options.pin_sisyphus,\n        },\n    )\n    .await?;\n\n    let output = options\n        .output\n        .clone()\n        .unwrap_or_else(|| format!(\"tokscale-{}-wrapped.png\", data.year));\n    let output_path = PathBuf::from(\u0026output);\n    let absolute = if output_path.is_absolute() {\n        output_path\n    } else {\n        std::env::current_dir()?.join(output_path)\n    };\n\n    image\n        .save_with_format(\u0026absolute, image::ImageFormat::Png)\n        .with_context(|| format!(\"Failed to save wrapped image to {}\", absolute.display()))?;\n\n    Ok(absolute.to_string_lossy().to_string())\n}\n\nasync fn load_wrapped_data(options: \u0026WrappedOptions) -\u003e Result\u003cWrappedData\u003e {\n    let year = options\n        .year\n        .clone()\n        .unwrap_or_else(|| Local::now().year().to_string());\n    let sources = options.sources.clone().unwrap_or_else(default_sources);\n    let local_sources: Vec\u003cString\u003e = sources\n        .iter()\n        .filter(|src| src.as_str() != \"cursor\")\n        .cloned()\n        .collect();\n    let include_cursor = sources.iter().any(|src| src == \"cursor\");\n\n    let since = format!(\"{}-01-01\", year);\n    let until = format!(\"{}-12-31\", year);\n\n    let has_cursor_cache = cursor::has_cursor_usage_cache();\n    let mut cursor_sync_result: Option\u003ccursor::SyncCursorResult\u003e = None;\n\n    if include_cursor \u0026\u0026 cursor::is_cursor_logged_in() {\n        cursor_sync_result = Some(cursor::sync_cursor_cache().await);\n    }\n\n    if let Some(sync) = cursor_sync_result.as_ref() {\n        if let Some(error) = sync.error.as_ref() {\n            if sync.synced || has_cursor_cache {\n                let prefix = if sync.synced {\n                    \"Cursor sync warning\"\n                } else {\n                    \"Cursor sync failed; using cached data\"\n                };\n                println!(\"{}\", format!(\"  {}: {}\", prefix, error).yellow());\n            }\n        }\n    }\n\n    let include_cursor_in_graph = if include_cursor {\n        let synced = cursor_sync_result\n            .as_ref()\n            .map(|sync| sync.synced)\n            .unwrap_or(false);\n        synced || has_cursor_cache\n    } else {\n        false\n    };\n\n    let graph_sources = if include_cursor \u0026\u0026 !include_cursor_in_graph {\n        sources\n            .iter()\n            .filter(|src| src.as_str() != \"cursor\")\n            .cloned()\n            .collect::\u003cVec\u003c_\u003e\u003e()\n    } else {\n        sources.clone()\n    };\n\n    let parsed_local = if options.include_agents \u0026\u0026 !local_sources.is_empty() {\n        Some(\n            parse_local_sources(LocalParseOptions {\n                home_dir: None,\n                sources: Some(local_sources),\n                since: Some(since.clone()),\n                until: Some(until.clone()),\n                year: Some(year.clone()),\n            })\n            .map_err(anyhow::Error::msg)?,\n        )\n    } else {\n        None\n    };\n\n    let graph = generate_graph(ReportOptions {\n        home_dir: None,\n        sources: Some(graph_sources),\n        since: Some(since),\n        until: Some(until),\n        year: Some(year.clone()),\n        group_by: GroupBy::default(),\n    })\n    .await\n    .map_err(anyhow::Error::msg)?;\n\n    let mut model_map: HashMap\u003cString, WrappedRankedEntry\u003e = HashMap::new();\n    let mut client_map: HashMap\u003cString, WrappedRankedEntry\u003e = HashMap::new();\n    let mut total_messages = 0i32;\n\n    for day in \u0026graph.contributions {\n        total_messages += day.totals.messages;\n\n        for source in \u0026day.sources {\n            let model_name = format_model_name(\u0026source.model_id);\n            let model_entry =\n                model_map\n                    .entry(model_name.clone())\n                    .or_insert_with(|| WrappedRankedEntry {\n                        name: model_name,\n                        cost: 0.0,\n                        tokens: 0,\n                    });\n            model_entry.cost += source.cost;\n            model_entry.tokens += source.tokens.input\n                + source.tokens.output\n                + source.tokens.cache_read\n                + source.tokens.cache_write;\n\n            let client_name = source_display_name(\u0026source.source)\n                .unwrap_or(source.source.as_str())\n                .to_string();\n            let client_entry =\n                client_map\n                    .entry(client_name.clone())\n                    .or_insert_with(|| WrappedRankedEntry {\n                        name: client_name,\n                        cost: 0.0,\n                        tokens: 0,\n                    });\n            client_entry.cost += source.cost;\n            client_entry.tokens += source.tokens.input\n                + source.tokens.output\n                + source.tokens.cache_read\n                + source.tokens.cache_write;\n        }\n    }\n\n    let mut top_models: Vec\u003cWrappedRankedEntry\u003e = model_map.into_values().collect();\n    top_models.sort_by(|a, b| b.cost.partial_cmp(\u0026a.cost).unwrap_or(Ordering::Equal));\n    top_models.truncate(3);\n\n    let mut top_clients: Vec\u003cWrappedRankedEntry\u003e = client_map.into_values().collect();\n    top_clients.sort_by(|a, b| b.cost.partial_cmp(\u0026a.cost).unwrap_or(Ordering::Equal));\n    top_clients.truncate(3);\n\n    let top_agents = if options.include_agents {\n        parsed_local\n            .as_ref()\n            .map(build_top_agents)\n            .filter(|agents| !agents.is_empty())\n    } else {\n        None\n    };\n\n    let max_cost = graph\n        .contributions\n        .iter()\n        .map(|c| c.totals.cost)\n        .fold(1.0, f64::max);\n    let contributions: Vec\u003cWrappedContribution\u003e = graph\n        .contributions\n        .iter()\n        .map(|c| WrappedContribution {\n            date: c.date.clone(),\n            level: calculate_intensity(c.totals.cost, max_cost),\n        })\n        .collect();\n\n    let mut sorted_dates: Vec\u003cString\u003e = contributions\n        .iter()\n        .map(|c| c.date.clone())\n        .filter(|date| date.starts_with(\u0026year))\n        .collect();\n    sorted_dates.sort();\n\n    let (_current_streak, longest_streak) = calculate_streaks(\u0026sorted_dates);\n    let _first_day = sorted_dates\n        .first()\n        .cloned()\n        .unwrap_or_else(|| format!(\"{}-01-01\", year));\n\n    Ok(WrappedData {\n        year,\n        active_days: graph.summary.active_days,\n        total_tokens: graph.summary.total_tokens,\n        total_cost: graph.summary.total_cost,\n        longest_streak,\n        top_models,\n        top_clients,\n        top_agents,\n        contributions,\n        total_messages,\n    })\n}\n\nfn build_top_agents(parsed: \u0026tokscale_core::ParsedMessages) -\u003e Vec\u003cWrappedAgentEntry\u003e {\n    let mut agent_map: HashMap\u003cString, WrappedAgentEntry\u003e = HashMap::new();\n\n    for message in \u0026parsed.messages {\n        if message.source != \"opencode\" {\n            continue;\n        }\n\n        let Some(agent) = message.agent.as_ref() else {\n            continue;\n        };\n\n        let normalized = tokscale_core::sessions::normalize_agent_name(agent);\n        let tokens = message.input\n            + message.output\n            + message.cache_read\n            + message.cache_write\n            + message.reasoning;\n\n        let entry = agent_map\n            .entry(normalized.clone())\n            .or_insert_with(|| WrappedAgentEntry {\n                name: normalized,\n                tokens: 0,\n                messages: 0,\n            });\n        entry.tokens += tokens;\n        entry.messages += 1;\n    }\n\n    let mut agents: Vec\u003cWrappedAgentEntry\u003e = agent_map.into_values().collect();\n\n    let mut pinned = agents\n        .iter()\n        .filter(|agent| PINNED_AGENTS.contains(\u0026agent.name.as_str()))\n        .cloned()\n        .collect::\u003cVec\u003c_\u003e\u003e();\n    let mut unpinned = agents\n        .drain(..)\n        .filter(|agent| !PINNED_AGENTS.contains(\u0026agent.name.as_str()))\n        .collect::\u003cVec\u003c_\u003e\u003e();\n\n    pinned.sort_by_key(|agent| {\n        PINNED_AGENTS\n            .iter()\n            .position(|name| *name == agent.name)\n            .unwrap_or(usize::MAX)\n    });\n    unpinned.sort_by(|a, b| b.messages.cmp(\u0026a.messages));\n\n    let mut combined = Vec::new();\n    combined.extend(pinned);\n    combined.extend(unpinned.into_iter().take(2));\n    combined\n}\n\nasync fn generate_wrapped_image(data: \u0026WrappedData, options: \u0026RenderOptions) -\u003e Result\u003cRgbaImage\u003e {\n    let client = reqwest::Client::new();\n    let fonts = ensure_fonts_loaded(\u0026client).await?;\n\n    let mut canvas =\n        RgbaImage::from_pixel(IMAGE_WIDTH as u32, IMAGE_HEIGHT as u32, COLOR_BACKGROUND);\n\n    let left_width = (IMAGE_WIDTH as f32 * 0.45) as i32;\n    let right_width = (IMAGE_WIDTH as f32 * 0.55) as i32;\n    let right_x = left_width;\n\n    let mut y_pos = PADDING + 24 * SCALE;\n\n    let credentials = auth::load_credentials();\n    let display_username = credentials\n        .as_ref()\n        .and_then(|cred| truncate_username(\u0026cred.username, 30));\n    let title_text = display_username\n        .map(|username| format!(\"@{}'s Wrapped {}\", username, data.year))\n        .unwrap_or_else(|| format!(\"My Wrapped {}\", data.year));\n\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.bold,\n        (28 * SCALE) as f32,\n        COLOR_TEXT_PRIMARY,\n        PADDING,\n        y_pos,\n        \u0026title_text,\n    );\n    y_pos += 60 * SCALE;\n\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.regular,\n        (20 * SCALE) as f32,\n        COLOR_TEXT_SECONDARY,\n        PADDING,\n        y_pos,\n        \"Total Tokens\",\n    );\n    y_pos += 64 * SCALE;\n\n    let total_tokens_display = if options.short {\n        format_tokens_short(data.total_tokens)\n    } else {\n        format_number_with_commas_i64(data.total_tokens)\n    };\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.bold,\n        (56 * SCALE) as f32,\n        COLOR_GRADE4,\n        PADDING,\n        y_pos,\n        \u0026total_tokens_display,\n    );\n    y_pos += 50 * SCALE + 40 * SCALE;\n\n    let logo_size = 32 * SCALE;\n    let logo_radius = 6 * SCALE;\n\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.regular,\n        (20 * SCALE) as f32,\n        COLOR_TEXT_SECONDARY,\n        PADDING,\n        y_pos,\n        \"Top Models\",\n    );\n    y_pos += 48 * SCALE;\n\n    for (index, model) in data.top_models.iter().enumerate() {\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.bold,\n            (32 * SCALE) as f32,\n            COLOR_TEXT_PRIMARY,\n            PADDING,\n            y_pos,\n            \u0026(index + 1).to_string(),\n        );\n\n        let mut text_x = PADDING + 40 * SCALE;\n\n        if let Some(provider) = get_provider_from_model(\u0026model.name) {\n            if let Some(logo_url) = provider_logo_url(provider) {\n                let filename = format!(\"provider-{}@2x.jpg\", provider);\n                if let Ok(path) = fetch_and_cache_image(\u0026client, logo_url, \u0026filename).await {\n                    if let Ok(logo) = load_rgba_image(\u0026path) {\n                        let logo_y = y_pos - logo_size + 6 * SCALE;\n                        let logo_x = PADDING + 40 * SCALE;\n\n                        draw_image_rounded(\n                            \u0026mut canvas,\n                            \u0026logo,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                        );\n                        draw_rounded_border(\n                            \u0026mut canvas,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                            1 * SCALE,\n                            COLOR_GRADE0,\n                        );\n\n                        text_x = logo_x + logo_size + 12 * SCALE;\n                    }\n                }\n            }\n        }\n\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.regular,\n            (32 * SCALE) as f32,\n            COLOR_TEXT_PRIMARY,\n            text_x,\n            y_pos,\n            \u0026model.name,\n        );\n        y_pos += 50 * SCALE;\n    }\n    y_pos += 40 * SCALE;\n\n    if options.include_agents {\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.regular,\n            (20 * SCALE) as f32,\n            COLOR_TEXT_SECONDARY,\n            PADDING,\n            y_pos,\n            \"Top OpenCode Agents\",\n        );\n        y_pos += 48 * SCALE;\n\n        let agents = data.top_agents.clone().unwrap_or_default();\n        let mut rank_index = 1;\n\n        for agent in agents {\n            let is_sisyphus_agent = PINNED_AGENTS.contains(\u0026agent.name.as_str());\n            let show_with_dash = options.pin_sisyphus \u0026\u0026 is_sisyphus_agent;\n            let prefix = if show_with_dash {\n                \"\\u{2022}\".to_string()\n            } else {\n                rank_index.to_string()\n            };\n            let prefix_color = if show_with_dash {\n                COLOR_SISYPHUS\n            } else {\n                COLOR_TEXT_PRIMARY\n            };\n\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.bold,\n                (32 * SCALE) as f32,\n                prefix_color,\n                PADDING,\n                y_pos,\n                \u0026prefix,\n            );\n\n            if !show_with_dash {\n                rank_index += 1;\n            }\n\n            let name_x = PADDING + 40 * SCALE;\n            let name_color = if is_sisyphus_agent {\n                COLOR_SISYPHUS\n            } else {\n                COLOR_TEXT_PRIMARY\n            };\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (32 * SCALE) as f32,\n                name_color,\n                name_x,\n                y_pos,\n                \u0026agent.name,\n            );\n\n            let name_width = measure_text_width(\u0026fonts.regular, (32 * SCALE) as f32, \u0026agent.name);\n            let suffix = format!(\n                \" ({})\",\n                format_number_with_commas_i64(agent.messages as i64)\n            );\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (32 * SCALE) as f32,\n                COLOR_TEXT_SECONDARY,\n                name_x + name_width.round() as i32,\n                y_pos,\n                \u0026suffix,\n            );\n\n            y_pos += 50 * SCALE;\n        }\n    } else {\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.regular,\n            (20 * SCALE) as f32,\n            COLOR_TEXT_SECONDARY,\n            PADDING,\n            y_pos,\n            \"Top Clients\",\n        );\n        y_pos += 48 * SCALE;\n\n        for (index, client_entry) in data.top_clients.iter().enumerate() {\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.bold,\n                (32 * SCALE) as f32,\n                COLOR_TEXT_PRIMARY,\n                PADDING,\n                y_pos,\n                \u0026(index + 1).to_string(),\n            );\n\n            if let Some(logo_url) = client_logo_url(\u0026client_entry.name) {\n                let filename = format!(\n                    \"client-{}@2x.png\",\n                    client_entry\n                        .name\n                        .to_lowercase()\n                        .split_whitespace()\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"-\")\n                );\n\n                if let Ok(path) = fetch_and_cache_image(\u0026client, logo_url, \u0026filename).await {\n                    if let Ok(logo) = load_rgba_image(\u0026path) {\n                        let logo_x = PADDING + 40 * SCALE;\n                        let logo_y = y_pos - logo_size + 6 * SCALE;\n\n                        draw_image_rounded(\n                            \u0026mut canvas,\n                            \u0026logo,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                        );\n                        draw_rounded_border(\n                            \u0026mut canvas,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                            1 * SCALE,\n                            COLOR_GRADE0,\n                        );\n                    }\n                }\n            }\n\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (32 * SCALE) as f32,\n                COLOR_TEXT_PRIMARY,\n                PADDING + 40 * SCALE + logo_size + 12 * SCALE,\n                y_pos,\n                \u0026client_entry.name,\n            );\n            y_pos += 50 * SCALE;\n        }\n    }\n\n    y_pos += 40 * SCALE;\n\n    let stats_start_y = y_pos;\n    let stat_width = (left_width - PADDING * 2) / 2;\n\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING,\n        stats_start_y,\n        \"Messages\",\n        \u0026format_number_with_commas_i64(data.total_messages as i64),\n    );\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING + stat_width,\n        stats_start_y,\n        \"Active Days\",\n        \u0026data.active_days.to_string(),\n    );\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING,\n        stats_start_y + 100 * SCALE,\n        \"Cost\",\n        \u0026format_cost(data.total_cost),\n    );\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING + stat_width,\n        stats_start_y + 100 * SCALE,\n        \"Streak\",\n        \u0026format!(\"{}d\", data.longest_streak),\n    );\n\n    draw_contribution_graph(\n        \u0026mut canvas,\n        data,\n        right_x,\n        PADDING,\n        right_width - PADDING,\n        IMAGE_HEIGHT - PADDING * 2,\n    );\n\n    let footer_bottom_y = IMAGE_HEIGHT - PADDING;\n    let tokscale_logo_height = 72 * SCALE;\n\n    if let Ok(logo_path) = fetch_svg_and_convert_to_png(\n        \u0026client,\n        TOKSCALE_LOGO_SVG_URL,\n        \"tokscale-logo@2x.png\",\n        TOKSCALE_LOGO_PNG_SIZE * SCALE,\n    )\n    .await\n    {\n        if let Ok(logo) = load_rgba_image(\u0026logo_path) {\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (18 * SCALE) as f32,\n                COLOR_TEXT_SECONDARY,\n                PADDING,\n                footer_bottom_y,\n                \"github.com/junhoyeo/tokscale\",\n            );\n\n            let logo_width = ((logo.width() as f32 / logo.height() as f32)\n                * tokscale_logo_height as f32)\n                .round() as i32;\n            let logo_y = footer_bottom_y - 18 * SCALE - 16 * SCALE - tokscale_logo_height;\n            draw_image(\n                \u0026mut canvas,\n                \u0026logo,\n                PADDING,\n                logo_y,\n                logo_width,\n                tokscale_logo_height,\n            );\n        }\n    }\n\n    Ok(canvas)\n}\n\nfn draw_contribution_graph(\n    canvas: \u0026mut RgbaImage,\n    data: \u0026WrappedData,\n    x: i32,\n    y: i32,\n    width: i32,\n    height: i32,\n) {\n    let year = data\n        .year\n        .parse::\u003ci32\u003e()\n        .unwrap_or_else(|_| Local::now().year());\n    let Some(start_date) = NaiveDate::from_ymd_opt(year, 1, 1) else {\n        return;\n    };\n    let Some(end_date) = NaiveDate::from_ymd_opt(year, 12, 31) else {\n        return;\n    };\n\n    let contrib_map: HashMap\u003c\u0026str, u8\u003e = data\n        .contributions\n        .iter()\n        .map(|contribution| (contribution.date.as_str(), contribution.level))\n        .collect();\n\n    const DAYS_PER_ROW: i32 = 14;\n    let total_days = (end_date - start_date).num_days() + 1;\n    let total_rows = ((total_days + (DAYS_PER_ROW as i64) - 1) / DAYS_PER_ROW as i64) as i32;\n\n    let cell_size = ((height as f32 / total_rows as f32).floor() as i32)\n        .min((width as f32 / DAYS_PER_ROW as f32).floor() as i32)\n        .max(1);\n    let dot_radius = (((cell_size - 2 * SCALE) as f32) / 2.0).floor().max(1.0) as i32;\n\n    let graph_width = DAYS_PER_ROW * cell_size;\n    let _graph_height = total_rows * cell_size;\n    let offset_x = x + (width - graph_width) / 2;\n    let offset_y = y;\n\n    let grade_colors = [\n        COLOR_GRADE0,\n        COLOR_GRADE1,\n        COLOR_GRADE2,\n        COLOR_GRADE3,\n        COLOR_GRADE4,\n    ];\n\n    let mut current_date = start_date;\n    let mut day_index = 0i32;\n\n    while current_date \u003c= end_date {\n        let date_key = current_date.format(\"%Y-%m-%d\").to_string();\n        let level = *contrib_map.get(date_key.as_str()).unwrap_or(\u00260);\n\n        let col = day_index % DAYS_PER_ROW;\n        let row = day_index / DAYS_PER_ROW;\n\n        let center_x = offset_x + col * cell_size + cell_size / 2;\n        let center_y = offset_y + row * cell_size + cell_size / 2;\n\n        draw_filled_circle_mut(\n            canvas,\n            (center_x, center_y),\n            dot_radius,\n            grade_colors[level as usize],\n        );\n\n        current_date += Duration::days(1);\n        day_index += 1;\n    }\n}\n\nfn draw_stat(canvas: \u0026mut RgbaImage, fonts: \u0026FontSet, x: i32, y: i32, label: \u0026str, value: \u0026str) {\n    draw_text_mut_baseline(\n        canvas,\n        \u0026fonts.regular,\n        (18 * SCALE) as f32,\n        COLOR_TEXT_SECONDARY,\n        x,\n        y,\n        label,\n    );\n    draw_text_mut_baseline(\n        canvas,\n        \u0026fonts.bold,\n        (36 * SCALE) as f32,\n        COLOR_TEXT_PRIMARY,\n        x,\n        y + 48 * SCALE,\n        value,\n    );\n}\n\nfn draw_text_mut_baseline(\n    canvas: \u0026mut RgbaImage,\n    font: \u0026FontArc,\n    font_size: f32,\n    color: Rgba\u003cu8\u003e,\n    x: i32,\n    baseline_y: i32,\n    text: \u0026str,\n) {\n    let scale = PxScale::from(font_size);\n    let scaled_font = font.as_scaled(scale);\n\n    let mut caret_x = x as f32;\n    let baseline = baseline_y as f32;\n    let mut prev_glyph: Option\u003cGlyphId\u003e = None;\n\n    for ch in text.chars() {\n        let glyph_id = scaled_font.glyph_id(ch);\n        if let Some(prev) = prev_glyph {\n            caret_x += scaled_font.kern(prev, glyph_id);\n        }\n\n        let glyph = glyph_id.with_scale_and_position(scale, point(caret_x, baseline));\n        if let Some(outlined) = font.outline_glyph(glyph) {\n            let bounds = outlined.px_bounds();\n            outlined.draw(|gx, gy, coverage| {\n                let px = bounds.min.x as i32 + gx as i32;\n                let py = bounds.min.y as i32 + gy as i32;\n                blend_pixel_with_coverage(canvas, px, py, color, coverage);\n            });\n        }\n\n        caret_x += scaled_font.h_advance(glyph_id);\n        prev_glyph = Some(glyph_id);\n    }\n}\n\nfn measure_text_width(font: \u0026FontArc, font_size: f32, text: \u0026str) -\u003e f32 {\n    let scale = PxScale::from(font_size);\n    let scaled_font = font.as_scaled(scale);\n    let mut width = 0.0f32;\n    let mut prev_glyph: Option\u003cGlyphId\u003e = None;\n\n    for ch in text.chars() {\n        let glyph_id = scaled_font.glyph_id(ch);\n        if let Some(prev) = prev_glyph {\n            width += scaled_font.kern(prev, glyph_id);\n        }\n        width += scaled_font.h_advance(glyph_id);\n        prev_glyph = Some(glyph_id);\n    }\n\n    width\n}\n\nfn draw_image(canvas: \u0026mut RgbaImage, source: \u0026RgbaImage, x: i32, y: i32, width: i32, height: i32) {\n    if width \u003c= 0 || height \u003c= 0 {\n        return;\n    }\n\n    let resized =\n        image::imageops::resize(source, width as u32, height as u32, FilterType::CatmullRom);\n    for dy in 0..height {\n        for dx in 0..width {\n            let src = *resized.get_pixel(dx as u32, dy as u32);\n            blend_pixel(canvas, x + dx, y + dy, src);\n        }\n    }\n}\n\nfn draw_image_rounded(\n    canvas: \u0026mut RgbaImage,\n    source: \u0026RgbaImage,\n    x: i32,\n    y: i32,\n    width: i32,\n    height: i32,\n    radius: i32,\n) {\n    if width \u003c= 0 || height \u003c= 0 {\n        return;\n    }\n\n    let resized =\n        image::imageops::resize(source, width as u32, height as u32, FilterType::CatmullRom);\n    for dy in 0..height {\n        for dx in 0..width {\n            let px = x + dx;\n            let py = y + dy;\n            if point_in_rounded_rect(\n                px as f32 + 0.5,\n                py as f32 + 0.5,\n                x as f32,\n                y as f32,\n                width as f32,\n                height as f32,\n                radius as f32,\n            ) {\n                let src = *resized.get_pixel(dx as u32, dy as u32);\n                blend_pixel(canvas, px, py, src);\n            }\n        }\n    }\n}\n\nfn draw_rounded_border(\n    canvas: \u0026mut RgbaImage,\n    x: i32,\n    y: i32,\n    width: i32,\n    height: i32,\n    radius: i32,\n    line_width: i32,\n    color: Rgba\u003cu8\u003e,\n) {\n    if width \u003c= 0 || height \u003c= 0 || line_width \u003c= 0 {\n        return;\n    }\n\n    for py in y..(y + height) {\n        for px in x..(x + width) {\n            let cx = px as f32 + 0.5;\n            let cy = py as f32 + 0.5;\n            let outer = point_in_rounded_rect(\n                cx,\n                cy,\n                x as f32,\n                y as f32,\n                width as f32,\n                height as f32,\n                radius as f32,\n            );\n            if !outer {\n                continue;\n            }\n\n            let inner = point_in_rounded_rect(\n                cx,\n                cy,\n                (x + line_width) as f32,\n                (y + line_width) as f32,\n                (width - 2 * line_width) as f32,\n                (height - 2 * line_width) as f32,\n                (radius - line_width).max(0) as f32,\n            );\n\n            if !inner {\n                blend_pixel(canvas, px, py, color);\n            }\n        }\n    }\n}\n\nfn point_in_rounded_rect(\n    px: f32,\n    py: f32,\n    x: f32,\n    y: f32,\n    width: f32,\n    height: f32,\n    radius: f32,\n) -\u003e bool {\n    if width \u003c= 0.0 || height \u003c= 0.0 {\n        return false;\n    }\n\n    let r = radius.max(0.0).min(width / 2.0).min(height / 2.0);\n    if r \u003c= 0.0 {\n        return px \u003e= x \u0026\u0026 px \u003c x + width \u0026\u0026 py \u003e= y \u0026\u0026 py \u003c y + height;\n    }\n\n    let nearest_x = px.clamp(x + r, x + width - r);\n    let nearest_y = py.clamp(y + r, y + height - r);\n    let dx = px - nearest_x;\n    let dy = py - nearest_y;\n    dx * dx + dy * dy \u003c= r * r\n}\n\nfn blend_pixel_with_coverage(\n    canvas: \u0026mut RgbaImage,\n    x: i32,\n    y: i32,\n    color: Rgba\u003cu8\u003e,\n    coverage: f32,\n) {\n    let mut src = color;\n    src.0[3] = ((src.0[3] as f32) * coverage.clamp(0.0, 1.0)).round() as u8;\n    blend_pixel(canvas, x, y, src);\n}\n\nfn blend_pixel(canvas: \u0026mut RgbaImage, x: i32, y: i32, src: Rgba\u003cu8\u003e) {\n    if x \u003c 0 || y \u003c 0 {\n        return;\n    }\n\n    let width = canvas.width() as i32;\n    let height = canvas.height() as i32;\n    if x \u003e= width || y \u003e= height {\n        return;\n    }\n\n    let dst = canvas.get_pixel_mut(x as u32, y as u32);\n    let src_alpha = src.0[3] as f32 / 255.0;\n    if src_alpha \u003c= 0.0 {\n        return;\n    }\n\n    let dst_alpha = dst.0[3] as f32 / 255.0;\n    let out_alpha = src_alpha + dst_alpha * (1.0 - src_alpha);\n\n    if out_alpha \u003c= 0.0 {\n        *dst = Rgba([0, 0, 0, 0]);\n        return;\n    }\n\n    for channel in 0..3 {\n        let src_channel = src.0[channel] as f32 / 255.0;\n        let dst_channel = dst.0[channel] as f32 / 255.0;\n        let out_channel =\n            (src_channel * src_alpha + dst_channel * dst_alpha * (1.0 - src_alpha)) / out_alpha;\n        dst.0[channel] = (out_channel * 255.0).round().clamp(0.0, 255.0) as u8;\n    }\n\n    dst.0[3] = (out_alpha * 255.0).round().clamp(0.0, 255.0) as u8;\n}\n\nasync fn ensure_fonts_loaded(client: \u0026reqwest::Client) -\u003e Result\u003cFontSet\u003e {\n    let cache_dir = get_font_cache_dir()?;\n    ensure_cache_dir(\u0026cache_dir)?;\n\n    let regular_path = cache_dir.join(FIGTREE_REGULAR_FILE);\n    let bold_path = cache_dir.join(FIGTREE_BOLD_FILE);\n\n    if !regular_path.exists() {\n        let _ = fetch_to_file(client, FIGTREE_REGULAR_URL, \u0026regular_path).await;\n    }\n    if !bold_path.exists() {\n        let _ = fetch_to_file(client, FIGTREE_BOLD_URL, \u0026bold_path).await;\n    }\n\n    let regular_font = if regular_path.exists() {\n        fs::read(\u0026regular_path)\n            .ok()\n            .and_then(|bytes| FontArc::try_from_vec(bytes).ok())\n    } else {\n        None\n    };\n    let bold_font = if bold_path.exists() {\n        fs::read(\u0026bold_path)\n            .ok()\n            .and_then(|bytes| FontArc::try_from_vec(bytes).ok())\n    } else {\n        None\n    };\n\n    let (regular, bold) = match (regular_font, bold_font) {\n        (Some(regular), Some(bold)) =\u003e (regular, bold),\n        (Some(regular), None) =\u003e (regular.clone(), regular),\n        (None, Some(bold)) =\u003e (bold.clone(), bold),\n        (None, None) =\u003e {\n            anyhow::bail!(\n                \"Failed to load Figtree fonts. Could not download or parse cached font files.\"\n            )\n        }\n    };\n\n    Ok(FontSet { regular, bold })\n}\n\nasync fn fetch_and_cache_image(\n    client: \u0026reqwest::Client,\n    url: \u0026str,\n    filename: \u0026str,\n) -\u003e Result\u003cPathBuf\u003e {\n    let cache_dir = get_image_cache_dir()?;\n    ensure_cache_dir(\u0026cache_dir)?;\n\n    let cached_path = cache_dir.join(filename);\n    if !cached_path.exists() {\n        fetch_to_file(client, url, \u0026cached_path).await?;\n    }\n\n    Ok(cached_path)\n}\n\nasync fn fetch_svg_and_convert_to_png(\n    client: \u0026reqwest::Client,\n    svg_url: \u0026str,\n    filename: \u0026str,\n    size: i32,\n) -\u003e Result\u003cPathBuf\u003e {\n    let cache_dir = get_image_cache_dir()?;\n    ensure_cache_dir(\u0026cache_dir)?;\n\n    let cached_path = cache_dir.join(filename);\n    if cached_path.exists() {\n        return Ok(cached_path);\n    }\n\n    let response = client\n        .get(svg_url)\n        .send()\n        .await\n        .with_context(|| format!(\"Failed to fetch {}\", svg_url))?;\n    if !response.status().is_success() {\n        anyhow::bail!(\"Failed to fetch {} (status {})\", svg_url, response.status());\n    }\n\n    let svg_bytes = response.bytes().await?;\n    let options = usvg::Options::default();\n    let tree = usvg::Tree::from_data(\u0026svg_bytes, \u0026options)\n        .map_err(|err| anyhow::anyhow!(\"Failed to parse SVG: {err:?}\"))?;\n\n    let base_size = tree.size().to_int_size();\n    let scale = size as f32 / base_size.width() as f32;\n    let scaled_size = base_size\n        .scale_by(scale)\n        .ok_or_else(|| anyhow::anyhow!(\"Invalid scaled SVG size\"))?;\n\n    let mut pixmap = resvg::tiny_skia::Pixmap::new(scaled_size.width(), scaled_size.height())\n        .ok_or_else(|| anyhow::anyhow!(\"Failed to create pixmap\"))?;\n    let transform = resvg::tiny_skia::Transform::from_scale(scale, scale);\n    resvg::render(\u0026tree, transform, \u0026mut pixmap.as_mut());\n\n    let png = pixmap\n        .encode_png()\n        .map_err(|err| anyhow::anyhow!(\"Failed to encode PNG: {err:?}\"))?;\n    fs::write(\u0026cached_path, png)?;\n\n    Ok(cached_path)\n}\n\nasync fn fetch_to_file(client: \u0026reqwest::Client, url: \u0026str, path: \u0026Path) -\u003e Result\u003c()\u003e {\n    let response = client\n        .get(url)\n        .send()\n        .await\n        .with_context(|| format!(\"Failed to fetch {}\", url))?;\n\n    if !response.status().is_success() {\n        anyhow::bail!(\"Failed to fetch {} (status {})\", url, response.status());\n    }\n\n    let bytes = response.bytes().await?;\n    fs::write(path, \u0026bytes)?;\n    Ok(())\n}\n\nfn ensure_cache_dir(path: \u0026Path) -\u003e Result\u003c()\u003e {\n    if !path.exists() {\n        fs::create_dir_all(path)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(path, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n    Ok(())\n}\n\nfn load_rgba_image(path: \u0026Path) -\u003e Result\u003cRgbaImage\u003e {\n    Ok(image::open(path)\n        .with_context(|| format!(\"Failed to decode image {}\", path.display()))?\n        .to_rgba8())\n}\n\nfn get_image_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    let home = dirs::home_dir().context(\"Could not determine home directory\")?;\n    Ok(home.join(\".cache\").join(\"tokscale\").join(\"images\"))\n}\n\nfn get_font_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    let home = dirs::home_dir().context(\"Could not determine home directory\")?;\n    Ok(home.join(\".cache\").join(\"tokscale\").join(\"fonts\"))\n}\n\nfn calculate_intensity(cost: f64, max_cost: f64) -\u003e u8 {\n    if cost == 0.0 || max_cost == 0.0 {\n        return 0;\n    }\n\n    let ratio = cost / max_cost;\n    if ratio \u003e= 0.75 {\n        4\n    } else if ratio \u003e= 0.5 {\n        3\n    } else if ratio \u003e= 0.25 {\n        2\n    } else {\n        1\n    }\n}\n\nfn calculate_streaks(sorted_dates: \u0026[String]) -\u003e (i32, i32) {\n    if sorted_dates.is_empty() {\n        return (0, 0);\n    }\n\n    let today = Utc::now().date_naive().format(\"%Y-%m-%d\").to_string();\n    let mut current_streak = 0;\n    let mut longest_streak = 0;\n    let mut streak = 1;\n\n    for index in (0..sorted_dates.len()).rev() {\n        if index == sorted_dates.len() - 1 {\n            let days_diff = date_diff_days(\u0026sorted_dates[index], \u0026today);\n            if days_diff \u003c= 1 {\n                current_streak = 1;\n            } else {\n                break;\n            }\n        } else {\n            let days_diff = date_diff_days(\u0026sorted_dates[index], \u0026sorted_dates[index + 1]);\n            if days_diff == 1 {\n                current_streak += 1;\n            } else {\n                break;\n            }\n        }\n    }\n\n    for index in 1..sorted_dates.len() {\n        let days_diff = date_diff_days(\u0026sorted_dates[index - 1], \u0026sorted_dates[index]);\n        if days_diff == 1 {\n            streak += 1;\n        } else {\n            longest_streak = longest_streak.max(streak);\n            streak = 1;\n        }\n    }\n    longest_streak = longest_streak.max(streak);\n\n    (current_streak, longest_streak)\n}\n\nfn date_diff_days(date1: \u0026str, date2: \u0026str) -\u003e i64 {\n    let parsed1 = NaiveDate::parse_from_str(date1, \"%Y-%m-%d\");\n    let parsed2 = NaiveDate::parse_from_str(date2, \"%Y-%m-%d\");\n\n    match (parsed1, parsed2) {\n        (Ok(d1), Ok(d2)) =\u003e (d2 - d1).num_days().abs(),\n        _ =\u003e 0,\n    }\n}\n\nfn format_tokens_short(tokens: i64) -\u003e String {\n    if tokens \u003e= 1_000_000_000 {\n        format!(\"{:.2}B\", tokens as f64 / 1_000_000_000.0)\n    } else if tokens \u003e= 1_000_000 {\n        format!(\"{:.2}M\", tokens as f64 / 1_000_000.0)\n    } else if tokens \u003e= 1_000 {\n        format!(\"{:.1}K\", tokens as f64 / 1_000.0)\n    } else {\n        tokens.to_string()\n    }\n}\n\nfn format_cost(cost: f64) -\u003e String {\n    if cost \u003e= 1000.0 {\n        format!(\"${:.2}K\", cost / 1000.0)\n    } else {\n        format!(\"${:.2}\", cost)\n    }\n}\n\nfn format_number_with_commas_i64(value: i64) -\u003e String {\n    let sign = if value \u003c 0 { \"-\" } else { \"\" };\n    let digits = value.abs().to_string();\n    let mut result = String::with_capacity(digits.len() + digits.len() / 3 + sign.len());\n\n    result.push_str(sign);\n    for (index, ch) in digits.chars().enumerate() {\n        if index \u003e 0 \u0026\u0026 (digits.len() - index).is_multiple_of(3) {\n            result.push(',');\n        }\n        result.push(ch);\n    }\n\n    result\n}\n\nfn source_display_name(source: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match source {\n        \"opencode\" =\u003e Some(\"OpenCode\"),\n        \"claude\" =\u003e Some(\"Claude Code\"),\n        \"codex\" =\u003e Some(\"Codex CLI\"),\n        \"gemini\" =\u003e Some(\"Gemini CLI\"),\n        \"cursor\" =\u003e Some(\"Cursor IDE\"),\n        \"amp\" =\u003e Some(\"Amp\"),\n        \"droid\" =\u003e Some(\"Droid\"),\n        \"openclaw\" =\u003e Some(\"OpenClaw\"),\n        \"pi\" =\u003e Some(\"Pi\"),\n        _ =\u003e None,\n    }\n}\n\nfn client_logo_url(client_name: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match client_name {\n        \"OpenCode\" =\u003e Some(\"https://tokscale.ai/assets/logos/opencode.png\"),\n        \"Claude Code\" =\u003e Some(\"https://tokscale.ai/assets/logos/claude.jpg\"),\n        \"Codex CLI\" =\u003e Some(\"https://tokscale.ai/assets/logos/openai.jpg\"),\n        \"Gemini CLI\" =\u003e Some(\"https://tokscale.ai/assets/logos/gemini.png\"),\n        \"Cursor IDE\" =\u003e Some(\"https://tokscale.ai/assets/logos/cursor.jpg\"),\n        \"Amp\" =\u003e Some(\"https://tokscale.ai/assets/logos/amp.png\"),\n        \"Droid\" =\u003e Some(\"https://tokscale.ai/assets/logos/droid.png\"),\n        \"OpenClaw\" =\u003e Some(\"https://tokscale.ai/assets/logos/openclaw.png\"),\n        \"Pi\" =\u003e Some(\"https://tokscale.ai/assets/logos/pi.png\"),\n        _ =\u003e None,\n    }\n}\n\nfn provider_logo_url(provider: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match provider {\n        \"anthropic\" =\u003e Some(\"https://tokscale.ai/assets/logos/claude.jpg\"),\n        \"openai\" =\u003e Some(\"https://tokscale.ai/assets/logos/openai.jpg\"),\n        \"google\" =\u003e Some(\"https://tokscale.ai/assets/logos/gemini.png\"),\n        \"xai\" =\u003e Some(\"https://tokscale.ai/assets/logos/grok.jpg\"),\n        \"zai\" =\u003e Some(\"https://tokscale.ai/assets/logos/zai.jpg\"),\n        _ =\u003e None,\n    }\n}\n\nfn get_provider_from_model(model_id: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    let lower = model_id.to_lowercase();\n    if lower.contains(\"claude\")\n        || lower.contains(\"opus\")\n        || lower.contains(\"sonnet\")\n        || lower.contains(\"haiku\")\n    {\n        return Some(\"anthropic\");\n    }\n    if lower.contains(\"gpt\")\n        || lower.contains(\"o1\")\n        || lower.contains(\"o3\")\n        || lower.contains(\"codex\")\n    {\n        return Some(\"openai\");\n    }\n    if lower.contains(\"gemini\") {\n        return Some(\"google\");\n    }\n    if lower.contains(\"grok\") {\n        return Some(\"xai\");\n    }\n    if lower.contains(\"glm\") || lower.contains(\"pickle\") {\n        return Some(\"zai\");\n    }\n    None\n}\n\nfn format_model_name(model: \u0026str) -\u003e String {\n    if let Some(display) = exact_model_display_name(model) {\n        return display.to_string();\n    }\n\n    let (without_quality, suffix) = split_quality_suffix(model);\n    let mut cleaned = without_quality;\n\n    if let Some(index) = cleaned.rfind(':') {\n        let tail = \u0026cleaned[index + 1..];\n        if !tail.is_empty()\n            \u0026\u0026 tail\n                .chars()\n                .all(|c| c.is_ascii_alphanumeric() || c == '-' || c == '_')\n        {\n            cleaned.truncate(index);\n        }\n    }\n\n    if cleaned.to_lowercase().ends_with(\"-thinking\") {\n        cleaned.truncate(cleaned.len() - \"-thinking\".len());\n    } else if cleaned.to_lowercase().ends_with(\"_thinking\") {\n        cleaned.truncate(cleaned.len() - \"_thinking\".len());\n    }\n\n    cleaned = strip_date_suffix(cleaned);\n\n    let normalized = cleaned\n        .to_lowercase()\n        .chars()\n        .filter(|c| c.is_ascii_alphanumeric())\n        .collect::\u003cString\u003e();\n\n    if normalized.contains(\"claudeopus45\") {\n        return format!(\"Claude Opus 4.5{}\", suffix);\n    }\n    if normalized.contains(\"claude4opus\") {\n        return format!(\"Claude 4 Opus{}\", suffix);\n    }\n    if normalized.contains(\"claudeopus4\") {\n        return format!(\"Claude Opus 4{}\", suffix);\n    }\n    if normalized.contains(\"claudesonnet45\") {\n        return format!(\"Claude Sonnet 4.5{}\", suffix);\n    }\n    if normalized.contains(\"claude4sonnet\") {\n        return format!(\"Claude 4 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claudesonnet4\") {\n        return format!(\"Claude Sonnet 4{}\", suffix);\n    }\n    if normalized.contains(\"claudehaiku45\") {\n        return format!(\"Claude Haiku 4.5{}\", suffix);\n    }\n    if normalized.contains(\"claude4haiku\") {\n        return format!(\"Claude 4 Haiku{}\", suffix);\n    }\n    if normalized.contains(\"claudehaiku4\") {\n        return format!(\"Claude Haiku 4{}\", suffix);\n    }\n    if normalized.contains(\"claude37sonnet\") {\n        return format!(\"Claude 3.7 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claude35sonnet\") {\n        return format!(\"Claude 3.5 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claude35haiku\") {\n        return format!(\"Claude 3.5 Haiku{}\", suffix);\n    }\n    if normalized.contains(\"claude3opus\") {\n        return format!(\"Claude 3 Opus{}\", suffix);\n    }\n    if normalized.contains(\"claude3sonnet\") {\n        return format!(\"Claude 3 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claude3haiku\") {\n        return format!(\"Claude 3 Haiku{}\", suffix);\n    }\n    if normalized.contains(\"gpt51\") {\n        return format!(\"GPT-5.1{}\", suffix);\n    }\n    if normalized.contains(\"gpt5\") {\n        return format!(\"GPT-5{}\", suffix);\n    }\n    if normalized.contains(\"gpt4omini\") {\n        return format!(\"GPT-4o Mini{}\", suffix);\n    }\n    if normalized.contains(\"gpt4o\") {\n        return format!(\"GPT-4o{}\", suffix);\n    }\n    if normalized.contains(\"gpt4turbo\") {\n        return format!(\"GPT-4 Turbo{}\", suffix);\n    }\n    if normalized.contains(\"gpt4\") {\n        return format!(\"GPT-4{}\", suffix);\n    }\n    if normalized.starts_with(\"o1mini\") {\n        return format!(\"o1 Mini{}\", suffix);\n    }\n    if normalized.starts_with(\"o1preview\") {\n        return format!(\"o1 Preview{}\", suffix);\n    }\n    if normalized.starts_with(\"o3mini\") {\n        return format!(\"o3 Mini{}\", suffix);\n    }\n    if normalized == \"o1\" {\n        return format!(\"o1{}\", suffix);\n    }\n    if normalized == \"o3\" {\n        return format!(\"o3{}\", suffix);\n    }\n    if normalized.contains(\"gemini3pro\") {\n        return format!(\"Gemini 3 Pro{}\", suffix);\n    }\n    if normalized.contains(\"gemini3flash\") {\n        return format!(\"Gemini 3 Flash{}\", suffix);\n    }\n    if normalized.contains(\"gemini25pro\") {\n        return format!(\"Gemini 2.5 Pro{}\", suffix);\n    }\n    if normalized.contains(\"gemini25flash\") {\n        return format!(\"Gemini 2.5 Flash{}\", suffix);\n    }\n    if normalized.contains(\"gemini20flash\") {\n        return format!(\"Gemini 2.0 Flash{}\", suffix);\n    }\n    if normalized.contains(\"gemini15pro\") {\n        return format!(\"Gemini 1.5 Pro{}\", suffix);\n    }\n    if normalized.contains(\"gemini15flash\") {\n        return format!(\"Gemini 1.5 Flash{}\", suffix);\n    }\n    if normalized.contains(\"grok3mini\") {\n        return format!(\"Grok Code 3 Mini{}\", suffix);\n    }\n    if normalized.contains(\"grok3\") {\n        return format!(\"Grok Code 3{}\", suffix);\n    }\n    if normalized.contains(\"grok\") {\n        return format!(\"Grok Code{}\", suffix);\n    }\n    if normalized.contains(\"deepseekv3\") {\n        return format!(\"DeepSeek V3{}\", suffix);\n    }\n    if normalized.contains(\"deepseekr1\") {\n        return format!(\"DeepSeek R1{}\", suffix);\n    }\n    if normalized.contains(\"deepseek\") {\n        return format!(\"DeepSeek{}\", suffix);\n    }\n\n    let mut fallback = cleaned;\n    let fallback_lower = fallback.to_lowercase();\n    if fallback_lower.starts_with(\"claude-\") || fallback_lower.starts_with(\"claude_\") {\n        fallback = format!(\"Claude {}\", \u0026fallback[7..]);\n    } else if fallback_lower.starts_with(\"gpt-\") || fallback_lower.starts_with(\"gpt_\") {\n        fallback = format!(\"GPT-{}\", \u0026fallback[4..]);\n    } else if fallback_lower.starts_with(\"gemini-\") || fallback_lower.starts_with(\"gemini_\") {\n        fallback = format!(\"Gemini {}\", \u0026fallback[7..]);\n    } else if fallback_lower.starts_with(\"grok-\") || fallback_lower.starts_with(\"grok_\") {\n        fallback = format!(\"Grok Code {}\", \u0026fallback[5..]);\n    }\n\n    let base_name = fallback\n        .split(['-', '_'])\n        .filter(|word| !word.is_empty())\n        .map(capitalize_word)\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\" \")\n        .trim()\n        .to_string();\n\n    if base_name.is_empty() {\n        format!(\"{}{}\", model, suffix)\n    } else {\n        format!(\"{}{}\", base_name, suffix)\n    }\n}\n\nfn exact_model_display_name(model: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match model {\n        \"claude-sonnet-4-20250514\" =\u003e Some(\"Claude Sonnet 4\"),\n        \"claude-3-5-sonnet-20241022\" =\u003e Some(\"Claude 3.5 Sonnet\"),\n        \"claude-3-5-sonnet-20240620\" =\u003e Some(\"Claude 3.5 Sonnet\"),\n        \"claude-3-opus-20240229\" =\u003e Some(\"Claude 3 Opus\"),\n        \"claude-3-haiku-20240307\" =\u003e Some(\"Claude 3 Haiku\"),\n        \"gpt-4o\" =\u003e Some(\"GPT-4o\"),\n        \"gpt-4o-mini\" =\u003e Some(\"GPT-4o Mini\"),\n        \"gpt-4-turbo\" =\u003e Some(\"GPT-4 Turbo\"),\n        \"o1\" =\u003e Some(\"o1\"),\n        \"o1-mini\" =\u003e Some(\"o1 Mini\"),\n        \"o1-preview\" =\u003e Some(\"o1 Preview\"),\n        \"o3-mini\" =\u003e Some(\"o3 Mini\"),\n        \"gemini-2.5-pro\" =\u003e Some(\"Gemini 2.5 Pro\"),\n        \"gemini-2.5-flash\" =\u003e Some(\"Gemini 2.5 Flash\"),\n        \"gemini-2.0-flash\" =\u003e Some(\"Gemini 2.0 Flash\"),\n        \"gemini-1.5-pro\" =\u003e Some(\"Gemini 1.5 Pro\"),\n        \"gemini-1.5-flash\" =\u003e Some(\"Gemini 1.5 Flash\"),\n        \"grok-3\" =\u003e Some(\"Grok 3\"),\n        \"grok-3-mini\" =\u003e Some(\"Grok 3 Mini\"),\n        _ =\u003e None,\n    }\n}\n\nfn split_quality_suffix(model: \u0026str) -\u003e (String, String) {\n    let lower = model.to_lowercase();\n\n    for (needle, label) in [\n        (\"-high\", \" High\"),\n        (\"_high\", \" High\"),\n        (\"-medium\", \" Medium\"),\n        (\"_medium\", \" Medium\"),\n        (\"-low\", \" Low\"),\n        (\"_low\", \" Low\"),\n    ] {\n        if lower.ends_with(needle) {\n            let base = model[..model.len() - needle.len()].to_string();\n            return (base, label.to_string());\n        }\n    }\n\n    (model.to_string(), String::new())\n}\n\nfn strip_date_suffix(mut model: String) -\u003e String {\n    let lower = model.to_lowercase();\n    if lower.len() \u003e 9 {\n        if let Some(last_dash) = model.rfind('-') {\n            let tail = \u0026model[last_dash + 1..];\n            if tail.len() == 8 \u0026\u0026 tail.chars().all(|ch| ch.is_ascii_digit()) {\n                model.truncate(last_dash);\n            }\n        }\n    }\n\n    if let Some(last_dash) = model.rfind('-') {\n        let tail = \u0026model[last_dash + 1..];\n        if tail.chars().all(|ch| ch.is_ascii_digit()) {\n            if let Some(prev_dash) = model[..last_dash].rfind('-') {\n                let prev_tail = \u0026model[prev_dash + 1..last_dash];\n                if prev_tail.starts_with(\"20\")\n                    \u0026\u0026 prev_tail.len() \u003e= 8\n                    \u0026\u0026 prev_tail.len() \u003c= 10\n                    \u0026\u0026 prev_tail.chars().all(|ch| ch.is_ascii_digit())\n                {\n                    model.truncate(prev_dash);\n                }\n            }\n        }\n    }\n\n    model\n}\n\nfn capitalize_word(word: \u0026str) -\u003e String {\n    if word.is_empty() {\n        return String::new();\n    }\n\n    let mut chars = word.chars();\n    let Some(first) = chars.next() else {\n        return String::new();\n    };\n\n    let mut result = String::new();\n    result.extend(first.to_uppercase());\n    result.push_str(\u0026chars.as_str().to_lowercase());\n    result\n}\n\nfn truncate_username(username: \u0026str, max_chars: usize) -\u003e Option\u003cString\u003e {\n    if username.is_empty() {\n        return None;\n    }\n\n    let len = username.chars().count();\n    if len \u003c= max_chars {\n        return Some(username.to_string());\n    }\n\n    if max_chars \u003c= 1 {\n        return Some(\"\\u{2026}\".to_string());\n    }\n\n    let truncated = username.chars().take(max_chars - 1).collect::\u003cString\u003e();\n    Some(format!(\"{}\\u{2026}\", truncated))\n}\n\nfn default_sources() -\u003e Vec\u003cString\u003e {\n    vec![\n        \"opencode\".to_string(),\n        \"claude\".to_string(),\n        \"codex\".to_string(),\n        \"gemini\".to_string(),\n        \"cursor\".to_string(),\n        \"amp\".to_string(),\n        \"droid\".to_string(),\n        \"openclaw\".to_string(),\n        \"pi\".to_string(),\n    ]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    // ========== format_tokens_short tests ==========\n\n    #[test]\n    fn test_format_tokens_short_billions() {\n        assert_eq!(format_tokens_short(1_500_000_000), \"1.50B\");\n        assert_eq!(format_tokens_short(2_340_000_000), \"2.34B\");\n        assert_eq!(format_tokens_short(10_000_000_000), \"10.00B\");\n    }\n\n    #[test]\n    fn test_format_tokens_short_millions() {\n        assert_eq!(format_tokens_short(234_000_000), \"234.00M\");\n        assert_eq!(format_tokens_short(1_500_000), \"1.50M\");\n        assert_eq!(format_tokens_short(999_999_999), \"1000.00M\");\n    }\n\n    #[test]\n    fn test_format_tokens_short_thousands() {\n        assert_eq!(format_tokens_short(5_678), \"5.7K\");\n        assert_eq!(format_tokens_short(1_000), \"1.0K\");\n        assert_eq!(format_tokens_short(999_999), \"1000.0K\");\n    }\n\n    #[test]\n    fn test_format_tokens_short_small_numbers() {\n        assert_eq!(format_tokens_short(123), \"123\");\n        assert_eq!(format_tokens_short(0), \"0\");\n        assert_eq!(format_tokens_short(999), \"999\");\n    }\n\n    // ========== format_cost tests ==========\n\n    #[test]\n    fn test_format_cost_standard() {\n        assert_eq!(format_cost(12.34), \"$12.34\");\n        assert_eq!(format_cost(0.99), \"$0.99\");\n        assert_eq!(format_cost(100.00), \"$100.00\");\n    }\n\n    #[test]\n    fn test_format_cost_thousands() {\n        assert_eq!(format_cost(1234.56), \"$1.23K\");\n        assert_eq!(format_cost(5000.00), \"$5.00K\");\n        assert_eq!(format_cost(999.99), \"$999.99\");\n    }\n\n    #[test]\n    fn test_format_cost_zero() {\n        assert_eq!(format_cost(0.0), \"$0.00\");\n    }\n\n    // ========== format_number_with_commas_i64 tests ==========\n\n    #[test]\n    fn test_format_number_with_commas_i64_large() {\n        assert_eq!(format_number_with_commas_i64(1_234_567), \"1,234,567\");\n        assert_eq!(format_number_with_commas_i64(1_000_000_000), \"1,000,000,000\");\n    }\n\n    #[test]\n    fn test_format_number_with_commas_i64_small() {\n        assert_eq!(format_number_with_commas_i64(100), \"100\");\n        assert_eq!(format_number_with_commas_i64(999), \"999\");\n    }\n\n    #[test]\n    fn test_format_number_with_commas_i64_negative() {\n        assert_eq!(format_number_with_commas_i64(-1_234_567), \"-1,234,567\");\n        assert_eq!(format_number_with_commas_i64(-100), \"-100\");\n    }\n\n    #[test]\n    fn test_format_number_with_commas_i64_zero() {\n        assert_eq!(format_number_with_commas_i64(0), \"0\");\n    }\n\n    // ========== truncate_username tests ==========\n\n    #[test]\n    fn test_truncate_username_long() {\n        assert_eq!(\n            truncate_username(\"very_long_username\", 10),\n            Some(\"very_longâ€¦\".to_string())\n        );\n        assert_eq!(\n            truncate_username(\"abcdefghijklmnop\", 8),\n            Some(\"abcdefgâ€¦\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_truncate_username_short() {\n        assert_eq!(truncate_username(\"short\", 10), Some(\"short\".to_string()));\n        assert_eq!(truncate_username(\"user\", 4), Some(\"user\".to_string()));\n    }\n\n    #[test]\n    fn test_truncate_username_empty() {\n        assert_eq!(truncate_username(\"\", 10), None);\n    }\n\n    #[test]\n    fn test_truncate_username_edge_cases() {\n        assert_eq!(truncate_username(\"a\", 1), Some(\"a\".to_string()));\n        assert_eq!(truncate_username(\"ab\", 1), Some(\"â€¦\".to_string()));\n    }\n\n    // ========== capitalize_word tests ==========\n\n    #[test]\n    fn test_capitalize_word_lowercase() {\n        assert_eq!(capitalize_word(\"hello\"), \"Hello\");\n        assert_eq!(capitalize_word(\"world\"), \"World\");\n    }\n\n    #[test]\n    fn test_capitalize_word_uppercase() {\n        assert_eq!(capitalize_word(\"WORLD\"), \"World\");\n        assert_eq!(capitalize_word(\"HELLO\"), \"Hello\");\n    }\n\n    #[test]\n    fn test_capitalize_word_mixed() {\n        assert_eq!(capitalize_word(\"hElLo\"), \"Hello\");\n        assert_eq!(capitalize_word(\"WoRlD\"), \"World\");\n    }\n\n    #[test]\n    fn test_capitalize_word_empty() {\n        assert_eq!(capitalize_word(\"\"), \"\");\n    }\n\n    #[test]\n    fn test_capitalize_word_single_char() {\n        assert_eq!(capitalize_word(\"a\"), \"A\");\n        assert_eq!(capitalize_word(\"Z\"), \"Z\");\n    }\n\n    // ========== strip_date_suffix tests ==========\n\n    #[test]\n    fn test_strip_date_suffix_with_date() {\n        assert_eq!(\n            strip_date_suffix(\"claude-4-20250514\".to_string()),\n            \"claude-4\"\n        );\n        assert_eq!(\n            strip_date_suffix(\"gpt-4-20240101\".to_string()),\n            \"gpt-4\"\n        );\n    }\n\n    #[test]\n    fn test_strip_date_suffix_without_date() {\n        assert_eq!(strip_date_suffix(\"gpt-5\".to_string()), \"gpt-5\");\n        assert_eq!(strip_date_suffix(\"claude-opus\".to_string()), \"claude-opus\");\n    }\n\n    #[test]\n    fn test_strip_date_suffix_complex() {\n        assert_eq!(\n            strip_date_suffix(\"model-2024-01-15-123\".to_string()),\n            \"model-2024-01-15-123\"\n        );\n    }\n\n    // ========== split_quality_suffix tests ==========\n\n    #[test]\n    fn test_split_quality_suffix_high() {\n        assert_eq!(\n            split_quality_suffix(\"model-high\"),\n            (\"model\".to_string(), \" High\".to_string())\n        );\n        assert_eq!(\n            split_quality_suffix(\"gpt-4_high\"),\n            (\"gpt-4\".to_string(), \" High\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_split_quality_suffix_medium() {\n        assert_eq!(\n            split_quality_suffix(\"model-medium\"),\n            (\"model\".to_string(), \" Medium\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_split_quality_suffix_low() {\n        assert_eq!(\n            split_quality_suffix(\"model-low\"),\n            (\"model\".to_string(), \" Low\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_split_quality_suffix_none() {\n        assert_eq!(\n            split_quality_suffix(\"model\"),\n            (\"model\".to_string(), String::new())\n        );\n        assert_eq!(\n            split_quality_suffix(\"gpt-4\"),\n            (\"gpt-4\".to_string(), String::new())\n        );\n    }\n\n    // ========== format_model_name tests ==========\n\n    #[test]\n    fn test_format_model_name_claude() {\n        assert_eq!(\n            format_model_name(\"claude-sonnet-4-20250514\"),\n            \"Claude Sonnet 4\"\n        );\n        assert_eq!(\n            format_model_name(\"claude-3-5-sonnet-20241022\"),\n            \"Claude 3.5 Sonnet\"\n        );\n        assert_eq!(\n            format_model_name(\"claude-3-opus-20240229\"),\n            \"Claude 3 Opus\"\n        );\n    }\n\n    #[test]\n    fn test_format_model_name_gpt() {\n        assert_eq!(format_model_name(\"gpt-4o\"), \"GPT-4o\");\n        assert_eq!(format_model_name(\"gpt-4o-mini\"), \"GPT-4o Mini\");\n        assert_eq!(format_model_name(\"gpt-5\"), \"GPT-5\");\n    }\n\n    #[test]\n    fn test_format_model_name_gemini() {\n        assert_eq!(format_model_name(\"gemini-2.5-pro\"), \"Gemini 2.5 Pro\");\n        assert_eq!(format_model_name(\"gemini-1.5-flash\"), \"Gemini 1.5 Flash\");\n    }\n\n    #[test]\n    fn test_format_model_name_with_quality_suffix() {\n        assert_eq!(format_model_name(\"gpt-4-high\"), \"GPT-4 High\");\n        assert_eq!(format_model_name(\"claude-opus-low\"), \"Claude opus Low\");\n    }\n\n    // ========== get_provider_from_model tests ==========\n\n    #[test]\n    fn test_get_provider_from_model_anthropic() {\n        assert_eq!(get_provider_from_model(\"claude-3-opus\"), Some(\"anthropic\"));\n        assert_eq!(get_provider_from_model(\"sonnet-4\"), Some(\"anthropic\"));\n        assert_eq!(get_provider_from_model(\"haiku-3.5\"), Some(\"anthropic\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_openai() {\n        assert_eq!(get_provider_from_model(\"gpt-4\"), Some(\"openai\"));\n        assert_eq!(get_provider_from_model(\"o1-preview\"), Some(\"openai\"));\n        assert_eq!(get_provider_from_model(\"codex-001\"), Some(\"openai\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_google() {\n        assert_eq!(get_provider_from_model(\"gemini-pro\"), Some(\"google\"));\n        assert_eq!(get_provider_from_model(\"gemini-2.5-flash\"), Some(\"google\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_xai() {\n        assert_eq!(get_provider_from_model(\"grok-3\"), Some(\"xai\"));\n        assert_eq!(get_provider_from_model(\"grok-code\"), Some(\"xai\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_zai() {\n        assert_eq!(get_provider_from_model(\"glm-4.7\"), Some(\"zai\"));\n        assert_eq!(get_provider_from_model(\"pickle-model\"), Some(\"zai\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_unknown() {\n        assert_eq!(get_provider_from_model(\"unknown-model\"), None);\n        assert_eq!(get_provider_from_model(\"random-123\"), None);\n    }\n\n    // ========== calculate_intensity tests ==========\n\n    #[test]\n    fn test_calculate_intensity_grade4() {\n        assert_eq!(calculate_intensity(100.0, 100.0), 4);\n        assert_eq!(calculate_intensity(75.0, 100.0), 4);\n        assert_eq!(calculate_intensity(80.0, 100.0), 4);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade3() {\n        assert_eq!(calculate_intensity(50.0, 100.0), 3);\n        assert_eq!(calculate_intensity(60.0, 100.0), 3);\n        assert_eq!(calculate_intensity(74.9, 100.0), 3);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade2() {\n        assert_eq!(calculate_intensity(25.0, 100.0), 2);\n        assert_eq!(calculate_intensity(30.0, 100.0), 2);\n        assert_eq!(calculate_intensity(49.9, 100.0), 2);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade1() {\n        assert_eq!(calculate_intensity(10.0, 100.0), 1);\n        assert_eq!(calculate_intensity(24.9, 100.0), 1);\n        assert_eq!(calculate_intensity(0.1, 100.0), 1);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade0() {\n        assert_eq!(calculate_intensity(0.0, 100.0), 0);\n        assert_eq!(calculate_intensity(0.0, 0.0), 0);\n    }\n\n    // ========== calculate_streaks tests ==========\n\n    #[test]\n    fn test_calculate_streaks_consecutive() {\n        let dates = vec![\n            \"2024-01-01\".to_string(),\n            \"2024-01-02\".to_string(),\n            \"2024-01-03\".to_string(),\n            \"2024-01-04\".to_string(),\n        ];\n        let (_current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(longest, 4);\n    }\n\n    #[test]\n    fn test_calculate_streaks_with_gaps() {\n        let dates = vec![\n            \"2024-01-01\".to_string(),\n            \"2024-01-02\".to_string(),\n            \"2024-01-05\".to_string(),\n            \"2024-01-06\".to_string(),\n            \"2024-01-07\".to_string(),\n        ];\n        let (_current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(longest, 3);\n    }\n\n    #[test]\n    fn test_calculate_streaks_empty() {\n        let dates: Vec\u003cString\u003e = vec![];\n        let (current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(current, 0);\n        assert_eq!(longest, 0);\n    }\n\n    #[test]\n    fn test_calculate_streaks_single_day() {\n        let dates = vec![\"2024-01-01\".to_string()];\n        let (_current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(longest, 1);\n    }\n\n    // ========== date_diff_days tests ==========\n\n    #[test]\n    fn test_date_diff_days_forward() {\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-01-10\"), 9);\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-01-02\"), 1);\n    }\n\n    #[test]\n    fn test_date_diff_days_backward() {\n        assert_eq!(date_diff_days(\"2024-01-10\", \"2024-01-01\"), 9);\n        assert_eq!(date_diff_days(\"2024-01-02\", \"2024-01-01\"), 1);\n    }\n\n    #[test]\n    fn test_date_diff_days_same_day() {\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-01-01\"), 0);\n    }\n\n    #[test]\n    fn test_date_diff_days_invalid() {\n        assert_eq!(date_diff_days(\"invalid\", \"2024-01-01\"), 0);\n        assert_eq!(date_diff_days(\"2024-01-01\", \"invalid\"), 0);\n        assert_eq!(date_diff_days(\"invalid\", \"invalid\"), 0);\n    }\n\n    #[test]\n    fn test_date_diff_days_cross_month() {\n        assert_eq!(date_diff_days(\"2024-01-31\", \"2024-02-01\"), 1);\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-02-01\"), 31);\n    }\n}\n","traces":[{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":793,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":808,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":811,"address":[],"length":0,"stats":{"Line":0}},{"line":814,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":828,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":831,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":839,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":854,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":873,"address":[],"length":0,"stats":{"Line":0}},{"line":874,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":885,"address":[],"length":0,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":893,"address":[],"length":0,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":899,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":903,"address":[],"length":0,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":912,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[],"length":0,"stats":{"Line":0}},{"line":925,"address":[],"length":0,"stats":{"Line":0}},{"line":930,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":955,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[],"length":0,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":982,"address":[],"length":0,"stats":{"Line":0}},{"line":984,"address":[],"length":0,"stats":{"Line":0}},{"line":985,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":987,"address":[],"length":0,"stats":{"Line":0}},{"line":988,"address":[],"length":0,"stats":{"Line":0}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":990,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":997,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1000,"address":[],"length":0,"stats":{"Line":0}},{"line":1001,"address":[],"length":0,"stats":{"Line":0}},{"line":1002,"address":[],"length":0,"stats":{"Line":0}},{"line":1003,"address":[],"length":0,"stats":{"Line":0}},{"line":1006,"address":[],"length":0,"stats":{"Line":0}},{"line":1007,"address":[],"length":0,"stats":{"Line":0}},{"line":1013,"address":[],"length":0,"stats":{"Line":0}},{"line":1022,"address":[],"length":0,"stats":{"Line":0}},{"line":1023,"address":[],"length":0,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1032,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1034,"address":[],"length":0,"stats":{"Line":0}},{"line":1035,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1045,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[],"length":0,"stats":{"Line":0}},{"line":1047,"address":[],"length":0,"stats":{"Line":0}},{"line":1050,"address":[],"length":0,"stats":{"Line":0}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1052,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[],"length":0,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1070,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1075,"address":[],"length":0,"stats":{"Line":0}},{"line":1076,"address":[],"length":0,"stats":{"Line":0}},{"line":1077,"address":[],"length":0,"stats":{"Line":0}},{"line":1078,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1080,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1087,"address":[],"length":0,"stats":{"Line":0}},{"line":1088,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1094,"address":[],"length":0,"stats":{"Line":0}},{"line":1096,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1100,"address":[],"length":0,"stats":{"Line":0}},{"line":1101,"address":[],"length":0,"stats":{"Line":0}},{"line":1103,"address":[],"length":0,"stats":{"Line":0}},{"line":1105,"address":[],"length":0,"stats":{"Line":0}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1115,"address":[],"length":0,"stats":{"Line":0}},{"line":1116,"address":[],"length":0,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1120,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1135,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":0}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1139,"address":[],"length":0,"stats":{"Line":0}},{"line":1142,"address":[],"length":0,"stats":{"Line":0}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1151,"address":[],"length":0,"stats":{"Line":0}},{"line":1152,"address":[],"length":0,"stats":{"Line":0}},{"line":1154,"address":[],"length":0,"stats":{"Line":0}},{"line":1155,"address":[],"length":0,"stats":{"Line":0}},{"line":1156,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1162,"address":[],"length":0,"stats":{"Line":0}},{"line":1163,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1165,"address":[],"length":0,"stats":{"Line":0}},{"line":1168,"address":[],"length":0,"stats":{"Line":0}},{"line":1169,"address":[],"length":0,"stats":{"Line":0}},{"line":1170,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1173,"address":[],"length":0,"stats":{"Line":0}},{"line":1174,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1180,"address":[],"length":0,"stats":{"Line":0}},{"line":1181,"address":[],"length":0,"stats":{"Line":0}},{"line":1182,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1194,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1199,"address":[],"length":0,"stats":{"Line":0}},{"line":1200,"address":[],"length":0,"stats":{"Line":0}},{"line":1203,"address":[],"length":0,"stats":{"Line":0}},{"line":1204,"address":[],"length":0,"stats":{"Line":0}},{"line":1205,"address":[],"length":0,"stats":{"Line":0}},{"line":1208,"address":[],"length":0,"stats":{"Line":0}},{"line":1209,"address":[],"length":0,"stats":{"Line":0}},{"line":1210,"address":[],"length":0,"stats":{"Line":0}},{"line":1214,"address":[],"length":0,"stats":{"Line":0}},{"line":1217,"address":[],"length":0,"stats":{"Line":0}},{"line":1220,"address":[],"length":0,"stats":{"Line":0}},{"line":1221,"address":[],"length":0,"stats":{"Line":0}},{"line":1222,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":0}},{"line":1226,"address":[],"length":0,"stats":{"Line":0}},{"line":1227,"address":[],"length":0,"stats":{"Line":0}},{"line":1228,"address":[],"length":0,"stats":{"Line":0}},{"line":1231,"address":[],"length":0,"stats":{"Line":0}},{"line":1232,"address":[],"length":0,"stats":{"Line":0}},{"line":1233,"address":[],"length":0,"stats":{"Line":0}},{"line":1236,"address":[],"length":0,"stats":{"Line":14}},{"line":1237,"address":[],"length":0,"stats":{"Line":26}},{"line":1238,"address":[],"length":0,"stats":{"Line":2}},{"line":1241,"address":[],"length":0,"stats":{"Line":24}},{"line":1242,"address":[],"length":0,"stats":{"Line":12}},{"line":1243,"address":[],"length":0,"stats":{"Line":3}},{"line":1244,"address":[],"length":0,"stats":{"Line":9}},{"line":1245,"address":[],"length":0,"stats":{"Line":3}},{"line":1246,"address":[],"length":0,"stats":{"Line":6}},{"line":1247,"address":[],"length":0,"stats":{"Line":3}},{"line":1249,"address":[],"length":0,"stats":{"Line":3}},{"line":1253,"address":[],"length":0,"stats":{"Line":4}},{"line":1254,"address":[],"length":0,"stats":{"Line":8}},{"line":1255,"address":[],"length":0,"stats":{"Line":1}},{"line":1258,"address":[],"length":0,"stats":{"Line":12}},{"line":1259,"address":[],"length":0,"stats":{"Line":6}},{"line":1260,"address":[],"length":0,"stats":{"Line":6}},{"line":1261,"address":[],"length":0,"stats":{"Line":6}},{"line":1263,"address":[],"length":0,"stats":{"Line":9}},{"line":1264,"address":[],"length":0,"stats":{"Line":6}},{"line":1265,"address":[],"length":0,"stats":{"Line":12}},{"line":1266,"address":[],"length":0,"stats":{"Line":3}},{"line":1267,"address":[],"length":0,"stats":{"Line":0}},{"line":1269,"address":[],"length":0,"stats":{"Line":3}},{"line":1272,"address":[],"length":0,"stats":{"Line":0}},{"line":1273,"address":[],"length":0,"stats":{"Line":0}},{"line":1274,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1281,"address":[],"length":0,"stats":{"Line":10}},{"line":1282,"address":[],"length":0,"stats":{"Line":28}},{"line":1283,"address":[],"length":0,"stats":{"Line":13}},{"line":1284,"address":[],"length":0,"stats":{"Line":6}},{"line":1286,"address":[],"length":0,"stats":{"Line":2}},{"line":1287,"address":[],"length":0,"stats":{"Line":1}},{"line":1290,"address":[],"length":0,"stats":{"Line":6}},{"line":1292,"address":[],"length":0,"stats":{"Line":3}},{"line":1295,"address":[],"length":0,"stats":{"Line":20}},{"line":1296,"address":[],"length":0,"stats":{"Line":80}},{"line":1297,"address":[],"length":0,"stats":{"Line":80}},{"line":1299,"address":[],"length":0,"stats":{"Line":40}},{"line":1300,"address":[],"length":0,"stats":{"Line":85}},{"line":1301,"address":[],"length":0,"stats":{"Line":3}},{"line":1305,"address":[],"length":0,"stats":{"Line":12}},{"line":1306,"address":[],"length":0,"stats":{"Line":12}},{"line":1307,"address":[],"length":0,"stats":{"Line":6}},{"line":1308,"address":[],"length":0,"stats":{"Line":9}},{"line":1309,"address":[],"length":0,"stats":{"Line":6}},{"line":1310,"address":[],"length":0,"stats":{"Line":6}},{"line":1311,"address":[],"length":0,"stats":{"Line":6}},{"line":1313,"address":[],"length":0,"stats":{"Line":6}},{"line":1317,"address":[],"length":0,"stats":{"Line":7}},{"line":1318,"address":[],"length":0,"stats":{"Line":7}},{"line":1319,"address":[],"length":0,"stats":{"Line":4}},{"line":1321,"address":[],"length":0,"stats":{"Line":5}},{"line":1325,"address":[],"length":0,"stats":{"Line":7}},{"line":1326,"address":[],"length":0,"stats":{"Line":21}},{"line":1327,"address":[],"length":0,"stats":{"Line":21}},{"line":1328,"address":[],"length":0,"stats":{"Line":42}},{"line":1330,"address":[],"length":0,"stats":{"Line":21}},{"line":1331,"address":[],"length":0,"stats":{"Line":82}},{"line":1332,"address":[],"length":0,"stats":{"Line":122}},{"line":1333,"address":[],"length":0,"stats":{"Line":7}},{"line":1335,"address":[],"length":0,"stats":{"Line":102}},{"line":1338,"address":[],"length":0,"stats":{"Line":7}},{"line":1341,"address":[],"length":0,"stats":{"Line":0}},{"line":1342,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1345,"address":[],"length":0,"stats":{"Line":0}},{"line":1346,"address":[],"length":0,"stats":{"Line":0}},{"line":1347,"address":[],"length":0,"stats":{"Line":0}},{"line":1348,"address":[],"length":0,"stats":{"Line":0}},{"line":1349,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1351,"address":[],"length":0,"stats":{"Line":0}},{"line":1352,"address":[],"length":0,"stats":{"Line":0}},{"line":1356,"address":[],"length":0,"stats":{"Line":0}},{"line":1357,"address":[],"length":0,"stats":{"Line":0}},{"line":1358,"address":[],"length":0,"stats":{"Line":0}},{"line":1359,"address":[],"length":0,"stats":{"Line":0}},{"line":1360,"address":[],"length":0,"stats":{"Line":0}},{"line":1361,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1365,"address":[],"length":0,"stats":{"Line":0}},{"line":1366,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1371,"address":[],"length":0,"stats":{"Line":0}},{"line":1372,"address":[],"length":0,"stats":{"Line":0}},{"line":1373,"address":[],"length":0,"stats":{"Line":0}},{"line":1374,"address":[],"length":0,"stats":{"Line":0}},{"line":1375,"address":[],"length":0,"stats":{"Line":0}},{"line":1376,"address":[],"length":0,"stats":{"Line":0}},{"line":1377,"address":[],"length":0,"stats":{"Line":0}},{"line":1378,"address":[],"length":0,"stats":{"Line":0}},{"line":1382,"address":[],"length":0,"stats":{"Line":14}},{"line":1383,"address":[],"length":0,"stats":{"Line":42}},{"line":1384,"address":[],"length":0,"stats":{"Line":14}},{"line":1385,"address":[],"length":0,"stats":{"Line":13}},{"line":1386,"address":[],"length":0,"stats":{"Line":13}},{"line":1387,"address":[],"length":0,"stats":{"Line":12}},{"line":1389,"address":[],"length":0,"stats":{"Line":3}},{"line":1391,"address":[],"length":0,"stats":{"Line":11}},{"line":1392,"address":[],"length":0,"stats":{"Line":10}},{"line":1393,"address":[],"length":0,"stats":{"Line":9}},{"line":1394,"address":[],"length":0,"stats":{"Line":9}},{"line":1396,"address":[],"length":0,"stats":{"Line":3}},{"line":1398,"address":[],"length":0,"stats":{"Line":8}},{"line":1399,"address":[],"length":0,"stats":{"Line":2}},{"line":1401,"address":[],"length":0,"stats":{"Line":6}},{"line":1402,"address":[],"length":0,"stats":{"Line":2}},{"line":1404,"address":[],"length":0,"stats":{"Line":7}},{"line":1405,"address":[],"length":0,"stats":{"Line":2}},{"line":1407,"address":[],"length":0,"stats":{"Line":2}},{"line":1410,"address":[],"length":0,"stats":{"Line":10}},{"line":1411,"address":[],"length":0,"stats":{"Line":17}},{"line":1412,"address":[],"length":0,"stats":{"Line":14}},{"line":1415,"address":[],"length":0,"stats":{"Line":9}},{"line":1416,"address":[],"length":0,"stats":{"Line":6}},{"line":1418,"address":[],"length":0,"stats":{"Line":3}},{"line":1419,"address":[],"length":0,"stats":{"Line":0}},{"line":1420,"address":[],"length":0,"stats":{"Line":0}},{"line":1421,"address":[],"length":0,"stats":{"Line":0}},{"line":1422,"address":[],"length":0,"stats":{"Line":0}},{"line":1423,"address":[],"length":0,"stats":{"Line":0}},{"line":1425,"address":[],"length":0,"stats":{"Line":0}},{"line":1429,"address":[],"length":0,"stats":{"Line":3}},{"line":1430,"address":[],"length":0,"stats":{"Line":0}},{"line":1431,"address":[],"length":0,"stats":{"Line":3}},{"line":1432,"address":[],"length":0,"stats":{"Line":0}},{"line":1435,"address":[],"length":0,"stats":{"Line":9}},{"line":1437,"address":[],"length":0,"stats":{"Line":6}},{"line":1440,"address":[],"length":0,"stats":{"Line":45}},{"line":1443,"address":[],"length":0,"stats":{"Line":3}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":3}},{"line":1447,"address":[],"length":0,"stats":{"Line":0}},{"line":1449,"address":[],"length":0,"stats":{"Line":3}},{"line":1450,"address":[],"length":0,"stats":{"Line":0}},{"line":1452,"address":[],"length":0,"stats":{"Line":3}},{"line":1453,"address":[],"length":0,"stats":{"Line":0}},{"line":1455,"address":[],"length":0,"stats":{"Line":3}},{"line":1456,"address":[],"length":0,"stats":{"Line":0}},{"line":1458,"address":[],"length":0,"stats":{"Line":3}},{"line":1459,"address":[],"length":0,"stats":{"Line":0}},{"line":1461,"address":[],"length":0,"stats":{"Line":3}},{"line":1462,"address":[],"length":0,"stats":{"Line":0}},{"line":1464,"address":[],"length":0,"stats":{"Line":3}},{"line":1465,"address":[],"length":0,"stats":{"Line":0}},{"line":1467,"address":[],"length":0,"stats":{"Line":3}},{"line":1468,"address":[],"length":0,"stats":{"Line":0}},{"line":1470,"address":[],"length":0,"stats":{"Line":3}},{"line":1471,"address":[],"length":0,"stats":{"Line":0}},{"line":1473,"address":[],"length":0,"stats":{"Line":3}},{"line":1474,"address":[],"length":0,"stats":{"Line":0}},{"line":1476,"address":[],"length":0,"stats":{"Line":3}},{"line":1477,"address":[],"length":0,"stats":{"Line":0}},{"line":1479,"address":[],"length":0,"stats":{"Line":3}},{"line":1480,"address":[],"length":0,"stats":{"Line":0}},{"line":1482,"address":[],"length":0,"stats":{"Line":3}},{"line":1483,"address":[],"length":0,"stats":{"Line":0}},{"line":1485,"address":[],"length":0,"stats":{"Line":3}},{"line":1486,"address":[],"length":0,"stats":{"Line":0}},{"line":1488,"address":[],"length":0,"stats":{"Line":3}},{"line":1489,"address":[],"length":0,"stats":{"Line":0}},{"line":1491,"address":[],"length":0,"stats":{"Line":3}},{"line":1492,"address":[],"length":0,"stats":{"Line":1}},{"line":1494,"address":[],"length":0,"stats":{"Line":2}},{"line":1495,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":2}},{"line":1498,"address":[],"length":0,"stats":{"Line":0}},{"line":1500,"address":[],"length":0,"stats":{"Line":2}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1503,"address":[],"length":0,"stats":{"Line":2}},{"line":1504,"address":[],"length":0,"stats":{"Line":1}},{"line":1506,"address":[],"length":0,"stats":{"Line":1}},{"line":1507,"address":[],"length":0,"stats":{"Line":0}},{"line":1509,"address":[],"length":0,"stats":{"Line":1}},{"line":1510,"address":[],"length":0,"stats":{"Line":0}},{"line":1512,"address":[],"length":0,"stats":{"Line":1}},{"line":1513,"address":[],"length":0,"stats":{"Line":0}},{"line":1515,"address":[],"length":0,"stats":{"Line":1}},{"line":1516,"address":[],"length":0,"stats":{"Line":0}},{"line":1518,"address":[],"length":0,"stats":{"Line":1}},{"line":1519,"address":[],"length":0,"stats":{"Line":0}},{"line":1521,"address":[],"length":0,"stats":{"Line":1}},{"line":1522,"address":[],"length":0,"stats":{"Line":0}},{"line":1524,"address":[],"length":0,"stats":{"Line":1}},{"line":1525,"address":[],"length":0,"stats":{"Line":0}},{"line":1527,"address":[],"length":0,"stats":{"Line":1}},{"line":1528,"address":[],"length":0,"stats":{"Line":0}},{"line":1530,"address":[],"length":0,"stats":{"Line":1}},{"line":1531,"address":[],"length":0,"stats":{"Line":0}},{"line":1533,"address":[],"length":0,"stats":{"Line":1}},{"line":1534,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":1}},{"line":1537,"address":[],"length":0,"stats":{"Line":0}},{"line":1539,"address":[],"length":0,"stats":{"Line":1}},{"line":1540,"address":[],"length":0,"stats":{"Line":0}},{"line":1542,"address":[],"length":0,"stats":{"Line":1}},{"line":1543,"address":[],"length":0,"stats":{"Line":0}},{"line":1545,"address":[],"length":0,"stats":{"Line":1}},{"line":1546,"address":[],"length":0,"stats":{"Line":0}},{"line":1548,"address":[],"length":0,"stats":{"Line":1}},{"line":1549,"address":[],"length":0,"stats":{"Line":0}},{"line":1551,"address":[],"length":0,"stats":{"Line":1}},{"line":1552,"address":[],"length":0,"stats":{"Line":0}},{"line":1554,"address":[],"length":0,"stats":{"Line":1}},{"line":1555,"address":[],"length":0,"stats":{"Line":0}},{"line":1557,"address":[],"length":0,"stats":{"Line":1}},{"line":1558,"address":[],"length":0,"stats":{"Line":0}},{"line":1561,"address":[],"length":0,"stats":{"Line":2}},{"line":1562,"address":[],"length":0,"stats":{"Line":2}},{"line":1563,"address":[],"length":0,"stats":{"Line":2}},{"line":1564,"address":[],"length":0,"stats":{"Line":3}},{"line":1565,"address":[],"length":0,"stats":{"Line":1}},{"line":1566,"address":[],"length":0,"stats":{"Line":0}},{"line":1567,"address":[],"length":0,"stats":{"Line":0}},{"line":1568,"address":[],"length":0,"stats":{"Line":0}},{"line":1569,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1573,"address":[],"length":0,"stats":{"Line":3}},{"line":1574,"address":[],"length":0,"stats":{"Line":1}},{"line":1575,"address":[],"length":0,"stats":{"Line":3}},{"line":1576,"address":[],"length":0,"stats":{"Line":1}},{"line":1582,"address":[],"length":0,"stats":{"Line":2}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1585,"address":[],"length":0,"stats":{"Line":1}},{"line":1589,"address":[],"length":0,"stats":{"Line":10}},{"line":1590,"address":[],"length":0,"stats":{"Line":10}},{"line":1591,"address":[],"length":0,"stats":{"Line":11}},{"line":1592,"address":[],"length":0,"stats":{"Line":10}},{"line":1593,"address":[],"length":0,"stats":{"Line":8}},{"line":1594,"address":[],"length":0,"stats":{"Line":9}},{"line":1595,"address":[],"length":0,"stats":{"Line":7}},{"line":1596,"address":[],"length":0,"stats":{"Line":8}},{"line":1597,"address":[],"length":0,"stats":{"Line":7}},{"line":1598,"address":[],"length":0,"stats":{"Line":5}},{"line":1599,"address":[],"length":0,"stats":{"Line":5}},{"line":1600,"address":[],"length":0,"stats":{"Line":5}},{"line":1601,"address":[],"length":0,"stats":{"Line":5}},{"line":1602,"address":[],"length":0,"stats":{"Line":5}},{"line":1603,"address":[],"length":0,"stats":{"Line":6}},{"line":1604,"address":[],"length":0,"stats":{"Line":4}},{"line":1605,"address":[],"length":0,"stats":{"Line":4}},{"line":1606,"address":[],"length":0,"stats":{"Line":4}},{"line":1607,"address":[],"length":0,"stats":{"Line":5}},{"line":1608,"address":[],"length":0,"stats":{"Line":3}},{"line":1609,"address":[],"length":0,"stats":{"Line":3}},{"line":1610,"address":[],"length":0,"stats":{"Line":3}},{"line":1614,"address":[],"length":0,"stats":{"Line":9}},{"line":1615,"address":[],"length":0,"stats":{"Line":27}},{"line":1617,"address":[],"length":0,"stats":{"Line":79}},{"line":1618,"address":[],"length":0,"stats":{"Line":18}},{"line":1619,"address":[],"length":0,"stats":{"Line":18}},{"line":1620,"address":[],"length":0,"stats":{"Line":18}},{"line":1621,"address":[],"length":0,"stats":{"Line":18}},{"line":1622,"address":[],"length":0,"stats":{"Line":18}},{"line":1623,"address":[],"length":0,"stats":{"Line":9}},{"line":1625,"address":[],"length":0,"stats":{"Line":70}},{"line":1626,"address":[],"length":0,"stats":{"Line":36}},{"line":1627,"address":[],"length":0,"stats":{"Line":12}},{"line":1631,"address":[],"length":0,"stats":{"Line":6}},{"line":1634,"address":[],"length":0,"stats":{"Line":8}},{"line":1635,"address":[],"length":0,"stats":{"Line":16}},{"line":1636,"address":[],"length":0,"stats":{"Line":8}},{"line":1637,"address":[],"length":0,"stats":{"Line":10}},{"line":1638,"address":[],"length":0,"stats":{"Line":10}},{"line":1639,"address":[],"length":0,"stats":{"Line":43}},{"line":1640,"address":[],"length":0,"stats":{"Line":4}},{"line":1645,"address":[],"length":0,"stats":{"Line":16}},{"line":1646,"address":[],"length":0,"stats":{"Line":16}},{"line":1647,"address":[],"length":0,"stats":{"Line":36}},{"line":1648,"address":[],"length":0,"stats":{"Line":7}},{"line":1649,"address":[],"length":0,"stats":{"Line":3}},{"line":1650,"address":[],"length":0,"stats":{"Line":2}},{"line":1651,"address":[],"length":0,"stats":{"Line":0}},{"line":1652,"address":[],"length":0,"stats":{"Line":0}},{"line":1653,"address":[],"length":0,"stats":{"Line":0}},{"line":1655,"address":[],"length":0,"stats":{"Line":0}},{"line":1661,"address":[],"length":0,"stats":{"Line":8}},{"line":1664,"address":[],"length":0,"stats":{"Line":10}},{"line":1665,"address":[],"length":0,"stats":{"Line":20}},{"line":1666,"address":[],"length":0,"stats":{"Line":1}},{"line":1669,"address":[],"length":0,"stats":{"Line":27}},{"line":1670,"address":[],"length":0,"stats":{"Line":18}},{"line":1671,"address":[],"length":0,"stats":{"Line":0}},{"line":1674,"address":[],"length":0,"stats":{"Line":18}},{"line":1675,"address":[],"length":0,"stats":{"Line":36}},{"line":1676,"address":[],"length":0,"stats":{"Line":27}},{"line":1677,"address":[],"length":0,"stats":{"Line":9}},{"line":1680,"address":[],"length":0,"stats":{"Line":7}},{"line":1681,"address":[],"length":0,"stats":{"Line":14}},{"line":1682,"address":[],"length":0,"stats":{"Line":1}},{"line":1685,"address":[],"length":0,"stats":{"Line":24}},{"line":1686,"address":[],"length":0,"stats":{"Line":6}},{"line":1687,"address":[],"length":0,"stats":{"Line":3}},{"line":1690,"address":[],"length":0,"stats":{"Line":3}},{"line":1691,"address":[],"length":0,"stats":{"Line":1}},{"line":1694,"address":[],"length":0,"stats":{"Line":12}},{"line":1695,"address":[],"length":0,"stats":{"Line":2}},{"line":1698,"address":[],"length":0,"stats":{"Line":0}},{"line":1699,"address":[],"length":0,"stats":{"Line":0}},{"line":1700,"address":[],"length":0,"stats":{"Line":0}},{"line":1701,"address":[],"length":0,"stats":{"Line":0}},{"line":1702,"address":[],"length":0,"stats":{"Line":0}},{"line":1703,"address":[],"length":0,"stats":{"Line":0}},{"line":1704,"address":[],"length":0,"stats":{"Line":0}},{"line":1705,"address":[],"length":0,"stats":{"Line":0}},{"line":1706,"address":[],"length":0,"stats":{"Line":0}},{"line":1707,"address":[],"length":0,"stats":{"Line":0}},{"line":1708,"address":[],"length":0,"stats":{"Line":0}}],"covered":209,"coverable":981},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","cursor.rs"],"content":"use anyhow::{Context, Result};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\nuse std::collections::HashMap;\nuse std::fs;\nuse std::io::Write;\nuse std::path::PathBuf;\n\nfn home_dir() -\u003e Result\u003cPathBuf\u003e {\n    dirs::home_dir().context(\"Could not determine home directory\")\n}\n\nconst USAGE_CSV_ENDPOINT: \u0026str =\n    \"https://cursor.com/api/dashboard/export-usage-events-csv?strategy=tokens\";\nconst USAGE_SUMMARY_ENDPOINT: \u0026str = \"https://cursor.com/api/usage-summary\";\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CursorCredentials {\n    #[serde(rename = \"sessionToken\")]\n    pub session_token: String,\n    #[serde(rename = \"userId\", skip_serializing_if = \"Option::is_none\")]\n    pub user_id: Option\u003cString\u003e,\n    #[serde(rename = \"createdAt\")]\n    pub created_at: String,\n    #[serde(rename = \"expiresAt\", skip_serializing_if = \"Option::is_none\")]\n    pub expires_at: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub label: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct CursorCredentialsStore {\n    pub version: i32,\n    #[serde(rename = \"activeAccountId\")]\n    pub active_account_id: String,\n    pub accounts: HashMap\u003cString, CursorCredentials\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct AccountInfo {\n    pub id: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub label: Option\u003cString\u003e,\n    #[serde(rename = \"userId\", skip_serializing_if = \"Option::is_none\")]\n    pub user_id: Option\u003cString\u003e,\n    #[serde(rename = \"createdAt\")]\n    pub created_at: String,\n    #[serde(rename = \"isActive\")]\n    pub is_active: bool,\n}\n\n#[derive(Debug)]\npub struct SyncCursorResult {\n    pub synced: bool,\n    pub rows: usize,\n    pub error: Option\u003cString\u003e,\n}\n\npub fn get_cursor_credentials_path() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".config/tokscale/cursor-credentials.json\"))\n}\n\nfn get_old_cursor_credentials_path() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".tokscale/cursor-credentials.json\"))\n}\n\npub fn get_cursor_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".config/tokscale/cursor-cache\"))\n}\n\nfn get_old_cursor_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".tokscale/cursor-cache\"))\n}\n\nfn migrate_cache_dir_from_old_path() {\n    let Ok(old_dir) = get_old_cursor_cache_dir() else {\n        return;\n    };\n    let Ok(new_dir) = get_cursor_cache_dir() else {\n        return;\n    };\n    if !new_dir.exists() \u0026\u0026 old_dir.exists() {\n        if fs::create_dir_all(\u0026new_dir).is_ok() {\n            if copy_dir_recursive(\u0026old_dir, \u0026new_dir).is_ok() {\n                let _ = fs::remove_dir_all(\u0026old_dir);\n            }\n        }\n    }\n}\n\nfn copy_dir_recursive(src: \u0026std::path::Path, dst: \u0026std::path::Path) -\u003e Result\u003c()\u003e {\n    for entry in fs::read_dir(src)? {\n        let entry = entry?;\n        let path = entry.path();\n        let target = dst.join(entry.file_name());\n        if path.is_dir() {\n            fs::create_dir_all(\u0026target)?;\n            copy_dir_recursive(\u0026path, \u0026target)?;\n        } else {\n            fs::copy(\u0026path, \u0026target)?;\n        }\n    }\n    Ok(())\n}\n\nfn build_cursor_headers(session_token: \u0026str) -\u003e reqwest::header::HeaderMap {\n    use reqwest::header::HeaderValue;\n\n    let mut headers = reqwest::header::HeaderMap::new();\n    headers.insert(\"Accept\", HeaderValue::from_static(\"*/*\"));\n    headers.insert(\n        \"Accept-Language\",\n        HeaderValue::from_static(\"en-US,en;q=0.9\"),\n    );\n    if let Ok(cookie) = format!(\"WorkosCursorSessionToken={}\", session_token).parse() {\n        headers.insert(\"Cookie\", cookie);\n    }\n    headers.insert(\n        \"Referer\",\n        HeaderValue::from_static(\"https://www.cursor.com/settings\"),\n    );\n    headers.insert(\n        \"User-Agent\",\n        HeaderValue::from_static(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"),\n    );\n    headers\n}\n\nfn count_cursor_csv_rows(csv_text: \u0026str) -\u003e usize {\n    let mut reader = csv::ReaderBuilder::new()\n        .has_headers(true)\n        .flexible(true)\n        .from_reader(csv_text.as_bytes());\n    reader.records().filter_map(|r| r.ok()).count()\n}\n\nfn atomic_write_file(path: \u0026std::path::Path, contents: \u0026str) -\u003e Result\u003c()\u003e {\n     let parent = path\n         .parent()\n         .ok_or_else(|| anyhow::anyhow!(\"Invalid cache path\"))?;\n     if !parent.exists() {\n         fs::create_dir_all(parent)?;\n     }\n\n     let temp_name = format!(\n         \".tmp-{}-{}\",\n         path.file_name()\n             .and_then(|name| name.to_str())\n             .unwrap_or(\"cursor\"),\n         std::process::id()\n     );\n     let temp_path = parent.join(temp_name);\n\n     #[cfg(unix)]\n     {\n         use std::fs::OpenOptions;\n         use std::os::unix::fs::OpenOptionsExt;\n\n         let mut file = OpenOptions::new()\n             .write(true)\n             .create(true)\n             .truncate(true)\n             .mode(0o600)\n             .open(\u0026temp_path)?;\n         file.write_all(contents.as_bytes())?;\n     }\n\n     #[cfg(not(unix))]\n     {\n         fs::write(\u0026temp_path, contents)?;\n     }\n\n     if let Err(err) = fs::rename(\u0026temp_path, path) {\n         if path.exists() {\n             match fs::copy(\u0026temp_path, path) {\n                 Ok(_) =\u003e {\n                     let _ = fs::remove_file(\u0026temp_path);\n                 }\n                 Err(copy_err) =\u003e {\n                     let _ = fs::remove_file(\u0026temp_path);\n                     return Err(anyhow::anyhow!(\n                         \"Failed to persist file with rename ({}) and copy fallback ({})\",\n                         err,\n                         copy_err\n                     ));\n                 }\n             }\n         } else {\n             let _ = fs::remove_file(\u0026temp_path);\n             return Err(err.into());\n         }\n     }\n     Ok(())\n }\n\nfn ensure_config_dir() -\u003e Result\u003c()\u003e {\n    let config_dir = home_dir()?.join(\".config/tokscale\");\n\n    if !config_dir.exists() {\n        fs::create_dir_all(\u0026config_dir)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(\u0026config_dir, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n    Ok(())\n}\n\nfn extract_user_id_from_session_token(token: \u0026str) -\u003e Option\u003cString\u003e {\n    let token = token.trim();\n    if token.contains(\"%3A%3A\") {\n        let user_id = token.split(\"%3A%3A\").next()?.trim();\n        if user_id.is_empty() {\n            return None;\n        }\n        return Some(user_id.to_string());\n    }\n    if token.contains(\"::\") {\n        let user_id = token.split(\"::\").next()?.trim();\n        if user_id.is_empty() {\n            return None;\n        }\n        return Some(user_id.to_string());\n    }\n    None\n}\n\nfn derive_account_id(session_token: \u0026str) -\u003e String {\n    if let Some(user_id) = extract_user_id_from_session_token(session_token) {\n        return user_id;\n    }\n    let mut hasher = Sha256::new();\n    hasher.update(session_token.as_bytes());\n    let hash = hasher.finalize();\n    let hex = format!(\"{:x}\", hash);\n    format!(\"anon-{}\", \u0026hex[..12])\n}\n\nfn sanitize_account_id_for_filename(account_id: \u0026str) -\u003e String {\n    let sanitized: String = account_id\n        .trim()\n        .to_lowercase()\n        .chars()\n        .map(|c| {\n            if c.is_ascii_alphanumeric() || c == '.' || c == '_' || c == '-' {\n                c\n            } else {\n                '-'\n            }\n        })\n        .collect();\n    let trimmed = sanitized.trim_matches('-');\n    let result = if trimmed.len() \u003e 80 {\n        \u0026trimmed[..80]\n    } else {\n        trimmed\n    };\n    if result.is_empty() {\n        \"account\".to_string()\n    } else {\n        result.to_string()\n    }\n}\n\npub fn load_credentials_store() -\u003e Option\u003cCursorCredentialsStore\u003e {\n    let path = get_cursor_credentials_path().ok()?;\n    let old_path = get_old_cursor_credentials_path().ok()?;\n    let read_path = if path.exists() {\n        path.clone()\n    } else if old_path.exists() {\n        old_path\n    } else {\n        return None;\n    };\n\n    let content = fs::read_to_string(\u0026read_path).ok()?;\n\n    if let Ok(mut store) = serde_json::from_str::\u003cCursorCredentialsStore\u003e(\u0026content) {\n        if store.version == 1 \u0026\u0026 !store.accounts.is_empty() {\n            let mut changed = false;\n            if !store.accounts.contains_key(\u0026store.active_account_id) {\n                if let Some(first_id) = store.accounts.keys().next().cloned() {\n                    store.active_account_id = first_id;\n                    changed = true;\n                }\n            }\n            if changed || read_path != path {\n                let _ = save_credentials_store(\u0026store);\n            }\n            if read_path != path {\n                if let Ok(old) = get_old_cursor_credentials_path() {\n                    let _ = fs::remove_file(old);\n                }\n            }\n            return Some(store);\n        }\n    }\n\n    if let Ok(single) = serde_json::from_str::\u003cCursorCredentials\u003e(\u0026content) {\n        let account_id = derive_account_id(\u0026single.session_token);\n        let mut accounts = HashMap::new();\n        accounts.insert(account_id.clone(), single);\n        let migrated = CursorCredentialsStore {\n            version: 1,\n            active_account_id: account_id,\n            accounts,\n        };\n\n        let _ = save_credentials_store(\u0026migrated);\n        if read_path != path {\n            if let Ok(old) = get_old_cursor_credentials_path() {\n                let _ = fs::remove_file(old);\n            }\n        }\n        return Some(migrated);\n    }\n\n    None\n}\n\npub fn save_credentials_store(store: \u0026CursorCredentialsStore) -\u003e Result\u003c()\u003e {\n    ensure_config_dir()?;\n    let path = get_cursor_credentials_path()?;\n    let json = serde_json::to_string_pretty(store)?;\n    atomic_write_file(\u0026path, \u0026json)?;\n\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::PermissionsExt;\n        fs::set_permissions(\u0026path, fs::Permissions::from_mode(0o600))?;\n    }\n\n    Ok(())\n}\n\nfn resolve_account_id(store: \u0026CursorCredentialsStore, name_or_id: \u0026str) -\u003e Option\u003cString\u003e {\n    let needle = name_or_id.trim();\n    if needle.is_empty() {\n        return None;\n    }\n\n    if store.accounts.contains_key(needle) {\n        return Some(needle.to_string());\n    }\n\n    let needle_lower = needle.to_lowercase();\n    for (id, acct) in \u0026store.accounts {\n        if let Some(label) = \u0026acct.label {\n            if label.to_lowercase() == needle_lower {\n                return Some(id.clone());\n            }\n        }\n    }\n\n    None\n}\n\npub fn list_accounts() -\u003e Vec\u003cAccountInfo\u003e {\n    let store = match load_credentials_store() {\n        Some(s) =\u003e s,\n        None =\u003e return vec![],\n    };\n\n    let mut accounts: Vec\u003cAccountInfo\u003e = store\n        .accounts\n        .iter()\n        .map(|(id, acct)| AccountInfo {\n            id: id.clone(),\n            label: acct.label.clone(),\n            user_id: acct.user_id.clone(),\n            created_at: acct.created_at.clone(),\n            is_active: id == \u0026store.active_account_id,\n        })\n        .collect();\n\n    accounts.sort_by(|a, b| {\n        if a.is_active != b.is_active {\n            return if a.is_active {\n                std::cmp::Ordering::Less\n            } else {\n                std::cmp::Ordering::Greater\n            };\n        }\n        let la = a.label.as_deref().unwrap_or(\u0026a.id).to_lowercase();\n        let lb = b.label.as_deref().unwrap_or(\u0026b.id).to_lowercase();\n        la.cmp(\u0026lb)\n    });\n\n    accounts\n}\n\npub fn find_account(name_or_id: \u0026str) -\u003e Option\u003cAccountInfo\u003e {\n    let store = load_credentials_store()?;\n    let resolved = resolve_account_id(\u0026store, name_or_id)?;\n    let acct = store.accounts.get(\u0026resolved)?;\n\n    Some(AccountInfo {\n        id: resolved.clone(),\n        label: acct.label.clone(),\n        user_id: acct.user_id.clone(),\n        created_at: acct.created_at.clone(),\n        is_active: resolved == store.active_account_id,\n    })\n}\n\npub fn save_credentials(token: \u0026str, label: Option\u003c\u0026str\u003e) -\u003e Result\u003cString\u003e {\n    let account_id = derive_account_id(token);\n    let user_id = extract_user_id_from_session_token(token);\n\n    let mut store = load_credentials_store().unwrap_or_else(|| CursorCredentialsStore {\n        version: 1,\n        active_account_id: account_id.clone(),\n        accounts: HashMap::new(),\n    });\n\n    if let Some(lbl) = label {\n        let needle = lbl.trim().to_lowercase();\n        if !needle.is_empty() {\n            for (id, acct) in \u0026store.accounts {\n                if id == \u0026account_id {\n                    continue;\n                }\n                if let Some(existing_label) = \u0026acct.label {\n                    if existing_label.trim().to_lowercase() == needle {\n                        anyhow::bail!(\"Cursor account label already exists: {}\", lbl);\n                    }\n                }\n            }\n        }\n    }\n\n    let credentials = CursorCredentials {\n        session_token: token.to_string(),\n        user_id,\n        created_at: chrono::Utc::now().to_rfc3339(),\n        expires_at: None,\n        label: label.map(|s| s.to_string()),\n    };\n\n    store.accounts.insert(account_id.clone(), credentials);\n    store.active_account_id = account_id.clone();\n\n    save_credentials_store(\u0026store)?;\n\n    Ok(account_id)\n}\n\npub fn remove_account(name_or_id: \u0026str, purge_cache: bool) -\u003e Result\u003c()\u003e {\n    let mut store =\n        load_credentials_store().ok_or_else(|| anyhow::anyhow!(\"No saved Cursor accounts\"))?;\n\n    let resolved = resolve_account_id(\u0026store, name_or_id)\n        .ok_or_else(|| anyhow::anyhow!(\"Account not found: {}\", name_or_id))?;\n\n    let was_active = resolved == store.active_account_id;\n\n    let cache_dir = get_cursor_cache_dir()?;\n    if cache_dir.exists() {\n        let per_account = cache_dir.join(format!(\n            \"usage.{}.csv\",\n            sanitize_account_id_for_filename(\u0026resolved)\n        ));\n        if per_account.exists() {\n            if purge_cache {\n                let _ = fs::remove_file(\u0026per_account);\n            } else {\n                let _ = archive_cache_file(\u0026per_account, \u0026format!(\"usage.{}\", resolved));\n            }\n        }\n        if was_active {\n            let active_file = cache_dir.join(\"usage.csv\");\n            if active_file.exists() {\n                if purge_cache {\n                    let _ = fs::remove_file(\u0026active_file);\n                } else {\n                    let _ = archive_cache_file(\u0026active_file, \u0026format!(\"usage.active.{}\", resolved));\n                }\n            }\n        }\n    }\n\n    store.accounts.remove(\u0026resolved);\n\n    if store.accounts.is_empty() {\n        let path = get_cursor_credentials_path()?;\n        if path.exists() {\n            fs::remove_file(path)?;\n        }\n        return Ok(());\n    }\n\n    if was_active {\n        if let Some(first_id) = store.accounts.keys().next().cloned() {\n            let new_account_file = cache_dir.join(format!(\n                \"usage.{}.csv\",\n                sanitize_account_id_for_filename(\u0026first_id)\n            ));\n            let active_file = cache_dir.join(\"usage.csv\");\n            if new_account_file.exists() {\n                let _ = fs::rename(\u0026new_account_file, \u0026active_file);\n            }\n            store.active_account_id = first_id;\n        }\n    }\n\n    save_credentials_store(\u0026store)?;\n    Ok(())\n}\n\npub fn remove_all_accounts(purge_cache: bool) -\u003e Result\u003c()\u003e {\n    let cache_dir = get_cursor_cache_dir()?;\n    if cache_dir.exists() {\n        if let Ok(entries) = fs::read_dir(\u0026cache_dir) {\n            for entry in entries.flatten() {\n                let name = entry.file_name().to_string_lossy().to_string();\n                if name.starts_with(\"usage\") \u0026\u0026 name.ends_with(\".csv\") {\n                    if purge_cache {\n                        let _ = fs::remove_file(entry.path());\n                    } else {\n                        let _ = archive_cache_file(\u0026entry.path(), \u0026format!(\"usage.all.{}\", name));\n                    }\n                }\n            }\n        }\n    }\n\n    let path = get_cursor_credentials_path()?;\n    if path.exists() {\n        fs::remove_file(path)?;\n    }\n    Ok(())\n}\n\npub fn set_active_account(name_or_id: \u0026str) -\u003e Result\u003c()\u003e {\n    let mut store =\n        load_credentials_store().ok_or_else(|| anyhow::anyhow!(\"No saved Cursor accounts\"))?;\n\n    let resolved = resolve_account_id(\u0026store, name_or_id)\n        .ok_or_else(|| anyhow::anyhow!(\"Account not found: {}\", name_or_id))?;\n\n    let old_active_id = store.active_account_id.clone();\n\n    if resolved != old_active_id {\n        let _ = reconcile_cache_files(\u0026old_active_id, \u0026resolved);\n    }\n\n    store.active_account_id = resolved;\n    save_credentials_store(\u0026store)?;\n\n    Ok(())\n}\n\nfn reconcile_cache_files(old_account_id: \u0026str, new_account_id: \u0026str) -\u003e Result\u003c()\u003e {\n    let cache_dir = get_cursor_cache_dir()?;\n    if !cache_dir.exists() {\n        return Ok(());\n    }\n\n    let active_file = cache_dir.join(\"usage.csv\");\n    let old_account_file = cache_dir.join(format!(\n        \"usage.{}.csv\",\n        sanitize_account_id_for_filename(old_account_id)\n    ));\n    let new_account_file = cache_dir.join(format!(\n        \"usage.{}.csv\",\n        sanitize_account_id_for_filename(new_account_id)\n    ));\n\n    if active_file.exists() {\n        if old_account_file.exists() {\n            let _ = archive_cache_file(\u0026old_account_file, old_account_id);\n        }\n        fs::rename(\u0026active_file, \u0026old_account_file)?;\n    }\n\n    if new_account_file.exists() {\n        if active_file.exists() {\n            let _ = archive_cache_file(\u0026active_file, \"usage.active\");\n        }\n        fs::rename(\u0026new_account_file, \u0026active_file)?;\n    }\n\n    Ok(())\n}\n\npub fn load_active_credentials() -\u003e Option\u003cCursorCredentials\u003e {\n    let store = load_credentials_store()?;\n    store.accounts.get(\u0026store.active_account_id).cloned()\n}\n\nfn is_cursor_usage_csv_filename(name: \u0026str) -\u003e bool {\n    if name == \"usage.csv\" {\n        return true;\n    }\n    if !name.starts_with(\"usage.\") || !name.ends_with(\".csv\") {\n        return false;\n    }\n    if name.starts_with(\"usage.backup\") {\n        return false;\n    }\n    let stem = name.trim_start_matches(\"usage.\").trim_end_matches(\".csv\");\n    !stem.is_empty()\n        \u0026\u0026 stem\n            .chars()\n            .all(|c| c.is_ascii_alphanumeric() || c == '.' || c == '_' || c == '-')\n}\n\npub fn has_cursor_usage_cache() -\u003e bool {\n    migrate_cache_dir_from_old_path();\n    let cache_dir = match get_cursor_cache_dir() {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return false,\n    };\n    if !cache_dir.exists() {\n        return false;\n    }\n\n    match fs::read_dir(cache_dir) {\n        Ok(entries) =\u003e entries\n            .filter_map(|entry| entry.ok())\n            .filter_map(|entry| entry.file_name().into_string().ok())\n            .any(|name| is_cursor_usage_csv_filename(\u0026name)),\n        Err(_) =\u003e false,\n    }\n}\n\npub fn is_cursor_logged_in() -\u003e bool {\n    load_active_credentials().is_some()\n}\n\npub fn load_credentials_for(name_or_id: \u0026str) -\u003e Option\u003cCursorCredentials\u003e {\n    let store = load_credentials_store()?;\n    let resolved = resolve_account_id(\u0026store, name_or_id)?;\n    store.accounts.get(\u0026resolved).cloned()\n}\n\n#[derive(Debug)]\npub struct ValidateSessionResult {\n    pub valid: bool,\n    pub membership_type: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n}\n\npub async fn validate_cursor_session(token: \u0026str) -\u003e ValidateSessionResult {\n    let client = reqwest::Client::new();\n    let response = match client\n        .get(USAGE_SUMMARY_ENDPOINT)\n        .headers(build_cursor_headers(token))\n        .send()\n        .await\n    {\n        Ok(resp) =\u003e resp,\n        Err(e) =\u003e {\n            return ValidateSessionResult {\n                valid: false,\n                membership_type: None,\n                error: Some(format!(\"Failed to connect: {}\", e)),\n            };\n        }\n    };\n\n    if response.status() == reqwest::StatusCode::UNAUTHORIZED\n        || response.status() == reqwest::StatusCode::FORBIDDEN\n    {\n        return ValidateSessionResult {\n            valid: false,\n            membership_type: None,\n            error: Some(\"Session token expired or invalid\".to_string()),\n        };\n    }\n\n    if !response.status().is_success() {\n        return ValidateSessionResult {\n            valid: false,\n            membership_type: None,\n            error: Some(format!(\"API returned status {}\", response.status())),\n        };\n    }\n\n    let data: serde_json::Value = match response.json().await {\n        Ok(d) =\u003e d,\n        Err(e) =\u003e {\n            return ValidateSessionResult {\n                valid: false,\n                membership_type: None,\n                error: Some(format!(\"Failed to parse response: {}\", e)),\n            };\n        }\n    };\n\n    let has_billing_start = data\n        .get(\"billingCycleStart\")\n        .and_then(|v| v.as_str())\n        .is_some();\n    let has_billing_end = data\n        .get(\"billingCycleEnd\")\n        .and_then(|v| v.as_str())\n        .is_some();\n\n    if has_billing_start \u0026\u0026 has_billing_end {\n        let membership_type = data\n            .get(\"membershipType\")\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string());\n        ValidateSessionResult {\n            valid: true,\n            membership_type,\n            error: None,\n        }\n    } else {\n        ValidateSessionResult {\n            valid: false,\n            membership_type: None,\n            error: Some(\"Invalid response format\".to_string()),\n        }\n    }\n}\n\npub async fn fetch_cursor_usage_csv(session_token: \u0026str) -\u003e Result\u003cString\u003e {\n    let client = reqwest::Client::new();\n    let response = client\n        .get(USAGE_CSV_ENDPOINT)\n        .headers(build_cursor_headers(session_token))\n        .send()\n        .await?;\n\n    if response.status() == reqwest::StatusCode::UNAUTHORIZED\n        || response.status() == reqwest::StatusCode::FORBIDDEN\n    {\n        anyhow::bail!(\n            \"Cursor session expired. Please run 'tokscale cursor login' to re-authenticate.\"\n        );\n    }\n\n    if !response.status().is_success() {\n        anyhow::bail!(\"Cursor API returned status {}\", response.status());\n    }\n\n    let text = response.text().await?;\n\n    if !text.starts_with(\"Date,\") {\n        anyhow::bail!(\"Invalid response from Cursor API - expected CSV format\");\n    }\n\n    Ok(text)\n}\n\npub async fn sync_cursor_cache() -\u003e SyncCursorResult {\n    migrate_cache_dir_from_old_path();\n\n    let store = match load_credentials_store() {\n        Some(s) =\u003e s,\n        None =\u003e {\n            return SyncCursorResult {\n                synced: false,\n                rows: 0,\n                error: Some(\"Not authenticated\".to_string()),\n            };\n        }\n    };\n\n    if store.accounts.is_empty() {\n        return SyncCursorResult {\n            synced: false,\n            rows: 0,\n            error: Some(\"Not authenticated\".to_string()),\n        };\n    }\n\n    let cache_dir = match get_cursor_cache_dir() {\n        Ok(d) =\u003e d,\n        Err(e) =\u003e {\n            return SyncCursorResult {\n                synced: false,\n                rows: 0,\n                error: Some(format!(\"Failed to get cache dir: {}\", e)),\n            };\n        }\n    };\n    if let Err(e) = fs::create_dir_all(\u0026cache_dir) {\n        return SyncCursorResult {\n            synced: false,\n            rows: 0,\n            error: Some(format!(\"Failed to create cache dir: {}\", e)),\n        };\n    }\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::PermissionsExt;\n        let _ = fs::set_permissions(\u0026cache_dir, fs::Permissions::from_mode(0o700));\n    }\n\n    let active_dup = cache_dir.join(format!(\n        \"usage.{}.csv\",\n        sanitize_account_id_for_filename(\u0026store.active_account_id)\n    ));\n    if active_dup.exists() {\n        let _ = fs::remove_file(\u0026active_dup);\n    }\n\n    let mut total_rows = 0;\n    let mut success_count = 0;\n    let mut errors: Vec\u003cString\u003e = Vec::new();\n\n    for (account_id, credentials) in \u0026store.accounts {\n        let is_active = account_id == \u0026store.active_account_id;\n\n        match fetch_cursor_usage_csv(\u0026credentials.session_token).await {\n            Ok(csv_text) =\u003e {\n                let file_path = if is_active {\n                    cache_dir.join(\"usage.csv\")\n                } else {\n                    cache_dir.join(format!(\n                        \"usage.{}.csv\",\n                        sanitize_account_id_for_filename(account_id)\n                    ))\n                };\n\n                let row_count = count_cursor_csv_rows(\u0026csv_text);\n\n                if let Err(e) = atomic_write_file(\u0026file_path, \u0026csv_text) {\n                    errors.push(format!(\"{}: {}\", account_id, e));\n                } else {\n                    total_rows += row_count;\n                    success_count += 1;\n                }\n            }\n            Err(e) =\u003e {\n                errors.push(format!(\"{}: {}\", account_id, e));\n            }\n        }\n    }\n\n    if success_count == 0 {\n        return SyncCursorResult {\n            synced: false,\n            rows: 0,\n            error: Some(\n                errors\n                    .first()\n                    .cloned()\n                    .unwrap_or_else(|| \"Cursor sync failed\".to_string()),\n            ),\n        };\n    }\n\n    SyncCursorResult {\n        synced: true,\n        rows: total_rows,\n        error: if errors.is_empty() {\n            None\n        } else {\n            Some(format!(\n                \"Some accounts failed to sync ({}/{})\",\n                errors.len(),\n                store.accounts.len()\n            ))\n        },\n    }\n}\n\nfn archive_cache_file(file_path: \u0026std::path::Path, label: \u0026str) -\u003e Result\u003c()\u003e {\n    let cache_dir = get_cursor_cache_dir()?;\n    let archive_dir = cache_dir.join(\"archive\");\n    if !archive_dir.exists() {\n        fs::create_dir_all(\u0026archive_dir)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(\u0026archive_dir, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n\n    let safe_label = sanitize_account_id_for_filename(label);\n    let ts = chrono::Utc::now().format(\"%Y-%m-%dT%H-%M-%S\").to_string();\n    let dest = archive_dir.join(format!(\"{}-{}.csv\", safe_label, ts));\n    fs::rename(file_path, dest)?;\n    Ok(())\n}\n\npub fn run_cursor_login(name: Option\u003cString\u003e) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use tokio::runtime::Runtime;\n\n    let rt = Runtime::new()?;\n\n    println!(\"\\n  {}\\n\", \"Cursor IDE - Login\".cyan());\n\n    if let Some(ref label) = name {\n        if find_account(label).is_some() {\n            println!(\n                \"  {}\",\n                format!(\n                    \"Account '{}' already exists. Use 'tokscale cursor logout --name {}' first.\",\n                    label, label\n                )\n                .yellow()\n            );\n            println!();\n            return Ok(());\n        }\n    }\n\n    print!(\"  Enter Cursor session token: \");\n    std::io::stdout().flush()?;\n    let token = rpassword::read_password().context(\"Failed to read session token\")?;\n    let token = token.trim().to_string();\n\n    if token.is_empty() {\n        println!(\"\\n  {}\\n\", \"No token provided.\".yellow());\n        return Ok(());\n    }\n\n    println!();\n    println!(\"{}\", \"  Validating session token...\".bright_black());\n\n    let result = rt.block_on(async { validate_cursor_session(\u0026token).await });\n\n    if !result.valid {\n        let msg = result\n            .error\n            .unwrap_or_else(|| \"Invalid session token\".to_string());\n        println!(\n            \"\\n  {}\\n\",\n            format!(\"{}. Please check and try again.\", msg).red()\n        );\n        std::process::exit(1);\n    }\n\n    let account_id = save_credentials(\u0026token, name.as_deref())?;\n\n    let display_name = name.as_deref().unwrap_or(\u0026account_id);\n    println!(\n        \"\\n  {}\",\n        format!(\n            \"Successfully logged in to Cursor as {}\",\n            display_name.bold()\n        )\n        .green()\n    );\n    println!(\"{}\", format!(\"  Account ID: {}\", account_id).bright_black());\n    println!();\n\n    Ok(())\n}\n\npub fn run_cursor_logout(name: Option\u003cString\u003e, all: bool, purge_cache: bool) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    if all {\n        let accounts = list_accounts();\n        if accounts.is_empty() {\n            println!(\"\\n  {}\\n\", \"No saved Cursor accounts.\".yellow());\n            return Ok(());\n        }\n\n        remove_all_accounts(purge_cache)?;\n        println!(\"\\n  {}\\n\", \"Logged out from all Cursor accounts.\".green());\n        return Ok(());\n    }\n\n    if let Some(ref account_name) = name {\n        remove_account(account_name, purge_cache)?;\n        println!(\n            \"\\n  {}\\n\",\n            format!(\"Logged out from Cursor account '{}'.\", account_name).green()\n        );\n        return Ok(());\n    }\n\n    let Some(store) = load_credentials_store() else {\n        println!(\"\\n  {}\\n\", \"No saved Cursor accounts.\".yellow());\n        return Ok(());\n    };\n    let active_id = store.active_account_id.clone();\n    let display = store\n        .accounts\n        .get(\u0026active_id)\n        .and_then(|a| a.label.clone())\n        .unwrap_or_else(|| active_id.clone());\n\n    remove_account(\u0026active_id, purge_cache)?;\n    println!(\n        \"\\n  {}\\n\",\n        format!(\"Logged out from Cursor account '{}'.\", display).green()\n    );\n\n    Ok(())\n}\n\npub fn run_cursor_status(name: Option\u003cString\u003e) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use tokio::runtime::Runtime;\n\n    let rt = Runtime::new()?;\n\n    let credentials = if let Some(ref account_name) = name {\n        load_credentials_for(account_name)\n    } else {\n        load_active_credentials()\n    };\n\n    let credentials = match credentials {\n        Some(c) =\u003e c,\n        None =\u003e {\n            if let Some(ref account_name) = name {\n                println!(\n                    \"\\n  {}\\n\",\n                    format!(\"Account not found: {}\", account_name).red()\n                );\n            } else {\n                println!(\"\\n  {}\", \"No saved Cursor accounts.\".yellow());\n                println!(\n                    \"{}\",\n                    \"  Run 'tokscale cursor login' to authenticate.\\n\".bright_black()\n                );\n            }\n            return Ok(());\n        }\n    };\n\n    println!(\"\\n  {}\\n\", \"Cursor IDE - Status\".cyan());\n\n    let display_name = credentials.label.as_deref().unwrap_or(\"(no label)\");\n    println!(\"{}\", format!(\"  Account: {}\", display_name).white());\n    if let Some(ref uid) = credentials.user_id {\n        println!(\"{}\", format!(\"  User ID: {}\", uid).bright_black());\n    }\n\n    println!(\"{}\", \"  Validating session...\".bright_black());\n\n    let result = rt.block_on(async { validate_cursor_session(\u0026credentials.session_token).await });\n\n    if result.valid {\n        println!(\"  {}\", \"Session: Valid\".green());\n        if let Some(membership) = result.membership_type {\n            println!(\"{}\", format!(\"  Membership: {}\", membership).bright_black());\n        }\n    } else {\n        let msg = result\n            .error\n            .unwrap_or_else(|| \"Invalid / Expired\".to_string());\n        println!(\"  {}\", format!(\"Session: {}\", msg).red());\n    }\n    println!();\n\n    Ok(())\n}\n\npub fn run_cursor_accounts(json: bool) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    let accounts = list_accounts();\n\n    if json {\n        #[derive(Serialize)]\n        struct Output {\n            accounts: Vec\u003cAccountInfo\u003e,\n        }\n        let output = Output { accounts };\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n        return Ok(());\n    }\n\n    if accounts.is_empty() {\n        println!(\"\\n  {}\\n\", \"No saved Cursor accounts.\".yellow());\n        return Ok(());\n    }\n\n    println!(\"{}\", \"\\n  Cursor IDE - Accounts\\n\".cyan());\n    for acct in \u0026accounts {\n        let name = if let Some(ref label) = acct.label {\n            format!(\"{} ({})\", label, acct.id)\n        } else {\n            acct.id.clone()\n        };\n        let marker = if acct.is_active { \"*\" } else { \"-\" };\n        let marker_colored = if acct.is_active {\n            marker.green().to_string()\n        } else {\n            marker.bright_black().to_string()\n        };\n        println!(\"  {} {}\", marker_colored, name);\n    }\n    println!();\n\n    Ok(())\n}\n\npub fn run_cursor_switch(name: \u0026str) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    set_active_account(name)?;\n    println!(\n        \"\\n  {}\\n\",\n        format!(\"Active Cursor account set to {}\", name.bold()).green()\n    );\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::TempDir;\n\n    #[test]\n    fn test_extract_user_id_from_session_token_with_url_encoding() {\n        // Test URL-encoded separator (%3A%3A)\n        assert_eq!(\n            extract_user_id_from_session_token(\"user123%3A%3Atoken456\"),\n            Some(\"user123\".to_string())\n        );\n        assert_eq!(\n            extract_user_id_from_session_token(\"  user123%3A%3Atoken456  \"),\n            Some(\"user123\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_user_id_from_session_token_with_double_colon() {\n        // Test plain :: separator\n        assert_eq!(\n            extract_user_id_from_session_token(\"user456::token789\"),\n            Some(\"user456\".to_string())\n        );\n        assert_eq!(\n            extract_user_id_from_session_token(\"  user456::token789  \"),\n            Some(\"user456\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_user_id_from_session_token_invalid() {\n        // No separator\n        assert_eq!(extract_user_id_from_session_token(\"invalidtoken\"), None);\n        // Empty user ID\n        assert_eq!(extract_user_id_from_session_token(\"%3A%3Atoken\"), None);\n        assert_eq!(extract_user_id_from_session_token(\"::token\"), None);\n        // Empty string\n        assert_eq!(extract_user_id_from_session_token(\"\"), None);\n        // Whitespace only\n        assert_eq!(extract_user_id_from_session_token(\"   \"), None);\n    }\n\n    #[test]\n    fn test_derive_account_id_with_user_id() {\n        // Should extract user ID when present\n        let account_id = derive_account_id(\"user123%3A%3Atoken456\");\n        assert_eq!(account_id, \"user123\");\n\n        let account_id = derive_account_id(\"user456::token789\");\n        assert_eq!(account_id, \"user456\");\n    }\n\n    #[test]\n    fn test_derive_account_id_without_user_id() {\n        // Should generate anon-{hash} when no user ID\n        let account_id = derive_account_id(\"randomtoken\");\n        assert!(account_id.starts_with(\"anon-\"));\n        assert_eq!(account_id.len(), 17); // \"anon-\" + 12 hex chars\n\n        // Same token should produce same hash\n        let account_id2 = derive_account_id(\"randomtoken\");\n        assert_eq!(account_id, account_id2);\n\n        // Different tokens should produce different hashes\n        let account_id3 = derive_account_id(\"differenttoken\");\n        assert_ne!(account_id, account_id3);\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_basic() {\n        // Alphanumeric, dots, underscores, hyphens should be preserved\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user123\"),\n            \"user123\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user.name_123-test\"),\n            \"user.name_123-test\"\n        );\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_unsafe_chars() {\n        // Unsafe characters should be replaced with hyphens\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user@example.com\"),\n            \"user-example.com\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user/name\\\\test\"),\n            \"user-name-test\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user name\"),\n            \"user-name\"\n        );\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_edge_cases() {\n        // Uppercase should be lowercased\n        assert_eq!(\n            sanitize_account_id_for_filename(\"UserName123\"),\n            \"username123\"\n        );\n\n        // Leading/trailing hyphens should be trimmed\n        assert_eq!(\n            sanitize_account_id_for_filename(\"---user---\"),\n            \"user\"\n        );\n\n        // Empty after sanitization should return \"account\"\n        assert_eq!(\n            sanitize_account_id_for_filename(\"@@@\"),\n            \"account\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"\"),\n            \"account\"\n        );\n\n        // Whitespace only should return \"account\"\n        assert_eq!(\n            sanitize_account_id_for_filename(\"   \"),\n            \"account\"\n        );\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_length_limit() {\n        // Should truncate to 80 characters\n        let long_id = \"a\".repeat(100);\n        let sanitized = sanitize_account_id_for_filename(\u0026long_id);\n        assert_eq!(sanitized.len(), 80);\n        assert_eq!(sanitized, \"a\".repeat(80));\n\n        // Should preserve exactly 80 characters\n        let exactly_80 = \"b\".repeat(80);\n        let sanitized = sanitize_account_id_for_filename(\u0026exactly_80);\n        assert_eq!(sanitized.len(), 80);\n    }\n\n    #[test]\n    fn test_count_cursor_csv_rows_valid() {\n        // Valid CSV with header\n        let csv = \"Date,Model,Tokens\\n2024-01-01,gpt-4,100\\n2024-01-02,gpt-4,200\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 2);\n\n        // Single row\n        let csv = \"Date,Model,Tokens\\n2024-01-01,gpt-4,100\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 1);\n    }\n\n    #[test]\n    fn test_count_cursor_csv_rows_empty() {\n        // Header only\n        let csv = \"Date,Model,Tokens\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 0);\n\n        // Empty string\n        let csv = \"\";\n        assert_eq!(count_cursor_csv_rows(csv), 0);\n    }\n\n    #[test]\n    fn test_count_cursor_csv_rows_malformed() {\n        // CSV reader with flexible=true accepts rows with different column counts\n        // This test verifies the actual behavior: all parseable rows are counted\n        let csv = \"Date,Model,Tokens\\n2024-01-01,gpt-4,100\\ninvalid,row\\n2024-01-02,gpt-4,200\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 3);\n    }\n\n    #[test]\n    fn test_atomic_write_file_basic() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let file_path = temp_dir.path().join(\"test.txt\");\n        let contents = \"Hello, world!\";\n\n        atomic_write_file(\u0026file_path, contents)?;\n\n        // Verify file was created and contains correct content\n        assert!(file_path.exists());\n        let read_contents = fs::read_to_string(\u0026file_path)?;\n        assert_eq!(read_contents, contents);\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_atomic_write_file_creates_parent_dirs() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let nested_path = temp_dir.path().join(\"a\").join(\"b\").join(\"c\").join(\"test.txt\");\n        let contents = \"Nested file\";\n\n        atomic_write_file(\u0026nested_path, contents)?;\n\n        // Verify parent directories were created\n        assert!(nested_path.exists());\n        let read_contents = fs::read_to_string(\u0026nested_path)?;\n        assert_eq!(read_contents, contents);\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_atomic_write_file_overwrites_existing() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let file_path = temp_dir.path().join(\"test.txt\");\n\n        // Write initial content\n        atomic_write_file(\u0026file_path, \"Initial\")?;\n        assert_eq!(fs::read_to_string(\u0026file_path)?, \"Initial\");\n\n        // Overwrite with new content\n        atomic_write_file(\u0026file_path, \"Updated\")?;\n        assert_eq!(fs::read_to_string(\u0026file_path)?, \"Updated\");\n\n        Ok(())\n    }\n\n    #[test]\n    #[cfg(unix)]\n    fn test_atomic_write_file_permissions() -\u003e Result\u003c()\u003e {\n        use std::os::unix::fs::PermissionsExt;\n\n        let temp_dir = TempDir::new()?;\n        let file_path = temp_dir.path().join(\"test.txt\");\n\n        atomic_write_file(\u0026file_path, \"Secret\")?;\n\n        // Verify file has 0o600 permissions (owner read/write only)\n        let metadata = fs::metadata(\u0026file_path)?;\n        let permissions = metadata.permissions();\n        assert_eq!(permissions.mode() \u0026 0o777, 0o600);\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_copy_dir_recursive_basic() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let src = temp_dir.path().join(\"src\");\n        let dst = temp_dir.path().join(\"dst\");\n\n        // Create source directory structure\n        fs::create_dir_all(\u0026src)?;\n        fs::write(src.join(\"file1.txt\"), \"Content 1\")?;\n        fs::write(src.join(\"file2.txt\"), \"Content 2\")?;\n\n        // Create destination directory\n        fs::create_dir_all(\u0026dst)?;\n\n        // Copy recursively\n        copy_dir_recursive(\u0026src, \u0026dst)?;\n\n        // Verify files were copied\n        assert!(dst.join(\"file1.txt\").exists());\n        assert!(dst.join(\"file2.txt\").exists());\n        assert_eq!(fs::read_to_string(dst.join(\"file1.txt\"))?, \"Content 1\");\n        assert_eq!(fs::read_to_string(dst.join(\"file2.txt\"))?, \"Content 2\");\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_copy_dir_recursive_nested() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let src = temp_dir.path().join(\"src\");\n        let dst = temp_dir.path().join(\"dst\");\n\n        // Create nested source directory structure\n        fs::create_dir_all(src.join(\"subdir1\").join(\"subdir2\"))?;\n        fs::write(src.join(\"root.txt\"), \"Root\")?;\n        fs::write(src.join(\"subdir1\").join(\"file1.txt\"), \"File 1\")?;\n        fs::write(src.join(\"subdir1\").join(\"subdir2\").join(\"file2.txt\"), \"File 2\")?;\n\n        // Create destination directory\n        fs::create_dir_all(\u0026dst)?;\n\n        // Copy recursively\n        copy_dir_recursive(\u0026src, \u0026dst)?;\n\n        // Verify nested structure was copied\n        assert!(dst.join(\"root.txt\").exists());\n        assert!(dst.join(\"subdir1\").join(\"file1.txt\").exists());\n        assert!(dst.join(\"subdir1\").join(\"subdir2\").join(\"file2.txt\").exists());\n        assert_eq!(fs::read_to_string(dst.join(\"root.txt\"))?, \"Root\");\n        assert_eq!(fs::read_to_string(dst.join(\"subdir1\").join(\"file1.txt\"))?, \"File 1\");\n        assert_eq!(fs::read_to_string(dst.join(\"subdir1\").join(\"subdir2\").join(\"file2.txt\"))?, \"File 2\");\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_copy_dir_recursive_empty_dir() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let src = temp_dir.path().join(\"src\");\n        let dst = temp_dir.path().join(\"dst\");\n\n        // Create empty source directory\n        fs::create_dir_all(\u0026src)?;\n        fs::create_dir_all(\u0026dst)?;\n\n        // Copy recursively (should succeed with no files)\n        copy_dir_recursive(\u0026src, \u0026dst)?;\n\n        // Verify destination exists but is empty\n        assert!(dst.exists());\n        assert_eq!(fs::read_dir(\u0026dst)?.count(), 0);\n\n        Ok(())\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":5}},{"line":92,"address":[],"length":0,"stats":{"Line":17}},{"line":93,"address":[],"length":0,"stats":{"Line":14}},{"line":94,"address":[],"length":0,"stats":{"Line":21}},{"line":95,"address":[],"length":0,"stats":{"Line":35}},{"line":96,"address":[],"length":0,"stats":{"Line":7}},{"line":97,"address":[],"length":0,"stats":{"Line":4}},{"line":98,"address":[],"length":0,"stats":{"Line":6}},{"line":100,"address":[],"length":0,"stats":{"Line":15}},{"line":103,"address":[],"length":0,"stats":{"Line":5}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":5}},{"line":130,"address":[],"length":0,"stats":{"Line":10}},{"line":133,"address":[],"length":0,"stats":{"Line":15}},{"line":134,"address":[],"length":0,"stats":{"Line":32}},{"line":137,"address":[],"length":0,"stats":{"Line":5}},{"line":138,"address":[],"length":0,"stats":{"Line":10}},{"line":140,"address":[],"length":0,"stats":{"Line":5}},{"line":141,"address":[],"length":0,"stats":{"Line":5}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":10}},{"line":147,"address":[],"length":0,"stats":{"Line":10}},{"line":148,"address":[],"length":0,"stats":{"Line":15}},{"line":149,"address":[],"length":0,"stats":{"Line":10}},{"line":150,"address":[],"length":0,"stats":{"Line":5}},{"line":152,"address":[],"length":0,"stats":{"Line":20}},{"line":159,"address":[],"length":0,"stats":{"Line":10}},{"line":164,"address":[],"length":0,"stats":{"Line":10}},{"line":165,"address":[],"length":0,"stats":{"Line":15}},{"line":173,"address":[],"length":0,"stats":{"Line":10}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":5}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":14}},{"line":211,"address":[],"length":0,"stats":{"Line":42}},{"line":212,"address":[],"length":0,"stats":{"Line":28}},{"line":213,"address":[],"length":0,"stats":{"Line":16}},{"line":214,"address":[],"length":0,"stats":{"Line":8}},{"line":215,"address":[],"length":0,"stats":{"Line":1}},{"line":217,"address":[],"length":0,"stats":{"Line":3}},{"line":219,"address":[],"length":0,"stats":{"Line":20}},{"line":220,"address":[],"length":0,"stats":{"Line":16}},{"line":221,"address":[],"length":0,"stats":{"Line":8}},{"line":222,"address":[],"length":0,"stats":{"Line":1}},{"line":224,"address":[],"length":0,"stats":{"Line":3}},{"line":226,"address":[],"length":0,"stats":{"Line":6}},{"line":229,"address":[],"length":0,"stats":{"Line":5}},{"line":230,"address":[],"length":0,"stats":{"Line":7}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":233,"address":[],"length":0,"stats":{"Line":6}},{"line":234,"address":[],"length":0,"stats":{"Line":12}},{"line":235,"address":[],"length":0,"stats":{"Line":9}},{"line":236,"address":[],"length":0,"stats":{"Line":6}},{"line":237,"address":[],"length":0,"stats":{"Line":6}},{"line":240,"address":[],"length":0,"stats":{"Line":12}},{"line":241,"address":[],"length":0,"stats":{"Line":36}},{"line":245,"address":[],"length":0,"stats":{"Line":280}},{"line":246,"address":[],"length":0,"stats":{"Line":582}},{"line":247,"address":[],"length":0,"stats":{"Line":261}},{"line":249,"address":[],"length":0,"stats":{"Line":7}},{"line":253,"address":[],"length":0,"stats":{"Line":24}},{"line":254,"address":[],"length":0,"stats":{"Line":24}},{"line":255,"address":[],"length":0,"stats":{"Line":1}},{"line":257,"address":[],"length":0,"stats":{"Line":11}},{"line":259,"address":[],"length":0,"stats":{"Line":24}},{"line":260,"address":[],"length":0,"stats":{"Line":6}},{"line":262,"address":[],"length":0,"stats":{"Line":18}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":746,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":765,"address":[],"length":0,"stats":{"Line":0}},{"line":766,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":791,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":811,"address":[],"length":0,"stats":{"Line":0}},{"line":812,"address":[],"length":0,"stats":{"Line":0}},{"line":814,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":864,"address":[],"length":0,"stats":{"Line":0}},{"line":865,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":867,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":890,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":907,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":912,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[],"length":0,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":928,"address":[],"length":0,"stats":{"Line":0}},{"line":931,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":937,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":955,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[],"length":0,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":960,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":967,"address":[],"length":0,"stats":{"Line":0}},{"line":969,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":973,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":977,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":984,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":996,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1001,"address":[],"length":0,"stats":{"Line":0}},{"line":1004,"address":[],"length":0,"stats":{"Line":0}},{"line":1005,"address":[],"length":0,"stats":{"Line":0}},{"line":1007,"address":[],"length":0,"stats":{"Line":0}},{"line":1008,"address":[],"length":0,"stats":{"Line":0}},{"line":1009,"address":[],"length":0,"stats":{"Line":0}},{"line":1010,"address":[],"length":0,"stats":{"Line":0}},{"line":1013,"address":[],"length":0,"stats":{"Line":0}},{"line":1014,"address":[],"length":0,"stats":{"Line":0}},{"line":1015,"address":[],"length":0,"stats":{"Line":0}},{"line":1016,"address":[],"length":0,"stats":{"Line":0}},{"line":1019,"address":[],"length":0,"stats":{"Line":0}},{"line":1023,"address":[],"length":0,"stats":{"Line":0}},{"line":1025,"address":[],"length":0,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1035,"address":[],"length":0,"stats":{"Line":0}},{"line":1036,"address":[],"length":0,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1041,"address":[],"length":0,"stats":{"Line":0}},{"line":1042,"address":[],"length":0,"stats":{"Line":0}},{"line":1043,"address":[],"length":0,"stats":{"Line":0}},{"line":1044,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[],"length":0,"stats":{"Line":0}},{"line":1048,"address":[],"length":0,"stats":{"Line":0}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":0}},{"line":1074,"address":[],"length":0,"stats":{"Line":0}},{"line":1076,"address":[],"length":0,"stats":{"Line":0}},{"line":1078,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1080,"address":[],"length":0,"stats":{"Line":0}},{"line":1082,"address":[],"length":0,"stats":{"Line":0}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1088,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1094,"address":[],"length":0,"stats":{"Line":0}},{"line":1095,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1100,"address":[],"length":0,"stats":{"Line":0}}],"covered":64,"coverable":581},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","main.rs"],"content":"mod auth;\nmod commands;\nmod cursor;\nmod tui;\n\nuse anyhow::Result;\nuse clap::{Parser, Subcommand};\nuse std::io::{self, IsTerminal, Write};\nuse std::path::{Path, PathBuf};\nuse std::sync::atomic::{AtomicBool, Ordering};\nuse std::sync::Arc;\nuse std::thread::{self, JoinHandle};\nuse std::time::Duration;\nuse tui::Tab;\n\n#[derive(Parser)]\n#[command(name = \"tokscale\")]\n#[command(author, version, about = \"AI token usage analytics\")]\nstruct Cli {\n    #[command(subcommand)]\n    command: Option\u003cCommands\u003e,\n\n    #[arg(short, long, default_value = \"blue\")]\n    theme: String,\n\n    #[arg(short, long, default_value = \"0\")]\n    refresh: u64,\n\n    #[arg(long)]\n    debug: bool,\n\n    #[arg(long)]\n    test_data: bool,\n\n    #[arg(long, help = \"Output as JSON\")]\n    json: bool,\n\n    #[arg(long, help = \"Use legacy CLI table output\")]\n    light: bool,\n\n    #[arg(long, help = \"Show only OpenCode usage\")]\n    opencode: bool,\n\n    #[arg(long, help = \"Show only Claude Code usage\")]\n    claude: bool,\n\n    #[arg(long, help = \"Show only Codex CLI usage\")]\n    codex: bool,\n\n    #[arg(long, help = \"Show only Gemini CLI usage\")]\n    gemini: bool,\n\n    #[arg(long, help = \"Show only Cursor IDE usage\")]\n    cursor: bool,\n\n    #[arg(long, help = \"Show only Amp usage\")]\n    amp: bool,\n\n    #[arg(long, help = \"Show only Droid usage\")]\n    droid: bool,\n\n    #[arg(long, help = \"Show only OpenClaw usage\")]\n    openclaw: bool,\n\n    #[arg(long, help = \"Show only Pi usage\")]\n    pi: bool,\n\n    #[arg(long, help = \"Show only today's usage\")]\n    today: bool,\n\n    #[arg(long, help = \"Show last 7 days\")]\n    week: bool,\n\n    #[arg(long, help = \"Show current month\")]\n    month: bool,\n\n    #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n    since: Option\u003cString\u003e,\n\n    #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n    until: Option\u003cString\u003e,\n\n    #[arg(long, help = \"Filter by year (YYYY)\")]\n    year: Option\u003cString\u003e,\n\n    #[arg(long, help = \"Show processing time\")]\n    benchmark: bool,\n\n    #[arg(\n        long,\n        value_name = \"STRATEGY\",\n        default_value = \"client,model\",\n        help = \"Grouping strategy for --light and --json output: model, client,model, client,provider,model\"\n    )]\n    group_by: String,\n\n    #[arg(long, help = \"Disable spinner (for AI agents and scripts)\")]\n    no_spinner: bool,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    #[command(about = \"Show model usage report\")]\n    Models {\n        #[arg(long)]\n        json: bool,\n        #[arg(long)]\n        light: bool,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show processing time\")]\n        benchmark: bool,\n        #[arg(\n            long,\n            value_name = \"STRATEGY\",\n            default_value = \"client,model\",\n            help = \"Grouping strategy for --light and --json output: model, client,model, client,provider,model\"\n        )]\n        group_by: String,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Show monthly usage report\")]\n    Monthly {\n        #[arg(long)]\n        json: bool,\n        #[arg(long)]\n        light: bool,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show processing time\")]\n        benchmark: bool,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Show pricing for a model\")]\n    Pricing {\n        model_id: String,\n        #[arg(long, help = \"Output as JSON\")]\n        json: bool,\n        #[arg(long, help = \"Force specific provider (litellm or openrouter)\")]\n        provider: Option\u003cString\u003e,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Show local scan locations and session counts\")]\n    Sources {\n        #[arg(long, help = \"Output as JSON\")]\n        json: bool,\n    },\n    #[command(about = \"Login to Tokscale (opens browser for GitHub auth)\")]\n    Login,\n    #[command(about = \"Logout from Tokscale\")]\n    Logout,\n    #[command(about = \"Show current logged in user\")]\n    Whoami,\n    #[command(about = \"Export contribution graph data as JSON\")]\n    Graph {\n        #[arg(long, help = \"Write to file instead of stdout\")]\n        output: Option\u003cString\u003e,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show processing time\")]\n        benchmark: bool,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Launch interactive TUI with optional filters\")]\n    Tui {\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n    },\n    #[command(about = \"Submit usage data to the Tokscale social platform\")]\n    Submit {\n        #[arg(long, help = \"Include only OpenCode data\")]\n        opencode: bool,\n        #[arg(long, help = \"Include only Claude Code data\")]\n        claude: bool,\n        #[arg(long, help = \"Include only Codex CLI data\")]\n        codex: bool,\n        #[arg(long, help = \"Include only Gemini CLI data\")]\n        gemini: bool,\n        #[arg(long, help = \"Include only Cursor IDE data\")]\n        cursor: bool,\n        #[arg(long, help = \"Include only Amp data\")]\n        amp: bool,\n        #[arg(long, help = \"Include only Droid data\")]\n        droid: bool,\n        #[arg(long, help = \"Include only OpenClaw data\")]\n        openclaw: bool,\n        #[arg(long, help = \"Include only Pi data\")]\n        pi: bool,\n        #[arg(long, help = \"Submit only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Submit last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Submit current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(\n            long,\n            help = \"Show what would be submitted without actually submitting\"\n        )]\n        dry_run: bool,\n    },\n    #[command(about = \"Capture subprocess output for token usage tracking\")]\n    Headless {\n        #[arg(help = \"Source CLI (currently only 'codex' supported)\")]\n        source: String,\n        #[arg(trailing_var_arg = true, allow_hyphen_values = true)]\n        args: Vec\u003cString\u003e,\n        #[arg(long, help = \"Override output format (json or jsonl)\")]\n        format: Option\u003cString\u003e,\n        #[arg(long, help = \"Write captured output to file\")]\n        output: Option\u003cString\u003e,\n        #[arg(long, help = \"Do not auto-add JSON output flags\")]\n        no_auto_flags: bool,\n    },\n    #[command(about = \"Generate year-in-review wrapped image\")]\n    Wrapped {\n        #[arg(long, help = \"Output file path (default: tokscale-{year}-wrapped.png)\")]\n        output: Option\u003cString\u003e,\n        #[arg(long, help = \"Year to generate (default: current year)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(\n            long,\n            help = \"Display total tokens in abbreviated format (e.g., 7.14B)\"\n        )]\n        short: bool,\n        #[arg(long, help = \"Show Top OpenCode Agents (default)\")]\n        agents: bool,\n        #[arg(long, help = \"Show Top Clients instead of Top OpenCode Agents\")]\n        clients: bool,\n        #[arg(long, help = \"Disable pinning of Sisyphus agents in rankings\")]\n        disable_pinned: bool,\n        #[arg(long, help = \"Disable loading spinner (for scripting)\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Cursor IDE integration commands\")]\n    Cursor {\n        #[command(subcommand)]\n        subcommand: CursorSubcommand,\n    },\n}\n\n#[derive(Subcommand)]\nenum CursorSubcommand {\n    #[command(about = \"Login to Cursor (paste your session token)\")]\n    Login {\n        #[arg(long, help = \"Label for this Cursor account (e.g., work, personal)\")]\n        name: Option\u003cString\u003e,\n    },\n    #[command(about = \"Logout from a Cursor account\")]\n    Logout {\n        #[arg(long, help = \"Account label or id\")]\n        name: Option\u003cString\u003e,\n        #[arg(long, help = \"Logout from all Cursor accounts\")]\n        all: bool,\n        #[arg(long, help = \"Also delete cached Cursor usage\")]\n        purge_cache: bool,\n    },\n    #[command(about = \"Check Cursor authentication status\")]\n    Status {\n        #[arg(long, help = \"Account label or id\")]\n        name: Option\u003cString\u003e,\n    },\n    #[command(about = \"List saved Cursor accounts\")]\n    Accounts {\n        #[arg(long, help = \"Output as JSON\")]\n        json: bool,\n    },\n    #[command(about = \"Switch active Cursor account\")]\n    Switch {\n        #[arg(help = \"Account label or id\")]\n        name: String,\n    },\n}\n\nfn main() -\u003e Result\u003c()\u003e {\n    use std::io::IsTerminal;\n\n    let cli = Cli::parse();\n    let can_use_tui = std::io::stdin().is_terminal() \u0026\u0026 std::io::stdout().is_terminal();\n\n    if cli.test_data {\n        return tui::test_data_loading();\n    }\n\n    match cli.command {\n        Some(Commands::Models {\n            json,\n            light,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            benchmark,\n            group_by,\n            no_spinner,\n        }) =\u003e {\n            use tokscale_core::GroupBy;\n\n            let group_by: GroupBy = group_by.parse().unwrap_or_else(|e| {\n                eprintln!(\"Error: {}\", e);\n                std::process::exit(1);\n            });\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            if json || light || !can_use_tui {\n                run_models_report(\n                    json,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    benchmark,\n                    no_spinner || !can_use_tui,\n                    today,\n                    week,\n                    month,\n                    group_by,\n                )\n            } else {\n                tui::run(\n                    \u0026cli.theme,\n                    cli.refresh,\n                    cli.debug,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    Some(Tab::Models),\n                )\n            }\n        }\n        Some(Commands::Monthly {\n            json,\n            light,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            benchmark,\n            no_spinner,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            if json || light || !can_use_tui {\n                run_monthly_report(\n                    json,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    benchmark,\n                    no_spinner || !can_use_tui,\n                    today,\n                    week,\n                    month,\n                )\n            } else {\n                tui::run(\n                    \u0026cli.theme,\n                    cli.refresh,\n                    cli.debug,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    Some(Tab::Daily),\n                )\n            }\n        }\n        Some(Commands::Pricing {\n            model_id,\n            json,\n            provider,\n            no_spinner,\n        }) =\u003e run_pricing_lookup(\u0026model_id, json, provider.as_deref(), no_spinner),\n        Some(Commands::Sources { json }) =\u003e run_sources_command(json),\n        Some(Commands::Login) =\u003e run_login_command(),\n        Some(Commands::Logout) =\u003e run_logout_command(),\n        Some(Commands::Whoami) =\u003e run_whoami_command(),\n        Some(Commands::Graph {\n            output,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            benchmark,\n            no_spinner,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            run_graph_command(output, sources, since, until, year, benchmark, no_spinner)\n        }\n        Some(Commands::Tui {\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            tui::run(\n                \u0026cli.theme,\n                cli.refresh,\n                cli.debug,\n                sources,\n                since,\n                until,\n                year,\n                None,\n            )\n        }\n        Some(Commands::Submit {\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            dry_run,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            run_submit_command(sources, since, until, year, dry_run)\n        }\n        Some(Commands::Headless {\n            source,\n            args,\n            format,\n            output,\n            no_auto_flags,\n        }) =\u003e run_headless_command(\u0026source, args, format, output, no_auto_flags),\n        Some(Commands::Wrapped {\n            output,\n            year,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            short,\n            agents,\n            clients,\n            disable_pinned,\n            no_spinner: _,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            run_wrapped_command(\n                output,\n                year,\n                sources,\n                short,\n                agents,\n                clients,\n                disable_pinned,\n            )\n        }\n        Some(Commands::Cursor { subcommand }) =\u003e run_cursor_command(subcommand),\n        None =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode: cli.opencode,\n                claude: cli.claude,\n                codex: cli.codex,\n                gemini: cli.gemini,\n                cursor: cli.cursor,\n                amp: cli.amp,\n                droid: cli.droid,\n                openclaw: cli.openclaw,\n                pi: cli.pi,\n            });\n            let (since, until) =\n                build_date_filter(cli.today, cli.week, cli.month, cli.since, cli.until);\n            let year = normalize_year_filter(cli.today, cli.week, cli.month, cli.year);\n            let group_by: tokscale_core::GroupBy = cli.group_by.parse().unwrap_or_else(|e| {\n                eprintln!(\"Error: {}\", e);\n                std::process::exit(1);\n            });\n\n            if cli.json {\n                run_models_report(\n                    cli.json,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    cli.benchmark,\n                    cli.no_spinner || cli.json,\n                    cli.today,\n                    cli.week,\n                    cli.month,\n                    group_by,\n                )\n            } else if cli.light || !can_use_tui {\n                run_models_report(\n                    false,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    cli.benchmark,\n                    cli.no_spinner || !can_use_tui,\n                    cli.today,\n                    cli.week,\n                    cli.month,\n                    group_by,\n                )\n            } else {\n                tui::run(\n                    \u0026cli.theme,\n                    cli.refresh,\n                    cli.debug,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    None,\n                )\n            }\n        }\n    }\n}\n\nstruct SourceFlags {\n    opencode: bool,\n    claude: bool,\n    codex: bool,\n    gemini: bool,\n    cursor: bool,\n    amp: bool,\n    droid: bool,\n    openclaw: bool,\n    pi: bool,\n}\n\nfn build_source_filter(flags: SourceFlags) -\u003e Option\u003cVec\u003cString\u003e\u003e {\n    let mut sources = Vec::new();\n    if flags.opencode {\n        sources.push(\"opencode\".to_string());\n    }\n    if flags.claude {\n        sources.push(\"claude\".to_string());\n    }\n    if flags.codex {\n        sources.push(\"codex\".to_string());\n    }\n    if flags.gemini {\n        sources.push(\"gemini\".to_string());\n    }\n    if flags.cursor {\n        sources.push(\"cursor\".to_string());\n    }\n    if flags.amp {\n        sources.push(\"amp\".to_string());\n    }\n    if flags.droid {\n        sources.push(\"droid\".to_string());\n    }\n    if flags.openclaw {\n        sources.push(\"openclaw\".to_string());\n    }\n    if flags.pi {\n        sources.push(\"pi\".to_string());\n    }\n\n    if sources.is_empty() {\n        None\n    } else {\n        Some(sources)\n    }\n}\n\nfn build_date_filter(\n    today: bool,\n    week: bool,\n    month: bool,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n) -\u003e (Option\u003cString\u003e, Option\u003cString\u003e) {\n    use chrono::{Datelike, Duration, Utc};\n\n    // Use UTC for date shortcuts to match TypeScript behavior\n    // TS uses: new Date().toISOString().split(\"T\")[0]\n    if today {\n        let date = Utc::now().format(\"%Y-%m-%d\").to_string();\n        return (Some(date.clone()), Some(date));\n    }\n\n    if week {\n        let end = Utc::now();\n        let start = end - Duration::days(6);\n        return (\n            Some(start.format(\"%Y-%m-%d\").to_string()),\n            Some(end.format(\"%Y-%m-%d\").to_string()),\n        );\n    }\n\n    if month {\n        let now = Utc::now();\n        let start = now.with_day(1).unwrap_or(now);\n        return (\n            Some(start.format(\"%Y-%m-%d\").to_string()),\n            Some(now.format(\"%Y-%m-%d\").to_string()),\n        );\n    }\n\n    (since, until)\n}\n\nfn normalize_year_filter(\n    today: bool,\n    week: bool,\n    month: bool,\n    year: Option\u003cString\u003e,\n) -\u003e Option\u003cString\u003e {\n    if today || week || month {\n        None\n    } else {\n        year\n    }\n}\n\nfn get_date_range_label(\n    today: bool,\n    week: bool,\n    month: bool,\n    since: \u0026Option\u003cString\u003e,\n    until: \u0026Option\u003cString\u003e,\n    year: \u0026Option\u003cString\u003e,\n) -\u003e Option\u003cString\u003e {\n    if today {\n        return Some(\"Today\".to_string());\n    }\n    if week {\n        return Some(\"Last 7 days\".to_string());\n    }\n    if month {\n        let now = chrono::Utc::now();\n        return Some(now.format(\"%B %Y\").to_string());\n    }\n    if let Some(y) = year {\n        return Some(y.clone());\n    }\n    let mut parts = Vec::new();\n    if let Some(s) = since {\n        parts.push(format!(\"from {}\", s));\n    }\n    if let Some(u) = until {\n        parts.push(format!(\"to {}\", u));\n    }\n    if parts.is_empty() {\n        None\n    } else {\n        Some(parts.join(\" \"))\n    }\n}\n\nstruct LightSpinner {\n    running: Arc\u003cAtomicBool\u003e,\n    handle: Option\u003cJoinHandle\u003c()\u003e\u003e,\n}\n\nconst TABLE_PRESET: \u0026str = \"â”‚â”‚â”€â”€â”œâ”€â”¼â”¤â”‚â”€â”¼â”œâ”¤â”¬â”´â”Œâ”â””â”˜\";\n\nimpl LightSpinner {\n    const WIDTH: usize = 8;\n    const HOLD_START: usize = 30;\n    const HOLD_END: usize = 9;\n    const TRAIL_LENGTH: usize = 4;\n    const TRAIL_COLORS: [u8; 6] = [51, 44, 37, 30, 23, 17];\n    const INACTIVE_COLOR: u8 = 240;\n    const FRAME_MS: u64 = 40;\n\n    fn start(message: \u0026'static str) -\u003e Self {\n        let running = Arc::new(AtomicBool::new(true));\n        let running_thread = Arc::clone(\u0026running);\n        let message = message.to_string();\n\n        let handle = thread::spawn(move || {\n            let mut frame = 0usize;\n            let mut stderr = io::stderr().lock();\n\n            let _ = write!(stderr, \"\\x1b[?25l\");\n            let _ = stderr.flush();\n\n            while running_thread.load(Ordering::Relaxed) {\n                let spinner = Self::frame(frame);\n                let _ = write!(stderr, \"\\r\\x1b[K  {} {}\", spinner, message);\n                let _ = stderr.flush();\n                frame = frame.wrapping_add(1);\n                thread::sleep(Duration::from_millis(Self::FRAME_MS));\n            }\n\n            let _ = write!(stderr, \"\\r\\x1b[K\\x1b[?25h\");\n            let _ = stderr.flush();\n        });\n\n        Self {\n            running,\n            handle: Some(handle),\n        }\n    }\n\n    fn stop(mut self) {\n        self.stop_inner();\n    }\n\n    fn stop_inner(\u0026mut self) {\n        self.running.store(false, Ordering::Relaxed);\n        if let Some(handle) = self.handle.take() {\n            let _ = handle.join();\n        }\n    }\n\n    fn frame(frame: usize) -\u003e String {\n        let (position, forward) = Self::scanner_state(frame);\n        let mut out = String::new();\n\n        for i in 0..Self::WIDTH {\n            let distance = if forward {\n                if position \u003e= i {\n                    position - i\n                } else {\n                    usize::MAX\n                }\n            } else if i \u003e= position {\n                i - position\n            } else {\n                usize::MAX\n            };\n\n            if distance \u003c Self::TRAIL_LENGTH {\n                let color = Self::TRAIL_COLORS[distance.min(Self::TRAIL_COLORS.len() - 1)];\n                out.push_str(\u0026format!(\"\\x1b[38;5;{}mâ– \\x1b[0m\", color));\n            } else {\n                out.push_str(\u0026format!(\"\\x1b[38;5;{}mâ¬\\x1b[0m\", Self::INACTIVE_COLOR));\n            }\n        }\n\n        out\n    }\n\n    fn scanner_state(frame: usize) -\u003e (usize, bool) {\n        let forward_frames = Self::WIDTH;\n        let backward_frames = Self::WIDTH - 1;\n        let total_cycle = forward_frames + Self::HOLD_END + backward_frames + Self::HOLD_START;\n        let normalized = frame % total_cycle;\n\n        if normalized \u003c forward_frames {\n            (normalized, true)\n        } else if normalized \u003c forward_frames + Self::HOLD_END {\n            (Self::WIDTH - 1, true)\n        } else if normalized \u003c forward_frames + Self::HOLD_END + backward_frames {\n            (\n                Self::WIDTH - 2 - (normalized - forward_frames - Self::HOLD_END),\n                false,\n            )\n        } else {\n            (0, false)\n        }\n    }\n}\n\nimpl Drop for LightSpinner {\n    fn drop(\u0026mut self) {\n        self.stop_inner();\n    }\n}\n\nfn run_models_report(\n    json: bool,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    benchmark: bool,\n    no_spinner: bool,\n    today: bool,\n    week: bool,\n    month_flag: bool,\n    group_by: tokscale_core::GroupBy,\n) -\u003e Result\u003c()\u003e {\n    use std::time::Instant;\n    use tokio::runtime::Runtime;\n    use tokscale_core::{get_model_report, GroupBy, ReportOptions};\n\n    let date_range = get_date_range_label(today, week, month_flag, \u0026since, \u0026until, \u0026year);\n\n    let spinner = if no_spinner {\n        None\n    } else {\n        Some(LightSpinner::start(\"Scanning session data...\"))\n    };\n    let start = Instant::now();\n    let rt = Runtime::new()?;\n    let report = rt\n        .block_on(async {\n            get_model_report(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: group_by.clone(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    if let Some(spinner) = spinner {\n        spinner.stop();\n    }\n\n    let processing_time_ms = start.elapsed().as_millis();\n\n    if json {\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct ModelUsageJson {\n            source: String,\n            merged_clients: Option\u003cString\u003e,\n            model: String,\n            provider: String,\n            input: i64,\n            output: i64,\n            cache_read: i64,\n            cache_write: i64,\n            reasoning: i64,\n            message_count: i32,\n            cost: f64,\n        }\n\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct ModelReportJson {\n            group_by: String,\n            entries: Vec\u003cModelUsageJson\u003e,\n            total_input: i64,\n            total_output: i64,\n            total_cache_read: i64,\n            total_cache_write: i64,\n            total_messages: i32,\n            total_cost: f64,\n            processing_time_ms: u32,\n        }\n\n        let output = ModelReportJson {\n            group_by: group_by.to_string(),\n            entries: report\n                .entries\n                .into_iter()\n                .map(|e| ModelUsageJson {\n                    source: e.source,\n                    merged_clients: e.merged_clients,\n                    model: e.model,\n                    provider: e.provider,\n                    input: e.input,\n                    output: e.output,\n                    cache_read: e.cache_read,\n                    cache_write: e.cache_write,\n                    reasoning: e.reasoning,\n                    message_count: e.message_count,\n                    cost: e.cost,\n                })\n                .collect(),\n            total_input: report.total_input,\n            total_output: report.total_output,\n            total_cache_read: report.total_cache_read,\n            total_cache_write: report.total_cache_write,\n            total_messages: report.total_messages,\n            total_cost: report.total_cost,\n            processing_time_ms: report.processing_time_ms,\n        };\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n    } else {\n        use comfy_table::{Attribute, Cell, CellAlignment, Color, ContentArrangement, Table};\n\n        let term_width = crossterm::terminal::size()\n            .map(|(w, _)| w as usize)\n            .unwrap_or(120);\n        let compact = term_width \u003c 100;\n\n        let mut table = Table::new();\n        table.load_preset(TABLE_PRESET);\n        let arrangement = if std::io::stdout().is_terminal() {\n            ContentArrangement::DynamicFullWidth\n        } else {\n            ContentArrangement::Dynamic\n        };\n        table.set_content_arrangement(arrangement);\n        table.enforce_styling();\n\n        if compact {\n            match group_by {\n                GroupBy::Model =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Clients\").fg(Color::Cyan),\n                        Cell::new(\"Providers\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        let clients_str = entry.merged_clients.as_deref().unwrap_or(\u0026entry.source);\n                        let capitalized_clients = clients_str\n                            .split(\", \")\n                            .map(|s| capitalize_source(s))\n                            .collect::\u003cVec\u003c_\u003e\u003e()\n                            .join(\", \");\n                        table.add_row(vec![\n                            Cell::new(capitalized_clients),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n                GroupBy::ClientModel | GroupBy::ClientProviderModel =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Client\").fg(Color::Cyan),\n                        Cell::new(\"Provider\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        table.add_row(vec![\n                            Cell::new(capitalize_source(\u0026entry.source)),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n            }\n        } else {\n            match group_by {\n                GroupBy::Model =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Clients\").fg(Color::Cyan),\n                        Cell::new(\"Providers\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cache Write\").fg(Color::Cyan),\n                        Cell::new(\"Cache Read\").fg(Color::Cyan),\n                        Cell::new(\"Total\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        let total = entry.input + entry.output + entry.cache_write + entry.cache_read;\n\n                        let clients_str = entry.merged_clients.as_deref().unwrap_or(\u0026entry.source);\n                        let capitalized_clients = clients_str\n                            .split(\", \")\n                            .map(|s| capitalize_source(s))\n                            .collect::\u003cVec\u003c_\u003e\u003e()\n                            .join(\", \");\n                        table.add_row(vec![\n                            Cell::new(capitalized_clients),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_write))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_read))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(total))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    let total_all = report.total_input\n                        + report.total_output\n                        + report.total_cache_write\n                        + report.total_cache_read;\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_write))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_read))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(total_all))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n                GroupBy::ClientModel | GroupBy::ClientProviderModel =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Client\").fg(Color::Cyan),\n                        Cell::new(\"Provider\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Resolved\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cache Write\").fg(Color::Cyan),\n                        Cell::new(\"Cache Read\").fg(Color::Cyan),\n                        Cell::new(\"Total\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        let total = entry.input + entry.output + entry.cache_write + entry.cache_read;\n\n                        table.add_row(vec![\n                            Cell::new(capitalize_source(\u0026entry.source)),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_model_name(\u0026entry.model)),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_write))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_read))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(total))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    let total_all = report.total_input\n                        + report.total_output\n                        + report.total_cache_write\n                        + report.total_cache_read;\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_write))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_read))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(total_all))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n            }\n        }\n\n        let title = match \u0026date_range {\n            Some(range) =\u003e format!(\"Token Usage Report by Model ({})\", range),\n            None =\u003e \"Token Usage Report by Model\".to_string(),\n        };\n        println!(\"\\n  \\x1b[36m{}\\x1b[0m\\n\", title);\n        println!(\"{}\", dim_borders(\u0026table.to_string()));\n\n        let total_tokens =\n            report.total_input + report.total_output + report.total_cache_write + report.total_cache_read;\n        println!(\n            \"\\x1b[90m\\n  Total: {} messages, {} tokens, \\x1b[32m{}\\x1b[90m\\x1b[0m\",\n            format_tokens_with_commas(report.total_messages as i64),\n            format_tokens_with_commas(total_tokens),\n            format_currency(report.total_cost)\n        );\n\n        if benchmark {\n            use colored::Colorize;\n            println!(\n                \"{}\",\n                format!(\"  Processing time: {}ms (Rust native)\", processing_time_ms).bright_black()\n            );\n        }\n    }\n\n    Ok(())\n}\n\nfn run_monthly_report(\n    json: bool,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    benchmark: bool,\n    no_spinner: bool,\n    today: bool,\n    week: bool,\n    month_flag: bool,\n) -\u003e Result\u003c()\u003e {\n    use std::time::Instant;\n    use tokio::runtime::Runtime;\n    use tokscale_core::{get_monthly_report, GroupBy, ReportOptions};\n\n    let date_range = get_date_range_label(today, week, month_flag, \u0026since, \u0026until, \u0026year);\n\n    let spinner = if no_spinner {\n        None\n    } else {\n        Some(LightSpinner::start(\"Scanning session data...\"))\n    };\n    let start = Instant::now();\n    let rt = Runtime::new()?;\n    let report = rt\n        .block_on(async {\n            get_monthly_report(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: GroupBy::default(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    if let Some(spinner) = spinner {\n        spinner.stop();\n    }\n\n    let processing_time_ms = start.elapsed().as_millis();\n\n    if json {\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct MonthlyUsageJson {\n            month: String,\n            models: Vec\u003cString\u003e,\n            input: i64,\n            output: i64,\n            cache_read: i64,\n            cache_write: i64,\n            message_count: i32,\n            cost: f64,\n        }\n\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct MonthlyReportJson {\n            entries: Vec\u003cMonthlyUsageJson\u003e,\n            total_cost: f64,\n            processing_time_ms: u32,\n        }\n\n        let output = MonthlyReportJson {\n            entries: report\n                .entries\n                .into_iter()\n                .map(|e| MonthlyUsageJson {\n                    month: e.month,\n                    models: e.models,\n                    input: e.input,\n                    output: e.output,\n                    cache_read: e.cache_read,\n                    cache_write: e.cache_write,\n                    message_count: e.message_count,\n                    cost: e.cost,\n                })\n                .collect(),\n            total_cost: report.total_cost,\n            processing_time_ms: report.processing_time_ms,\n        };\n\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n    } else {\n        use comfy_table::{Attribute, Cell, CellAlignment, Color, ContentArrangement, Table};\n\n        let term_width = crossterm::terminal::size()\n            .map(|(w, _)| w as usize)\n            .unwrap_or(120);\n        let compact = term_width \u003c 100;\n\n        let mut table = Table::new();\n        table.load_preset(TABLE_PRESET);\n        let arrangement = if std::io::stdout().is_terminal() {\n            ContentArrangement::DynamicFullWidth\n        } else {\n            ContentArrangement::Dynamic\n        };\n        table.set_content_arrangement(arrangement);\n        table.enforce_styling();\n        if compact {\n            table.set_header(vec![\n                Cell::new(\"Month\").fg(Color::Cyan),\n                Cell::new(\"Models\").fg(Color::Cyan),\n                Cell::new(\"Input\").fg(Color::Cyan),\n                Cell::new(\"Output\").fg(Color::Cyan),\n                Cell::new(\"Cost\").fg(Color::Cyan),\n            ]);\n\n            for entry in \u0026report.entries {\n                let models_col = if entry.models.is_empty() {\n                    \"-\".to_string()\n                } else {\n                    let mut unique_models: Vec\u003cString\u003e = entry\n                        .models\n                        .iter()\n                        .map(|model| format_model_name(model))\n                        .collect::\u003cstd::collections::BTreeSet\u003c_\u003e\u003e()\n                        .into_iter()\n                        .collect();\n                    unique_models.sort();\n                    unique_models\n                        .iter()\n                        .map(|m| format!(\"- {}\", m))\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"\\n\")\n                };\n\n                table.add_row(vec![\n                    Cell::new(entry.month.clone()),\n                    Cell::new(models_col),\n                    Cell::new(format_tokens_with_commas(entry.input)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.output)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                ]);\n            }\n\n            table.add_row(vec![\n                Cell::new(\"Total\")\n                    .fg(Color::Yellow)\n                    .add_attribute(Attribute::Bold),\n                Cell::new(\"\"),\n                Cell::new(format_tokens_with_commas(report.entries.iter().map(|e| e.input).sum()))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(report.entries.iter().map(|e| e.output).sum()))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_currency(report.total_cost))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n            ]);\n        } else {\n            table.set_header(vec![\n                Cell::new(\"Month\").fg(Color::Cyan),\n                Cell::new(\"Models\").fg(Color::Cyan),\n                Cell::new(\"Input\").fg(Color::Cyan),\n                Cell::new(\"Output\").fg(Color::Cyan),\n                Cell::new(\"Cache Write\").fg(Color::Cyan),\n                Cell::new(\"Cache Read\").fg(Color::Cyan),\n                Cell::new(\"Total\").fg(Color::Cyan),\n                Cell::new(\"Cost\").fg(Color::Cyan),\n            ]);\n\n            for entry in \u0026report.entries {\n                let models_col = if entry.models.is_empty() {\n                    \"-\".to_string()\n                } else {\n                    let mut unique_models: Vec\u003cString\u003e = entry\n                        .models\n                        .iter()\n                        .map(|model| format_model_name(model))\n                        .collect::\u003cstd::collections::BTreeSet\u003c_\u003e\u003e()\n                        .into_iter()\n                        .collect();\n                    unique_models.sort();\n                    unique_models\n                        .iter()\n                        .map(|m| format!(\"- {}\", m))\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"\\n\")\n                };\n                let total = entry.input + entry.output + entry.cache_write + entry.cache_read;\n\n                table.add_row(vec![\n                    Cell::new(entry.month.clone()),\n                    Cell::new(models_col),\n                    Cell::new(format_tokens_with_commas(entry.input)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.output)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.cache_write))\n                        .set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.cache_read))\n                        .set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(total)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                ]);\n            }\n\n            let total_input: i64 = report.entries.iter().map(|e| e.input).sum();\n            let total_output: i64 = report.entries.iter().map(|e| e.output).sum();\n            let total_cache_write: i64 = report.entries.iter().map(|e| e.cache_write).sum();\n            let total_cache_read: i64 = report.entries.iter().map(|e| e.cache_read).sum();\n            let total_all = total_input + total_output + total_cache_write + total_cache_read;\n\n            table.add_row(vec![\n                Cell::new(\"Total\")\n                    .fg(Color::Yellow)\n                    .add_attribute(Attribute::Bold),\n                Cell::new(\"\"),\n                Cell::new(format_tokens_with_commas(total_input))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_output))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_cache_write))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_cache_read))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_all))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_currency(report.total_cost))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n            ]);\n        }\n\n        let title = match \u0026date_range {\n            Some(range) =\u003e format!(\"Monthly Token Usage Report ({})\", range),\n            None =\u003e \"Monthly Token Usage Report\".to_string(),\n        };\n        println!(\"\\n  \\x1b[36m{}\\x1b[0m\\n\", title);\n        println!(\"{}\", dim_borders(\u0026table.to_string()));\n\n        println!(\n            \"\\x1b[90m\\n  Total Cost: \\x1b[32m{}\\x1b[90m\\x1b[0m\",\n            format_currency(report.total_cost)\n        );\n\n        if benchmark {\n            use colored::Colorize;\n            println!(\n                \"{}\",\n                format!(\"  Processing time: {}ms (Rust native)\", processing_time_ms).bright_black()\n            );\n        }\n    }\n\n    Ok(())\n}\n\nfn run_wrapped_command(\n    output: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    short: bool,\n    agents: bool,\n    clients: bool,\n    disable_pinned: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    println!(\"{}\", \"\\n  Tokscale - Generate Wrapped Image\\n\".cyan());\n\n    println!(\"{}\", \"  Generating wrapped image...\".bright_black());\n    println!();\n\n    let include_agents = !clients || agents;\n    let wrapped_options = commands::wrapped::WrappedOptions {\n        output,\n        year,\n        sources,\n        short,\n        include_agents,\n        pin_sisyphus: !disable_pinned,\n    };\n\n    match commands::wrapped::run(wrapped_options) {\n        Ok(output_path) =\u003e {\n            println!(\n                \"{}\",\n                format!(\"\\n  âœ“ Generated wrapped image: {}\\n\", output_path).green()\n            );\n        }\n        Err(err) =\u003e {\n            eprintln!(\"{}\", \"\\nError generating wrapped image:\".red());\n            eprintln!(\"{}\", format!(\"  {}\\n\", err));\n            std::process::exit(1);\n        }\n    }\n\n    Ok(())\n}\n\nfn run_pricing_lookup(\n    model_id: \u0026str,\n    json: bool,\n    provider: Option\u003c\u0026str\u003e,\n    no_spinner: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use indicatif::ProgressBar;\n    use indicatif::ProgressStyle;\n    use tokio::runtime::Runtime;\n    use tokscale_core::pricing::PricingService;\n\n    let provider_normalized = provider.map(|p| p.to_lowercase());\n    if let Some(ref p) = provider_normalized {\n        if p != \"litellm\" \u0026\u0026 p != \"openrouter\" {\n            println!(\n                \"\\n  {}\",\n                format!(\"Invalid provider: {}\", provider.unwrap_or(\"\")).red()\n            );\n            println!(\n                \"{}\\n\",\n                \"  Valid providers: litellm, openrouter\".bright_black()\n            );\n            std::process::exit(1);\n        }\n    }\n\n    let spinner = if no_spinner {\n        None\n    } else {\n        let provider_label = provider.map(|p| format!(\" from {}\", p)).unwrap_or_default();\n        let pb = ProgressBar::new_spinner();\n        pb.set_style(ProgressStyle::default_spinner());\n        pb.set_message(format!(\"Fetching pricing data{}...\", provider_label));\n        pb.enable_steady_tick(std::time::Duration::from_millis(100));\n        Some(pb)\n    };\n\n    let rt = Runtime::new()?;\n    let result = match rt.block_on(async {\n        let svc = PricingService::get_or_init().await?;\n        Ok::\u003c_, String\u003e(svc.lookup_with_source(model_id, provider_normalized.as_deref()))\n    }) {\n        Ok(result) =\u003e result,\n        Err(err) =\u003e {\n            if let Some(pb) = spinner {\n                pb.finish_and_clear();\n            }\n            if json {\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct ErrorOutput {\n                    error: String,\n                    model_id: String,\n                }\n                println!(\n                    \"{}\",\n                    serde_json::to_string_pretty(\u0026ErrorOutput {\n                        error: err,\n                        model_id: model_id.to_string(),\n                    })?\n                );\n                std::process::exit(1);\n            }\n            return Err(anyhow::anyhow!(err));\n        }\n    };\n\n    if let Some(pb) = spinner {\n        pb.finish_and_clear();\n    }\n\n    if json {\n        match result {\n            Some(pricing) =\u003e {\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct PricingValues {\n                    input_cost_per_token: f64,\n                    output_cost_per_token: f64,\n                    #[serde(skip_serializing_if = \"Option::is_none\")]\n                    cache_read_input_token_cost: Option\u003cf64\u003e,\n                    #[serde(skip_serializing_if = \"Option::is_none\")]\n                    cache_creation_input_token_cost: Option\u003cf64\u003e,\n                }\n\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct PricingOutput {\n                    model_id: String,\n                    matched_key: String,\n                    source: String,\n                    pricing: PricingValues,\n                }\n\n                let output = PricingOutput {\n                    model_id: model_id.to_string(),\n                    matched_key: pricing.matched_key,\n                    source: pricing.source,\n                    pricing: PricingValues {\n                        input_cost_per_token: pricing.pricing.input_cost_per_token.unwrap_or(0.0),\n                        output_cost_per_token: pricing.pricing.output_cost_per_token.unwrap_or(0.0),\n                        cache_read_input_token_cost: pricing.pricing.cache_read_input_token_cost,\n                        cache_creation_input_token_cost: pricing\n                            .pricing\n                            .cache_creation_input_token_cost,\n                    },\n                };\n\n                println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n            }\n            None =\u003e {\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct ErrorOutput {\n                    error: String,\n                    model_id: String,\n                }\n\n                let output = ErrorOutput {\n                    error: \"Model not found\".to_string(),\n                    model_id: model_id.to_string(),\n                };\n\n                println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n                std::process::exit(1);\n            }\n        }\n    } else {\n        match result {\n            Some(pricing) =\u003e {\n                println!(\"\\n  Pricing for: {}\", model_id.bold());\n                println!(\"  Matched key: {}\", pricing.matched_key);\n                let source_label = if pricing.source.eq_ignore_ascii_case(\"litellm\") {\n                    \"LiteLLM\"\n                } else {\n                    \"OpenRouter\"\n                };\n                println!(\"  Source: {}\", source_label);\n                println!();\n                let input = pricing.pricing.input_cost_per_token.unwrap_or(0.0);\n                let output = pricing.pricing.output_cost_per_token.unwrap_or(0.0);\n                println!(\"  Input:  ${:.2} / 1M tokens\", input * 1_000_000.0);\n                println!(\"  Output: ${:.2} / 1M tokens\", output * 1_000_000.0);\n                if let Some(cache_read) = pricing.pricing.cache_read_input_token_cost {\n                    println!(\n                        \"  Cache Read:  ${:.2} / 1M tokens\",\n                        cache_read * 1_000_000.0\n                    );\n                }\n                if let Some(cache_write) = pricing.pricing.cache_creation_input_token_cost {\n                    println!(\n                        \"  Cache Write: ${:.2} / 1M tokens\",\n                        cache_write * 1_000_000.0\n                    );\n                }\n                println!();\n            }\n            None =\u003e {\n                println!(\"\\n  {}\\n\", format!(\"Model not found: {}\", model_id).red());\n                std::process::exit(1);\n            }\n        }\n    }\n\n    Ok(())\n}\n\nfn format_currency(n: f64) -\u003e String {\n    format!(\"${:.2}\", n)\n}\n\nfn dim_borders(table_str: \u0026str) -\u003e String {\n    let border_chars: \u0026[char] = \u0026['â”Œ', 'â”€', 'â”¬', 'â”', 'â”‚', 'â”œ', 'â”¼', 'â”¤', 'â””', 'â”´', 'â”˜'];\n    let mut result = String::with_capacity(table_str.len() * 2);\n\n    for ch in table_str.chars() {\n        if border_chars.contains(\u0026ch) {\n            result.push_str(\"\\x1b[90m\");\n            result.push(ch);\n            result.push_str(\"\\x1b[0m\");\n        } else {\n            result.push(ch);\n        }\n    }\n\n    result\n}\n\nfn format_model_name(model: \u0026str) -\u003e String {\n    let name = model.strip_prefix(\"claude-\").unwrap_or(model);\n    if name.len() \u003e 9 {\n        let potential_date = \u0026name[name.len() - 8..];\n        if potential_date.chars().all(|c| c.is_ascii_digit()) \u0026\u0026 name.as_bytes()[name.len() - 9] == b'-' {\n            return name[..name.len() - 9].to_string();\n        }\n    }\n    name.to_string()\n}\n\nfn capitalize_source(source: \u0026str) -\u003e String {\n    match source {\n        \"opencode\" =\u003e \"OpenCode\".to_string(),\n        \"claude\" =\u003e \"Claude\".to_string(),\n        \"codex\" =\u003e \"Codex\".to_string(),\n        \"cursor\" =\u003e \"Cursor\".to_string(),\n        \"gemini\" =\u003e \"Gemini\".to_string(),\n        \"amp\" =\u003e \"Amp\".to_string(),\n        \"droid\" =\u003e \"Droid\".to_string(),\n        \"openclaw\" =\u003e \"openclaw\".to_string(),\n        \"pi\" =\u003e \"Pi\".to_string(),\n        other =\u003e other.to_string(),\n    }\n}\n\nfn run_sources_command(json: bool) -\u003e Result\u003c()\u003e {\n    use tokscale_core::{parse_local_sources, LocalParseOptions};\n\n    let home_dir =\n        dirs::home_dir().ok_or_else(|| anyhow::anyhow!(\"Could not determine home directory\"))?;\n\n    let parsed = parse_local_sources(LocalParseOptions {\n        home_dir: Some(home_dir.to_string_lossy().to_string()),\n        sources: Some(vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]),\n        since: None,\n        until: None,\n        year: None,\n    })\n    .map_err(|e| anyhow::anyhow!(e))?;\n\n    let headless_roots = get_headless_roots(\u0026home_dir);\n    let headless_codex_count = parsed\n        .messages\n        .iter()\n        .filter(|m| m.agent.as_deref() == Some(\"headless\") \u0026\u0026 m.source == \"codex\")\n        .count() as i32;\n\n    #[derive(serde::Serialize)]\n    #[serde(rename_all = \"camelCase\")]\n    struct SourceRow {\n        source: String,\n        label: String,\n        sessions_path: String,\n        sessions_path_exists: bool,\n        #[serde(skip_serializing_if = \"Vec::is_empty\")]\n        legacy_paths: Vec\u003cLegacyPath\u003e,\n        message_count: i32,\n        headless_supported: bool,\n        #[serde(skip_serializing_if = \"Vec::is_empty\")]\n        headless_paths: Vec\u003cHeadlessPath\u003e,\n        headless_message_count: i32,\n    }\n\n    #[derive(serde::Serialize)]\n    #[serde(rename_all = \"camelCase\")]\n    struct LegacyPath {\n        path: String,\n        exists: bool,\n    }\n\n    #[derive(serde::Serialize)]\n    #[serde(rename_all = \"camelCase\")]\n    struct HeadlessPath {\n        path: String,\n        exists: bool,\n    }\n\n    let sources = vec![\n        SourceRow {\n            source: \"opencode\".to_string(),\n            label: \"OpenCode\".to_string(),\n            sessions_path: home_dir\n                .join(\".local/share/opencode/storage/message\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir\n                .join(\".local/share/opencode/storage/message\")\n                .exists(),\n            legacy_paths: vec![],\n            message_count: parsed.opencode_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"claude\".to_string(),\n            label: \"Claude Code\".to_string(),\n            sessions_path: home_dir\n                .join(\".claude/projects\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".claude/projects\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.claude_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"codex\".to_string(),\n            label: \"Codex CLI\".to_string(),\n            sessions_path: get_codex_home(\u0026home_dir)\n                .join(\"sessions\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: get_codex_home(\u0026home_dir).join(\"sessions\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.codex_count,\n            headless_supported: true,\n            headless_paths: headless_roots\n                .iter()\n                .map(|root| {\n                    let path = root.join(\"codex\");\n                    HeadlessPath {\n                        path: path.to_string_lossy().to_string(),\n                        exists: path.exists(),\n                    }\n                })\n                .collect(),\n            headless_message_count: headless_codex_count,\n        },\n        SourceRow {\n            source: \"gemini\".to_string(),\n            label: \"Gemini CLI\".to_string(),\n            sessions_path: home_dir.join(\".gemini/tmp\").to_string_lossy().to_string(),\n            sessions_path_exists: home_dir.join(\".gemini/tmp\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.gemini_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"cursor\".to_string(),\n            label: \"Cursor IDE\".to_string(),\n            sessions_path: home_dir\n                .join(\".config/tokscale/cursor-cache\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".config/tokscale/cursor-cache\").exists(),\n            legacy_paths: vec![],\n            message_count: 0,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"amp\".to_string(),\n            label: \"Amp\".to_string(),\n            sessions_path: home_dir\n                .join(\".local/share/amp/threads\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".local/share/amp/threads\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.amp_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"droid\".to_string(),\n            label: \"Droid\".to_string(),\n            sessions_path: home_dir\n                .join(\".factory/sessions\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".factory/sessions\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.droid_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"openclaw\".to_string(),\n            label: \"OpenClaw\".to_string(),\n            sessions_path: home_dir\n                .join(\".openclaw/agents\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".openclaw/agents\").exists(),\n            legacy_paths: vec![\n                LegacyPath {\n                    path: home_dir\n                        .join(\".clawdbot/agents\")\n                        .to_string_lossy()\n                        .to_string(),\n                    exists: home_dir.join(\".clawdbot/agents\").exists(),\n                },\n                LegacyPath {\n                    path: home_dir\n                        .join(\".moltbot/agents\")\n                        .to_string_lossy()\n                        .to_string(),\n                    exists: home_dir.join(\".moltbot/agents\").exists(),\n                },\n                LegacyPath {\n                    path: home_dir\n                        .join(\".moldbot/agents\")\n                        .to_string_lossy()\n                        .to_string(),\n                    exists: home_dir.join(\".moldbot/agents\").exists(),\n                },\n            ],\n            message_count: parsed.openclaw_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"pi\".to_string(),\n            label: \"Pi\".to_string(),\n            sessions_path: home_dir\n                .join(\".pi/agent/sessions\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".pi/agent/sessions\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.pi_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n    ];\n\n    if json {\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct Output {\n            headless_roots: Vec\u003cString\u003e,\n            sources: Vec\u003cSourceRow\u003e,\n            note: String,\n        }\n\n        let output = Output {\n            headless_roots: headless_roots\n                .iter()\n                .map(|p| p.to_string_lossy().to_string())\n                .collect(),\n            sources,\n            note: \"Headless capture is supported for Codex CLI only.\".to_string(),\n        };\n\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n    } else {\n        use colored::Colorize;\n\n        println!(\"\\n  {}\", \"Local sources \u0026 session counts\".cyan());\n        println!(\n            \"  {}\",\n            format!(\n                \"Headless roots: {}\",\n                headless_roots\n                    .iter()\n                    .map(|p| p.to_string_lossy())\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\", \")\n            )\n            .bright_black()\n        );\n        println!();\n\n        for row in sources {\n            println!(\"  {}\", row.label.white());\n            println!(\n                \"  {}\",\n                format!(\n                    \"sessions: {}\",\n                    describe_path(\u0026row.sessions_path, row.sessions_path_exists)\n                )\n                .bright_black()\n            );\n\n            if !row.legacy_paths.is_empty() {\n                let legacy_desc: Vec\u003cString\u003e = row\n                    .legacy_paths\n                    .iter()\n                    .map(|lp| describe_path(\u0026lp.path, lp.exists))\n                    .collect();\n                println!(\n                    \"  {}\",\n                    format!(\"legacy: {}\", legacy_desc.join(\", \")).bright_black()\n                );\n            }\n\n            if row.headless_supported {\n                let headless_desc: Vec\u003cString\u003e = row\n                    .headless_paths\n                    .iter()\n                    .map(|hp| describe_path(\u0026hp.path, hp.exists))\n                    .collect();\n                println!(\n                    \"  {}\",\n                    format!(\"headless: {}\", headless_desc.join(\", \")).bright_black()\n                );\n                println!(\n                    \"  {}\",\n                    format!(\n                        \"messages: {} (headless: {})\",\n                        format_number(row.message_count),\n                        format_number(row.headless_message_count)\n                    )\n                    .bright_black()\n                );\n            } else {\n                println!(\n                    \"  {}\",\n                    format!(\"messages: {}\", format_number(row.message_count)).bright_black()\n                );\n            }\n\n            println!();\n        }\n\n        println!(\n            \"  {}\",\n            \"Note: Headless capture is supported for Codex CLI only.\".bright_black()\n        );\n        println!();\n    }\n\n    Ok(())\n}\n\nfn get_headless_roots(home_dir: \u0026Path) -\u003e Vec\u003cPathBuf\u003e {\n    let mut roots = Vec::new();\n\n    if let Ok(env_dir) = std::env::var(\"TOKSCALE_HEADLESS_DIR\") {\n        roots.push(PathBuf::from(env_dir));\n    } else {\n        roots.push(home_dir.join(\".config/tokscale/headless\"));\n\n        #[cfg(target_os = \"macos\")]\n        {\n            roots.push(home_dir.join(\"Library/Application Support/tokscale/headless\"));\n        }\n    }\n\n    roots\n}\n\nfn get_codex_home(home_dir: \u0026Path) -\u003e PathBuf {\n    if let Ok(codex_home) = std::env::var(\"CODEX_HOME\") {\n        PathBuf::from(codex_home)\n    } else {\n        home_dir.join(\".codex\")\n    }\n}\n\nfn describe_path(path: \u0026str, exists: bool) -\u003e String {\n    let path_display = if let Some(home) = dirs::home_dir() {\n        path.replace(\u0026home.to_string_lossy().to_string(), \"~\")\n    } else {\n        path.to_string()\n    };\n    if exists {\n        format!(\"{} âœ“\", path_display)\n    } else {\n        format!(\"{} âœ—\", path_display)\n    }\n}\n\nfn format_number(n: i32) -\u003e String {\n    if n \u003e= 1_000_000 {\n        format!(\"{:.1}M\", n as f64 / 1_000_000.0)\n    } else if n \u003e= 1_000 {\n        format!(\"{:.1}K\", n as f64 / 1_000.0)\n    } else {\n        n.to_string()\n    }\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsTokenBreakdown {\n    input: i64,\n    output: i64,\n    cache_read: i64,\n    cache_write: i64,\n    reasoning: i64,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsSourceContribution {\n    source: String,\n    model_id: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    provider_id: Option\u003cString\u003e,\n    tokens: TsTokenBreakdown,\n    cost: f64,\n    messages: i32,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsDailyTotals {\n    tokens: i64,\n    cost: f64,\n    messages: i32,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsDailyContribution {\n    date: String,\n    totals: TsDailyTotals,\n    intensity: u8,\n    token_breakdown: TsTokenBreakdown,\n    sources: Vec\u003cTsSourceContribution\u003e,\n}\n\n#[derive(serde::Serialize)]\nstruct DateRange {\n    start: String,\n    end: String,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsYearSummary {\n    year: String,\n    total_tokens: i64,\n    total_cost: f64,\n    range: DateRange,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsDataSummary {\n    total_tokens: i64,\n    total_cost: f64,\n    total_days: i32,\n    active_days: i32,\n    average_per_day: f64,\n    max_cost_in_single_day: f64,\n    sources: Vec\u003cString\u003e,\n    models: Vec\u003cString\u003e,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsExportMeta {\n    generated_at: String,\n    version: String,\n    date_range: DateRange,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsTokenContributionData {\n    meta: TsExportMeta,\n    summary: TsDataSummary,\n    years: Vec\u003cTsYearSummary\u003e,\n    contributions: Vec\u003cTsDailyContribution\u003e,\n}\n\nfn to_ts_token_contribution_data(graph: \u0026tokscale_core::GraphResult) -\u003e TsTokenContributionData {\n    TsTokenContributionData {\n        meta: TsExportMeta {\n            generated_at: graph.meta.generated_at.clone(),\n            version: graph.meta.version.clone(),\n            date_range: DateRange {\n                start: graph.meta.date_range_start.clone(),\n                end: graph.meta.date_range_end.clone(),\n            },\n        },\n        summary: TsDataSummary {\n            total_tokens: graph.summary.total_tokens,\n            total_cost: graph.summary.total_cost,\n            total_days: graph.summary.total_days,\n            active_days: graph.summary.active_days,\n            average_per_day: graph.summary.average_per_day,\n            max_cost_in_single_day: graph.summary.max_cost_in_single_day,\n            sources: graph.summary.sources.clone(),\n            models: graph.summary.models.clone(),\n        },\n        years: graph\n            .years\n            .iter()\n            .map(|y| TsYearSummary {\n                year: y.year.clone(),\n                total_tokens: y.total_tokens,\n                total_cost: y.total_cost,\n                range: DateRange {\n                    start: y.range_start.clone(),\n                    end: y.range_end.clone(),\n                },\n            })\n            .collect(),\n        contributions: graph\n            .contributions\n            .iter()\n            .map(|d| TsDailyContribution {\n                date: d.date.clone(),\n                totals: TsDailyTotals {\n                    tokens: d.totals.tokens,\n                    cost: d.totals.cost,\n                    messages: d.totals.messages,\n                },\n                intensity: d.intensity,\n                token_breakdown: TsTokenBreakdown {\n                    input: d.token_breakdown.input,\n                    output: d.token_breakdown.output,\n                    cache_read: d.token_breakdown.cache_read,\n                    cache_write: d.token_breakdown.cache_write,\n                    reasoning: d.token_breakdown.reasoning,\n                },\n                sources: d\n                    .sources\n                    .iter()\n                    .map(|s| TsSourceContribution {\n                        source: s.source.clone(),\n                        model_id: s.model_id.clone(),\n                        provider_id: if s.provider_id.is_empty() {\n                            None\n                        } else {\n                            Some(s.provider_id.clone())\n                        },\n                        tokens: TsTokenBreakdown {\n                            input: s.tokens.input,\n                            output: s.tokens.output,\n                            cache_read: s.tokens.cache_read,\n                            cache_write: s.tokens.cache_write,\n                            reasoning: s.tokens.reasoning,\n                        },\n                        cost: s.cost,\n                        messages: s.messages,\n                    })\n                    .collect(),\n            })\n            .collect(),\n    }\n}\n\nfn run_login_command() -\u003e Result\u003c()\u003e {\n    use tokio::runtime::Runtime;\n\n    let rt = Runtime::new()?;\n    rt.block_on(async { auth::login().await })\n}\n\nfn run_logout_command() -\u003e Result\u003c()\u003e {\n    auth::logout()\n}\n\nfn run_whoami_command() -\u003e Result\u003c()\u003e {\n    auth::whoami()\n}\n\nfn prompt_star_repo() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use std::io::{self, Write};\n    use std::process::Command;\n\n    let gh_available = Command::new(\"gh\")\n        .arg(\"--version\")\n        .output()\n        .map(|out| out.status.success())\n        .unwrap_or(false);\n\n    if !gh_available {\n        return Ok(());\n    }\n\n    println!(\n        \"{}\",\n        \"  Please consider starring tokscale on GitHub!\".bright_black()\n    );\n    print!(\"  Star now with gh CLI? [y/N]: \");\n    io::stdout().flush()?;\n\n    let mut input = String::new();\n    io::stdin().read_line(\u0026mut input)?;\n    let answer = input.trim().to_lowercase();\n    if answer != \"y\" \u0026\u0026 answer != \"yes\" {\n        println!();\n        return Ok(());\n    }\n\n    let status = Command::new(\"gh\")\n        .args([\"repo\", \"star\", \"junhoyeo/tokscale\"])\n        .status();\n    match status {\n        Ok(s) if s.success() =\u003e {\n            println!(\"{}\", \"  âœ“ Starred! Thank you for your support.\".green());\n            println!();\n        }\n        _ =\u003e {\n            println!(\n                \"{}\",\n                \"  Failed to star via gh CLI. Continuing to submit...\".yellow()\n            );\n            println!();\n        }\n    }\n\n    Ok(())\n}\n\nfn run_graph_command(\n    output: Option\u003cString\u003e,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    benchmark: bool,\n    no_spinner: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use std::time::Instant;\n    use tokscale_core::{generate_graph, GroupBy, ReportOptions};\n\n    let show_progress = output.is_some() \u0026\u0026 !no_spinner;\n    let include_cursor = sources\n        .as_ref()\n        .map_or(true, |s| s.iter().any(|src| src == \"cursor\"));\n    let has_cursor_cache = cursor::has_cursor_usage_cache();\n    let mut cursor_sync_result: Option\u003ccursor::SyncCursorResult\u003e = None;\n\n    if include_cursor \u0026\u0026 cursor::is_cursor_logged_in() {\n        let rt_sync = tokio::runtime::Runtime::new()?;\n        cursor_sync_result = Some(rt_sync.block_on(async { cursor::sync_cursor_cache().await }));\n    }\n\n    if show_progress {\n        eprintln!(\"  Scanning session data...\");\n    }\n    let start = Instant::now();\n\n    if show_progress {\n        eprintln!(\"  Generating graph data...\");\n    }\n    let rt = tokio::runtime::Runtime::new()?;\n    let graph_result = rt\n        .block_on(async {\n            generate_graph(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: GroupBy::default(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    let processing_time_ms = start.elapsed().as_millis() as u32;\n    let output_data = to_ts_token_contribution_data(\u0026graph_result);\n    let json_output = serde_json::to_string_pretty(\u0026output_data)?;\n\n    if let Some(output_path) = output {\n        std::fs::write(\u0026output_path, json_output)?;\n\n        eprintln!(\n            \"{}\",\n            format!(\"âœ“ Graph data written to {}\", output_path).green()\n        );\n        eprintln!(\n            \"{}\",\n            format!(\n                \"  {} days, {} sources, {} models\",\n                output_data.contributions.len(),\n                output_data.summary.sources.len(),\n                output_data.summary.models.len()\n            )\n            .bright_black()\n        );\n        eprintln!(\n            \"{}\",\n            format!(\n                \"  Total: {}\",\n                format_currency(output_data.summary.total_cost)\n            )\n            .bright_black()\n        );\n\n        if benchmark {\n            eprintln!(\n                \"{}\",\n                format!(\"  Processing time: {}ms (Rust native)\", processing_time_ms).bright_black()\n            );\n            if let Some(sync) = cursor_sync_result {\n                if sync.synced {\n                    eprintln!(\n                        \"{}\",\n                        format!(\n                            \"  Cursor: {} usage events synced (full lifetime data)\",\n                            sync.rows\n                        )\n                        .bright_black()\n                    );\n                } else if let Some(err) = sync.error {\n                    if has_cursor_cache {\n                        eprintln!(\"{}\", format!(\"  Cursor: sync failed - {}\", err).yellow());\n                    }\n                }\n            }\n        }\n    } else {\n        println!(\"{}\", json_output);\n    }\n\n    Ok(())\n}\n\n#[derive(serde::Deserialize)]\nstruct SubmitResponse {\n    #[serde(rename = \"submissionId\")]\n    submission_id: Option\u003cString\u003e,\n    #[allow(dead_code)]\n    username: Option\u003cString\u003e,\n    metrics: Option\u003cSubmitMetrics\u003e,\n    warnings: Option\u003cVec\u003cString\u003e\u003e,\n    error: Option\u003cString\u003e,\n    details: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(serde::Deserialize)]\nstruct SubmitMetrics {\n    #[serde(rename = \"totalTokens\")]\n    total_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"totalCost\")]\n    total_cost: Option\u003cf64\u003e,\n    #[serde(rename = \"activeDays\")]\n    active_days: Option\u003ci32\u003e,\n    #[allow(dead_code)]\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n}\n\nfn run_submit_command(\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    dry_run: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use std::io::IsTerminal;\n    use tokio::runtime::Runtime;\n    use tokscale_core::{generate_graph, GroupBy, ReportOptions};\n\n    let credentials = match auth::load_credentials() {\n        Some(creds) =\u003e creds,\n        None =\u003e {\n            eprintln!(\"\\n  {}\", \"Not logged in.\".yellow());\n            eprintln!(\"{}\", \"  Run 'tokscale login' first.\\n\".bright_black());\n            std::process::exit(1);\n        }\n    };\n\n    if std::io::stdin().is_terminal() \u0026\u0026 std::io::stdout().is_terminal() {\n        let _ = prompt_star_repo();\n    }\n\n    println!(\"\\n  {}\\n\", \"Tokscale - Submit Usage Data\".cyan());\n\n    let include_cursor = sources\n        .as_ref()\n        .map_or(true, |s| s.iter().any(|src| src == \"cursor\"));\n    let has_cursor_cache = cursor::has_cursor_usage_cache();\n    if include_cursor \u0026\u0026 cursor::is_cursor_logged_in() {\n        println!(\"{}\", \"  Syncing Cursor usage data...\".bright_black());\n        let rt_sync = Runtime::new()?;\n        let sync_result = rt_sync.block_on(async { cursor::sync_cursor_cache().await });\n        if sync_result.synced {\n            println!(\n                \"{}\",\n                format!(\"  Cursor: {} usage events synced\", sync_result.rows).bright_black()\n            );\n        } else if let Some(err) = sync_result.error {\n            if has_cursor_cache {\n                println!(\n                    \"{}\",\n                    format!(\"  Cursor sync failed; using cached data: {}\", err).yellow()\n                );\n            }\n        }\n    }\n\n    println!(\"{}\", \"  Scanning local session data...\".bright_black());\n\n    let rt = Runtime::new()?;\n    let graph_result = rt\n        .block_on(async {\n            generate_graph(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: GroupBy::default(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    println!(\"{}\", \"  Data to submit:\".white());\n    println!(\n        \"{}\",\n        format!(\n            \"    Date range: {} to {}\",\n            graph_result.meta.date_range_start, graph_result.meta.date_range_end,\n        )\n        .bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\"    Active days: {}\", graph_result.summary.active_days).bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\n            \"    Total tokens: {}\",\n            format_tokens_with_commas(graph_result.summary.total_tokens)\n        )\n        .bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\n            \"    Total cost: {}\",\n            format_currency(graph_result.summary.total_cost)\n        )\n        .bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\"    Sources: {}\", graph_result.summary.sources.join(\", \")).bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\"    Models: {} models\", graph_result.summary.models.len()).bright_black()\n    );\n    println!();\n\n    if graph_result.summary.total_tokens == 0 {\n        println!(\"{}\", \"  No usage data found to submit.\\n\".yellow());\n        return Ok(());\n    }\n\n    if dry_run {\n        println!(\"{}\", \"  Dry run - not submitting data.\\n\".yellow());\n        return Ok(());\n    }\n\n    println!(\"{}\", \"  Submitting to server...\".bright_black());\n\n    let api_url = auth::get_api_base_url();\n\n    let submit_payload = to_ts_token_contribution_data(\u0026graph_result);\n\n    let response = rt.block_on(async {\n        reqwest::Client::new()\n            .post(format!(\"{}/api/submit\", api_url))\n            .header(\"Content-Type\", \"application/json\")\n            .header(\"Authorization\", format!(\"Bearer {}\", credentials.token))\n            .json(\u0026submit_payload)\n            .send()\n            .await\n    });\n\n    match response {\n        Ok(resp) =\u003e {\n            let status = resp.status();\n            let body: SubmitResponse =\n                rt.block_on(async { resp.json().await })\n                    .unwrap_or_else(|_| SubmitResponse {\n                        submission_id: None,\n                        username: None,\n                        metrics: None,\n                        warnings: None,\n                        error: Some(format!(\n                            \"Server returned {} with unparseable response\",\n                            status\n                        )),\n                        details: None,\n                    });\n\n            if !status.is_success() {\n                eprintln!(\n                    \"\\n  {}\",\n                    format!(\n                        \"Error: {}\",\n                        body.error\n                            .unwrap_or_else(|| \"Submission failed\".to_string())\n                    )\n                    .red()\n                );\n                if let Some(details) = body.details {\n                    for detail in details {\n                        eprintln!(\"{}\", format!(\"    - {}\", detail).bright_black());\n                    }\n                }\n                println!();\n                std::process::exit(1);\n            }\n\n            println!(\"\\n  {}\", \"Successfully submitted!\".green());\n            println!();\n            println!(\"{}\", \"  Summary:\".white());\n            if let Some(id) = body.submission_id {\n                println!(\"{}\", format!(\"    Submission ID: {}\", id).bright_black());\n            }\n            if let Some(metrics) = \u0026body.metrics {\n                if let Some(tokens) = metrics.total_tokens {\n                    println!(\n                        \"{}\",\n                        format!(\"    Total tokens: {}\", format_tokens_with_commas(tokens))\n                            .bright_black()\n                    );\n                }\n                if let Some(cost) = metrics.total_cost {\n                    println!(\n                        \"{}\",\n                        format!(\"    Total cost: {}\", format_currency(cost)).bright_black()\n                    );\n                }\n                if let Some(days) = metrics.active_days {\n                    println!(\"{}\", format!(\"    Active days: {}\", days).bright_black());\n                }\n            }\n            println!();\n            println!(\n                \"{}\",\n                format!(\n                    \"  View your profile: {}/u/{}\",\n                    api_url, credentials.username\n                )\n                .cyan()\n            );\n            println!();\n\n            if let Some(warnings) = body.warnings {\n                if !warnings.is_empty() {\n                    println!(\"{}\", \"  Warnings:\".yellow());\n                    for warning in warnings {\n                        println!(\"{}\", format!(\"    - {}\", warning).bright_black());\n                    }\n                    println!();\n                }\n            }\n        }\n        Err(err) =\u003e {\n            eprintln!(\"\\n  {}\", \"Error: Failed to connect to server.\".red());\n            eprintln!(\"{}\\n\", format!(\"  {}\", err).bright_black());\n            std::process::exit(1);\n        }\n    }\n\n    Ok(())\n}\n\nfn run_cursor_command(subcommand: CursorSubcommand) -\u003e Result\u003c()\u003e {\n    match subcommand {\n        CursorSubcommand::Login { name } =\u003e cursor::run_cursor_login(name),\n        CursorSubcommand::Logout {\n            name,\n            all,\n            purge_cache,\n        } =\u003e cursor::run_cursor_logout(name, all, purge_cache),\n        CursorSubcommand::Status { name } =\u003e cursor::run_cursor_status(name),\n        CursorSubcommand::Accounts { json } =\u003e cursor::run_cursor_accounts(json),\n        CursorSubcommand::Switch { name } =\u003e cursor::run_cursor_switch(\u0026name),\n    }\n}\n\nfn format_tokens_with_commas(n: i64) -\u003e String {\n    let s = n.to_string();\n    let bytes = s.as_bytes();\n    let len = bytes.len();\n    let mut result = String::with_capacity(len + len / 3);\n    for (i, \u0026b) in bytes.iter().enumerate() {\n        if i \u003e 0 \u0026\u0026 (len - i).is_multiple_of(3) {\n            result.push(',');\n        }\n        result.push(b as char);\n    }\n    result\n}\n\nfn run_headless_command(\n    source: \u0026str,\n    args: Vec\u003cString\u003e,\n    format: Option\u003cString\u003e,\n    output: Option\u003cString\u003e,\n    no_auto_flags: bool,\n) -\u003e Result\u003c()\u003e {\n    use chrono::Utc;\n    use std::io::{Read, Write};\n    use std::process::Command;\n    use std::sync::atomic::{AtomicBool, Ordering};\n    use std::sync::Arc;\n    use uuid::Uuid;\n\n    let source_lower = source.to_lowercase();\n    if source_lower != \"codex\" {\n        eprintln!(\"\\n  Error: Unknown headless source '{}'.\", source);\n        eprintln!(\"  Currently only 'codex' is supported.\\n\");\n        std::process::exit(1);\n    }\n\n    let resolved_format = match format {\n        Some(f) if f == \"json\" || f == \"jsonl\" =\u003e f,\n        Some(f) =\u003e {\n            eprintln!(\"\\n  Error: Invalid format '{}'. Use json or jsonl.\\n\", f);\n            std::process::exit(1);\n        }\n        None =\u003e \"jsonl\".to_string(),\n    };\n\n    let mut final_args = args.clone();\n    if !no_auto_flags \u0026\u0026 source_lower == \"codex\" \u0026\u0026 !final_args.contains(\u0026\"--json\".to_string()) {\n        final_args.push(\"--json\".to_string());\n    }\n\n    let home_dir =\n        dirs::home_dir().ok_or_else(|| anyhow::anyhow!(\"Could not determine home directory\"))?;\n    let headless_roots = get_headless_roots(\u0026home_dir);\n\n    let output_path = if let Some(custom_output) = output {\n        let parent = Path::new(\u0026custom_output)\n            .parent()\n            .unwrap_or_else(|| Path::new(\".\"));\n        std::fs::create_dir_all(parent)?;\n        custom_output\n    } else {\n        let root = headless_roots\n            .first()\n            .cloned()\n            .unwrap_or_else(|| home_dir.join(\".config/tokscale/headless\"));\n        let dir = root.join(\u0026source_lower);\n        std::fs::create_dir_all(\u0026dir)?;\n\n        let now = Utc::now();\n        let timestamp = now.format(\"%Y-%m-%dT%H-%M-%S-%3fZ\").to_string();\n        let uuid_short = Uuid::new_v4()\n            .to_string()\n            .replace(\"-\", \"\")\n            .chars()\n            .take(8)\n            .collect::\u003cString\u003e();\n        let filename = format!(\n            \"{}-{}-{}.{}\",\n            source_lower, timestamp, uuid_short, resolved_format\n        );\n\n        dir.join(filename).to_string_lossy().to_string()\n    };\n\n    let settings = tui::settings::Settings::load();\n    let timeout = settings.get_native_timeout();\n\n    use colored::Colorize;\n    println!(\"\\n  {}\", \"Headless capture\".cyan());\n    println!(\"  {}\", format!(\"source: {}\", source_lower).bright_black());\n    println!(\"  {}\", format!(\"output: {}\", output_path).bright_black());\n    println!(\n        \"  {}\",\n        format!(\"timeout: {}s\", timeout.as_secs()).bright_black()\n    );\n    println!();\n\n    let mut child = Command::new(\u0026source_lower)\n        .args(\u0026final_args)\n        .stdout(std::process::Stdio::piped())\n        .stderr(std::process::Stdio::inherit())\n        .stdin(std::process::Stdio::inherit())\n        .spawn()\n        .map_err(|e| anyhow::anyhow!(\"Failed to spawn '{}': {}\", source_lower, e))?;\n\n    let stdout = child\n        .stdout\n        .take()\n        .ok_or_else(|| anyhow::anyhow!(\"Failed to capture stdout from command\"))?;\n\n    let mut output_file = std::fs::File::create(\u0026output_path)\n        .map_err(|e| anyhow::anyhow!(\"Failed to create output file '{}': {}\", output_path, e))?;\n\n    let timed_out = Arc::new(AtomicBool::new(false));\n    let timed_out_clone = Arc::clone(\u0026timed_out);\n    let child_id = child.id();\n\n    let timeout_handle = std::thread::spawn(move || {\n        std::thread::sleep(timeout);\n        if !timed_out_clone.load(Ordering::SeqCst) {\n            timed_out_clone.store(true, Ordering::SeqCst);\n            #[cfg(unix)]\n            {\n                let _ = std::process::Command::new(\"kill\")\n                    .arg(\"-9\")\n                    .arg(child_id.to_string())\n                    .output();\n            }\n            #[cfg(windows)]\n            {\n                let _ = std::process::Command::new(\"taskkill\")\n                    .args([\"/F\", \"/PID\", \u0026child_id.to_string()])\n                    .output();\n            }\n        }\n    });\n\n    let mut reader = std::io::BufReader::new(stdout);\n    let mut buffer = [0; 8192];\n    loop {\n        match reader.read(\u0026mut buffer) {\n            Ok(0) =\u003e break,\n            Ok(n) =\u003e {\n                output_file\n                    .write_all(\u0026buffer[..n])\n                    .map_err(|e| anyhow::anyhow!(\"Failed to write to output file: {}\", e))?;\n            }\n            Err(e) =\u003e {\n                if timed_out.load(Ordering::SeqCst) {\n                    break;\n                }\n                return Err(anyhow::anyhow!(\n                    \"Failed to read from subprocess stdout: {}\",\n                    e\n                ));\n            }\n        }\n    }\n\n    let status = child\n        .wait()\n        .map_err(|e| anyhow::anyhow!(\"Failed to wait for subprocess: {}\", e))?;\n\n    timed_out.store(true, Ordering::SeqCst);\n    let _ = timeout_handle.join();\n\n    if timed_out.load(Ordering::SeqCst) \u0026\u0026 !status.success() {\n        eprintln!(\n            \"{}\",\n            format!(\"\\n  Subprocess timed out after {}s\", timeout.as_secs()).red()\n        );\n        eprintln!(\"{}\", \"  Partial output saved. Increase timeout with TOKSCALE_NATIVE_TIMEOUT_MS or settings.json\".bright_black());\n        println!();\n        std::process::exit(124);\n    }\n\n    let exit_code = status.code().unwrap_or(1);\n\n    println!(\n        \"{}\",\n        format!(\"âœ“ Saved headless output to {}\", output_path).green()\n    );\n    println!();\n\n    if exit_code != 0 {\n        std::process::exit(exit_code);\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_build_source_filter_all_false() {\n        let flags = SourceFlags {\n            opencode: false,\n            claude: false,\n            codex: false,\n            gemini: false,\n            cursor: false,\n            amp: false,\n            droid: false,\n            openclaw: false,\n            pi: false,\n        };\n        assert_eq!(build_source_filter(flags), None);\n    }\n\n    #[test]\n    fn test_build_source_filter_single_source() {\n        let flags = SourceFlags {\n            opencode: true,\n            claude: false,\n            codex: false,\n            gemini: false,\n            cursor: false,\n            amp: false,\n            droid: false,\n            openclaw: false,\n            pi: false,\n        };\n        assert_eq!(\n            build_source_filter(flags),\n            Some(vec![\"opencode\".to_string()])\n        );\n    }\n\n    #[test]\n    fn test_build_source_filter_multiple_sources() {\n        let flags = SourceFlags {\n            opencode: true,\n            claude: true,\n            codex: false,\n            gemini: false,\n            cursor: false,\n            amp: false,\n            droid: false,\n            openclaw: false,\n            pi: true,\n        };\n        assert_eq!(\n            build_source_filter(flags),\n            Some(vec![\n                \"opencode\".to_string(),\n                \"claude\".to_string(),\n                \"pi\".to_string()\n            ])\n        );\n    }\n\n    #[test]\n    fn test_build_source_filter_all_sources() {\n        let flags = SourceFlags {\n            opencode: true,\n            claude: true,\n            codex: true,\n            gemini: true,\n            cursor: true,\n            amp: true,\n            droid: true,\n            openclaw: true,\n            pi: true,\n        };\n        let result = build_source_filter(flags);\n        assert!(result.is_some());\n        let sources = result.unwrap();\n        assert_eq!(sources.len(), 9);\n        assert!(sources.contains(\u0026\"opencode\".to_string()));\n        assert!(sources.contains(\u0026\"claude\".to_string()));\n        assert!(sources.contains(\u0026\"codex\".to_string()));\n        assert!(sources.contains(\u0026\"gemini\".to_string()));\n        assert!(sources.contains(\u0026\"cursor\".to_string()));\n        assert!(sources.contains(\u0026\"amp\".to_string()));\n        assert!(sources.contains(\u0026\"droid\".to_string()));\n        assert!(sources.contains(\u0026\"openclaw\".to_string()));\n        assert!(sources.contains(\u0026\"pi\".to_string()));\n    }\n\n    #[test]\n    fn test_build_date_filter_custom_range() {\n        let (since, until) = build_date_filter(\n            false,\n            false,\n            false,\n            Some(\"2024-01-01\".to_string()),\n            Some(\"2024-12-31\".to_string()),\n        );\n        assert_eq!(since, Some(\"2024-01-01\".to_string()));\n        assert_eq!(until, Some(\"2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_build_date_filter_no_filters() {\n        let (since, until) = build_date_filter(false, false, false, None, None);\n        assert_eq!(since, None);\n        assert_eq!(until, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_year() {\n        let year = normalize_year_filter(false, false, false, Some(\"2024\".to_string()));\n        assert_eq!(year, Some(\"2024\".to_string()));\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_today() {\n        let year = normalize_year_filter(true, false, false, Some(\"2024\".to_string()));\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_week() {\n        let year = normalize_year_filter(false, true, false, Some(\"2024\".to_string()));\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_month() {\n        let year = normalize_year_filter(false, false, true, Some(\"2024\".to_string()));\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_no_year() {\n        let year = normalize_year_filter(false, false, false, None);\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_small() {\n        assert_eq!(format_tokens_with_commas(123), \"123\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_thousands() {\n        assert_eq!(format_tokens_with_commas(1234), \"1,234\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_millions() {\n        assert_eq!(format_tokens_with_commas(1234567), \"1,234,567\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_billions() {\n        assert_eq!(format_tokens_with_commas(1234567890), \"1,234,567,890\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_zero() {\n        assert_eq!(format_tokens_with_commas(0), \"0\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_negative() {\n        assert_eq!(format_tokens_with_commas(-1234567), \"-1,234,567\");\n    }\n\n    #[test]\n    fn test_format_currency_zero() {\n        assert_eq!(format_currency(0.0), \"$0.00\");\n    }\n\n    #[test]\n    fn test_format_currency_small() {\n        assert_eq!(format_currency(12.34), \"$12.34\");\n    }\n\n    #[test]\n    fn test_format_currency_large() {\n        assert_eq!(format_currency(1234.56), \"$1234.56\");\n    }\n\n    #[test]\n    fn test_format_currency_rounds() {\n        assert_eq!(format_currency(12.345), \"$12.35\");\n        assert_eq!(format_currency(12.344), \"$12.34\");\n    }\n\n    #[test]\n    fn test_capitalize_source_opencode() {\n        assert_eq!(capitalize_source(\"opencode\"), \"OpenCode\");\n    }\n\n    #[test]\n    fn test_capitalize_source_claude() {\n        assert_eq!(capitalize_source(\"claude\"), \"Claude\");\n    }\n\n    #[test]\n    fn test_capitalize_source_codex() {\n        assert_eq!(capitalize_source(\"codex\"), \"Codex\");\n    }\n\n    #[test]\n    fn test_capitalize_source_cursor() {\n        assert_eq!(capitalize_source(\"cursor\"), \"Cursor\");\n    }\n\n    #[test]\n    fn test_capitalize_source_gemini() {\n        assert_eq!(capitalize_source(\"gemini\"), \"Gemini\");\n    }\n\n    #[test]\n    fn test_capitalize_source_amp() {\n        assert_eq!(capitalize_source(\"amp\"), \"Amp\");\n    }\n\n    #[test]\n    fn test_capitalize_source_droid() {\n        assert_eq!(capitalize_source(\"droid\"), \"Droid\");\n    }\n\n    #[test]\n    fn test_capitalize_source_openclaw() {\n        assert_eq!(capitalize_source(\"openclaw\"), \"openclaw\");\n    }\n\n    #[test]\n    fn test_capitalize_source_pi() {\n        assert_eq!(capitalize_source(\"pi\"), \"Pi\");\n    }\n\n    #[test]\n    fn test_capitalize_source_unknown() {\n        assert_eq!(capitalize_source(\"unknown\"), \"unknown\");\n    }\n\n    #[test]\n    fn test_get_date_range_label_today() {\n        let label = get_date_range_label(true, false, false, \u0026None, \u0026None, \u0026None);\n        assert_eq!(label, Some(\"Today\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_week() {\n        let label = get_date_range_label(false, true, false, \u0026None, \u0026None, \u0026None);\n        assert_eq!(label, Some(\"Last 7 days\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_year() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026None,\n            \u0026None,\n            \u0026Some(\"2024\".to_string()),\n        );\n        assert_eq!(label, Some(\"2024\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_custom_since() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026Some(\"2024-01-01\".to_string()),\n            \u0026None,\n            \u0026None,\n        );\n        assert_eq!(label, Some(\"from 2024-01-01\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_custom_until() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026None,\n            \u0026Some(\"2024-12-31\".to_string()),\n            \u0026None,\n        );\n        assert_eq!(label, Some(\"to 2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_custom_range() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026Some(\"2024-01-01\".to_string()),\n            \u0026Some(\"2024-12-31\".to_string()),\n            \u0026None,\n        );\n        assert_eq!(label, Some(\"from 2024-01-01 to 2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_none() {\n        let label = get_date_range_label(false, false, false, \u0026None, \u0026None, \u0026None);\n        assert_eq!(label, None);\n    }\n\n    #[test]\n    fn test_light_spinner_frame_0() {\n        let frame = LightSpinner::frame(0);\n        assert!(frame.contains(\"â– \"));\n        assert!(frame.contains(\"â¬\"));\n    }\n\n    #[test]\n    fn test_light_spinner_frame_1() {\n        let frame = LightSpinner::frame(1);\n        assert!(frame.contains(\"â– \"));\n        assert!(frame.contains(\"â¬\"));\n    }\n\n    #[test]\n    fn test_light_spinner_frame_2() {\n        let frame = LightSpinner::frame(2);\n        assert!(frame.contains(\"â– \"));\n        assert!(frame.contains(\"â¬\"));\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_forward_start() {\n        let (position, forward) = LightSpinner::scanner_state(0);\n        assert_eq!(position, 0);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_forward_mid() {\n        let (position, forward) = LightSpinner::scanner_state(4);\n        assert_eq!(position, 4);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_forward_end() {\n        let (position, forward) = LightSpinner::scanner_state(7);\n        assert_eq!(position, 7);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_hold_end() {\n        let (position, forward) = LightSpinner::scanner_state(8);\n        assert_eq!(position, 7);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_backward_start() {\n        let (position, forward) = LightSpinner::scanner_state(17);\n        assert_eq!(position, 6);\n        assert_eq!(forward, false);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_backward_end() {\n        let (position, forward) = LightSpinner::scanner_state(23);\n        assert_eq!(position, 0);\n        assert_eq!(forward, false);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_hold_start() {\n        let (position, forward) = LightSpinner::scanner_state(24);\n        assert_eq!(position, 0);\n        assert_eq!(forward, false);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_cycle_wrap() {\n        // Total cycle = 8 + 9 + 7 + 30 = 54\n        let (position1, forward1) = LightSpinner::scanner_state(0);\n        let (position2, forward2) = LightSpinner::scanner_state(54);\n        assert_eq!(position1, position2);\n        assert_eq!(forward1, forward2);\n    }\n}\n","traces":[{"line":414,"address":[],"length":0,"stats":{"Line":22}},{"line":417,"address":[],"length":0,"stats":{"Line":44}},{"line":418,"address":[],"length":0,"stats":{"Line":66}},{"line":420,"address":[],"length":0,"stats":{"Line":22}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":3}},{"line":426,"address":[],"length":0,"stats":{"Line":2}},{"line":427,"address":[],"length":0,"stats":{"Line":2}},{"line":428,"address":[],"length":0,"stats":{"Line":2}},{"line":429,"address":[],"length":0,"stats":{"Line":2}},{"line":430,"address":[],"length":0,"stats":{"Line":2}},{"line":431,"address":[],"length":0,"stats":{"Line":2}},{"line":432,"address":[],"length":0,"stats":{"Line":2}},{"line":433,"address":[],"length":0,"stats":{"Line":2}},{"line":434,"address":[],"length":0,"stats":{"Line":2}},{"line":435,"address":[],"length":0,"stats":{"Line":2}},{"line":436,"address":[],"length":0,"stats":{"Line":2}},{"line":437,"address":[],"length":0,"stats":{"Line":2}},{"line":438,"address":[],"length":0,"stats":{"Line":2}},{"line":439,"address":[],"length":0,"stats":{"Line":2}},{"line":440,"address":[],"length":0,"stats":{"Line":2}},{"line":441,"address":[],"length":0,"stats":{"Line":2}},{"line":442,"address":[],"length":0,"stats":{"Line":2}},{"line":443,"address":[],"length":0,"stats":{"Line":2}},{"line":444,"address":[],"length":0,"stats":{"Line":2}},{"line":445,"address":[],"length":0,"stats":{"Line":2}},{"line":449,"address":[],"length":0,"stats":{"Line":8}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":6}},{"line":454,"address":[],"length":0,"stats":{"Line":4}},{"line":455,"address":[],"length":0,"stats":{"Line":4}},{"line":456,"address":[],"length":0,"stats":{"Line":4}},{"line":457,"address":[],"length":0,"stats":{"Line":4}},{"line":458,"address":[],"length":0,"stats":{"Line":4}},{"line":459,"address":[],"length":0,"stats":{"Line":4}},{"line":460,"address":[],"length":0,"stats":{"Line":4}},{"line":461,"address":[],"length":0,"stats":{"Line":2}},{"line":462,"address":[],"length":0,"stats":{"Line":2}},{"line":464,"address":[],"length":0,"stats":{"Line":14}},{"line":465,"address":[],"length":0,"stats":{"Line":12}},{"line":466,"address":[],"length":0,"stats":{"Line":4}},{"line":468,"address":[],"length":0,"stats":{"Line":2}},{"line":469,"address":[],"length":0,"stats":{"Line":2}},{"line":470,"address":[],"length":0,"stats":{"Line":2}},{"line":471,"address":[],"length":0,"stats":{"Line":2}},{"line":472,"address":[],"length":0,"stats":{"Line":2}},{"line":473,"address":[],"length":0,"stats":{"Line":2}},{"line":474,"address":[],"length":0,"stats":{"Line":4}},{"line":475,"address":[],"length":0,"stats":{"Line":2}},{"line":476,"address":[],"length":0,"stats":{"Line":2}},{"line":477,"address":[],"length":0,"stats":{"Line":2}},{"line":478,"address":[],"length":0,"stats":{"Line":2}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":1}},{"line":674,"address":[],"length":0,"stats":{"Line":1}},{"line":675,"address":[],"length":0,"stats":{"Line":1}},{"line":676,"address":[],"length":0,"stats":{"Line":1}},{"line":677,"address":[],"length":0,"stats":{"Line":1}},{"line":678,"address":[],"length":0,"stats":{"Line":6}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":57}},{"line":721,"address":[],"length":0,"stats":{"Line":38}},{"line":722,"address":[],"length":0,"stats":{"Line":38}},{"line":723,"address":[],"length":0,"stats":{"Line":38}},{"line":724,"address":[],"length":0,"stats":{"Line":38}},{"line":725,"address":[],"length":0,"stats":{"Line":38}},{"line":726,"address":[],"length":0,"stats":{"Line":38}},{"line":727,"address":[],"length":0,"stats":{"Line":38}},{"line":728,"address":[],"length":0,"stats":{"Line":19}},{"line":729,"address":[],"length":0,"stats":{"Line":19}},{"line":731,"address":[],"length":0,"stats":{"Line":38}},{"line":732,"address":[],"length":0,"stats":{"Line":95}},{"line":733,"address":[],"length":0,"stats":{"Line":114}},{"line":734,"address":[],"length":0,"stats":{"Line":76}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":19}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":746,"address":[],"length":0,"stats":{"Line":0}},{"line":747,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":19}},{"line":756,"address":[],"length":0,"stats":{"Line":19}},{"line":757,"address":[],"length":0,"stats":{"Line":19}},{"line":758,"address":[],"length":0,"stats":{"Line":19}},{"line":759,"address":[],"length":0,"stats":{"Line":19}},{"line":760,"address":[],"length":0,"stats":{"Line":19}},{"line":761,"address":[],"length":0,"stats":{"Line":38}},{"line":762,"address":[],"length":0,"stats":{"Line":19}},{"line":763,"address":[],"length":0,"stats":{"Line":19}},{"line":764,"address":[],"length":0,"stats":{"Line":19}},{"line":765,"address":[],"length":0,"stats":{"Line":19}},{"line":769,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":6}},{"line":796,"address":[],"length":0,"stats":{"Line":12}},{"line":797,"address":[],"length":0,"stats":{"Line":9}},{"line":798,"address":[],"length":0,"stats":{"Line":9}},{"line":800,"address":[],"length":0,"stats":{"Line":8}},{"line":801,"address":[],"length":0,"stats":{"Line":6}},{"line":803,"address":[],"length":0,"stats":{"Line":7}},{"line":804,"address":[],"length":0,"stats":{"Line":3}},{"line":806,"address":[],"length":0,"stats":{"Line":7}},{"line":807,"address":[],"length":0,"stats":{"Line":3}},{"line":809,"address":[],"length":0,"stats":{"Line":7}},{"line":810,"address":[],"length":0,"stats":{"Line":3}},{"line":812,"address":[],"length":0,"stats":{"Line":7}},{"line":813,"address":[],"length":0,"stats":{"Line":3}},{"line":815,"address":[],"length":0,"stats":{"Line":7}},{"line":816,"address":[],"length":0,"stats":{"Line":3}},{"line":818,"address":[],"length":0,"stats":{"Line":7}},{"line":819,"address":[],"length":0,"stats":{"Line":3}},{"line":821,"address":[],"length":0,"stats":{"Line":8}},{"line":822,"address":[],"length":0,"stats":{"Line":6}},{"line":825,"address":[],"length":0,"stats":{"Line":12}},{"line":826,"address":[],"length":0,"stats":{"Line":3}},{"line":828,"address":[],"length":0,"stats":{"Line":3}},{"line":832,"address":[],"length":0,"stats":{"Line":4}},{"line":843,"address":[],"length":0,"stats":{"Line":4}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":848,"address":[],"length":0,"stats":{"Line":4}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":853,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":4}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":861,"address":[],"length":0,"stats":{"Line":0}},{"line":862,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":4}},{"line":869,"address":[],"length":0,"stats":{"Line":7}},{"line":875,"address":[],"length":0,"stats":{"Line":18}},{"line":876,"address":[],"length":0,"stats":{"Line":3}},{"line":878,"address":[],"length":0,"stats":{"Line":4}},{"line":882,"address":[],"length":0,"stats":{"Line":9}},{"line":890,"address":[],"length":0,"stats":{"Line":9}},{"line":891,"address":[],"length":0,"stats":{"Line":1}},{"line":893,"address":[],"length":0,"stats":{"Line":8}},{"line":894,"address":[],"length":0,"stats":{"Line":1}},{"line":896,"address":[],"length":0,"stats":{"Line":7}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":9}},{"line":901,"address":[],"length":0,"stats":{"Line":2}},{"line":903,"address":[],"length":0,"stats":{"Line":10}},{"line":904,"address":[],"length":0,"stats":{"Line":11}},{"line":905,"address":[],"length":0,"stats":{"Line":6}},{"line":907,"address":[],"length":0,"stats":{"Line":9}},{"line":908,"address":[],"length":0,"stats":{"Line":4}},{"line":910,"address":[],"length":0,"stats":{"Line":10}},{"line":911,"address":[],"length":0,"stats":{"Line":1}},{"line":913,"address":[],"length":0,"stats":{"Line":8}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":949,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":967,"address":[],"length":0,"stats":{"Line":0}},{"line":968,"address":[],"length":0,"stats":{"Line":0}},{"line":969,"address":[],"length":0,"stats":{"Line":0}},{"line":970,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":3}},{"line":975,"address":[],"length":0,"stats":{"Line":9}},{"line":976,"address":[],"length":0,"stats":{"Line":6}},{"line":978,"address":[],"length":0,"stats":{"Line":27}},{"line":979,"address":[],"length":0,"stats":{"Line":48}},{"line":980,"address":[],"length":0,"stats":{"Line":24}},{"line":981,"address":[],"length":0,"stats":{"Line":6}},{"line":983,"address":[],"length":0,"stats":{"Line":18}},{"line":985,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":988,"address":[],"length":0,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":30}},{"line":992,"address":[],"length":0,"stats":{"Line":36}},{"line":993,"address":[],"length":0,"stats":{"Line":12}},{"line":995,"address":[],"length":0,"stats":{"Line":36}},{"line":999,"address":[],"length":0,"stats":{"Line":3}},{"line":1002,"address":[],"length":0,"stats":{"Line":12}},{"line":1003,"address":[],"length":0,"stats":{"Line":24}},{"line":1004,"address":[],"length":0,"stats":{"Line":24}},{"line":1005,"address":[],"length":0,"stats":{"Line":24}},{"line":1006,"address":[],"length":0,"stats":{"Line":24}},{"line":1008,"address":[],"length":0,"stats":{"Line":12}},{"line":1009,"address":[],"length":0,"stats":{"Line":8}},{"line":1010,"address":[],"length":0,"stats":{"Line":4}},{"line":1011,"address":[],"length":0,"stats":{"Line":1}},{"line":1012,"address":[],"length":0,"stats":{"Line":6}},{"line":1014,"address":[],"length":0,"stats":{"Line":4}},{"line":1015,"address":[],"length":0,"stats":{"Line":2}},{"line":1018,"address":[],"length":0,"stats":{"Line":1}},{"line":1024,"address":[],"length":0,"stats":{"Line":0}},{"line":1025,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":2}},{"line":1046,"address":[],"length":0,"stats":{"Line":16}},{"line":1048,"address":[],"length":0,"stats":{"Line":4}},{"line":1049,"address":[],"length":0,"stats":{"Line":2}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1053,"address":[],"length":0,"stats":{"Line":4}},{"line":1054,"address":[],"length":0,"stats":{"Line":4}},{"line":1055,"address":[],"length":0,"stats":{"Line":4}},{"line":1056,"address":[],"length":0,"stats":{"Line":4}},{"line":1057,"address":[],"length":0,"stats":{"Line":4}},{"line":1058,"address":[],"length":0,"stats":{"Line":4}},{"line":1059,"address":[],"length":0,"stats":{"Line":4}},{"line":1060,"address":[],"length":0,"stats":{"Line":4}},{"line":1061,"address":[],"length":0,"stats":{"Line":4}},{"line":1062,"address":[],"length":0,"stats":{"Line":4}},{"line":1063,"address":[],"length":0,"stats":{"Line":2}},{"line":1065,"address":[],"length":0,"stats":{"Line":2}},{"line":1067,"address":[],"length":0,"stats":{"Line":2}},{"line":1069,"address":[],"length":0,"stats":{"Line":2}},{"line":1070,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":6}},{"line":1075,"address":[],"length":0,"stats":{"Line":2}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1127,"address":[],"length":0,"stats":{"Line":0}},{"line":1128,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1130,"address":[],"length":0,"stats":{"Line":0}},{"line":1131,"address":[],"length":0,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":4}},{"line":1138,"address":[],"length":0,"stats":{"Line":4}},{"line":1140,"address":[],"length":0,"stats":{"Line":4}},{"line":1142,"address":[],"length":0,"stats":{"Line":4}},{"line":1143,"address":[],"length":0,"stats":{"Line":6}},{"line":1144,"address":[],"length":0,"stats":{"Line":6}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1147,"address":[],"length":0,"stats":{"Line":2}},{"line":1149,"address":[],"length":0,"stats":{"Line":6}},{"line":1150,"address":[],"length":0,"stats":{"Line":4}},{"line":1152,"address":[],"length":0,"stats":{"Line":2}},{"line":1153,"address":[],"length":0,"stats":{"Line":2}},{"line":1155,"address":[],"length":0,"stats":{"Line":0}},{"line":1156,"address":[],"length":0,"stats":{"Line":0}},{"line":1157,"address":[],"length":0,"stats":{"Line":0}},{"line":1158,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1161,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1165,"address":[],"length":0,"stats":{"Line":0}},{"line":1166,"address":[],"length":0,"stats":{"Line":0}},{"line":1168,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1172,"address":[],"length":0,"stats":{"Line":0}},{"line":1173,"address":[],"length":0,"stats":{"Line":0}},{"line":1174,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[],"length":0,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1183,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1185,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1188,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1191,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1194,"address":[],"length":0,"stats":{"Line":0}},{"line":1195,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1201,"address":[],"length":0,"stats":{"Line":6}},{"line":1202,"address":[],"length":0,"stats":{"Line":6}},{"line":1203,"address":[],"length":0,"stats":{"Line":6}},{"line":1204,"address":[],"length":0,"stats":{"Line":6}},{"line":1205,"address":[],"length":0,"stats":{"Line":6}},{"line":1206,"address":[],"length":0,"stats":{"Line":6}},{"line":1207,"address":[],"length":0,"stats":{"Line":6}},{"line":1210,"address":[],"length":0,"stats":{"Line":2}},{"line":1211,"address":[],"length":0,"stats":{"Line":0}},{"line":1212,"address":[],"length":0,"stats":{"Line":0}},{"line":1213,"address":[],"length":0,"stats":{"Line":0}},{"line":1214,"address":[],"length":0,"stats":{"Line":0}},{"line":1215,"address":[],"length":0,"stats":{"Line":0}},{"line":1216,"address":[],"length":0,"stats":{"Line":0}},{"line":1217,"address":[],"length":0,"stats":{"Line":0}},{"line":1218,"address":[],"length":0,"stats":{"Line":0}},{"line":1219,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":6}},{"line":1224,"address":[],"length":0,"stats":{"Line":2}},{"line":1225,"address":[],"length":0,"stats":{"Line":4}},{"line":1226,"address":[],"length":0,"stats":{"Line":4}},{"line":1227,"address":[],"length":0,"stats":{"Line":2}},{"line":1228,"address":[],"length":0,"stats":{"Line":2}},{"line":1229,"address":[],"length":0,"stats":{"Line":6}},{"line":1230,"address":[],"length":0,"stats":{"Line":4}},{"line":1231,"address":[],"length":0,"stats":{"Line":4}},{"line":1232,"address":[],"length":0,"stats":{"Line":6}},{"line":1233,"address":[],"length":0,"stats":{"Line":4}},{"line":1234,"address":[],"length":0,"stats":{"Line":4}},{"line":1235,"address":[],"length":0,"stats":{"Line":6}},{"line":1236,"address":[],"length":0,"stats":{"Line":4}},{"line":1237,"address":[],"length":0,"stats":{"Line":4}},{"line":1242,"address":[],"length":0,"stats":{"Line":0}},{"line":1244,"address":[],"length":0,"stats":{"Line":0}},{"line":1245,"address":[],"length":0,"stats":{"Line":0}},{"line":1246,"address":[],"length":0,"stats":{"Line":0}},{"line":1247,"address":[],"length":0,"stats":{"Line":0}},{"line":1248,"address":[],"length":0,"stats":{"Line":0}},{"line":1249,"address":[],"length":0,"stats":{"Line":0}},{"line":1250,"address":[],"length":0,"stats":{"Line":0}},{"line":1251,"address":[],"length":0,"stats":{"Line":0}},{"line":1252,"address":[],"length":0,"stats":{"Line":0}},{"line":1253,"address":[],"length":0,"stats":{"Line":0}},{"line":1256,"address":[],"length":0,"stats":{"Line":0}},{"line":1257,"address":[],"length":0,"stats":{"Line":0}},{"line":1259,"address":[],"length":0,"stats":{"Line":0}},{"line":1260,"address":[],"length":0,"stats":{"Line":0}},{"line":1262,"address":[],"length":0,"stats":{"Line":0}},{"line":1265,"address":[],"length":0,"stats":{"Line":0}},{"line":1266,"address":[],"length":0,"stats":{"Line":0}},{"line":1267,"address":[],"length":0,"stats":{"Line":0}},{"line":1268,"address":[],"length":0,"stats":{"Line":0}},{"line":1269,"address":[],"length":0,"stats":{"Line":0}},{"line":1270,"address":[],"length":0,"stats":{"Line":0}},{"line":1271,"address":[],"length":0,"stats":{"Line":0}},{"line":1272,"address":[],"length":0,"stats":{"Line":0}},{"line":1273,"address":[],"length":0,"stats":{"Line":0}},{"line":1274,"address":[],"length":0,"stats":{"Line":0}},{"line":1275,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1277,"address":[],"length":0,"stats":{"Line":0}},{"line":1278,"address":[],"length":0,"stats":{"Line":0}},{"line":1279,"address":[],"length":0,"stats":{"Line":0}},{"line":1283,"address":[],"length":0,"stats":{"Line":0}},{"line":1284,"address":[],"length":0,"stats":{"Line":0}},{"line":1285,"address":[],"length":0,"stats":{"Line":0}},{"line":1286,"address":[],"length":0,"stats":{"Line":0}},{"line":1287,"address":[],"length":0,"stats":{"Line":0}},{"line":1288,"address":[],"length":0,"stats":{"Line":0}},{"line":1289,"address":[],"length":0,"stats":{"Line":0}},{"line":1290,"address":[],"length":0,"stats":{"Line":0}},{"line":1291,"address":[],"length":0,"stats":{"Line":0}},{"line":1292,"address":[],"length":0,"stats":{"Line":0}},{"line":1293,"address":[],"length":0,"stats":{"Line":0}},{"line":1294,"address":[],"length":0,"stats":{"Line":0}},{"line":1295,"address":[],"length":0,"stats":{"Line":0}},{"line":1296,"address":[],"length":0,"stats":{"Line":0}},{"line":1297,"address":[],"length":0,"stats":{"Line":0}},{"line":1298,"address":[],"length":0,"stats":{"Line":0}},{"line":1299,"address":[],"length":0,"stats":{"Line":0}},{"line":1300,"address":[],"length":0,"stats":{"Line":0}},{"line":1301,"address":[],"length":0,"stats":{"Line":0}},{"line":1302,"address":[],"length":0,"stats":{"Line":0}},{"line":1303,"address":[],"length":0,"stats":{"Line":0}},{"line":1304,"address":[],"length":0,"stats":{"Line":0}},{"line":1305,"address":[],"length":0,"stats":{"Line":0}},{"line":1306,"address":[],"length":0,"stats":{"Line":0}},{"line":1307,"address":[],"length":0,"stats":{"Line":0}},{"line":1308,"address":[],"length":0,"stats":{"Line":0}},{"line":1309,"address":[],"length":0,"stats":{"Line":0}},{"line":1310,"address":[],"length":0,"stats":{"Line":0}},{"line":1314,"address":[],"length":0,"stats":{"Line":0}},{"line":1315,"address":[],"length":0,"stats":{"Line":0}},{"line":1316,"address":[],"length":0,"stats":{"Line":0}},{"line":1317,"address":[],"length":0,"stats":{"Line":0}},{"line":1318,"address":[],"length":0,"stats":{"Line":0}},{"line":1319,"address":[],"length":0,"stats":{"Line":0}},{"line":1320,"address":[],"length":0,"stats":{"Line":0}},{"line":1321,"address":[],"length":0,"stats":{"Line":0}},{"line":1322,"address":[],"length":0,"stats":{"Line":0}},{"line":1323,"address":[],"length":0,"stats":{"Line":0}},{"line":1324,"address":[],"length":0,"stats":{"Line":0}},{"line":1327,"address":[],"length":0,"stats":{"Line":0}},{"line":1328,"address":[],"length":0,"stats":{"Line":0}},{"line":1330,"address":[],"length":0,"stats":{"Line":0}},{"line":1331,"address":[],"length":0,"stats":{"Line":0}},{"line":1332,"address":[],"length":0,"stats":{"Line":0}},{"line":1333,"address":[],"length":0,"stats":{"Line":0}},{"line":1334,"address":[],"length":0,"stats":{"Line":0}},{"line":1335,"address":[],"length":0,"stats":{"Line":0}},{"line":1336,"address":[],"length":0,"stats":{"Line":0}},{"line":1337,"address":[],"length":0,"stats":{"Line":0}},{"line":1338,"address":[],"length":0,"stats":{"Line":0}},{"line":1339,"address":[],"length":0,"stats":{"Line":0}},{"line":1340,"address":[],"length":0,"stats":{"Line":0}},{"line":1341,"address":[],"length":0,"stats":{"Line":0}},{"line":1342,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1345,"address":[],"length":0,"stats":{"Line":0}},{"line":1349,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1351,"address":[],"length":0,"stats":{"Line":0}},{"line":1352,"address":[],"length":0,"stats":{"Line":0}},{"line":1353,"address":[],"length":0,"stats":{"Line":0}},{"line":1354,"address":[],"length":0,"stats":{"Line":0}},{"line":1355,"address":[],"length":0,"stats":{"Line":0}},{"line":1356,"address":[],"length":0,"stats":{"Line":0}},{"line":1357,"address":[],"length":0,"stats":{"Line":0}},{"line":1358,"address":[],"length":0,"stats":{"Line":0}},{"line":1359,"address":[],"length":0,"stats":{"Line":0}},{"line":1360,"address":[],"length":0,"stats":{"Line":0}},{"line":1361,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1365,"address":[],"length":0,"stats":{"Line":0}},{"line":1366,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1368,"address":[],"length":0,"stats":{"Line":0}},{"line":1369,"address":[],"length":0,"stats":{"Line":0}},{"line":1370,"address":[],"length":0,"stats":{"Line":0}},{"line":1371,"address":[],"length":0,"stats":{"Line":0}},{"line":1372,"address":[],"length":0,"stats":{"Line":0}},{"line":1373,"address":[],"length":0,"stats":{"Line":0}},{"line":1374,"address":[],"length":0,"stats":{"Line":0}},{"line":1375,"address":[],"length":0,"stats":{"Line":0}},{"line":1376,"address":[],"length":0,"stats":{"Line":0}},{"line":1377,"address":[],"length":0,"stats":{"Line":0}},{"line":1383,"address":[],"length":0,"stats":{"Line":4}},{"line":1384,"address":[],"length":0,"stats":{"Line":4}},{"line":1385,"address":[],"length":0,"stats":{"Line":0}},{"line":1387,"address":[],"length":0,"stats":{"Line":2}},{"line":1388,"address":[],"length":0,"stats":{"Line":6}},{"line":1390,"address":[],"length":0,"stats":{"Line":2}},{"line":1391,"address":[],"length":0,"stats":{"Line":2}},{"line":1392,"address":[],"length":0,"stats":{"Line":2}},{"line":1394,"address":[],"length":0,"stats":{"Line":4}},{"line":1395,"address":[],"length":0,"stats":{"Line":4}},{"line":1396,"address":[],"length":0,"stats":{"Line":4}},{"line":1399,"address":[],"length":0,"stats":{"Line":2}},{"line":1401,"address":[],"length":0,"stats":{"Line":0}},{"line":1403,"address":[],"length":0,"stats":{"Line":0}},{"line":1408,"address":[],"length":0,"stats":{"Line":2}},{"line":1411,"address":[],"length":0,"stats":{"Line":0}},{"line":1427,"address":[],"length":0,"stats":{"Line":0}},{"line":1429,"address":[],"length":0,"stats":{"Line":0}},{"line":1430,"address":[],"length":0,"stats":{"Line":0}},{"line":1432,"address":[],"length":0,"stats":{"Line":0}},{"line":1434,"address":[],"length":0,"stats":{"Line":0}},{"line":1435,"address":[],"length":0,"stats":{"Line":0}},{"line":1436,"address":[],"length":0,"stats":{"Line":0}},{"line":1437,"address":[],"length":0,"stats":{"Line":0}},{"line":1438,"address":[],"length":0,"stats":{"Line":0}},{"line":1439,"address":[],"length":0,"stats":{"Line":0}},{"line":1440,"address":[],"length":0,"stats":{"Line":0}},{"line":1441,"address":[],"length":0,"stats":{"Line":0}},{"line":1442,"address":[],"length":0,"stats":{"Line":0}},{"line":1443,"address":[],"length":0,"stats":{"Line":0}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":0}},{"line":1448,"address":[],"length":0,"stats":{"Line":0}},{"line":1450,"address":[],"length":0,"stats":{"Line":0}},{"line":1451,"address":[],"length":0,"stats":{"Line":0}},{"line":1454,"address":[],"length":0,"stats":{"Line":0}},{"line":1456,"address":[],"length":0,"stats":{"Line":0}},{"line":1479,"address":[],"length":0,"stats":{"Line":0}},{"line":1493,"address":[],"length":0,"stats":{"Line":0}},{"line":1494,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":0}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1502,"address":[],"length":0,"stats":{"Line":0}},{"line":1504,"address":[],"length":0,"stats":{"Line":0}},{"line":1506,"address":[],"length":0,"stats":{"Line":0}},{"line":1507,"address":[],"length":0,"stats":{"Line":0}},{"line":1508,"address":[],"length":0,"stats":{"Line":0}},{"line":1509,"address":[],"length":0,"stats":{"Line":0}},{"line":1511,"address":[],"length":0,"stats":{"Line":0}},{"line":1513,"address":[],"length":0,"stats":{"Line":0}},{"line":1514,"address":[],"length":0,"stats":{"Line":0}},{"line":1515,"address":[],"length":0,"stats":{"Line":0}},{"line":1516,"address":[],"length":0,"stats":{"Line":0}},{"line":1517,"address":[],"length":0,"stats":{"Line":0}},{"line":1518,"address":[],"length":0,"stats":{"Line":0}},{"line":1519,"address":[],"length":0,"stats":{"Line":0}},{"line":1520,"address":[],"length":0,"stats":{"Line":0}},{"line":1521,"address":[],"length":0,"stats":{"Line":0}},{"line":1524,"address":[],"length":0,"stats":{"Line":0}},{"line":1525,"address":[],"length":0,"stats":{"Line":0}},{"line":1526,"address":[],"length":0,"stats":{"Line":0}},{"line":1528,"address":[],"length":0,"stats":{"Line":0}},{"line":1529,"address":[],"length":0,"stats":{"Line":0}},{"line":1531,"address":[],"length":0,"stats":{"Line":0}},{"line":1535,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":0}},{"line":1538,"address":[],"length":0,"stats":{"Line":0}},{"line":1543,"address":[],"length":0,"stats":{"Line":0}},{"line":1544,"address":[],"length":0,"stats":{"Line":0}},{"line":1545,"address":[],"length":0,"stats":{"Line":0}},{"line":1546,"address":[],"length":0,"stats":{"Line":0}},{"line":1547,"address":[],"length":0,"stats":{"Line":0}},{"line":1548,"address":[],"length":0,"stats":{"Line":0}},{"line":1552,"address":[],"length":0,"stats":{"Line":0}},{"line":1553,"address":[],"length":0,"stats":{"Line":0}},{"line":1554,"address":[],"length":0,"stats":{"Line":0}},{"line":1555,"address":[],"length":0,"stats":{"Line":0}},{"line":1556,"address":[],"length":0,"stats":{"Line":0}},{"line":1557,"address":[],"length":0,"stats":{"Line":0}},{"line":1558,"address":[],"length":0,"stats":{"Line":0}},{"line":1559,"address":[],"length":0,"stats":{"Line":0}},{"line":1560,"address":[],"length":0,"stats":{"Line":0}},{"line":1561,"address":[],"length":0,"stats":{"Line":0}},{"line":1562,"address":[],"length":0,"stats":{"Line":0}},{"line":1563,"address":[],"length":0,"stats":{"Line":0}},{"line":1564,"address":[],"length":0,"stats":{"Line":0}},{"line":1565,"address":[],"length":0,"stats":{"Line":0}},{"line":1568,"address":[],"length":0,"stats":{"Line":0}},{"line":1569,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1571,"address":[],"length":0,"stats":{"Line":0}},{"line":1572,"address":[],"length":0,"stats":{"Line":0}},{"line":1573,"address":[],"length":0,"stats":{"Line":0}},{"line":1574,"address":[],"length":0,"stats":{"Line":0}},{"line":1575,"address":[],"length":0,"stats":{"Line":0}},{"line":1576,"address":[],"length":0,"stats":{"Line":0}},{"line":1579,"address":[],"length":0,"stats":{"Line":0}},{"line":1580,"address":[],"length":0,"stats":{"Line":0}},{"line":1581,"address":[],"length":0,"stats":{"Line":0}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1584,"address":[],"length":0,"stats":{"Line":0}},{"line":1586,"address":[],"length":0,"stats":{"Line":0}},{"line":1590,"address":[],"length":0,"stats":{"Line":0}},{"line":1591,"address":[],"length":0,"stats":{"Line":0}},{"line":1593,"address":[],"length":0,"stats":{"Line":0}},{"line":1597,"address":[],"length":0,"stats":{"Line":0}},{"line":1599,"address":[],"length":0,"stats":{"Line":0}},{"line":1600,"address":[],"length":0,"stats":{"Line":0}},{"line":1601,"address":[],"length":0,"stats":{"Line":0}},{"line":1602,"address":[],"length":0,"stats":{"Line":0}},{"line":1603,"address":[],"length":0,"stats":{"Line":0}},{"line":1604,"address":[],"length":0,"stats":{"Line":0}},{"line":1605,"address":[],"length":0,"stats":{"Line":0}},{"line":1606,"address":[],"length":0,"stats":{"Line":0}},{"line":1607,"address":[],"length":0,"stats":{"Line":0}},{"line":1608,"address":[],"length":0,"stats":{"Line":0}},{"line":1609,"address":[],"length":0,"stats":{"Line":0}},{"line":1613,"address":[],"length":0,"stats":{"Line":0}},{"line":1614,"address":[],"length":0,"stats":{"Line":0}},{"line":1615,"address":[],"length":0,"stats":{"Line":0}},{"line":1616,"address":[],"length":0,"stats":{"Line":0}},{"line":1617,"address":[],"length":0,"stats":{"Line":0}},{"line":1619,"address":[],"length":0,"stats":{"Line":0}},{"line":1620,"address":[],"length":0,"stats":{"Line":0}},{"line":1621,"address":[],"length":0,"stats":{"Line":0}},{"line":1622,"address":[],"length":0,"stats":{"Line":0}},{"line":1623,"address":[],"length":0,"stats":{"Line":0}},{"line":1624,"address":[],"length":0,"stats":{"Line":0}},{"line":1625,"address":[],"length":0,"stats":{"Line":0}},{"line":1626,"address":[],"length":0,"stats":{"Line":0}},{"line":1627,"address":[],"length":0,"stats":{"Line":0}},{"line":1628,"address":[],"length":0,"stats":{"Line":0}},{"line":1629,"address":[],"length":0,"stats":{"Line":0}},{"line":1630,"address":[],"length":0,"stats":{"Line":0}},{"line":1631,"address":[],"length":0,"stats":{"Line":0}},{"line":1632,"address":[],"length":0,"stats":{"Line":0}},{"line":1633,"address":[],"length":0,"stats":{"Line":0}},{"line":1634,"address":[],"length":0,"stats":{"Line":0}},{"line":1635,"address":[],"length":0,"stats":{"Line":0}},{"line":1636,"address":[],"length":0,"stats":{"Line":0}},{"line":1637,"address":[],"length":0,"stats":{"Line":0}},{"line":1638,"address":[],"length":0,"stats":{"Line":0}},{"line":1639,"address":[],"length":0,"stats":{"Line":0}},{"line":1640,"address":[],"length":0,"stats":{"Line":0}},{"line":1641,"address":[],"length":0,"stats":{"Line":0}},{"line":1645,"address":[],"length":0,"stats":{"Line":0}},{"line":1646,"address":[],"length":0,"stats":{"Line":0}},{"line":1647,"address":[],"length":0,"stats":{"Line":0}},{"line":1649,"address":[],"length":0,"stats":{"Line":0}},{"line":1650,"address":[],"length":0,"stats":{"Line":0}},{"line":1652,"address":[],"length":0,"stats":{"Line":0}},{"line":1654,"address":[],"length":0,"stats":{"Line":0}},{"line":1657,"address":[],"length":0,"stats":{"Line":0}},{"line":1659,"address":[],"length":0,"stats":{"Line":0}},{"line":1661,"address":[],"length":0,"stats":{"Line":0}},{"line":1666,"address":[],"length":0,"stats":{"Line":0}},{"line":1669,"address":[],"length":0,"stats":{"Line":0}},{"line":1680,"address":[],"length":0,"stats":{"Line":0}},{"line":1682,"address":[],"length":0,"stats":{"Line":0}},{"line":1683,"address":[],"length":0,"stats":{"Line":0}},{"line":1685,"address":[],"length":0,"stats":{"Line":0}},{"line":1692,"address":[],"length":0,"stats":{"Line":0}},{"line":1695,"address":[],"length":0,"stats":{"Line":0}},{"line":1696,"address":[],"length":0,"stats":{"Line":0}},{"line":1697,"address":[],"length":0,"stats":{"Line":0}},{"line":1698,"address":[],"length":0,"stats":{"Line":0}},{"line":1699,"address":[],"length":0,"stats":{"Line":0}},{"line":1702,"address":[],"length":0,"stats":{"Line":0}},{"line":1703,"address":[],"length":0,"stats":{"Line":0}},{"line":1704,"address":[],"length":0,"stats":{"Line":0}},{"line":1705,"address":[],"length":0,"stats":{"Line":0}},{"line":1709,"address":[],"length":0,"stats":{"Line":0}},{"line":1712,"address":[],"length":0,"stats":{"Line":0}},{"line":1724,"address":[],"length":0,"stats":{"Line":0}},{"line":1725,"address":[],"length":0,"stats":{"Line":0}},{"line":1726,"address":[],"length":0,"stats":{"Line":0}},{"line":1727,"address":[],"length":0,"stats":{"Line":0}},{"line":1729,"address":[],"length":0,"stats":{"Line":0}},{"line":1731,"address":[],"length":0,"stats":{"Line":0}},{"line":1733,"address":[],"length":0,"stats":{"Line":0}},{"line":1735,"address":[],"length":0,"stats":{"Line":0}},{"line":1739,"address":[],"length":0,"stats":{"Line":0}},{"line":1740,"address":[],"length":0,"stats":{"Line":0}},{"line":1742,"address":[],"length":0,"stats":{"Line":0}},{"line":1743,"address":[],"length":0,"stats":{"Line":0}},{"line":1744,"address":[],"length":0,"stats":{"Line":0}},{"line":1745,"address":[],"length":0,"stats":{"Line":0}},{"line":1746,"address":[],"length":0,"stats":{"Line":0}},{"line":1747,"address":[],"length":0,"stats":{"Line":0}},{"line":1750,"address":[],"length":0,"stats":{"Line":0}},{"line":1751,"address":[],"length":0,"stats":{"Line":0}},{"line":1752,"address":[],"length":0,"stats":{"Line":0}},{"line":1753,"address":[],"length":0,"stats":{"Line":0}},{"line":1755,"address":[],"length":0,"stats":{"Line":0}},{"line":1756,"address":[],"length":0,"stats":{"Line":0}},{"line":1757,"address":[],"length":0,"stats":{"Line":0}},{"line":1758,"address":[],"length":0,"stats":{"Line":0}},{"line":1760,"address":[],"length":0,"stats":{"Line":0}},{"line":1767,"address":[],"length":0,"stats":{"Line":0}},{"line":1769,"address":[],"length":0,"stats":{"Line":0}},{"line":1770,"address":[],"length":0,"stats":{"Line":0}},{"line":1771,"address":[],"length":0,"stats":{"Line":0}},{"line":1774,"address":[],"length":0,"stats":{"Line":0}},{"line":1776,"address":[],"length":0,"stats":{"Line":0}},{"line":1780,"address":[],"length":0,"stats":{"Line":0}},{"line":1781,"address":[],"length":0,"stats":{"Line":0}},{"line":1784,"address":[],"length":0,"stats":{"Line":0}},{"line":1785,"address":[],"length":0,"stats":{"Line":0}},{"line":1786,"address":[],"length":0,"stats":{"Line":0}},{"line":1808,"address":[],"length":0,"stats":{"Line":0}},{"line":1809,"address":[],"length":0,"stats":{"Line":0}},{"line":1810,"address":[],"length":0,"stats":{"Line":0}},{"line":1811,"address":[],"length":0,"stats":{"Line":0}},{"line":1821,"address":[],"length":0,"stats":{"Line":0}},{"line":1832,"address":[],"length":0,"stats":{"Line":0}},{"line":1833,"address":[],"length":0,"stats":{"Line":0}},{"line":1836,"address":[],"length":0,"stats":{"Line":0}},{"line":1837,"address":[],"length":0,"stats":{"Line":0}},{"line":1841,"address":[],"length":0,"stats":{"Line":0}},{"line":1842,"address":[],"length":0,"stats":{"Line":0}},{"line":1843,"address":[],"length":0,"stats":{"Line":0}},{"line":1844,"address":[],"length":0,"stats":{"Line":0}},{"line":1845,"address":[],"length":0,"stats":{"Line":0}},{"line":1846,"address":[],"length":0,"stats":{"Line":0}},{"line":1848,"address":[],"length":0,"stats":{"Line":0}},{"line":1850,"address":[],"length":0,"stats":{"Line":0}},{"line":1851,"address":[],"length":0,"stats":{"Line":0}},{"line":1852,"address":[],"length":0,"stats":{"Line":0}},{"line":1853,"address":[],"length":0,"stats":{"Line":0}},{"line":1854,"address":[],"length":0,"stats":{"Line":0}},{"line":1855,"address":[],"length":0,"stats":{"Line":0}},{"line":1856,"address":[],"length":0,"stats":{"Line":0}},{"line":1857,"address":[],"length":0,"stats":{"Line":0}},{"line":1858,"address":[],"length":0,"stats":{"Line":0}},{"line":1859,"address":[],"length":0,"stats":{"Line":0}},{"line":1862,"address":[],"length":0,"stats":{"Line":0}},{"line":1863,"address":[],"length":0,"stats":{"Line":0}},{"line":1864,"address":[],"length":0,"stats":{"Line":0}},{"line":1865,"address":[],"length":0,"stats":{"Line":0}},{"line":1868,"address":[],"length":0,"stats":{"Line":0}},{"line":1871,"address":[],"length":0,"stats":{"Line":0}},{"line":1872,"address":[],"length":0,"stats":{"Line":0}},{"line":1877,"address":[],"length":0,"stats":{"Line":0}},{"line":1880,"address":[],"length":0,"stats":{"Line":9}},{"line":1881,"address":[],"length":0,"stats":{"Line":9}},{"line":1884,"address":[],"length":0,"stats":{"Line":2}},{"line":1885,"address":[],"length":0,"stats":{"Line":6}},{"line":1886,"address":[],"length":0,"stats":{"Line":6}},{"line":1888,"address":[],"length":0,"stats":{"Line":868}},{"line":1889,"address":[],"length":0,"stats":{"Line":2950}},{"line":1890,"address":[],"length":0,"stats":{"Line":1432}},{"line":1891,"address":[],"length":0,"stats":{"Line":1432}},{"line":1892,"address":[],"length":0,"stats":{"Line":716}},{"line":1894,"address":[],"length":0,"stats":{"Line":1012}},{"line":1898,"address":[],"length":0,"stats":{"Line":2}},{"line":1901,"address":[],"length":0,"stats":{"Line":0}},{"line":1902,"address":[],"length":0,"stats":{"Line":0}},{"line":1903,"address":[],"length":0,"stats":{"Line":0}},{"line":1904,"address":[],"length":0,"stats":{"Line":0}},{"line":1905,"address":[],"length":0,"stats":{"Line":0}},{"line":1906,"address":[],"length":0,"stats":{"Line":0}},{"line":1909,"address":[],"length":0,"stats":{"Line":0}},{"line":1912,"address":[],"length":0,"stats":{"Line":10}},{"line":1913,"address":[],"length":0,"stats":{"Line":10}},{"line":1914,"address":[],"length":0,"stats":{"Line":12}},{"line":1915,"address":[],"length":0,"stats":{"Line":11}},{"line":1916,"address":[],"length":0,"stats":{"Line":10}},{"line":1917,"address":[],"length":0,"stats":{"Line":9}},{"line":1918,"address":[],"length":0,"stats":{"Line":8}},{"line":1919,"address":[],"length":0,"stats":{"Line":7}},{"line":1920,"address":[],"length":0,"stats":{"Line":6}},{"line":1921,"address":[],"length":0,"stats":{"Line":5}},{"line":1922,"address":[],"length":0,"stats":{"Line":4}},{"line":1923,"address":[],"length":0,"stats":{"Line":3}},{"line":1927,"address":[],"length":0,"stats":{"Line":0}},{"line":1930,"address":[],"length":0,"stats":{"Line":0}},{"line":1931,"address":[],"length":0,"stats":{"Line":0}},{"line":1933,"address":[],"length":0,"stats":{"Line":0}},{"line":1934,"address":[],"length":0,"stats":{"Line":0}},{"line":1935,"address":[],"length":0,"stats":{"Line":0}},{"line":1936,"address":[],"length":0,"stats":{"Line":0}},{"line":1937,"address":[],"length":0,"stats":{"Line":0}},{"line":1938,"address":[],"length":0,"stats":{"Line":0}},{"line":1939,"address":[],"length":0,"stats":{"Line":0}},{"line":1940,"address":[],"length":0,"stats":{"Line":0}},{"line":1941,"address":[],"length":0,"stats":{"Line":0}},{"line":1942,"address":[],"length":0,"stats":{"Line":0}},{"line":1943,"address":[],"length":0,"stats":{"Line":0}},{"line":1945,"address":[],"length":0,"stats":{"Line":0}},{"line":1946,"address":[],"length":0,"stats":{"Line":0}},{"line":1947,"address":[],"length":0,"stats":{"Line":0}},{"line":1949,"address":[],"length":0,"stats":{"Line":0}},{"line":1951,"address":[],"length":0,"stats":{"Line":0}},{"line":1952,"address":[],"length":0,"stats":{"Line":0}},{"line":1953,"address":[],"length":0,"stats":{"Line":0}},{"line":1954,"address":[],"length":0,"stats":{"Line":0}},{"line":1955,"address":[],"length":0,"stats":{"Line":0}},{"line":1956,"address":[],"length":0,"stats":{"Line":0}},{"line":1988,"address":[],"length":0,"stats":{"Line":0}},{"line":1989,"address":[],"length":0,"stats":{"Line":0}},{"line":1990,"address":[],"length":0,"stats":{"Line":0}},{"line":1991,"address":[],"length":0,"stats":{"Line":0}},{"line":1992,"address":[],"length":0,"stats":{"Line":0}},{"line":1993,"address":[],"length":0,"stats":{"Line":0}},{"line":1994,"address":[],"length":0,"stats":{"Line":0}},{"line":1995,"address":[],"length":0,"stats":{"Line":0}},{"line":1996,"address":[],"length":0,"stats":{"Line":0}},{"line":1997,"address":[],"length":0,"stats":{"Line":0}},{"line":1998,"address":[],"length":0,"stats":{"Line":0}},{"line":1999,"address":[],"length":0,"stats":{"Line":0}},{"line":2000,"address":[],"length":0,"stats":{"Line":0}},{"line":2001,"address":[],"length":0,"stats":{"Line":0}},{"line":2002,"address":[],"length":0,"stats":{"Line":0}},{"line":2003,"address":[],"length":0,"stats":{"Line":0}},{"line":2005,"address":[],"length":0,"stats":{"Line":0}},{"line":2006,"address":[],"length":0,"stats":{"Line":0}},{"line":2007,"address":[],"length":0,"stats":{"Line":0}},{"line":2008,"address":[],"length":0,"stats":{"Line":0}},{"line":2009,"address":[],"length":0,"stats":{"Line":0}},{"line":2010,"address":[],"length":0,"stats":{"Line":0}},{"line":2011,"address":[],"length":0,"stats":{"Line":0}},{"line":2012,"address":[],"length":0,"stats":{"Line":0}},{"line":2013,"address":[],"length":0,"stats":{"Line":0}},{"line":2014,"address":[],"length":0,"stats":{"Line":0}},{"line":2015,"address":[],"length":0,"stats":{"Line":0}},{"line":2016,"address":[],"length":0,"stats":{"Line":0}},{"line":2017,"address":[],"length":0,"stats":{"Line":0}},{"line":2020,"address":[],"length":0,"stats":{"Line":0}},{"line":2021,"address":[],"length":0,"stats":{"Line":0}},{"line":2022,"address":[],"length":0,"stats":{"Line":0}},{"line":2023,"address":[],"length":0,"stats":{"Line":0}},{"line":2024,"address":[],"length":0,"stats":{"Line":0}},{"line":2025,"address":[],"length":0,"stats":{"Line":0}},{"line":2026,"address":[],"length":0,"stats":{"Line":0}},{"line":2027,"address":[],"length":0,"stats":{"Line":0}},{"line":2028,"address":[],"length":0,"stats":{"Line":0}},{"line":2030,"address":[],"length":0,"stats":{"Line":0}},{"line":2031,"address":[],"length":0,"stats":{"Line":0}},{"line":2032,"address":[],"length":0,"stats":{"Line":0}},{"line":2033,"address":[],"length":0,"stats":{"Line":0}},{"line":2034,"address":[],"length":0,"stats":{"Line":0}},{"line":2035,"address":[],"length":0,"stats":{"Line":0}},{"line":2036,"address":[],"length":0,"stats":{"Line":0}},{"line":2039,"address":[],"length":0,"stats":{"Line":0}},{"line":2040,"address":[],"length":0,"stats":{"Line":0}},{"line":2042,"address":[],"length":0,"stats":{"Line":0}},{"line":2043,"address":[],"length":0,"stats":{"Line":0}},{"line":2044,"address":[],"length":0,"stats":{"Line":0}},{"line":2045,"address":[],"length":0,"stats":{"Line":0}},{"line":2046,"address":[],"length":0,"stats":{"Line":0}},{"line":2047,"address":[],"length":0,"stats":{"Line":0}},{"line":2048,"address":[],"length":0,"stats":{"Line":0}},{"line":2049,"address":[],"length":0,"stats":{"Line":0}},{"line":2050,"address":[],"length":0,"stats":{"Line":0}},{"line":2051,"address":[],"length":0,"stats":{"Line":0}},{"line":2053,"address":[],"length":0,"stats":{"Line":0}},{"line":2054,"address":[],"length":0,"stats":{"Line":0}},{"line":2055,"address":[],"length":0,"stats":{"Line":0}},{"line":2056,"address":[],"length":0,"stats":{"Line":0}},{"line":2057,"address":[],"length":0,"stats":{"Line":0}},{"line":2058,"address":[],"length":0,"stats":{"Line":0}},{"line":2059,"address":[],"length":0,"stats":{"Line":0}},{"line":2060,"address":[],"length":0,"stats":{"Line":0}},{"line":2061,"address":[],"length":0,"stats":{"Line":0}},{"line":2062,"address":[],"length":0,"stats":{"Line":0}},{"line":2063,"address":[],"length":0,"stats":{"Line":0}},{"line":2064,"address":[],"length":0,"stats":{"Line":0}},{"line":2065,"address":[],"length":0,"stats":{"Line":0}},{"line":2067,"address":[],"length":0,"stats":{"Line":0}},{"line":2068,"address":[],"length":0,"stats":{"Line":0}},{"line":2069,"address":[],"length":0,"stats":{"Line":0}},{"line":2070,"address":[],"length":0,"stats":{"Line":0}},{"line":2071,"address":[],"length":0,"stats":{"Line":0}},{"line":2072,"address":[],"length":0,"stats":{"Line":0}},{"line":2073,"address":[],"length":0,"stats":{"Line":0}},{"line":2074,"address":[],"length":0,"stats":{"Line":0}},{"line":2075,"address":[],"length":0,"stats":{"Line":0}},{"line":2076,"address":[],"length":0,"stats":{"Line":0}},{"line":2077,"address":[],"length":0,"stats":{"Line":0}},{"line":2078,"address":[],"length":0,"stats":{"Line":0}},{"line":2079,"address":[],"length":0,"stats":{"Line":0}},{"line":2081,"address":[],"length":0,"stats":{"Line":0}},{"line":2082,"address":[],"length":0,"stats":{"Line":0}},{"line":2083,"address":[],"length":0,"stats":{"Line":0}},{"line":2084,"address":[],"length":0,"stats":{"Line":0}},{"line":2085,"address":[],"length":0,"stats":{"Line":0}},{"line":2086,"address":[],"length":0,"stats":{"Line":0}},{"line":2087,"address":[],"length":0,"stats":{"Line":0}},{"line":2088,"address":[],"length":0,"stats":{"Line":0}},{"line":2089,"address":[],"length":0,"stats":{"Line":0}},{"line":2090,"address":[],"length":0,"stats":{"Line":0}},{"line":2091,"address":[],"length":0,"stats":{"Line":0}},{"line":2092,"address":[],"length":0,"stats":{"Line":0}},{"line":2093,"address":[],"length":0,"stats":{"Line":0}},{"line":2095,"address":[],"length":0,"stats":{"Line":0}},{"line":2096,"address":[],"length":0,"stats":{"Line":0}},{"line":2097,"address":[],"length":0,"stats":{"Line":0}},{"line":2098,"address":[],"length":0,"stats":{"Line":0}},{"line":2099,"address":[],"length":0,"stats":{"Line":0}},{"line":2100,"address":[],"length":0,"stats":{"Line":0}},{"line":2101,"address":[],"length":0,"stats":{"Line":0}},{"line":2102,"address":[],"length":0,"stats":{"Line":0}},{"line":2103,"address":[],"length":0,"stats":{"Line":0}},{"line":2104,"address":[],"length":0,"stats":{"Line":0}},{"line":2105,"address":[],"length":0,"stats":{"Line":0}},{"line":2106,"address":[],"length":0,"stats":{"Line":0}},{"line":2107,"address":[],"length":0,"stats":{"Line":0}},{"line":2108,"address":[],"length":0,"stats":{"Line":0}},{"line":2109,"address":[],"length":0,"stats":{"Line":0}},{"line":2111,"address":[],"length":0,"stats":{"Line":0}},{"line":2112,"address":[],"length":0,"stats":{"Line":0}},{"line":2113,"address":[],"length":0,"stats":{"Line":0}},{"line":2114,"address":[],"length":0,"stats":{"Line":0}},{"line":2115,"address":[],"length":0,"stats":{"Line":0}},{"line":2116,"address":[],"length":0,"stats":{"Line":0}},{"line":2118,"address":[],"length":0,"stats":{"Line":0}},{"line":2119,"address":[],"length":0,"stats":{"Line":0}},{"line":2120,"address":[],"length":0,"stats":{"Line":0}},{"line":2121,"address":[],"length":0,"stats":{"Line":0}},{"line":2122,"address":[],"length":0,"stats":{"Line":0}},{"line":2123,"address":[],"length":0,"stats":{"Line":0}},{"line":2126,"address":[],"length":0,"stats":{"Line":0}},{"line":2127,"address":[],"length":0,"stats":{"Line":0}},{"line":2128,"address":[],"length":0,"stats":{"Line":0}},{"line":2129,"address":[],"length":0,"stats":{"Line":0}},{"line":2131,"address":[],"length":0,"stats":{"Line":0}},{"line":2132,"address":[],"length":0,"stats":{"Line":0}},{"line":2133,"address":[],"length":0,"stats":{"Line":0}},{"line":2134,"address":[],"length":0,"stats":{"Line":0}},{"line":2135,"address":[],"length":0,"stats":{"Line":0}},{"line":2136,"address":[],"length":0,"stats":{"Line":0}},{"line":2137,"address":[],"length":0,"stats":{"Line":0}},{"line":2138,"address":[],"length":0,"stats":{"Line":0}},{"line":2139,"address":[],"length":0,"stats":{"Line":0}},{"line":2140,"address":[],"length":0,"stats":{"Line":0}},{"line":2141,"address":[],"length":0,"stats":{"Line":0}},{"line":2142,"address":[],"length":0,"stats":{"Line":0}},{"line":2143,"address":[],"length":0,"stats":{"Line":0}},{"line":2147,"address":[],"length":0,"stats":{"Line":0}},{"line":2157,"address":[],"length":0,"stats":{"Line":0}},{"line":2162,"address":[],"length":0,"stats":{"Line":0}},{"line":2165,"address":[],"length":0,"stats":{"Line":0}},{"line":2169,"address":[],"length":0,"stats":{"Line":0}},{"line":2170,"address":[],"length":0,"stats":{"Line":0}},{"line":2172,"address":[],"length":0,"stats":{"Line":0}},{"line":2174,"address":[],"length":0,"stats":{"Line":0}},{"line":2175,"address":[],"length":0,"stats":{"Line":0}},{"line":2176,"address":[],"length":0,"stats":{"Line":0}},{"line":2177,"address":[],"length":0,"stats":{"Line":0}},{"line":2178,"address":[],"length":0,"stats":{"Line":0}},{"line":2180,"address":[],"length":0,"stats":{"Line":0}},{"line":2182,"address":[],"length":0,"stats":{"Line":0}},{"line":2184,"address":[],"length":0,"stats":{"Line":0}},{"line":2185,"address":[],"length":0,"stats":{"Line":0}},{"line":2186,"address":[],"length":0,"stats":{"Line":0}},{"line":2188,"address":[],"length":0,"stats":{"Line":0}},{"line":2189,"address":[],"length":0,"stats":{"Line":0}},{"line":2190,"address":[],"length":0,"stats":{"Line":0}},{"line":2192,"address":[],"length":0,"stats":{"Line":0}},{"line":2195,"address":[],"length":0,"stats":{"Line":0}},{"line":2196,"address":[],"length":0,"stats":{"Line":0}},{"line":2197,"address":[],"length":0,"stats":{"Line":0}},{"line":2199,"address":[],"length":0,"stats":{"Line":0}},{"line":2201,"address":[],"length":0,"stats":{"Line":0}},{"line":2203,"address":[],"length":0,"stats":{"Line":0}},{"line":2207,"address":[],"length":0,"stats":{"Line":0}},{"line":2208,"address":[],"length":0,"stats":{"Line":0}},{"line":2209,"address":[],"length":0,"stats":{"Line":0}},{"line":2211,"address":[],"length":0,"stats":{"Line":0}},{"line":2213,"address":[],"length":0,"stats":{"Line":0}},{"line":2215,"address":[],"length":0,"stats":{"Line":0}},{"line":2217,"address":[],"length":0,"stats":{"Line":0}},{"line":2219,"address":[],"length":0,"stats":{"Line":0}},{"line":2220,"address":[],"length":0,"stats":{"Line":0}},{"line":2221,"address":[],"length":0,"stats":{"Line":0}},{"line":2222,"address":[],"length":0,"stats":{"Line":0}},{"line":2224,"address":[],"length":0,"stats":{"Line":0}},{"line":2227,"address":[],"length":0,"stats":{"Line":0}},{"line":2228,"address":[],"length":0,"stats":{"Line":0}},{"line":2229,"address":[],"length":0,"stats":{"Line":0}},{"line":2233,"address":[],"length":0,"stats":{"Line":0}},{"line":2236,"address":[],"length":0,"stats":{"Line":0}},{"line":2238,"address":[],"length":0,"stats":{"Line":0}},{"line":2240,"address":[],"length":0,"stats":{"Line":0}},{"line":2243,"address":[],"length":0,"stats":{"Line":0}},{"line":2246,"address":[],"length":0,"stats":{"Line":0}},{"line":2247,"address":[],"length":0,"stats":{"Line":0}},{"line":2249,"address":[],"length":0,"stats":{"Line":0}},{"line":2250,"address":[],"length":0,"stats":{"Line":0}},{"line":2252,"address":[],"length":0,"stats":{"Line":0}},{"line":2256,"address":[],"length":0,"stats":{"Line":0}},{"line":2260,"address":[],"length":0,"stats":{"Line":0}},{"line":2263,"address":[],"length":0,"stats":{"Line":0}},{"line":2264,"address":[],"length":0,"stats":{"Line":0}},{"line":2265,"address":[],"length":0,"stats":{"Line":0}},{"line":2267,"address":[],"length":0,"stats":{"Line":0}},{"line":2271,"address":[],"length":0,"stats":{"Line":0}},{"line":2272,"address":[],"length":0,"stats":{"Line":0}},{"line":2273,"address":[],"length":0,"stats":{"Line":0}},{"line":2275,"address":[],"length":0,"stats":{"Line":0}},{"line":2277,"address":[],"length":0,"stats":{"Line":0}},{"line":2278,"address":[],"length":0,"stats":{"Line":0}},{"line":2280,"address":[],"length":0,"stats":{"Line":0}},{"line":2284,"address":[],"length":0,"stats":{"Line":0}},{"line":2285,"address":[],"length":0,"stats":{"Line":0}},{"line":2286,"address":[],"length":0,"stats":{"Line":0}},{"line":2287,"address":[],"length":0,"stats":{"Line":0}},{"line":2288,"address":[],"length":0,"stats":{"Line":0}},{"line":2290,"address":[],"length":0,"stats":{"Line":0}},{"line":2379,"address":[],"length":0,"stats":{"Line":0}},{"line":2381,"address":[],"length":0,"stats":{"Line":0}},{"line":2389,"address":[],"length":0,"stats":{"Line":0}},{"line":2399,"address":[],"length":0,"stats":{"Line":0}},{"line":2412,"address":[],"length":0,"stats":{"Line":0}},{"line":2457,"address":[],"length":0,"stats":{"Line":0}},{"line":2460,"address":[],"length":0,"stats":{"Line":0}},{"line":2461,"address":[],"length":0,"stats":{"Line":0}},{"line":2464,"address":[],"length":0,"stats":{"Line":0}},{"line":2465,"address":[],"length":0,"stats":{"Line":0}},{"line":2468,"address":[],"length":0,"stats":{"Line":0}},{"line":2469,"address":[],"length":0,"stats":{"Line":0}},{"line":2472,"address":[],"length":0,"stats":{"Line":0}},{"line":2477,"address":[],"length":0,"stats":{"Line":0}},{"line":2480,"address":[],"length":0,"stats":{"Line":0}},{"line":2483,"address":[],"length":0,"stats":{"Line":0}},{"line":2484,"address":[],"length":0,"stats":{"Line":0}},{"line":2487,"address":[],"length":0,"stats":{"Line":0}},{"line":2489,"address":[],"length":0,"stats":{"Line":0}},{"line":2491,"address":[],"length":0,"stats":{"Line":0}},{"line":2492,"address":[],"length":0,"stats":{"Line":0}},{"line":2494,"address":[],"length":0,"stats":{"Line":0}},{"line":2495,"address":[],"length":0,"stats":{"Line":0}},{"line":2496,"address":[],"length":0,"stats":{"Line":0}},{"line":2497,"address":[],"length":0,"stats":{"Line":0}},{"line":2498,"address":[],"length":0,"stats":{"Line":0}},{"line":2499,"address":[],"length":0,"stats":{"Line":0}},{"line":2502,"address":[],"length":0,"stats":{"Line":0}},{"line":2503,"address":[],"length":0,"stats":{"Line":0}},{"line":2505,"address":[],"length":0,"stats":{"Line":0}},{"line":2506,"address":[],"length":0,"stats":{"Line":0}},{"line":2507,"address":[],"length":0,"stats":{"Line":0}},{"line":2508,"address":[],"length":0,"stats":{"Line":0}},{"line":2510,"address":[],"length":0,"stats":{"Line":0}},{"line":2511,"address":[],"length":0,"stats":{"Line":0}},{"line":2512,"address":[],"length":0,"stats":{"Line":0}},{"line":2513,"address":[],"length":0,"stats":{"Line":0}},{"line":2515,"address":[],"length":0,"stats":{"Line":0}},{"line":2519,"address":[],"length":0,"stats":{"Line":0}},{"line":2522,"address":[],"length":0,"stats":{"Line":0}},{"line":2535,"address":[],"length":0,"stats":{"Line":0}},{"line":2536,"address":[],"length":0,"stats":{"Line":0}},{"line":2538,"address":[],"length":0,"stats":{"Line":0}},{"line":2539,"address":[],"length":0,"stats":{"Line":0}},{"line":2540,"address":[],"length":0,"stats":{"Line":0}},{"line":2542,"address":[],"length":0,"stats":{"Line":0}},{"line":2543,"address":[],"length":0,"stats":{"Line":0}},{"line":2544,"address":[],"length":0,"stats":{"Line":0}},{"line":2547,"address":[],"length":0,"stats":{"Line":0}},{"line":2548,"address":[],"length":0,"stats":{"Line":0}},{"line":2550,"address":[],"length":0,"stats":{"Line":0}},{"line":2552,"address":[],"length":0,"stats":{"Line":0}},{"line":2553,"address":[],"length":0,"stats":{"Line":0}},{"line":2555,"address":[],"length":0,"stats":{"Line":0}},{"line":2556,"address":[],"length":0,"stats":{"Line":0}},{"line":2557,"address":[],"length":0,"stats":{"Line":0}},{"line":2558,"address":[],"length":0,"stats":{"Line":0}},{"line":2559,"address":[],"length":0,"stats":{"Line":0}},{"line":2560,"address":[],"length":0,"stats":{"Line":0}},{"line":2561,"address":[],"length":0,"stats":{"Line":0}},{"line":2562,"address":[],"length":0,"stats":{"Line":0}},{"line":2563,"address":[],"length":0,"stats":{"Line":0}},{"line":2564,"address":[],"length":0,"stats":{"Line":0}},{"line":2566,"address":[],"length":0,"stats":{"Line":0}},{"line":2568,"address":[],"length":0,"stats":{"Line":0}},{"line":2570,"address":[],"length":0,"stats":{"Line":0}},{"line":2571,"address":[],"length":0,"stats":{"Line":0}},{"line":2572,"address":[],"length":0,"stats":{"Line":0}},{"line":2574,"address":[],"length":0,"stats":{"Line":0}},{"line":2575,"address":[],"length":0,"stats":{"Line":0}},{"line":2577,"address":[],"length":0,"stats":{"Line":0}},{"line":2579,"address":[],"length":0,"stats":{"Line":0}},{"line":2581,"address":[],"length":0,"stats":{"Line":0}},{"line":2583,"address":[],"length":0,"stats":{"Line":0}},{"line":2584,"address":[],"length":0,"stats":{"Line":0}},{"line":2585,"address":[],"length":0,"stats":{"Line":0}},{"line":2586,"address":[],"length":0,"stats":{"Line":0}},{"line":2587,"address":[],"length":0,"stats":{"Line":0}},{"line":2589,"address":[],"length":0,"stats":{"Line":0}},{"line":2591,"address":[],"length":0,"stats":{"Line":0}},{"line":2593,"address":[],"length":0,"stats":{"Line":0}},{"line":2594,"address":[],"length":0,"stats":{"Line":0}},{"line":2595,"address":[],"length":0,"stats":{"Line":0}},{"line":2597,"address":[],"length":0,"stats":{"Line":0}},{"line":2600,"address":[],"length":0,"stats":{"Line":0}},{"line":2601,"address":[],"length":0,"stats":{"Line":0}},{"line":2603,"address":[],"length":0,"stats":{"Line":0}},{"line":2605,"address":[],"length":0,"stats":{"Line":0}},{"line":2606,"address":[],"length":0,"stats":{"Line":0}},{"line":2607,"address":[],"length":0,"stats":{"Line":0}},{"line":2608,"address":[],"length":0,"stats":{"Line":0}},{"line":2609,"address":[],"length":0,"stats":{"Line":0}},{"line":2610,"address":[],"length":0,"stats":{"Line":0}},{"line":2611,"address":[],"length":0,"stats":{"Line":0}},{"line":2613,"address":[],"length":0,"stats":{"Line":0}},{"line":2615,"address":[],"length":0,"stats":{"Line":0}},{"line":2616,"address":[],"length":0,"stats":{"Line":0}},{"line":2617,"address":[],"length":0,"stats":{"Line":0}},{"line":2623,"address":[],"length":0,"stats":{"Line":0}},{"line":2626,"address":[],"length":0,"stats":{"Line":0}},{"line":2653,"address":[],"length":0,"stats":{"Line":0}},{"line":2665,"address":[],"length":0,"stats":{"Line":0}},{"line":2666,"address":[],"length":0,"stats":{"Line":0}},{"line":2668,"address":[],"length":0,"stats":{"Line":0}},{"line":2669,"address":[],"length":0,"stats":{"Line":0}},{"line":2670,"address":[],"length":0,"stats":{"Line":0}},{"line":2674,"address":[],"length":0,"stats":{"Line":0}},{"line":2675,"address":[],"length":0,"stats":{"Line":0}},{"line":2678,"address":[],"length":0,"stats":{"Line":0}},{"line":2680,"address":[],"length":0,"stats":{"Line":0}},{"line":2682,"address":[],"length":0,"stats":{"Line":0}},{"line":2683,"address":[],"length":0,"stats":{"Line":0}},{"line":2684,"address":[],"length":0,"stats":{"Line":0}},{"line":2685,"address":[],"length":0,"stats":{"Line":0}},{"line":2686,"address":[],"length":0,"stats":{"Line":0}},{"line":2687,"address":[],"length":0,"stats":{"Line":0}},{"line":2688,"address":[],"length":0,"stats":{"Line":0}},{"line":2689,"address":[],"length":0,"stats":{"Line":0}},{"line":2690,"address":[],"length":0,"stats":{"Line":0}},{"line":2691,"address":[],"length":0,"stats":{"Line":0}},{"line":2693,"address":[],"length":0,"stats":{"Line":0}},{"line":2694,"address":[],"length":0,"stats":{"Line":0}},{"line":2695,"address":[],"length":0,"stats":{"Line":0}},{"line":2696,"address":[],"length":0,"stats":{"Line":0}},{"line":2697,"address":[],"length":0,"stats":{"Line":0}},{"line":2703,"address":[],"length":0,"stats":{"Line":0}},{"line":2705,"address":[],"length":0,"stats":{"Line":0}},{"line":2706,"address":[],"length":0,"stats":{"Line":0}},{"line":2707,"address":[],"length":0,"stats":{"Line":0}},{"line":2708,"address":[],"length":0,"stats":{"Line":0}},{"line":2709,"address":[],"length":0,"stats":{"Line":0}},{"line":2710,"address":[],"length":0,"stats":{"Line":0}},{"line":2711,"address":[],"length":0,"stats":{"Line":0}},{"line":2712,"address":[],"length":0,"stats":{"Line":0}},{"line":2713,"address":[],"length":0,"stats":{"Line":0}},{"line":2714,"address":[],"length":0,"stats":{"Line":0}},{"line":2716,"address":[],"length":0,"stats":{"Line":0}},{"line":2718,"address":[],"length":0,"stats":{"Line":0}},{"line":2720,"address":[],"length":0,"stats":{"Line":0}},{"line":2721,"address":[],"length":0,"stats":{"Line":0}},{"line":2723,"address":[],"length":0,"stats":{"Line":0}},{"line":2724,"address":[],"length":0,"stats":{"Line":0}},{"line":2725,"address":[],"length":0,"stats":{"Line":0}},{"line":2727,"address":[],"length":0,"stats":{"Line":0}},{"line":2729,"address":[],"length":0,"stats":{"Line":0}},{"line":2731,"address":[],"length":0,"stats":{"Line":0}},{"line":2733,"address":[],"length":0,"stats":{"Line":0}},{"line":2735,"address":[],"length":0,"stats":{"Line":0}},{"line":2736,"address":[],"length":0,"stats":{"Line":0}},{"line":2737,"address":[],"length":0,"stats":{"Line":0}},{"line":2739,"address":[],"length":0,"stats":{"Line":0}},{"line":2741,"address":[],"length":0,"stats":{"Line":0}},{"line":2743,"address":[],"length":0,"stats":{"Line":0}},{"line":2744,"address":[],"length":0,"stats":{"Line":0}},{"line":2745,"address":[],"length":0,"stats":{"Line":0}},{"line":2747,"address":[],"length":0,"stats":{"Line":0}},{"line":2749,"address":[],"length":0,"stats":{"Line":0}},{"line":2751,"address":[],"length":0,"stats":{"Line":0}},{"line":2753,"address":[],"length":0,"stats":{"Line":0}},{"line":2755,"address":[],"length":0,"stats":{"Line":0}},{"line":2757,"address":[],"length":0,"stats":{"Line":0}},{"line":2759,"address":[],"length":0,"stats":{"Line":0}},{"line":2760,"address":[],"length":0,"stats":{"Line":0}},{"line":2761,"address":[],"length":0,"stats":{"Line":0}},{"line":2764,"address":[],"length":0,"stats":{"Line":0}},{"line":2765,"address":[],"length":0,"stats":{"Line":0}},{"line":2766,"address":[],"length":0,"stats":{"Line":0}},{"line":2769,"address":[],"length":0,"stats":{"Line":0}},{"line":2771,"address":[],"length":0,"stats":{"Line":0}},{"line":2773,"address":[],"length":0,"stats":{"Line":0}},{"line":2775,"address":[],"length":0,"stats":{"Line":0}},{"line":2776,"address":[],"length":0,"stats":{"Line":0}},{"line":2777,"address":[],"length":0,"stats":{"Line":0}},{"line":2778,"address":[],"length":0,"stats":{"Line":0}},{"line":2779,"address":[],"length":0,"stats":{"Line":0}},{"line":2780,"address":[],"length":0,"stats":{"Line":0}},{"line":2781,"address":[],"length":0,"stats":{"Line":0}},{"line":2782,"address":[],"length":0,"stats":{"Line":0}},{"line":2785,"address":[],"length":0,"stats":{"Line":0}},{"line":2786,"address":[],"length":0,"stats":{"Line":0}},{"line":2787,"address":[],"length":0,"stats":{"Line":0}},{"line":2788,"address":[],"length":0,"stats":{"Line":0}},{"line":2789,"address":[],"length":0,"stats":{"Line":0}},{"line":2790,"address":[],"length":0,"stats":{"Line":0}},{"line":2791,"address":[],"length":0,"stats":{"Line":0}},{"line":2792,"address":[],"length":0,"stats":{"Line":0}},{"line":2793,"address":[],"length":0,"stats":{"Line":0}},{"line":2794,"address":[],"length":0,"stats":{"Line":0}},{"line":2795,"address":[],"length":0,"stats":{"Line":0}},{"line":2796,"address":[],"length":0,"stats":{"Line":0}},{"line":2797,"address":[],"length":0,"stats":{"Line":0}},{"line":2799,"address":[],"length":0,"stats":{"Line":0}},{"line":2802,"address":[],"length":0,"stats":{"Line":0}},{"line":2803,"address":[],"length":0,"stats":{"Line":0}},{"line":2805,"address":[],"length":0,"stats":{"Line":0}},{"line":2807,"address":[],"length":0,"stats":{"Line":0}},{"line":2808,"address":[],"length":0,"stats":{"Line":0}},{"line":2810,"address":[],"length":0,"stats":{"Line":0}},{"line":2812,"address":[],"length":0,"stats":{"Line":0}},{"line":2813,"address":[],"length":0,"stats":{"Line":0}},{"line":2814,"address":[],"length":0,"stats":{"Line":0}},{"line":2817,"address":[],"length":0,"stats":{"Line":0}},{"line":2818,"address":[],"length":0,"stats":{"Line":0}},{"line":2821,"address":[],"length":0,"stats":{"Line":0}},{"line":2822,"address":[],"length":0,"stats":{"Line":0}},{"line":2823,"address":[],"length":0,"stats":{"Line":0}},{"line":2824,"address":[],"length":0,"stats":{"Line":0}},{"line":2825,"address":[],"length":0,"stats":{"Line":0}},{"line":2827,"address":[],"length":0,"stats":{"Line":0}},{"line":2828,"address":[],"length":0,"stats":{"Line":0}},{"line":2829,"address":[],"length":0,"stats":{"Line":0}},{"line":2830,"address":[],"length":0,"stats":{"Line":0}},{"line":2831,"address":[],"length":0,"stats":{"Line":0}},{"line":2832,"address":[],"length":0,"stats":{"Line":0}},{"line":2835,"address":[],"length":0,"stats":{"Line":0}},{"line":2836,"address":[],"length":0,"stats":{"Line":0}},{"line":2837,"address":[],"length":0,"stats":{"Line":0}},{"line":2838,"address":[],"length":0,"stats":{"Line":0}},{"line":2841,"address":[],"length":0,"stats":{"Line":0}},{"line":2842,"address":[],"length":0,"stats":{"Line":0}},{"line":2845,"address":[],"length":0,"stats":{"Line":0}},{"line":2846,"address":[],"length":0,"stats":{"Line":0}},{"line":2848,"address":[],"length":0,"stats":{"Line":0}},{"line":2849,"address":[],"length":0,"stats":{"Line":0}},{"line":2850,"address":[],"length":0,"stats":{"Line":0}},{"line":2852,"address":[],"length":0,"stats":{"Line":0}},{"line":2854,"address":[],"length":0,"stats":{"Line":0}},{"line":2856,"address":[],"length":0,"stats":{"Line":0}},{"line":2857,"address":[],"length":0,"stats":{"Line":0}},{"line":2858,"address":[],"length":0,"stats":{"Line":0}},{"line":2859,"address":[],"length":0,"stats":{"Line":0}},{"line":2860,"address":[],"length":0,"stats":{"Line":0}},{"line":2862,"address":[],"length":0,"stats":{"Line":0}},{"line":2866,"address":[],"length":0,"stats":{"Line":0}},{"line":2867,"address":[],"length":0,"stats":{"Line":0}},{"line":2868,"address":[],"length":0,"stats":{"Line":0}},{"line":2869,"address":[],"length":0,"stats":{"Line":0}},{"line":2873,"address":[],"length":0,"stats":{"Line":0}},{"line":2876,"address":[],"length":0,"stats":{"Line":0}},{"line":2877,"address":[],"length":0,"stats":{"Line":0}},{"line":2878,"address":[],"length":0,"stats":{"Line":0}},{"line":2880,"address":[],"length":0,"stats":{"Line":0}},{"line":2881,"address":[],"length":0,"stats":{"Line":0}},{"line":2882,"address":[],"length":0,"stats":{"Line":0}},{"line":2883,"address":[],"length":0,"stats":{"Line":0}},{"line":2884,"address":[],"length":0,"stats":{"Line":0}},{"line":2885,"address":[],"length":0,"stats":{"Line":0}},{"line":2886,"address":[],"length":0,"stats":{"Line":0}},{"line":2890,"address":[],"length":0,"stats":{"Line":14}},{"line":2891,"address":[],"length":0,"stats":{"Line":42}},{"line":2892,"address":[],"length":0,"stats":{"Line":42}},{"line":2893,"address":[],"length":0,"stats":{"Line":42}},{"line":2894,"address":[],"length":0,"stats":{"Line":42}},{"line":2895,"address":[],"length":0,"stats":{"Line":124}},{"line":2896,"address":[],"length":0,"stats":{"Line":103}},{"line":2897,"address":[],"length":0,"stats":{"Line":8}},{"line":2899,"address":[],"length":0,"stats":{"Line":123}},{"line":2901,"address":[],"length":0,"stats":{"Line":14}},{"line":2904,"address":[],"length":0,"stats":{"Line":1}},{"line":2918,"address":[],"length":0,"stats":{"Line":3}},{"line":2919,"address":[],"length":0,"stats":{"Line":1}},{"line":2920,"address":[],"length":0,"stats":{"Line":1}},{"line":2921,"address":[],"length":0,"stats":{"Line":1}},{"line":2922,"address":[],"length":0,"stats":{"Line":1}},{"line":2925,"address":[],"length":0,"stats":{"Line":0}},{"line":2926,"address":[],"length":0,"stats":{"Line":0}},{"line":2927,"address":[],"length":0,"stats":{"Line":0}},{"line":2928,"address":[],"length":0,"stats":{"Line":0}},{"line":2929,"address":[],"length":0,"stats":{"Line":0}},{"line":2931,"address":[],"length":0,"stats":{"Line":0}},{"line":2934,"address":[],"length":0,"stats":{"Line":0}},{"line":2935,"address":[],"length":0,"stats":{"Line":0}},{"line":2936,"address":[],"length":0,"stats":{"Line":0}},{"line":2939,"address":[],"length":0,"stats":{"Line":0}},{"line":2940,"address":[],"length":0,"stats":{"Line":0}},{"line":2941,"address":[],"length":0,"stats":{"Line":0}},{"line":2943,"address":[],"length":0,"stats":{"Line":0}},{"line":2944,"address":[],"length":0,"stats":{"Line":0}},{"line":2946,"address":[],"length":0,"stats":{"Line":0}},{"line":2947,"address":[],"length":0,"stats":{"Line":0}},{"line":2948,"address":[],"length":0,"stats":{"Line":0}},{"line":2950,"address":[],"length":0,"stats":{"Line":0}},{"line":2953,"address":[],"length":0,"stats":{"Line":0}},{"line":2954,"address":[],"length":0,"stats":{"Line":0}},{"line":2955,"address":[],"length":0,"stats":{"Line":0}},{"line":2957,"address":[],"length":0,"stats":{"Line":0}},{"line":2958,"address":[],"length":0,"stats":{"Line":0}},{"line":2959,"address":[],"length":0,"stats":{"Line":0}},{"line":2965,"address":[],"length":0,"stats":{"Line":0}},{"line":2970,"address":[],"length":0,"stats":{"Line":0}},{"line":2973,"address":[],"length":0,"stats":{"Line":0}},{"line":2974,"address":[],"length":0,"stats":{"Line":0}},{"line":2977,"address":[],"length":0,"stats":{"Line":0}},{"line":2978,"address":[],"length":0,"stats":{"Line":0}},{"line":2979,"address":[],"length":0,"stats":{"Line":0}},{"line":2980,"address":[],"length":0,"stats":{"Line":0}},{"line":2982,"address":[],"length":0,"stats":{"Line":0}},{"line":2984,"address":[],"length":0,"stats":{"Line":0}},{"line":2986,"address":[],"length":0,"stats":{"Line":0}},{"line":2987,"address":[],"length":0,"stats":{"Line":0}},{"line":2988,"address":[],"length":0,"stats":{"Line":0}},{"line":2989,"address":[],"length":0,"stats":{"Line":0}},{"line":2990,"address":[],"length":0,"stats":{"Line":0}},{"line":2992,"address":[],"length":0,"stats":{"Line":0}},{"line":2994,"address":[],"length":0,"stats":{"Line":0}},{"line":2995,"address":[],"length":0,"stats":{"Line":0}},{"line":2997,"address":[],"length":0,"stats":{"Line":0}},{"line":2999,"address":[],"length":0,"stats":{"Line":0}},{"line":3000,"address":[],"length":0,"stats":{"Line":0}},{"line":3002,"address":[],"length":0,"stats":{"Line":0}},{"line":3003,"address":[],"length":0,"stats":{"Line":0}},{"line":3004,"address":[],"length":0,"stats":{"Line":0}},{"line":3006,"address":[],"length":0,"stats":{"Line":0}},{"line":3007,"address":[],"length":0,"stats":{"Line":0}},{"line":3008,"address":[],"length":0,"stats":{"Line":0}},{"line":3009,"address":[],"length":0,"stats":{"Line":0}},{"line":3012,"address":[],"length":0,"stats":{"Line":0}},{"line":3013,"address":[],"length":0,"stats":{"Line":0}},{"line":3014,"address":[],"length":0,"stats":{"Line":0}},{"line":3015,"address":[],"length":0,"stats":{"Line":0}},{"line":3026,"address":[],"length":0,"stats":{"Line":0}},{"line":3027,"address":[],"length":0,"stats":{"Line":0}},{"line":3029,"address":[],"length":0,"stats":{"Line":0}},{"line":3030,"address":[],"length":0,"stats":{"Line":0}},{"line":3031,"address":[],"length":0,"stats":{"Line":0}},{"line":3032,"address":[],"length":0,"stats":{"Line":0}},{"line":3033,"address":[],"length":0,"stats":{"Line":0}},{"line":3034,"address":[],"length":0,"stats":{"Line":0}},{"line":3036,"address":[],"length":0,"stats":{"Line":0}},{"line":3037,"address":[],"length":0,"stats":{"Line":0}},{"line":3038,"address":[],"length":0,"stats":{"Line":0}},{"line":3040,"address":[],"length":0,"stats":{"Line":0}},{"line":3041,"address":[],"length":0,"stats":{"Line":0}},{"line":3042,"address":[],"length":0,"stats":{"Line":0}},{"line":3048,"address":[],"length":0,"stats":{"Line":0}},{"line":3050,"address":[],"length":0,"stats":{"Line":0}},{"line":3052,"address":[],"length":0,"stats":{"Line":0}},{"line":3053,"address":[],"length":0,"stats":{"Line":0}},{"line":3055,"address":[],"length":0,"stats":{"Line":0}},{"line":3056,"address":[],"length":0,"stats":{"Line":0}},{"line":3058,"address":[],"length":0,"stats":{"Line":0}},{"line":3060,"address":[],"length":0,"stats":{"Line":0}},{"line":3061,"address":[],"length":0,"stats":{"Line":0}},{"line":3062,"address":[],"length":0,"stats":{"Line":0}},{"line":3065,"address":[],"length":0,"stats":{"Line":0}},{"line":3067,"address":[],"length":0,"stats":{"Line":0}},{"line":3069,"address":[],"length":0,"stats":{"Line":0}},{"line":3071,"address":[],"length":0,"stats":{"Line":0}},{"line":3073,"address":[],"length":0,"stats":{"Line":0}},{"line":3074,"address":[],"length":0,"stats":{"Line":0}},{"line":3077,"address":[],"length":0,"stats":{"Line":0}}],"covered":262,"coverable":1506},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","app.rs"],"content":"use std::collections::HashSet;\nuse std::time::{Duration, Instant};\n\nuse anyhow::Result;\nuse crossterm::event::{KeyCode, KeyEvent, KeyModifiers, MouseButton, MouseEvent, MouseEventKind};\nuse ratatui::layout::Rect;\n\nuse super::data::{DailyUsage, DataLoader, ModelUsage, Source, UsageData};\nuse super::settings::Settings;\nuse super::themes::{Theme, ThemeName};\n\n/// Configuration for TUI initialization\npub struct TuiConfig {\n    pub theme: String,\n    pub refresh: u64,\n    pub sessions_path: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n    pub initial_tab: Option\u003cTab\u003e,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum Tab {\n    Overview,\n    Models,\n    Daily,\n    Stats,\n}\n\nimpl Tab {\n    pub fn all() -\u003e \u0026'static [Tab] {\n        \u0026[Tab::Overview, Tab::Models, Tab::Daily, Tab::Stats]\n    }\n\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Tab::Overview =\u003e \"Overview\",\n            Tab::Models =\u003e \"Models\",\n            Tab::Daily =\u003e \"Daily\",\n            Tab::Stats =\u003e \"Stats\",\n        }\n    }\n\n    pub fn short_name(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Tab::Overview =\u003e \"Ovw\",\n            Tab::Models =\u003e \"Mod\",\n            Tab::Daily =\u003e \"Day\",\n            Tab::Stats =\u003e \"Sta\",\n        }\n    }\n\n    pub fn next(self) -\u003e Tab {\n        match self {\n            Tab::Overview =\u003e Tab::Models,\n            Tab::Models =\u003e Tab::Daily,\n            Tab::Daily =\u003e Tab::Stats,\n            Tab::Stats =\u003e Tab::Overview,\n        }\n    }\n\n    pub fn prev(self) -\u003e Tab {\n        match self {\n            Tab::Overview =\u003e Tab::Stats,\n            Tab::Models =\u003e Tab::Overview,\n            Tab::Daily =\u003e Tab::Models,\n            Tab::Stats =\u003e Tab::Daily,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum SortField {\n    Cost,\n    Tokens,\n    Date,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum SortDirection {\n    Ascending,\n    Descending,\n}\n\npub struct ClickArea {\n    pub rect: Rect,\n    pub action: ClickAction,\n}\n\n#[derive(Debug, Clone)]\npub enum ClickAction {\n    Tab(Tab),\n    Source(Source),\n    Sort(SortField),\n    GraphCell { week: usize, day: usize },\n}\n\npub struct App {\n    pub should_quit: bool,\n    pub current_tab: Tab,\n    pub theme: Theme,\n    pub settings: Settings,\n    pub data: UsageData,\n    pub data_loader: DataLoader,\n\n    pub enabled_sources: HashSet\u003cSource\u003e,\n    pub sort_field: SortField,\n    pub sort_direction: SortDirection,\n\n    pub scroll_offset: usize,\n    pub selected_index: usize,\n    pub max_visible_items: usize,\n\n    pub selected_graph_cell: Option\u003c(usize, usize)\u003e,\n\n    pub auto_refresh: bool,\n    pub auto_refresh_interval: Duration,\n    pub last_refresh: Instant,\n\n    pub status_message: Option\u003cString\u003e,\n    pub status_message_time: Option\u003cInstant\u003e,\n\n    pub terminal_width: u16,\n    pub terminal_height: u16,\n\n    pub click_areas: Vec\u003cClickArea\u003e,\n\n    pub spinner_frame: usize,\n\n    pub background_loading: bool,\n}\n\nimpl App {\n    pub fn new_with_cached_data(config: TuiConfig, cached_data: Option\u003cUsageData\u003e) -\u003e Result\u003cSelf\u003e {\n        let settings = Settings::load();\n        let theme_name: ThemeName = config\n            .theme\n            .parse()\n            .unwrap_or_else(|_| settings.theme_name());\n        let theme = Theme::from_name(theme_name);\n\n        let mut enabled_sources = HashSet::new();\n\n        if let Some(ref cli_sources) = config.sources {\n            for source_str in cli_sources {\n                match source_str.as_str() {\n                    \"opencode\" =\u003e enabled_sources.insert(Source::OpenCode),\n                    \"claude\" =\u003e enabled_sources.insert(Source::Claude),\n                    \"codex\" =\u003e enabled_sources.insert(Source::Codex),\n                    \"cursor\" =\u003e enabled_sources.insert(Source::Cursor),\n                    \"gemini\" =\u003e enabled_sources.insert(Source::Gemini),\n                    \"amp\" =\u003e enabled_sources.insert(Source::Amp),\n                    \"droid\" =\u003e enabled_sources.insert(Source::Droid),\n                    \"openclaw\" =\u003e enabled_sources.insert(Source::OpenClaw),\n                    \"pi\" =\u003e enabled_sources.insert(Source::Pi),\n                    _ =\u003e false,\n                };\n            }\n        } else {\n            for source in Source::all() {\n                enabled_sources.insert(*source);\n            }\n        }\n\n        let auto_refresh_interval = if config.refresh \u003e 0 {\n            Duration::from_secs(config.refresh)\n        } else if let Some(interval) = settings.get_auto_refresh_interval() {\n            interval\n        } else {\n            Duration::from_secs(30)\n        };\n\n        let auto_refresh = config.refresh \u003e 0 || settings.auto_refresh_enabled;\n\n        let data_loader = DataLoader::with_filters(\n            config.sessions_path.map(std::path::PathBuf::from),\n            config.since,\n            config.until,\n            config.year,\n        );\n\n        let data = cached_data.unwrap_or_default();\n        let has_data = !data.models.is_empty();\n\n        Ok(Self {\n            should_quit: false,\n            current_tab: config.initial_tab.unwrap_or(Tab::Overview),\n            theme,\n            settings,\n            data,\n            data_loader,\n            enabled_sources,\n            sort_field: SortField::Cost,\n            sort_direction: SortDirection::Descending,\n            scroll_offset: 0,\n            selected_index: 0,\n            max_visible_items: 20,\n            selected_graph_cell: None,\n            auto_refresh,\n            auto_refresh_interval,\n            last_refresh: Instant::now(),\n            status_message: if has_data {\n                Some(\"Loaded from cache\".to_string())\n            } else {\n                None\n            },\n            status_message_time: if has_data { Some(Instant::now()) } else { None },\n            terminal_width: 80,\n            terminal_height: 24,\n            click_areas: Vec::new(),\n            spinner_frame: 0,\n            background_loading: false,\n        })\n    }\n\n    pub fn load_data(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.data.loading = true;\n        let sources: Vec\u003cSource\u003e = self.enabled_sources.iter().copied().collect();\n        match self.data_loader.load(\u0026sources) {\n            Ok(data) =\u003e {\n                self.data = data;\n                self.last_refresh = Instant::now();\n                self.clamp_selection();\n                self.set_status(\"Data loaded\");\n            }\n            Err(e) =\u003e {\n                self.data.loading = false;\n                self.data.error = Some(e.to_string());\n                self.set_status(\u0026format!(\"Error: {}\", e));\n            }\n        }\n        Ok(())\n    }\n\n    pub fn set_background_loading(\u0026mut self, loading: bool) {\n        self.background_loading = loading;\n        // Don't set data.loading - let cached data remain visible during background refresh\n    }\n\n    pub fn update_data(\u0026mut self, data: UsageData) {\n        self.data = data;\n        self.last_refresh = Instant::now();\n        self.clamp_selection();\n    }\n\n    pub fn set_error(\u0026mut self, error: Option\u003cString\u003e) {\n        self.data.error = error;\n    }\n\n    pub fn on_tick(\u0026mut self) {\n        self.spinner_frame = (self.spinner_frame + 1) % 20;\n\n        if let Some(status_time) = self.status_message_time {\n            if status_time.elapsed() \u003e Duration::from_secs(3) {\n                self.status_message = None;\n                self.status_message_time = None;\n            }\n        }\n\n        if self.auto_refresh \u0026\u0026 self.last_refresh.elapsed() \u003e= self.auto_refresh_interval {\n            let _ = self.load_data();\n        }\n    }\n\n    pub fn handle_key_event(\u0026mut self, key: KeyEvent) -\u003e bool {\n        if key.code == KeyCode::Char('c') \u0026\u0026 key.modifiers.contains(KeyModifiers::CONTROL) {\n            self.should_quit = true;\n            return true;\n        }\n\n        match key.code {\n            KeyCode::Char('q') =\u003e {\n                self.should_quit = true;\n                return true;\n            }\n            KeyCode::Tab =\u003e {\n                self.current_tab = self.current_tab.next();\n                self.reset_selection();\n            }\n            KeyCode::BackTab =\u003e {\n                self.current_tab = self.current_tab.prev();\n                self.reset_selection();\n            }\n            KeyCode::Left =\u003e {\n                self.current_tab = self.current_tab.prev();\n                self.reset_selection();\n            }\n            KeyCode::Right =\u003e {\n                self.current_tab = self.current_tab.next();\n                self.reset_selection();\n            }\n            KeyCode::Up =\u003e {\n                self.move_selection_up();\n            }\n            KeyCode::Down =\u003e {\n                self.move_selection_down();\n            }\n            KeyCode::Char('c') =\u003e {\n                self.set_sort(SortField::Cost);\n            }\n            KeyCode::Char('t') =\u003e {\n                self.set_sort(SortField::Tokens);\n            }\n            KeyCode::Char('d') =\u003e {\n                self.set_sort(SortField::Date);\n            }\n            KeyCode::Char('p') =\u003e {\n                self.cycle_theme();\n            }\n            KeyCode::Char('r') =\u003e {\n                let _ = self.load_data();\n            }\n            KeyCode::Char('R') if key.modifiers.contains(KeyModifiers::SHIFT) =\u003e {\n                self.toggle_auto_refresh();\n            }\n            KeyCode::Char('+') | KeyCode::Char('=') =\u003e {\n                self.increase_refresh_interval();\n            }\n            KeyCode::Char('-') =\u003e {\n                self.decrease_refresh_interval();\n            }\n            KeyCode::Char('y') =\u003e {\n                self.copy_selected_to_clipboard();\n            }\n            KeyCode::Char('e') =\u003e {\n                self.export_to_json();\n            }\n            KeyCode::Char(c @ '1'..='9') =\u003e {\n                self.toggle_source(c);\n            }\n            KeyCode::Enter =\u003e {\n                if self.current_tab == Tab::Stats {\n                    self.handle_graph_selection();\n                }\n            }\n            KeyCode::Esc =\u003e {\n                self.selected_graph_cell = None;\n            }\n            _ =\u003e {}\n        }\n        false\n    }\n\n    pub fn handle_mouse_event(\u0026mut self, event: MouseEvent) {\n        if let MouseEventKind::Down(MouseButton::Left) = event.kind {\n            let x = event.column;\n            let y = event.row;\n\n            for area in \u0026self.click_areas {\n                if x \u003e= area.rect.x\n                    \u0026\u0026 x \u003c area.rect.x + area.rect.width\n                    \u0026\u0026 y \u003e= area.rect.y\n                    \u0026\u0026 y \u003c area.rect.y + area.rect.height\n                {\n                    match \u0026area.action {\n                        ClickAction::Tab(tab) =\u003e {\n                            self.current_tab = *tab;\n                            self.reset_selection();\n                        }\n                        ClickAction::Source(source) =\u003e {\n                            self.toggle_source(source.key());\n                        }\n                        ClickAction::Sort(field) =\u003e {\n                            self.set_sort(*field);\n                        }\n                        ClickAction::GraphCell { week, day } =\u003e {\n                            self.selected_graph_cell = Some((*week, *day));\n                        }\n                    }\n                    break;\n                }\n            }\n        }\n    }\n\n    pub fn handle_resize(\u0026mut self, width: u16, height: u16) {\n        self.terminal_width = width;\n        self.terminal_height = height;\n        // Ensure at least 1 visible item to prevent division/slice issues\n        self.max_visible_items = (height.saturating_sub(10) as usize).max(1);\n        self.clamp_selection();\n    }\n\n    /// Clamp selection and scroll offset to valid bounds after data/resize changes\n    fn clamp_selection(\u0026mut self) {\n        let len = self.get_current_list_len();\n        if len == 0 {\n            self.selected_index = 0;\n            self.scroll_offset = 0;\n            return;\n        }\n        self.selected_index = self.selected_index.min(len.saturating_sub(1));\n        let max_scroll = len.saturating_sub(self.max_visible_items);\n        self.scroll_offset = self.scroll_offset.min(max_scroll);\n    }\n\n    pub fn clear_click_areas(\u0026mut self) {\n        self.click_areas.clear();\n    }\n\n    pub fn add_click_area(\u0026mut self, rect: Rect, action: ClickAction) {\n        self.click_areas.push(ClickArea { rect, action });\n    }\n\n    fn reset_selection(\u0026mut self) {\n        self.scroll_offset = 0;\n        self.selected_index = 0;\n        self.selected_graph_cell = None;\n    }\n\n    fn move_selection_up(\u0026mut self) {\n        if self.selected_index \u003e 0 {\n            self.selected_index -= 1;\n            if self.selected_index \u003c self.scroll_offset {\n                self.scroll_offset = self.selected_index;\n            }\n        }\n    }\n\n    fn move_selection_down(\u0026mut self) {\n        let max_index = self.get_current_list_len().saturating_sub(1);\n        if self.selected_index \u003c max_index {\n            self.selected_index += 1;\n            if self.selected_index \u003e= self.scroll_offset + self.max_visible_items {\n                self.scroll_offset = self.selected_index - self.max_visible_items + 1;\n            }\n        }\n    }\n\n    fn get_current_list_len(\u0026self) -\u003e usize {\n        match self.current_tab {\n            Tab::Overview | Tab::Models =\u003e self.data.models.len(),\n            Tab::Daily =\u003e self.data.daily.len(),\n            Tab::Stats =\u003e 0,\n        }\n    }\n\n    fn set_sort(\u0026mut self, field: SortField) {\n        if self.sort_field == field {\n            self.sort_direction = match self.sort_direction {\n                SortDirection::Ascending =\u003e SortDirection::Descending,\n                SortDirection::Descending =\u003e SortDirection::Ascending,\n            };\n        } else {\n            self.sort_field = field;\n            self.sort_direction = SortDirection::Descending;\n        }\n        self.reset_selection();\n        self.set_status(\u0026format!(\n            \"Sorted by {:?} {:?}\",\n            self.sort_field, self.sort_direction\n        ));\n    }\n\n    fn cycle_theme(\u0026mut self) {\n        let new_theme = self.theme.name.next();\n        self.theme = Theme::from_name(new_theme);\n        self.settings.set_theme(new_theme);\n        if let Err(e) = self.settings.save() {\n            self.set_status(\u0026format!(\n                \"Theme: {} (save failed: {})\",\n                new_theme.as_str(),\n                e\n            ));\n        } else {\n            self.set_status(\u0026format!(\"Theme: {}\", new_theme.as_str()));\n        }\n    }\n\n    fn toggle_source(\u0026mut self, key: char) {\n        if let Some(source) = Source::from_key(key) {\n            if self.enabled_sources.contains(\u0026source) {\n                if self.enabled_sources.len() \u003e 1 {\n                    self.enabled_sources.remove(\u0026source);\n                    self.set_status(\u0026format!(\"Disabled {}\", source.as_str()));\n                }\n            } else {\n                self.enabled_sources.insert(source);\n                self.set_status(\u0026format!(\"Enabled {}\", source.as_str()));\n            }\n            let _ = self.load_data();\n        }\n    }\n\n    fn toggle_auto_refresh(\u0026mut self) {\n        self.auto_refresh = !self.auto_refresh;\n        self.settings.auto_refresh_enabled = self.auto_refresh;\n        let save_result = self.settings.save();\n        let msg = if self.auto_refresh {\n            format!(\n                \"Auto-refresh ON ({}s)\",\n                self.auto_refresh_interval.as_secs()\n            )\n        } else {\n            \"Auto-refresh OFF\".to_string()\n        };\n        if let Err(e) = save_result {\n            self.set_status(\u0026format!(\"{} (save failed: {})\", msg, e));\n        } else {\n            self.set_status(\u0026msg);\n        }\n    }\n\n    fn increase_refresh_interval(\u0026mut self) {\n        let ms = self.auto_refresh_interval.as_millis() as u64;\n        let new_ms = ms.saturating_add(10_000).min(300_000);\n        self.auto_refresh_interval = Duration::from_millis(new_ms);\n        self.settings.auto_refresh_ms = new_ms;\n        let save_result = self.settings.save();\n        let msg = format!(\"Refresh interval: {}s\", new_ms / 1000);\n        if let Err(e) = save_result {\n            self.set_status(\u0026format!(\"{} (save failed: {})\", msg, e));\n        } else {\n            self.set_status(\u0026msg);\n        }\n    }\n\n    fn decrease_refresh_interval(\u0026mut self) {\n        let ms = self.auto_refresh_interval.as_millis() as u64;\n        let new_ms = ms.saturating_sub(10_000).max(30_000);\n        self.auto_refresh_interval = Duration::from_millis(new_ms);\n        self.settings.auto_refresh_ms = new_ms;\n        let save_result = self.settings.save();\n        let msg = format!(\"Refresh interval: {}s\", new_ms / 1000);\n        if let Err(e) = save_result {\n            self.set_status(\u0026format!(\"{} (save failed: {})\", msg, e));\n        } else {\n            self.set_status(\u0026msg);\n        }\n    }\n\n    fn copy_selected_to_clipboard(\u0026mut self) {\n        let text = match self.current_tab {\n            Tab::Overview | Tab::Models =\u003e self\n                .get_sorted_models()\n                .get(self.selected_index)\n                .map(|m| format!(\"{}: {} tokens, ${:.4}\", m.model, m.tokens.total(), m.cost)),\n            Tab::Daily =\u003e self\n                .get_sorted_daily()\n                .get(self.selected_index)\n                .map(|d| format!(\"{}: {} tokens, ${:.4}\", d.date, d.tokens.total(), d.cost)),\n            Tab::Stats =\u003e None,\n        };\n\n        if let Some(text) = text {\n            match arboard::Clipboard::new().and_then(|mut cb| cb.set_text(\u0026text)) {\n                Ok(_) =\u003e self.set_status(\"Copied to clipboard\"),\n                Err(_) =\u003e self.set_status(\"Failed to copy\"),\n            }\n        }\n    }\n\n    fn export_to_json(\u0026mut self) {\n        let export_data = serde_json::json!({\n            \"models\": self.data.models.iter().map(|m| serde_json::json!({\n                \"model\": m.model,\n                \"provider\": m.provider,\n                \"source\": m.source,\n                \"tokens\": {\n                    \"input\": m.tokens.input,\n                    \"output\": m.tokens.output,\n                    \"cacheRead\": m.tokens.cache_read,\n                    \"cacheWrite\": m.tokens.cache_write,\n                    \"total\": m.tokens.total()\n                },\n                \"cost\": m.cost,\n                \"sessionCount\": m.session_count\n            })).collect::\u003cVec\u003c_\u003e\u003e(),\n            \"daily\": self.data.daily.iter().map(|d| serde_json::json!({\n                \"date\": d.date.to_string(),\n                \"tokens\": {\n                    \"input\": d.tokens.input,\n                    \"output\": d.tokens.output,\n                    \"cacheRead\": d.tokens.cache_read,\n                    \"cacheWrite\": d.tokens.cache_write,\n                    \"total\": d.tokens.total()\n                },\n                \"cost\": d.cost\n            })).collect::\u003cVec\u003c_\u003e\u003e(),\n            \"totals\": {\n                \"tokens\": self.data.total_tokens,\n                \"cost\": self.data.total_cost\n            }\n        });\n\n        let filename = format!(\n            \"tokscale-export-{}.json\",\n            chrono::Utc::now().format(\"%Y%m%d-%H%M%S\")\n        );\n\n        match serde_json::to_string_pretty(\u0026export_data) {\n            Ok(json) =\u003e match std::fs::write(\u0026filename, json) {\n                Ok(_) =\u003e self.set_status(\u0026format!(\"Exported to {}\", filename)),\n                Err(e) =\u003e self.set_status(\u0026format!(\"Export failed: {}\", e)),\n            },\n            Err(e) =\u003e self.set_status(\u0026format!(\"Export failed: {}\", e)),\n        }\n    }\n\n    fn handle_graph_selection(\u0026mut self) {\n        if self.current_tab == Tab::Stats \u0026\u0026 self.selected_graph_cell.is_some() {\n            self.set_status(\"Press ESC to deselect\");\n        }\n    }\n\n    pub fn set_status(\u0026mut self, message: \u0026str) {\n        self.status_message = Some(message.to_string());\n        self.status_message_time = Some(Instant::now());\n    }\n\n    pub fn get_sorted_models(\u0026self) -\u003e Vec\u003c\u0026ModelUsage\u003e {\n        let mut models: Vec\u003c\u0026ModelUsage\u003e = self.data.models.iter().collect();\n\n        let tie_breaker = |a: \u0026\u0026ModelUsage, b: \u0026\u0026ModelUsage| {\n            a.model\n                .cmp(\u0026b.model)\n                .then_with(|| a.provider.cmp(\u0026b.provider))\n                .then_with(|| a.source.cmp(\u0026b.source))\n        };\n\n        match (self.sort_field, self.sort_direction) {\n            (SortField::Cost, SortDirection::Descending) =\u003e {\n                models.sort_by(|a, b| b.cost.total_cmp(\u0026a.cost).then_with(|| tie_breaker(a, b)))\n            }\n            (SortField::Cost, SortDirection::Ascending) =\u003e {\n                models.sort_by(|a, b| a.cost.total_cmp(\u0026b.cost).then_with(|| tie_breaker(a, b)))\n            }\n            (SortField::Tokens, SortDirection::Descending) =\u003e models.sort_by(|a, b| {\n                b.tokens\n                    .total()\n                    .cmp(\u0026a.tokens.total())\n                    .then_with(|| tie_breaker(a, b))\n            }),\n            (SortField::Tokens, SortDirection::Ascending) =\u003e models.sort_by(|a, b| {\n                a.tokens\n                    .total()\n                    .cmp(\u0026b.tokens.total())\n                    .then_with(|| tie_breaker(a, b))\n            }),\n            (SortField::Date, _) =\u003e {\n                models.sort_by(|a, b| tie_breaker(a, b));\n            }\n        }\n\n        models\n    }\n\n    pub fn get_sorted_daily(\u0026self) -\u003e Vec\u003c\u0026DailyUsage\u003e {\n        let mut daily: Vec\u003c\u0026DailyUsage\u003e = self.data.daily.iter().collect();\n\n        match (self.sort_field, self.sort_direction) {\n            (SortField::Cost, SortDirection::Descending) =\u003e {\n                daily.sort_by(|a, b| b.cost.total_cmp(\u0026a.cost).then_with(|| a.date.cmp(\u0026b.date)))\n            }\n            (SortField::Cost, SortDirection::Ascending) =\u003e {\n                daily.sort_by(|a, b| a.cost.total_cmp(\u0026b.cost).then_with(|| a.date.cmp(\u0026b.date)))\n            }\n            (SortField::Tokens, SortDirection::Descending) =\u003e daily.sort_by(|a, b| {\n                b.tokens\n                    .total()\n                    .cmp(\u0026a.tokens.total())\n                    .then_with(|| a.date.cmp(\u0026b.date))\n            }),\n            (SortField::Tokens, SortDirection::Ascending) =\u003e daily.sort_by(|a, b| {\n                a.tokens\n                    .total()\n                    .cmp(\u0026b.tokens.total())\n                    .then_with(|| a.date.cmp(\u0026b.date))\n            }),\n            (SortField::Date, SortDirection::Descending) =\u003e {\n                daily.sort_by(|a, b| b.date.cmp(\u0026a.date))\n            }\n            (SortField::Date, SortDirection::Ascending) =\u003e {\n                daily.sort_by(|a, b| a.date.cmp(\u0026b.date))\n            }\n        }\n\n        daily\n    }\n\n    pub fn is_narrow(\u0026self) -\u003e bool {\n        self.terminal_width \u003c 80\n    }\n\n    pub fn is_very_narrow(\u0026self) -\u003e bool {\n        self.terminal_width \u003c 60\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::tui::data::{ModelUsage, TokenBreakdown};\n\n    #[test]\n    fn test_tab_all() {\n        let tabs = Tab::all();\n        assert_eq!(tabs.len(), 4);\n        assert_eq!(tabs[0], Tab::Overview);\n        assert_eq!(tabs[1], Tab::Models);\n        assert_eq!(tabs[2], Tab::Daily);\n        assert_eq!(tabs[3], Tab::Stats);\n    }\n\n    #[test]\n    fn test_tab_next() {\n        assert_eq!(Tab::Overview.next(), Tab::Models);\n        assert_eq!(Tab::Models.next(), Tab::Daily);\n        assert_eq!(Tab::Daily.next(), Tab::Stats);\n        assert_eq!(Tab::Stats.next(), Tab::Overview);\n    }\n\n    #[test]\n    fn test_tab_prev() {\n        assert_eq!(Tab::Overview.prev(), Tab::Stats);\n        assert_eq!(Tab::Models.prev(), Tab::Overview);\n        assert_eq!(Tab::Daily.prev(), Tab::Models);\n        assert_eq!(Tab::Stats.prev(), Tab::Daily);\n    }\n\n    #[test]\n    fn test_tab_as_str() {\n        assert_eq!(Tab::Overview.as_str(), \"Overview\");\n        assert_eq!(Tab::Models.as_str(), \"Models\");\n        assert_eq!(Tab::Daily.as_str(), \"Daily\");\n        assert_eq!(Tab::Stats.as_str(), \"Stats\");\n    }\n\n    #[test]\n    fn test_tab_short_name() {\n        assert_eq!(Tab::Overview.short_name(), \"Ovw\");\n        assert_eq!(Tab::Models.short_name(), \"Mod\");\n        assert_eq!(Tab::Daily.short_name(), \"Day\");\n        assert_eq!(Tab::Stats.short_name(), \"Sta\");\n    }\n\n    #[test]\n    fn test_reset_selection() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        app.selected_index = 5;\n        app.scroll_offset = 3;\n        app.selected_graph_cell = Some((2, 4));\n\n        app.reset_selection();\n\n        assert_eq!(app.selected_index, 0);\n        assert_eq!(app.scroll_offset, 0);\n        assert_eq!(app.selected_graph_cell, None);\n    }\n\n    #[test]\n    fn test_move_selection_up() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Add some mock data\n        app.data.models = vec![\n            ModelUsage {\n                model: \"model1\".to_string(),\n                provider: \"provider1\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n            ModelUsage {\n                model: \"model2\".to_string(),\n                provider: \"provider2\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n        ];\n\n        app.selected_index = 1;\n        app.move_selection_up();\n        assert_eq!(app.selected_index, 0);\n\n        // At top boundary - should not move\n        app.move_selection_up();\n        assert_eq!(app.selected_index, 0);\n    }\n\n    #[test]\n    fn test_move_selection_down() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Add some mock data\n        app.data.models = vec![\n            ModelUsage {\n                model: \"model1\".to_string(),\n                provider: \"provider1\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n            ModelUsage {\n                model: \"model2\".to_string(),\n                provider: \"provider2\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n        ];\n\n        app.selected_index = 0;\n        app.move_selection_down();\n        assert_eq!(app.selected_index, 1);\n\n        // At bottom boundary - should not move\n        app.move_selection_down();\n        assert_eq!(app.selected_index, 1);\n    }\n\n    #[test]\n    fn test_clamp_selection() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Add some mock data\n        app.data.models = vec![ModelUsage {\n            model: \"model1\".to_string(),\n            provider: \"provider1\".to_string(),\n            source: \"opencode\".to_string(),\n            tokens: TokenBreakdown::default(),\n            cost: 0.0,\n            session_count: 1,\n        }];\n\n        // Set selection beyond bounds\n        app.selected_index = 10;\n        app.clamp_selection();\n        assert_eq!(app.selected_index, 0);\n\n        // Empty data\n        app.data.models.clear();\n        app.selected_index = 5;\n        app.clamp_selection();\n        assert_eq!(app.selected_index, 0);\n        assert_eq!(app.scroll_offset, 0);\n    }\n\n    #[test]\n    fn test_set_sort() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Initial state\n        assert_eq!(app.sort_field, SortField::Cost);\n        assert_eq!(app.sort_direction, SortDirection::Descending);\n\n        // Change to different field\n        app.set_sort(SortField::Tokens);\n        assert_eq!(app.sort_field, SortField::Tokens);\n        assert_eq!(app.sort_direction, SortDirection::Descending);\n\n        // Toggle same field\n        app.set_sort(SortField::Tokens);\n        assert_eq!(app.sort_field, SortField::Tokens);\n        assert_eq!(app.sort_direction, SortDirection::Ascending);\n\n        // Toggle again\n        app.set_sort(SortField::Tokens);\n        assert_eq!(app.sort_field, SortField::Tokens);\n        assert_eq!(app.sort_direction, SortDirection::Descending);\n    }\n\n    #[test]\n    fn test_should_quit() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let app = App::new_with_cached_data(config, None).unwrap();\n\n        assert_eq!(app.should_quit, false);\n    }\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":4}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":46,"address":[],"length":0,"stats":{"Line":4}},{"line":47,"address":[],"length":0,"stats":{"Line":4}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[],"length":0,"stats":{"Line":1}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":4}},{"line":56,"address":[],"length":0,"stats":{"Line":4}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":66,"address":[],"length":0,"stats":{"Line":1}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":68,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":6}},{"line":137,"address":[],"length":0,"stats":{"Line":12}},{"line":138,"address":[],"length":0,"stats":{"Line":18}},{"line":139,"address":[],"length":0,"stats":{"Line":6}},{"line":141,"address":[],"length":0,"stats":{"Line":6}},{"line":142,"address":[],"length":0,"stats":{"Line":18}},{"line":144,"address":[],"length":0,"stats":{"Line":12}},{"line":146,"address":[],"length":0,"stats":{"Line":6}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":114}},{"line":163,"address":[],"length":0,"stats":{"Line":108}},{"line":167,"address":[],"length":0,"stats":{"Line":12}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":6}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":6}},{"line":175,"address":[],"length":0,"stats":{"Line":18}},{"line":178,"address":[],"length":0,"stats":{"Line":12}},{"line":179,"address":[],"length":0,"stats":{"Line":6}},{"line":180,"address":[],"length":0,"stats":{"Line":6}},{"line":181,"address":[],"length":0,"stats":{"Line":6}},{"line":184,"address":[],"length":0,"stats":{"Line":18}},{"line":185,"address":[],"length":0,"stats":{"Line":12}},{"line":189,"address":[],"length":0,"stats":{"Line":18}},{"line":190,"address":[],"length":0,"stats":{"Line":6}},{"line":191,"address":[],"length":0,"stats":{"Line":6}},{"line":192,"address":[],"length":0,"stats":{"Line":6}},{"line":193,"address":[],"length":0,"stats":{"Line":6}},{"line":194,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":6}},{"line":196,"address":[],"length":0,"stats":{"Line":6}},{"line":200,"address":[],"length":0,"stats":{"Line":6}},{"line":201,"address":[],"length":0,"stats":{"Line":6}},{"line":202,"address":[],"length":0,"stats":{"Line":6}},{"line":203,"address":[],"length":0,"stats":{"Line":6}},{"line":204,"address":[],"length":0,"stats":{"Line":6}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":6}},{"line":209,"address":[],"length":0,"stats":{"Line":12}},{"line":212,"address":[],"length":0,"stats":{"Line":6}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":2}},{"line":388,"address":[],"length":0,"stats":{"Line":6}},{"line":389,"address":[],"length":0,"stats":{"Line":2}},{"line":390,"address":[],"length":0,"stats":{"Line":1}},{"line":391,"address":[],"length":0,"stats":{"Line":1}},{"line":392,"address":[],"length":0,"stats":{"Line":1}},{"line":394,"address":[],"length":0,"stats":{"Line":3}},{"line":395,"address":[],"length":0,"stats":{"Line":4}},{"line":396,"address":[],"length":0,"stats":{"Line":2}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":4}},{"line":408,"address":[],"length":0,"stats":{"Line":4}},{"line":409,"address":[],"length":0,"stats":{"Line":4}},{"line":410,"address":[],"length":0,"stats":{"Line":4}},{"line":413,"address":[],"length":0,"stats":{"Line":2}},{"line":414,"address":[],"length":0,"stats":{"Line":2}},{"line":415,"address":[],"length":0,"stats":{"Line":1}},{"line":416,"address":[],"length":0,"stats":{"Line":1}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":2}},{"line":423,"address":[],"length":0,"stats":{"Line":8}},{"line":424,"address":[],"length":0,"stats":{"Line":2}},{"line":425,"address":[],"length":0,"stats":{"Line":1}},{"line":426,"address":[],"length":0,"stats":{"Line":2}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":4}},{"line":433,"address":[],"length":0,"stats":{"Line":4}},{"line":434,"address":[],"length":0,"stats":{"Line":8}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":3}},{"line":441,"address":[],"length":0,"stats":{"Line":3}},{"line":442,"address":[],"length":0,"stats":{"Line":2}},{"line":443,"address":[],"length":0,"stats":{"Line":1}},{"line":444,"address":[],"length":0,"stats":{"Line":1}},{"line":447,"address":[],"length":0,"stats":{"Line":1}},{"line":448,"address":[],"length":0,"stats":{"Line":1}},{"line":450,"address":[],"length":0,"stats":{"Line":6}},{"line":451,"address":[],"length":0,"stats":{"Line":9}},{"line":452,"address":[],"length":0,"stats":{"Line":3}},{"line":453,"address":[],"length":0,"stats":{"Line":3}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":3}},{"line":609,"address":[],"length":0,"stats":{"Line":6}},{"line":610,"address":[],"length":0,"stats":{"Line":3}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}}],"covered":101,"coverable":375},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","cache.rs"],"content":"//! TUI data caching for instant startup.\n//!\n//! This module provides disk-based caching for TUI data to enable instant UI display\n//! while fresh data loads in the background (matching TypeScript implementation behavior).\n\nuse std::collections::HashSet;\nuse std::fs::{self, File};\nuse std::io::{BufReader, BufWriter};\nuse std::path::PathBuf;\nuse std::time::{SystemTime, UNIX_EPOCH};\n\nuse serde::{Deserialize, Serialize};\n\nuse super::data::{\n    ContributionDay, DailyModelInfo, DailyUsage, GraphData, ModelUsage, Source, TokenBreakdown,\n    UsageData,\n};\n\n/// Cache staleness threshold: 5 minutes (matches TS implementation)\nconst CACHE_STALE_THRESHOLD_MS: u64 = 5 * 60 * 1000;\n\n/// Get the cache directory path\n/// Uses `~/.cache/tokscale/` to match TypeScript implementation for cache sharing\nfn cache_dir() -\u003e Option\u003cPathBuf\u003e {\n    dirs::home_dir().map(|h| h.join(\".cache\").join(\"tokscale\"))\n}\n\n/// Get the cache file path\nfn cache_file() -\u003e Option\u003cPathBuf\u003e {\n    cache_dir().map(|d| d.join(\"tui-data-cache.json\"))\n}\n\n/// Cached TUI data structure (serializable)\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedTUIData {\n    timestamp: u64,\n    enabled_sources: Vec\u003cString\u003e,\n    data: CachedUsageData,\n}\n\n/// Serializable version of UsageData\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedUsageData {\n    models: Vec\u003cCachedModelUsage\u003e,\n    daily: Vec\u003cCachedDailyUsage\u003e,\n    graph: Option\u003cCachedGraphData\u003e,\n    total_tokens: u64,\n    total_cost: f64,\n    current_streak: u32,\n    longest_streak: u32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedTokenBreakdown {\n    input: u64,\n    output: u64,\n    cache_read: u64,\n    cache_write: u64,\n    reasoning: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedModelUsage {\n    model: String,\n    provider: String,\n    source: String,\n    tokens: CachedTokenBreakdown,\n    cost: f64,\n    session_count: u32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedDailyModelInfo {\n    source: String,\n    tokens: CachedTokenBreakdown,\n    cost: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedDailyUsage {\n    date: String, // NaiveDate serialized as string\n    tokens: CachedTokenBreakdown,\n    cost: f64,\n    models: Vec\u003c(String, CachedDailyModelInfo)\u003e, // HashMap as vec of tuples\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedContributionDay {\n    date: String,\n    tokens: u64,\n    cost: f64,\n    intensity: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedGraphData {\n    weeks: Vec\u003cVec\u003cOption\u003cCachedContributionDay\u003e\u003e\u003e,\n}\n\n// Conversion implementations\n\nimpl From\u003c\u0026TokenBreakdown\u003e for CachedTokenBreakdown {\n    fn from(t: \u0026TokenBreakdown) -\u003e Self {\n        Self {\n            input: t.input,\n            output: t.output,\n            cache_read: t.cache_read,\n            cache_write: t.cache_write,\n            reasoning: t.reasoning,\n        }\n    }\n}\n\nimpl From\u003cCachedTokenBreakdown\u003e for TokenBreakdown {\n    fn from(t: CachedTokenBreakdown) -\u003e Self {\n        Self {\n            input: t.input,\n            output: t.output,\n            cache_read: t.cache_read,\n            cache_write: t.cache_write,\n            reasoning: t.reasoning,\n        }\n    }\n}\n\nimpl From\u003c\u0026ModelUsage\u003e for CachedModelUsage {\n    fn from(m: \u0026ModelUsage) -\u003e Self {\n        Self {\n            model: m.model.clone(),\n            provider: m.provider.clone(),\n            source: m.source.clone(),\n            tokens: (\u0026m.tokens).into(),\n            cost: m.cost,\n            session_count: m.session_count,\n        }\n    }\n}\n\nimpl From\u003cCachedModelUsage\u003e for ModelUsage {\n    fn from(m: CachedModelUsage) -\u003e Self {\n        Self {\n            model: m.model,\n            provider: m.provider,\n            source: m.source,\n            tokens: m.tokens.into(),\n            cost: m.cost,\n            session_count: m.session_count,\n        }\n    }\n}\n\nimpl From\u003c\u0026DailyModelInfo\u003e for CachedDailyModelInfo {\n    fn from(d: \u0026DailyModelInfo) -\u003e Self {\n        Self {\n            source: d.source.clone(),\n            tokens: (\u0026d.tokens).into(),\n            cost: d.cost,\n        }\n    }\n}\n\nimpl From\u003cCachedDailyModelInfo\u003e for DailyModelInfo {\n    fn from(d: CachedDailyModelInfo) -\u003e Self {\n        Self {\n            source: d.source,\n            tokens: d.tokens.into(),\n            cost: d.cost,\n        }\n    }\n}\n\nimpl From\u003c\u0026DailyUsage\u003e for CachedDailyUsage {\n    fn from(d: \u0026DailyUsage) -\u003e Self {\n        Self {\n            date: d.date.to_string(),\n            tokens: (\u0026d.tokens).into(),\n            cost: d.cost,\n            models: d\n                .models\n                .iter()\n                .map(|(k, v)| (k.clone(), v.into()))\n                .collect(),\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedDailyUsage\u003e for DailyUsage {\n    type Error = chrono::ParseError;\n\n    fn try_from(d: CachedDailyUsage) -\u003e Result\u003cSelf, Self::Error\u003e {\n        use chrono::NaiveDate;\n        Ok(Self {\n            date: NaiveDate::parse_from_str(\u0026d.date, \"%Y-%m-%d\")?,\n            tokens: d.tokens.into(),\n            cost: d.cost,\n            models: d.models.into_iter().map(|(k, v)| (k, v.into())).collect(),\n        })\n    }\n}\n\nimpl From\u003c\u0026ContributionDay\u003e for CachedContributionDay {\n    fn from(c: \u0026ContributionDay) -\u003e Self {\n        Self {\n            date: c.date.to_string(),\n            tokens: c.tokens,\n            cost: c.cost,\n            intensity: c.intensity,\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedContributionDay\u003e for ContributionDay {\n    type Error = chrono::ParseError;\n\n    fn try_from(c: CachedContributionDay) -\u003e Result\u003cSelf, Self::Error\u003e {\n        use chrono::NaiveDate;\n        Ok(Self {\n            date: NaiveDate::parse_from_str(\u0026c.date, \"%Y-%m-%d\")?,\n            tokens: c.tokens,\n            cost: c.cost,\n            intensity: c.intensity,\n        })\n    }\n}\n\nimpl From\u003c\u0026GraphData\u003e for CachedGraphData {\n    fn from(g: \u0026GraphData) -\u003e Self {\n        Self {\n            weeks: g\n                .weeks\n                .iter()\n                .map(|week| {\n                    week.iter()\n                        .map(|day| day.as_ref().map(|d| d.into()))\n                        .collect()\n                })\n                .collect(),\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedGraphData\u003e for GraphData {\n    type Error = chrono::ParseError;\n\n    fn try_from(g: CachedGraphData) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let weeks: Result\u003cVec\u003cVec\u003cOption\u003cContributionDay\u003e\u003e\u003e, _\u003e = g\n            .weeks\n            .into_iter()\n            .map(|week| {\n                week.into_iter()\n                    .map(|day| day.map(|d| d.try_into()).transpose())\n                    .collect()\n            })\n            .collect();\n        Ok(Self { weeks: weeks? })\n    }\n}\n\nimpl From\u003c\u0026UsageData\u003e for CachedUsageData {\n    fn from(u: \u0026UsageData) -\u003e Self {\n        Self {\n            models: u.models.iter().map(|m| m.into()).collect(),\n            daily: u.daily.iter().map(|d| d.into()).collect(),\n            graph: u.graph.as_ref().map(|g| g.into()),\n            total_tokens: u.total_tokens,\n            total_cost: u.total_cost,\n            current_streak: u.current_streak,\n            longest_streak: u.longest_streak,\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedUsageData\u003e for UsageData {\n    type Error = chrono::ParseError;\n\n    fn try_from(u: CachedUsageData) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let daily: Result\u003cVec\u003cDailyUsage\u003e, _\u003e = u.daily.into_iter().map(|d| d.try_into()).collect();\n        let graph: Option\u003cResult\u003cGraphData, _\u003e\u003e = u.graph.map(|g| g.try_into());\n\n        Ok(Self {\n            models: u.models.into_iter().map(|m| m.into()).collect(),\n            daily: daily?,\n            graph: graph.transpose()?,\n            total_tokens: u.total_tokens,\n            total_cost: u.total_cost,\n            loading: false,\n            error: None,\n            current_streak: u.current_streak,\n            longest_streak: u.longest_streak,\n        })\n    }\n}\n\n/// Check if sources match between enabled and cached\nfn sources_match(enabled_sources: \u0026HashSet\u003cSource\u003e, cached_sources: \u0026[String]) -\u003e bool {\n    if enabled_sources.len() != cached_sources.len() {\n        return false;\n    }\n    for source in enabled_sources {\n        if !cached_sources.contains(\u0026source.as_str().to_lowercase()) {\n            return false;\n        }\n    }\n    true\n}\n\n/// Load cached TUI data from disk\npub fn load_cached_data(enabled_sources: \u0026HashSet\u003cSource\u003e) -\u003e Option\u003cUsageData\u003e {\n    let cache_path = cache_file()?;\n\n    if !cache_path.exists() {\n        return None;\n    }\n\n    let file = File::open(\u0026cache_path).ok()?;\n    let reader = BufReader::new(file);\n    let cached: CachedTUIData = serde_json::from_reader(reader).ok()?;\n\n    // Check if sources match\n    if !sources_match(enabled_sources, \u0026cached.enabled_sources) {\n        return None;\n    }\n\n    // Convert cached data to UsageData\n    cached.data.try_into().ok()\n}\n\n/// Save TUI data to disk cache\npub fn save_cached_data(data: \u0026UsageData, enabled_sources: \u0026HashSet\u003cSource\u003e) {\n    let Some(cache_path) = cache_file() else {\n        return;\n    };\n\n    // Ensure cache directory exists\n    if let Some(dir) = cache_path.parent() {\n        if let Err(_) = fs::create_dir_all(dir) {\n            return;\n        }\n    }\n\n    let timestamp = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_millis() as u64;\n\n    let cached = CachedTUIData {\n        timestamp,\n        enabled_sources: enabled_sources\n            .iter()\n            .map(|s| s.as_str().to_lowercase())\n            .collect(),\n        data: data.into(),\n    };\n\n    // Write to temp file first, then rename (atomic)\n    let temp_path = cache_path.with_extension(\"json.tmp\");\n    let file = match File::create(\u0026temp_path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return,\n    };\n    let writer = BufWriter::new(file);\n\n    if serde_json::to_writer(writer, \u0026cached).is_ok() {\n        let _ = fs::rename(\u0026temp_path, \u0026cache_path);\n    } else {\n        let _ = fs::remove_file(\u0026temp_path);\n    }\n}\n\n/// Check if cache is stale (older than threshold)\npub fn is_cache_stale(enabled_sources: \u0026HashSet\u003cSource\u003e) -\u003e bool {\n    let Some(cache_path) = cache_file() else {\n        return true;\n    };\n\n    if !cache_path.exists() {\n        return true;\n    }\n\n    let file = match File::open(\u0026cache_path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return true,\n    };\n    let reader = BufReader::new(file);\n    let cached: CachedTUIData = match serde_json::from_reader(reader) {\n        Ok(c) =\u003e c,\n        Err(_) =\u003e return true,\n    };\n\n    // Check if sources match\n    if !sources_match(enabled_sources, \u0026cached.enabled_sources) {\n        return true;\n    }\n\n    // Check age\n    let now = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_millis() as u64;\n\n    let cache_age = now.saturating_sub(cached.timestamp);\n    cache_age \u003e CACHE_STALE_THRESHOLD_MS\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":144},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","config.rs"],"content":"use std::collections::HashMap;\nuse std::fs;\nuse std::path::PathBuf;\nuse std::sync::OnceLock;\n\nuse ratatui::style::Color;\nuse serde::Deserialize;\n\nstatic CONFIG: OnceLock\u003cTokscaleConfig\u003e = OnceLock::new();\n\n#[derive(Debug, Clone, Default, Deserialize)]\npub struct TokscaleConfig {\n    #[serde(default)]\n    pub colors: ColorsConfig,\n    #[serde(default)]\n    pub display_names: DisplayNamesConfig,\n}\n\n#[derive(Debug, Clone, Default, Deserialize)]\npub struct ColorsConfig {\n    #[serde(default)]\n    pub providers: HashMap\u003cString, String\u003e,\n    #[serde(default)]\n    pub sources: HashMap\u003cString, String\u003e,\n}\n\n#[derive(Debug, Clone, Default, Deserialize)]\npub struct DisplayNamesConfig {\n    #[serde(default)]\n    pub providers: HashMap\u003cString, String\u003e,\n    #[serde(default)]\n    pub sources: HashMap\u003cString, String\u003e,\n}\n\nimpl TokscaleConfig {\n    fn config_path() -\u003e Option\u003cPathBuf\u003e {\n        dirs::home_dir().map(|h| h.join(\".tokscale\"))\n    }\n\n    pub fn load() -\u003e \u0026'static TokscaleConfig {\n        CONFIG.get_or_init(|| {\n            Self::config_path()\n                .and_then(|path| fs::read_to_string(path).ok())\n                .and_then(|content| toml::from_str(\u0026content).ok())\n                .unwrap_or_default()\n        })\n    }\n\n    pub fn get_provider_color(\u0026self, provider: \u0026str) -\u003e Option\u003cColor\u003e {\n        self.colors\n            .providers\n            .get(\u0026provider.to_lowercase())\n            .and_then(|hex| parse_hex_color(hex))\n    }\n\n    pub fn get_source_color(\u0026self, source: \u0026str) -\u003e Option\u003cColor\u003e {\n        self.colors\n            .sources\n            .get(\u0026source.to_lowercase())\n            .and_then(|hex| parse_hex_color(hex))\n    }\n\n    pub fn get_provider_display_name(\u0026self, provider: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        self.display_names\n            .providers\n            .get(\u0026provider.to_lowercase())\n            .map(|s| s.as_str())\n    }\n\n    pub fn get_source_display_name(\u0026self, source: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        self.display_names\n            .sources\n            .get(\u0026source.to_lowercase())\n            .map(|s| s.as_str())\n    }\n}\n\nfn parse_hex_color(hex: \u0026str) -\u003e Option\u003cColor\u003e {\n    let hex = hex.trim().trim_start_matches('#');\n    if hex.len() != 6 {\n        return None;\n    }\n    let r = u8::from_str_radix(\u0026hex[0..2], 16).ok()?;\n    let g = u8::from_str_radix(\u0026hex[2..4], 16).ok()?;\n    let b = u8::from_str_radix(\u0026hex[4..6], 16).ok()?;\n    Some(Color::Rgb(r, g, b))\n}\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","data","mod.rs"],"content":"use std::collections::{HashMap, HashSet};\nuse std::path::PathBuf;\n\nuse anyhow::Result;\nuse chrono::{Datelike, NaiveDate, Utc};\nuse rayon::prelude::*;\nuse tokio::runtime::Runtime;\n\nuse tokscale_core::pricing::PricingService;\nuse tokscale_core::sessions::UnifiedMessage;\nuse tokscale_core::{scanner, sessions};\n\n#[derive(Debug, Clone, Default)]\npub struct TokenBreakdown {\n    pub input: u64,\n    pub output: u64,\n    pub cache_read: u64,\n    pub cache_write: u64,\n    pub reasoning: u64,\n}\n\nimpl TokenBreakdown {\n    pub fn total(\u0026self) -\u003e u64 {\n        self.input\n            .saturating_add(self.output)\n            .saturating_add(self.cache_read)\n            .saturating_add(self.cache_write)\n            .saturating_add(self.reasoning)\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct ModelUsage {\n    pub model: String,\n    pub provider: String,\n    pub source: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub session_count: u32,\n}\n\n#[derive(Debug, Clone)]\npub struct DailyModelInfo {\n    pub source: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n}\n\n#[derive(Debug, Clone)]\npub struct DailyUsage {\n    pub date: NaiveDate,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub models: HashMap\u003cString, DailyModelInfo\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ContributionDay {\n    pub date: NaiveDate,\n    pub tokens: u64,\n    pub cost: f64,\n    pub intensity: f64,\n}\n\n#[derive(Debug, Clone)]\npub struct GraphData {\n    pub weeks: Vec\u003cVec\u003cOption\u003cContributionDay\u003e\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Default)]\npub struct UsageData {\n    pub models: Vec\u003cModelUsage\u003e,\n    pub daily: Vec\u003cDailyUsage\u003e,\n    pub graph: Option\u003cGraphData\u003e,\n    pub total_tokens: u64,\n    pub total_cost: f64,\n    pub loading: bool,\n    pub error: Option\u003cString\u003e,\n    pub current_streak: u32,\n    pub longest_streak: u32,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum Source {\n    OpenCode,\n    Claude,\n    Codex,\n    Cursor,\n    Gemini,\n    Amp,\n    Droid,\n    OpenClaw,\n    Pi,\n}\n\nimpl Source {\n    pub fn all() -\u003e \u0026'static [Source] {\n        \u0026[\n            Source::OpenCode,\n            Source::Claude,\n            Source::Codex,\n            Source::Cursor,\n            Source::Gemini,\n            Source::Amp,\n            Source::Droid,\n            Source::OpenClaw,\n            Source::Pi,\n        ]\n    }\n\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Source::OpenCode =\u003e \"OpenCode\",\n            Source::Claude =\u003e \"Claude\",\n            Source::Codex =\u003e \"Codex\",\n            Source::Cursor =\u003e \"Cursor\",\n            Source::Gemini =\u003e \"Gemini\",\n            Source::Amp =\u003e \"Amp\",\n            Source::Droid =\u003e \"Droid\",\n            Source::OpenClaw =\u003e \"OpenClaw\",\n            Source::Pi =\u003e \"Pi\",\n        }\n    }\n\n    pub fn key(\u0026self) -\u003e char {\n        match self {\n            Source::OpenCode =\u003e '1',\n            Source::Claude =\u003e '2',\n            Source::Codex =\u003e '3',\n            Source::Cursor =\u003e '4',\n            Source::Gemini =\u003e '5',\n            Source::Amp =\u003e '6',\n            Source::Droid =\u003e '7',\n            Source::OpenClaw =\u003e '8',\n            Source::Pi =\u003e '9',\n        }\n    }\n\n    pub fn from_key(key: char) -\u003e Option\u003cSource\u003e {\n        match key {\n            '1' =\u003e Some(Source::OpenCode),\n            '2' =\u003e Some(Source::Claude),\n            '3' =\u003e Some(Source::Codex),\n            '4' =\u003e Some(Source::Cursor),\n            '5' =\u003e Some(Source::Gemini),\n            '6' =\u003e Some(Source::Amp),\n            '7' =\u003e Some(Source::Droid),\n            '8' =\u003e Some(Source::OpenClaw),\n            '9' =\u003e Some(Source::Pi),\n            _ =\u003e None,\n        }\n    }\n\n    fn to_core_source(self) -\u003e \u0026'static str {\n        match self {\n            Source::OpenCode =\u003e \"opencode\",\n            Source::Claude =\u003e \"claude\",\n            Source::Codex =\u003e \"codex\",\n            Source::Cursor =\u003e \"cursor\",\n            Source::Gemini =\u003e \"gemini\",\n            Source::Amp =\u003e \"amp\",\n            Source::Droid =\u003e \"droid\",\n            Source::OpenClaw =\u003e \"openclaw\",\n            Source::Pi =\u003e \"pi\",\n        }\n    }\n}\n\npub struct DataLoader {\n    _sessions_path: Option\u003cPathBuf\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n}\n\nimpl DataLoader {\n    pub fn new(sessions_path: Option\u003cPathBuf\u003e) -\u003e Self {\n        Self {\n            _sessions_path: sessions_path,\n            since: None,\n            until: None,\n            year: None,\n        }\n    }\n\n    pub fn with_filters(\n        sessions_path: Option\u003cPathBuf\u003e,\n        since: Option\u003cString\u003e,\n        until: Option\u003cString\u003e,\n        year: Option\u003cString\u003e,\n    ) -\u003e Self {\n        Self {\n            _sessions_path: sessions_path,\n            since,\n            until,\n            year,\n        }\n    }\n\n    pub fn load(\u0026self, enabled_sources: \u0026[Source]) -\u003e Result\u003cUsageData\u003e {\n        let home = dirs::home_dir()\n            .ok_or_else(|| anyhow::anyhow!(\"Could not find home directory\"))?\n            .to_string_lossy()\n            .to_string();\n\n        let rt = Runtime::new()?;\n        let pricing_result = rt.block_on(async { PricingService::get_or_init().await });\n        let pricing = pricing_result.as_ref().ok();\n\n        let sources: Vec\u003cString\u003e = enabled_sources\n            .iter()\n            .map(|s| s.to_core_source().to_string())\n            .collect();\n\n        let scan_result = scanner::scan_all_sources(\u0026home, \u0026sources);\n\n        let mut all_messages: Vec\u003cUnifiedMessage\u003e = Vec::new();\n\n        if enabled_sources.contains(\u0026Source::OpenCode) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .opencode_files\n                .par_iter()\n                .filter_map(|path| sessions::opencode::parse_opencode_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Claude) {\n            let msgs_raw: Vec\u003cUnifiedMessage\u003e = scan_result\n                .claude_files\n                .par_iter()\n                .flat_map(|path| sessions::claudecode::parse_claude_file(path))\n                .collect();\n\n            let mut seen_keys: HashSet\u003cString\u003e = HashSet::new();\n            let msgs: Vec\u003cUnifiedMessage\u003e = msgs_raw\n                .into_iter()\n                .filter(|m| {\n                    m.dedup_key\n                        .as_ref()\n                        .is_none_or(|k| k.is_empty() || seen_keys.insert(k.clone()))\n                })\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Codex) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .codex_files\n                .par_iter()\n                .flat_map(|path| sessions::codex::parse_codex_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Cursor) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .cursor_files\n                .par_iter()\n                .flat_map(|path| sessions::cursor::parse_cursor_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Gemini) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .gemini_files\n                .par_iter()\n                .flat_map(|path| sessions::gemini::parse_gemini_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Amp) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .amp_files\n                .par_iter()\n                .flat_map(|path| sessions::amp::parse_amp_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Droid) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .droid_files\n                .par_iter()\n                .flat_map(|path| sessions::droid::parse_droid_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::OpenClaw) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .openclaw_files\n                .par_iter()\n                .flat_map(|path| sessions::openclaw::parse_openclaw_index(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Pi) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .pi_files\n                .par_iter()\n                .flat_map(|path| sessions::pi::parse_pi_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if let Some(svc) = pricing {\n            for msg in \u0026mut all_messages {\n                let calculated_cost = svc.calculate_cost(\n                    \u0026msg.model_id,\n                    msg.tokens.input,\n                    msg.tokens.output,\n                    msg.tokens.cache_read,\n                    msg.tokens.cache_write,\n                    msg.tokens.reasoning,\n                );\n                // Only overwrite cost if pricing service returns a positive value\n                // Preserve original cost for sources like cursor/amp that provide pre-calculated costs\n                if calculated_cost \u003e 0.0 {\n                    msg.cost = calculated_cost;\n                }\n            }\n        }\n\n        // Apply date filters if specified\n        let filtered_messages = self.apply_date_filters(all_messages);\n\n        self.aggregate_messages(filtered_messages)\n    }\n\n    fn aggregate_messages(\u0026self, messages: Vec\u003cUnifiedMessage\u003e) -\u003e Result\u003cUsageData\u003e {\n        let mut model_map: HashMap\u003cString, ModelUsage\u003e = HashMap::new();\n        let mut daily_map: HashMap\u003cNaiveDate, DailyUsage\u003e = HashMap::new();\n        let mut model_session_ids: HashMap\u003cString, HashSet\u003cString\u003e\u003e = HashMap::new();\n\n        for msg in \u0026messages {\n            let key = format!(\"{}:{}:{}\", msg.source, msg.provider_id, msg.model_id);\n\n            let model_entry = model_map.entry(key.clone()).or_insert_with(|| ModelUsage {\n                model: msg.model_id.clone(),\n                provider: msg.provider_id.clone(),\n                source: msg.source.clone(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 0,\n            });\n\n            model_entry.tokens.input = model_entry\n                .tokens\n                .input\n                .saturating_add(msg.tokens.input.max(0) as u64);\n            model_entry.tokens.output = model_entry\n                .tokens\n                .output\n                .saturating_add(msg.tokens.output.max(0) as u64);\n            model_entry.tokens.cache_read = model_entry\n                .tokens\n                .cache_read\n                .saturating_add(msg.tokens.cache_read.max(0) as u64);\n            model_entry.tokens.cache_write = model_entry\n                .tokens\n                .cache_write\n                .saturating_add(msg.tokens.cache_write.max(0) as u64);\n            model_entry.tokens.reasoning = model_entry\n                .tokens\n                .reasoning\n                .saturating_add(msg.tokens.reasoning.max(0) as u64);\n            let msg_cost = if msg.cost.is_finite() \u0026\u0026 msg.cost \u003e= 0.0 {\n                msg.cost\n            } else {\n                0.0\n            };\n            model_entry.cost += msg_cost;\n\n            let session_key = format!(\"{}:{}\", msg.source, msg.session_id);\n            let model_sessions = model_session_ids.entry(key).or_insert_with(HashSet::new);\n            if model_sessions.insert(session_key) {\n                model_entry.session_count += 1;\n            }\n\n            if let Some(date) = parse_date(\u0026msg.date) {\n                let daily_entry = daily_map.entry(date).or_insert_with(|| DailyUsage {\n                    date,\n                    tokens: TokenBreakdown::default(),\n                    cost: 0.0,\n                    models: HashMap::new(),\n                });\n\n                daily_entry.tokens.input = daily_entry\n                    .tokens\n                    .input\n                    .saturating_add(msg.tokens.input.max(0) as u64);\n                daily_entry.tokens.output = daily_entry\n                    .tokens\n                    .output\n                    .saturating_add(msg.tokens.output.max(0) as u64);\n                daily_entry.tokens.cache_read = daily_entry\n                    .tokens\n                    .cache_read\n                    .saturating_add(msg.tokens.cache_read.max(0) as u64);\n                daily_entry.tokens.cache_write = daily_entry\n                    .tokens\n                    .cache_write\n                    .saturating_add(msg.tokens.cache_write.max(0) as u64);\n                daily_entry.tokens.reasoning = daily_entry\n                    .tokens\n                    .reasoning\n                    .saturating_add(msg.tokens.reasoning.max(0) as u64);\n                let msg_cost = if msg.cost.is_finite() \u0026\u0026 msg.cost \u003e= 0.0 {\n                    msg.cost\n                } else {\n                    0.0\n                };\n                daily_entry.cost += msg_cost;\n\n                let model_info = daily_entry\n                    .models\n                    .entry(msg.model_id.clone())\n                    .or_insert_with(|| DailyModelInfo {\n                        source: msg.source.clone(),\n                        tokens: TokenBreakdown::default(),\n                        cost: 0.0,\n                    });\n\n                model_info.tokens.input = model_info\n                    .tokens\n                    .input\n                    .saturating_add(msg.tokens.input.max(0) as u64);\n                model_info.tokens.output = model_info\n                    .tokens\n                    .output\n                    .saturating_add(msg.tokens.output.max(0) as u64);\n                model_info.tokens.cache_read = model_info\n                    .tokens\n                    .cache_read\n                    .saturating_add(msg.tokens.cache_read.max(0) as u64);\n                model_info.tokens.cache_write = model_info\n                    .tokens\n                    .cache_write\n                    .saturating_add(msg.tokens.cache_write.max(0) as u64);\n                model_info.tokens.reasoning = model_info\n                    .tokens\n                    .reasoning\n                    .saturating_add(msg.tokens.reasoning.max(0) as u64);\n                let model_msg_cost = if msg.cost.is_finite() \u0026\u0026 msg.cost \u003e= 0.0 {\n                    msg.cost\n                } else {\n                    0.0\n                };\n                model_info.cost += model_msg_cost;\n            }\n        }\n\n        let mut models: Vec\u003cModelUsage\u003e = model_map.into_values().collect();\n        models.sort_by(|a, b| {\n            b.cost\n                .total_cmp(\u0026a.cost)\n                .then_with(|| a.model.cmp(\u0026b.model))\n                .then_with(|| a.provider.cmp(\u0026b.provider))\n                .then_with(|| a.source.cmp(\u0026b.source))\n        });\n\n        let mut daily: Vec\u003cDailyUsage\u003e = daily_map.into_values().collect();\n        daily.sort_by(|a, b| b.date.cmp(\u0026a.date));\n\n        let total_tokens: u64 = models.iter().map(|m| m.tokens.total()).sum();\n        let total_cost: f64 = models\n            .iter()\n            .map(|m| if m.cost.is_finite() { m.cost } else { 0.0 })\n            .sum();\n\n        let graph = build_contribution_graph(\u0026daily);\n        let (current_streak, longest_streak) = calculate_streaks(\u0026daily);\n\n        Ok(UsageData {\n            models,\n            daily,\n            graph: Some(graph),\n            total_tokens,\n            total_cost,\n            loading: false,\n            error: None,\n            current_streak,\n            longest_streak,\n        })\n    }\n\n    fn apply_date_filters(\u0026self, messages: Vec\u003cUnifiedMessage\u003e) -\u003e Vec\u003cUnifiedMessage\u003e {\n        // If no filters are specified, return all messages\n        if self.since.is_none() \u0026\u0026 self.until.is_none() \u0026\u0026 self.year.is_none() {\n            return messages;\n        }\n\n        messages\n            .into_iter()\n            .filter(|msg| {\n                if let Some(date) = parse_date(\u0026msg.date) {\n                    // Check year filter\n                    if let Some(ref year_str) = self.year {\n                        if let Ok(year) = year_str.parse::\u003ci32\u003e() {\n                            if date.year() != year {\n                                return false;\n                            }\n                        }\n                    }\n\n                    // Check since filter\n                    if let Some(ref since_str) = self.since {\n                        if let Some(since_date) = parse_date(since_str) {\n                            if date \u003c since_date {\n                                return false;\n                            }\n                        }\n                    }\n\n                    // Check until filter\n                    if let Some(ref until_str) = self.until {\n                        if let Some(until_date) = parse_date(until_str) {\n                            if date \u003e until_date {\n                                return false;\n                            }\n                        }\n                    }\n\n                    true\n                } else {\n                    false\n                }\n            })\n            .collect()\n    }\n}\n\nfn parse_date(date_str: \u0026str) -\u003e Option\u003cNaiveDate\u003e {\n    NaiveDate::parse_from_str(date_str, \"%Y-%m-%d\").ok()\n}\n\nfn build_contribution_graph(daily: \u0026[DailyUsage]) -\u003e GraphData {\n    if daily.is_empty() {\n        return GraphData { weeks: vec![] };\n    }\n\n    let today = Utc::now().date_naive();\n    let days_to_sunday = today.weekday().num_days_from_sunday();\n    let end_date = today;\n    let start_date = end_date - chrono::Duration::days(364 + days_to_sunday as i64);\n\n    let daily_map: HashMap\u003cNaiveDate, \u0026DailyUsage\u003e = daily.iter().map(|d| (d.date, d)).collect();\n\n    let max_cost = daily.iter().map(|d| d.cost).fold(0.0_f64, |a, b| a.max(b));\n\n    let mut weeks: Vec\u003cVec\u003cOption\u003cContributionDay\u003e\u003e\u003e = Vec::new();\n    let mut current_week: Vec\u003cOption\u003cContributionDay\u003e\u003e = Vec::new();\n\n    let mut current_date = start_date;\n    while current_date \u003c= end_date {\n        let day = if let Some(usage) = daily_map.get(\u0026current_date) {\n            let raw_intensity = if max_cost \u003e 0.0 {\n                usage.cost / max_cost\n            } else {\n                0.0\n            };\n            let intensity = if raw_intensity.is_finite() {\n                raw_intensity.clamp(0.0, 1.0)\n            } else {\n                0.0\n            };\n            Some(ContributionDay {\n                date: current_date,\n                tokens: usage.tokens.total(),\n                cost: usage.cost,\n                intensity,\n            })\n        } else {\n            Some(ContributionDay {\n                date: current_date,\n                tokens: 0,\n                cost: 0.0,\n                intensity: 0.0,\n            })\n        };\n\n        current_week.push(day);\n\n        if current_date.weekday() == chrono::Weekday::Sat || current_date == end_date {\n            weeks.push(current_week);\n            current_week = Vec::new();\n        }\n\n        current_date += chrono::Duration::days(1);\n    }\n\n    GraphData { weeks }\n}\n\nfn calculate_streaks(daily: \u0026[DailyUsage]) -\u003e (u32, u32) {\n    if daily.is_empty() {\n        return (0, 0);\n    }\n\n    let today = Utc::now().date_naive();\n    let dates: HashSet\u003cNaiveDate\u003e = daily.iter().map(|d| d.date).collect();\n\n    let mut current_streak = 0u32;\n    let mut check_date = today;\n\n    while dates.contains(\u0026check_date) {\n        current_streak += 1;\n        check_date -= chrono::Duration::days(1);\n    }\n\n    if current_streak == 0 {\n        let yesterday = today - chrono::Duration::days(1);\n        check_date = yesterday;\n        while dates.contains(\u0026check_date) {\n            current_streak += 1;\n            check_date -= chrono::Duration::days(1);\n        }\n    }\n\n    let mut longest_streak = 0u32;\n    let mut sorted_dates: Vec\u003cNaiveDate\u003e = dates.into_iter().collect();\n    sorted_dates.sort();\n\n    let mut streak = 0u32;\n    let mut prev_date: Option\u003cNaiveDate\u003e = None;\n\n    for date in sorted_dates {\n        if let Some(prev) = prev_date {\n            if date == prev + chrono::Duration::days(1) {\n                streak += 1;\n            } else {\n                longest_streak = longest_streak.max(streak);\n                streak = 1;\n            }\n        } else {\n            streak = 1;\n        }\n        prev_date = Some(date);\n    }\n    longest_streak = longest_streak.max(streak);\n\n    (current_streak, longest_streak)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_source_all() {\n        let sources = Source::all();\n        assert_eq!(sources.len(), 9);\n        assert_eq!(sources[0], Source::OpenCode);\n        assert_eq!(sources[1], Source::Claude);\n        assert_eq!(sources[2], Source::Codex);\n        assert_eq!(sources[3], Source::Cursor);\n        assert_eq!(sources[4], Source::Gemini);\n        assert_eq!(sources[5], Source::Amp);\n        assert_eq!(sources[6], Source::Droid);\n        assert_eq!(sources[7], Source::OpenClaw);\n        assert_eq!(sources[8], Source::Pi);\n    }\n\n    #[test]\n    fn test_source_as_str() {\n        assert_eq!(Source::OpenCode.as_str(), \"OpenCode\");\n        assert_eq!(Source::Claude.as_str(), \"Claude\");\n        assert_eq!(Source::Codex.as_str(), \"Codex\");\n        assert_eq!(Source::Cursor.as_str(), \"Cursor\");\n        assert_eq!(Source::Gemini.as_str(), \"Gemini\");\n        assert_eq!(Source::Amp.as_str(), \"Amp\");\n        assert_eq!(Source::Droid.as_str(), \"Droid\");\n        assert_eq!(Source::OpenClaw.as_str(), \"OpenClaw\");\n        assert_eq!(Source::Pi.as_str(), \"Pi\");\n    }\n\n    #[test]\n    fn test_source_key() {\n        assert_eq!(Source::OpenCode.key(), '1');\n        assert_eq!(Source::Claude.key(), '2');\n        assert_eq!(Source::Codex.key(), '3');\n        assert_eq!(Source::Cursor.key(), '4');\n        assert_eq!(Source::Gemini.key(), '5');\n        assert_eq!(Source::Amp.key(), '6');\n        assert_eq!(Source::Droid.key(), '7');\n        assert_eq!(Source::OpenClaw.key(), '8');\n        assert_eq!(Source::Pi.key(), '9');\n    }\n\n    #[test]\n    fn test_source_from_key() {\n        assert_eq!(Source::from_key('1'), Some(Source::OpenCode));\n        assert_eq!(Source::from_key('2'), Some(Source::Claude));\n        assert_eq!(Source::from_key('3'), Some(Source::Codex));\n        assert_eq!(Source::from_key('4'), Some(Source::Cursor));\n        assert_eq!(Source::from_key('5'), Some(Source::Gemini));\n        assert_eq!(Source::from_key('6'), Some(Source::Amp));\n        assert_eq!(Source::from_key('7'), Some(Source::Droid));\n        assert_eq!(Source::from_key('8'), Some(Source::OpenClaw));\n        assert_eq!(Source::from_key('9'), Some(Source::Pi));\n        assert_eq!(Source::from_key('0'), None);\n        assert_eq!(Source::from_key('a'), None);\n    }\n\n    #[test]\n    fn test_token_breakdown_total() {\n        let breakdown = TokenBreakdown {\n            input: 100,\n            output: 200,\n            cache_read: 50,\n            cache_write: 25,\n            reasoning: 10,\n        };\n        assert_eq!(breakdown.total(), 385);\n    }\n\n    #[test]\n    fn test_token_breakdown_total_with_overflow() {\n        let breakdown = TokenBreakdown {\n            input: u64::MAX,\n            output: 1,\n            cache_read: 0,\n            cache_write: 0,\n            reasoning: 0,\n        };\n        // saturating_add should prevent overflow\n        assert_eq!(breakdown.total(), u64::MAX);\n    }\n\n    #[test]\n    fn test_token_breakdown_default() {\n        let breakdown = TokenBreakdown::default();\n        assert_eq!(breakdown.input, 0);\n        assert_eq!(breakdown.output, 0);\n        assert_eq!(breakdown.cache_read, 0);\n        assert_eq!(breakdown.cache_write, 0);\n        assert_eq!(breakdown.reasoning, 0);\n        assert_eq!(breakdown.total(), 0);\n    }\n\n    #[test]\n    fn test_data_loader_new() {\n        let loader = DataLoader::new(None);\n        assert!(loader._sessions_path.is_none());\n        assert!(loader.since.is_none());\n        assert!(loader.until.is_none());\n        assert!(loader.year.is_none());\n    }\n\n    #[test]\n    fn test_data_loader_with_filters() {\n        let loader = DataLoader::with_filters(\n            Some(PathBuf::from(\"/tmp/sessions\")),\n            Some(\"2024-01-01\".to_string()),\n            Some(\"2024-12-31\".to_string()),\n            Some(\"2024\".to_string()),\n        );\n        \n        assert_eq!(loader._sessions_path, Some(PathBuf::from(\"/tmp/sessions\")));\n        assert_eq!(loader.since, Some(\"2024-01-01\".to_string()));\n        assert_eq!(loader.until, Some(\"2024-12-31\".to_string()));\n        assert_eq!(loader.year, Some(\"2024\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_date() {\n        assert_eq!(\n            parse_date(\"2024-01-15\"),\n            Some(NaiveDate::from_ymd_opt(2024, 1, 15).unwrap())\n        );\n        assert_eq!(\n            parse_date(\"2024-12-31\"),\n            Some(NaiveDate::from_ymd_opt(2024, 12, 31).unwrap())\n        );\n        assert_eq!(parse_date(\"invalid\"), None);\n        assert_eq!(parse_date(\"2024-13-01\"), None);\n        assert_eq!(parse_date(\"\"), None);\n    }\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":3}},{"line":24,"address":[],"length":0,"stats":{"Line":3}},{"line":25,"address":[],"length":0,"stats":{"Line":6}},{"line":26,"address":[],"length":0,"stats":{"Line":6}},{"line":27,"address":[],"length":0,"stats":{"Line":6}},{"line":28,"address":[],"length":0,"stats":{"Line":6}},{"line":97,"address":[],"length":0,"stats":{"Line":7}},{"line":98,"address":[],"length":0,"stats":{"Line":7}},{"line":99,"address":[],"length":0,"stats":{"Line":7}},{"line":100,"address":[],"length":0,"stats":{"Line":7}},{"line":101,"address":[],"length":0,"stats":{"Line":7}},{"line":102,"address":[],"length":0,"stats":{"Line":7}},{"line":103,"address":[],"length":0,"stats":{"Line":7}},{"line":104,"address":[],"length":0,"stats":{"Line":7}},{"line":105,"address":[],"length":0,"stats":{"Line":7}},{"line":106,"address":[],"length":0,"stats":{"Line":7}},{"line":107,"address":[],"length":0,"stats":{"Line":7}},{"line":111,"address":[],"length":0,"stats":{"Line":9}},{"line":112,"address":[],"length":0,"stats":{"Line":9}},{"line":113,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":115,"address":[],"length":0,"stats":{"Line":1}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":117,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":1}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":125,"address":[],"length":0,"stats":{"Line":9}},{"line":126,"address":[],"length":0,"stats":{"Line":9}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":128,"address":[],"length":0,"stats":{"Line":1}},{"line":129,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":133,"address":[],"length":0,"stats":{"Line":1}},{"line":134,"address":[],"length":0,"stats":{"Line":1}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":11}},{"line":140,"address":[],"length":0,"stats":{"Line":11}},{"line":141,"address":[],"length":0,"stats":{"Line":1}},{"line":142,"address":[],"length":0,"stats":{"Line":1}},{"line":143,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":1}},{"line":145,"address":[],"length":0,"stats":{"Line":1}},{"line":146,"address":[],"length":0,"stats":{"Line":1}},{"line":147,"address":[],"length":0,"stats":{"Line":1}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":149,"address":[],"length":0,"stats":{"Line":1}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":186,"address":[],"length":0,"stats":{"Line":7}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":5}},{"line":538,"address":[],"length":0,"stats":{"Line":20}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}}],"covered":55,"coverable":348},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","event.rs"],"content":"use std::sync::mpsc;\nuse std::thread;\nuse std::time::Duration;\n\nuse anyhow::Result;\nuse crossterm::event::{self, KeyEvent, MouseEvent};\n\npub enum Event {\n    Tick,\n    Key(KeyEvent),\n    Mouse(MouseEvent),\n    Resize(u16, u16),\n}\n\npub struct EventHandler {\n    rx: mpsc::Receiver\u003cEvent\u003e,\n}\n\nimpl EventHandler {\n    pub fn new(tick_rate: Duration) -\u003e Self {\n        let (tx, rx) = mpsc::channel();\n        let event_tx = tx.clone();\n\n        thread::spawn(move || loop {\n            if event::poll(tick_rate).unwrap_or(false) {\n                match event::read() {\n                    Ok(event::Event::Key(key)) =\u003e {\n                        if event_tx.send(Event::Key(key)).is_err() {\n                            break;\n                        }\n                    }\n                    Ok(event::Event::Mouse(mouse)) =\u003e {\n                        if event_tx.send(Event::Mouse(mouse)).is_err() {\n                            break;\n                        }\n                    }\n                    Ok(event::Event::Resize(w, h)) =\u003e {\n                        if event_tx.send(Event::Resize(w, h)).is_err() {\n                            break;\n                        }\n                    }\n                    _ =\u003e {}\n                }\n            } else if event_tx.send(Event::Tick).is_err() {\n                break;\n            }\n        });\n\n        drop(tx);\n        Self { rx }\n    }\n\n    pub fn next(\u0026mut self) -\u003e Result\u003cEvent\u003e {\n        Ok(self.rx.recv()?)\n    }\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":21},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","mod.rs"],"content":"mod app;\nmod cache;\npub mod config;\npub mod data;\nmod event;\npub mod settings;\nmod themes;\nmod ui;\n\npub use app::{App, Tab, TuiConfig};\npub use cache::{is_cache_stale, load_cached_data, save_cached_data};\npub use data::{DataLoader, Source, UsageData};\npub use event::{Event, EventHandler};\n\nuse std::collections::HashSet;\nuse std::io;\nuse std::sync::mpsc;\nuse std::sync::mpsc::TryRecvError;\nuse std::thread;\nuse std::time::Duration;\n\nuse anyhow::Result;\nuse crossterm::{\n    event::{DisableMouseCapture, EnableMouseCapture},\n    execute,\n    terminal::{disable_raw_mode, enable_raw_mode, EnterAlternateScreen, LeaveAlternateScreen},\n};\nuse ratatui::prelude::*;\n\npub fn run(\n    theme: \u0026str,\n    refresh: u64,\n    debug: bool,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    initial_tab: Option\u003cTab\u003e,\n) -\u003e Result\u003c()\u003e {\n    if debug {\n        let _ = tracing_subscriber::fmt()\n            .with_env_filter(\"debug\")\n            .try_init();\n    }\n\n    let config = TuiConfig {\n        theme: theme.to_string(),\n        refresh,\n        sessions_path: None,\n        sources: sources.clone(),\n        since: since.clone(),\n        until: until.clone(),\n        year: year.clone(),\n        initial_tab,\n    };\n\n    let mut enabled_sources = HashSet::new();\n    if let Some(ref cli_sources) = sources {\n        for source_str in cli_sources {\n            match source_str.as_str() {\n                \"opencode\" =\u003e enabled_sources.insert(Source::OpenCode),\n                \"claude\" =\u003e enabled_sources.insert(Source::Claude),\n                \"codex\" =\u003e enabled_sources.insert(Source::Codex),\n                \"cursor\" =\u003e enabled_sources.insert(Source::Cursor),\n                \"gemini\" =\u003e enabled_sources.insert(Source::Gemini),\n                \"amp\" =\u003e enabled_sources.insert(Source::Amp),\n                \"droid\" =\u003e enabled_sources.insert(Source::Droid),\n                \"openclaw\" =\u003e enabled_sources.insert(Source::OpenClaw),\n                \"pi\" =\u003e enabled_sources.insert(Source::Pi),\n                _ =\u003e false,\n            };\n        }\n    } else {\n        for source in Source::all() {\n            enabled_sources.insert(*source);\n        }\n    }\n\n    let cached_data = load_cached_data(\u0026enabled_sources);\n    let cache_is_stale = cached_data.is_some() \u0026\u0026 is_cache_stale(\u0026enabled_sources);\n    let has_cached_data = cached_data.is_some();\n\n    enable_raw_mode()?;\n    let mut stdout = io::stdout();\n\n    if let Err(e) = execute!(stdout, EnterAlternateScreen, EnableMouseCapture) {\n        let _ = disable_raw_mode();\n        return Err(e.into());\n    }\n\n    let backend = CrosstermBackend::new(stdout);\n    let terminal_result = Terminal::new(backend);\n    let mut terminal = match terminal_result {\n        Ok(t) =\u003e t,\n        Err(e) =\u003e {\n            restore_terminal_best_effort();\n            return Err(e.into());\n        }\n    };\n\n    let mut app = match App::new_with_cached_data(config, cached_data) {\n        Ok(a) =\u003e a,\n        Err(e) =\u003e {\n            restore_terminal(\u0026mut terminal);\n            return Err(e);\n        }\n    };\n\n    let (tx, rx) = mpsc::channel::\u003cResult\u003cUsageData\u003e\u003e();\n    let needs_background_load = !has_cached_data || cache_is_stale;\n\n    if needs_background_load {\n        app.set_background_loading(true);\n\n        let bg_sources: Vec\u003cSource\u003e = enabled_sources.iter().copied().collect();\n        let bg_since = since.clone();\n        let bg_until = until.clone();\n        let bg_year = year.clone();\n        let bg_enabled_sources = enabled_sources.clone();\n\n        thread::spawn(move || {\n            let loader = DataLoader::with_filters(None, bg_since, bg_until, bg_year);\n            let result = loader.load(\u0026bg_sources);\n\n            if let Ok(ref data) = result {\n                save_cached_data(data, \u0026bg_enabled_sources);\n            }\n\n            let _ = tx.send(result);\n        });\n    }\n\n    let mut events = EventHandler::new(Duration::from_millis(100));\n\n    let result = run_loop_with_background(\u0026mut terminal, \u0026mut app, \u0026mut events, rx);\n\n    restore_terminal(\u0026mut terminal);\n\n    result\n}\n\nfn restore_terminal_best_effort() {\n    let _ = execute!(io::stdout(), LeaveAlternateScreen, DisableMouseCapture);\n    let _ = disable_raw_mode();\n}\n\nfn restore_terminal(terminal: \u0026mut Terminal\u003cCrosstermBackend\u003cio::Stdout\u003e\u003e) {\n    let _ = disable_raw_mode();\n    let _ = execute!(\n        terminal.backend_mut(),\n        LeaveAlternateScreen,\n        DisableMouseCapture\n    );\n    let _ = terminal.show_cursor();\n}\n\nfn run_loop_with_background(\n    terminal: \u0026mut Terminal\u003cCrosstermBackend\u003cio::Stdout\u003e\u003e,\n    app: \u0026mut App,\n    events: \u0026mut EventHandler,\n    background_rx: mpsc::Receiver\u003cResult\u003cUsageData\u003e\u003e,\n) -\u003e Result\u003c()\u003e {\n    loop {\n        terminal.draw(|f| ui::render(f, app))?;\n\n        match background_rx.try_recv() {\n            Ok(result) =\u003e {\n                app.set_background_loading(false);\n                match result {\n                    Ok(data) =\u003e {\n                        app.update_data(data);\n                        app.set_status(\"Data loaded\");\n                    }\n                    Err(e) =\u003e {\n                        app.set_error(Some(e.to_string()));\n                        app.set_status(\u0026format!(\"Error: {}\", e));\n                    }\n                }\n            }\n            Err(TryRecvError::Disconnected) =\u003e {\n                // Only treat as error if we were still waiting for data\n                // After data is received, disconnect is expected (thread completed)\n                if app.background_loading {\n                    app.set_background_loading(false);\n                    app.set_error(Some(\"Background thread disconnected\".to_string()));\n                    app.set_status(\"Error: Background thread disconnected\");\n                }\n            }\n            Err(TryRecvError::Empty) =\u003e {\n                // No data available yet, continue\n            }\n        }\n\n        match events.next()? {\n            Event::Tick =\u003e {\n                app.on_tick();\n            }\n            Event::Key(key) =\u003e {\n                if app.handle_key_event(key) {\n                    break;\n                }\n            }\n            Event::Mouse(mouse) =\u003e {\n                app.handle_mouse_event(mouse);\n            }\n            Event::Resize(w, h) =\u003e {\n                app.handle_resize(w, h);\n            }\n        }\n\n        if app.should_quit {\n            break;\n        }\n    }\n    Ok(())\n}\n\npub fn test_data_loading() -\u003e Result\u003c()\u003e {\n    println!(\"Testing data loading...\");\n\n    let loader = DataLoader::new(None);\n    let all_sources = vec![\n        Source::OpenCode,\n        Source::Claude,\n        Source::Cursor,\n        Source::Gemini,\n        Source::Codex,\n        Source::Amp,\n        Source::Droid,\n        Source::OpenClaw,\n        Source::Pi,\n    ];\n\n    let data = loader.load(\u0026all_sources)?;\n\n    println!(\"Loaded {} models\", data.models.len());\n    println!(\"Total cost: ${:.2}\", data.total_cost);\n\n    println!(\"\\nAll models (source:model):\");\n    let mut models = data.models.clone();\n    models.sort_by(|a, b| {\n        let source_cmp = a.source.cmp(\u0026b.source);\n        if source_cmp == std::cmp::Ordering::Equal {\n            a.model.cmp(\u0026b.model)\n        } else {\n            source_cmp\n        }\n    });\n    for m in \u0026models {\n        println!(\"{}:{}\", m.source.to_lowercase(), m.model);\n    }\n\n    Ok(())\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":127},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","settings.rs"],"content":"use std::fs;\nuse std::path::PathBuf;\nuse std::time::Duration;\n\nuse anyhow::Result;\nuse serde::{Deserialize, Serialize};\n\nuse super::themes::ThemeName;\n\nconst DEFAULT_AUTO_REFRESH_MS: u64 = 60_000;\nconst MIN_AUTO_REFRESH_MS: u64 = 30_000;\nconst MAX_AUTO_REFRESH_MS: u64 = 3_600_000;\n\nconst DEFAULT_NATIVE_TIMEOUT_MS: u64 = 300_000;\nconst MIN_NATIVE_TIMEOUT_MS: u64 = 5_000;\nconst MAX_NATIVE_TIMEOUT_MS: u64 = 3_600_000;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\npub struct Settings {\n    #[serde(default = \"default_color_palette\")]\n    pub color_palette: String,\n    #[serde(default)]\n    pub auto_refresh_enabled: bool,\n    #[serde(default = \"default_auto_refresh_ms\")]\n    pub auto_refresh_ms: u64,\n    #[serde(default)]\n    pub include_unused_models: bool,\n    #[serde(default = \"default_native_timeout_ms\")]\n    pub native_timeout_ms: u64,\n}\n\nfn default_color_palette() -\u003e String {\n    \"blue\".to_string()\n}\n\nfn default_auto_refresh_ms() -\u003e u64 {\n    DEFAULT_AUTO_REFRESH_MS\n}\n\nfn default_native_timeout_ms() -\u003e u64 {\n    DEFAULT_NATIVE_TIMEOUT_MS\n}\n\nimpl Default for Settings {\n    fn default() -\u003e Self {\n        Self {\n            color_palette: default_color_palette(),\n            auto_refresh_enabled: false,\n            auto_refresh_ms: DEFAULT_AUTO_REFRESH_MS,\n            include_unused_models: false,\n            native_timeout_ms: DEFAULT_NATIVE_TIMEOUT_MS,\n        }\n    }\n}\n\nimpl Settings {\n    fn config_path() -\u003e Result\u003cPathBuf\u003e {\n        let config_dir = dirs::config_dir()\n            .ok_or_else(|| anyhow::anyhow!(\"Could not find config directory\"))?\n            .join(\"tokscale\");\n\n        if !config_dir.exists() {\n            fs::create_dir_all(\u0026config_dir)?;\n        }\n\n        Ok(config_dir.join(\"settings.json\"))\n    }\n\n    pub fn load() -\u003e Self {\n        Self::config_path()\n            .ok()\n            .and_then(|path| fs::read_to_string(path).ok())\n            .and_then(|content| serde_json::from_str(\u0026content).ok())\n            .map(|mut s: Settings| {\n                s.auto_refresh_ms = s\n                    .auto_refresh_ms\n                    .clamp(MIN_AUTO_REFRESH_MS, MAX_AUTO_REFRESH_MS);\n                s.native_timeout_ms = s\n                    .native_timeout_ms\n                    .clamp(MIN_NATIVE_TIMEOUT_MS, MAX_NATIVE_TIMEOUT_MS);\n                s\n            })\n            .unwrap_or_default()\n    }\n\n    pub fn save(\u0026self) -\u003e Result\u003c()\u003e {\n        let path = Self::config_path()?;\n        let content = serde_json::to_string_pretty(self)?;\n        fs::write(path, content)?;\n        Ok(())\n    }\n\n    pub fn theme_name(\u0026self) -\u003e ThemeName {\n        self.color_palette.parse().unwrap_or(ThemeName::Blue)\n    }\n\n    pub fn set_theme(\u0026mut self, theme: ThemeName) {\n        self.color_palette = theme.as_str().to_string();\n    }\n\n    pub fn get_auto_refresh_interval(\u0026self) -\u003e Option\u003cDuration\u003e {\n        if self.auto_refresh_enabled \u0026\u0026 self.auto_refresh_ms \u003e 0 {\n            Some(Duration::from_millis(self.auto_refresh_ms))\n        } else {\n            None\n        }\n    }\n\n    pub fn get_native_timeout(\u0026self) -\u003e Duration {\n        let timeout_ms = if let Ok(env_val) = std::env::var(\"TOKSCALE_NATIVE_TIMEOUT_MS\") {\n            env_val.parse::\u003cu64\u003e().unwrap_or(self.native_timeout_ms)\n        } else {\n            self.native_timeout_ms\n        };\n\n        let clamped = timeout_ms.clamp(MIN_NATIVE_TIMEOUT_MS, MAX_NATIVE_TIMEOUT_MS);\n        Duration::from_millis(clamped)\n    }\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":6}},{"line":59,"address":[],"length":0,"stats":{"Line":12}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":63,"address":[],"length":0,"stats":{"Line":6}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":6}},{"line":70,"address":[],"length":0,"stats":{"Line":6}},{"line":71,"address":[],"length":0,"stats":{"Line":6}},{"line":73,"address":[],"length":0,"stats":{"Line":24}},{"line":74,"address":[],"length":0,"stats":{"Line":24}},{"line":75,"address":[],"length":0,"stats":{"Line":12}},{"line":76,"address":[],"length":0,"stats":{"Line":6}},{"line":77,"address":[],"length":0,"stats":{"Line":6}},{"line":78,"address":[],"length":0,"stats":{"Line":6}},{"line":79,"address":[],"length":0,"stats":{"Line":6}},{"line":80,"address":[],"length":0,"stats":{"Line":6}},{"line":81,"address":[],"length":0,"stats":{"Line":6}},{"line":82,"address":[],"length":0,"stats":{"Line":6}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":6}},{"line":103,"address":[],"length":0,"stats":{"Line":6}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":6}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}}],"covered":20,"coverable":45},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","themes.rs"],"content":"use ratatui::style::Color;\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ThemeName {\n    Green,\n    Halloween,\n    Teal,\n    Blue,\n    Pink,\n    Purple,\n    Orange,\n    Monochrome,\n    YlGnBu,\n}\n\nimpl ThemeName {\n    pub fn all() -\u003e \u0026'static [ThemeName] {\n        \u0026[\n            ThemeName::Green,\n            ThemeName::Halloween,\n            ThemeName::Teal,\n            ThemeName::Blue,\n            ThemeName::Pink,\n            ThemeName::Purple,\n            ThemeName::Orange,\n            ThemeName::Monochrome,\n            ThemeName::YlGnBu,\n        ]\n    }\n\n    pub fn next(self) -\u003e ThemeName {\n        let themes = Self::all();\n        let idx = themes.iter().position(|\u0026t| t == self).unwrap_or(0);\n        themes[(idx + 1) % themes.len()]\n    }\n\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            ThemeName::Green =\u003e \"green\",\n            ThemeName::Halloween =\u003e \"halloween\",\n            ThemeName::Teal =\u003e \"teal\",\n            ThemeName::Blue =\u003e \"blue\",\n            ThemeName::Pink =\u003e \"pink\",\n            ThemeName::Purple =\u003e \"purple\",\n            ThemeName::Orange =\u003e \"orange\",\n            ThemeName::Monochrome =\u003e \"monochrome\",\n            ThemeName::YlGnBu =\u003e \"ylgnbu\",\n        }\n    }\n}\n\nimpl std::str::FromStr for ThemeName {\n    type Err = ();\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match s.to_lowercase().as_str() {\n            \"green\" =\u003e Ok(ThemeName::Green),\n            \"halloween\" =\u003e Ok(ThemeName::Halloween),\n            \"teal\" =\u003e Ok(ThemeName::Teal),\n            \"blue\" =\u003e Ok(ThemeName::Blue),\n            \"pink\" =\u003e Ok(ThemeName::Pink),\n            \"purple\" =\u003e Ok(ThemeName::Purple),\n            \"orange\" =\u003e Ok(ThemeName::Orange),\n            \"monochrome\" =\u003e Ok(ThemeName::Monochrome),\n            \"ylgnbu\" =\u003e Ok(ThemeName::YlGnBu),\n            _ =\u003e Err(()),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct Theme {\n    pub name: ThemeName,\n    pub colors: [Color; 5],\n    pub background: Color,\n    pub foreground: Color,\n    pub border: Color,\n    pub highlight: Color,\n    pub muted: Color,\n    pub accent: Color,\n    pub selection: Color,\n}\n\nimpl Theme {\n    pub fn from_name(name: ThemeName) -\u003e Self {\n        let colors = match name {\n            // Colors match frontend contribution graph palettes (higher grade = darker = more activity)\n            ThemeName::Green =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(155, 233, 168), // grade1: #9be9a8\n                Color::Rgb(64, 196, 99),   // grade2: #40c463\n                Color::Rgb(48, 161, 78),   // grade3: #30a14e\n                Color::Rgb(33, 110, 57),   // grade4: #216e39\n            ],\n            ThemeName::Halloween =\u003e [\n                Color::Rgb(22, 27, 34),   // grade0: empty\n                Color::Rgb(255, 238, 74), // grade1: #FFEE4A\n                Color::Rgb(255, 197, 1),  // grade2: #FFC501\n                Color::Rgb(254, 150, 0),  // grade3: #FE9600\n                Color::Rgb(3, 0, 28),     // grade4: #03001C\n            ],\n            ThemeName::Teal =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(126, 229, 229), // grade1: #7ee5e5\n                Color::Rgb(45, 197, 197),  // grade2: #2dc5c5\n                Color::Rgb(13, 158, 158),  // grade3: #0d9e9e\n                Color::Rgb(14, 109, 109),  // grade4: #0e6d6d\n            ],\n            ThemeName::Blue =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(121, 184, 255), // grade1: #79b8ff\n                Color::Rgb(56, 139, 253),  // grade2: #388bfd\n                Color::Rgb(31, 111, 235),  // grade3: #1f6feb\n                Color::Rgb(13, 65, 157),   // grade4: #0d419d\n            ],\n            ThemeName::Pink =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(240, 181, 210), // grade1: #f0b5d2\n                Color::Rgb(217, 97, 160),  // grade2: #d961a0\n                Color::Rgb(191, 75, 138),  // grade3: #bf4b8a\n                Color::Rgb(153, 40, 110),  // grade4: #99286e\n            ],\n            ThemeName::Purple =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(205, 180, 255), // grade1: #cdb4ff\n                Color::Rgb(163, 113, 247), // grade2: #a371f7\n                Color::Rgb(137, 87, 229),  // grade3: #8957e5\n                Color::Rgb(110, 64, 201),  // grade4: #6e40c9\n            ],\n            ThemeName::Orange =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(255, 214, 153), // grade1: #ffd699\n                Color::Rgb(255, 179, 71),  // grade2: #ffb347\n                Color::Rgb(255, 140, 0),   // grade3: #ff8c00\n                Color::Rgb(204, 85, 0),    // grade4: #cc5500\n            ],\n            ThemeName::Monochrome =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(158, 158, 158), // grade1: #9e9e9e\n                Color::Rgb(117, 117, 117), // grade2: #757575\n                Color::Rgb(66, 66, 66),    // grade3: #424242\n                Color::Rgb(33, 33, 33),    // grade4: #212121\n            ],\n            ThemeName::YlGnBu =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(161, 218, 180), // grade1: #a1dab4\n                Color::Rgb(65, 182, 196),  // grade2: #41b6c4\n                Color::Rgb(44, 127, 184),  // grade3: #2c7fb8\n                Color::Rgb(37, 52, 148),   // grade4: #253494\n            ],\n        };\n\n        Self {\n            name,\n            colors,\n            background: Color::Rgb(13, 17, 23),\n            foreground: Color::Rgb(201, 209, 217),\n            border: Color::Rgb(48, 54, 61),\n            highlight: colors[4],\n            muted: Color::Rgb(139, 148, 158),\n            accent: Color::Cyan,\n            selection: Color::Rgb(48, 54, 61),\n        }\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":6}},{"line":56,"address":[],"length":0,"stats":{"Line":6}},{"line":57,"address":[],"length":0,"stats":{"Line":6}},{"line":58,"address":[],"length":0,"stats":{"Line":6}},{"line":59,"address":[],"length":0,"stats":{"Line":6}},{"line":60,"address":[],"length":0,"stats":{"Line":12}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":6}},{"line":86,"address":[],"length":0,"stats":{"Line":12}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":6}},{"line":110,"address":[],"length":0,"stats":{"Line":12}},{"line":111,"address":[],"length":0,"stats":{"Line":12}},{"line":112,"address":[],"length":0,"stats":{"Line":12}},{"line":113,"address":[],"length":0,"stats":{"Line":6}},{"line":114,"address":[],"length":0,"stats":{"Line":6}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":12}},{"line":157,"address":[],"length":0,"stats":{"Line":12}},{"line":158,"address":[],"length":0,"stats":{"Line":12}},{"line":159,"address":[],"length":0,"stats":{"Line":12}},{"line":160,"address":[],"length":0,"stats":{"Line":12}},{"line":162,"address":[],"length":0,"stats":{"Line":6}}],"covered":20,"coverable":100},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","bar_chart.rs"],"content":"use ratatui::prelude::*;\n\nuse super::widgets::format_tokens;\nuse crate::tui::app::App;\n\n/// 8-level block characters for sub-cell precision (matching OpenTUI)\nconst BLOCKS: \u0026[char] = \u0026[' ', 'â–', 'â–‚', 'â–ƒ', 'â–„', 'â–…', 'â–†', 'â–‡', 'â–ˆ'];\n\nconst MONTH_NAMES: \u0026[\u0026str] = \u0026[\n    \"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\",\n];\n\n/// A single model's contribution to a bar\n#[derive(Debug, Clone)]\npub struct ModelSegment {\n    pub model_id: String,\n    pub tokens: u64,\n    pub color: Color,\n}\n\n/// Data for a single bar in the stacked chart\n#[derive(Debug, Clone)]\npub struct StackedBarData {\n    pub date: String,\n    pub models: Vec\u003cModelSegment\u003e,\n    pub total: u64,\n}\n\n/// Render a stacked bar chart where each bar shows model breakdown\npub fn render_stacked_bar_chart(frame: \u0026mut Frame, app: \u0026App, area: Rect, data: \u0026[StackedBarData]) {\n    if data.is_empty() {\n        return;\n    }\n\n    let is_very_narrow = app.is_very_narrow();\n    let y_label_width: u16 = if is_very_narrow { 6 } else { 7 };\n\n    let chart_width = area.width.saturating_sub(y_label_width) as usize;\n    let chart_height = area.height.saturating_sub(3) as usize;\n\n    if chart_width == 0 || chart_height == 0 {\n        return;\n    }\n\n    let max_value = data\n        .iter()\n        .map(|d| d.total as f64)\n        .fold(0.0_f64, |a, b| a.max(b))\n        .max(1.0);\n\n    let buf = frame.buffer_mut();\n    let bar_count = data.len();\n\n    let get_bar_width = |index: usize| -\u003e usize {\n        if bar_count == 0 {\n            return 1;\n        }\n        let start = (index * chart_width) / bar_count;\n        let end = ((index + 1) * chart_width) / bar_count;\n        (end - start).max(1)\n    };\n\n    // Title\n    let title = if is_very_narrow {\n        \"Tokens\"\n    } else {\n        \"Tokens per Day\"\n    };\n    let title_y = area.y;\n    for (i, ch) in title.chars().enumerate() {\n        let x = area.x + y_label_width + i as u16;\n        if x \u003c area.x + area.width {\n            buf[(x, title_y)]\n                .set_char(ch)\n                .set_style(Style::default().add_modifier(Modifier::BOLD));\n        }\n    }\n\n    // Render bars row by row (from top to bottom visually, which is high values to low)\n    for row_from_bottom in (0..chart_height).rev() {\n        let row_index = chart_height - 1 - row_from_bottom;\n        let y = area.y + 1 + row_index as u16;\n\n        // Y-axis label (only at top)\n        let y_label = if row_from_bottom == chart_height - 1 {\n            format_tokens(max_value as u64)\n        } else {\n            String::new()\n        };\n        let padded_label = format!(\"{:\u003ewidth$}â”‚\", y_label, width = (y_label_width - 1) as usize);\n        for (i, ch) in padded_label.chars().enumerate() {\n            let x = area.x + i as u16;\n            if x \u003c area.x + y_label_width {\n                buf[(x, y)]\n                    .set_char(ch)\n                    .set_style(Style::default().fg(app.theme.muted));\n            }\n        }\n\n        // Render each bar\n        let mut x_pos = area.x + y_label_width;\n        for (bar_index, bar_data) in data.iter().enumerate() {\n            let bar_width = get_bar_width(bar_index);\n\n            let row_threshold = ((row_from_bottom + 1) as f64 / chart_height as f64) * max_value;\n            let prev_threshold = (row_from_bottom as f64 / chart_height as f64) * max_value;\n            let threshold_diff = row_threshold - prev_threshold;\n\n            let total = bar_data.total as f64;\n\n            // Get the character and color for this cell using stacked model logic\n            let (ch, fg_color) = get_stacked_bar_content(\n                bar_data,\n                total,\n                row_threshold,\n                prev_threshold,\n                threshold_diff,\n                app.theme.muted,\n                app.theme.highlight,\n            );\n\n            for _ in 0..bar_width {\n                if x_pos \u003c area.x + area.width {\n                    buf[(x_pos, y)].set_char(ch).set_fg(fg_color);\n                    x_pos += 1;\n                }\n            }\n        }\n    }\n\n    // X-axis\n    let axis_y = area.y + 1 + chart_height as u16;\n    if axis_y \u003c area.y + area.height {\n        let zero_label = format!(\"{:\u003ewidth$}â”‚\", \"0\", width = (y_label_width - 1) as usize);\n        for (i, ch) in zero_label.chars().enumerate() {\n            let x = area.x + i as u16;\n            if x \u003c area.x + y_label_width {\n                buf[(x, axis_y)]\n                    .set_char(ch)\n                    .set_style(Style::default().fg(app.theme.muted));\n            }\n        }\n        for x in (area.x + y_label_width)..(area.x + area.width) {\n            buf[(x, axis_y)]\n                .set_char('â”€')\n                .set_style(Style::default().fg(app.theme.muted));\n        }\n    }\n\n    // X-axis labels\n    let label_y = axis_y + 1;\n    if label_y \u003c area.y + area.height \u0026\u0026 !data.is_empty() {\n        let num_labels = if is_very_narrow { 2 } else { 3 };\n        let label_interval = (bar_count / num_labels).max(1);\n\n        for i in (0..bar_count).step_by(label_interval) {\n            let date_str = \u0026data[i].date;\n\n            let label = if let Some((month_str, day_str)) = date_str.split_once('/') {\n                if let (Ok(month), Ok(day)) = (month_str.parse::\u003cusize\u003e(), day_str.parse::\u003cu32\u003e()) {\n                    if (1..=12).contains(\u0026month) {\n                        if is_very_narrow {\n                            format!(\"{}/{}\", month, day)\n                        } else {\n                            format!(\"{} {}\", MONTH_NAMES[month - 1], day)\n                        }\n                    } else {\n                        date_str.clone()\n                    }\n                } else {\n                    date_str.clone()\n                }\n            } else {\n                date_str.clone()\n            };\n\n            let bar_start_x = (i * chart_width) / bar_count;\n            let label_x = area.x + y_label_width + bar_start_x as u16;\n\n            for (j, ch) in label.chars().enumerate() {\n                let x = label_x + j as u16;\n                if x \u003c area.x + area.width {\n                    buf[(x, label_y)]\n                        .set_char(ch)\n                        .set_style(Style::default().fg(app.theme.muted));\n                }\n            }\n        }\n    }\n}\n\nfn get_stacked_bar_content(\n    bar_data: \u0026StackedBarData,\n    total: f64,\n    row_threshold: f64,\n    prev_threshold: f64,\n    threshold_diff: f64,\n    muted_color: Color,\n    fallback_color: Color,\n) -\u003e (char, Color) {\n    if total \u003c= prev_threshold {\n        return (' ', muted_color);\n    }\n\n    if bar_data.models.is_empty() {\n        return (' ', muted_color);\n    }\n\n    // Note: Sorting happens per cell render. If performance becomes an issue,\n    // consider pre-sorting the model list before calling this function.\n    let mut sorted_models: Vec\u003c\u0026ModelSegment\u003e = bar_data.models.iter().collect();\n    sorted_models.sort_by(|a, b| a.model_id.cmp(\u0026b.model_id));\n\n    let row_start = prev_threshold;\n    let row_end = row_threshold;\n\n    let mut current_height: f64 = 0.0;\n    let mut max_overlap: f64 = 0.0;\n    let mut best_color = sorted_models\n        .first()\n        .map(|m| m.color)\n        .unwrap_or(fallback_color);\n\n    for model in \u0026sorted_models {\n        let m_start = current_height;\n        let m_end = current_height + model.tokens as f64;\n        current_height += model.tokens as f64;\n\n        let overlap_start = m_start.max(row_start);\n        let overlap_end = m_end.min(row_end);\n        let overlap = (overlap_end - overlap_start).max(0.0);\n\n        if overlap \u003e max_overlap {\n            max_overlap = overlap;\n            best_color = model.color;\n        }\n    }\n\n    if total \u003e= row_threshold {\n        return (BLOCKS[8], best_color);\n    }\n\n    let ratio = if threshold_diff \u003e 0.0 {\n        (total - prev_threshold) / threshold_diff\n    } else {\n        1.0\n    };\n    let block_index = (ratio * 8.0).floor().clamp(1.0, 8.0) as usize;\n    (BLOCKS[block_index], best_color)\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":127},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","daily.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{\n    Block, Borders, Cell, Paragraph, Row, Scrollbar, ScrollbarOrientation, ScrollbarState, Table,\n};\n\nuse super::widgets::{format_cost, format_tokens};\nuse crate::tui::app::{App, SortDirection, SortField};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Daily Usage \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let visible_height = inner.height.saturating_sub(1) as usize;\n    app.max_visible_items = visible_height;\n\n    let daily = app.get_sorted_daily();\n    if daily.is_empty() {\n        let empty_msg = Paragraph::new(\"No daily usage data found. Press 'r' to refresh.\")\n            .style(Style::default().fg(app.theme.muted))\n            .alignment(Alignment::Center);\n        frame.render_widget(empty_msg, inner);\n        return;\n    }\n\n    let is_narrow = app.is_narrow();\n    let is_very_narrow = app.is_very_narrow();\n    let sort_field = app.sort_field;\n    let sort_direction = app.sort_direction;\n    let scroll_offset = app.scroll_offset;\n    let selected_index = app.selected_index;\n    let theme_accent = app.theme.accent;\n    let theme_selection = app.theme.selection;\n\n    let header_cells = if is_very_narrow {\n        vec![\"Date\", \"Cost\"]\n    } else if is_narrow {\n        vec![\"Date\", \"Tokens\", \"Cost\"]\n    } else {\n        vec![\n            \"Date\",\n            \"Input\",\n            \"Output\",\n            \"Cache Read\",\n            \"Cache Write\",\n            \"Total\",\n            \"Cost\",\n        ]\n    };\n\n    let sort_indicator = |field: SortField| -\u003e \u0026'static str {\n        if sort_field == field {\n            match sort_direction {\n                SortDirection::Ascending =\u003e \" â–²\",\n                SortDirection::Descending =\u003e \" â–¼\",\n            }\n        } else {\n            \"\"\n        }\n    };\n\n    let header = Row::new(\n        header_cells\n            .iter()\n            .enumerate()\n            .map(|(i, h)| {\n                let indicator = match (i, is_narrow, is_very_narrow) {\n                    (0, _, _) =\u003e sort_indicator(SortField::Date),\n                    (5, false, false) =\u003e sort_indicator(SortField::Tokens),\n                    (1, true, false) =\u003e sort_indicator(SortField::Tokens),\n                    (6, false, false) =\u003e sort_indicator(SortField::Cost),\n                    (2, true, false) =\u003e sort_indicator(SortField::Cost),\n                    (1, _, true) =\u003e sort_indicator(SortField::Cost),\n                    _ =\u003e \"\",\n                };\n                Cell::from(format!(\"{}{}\", h, indicator))\n            })\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n    )\n    .style(\n        Style::default()\n            .fg(theme_accent)\n            .add_modifier(Modifier::BOLD),\n    )\n    .height(1);\n\n    let daily_len = daily.len();\n    let start = scroll_offset.min(daily_len);\n    let end = (start + visible_height).min(daily_len);\n\n    if start \u003e= daily_len {\n        return;\n    }\n\n    let rows: Vec\u003cRow\u003e = daily[start..end]\n        .iter()\n        .enumerate()\n        .map(|(i, day)| {\n            let idx = i + start;\n            let is_selected = idx == selected_index;\n            let is_striped = idx % 2 == 1;\n\n            let cells: Vec\u003cCell\u003e = if is_very_narrow {\n                vec![\n                    Cell::from(day.date.format(\"%m/%d\").to_string()),\n                    Cell::from(format_cost(day.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else if is_narrow {\n                vec![\n                    Cell::from(day.date.format(\"%Y-%m-%d\").to_string()),\n                    Cell::from(format_tokens(day.tokens.total())),\n                    Cell::from(format_cost(day.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else {\n                vec![\n                    Cell::from(day.date.format(\"%Y-%m-%d\").to_string())\n                        .style(Style::default().add_modifier(Modifier::BOLD)),\n                    Cell::from(format_tokens(day.tokens.input))\n                        .style(Style::default().fg(Color::Rgb(100, 200, 100))),\n                    Cell::from(format_tokens(day.tokens.output))\n                        .style(Style::default().fg(Color::Rgb(200, 100, 100))),\n                    Cell::from(format_tokens(day.tokens.cache_read))\n                        .style(Style::default().fg(Color::Rgb(100, 150, 200))),\n                    Cell::from(format_tokens(day.tokens.cache_write))\n                        .style(Style::default().fg(Color::Rgb(200, 150, 100))),\n                    Cell::from(format_tokens(day.tokens.total())),\n                    Cell::from(format_cost(day.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            };\n\n            let row_style = if is_selected {\n                Style::default().bg(theme_selection)\n            } else if is_striped {\n                Style::default().bg(Color::Rgb(20, 24, 30))\n            } else {\n                Style::default()\n            };\n\n            Row::new(cells).style(row_style).height(1)\n        })\n        .collect();\n\n    let widths = if is_very_narrow {\n        vec![Constraint::Percentage(60), Constraint::Percentage(40)]\n    } else if is_narrow {\n        vec![\n            Constraint::Percentage(40),\n            Constraint::Percentage(30),\n            Constraint::Percentage(30),\n        ]\n    } else {\n        vec![\n            Constraint::Length(12),\n            Constraint::Length(10),\n            Constraint::Length(10),\n            Constraint::Length(12),\n            Constraint::Length(12),\n            Constraint::Length(10),\n            Constraint::Length(10),\n        ]\n    };\n\n    let table = Table::new(rows, widths)\n        .header(header)\n        .row_highlight_style(Style::default().bg(theme_selection));\n\n    frame.render_widget(table, inner);\n\n    if daily_len \u003e visible_height {\n        let scrollbar = Scrollbar::new(ScrollbarOrientation::VerticalRight)\n            .begin_symbol(Some(\"â–²\"))\n            .end_symbol(Some(\"â–¼\"));\n\n        let mut scrollbar_state = ScrollbarState::new(daily_len).position(scroll_offset);\n\n        frame.render_stateful_widget(\n            scrollbar,\n            area.inner(Margin {\n                horizontal: 0,\n                vertical: 1,\n            }),\n            \u0026mut scrollbar_state,\n        );\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":124},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","footer.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Paragraph};\n\nuse super::spinner::{get_phase_message, get_scanner_spans};\nuse super::widgets::{format_cost, format_tokens};\nuse crate::tui::app::{App, ClickAction, SortField, Tab};\nuse crate::tui::data::Source;\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    // Split into 3 rows: sources+sort, help text, status\n    let row_constraints = if inner.height \u003e= 3 {\n        vec![\n            Constraint::Length(1),\n            Constraint::Length(1),\n            Constraint::Length(1),\n        ]\n    } else if inner.height \u003e= 2 {\n        vec![Constraint::Length(1), Constraint::Length(1)]\n    } else {\n        vec![Constraint::Length(1)]\n    };\n\n    let rows = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints(row_constraints)\n        .split(inner);\n\n    render_main_row(frame, app, rows[0]);\n\n    if rows.len() \u003e= 2 {\n        render_help_row(frame, app, rows[1]);\n    }\n\n    if rows.len() \u003e= 3 {\n        render_status_row(frame, app, rows[2]);\n    }\n}\n\nfn render_main_row(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n\n    // Split into left (sources) and right (sort + totals)\n    let chunks = Layout::default()\n        .direction(Direction::Horizontal)\n        .constraints([Constraint::Percentage(55), Constraint::Percentage(45)])\n        .split(area);\n\n    // Left side: source badges\n    render_source_badges(frame, app, chunks[0]);\n\n    // Right side: scroll info | tokens | cost (models)\n    let mut right_spans: Vec\u003cSpan\u003e = Vec::new();\n\n    // Scroll position indicator for Overview tab\n    if app.current_tab == Tab::Overview {\n        let total_models = app.data.models.len();\n        if total_models \u003e app.max_visible_items \u0026\u0026 app.max_visible_items \u003e 0 {\n            let start = app.scroll_offset + 1;\n            let end = (app.scroll_offset + app.max_visible_items).min(total_models);\n            if !is_very_narrow {\n                right_spans.push(Span::styled(\n                    format!(\"â†“ {}-{} of {} \", start, end, total_models),\n                    Style::default().fg(app.theme.muted),\n                ));\n                right_spans.push(Span::styled(\"| \", Style::default().fg(app.theme.muted)));\n            }\n        }\n    }\n\n    // Total tokens\n    let total_tokens = app.data.total_tokens;\n    right_spans.push(Span::styled(\n        format_tokens(total_tokens),\n        Style::default().fg(Color::Cyan),\n    ));\n    if !is_very_narrow {\n        right_spans.push(Span::styled(\n            \" tokens\",\n            Style::default().fg(app.theme.muted),\n        ));\n    }\n\n    right_spans.push(Span::styled(\" | \", Style::default().fg(app.theme.muted)));\n\n    // Total cost\n    right_spans.push(Span::styled(\n        format_cost(app.data.total_cost),\n        Style::default()\n            .fg(Color::Green)\n            .add_modifier(Modifier::BOLD),\n    ));\n\n    // Model count\n    if !is_very_narrow {\n        right_spans.push(Span::styled(\n            format!(\" ({} models)\", app.data.models.len()),\n            Style::default().fg(app.theme.muted),\n        ));\n    }\n\n    let right_line = Line::from(right_spans);\n    let right_para = Paragraph::new(right_line).alignment(Alignment::Right);\n    frame.render_widget(right_para, chunks[1]);\n}\n\nfn render_source_badges(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let mut spans: Vec\u003cSpan\u003e = Vec::new();\n    let mut x_offset = area.x;\n    let is_very_narrow = app.is_very_narrow();\n\n    let source_labels = [\n        (Source::OpenCode, \"1\", \"OC\"),\n        (Source::Claude, \"2\", \"CC\"),\n        (Source::Codex, \"3\", \"CX\"),\n        (Source::Cursor, \"4\", \"CR\"),\n        (Source::Gemini, \"5\", \"GM\"),\n        (Source::Amp, \"6\", \"AM\"),\n        (Source::Droid, \"7\", \"DR\"),\n        (Source::OpenClaw, \"8\", \"CL\"),\n        (Source::Pi, \"9\", \"PI\"),\n    ];\n\n    for (source, key, short) in source_labels {\n        let enabled = app.enabled_sources.contains(\u0026source);\n        let indicator = if enabled { \"â—\" } else { \"â—‹\" };\n\n        let badge_text = if is_very_narrow {\n            format!(\"[{}{}]\", indicator, key)\n        } else {\n            format!(\"[{}{}:{}]\", indicator, key, short)\n        };\n        let badge_width = badge_text.chars().count() as u16;\n\n        let style = if enabled {\n            Style::default().fg(Color::Green)\n        } else {\n            Style::default().fg(app.theme.muted)\n        };\n\n        spans.push(Span::styled(badge_text, style));\n        spans.push(Span::raw(\" \"));\n\n        app.add_click_area(\n            Rect::new(x_offset, area.y, badge_width, 1),\n            ClickAction::Source(source),\n        );\n        x_offset += badge_width + 1;\n    }\n\n    // Sort buttons (if not very narrow)\n    if !is_very_narrow {\n        spans.push(Span::styled(\"| \", Style::default().fg(app.theme.muted)));\n\n        let sort_buttons = [\n            (SortField::Date, \"Date\"),\n            (SortField::Cost, \"Cost\"),\n            (SortField::Tokens, \"Tok\"),\n        ];\n\n        for (field, label) in sort_buttons {\n            let is_active = app.sort_field == field;\n            let style = if is_active {\n                Style::default()\n                    .fg(app.theme.foreground)\n                    .add_modifier(Modifier::BOLD)\n            } else {\n                Style::default().fg(app.theme.muted)\n            };\n\n            spans.push(Span::styled(label, style));\n            spans.push(Span::raw(\" \"));\n\n            let btn_width = label.len() as u16;\n            app.add_click_area(\n                Rect::new(x_offset + 2, area.y, btn_width, 1),\n                ClickAction::Sort(field),\n            );\n            x_offset += btn_width + 1;\n        }\n    }\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line);\n    frame.render_widget(paragraph, area);\n}\n\nfn render_help_row(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n\n    let spans = if is_very_narrow {\n        vec![\n            Span::styled(\"â†‘â†“\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"â†â†’\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"y\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"[p]\", Style::default().fg(Color::Magenta)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"[r]\", Style::default().fg(Color::Yellow)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"q\", Style::default().fg(app.theme.muted)),\n        ]\n    } else {\n        vec![\n            Span::styled(\n                \"â†‘â†“ scroll â€¢ â†â†’/tab view â€¢ y copy â€¢ \",\n                Style::default().fg(app.theme.muted),\n            ),\n            Span::styled(\n                format!(\"[p:{}]\", app.theme.name.as_str()),\n                Style::default().fg(Color::Magenta),\n            ),\n            Span::styled(\" \", Style::default()),\n            Span::styled(\n                if app.auto_refresh {\n                    format!(\"[R:auto {}s]\", app.auto_refresh_interval.as_secs())\n                } else {\n                    \"[R:auto off]\".to_string()\n                },\n                Style::default().fg(if app.auto_refresh {\n                    Color::Green\n                } else {\n                    app.theme.muted\n                }),\n            ),\n            Span::styled(\" [-/+ interval] â€¢ \", Style::default().fg(app.theme.muted)),\n            Span::styled(\"[r:refresh]\", Style::default().fg(Color::Yellow)),\n            Span::styled(\" â€¢ e export â€¢ q quit\", Style::default().fg(app.theme.muted)),\n        ]\n    };\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line);\n    frame.render_widget(paragraph, area);\n}\n\nfn render_status_row(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let mut spans: Vec\u003cSpan\u003e = Vec::new();\n\n    if app.data.loading || app.background_loading {\n        let scanner_spans = get_scanner_spans(app.spinner_frame);\n        spans.extend(scanner_spans);\n        spans.push(Span::raw(\" \"));\n        spans.push(Span::styled(\n            get_phase_message(\"parsing-sources\"),\n            Style::default().fg(app.theme.muted),\n        ));\n    } else if let Some(ref msg) = app.status_message {\n        spans.push(Span::styled(\n            msg.clone(),\n            Style::default()\n                .fg(Color::Green)\n                .add_modifier(Modifier::BOLD),\n        ));\n    } else {\n        let elapsed = app.last_refresh.elapsed();\n        let ago = if elapsed.as_secs() \u003c 60 {\n            format!(\"{}s ago\", elapsed.as_secs())\n        } else if elapsed.as_secs() \u003c 3600 {\n            format!(\"{}m ago\", elapsed.as_secs() / 60)\n        } else {\n            format!(\"{}h ago\", elapsed.as_secs() / 3600)\n        };\n        spans.push(Span::styled(\n            format!(\"Last updated: {}\", ago),\n            Style::default().fg(app.theme.muted),\n        ));\n\n        if app.auto_refresh {\n            spans.push(Span::styled(\n                format!(\" â€¢ Auto: {}s\", app.auto_refresh_interval.as_secs()),\n                Style::default().fg(app.theme.muted),\n            ));\n        }\n    }\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line);\n    frame.render_widget(paragraph, area);\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":182},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","header.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Tabs};\n\nuse crate::tui::app::{App, ClickAction, Tab};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n\n    let titles: Vec\u003cLine\u003e = Tab::all()\n        .iter()\n        .map(|t| {\n            let name = if is_very_narrow {\n                t.short_name()\n            } else {\n                t.as_str()\n            };\n            let style = if *t == app.current_tab {\n                Style::default()\n                    .fg(app.theme.accent)\n                    .add_modifier(Modifier::BOLD)\n            } else {\n                Style::default().fg(app.theme.muted)\n            };\n            Line::from(Span::styled(name, style))\n        })\n        .collect();\n\n    let selected = Tab::all()\n        .iter()\n        .position(|t| *t == app.current_tab)\n        .unwrap_or(0);\n\n    let is_narrow = app.is_narrow();\n\n    let mut block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" tokscale \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .title_alignment(Alignment::Left)\n        .style(Style::default().bg(app.theme.background));\n\n    if !is_narrow {\n        block = block.title_top(\n            Line::from(vec![\n                Span::styled(\" | \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\"GitHub \", Style::default().fg(Color::Rgb(102, 102, 102))),\n            ])\n            .right_aligned(),\n        );\n    }\n\n    let tabs = Tabs::new(titles)\n        .block(block)\n        .select(selected)\n        .highlight_style(\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        )\n        .divider(Span::styled(\" â”‚ \", Style::default().fg(app.theme.border)));\n\n    frame.render_widget(tabs, area);\n\n    register_tab_click_areas(app, area);\n}\n\nfn register_tab_click_areas(app: \u0026mut App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n    let inner_x = area.x + 12;\n    let y = area.y + 1;\n    let mut x = inner_x;\n\n    for tab in Tab::all() {\n        let name_len = if is_very_narrow {\n            tab.short_name().len()\n        } else {\n            tab.as_str().len()\n        };\n        let width = name_len as u16 + 3;\n        app.add_click_area(Rect::new(x, y, width, 1), ClickAction::Tab(*tab));\n        x += width;\n    }\n}\n","traces":[{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":52},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","mod.rs"],"content":"mod bar_chart;\nmod daily;\nmod footer;\nmod header;\nmod models;\nmod overview;\npub mod spinner;\nmod stats;\nmod widgets;\n\nuse ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Paragraph};\n\nuse crate::tui::app::{App, Tab};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App) {\n    let area = frame.area();\n    if area.width == 0 || area.height == 0 {\n        return;\n    }\n\n    app.clear_click_areas();\n    app.handle_resize(area.width, area.height);\n\n    let chunks = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Length(3),\n            Constraint::Min(0),\n            Constraint::Length(5),\n        ])\n        .split(area);\n\n    header::render(frame, app, chunks[0]);\n\n    if app.data.loading \u0026\u0026 !app.background_loading {\n        render_loading(frame, app, chunks[1]);\n    } else if let Some(ref error) = app.data.error {\n        render_error(frame, app, chunks[1], error);\n    } else {\n        match app.current_tab {\n            Tab::Overview =\u003e overview::render(frame, app, chunks[1]),\n            Tab::Models =\u003e models::render(frame, app, chunks[1]),\n            Tab::Daily =\u003e daily::render(frame, app, chunks[1]),\n            Tab::Stats =\u003e stats::render(frame, app, chunks[1]),\n        }\n    }\n\n    footer::render(frame, app, chunks[2]);\n}\n\nfn render_loading(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let center = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Percentage(40),\n            Constraint::Length(3),\n            Constraint::Percentage(40),\n        ])\n        .split(inner)[1];\n\n    let mut spans = spinner::get_scanner_spans(app.spinner_frame);\n    spans.push(Span::raw(\"  \"));\n    spans.push(Span::styled(\n        spinner::get_phase_message(\"parsing-sources\"),\n        Style::default().fg(app.theme.muted),\n    ));\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line).alignment(Alignment::Center);\n\n    frame.render_widget(paragraph, center);\n}\n\nfn render_error(frame: \u0026mut Frame, app: \u0026App, area: Rect, error: \u0026str) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let center = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Percentage(40),\n            Constraint::Length(3),\n            Constraint::Percentage(40),\n        ])\n        .split(inner)[1];\n\n    let text = format!(\"Error: {}\", error);\n    let paragraph = Paragraph::new(text)\n        .style(Style::default().fg(Color::Red))\n        .alignment(Alignment::Center);\n\n    frame.render_widget(paragraph, center);\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":65},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","models.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{\n    Block, Borders, Cell, Paragraph, Row, Scrollbar, ScrollbarOrientation, ScrollbarState, Table,\n};\n\nuse super::widgets::{\n    format_cost, format_tokens, get_model_color, get_provider_display_name, get_source_display_name,\n};\nuse crate::tui::app::{App, SortDirection, SortField};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Models \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let visible_height = inner.height.saturating_sub(1) as usize;\n    app.max_visible_items = visible_height;\n\n    let is_narrow = app.is_narrow();\n    let is_very_narrow = app.is_very_narrow();\n    let sort_field = app.sort_field;\n    let sort_direction = app.sort_direction;\n    let scroll_offset = app.scroll_offset;\n    let selected_index = app.selected_index;\n    let theme_accent = app.theme.accent;\n    let theme_muted = app.theme.muted;\n    let theme_selection = app.theme.selection;\n\n    let models = app.get_sorted_models();\n    if models.is_empty() {\n        let empty_msg =\n            Paragraph::new(\"No usage data found. Press 'r' to refresh or toggle sources with 1-8.\")\n                .style(Style::default().fg(theme_muted))\n                .alignment(Alignment::Center);\n        frame.render_widget(empty_msg, inner);\n        return;\n    }\n\n    let header_cells = if is_very_narrow {\n        vec![\"Model\", \"Cost\"]\n    } else if is_narrow {\n        vec![\"Model\", \"Tokens\", \"Cost\"]\n    } else {\n        vec![\n            \"#\",\n            \"Model\",\n            \"Provider\",\n            \"Source\",\n            \"Input\",\n            \"Output\",\n            \"Cache Read\",\n            \"Cache Write\",\n            \"Total\",\n            \"Cost\",\n        ]\n    };\n\n    let sort_indicator = |field: SortField| -\u003e \u0026'static str {\n        if sort_field == field {\n            match sort_direction {\n                SortDirection::Ascending =\u003e \" â–²\",\n                SortDirection::Descending =\u003e \" â–¼\",\n            }\n        } else {\n            \"\"\n        }\n    };\n\n    let header = Row::new(\n        header_cells\n            .iter()\n            .enumerate()\n            .map(|(i, h)| {\n                let indicator = match i {\n                    8 if !is_narrow =\u003e sort_indicator(SortField::Tokens),\n                    9 if !is_narrow =\u003e sort_indicator(SortField::Cost),\n                    1 if is_very_narrow =\u003e sort_indicator(SortField::Cost),\n                    2 if is_narrow \u0026\u0026 !is_very_narrow =\u003e sort_indicator(SortField::Cost),\n                    1 if is_narrow \u0026\u0026 !is_very_narrow =\u003e sort_indicator(SortField::Tokens),\n                    _ =\u003e \"\",\n                };\n                Cell::from(format!(\"{}{}\", h, indicator))\n            })\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n    )\n    .style(\n        Style::default()\n            .fg(theme_accent)\n            .add_modifier(Modifier::BOLD),\n    )\n    .height(1);\n\n    let models_len = models.len();\n    let start = scroll_offset.min(models_len.saturating_sub(1));\n    let end = (start + visible_height).min(models_len);\n\n    if start \u003e= models_len {\n        return;\n    }\n\n    let rows: Vec\u003cRow\u003e = models[start..end]\n        .iter()\n        .enumerate()\n        .map(|(i, model)| {\n            let idx = i + start;\n            let is_selected = idx == selected_index;\n            let is_striped = idx % 2 == 1;\n\n            let model_color = get_model_color(\u0026model.model);\n\n            let cells: Vec\u003cCell\u003e = if is_very_narrow {\n                vec![\n                    Cell::from(truncate(\u0026model.model, 15)).style(Style::default().fg(model_color)),\n                    Cell::from(format_cost(model.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else if is_narrow {\n                vec![\n                    Cell::from(truncate(\u0026model.model, 25)).style(Style::default().fg(model_color)),\n                    Cell::from(format_tokens(model.tokens.total())),\n                    Cell::from(format_cost(model.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else {\n                vec![\n                    Cell::from(format!(\"{}\", idx + 1)).style(Style::default().fg(theme_muted)),\n                    Cell::from(truncate(\u0026model.model, 30)).style(\n                        Style::default()\n                            .fg(model_color)\n                            .add_modifier(Modifier::BOLD),\n                    ),\n                    Cell::from(get_provider_display_name(\u0026model.provider)),\n                    Cell::from(get_source_display_name(\u0026model.source))\n                        .style(Style::default().fg(theme_muted)),\n                    Cell::from(format_tokens(model.tokens.input))\n                        .style(Style::default().fg(Color::Rgb(100, 200, 100))),\n                    Cell::from(format_tokens(model.tokens.output))\n                        .style(Style::default().fg(Color::Rgb(200, 100, 100))),\n                    Cell::from(format_tokens(model.tokens.cache_read))\n                        .style(Style::default().fg(Color::Rgb(100, 150, 200))),\n                    Cell::from(format_tokens(model.tokens.cache_write))\n                        .style(Style::default().fg(Color::Rgb(200, 150, 100))),\n                    Cell::from(format_tokens(model.tokens.total())),\n                    Cell::from(format_cost(model.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            };\n\n            let row_style = if is_selected {\n                Style::default().bg(theme_selection)\n            } else if is_striped {\n                Style::default().bg(Color::Rgb(20, 24, 30))\n            } else {\n                Style::default()\n            };\n\n            Row::new(cells).style(row_style).height(1)\n        })\n        .collect();\n\n    let widths = if is_very_narrow {\n        vec![Constraint::Percentage(70), Constraint::Percentage(30)]\n    } else if is_narrow {\n        vec![\n            Constraint::Percentage(50),\n            Constraint::Percentage(25),\n            Constraint::Percentage(25),\n        ]\n    } else {\n        vec![\n            Constraint::Length(3),\n            Constraint::Min(20),\n            Constraint::Length(18),\n            Constraint::Length(14),\n            Constraint::Length(10),\n            Constraint::Length(10),\n            Constraint::Length(12),\n            Constraint::Length(12),\n            Constraint::Length(10),\n            Constraint::Length(10),\n        ]\n    };\n\n    let table = Table::new(rows, widths)\n        .header(header)\n        .row_highlight_style(Style::default().bg(theme_selection));\n\n    frame.render_widget(table, inner);\n\n    if models_len \u003e visible_height {\n        let scrollbar = Scrollbar::new(ScrollbarOrientation::VerticalRight)\n            .begin_symbol(Some(\"â–²\"))\n            .end_symbol(Some(\"â–¼\"));\n\n        let mut scrollbar_state = ScrollbarState::new(models_len).position(scroll_offset);\n\n        frame.render_stateful_widget(\n            scrollbar,\n            area.inner(Margin {\n                horizontal: 0,\n                vertical: 1,\n            }),\n            \u0026mut scrollbar_state,\n        );\n    }\n}\n\nfn truncate(s: \u0026str, max_chars: usize) -\u003e String {\n    if max_chars == 0 {\n        return String::new();\n    }\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        s.to_string()\n    } else if max_chars \u003c= 3 {\n        s.chars().take(max_chars).collect()\n    } else {\n        let head: String = s.chars().take(max_chars - 3).collect();\n        format!(\"{}...\", head)\n    }\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":145},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","overview.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{\n    Block, Borders, Paragraph, Scrollbar, ScrollbarOrientation, ScrollbarState,\n};\n\nuse super::bar_chart::{render_stacked_bar_chart, ModelSegment, StackedBarData};\nuse super::widgets::{format_tokens, get_model_color};\nuse crate::tui::app::App;\n\nstruct ModelRowData {\n    model: String,\n    tokens_input: u64,\n    tokens_output: u64,\n    tokens_cache_read: u64,\n    tokens_cache_write: u64,\n    cost: f64,\n}\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let safe_height = area.height.max(12) as usize;\n    let chart_height = (safe_height as f64 * 0.35).floor().max(5.0) as u16;\n    let legend_height = 1u16;\n\n    let chunks = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Length(chart_height),\n            Constraint::Length(legend_height),\n            Constraint::Min(0),\n        ])\n        .split(area);\n\n    let list_area_height = chunks[2].height.saturating_sub(2);\n    let items_per_page = ((list_area_height / 2) as usize).max(1);\n    app.max_visible_items = items_per_page;\n\n    render_chart(frame, app, chunks[0]);\n    render_legend(frame, app, chunks[1]);\n    render_top_models(frame, app, chunks[2], items_per_page);\n}\n\nfn render_chart(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let daily = \u0026app.data.daily;\n    let mut sorted_daily: Vec\u003c_\u003e = daily.iter().collect();\n    sorted_daily.sort_by(|a, b| a.date.cmp(\u0026b.date));\n\n    let data: Vec\u003cStackedBarData\u003e = sorted_daily\n        .iter()\n        .rev()\n        .take(60)\n        .rev()\n        .map(|d| {\n            let date = d.date.format(\"%m/%d\").to_string();\n            let total = d.tokens.total();\n\n            let models: Vec\u003cModelSegment\u003e = d\n                .models\n                .iter()\n                .map(|(model_name, info)| ModelSegment {\n                    model_id: model_name.clone(),\n                    tokens: info.tokens.total(),\n                    color: get_model_color(model_name),\n                })\n                .collect();\n\n            StackedBarData {\n                date,\n                models,\n                total,\n            }\n        })\n        .collect();\n\n    render_stacked_bar_chart(frame, app, area, \u0026data);\n}\n\nfn render_legend(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let legend_limit = if app.is_narrow() { 3 } else { 5 };\n    let max_name_width = if app.is_narrow() { 12 } else { 18 };\n    let muted_color = app.theme.muted;\n\n    let top_models: Vec\u003c(String, Color)\u003e = app\n        .get_sorted_models()\n        .iter()\n        .take(legend_limit)\n        .map(|m| (m.model.clone(), get_model_color(\u0026m.model)))\n        .collect();\n\n    if top_models.is_empty() {\n        return;\n    }\n\n    let mut spans: Vec\u003cSpan\u003e = Vec::new();\n    for (i, (model_name, color)) in top_models.iter().enumerate() {\n        let name = truncate_string(model_name, max_name_width);\n\n        spans.push(Span::styled(\"â—\", Style::default().fg(*color)));\n        spans.push(Span::raw(format!(\" {}\", name)));\n\n        if i \u003c top_models.len() - 1 {\n            spans.push(Span::styled(\"  Â·\", Style::default().fg(muted_color)));\n        }\n    }\n\n    let legend_line = Line::from(spans);\n    let paragraph = Paragraph::new(legend_line);\n    frame.render_widget(paragraph, area);\n}\n\nfn render_top_models(frame: \u0026mut Frame, app: \u0026mut App, area: Rect, items_per_page: usize) {\n    use super::widgets::format_cost;\n    use crate::tui::app::SortField;\n\n    let theme_border = app.theme.border;\n    let theme_accent = app.theme.accent;\n    let theme_background = app.theme.background;\n    let theme_muted = app.theme.muted;\n    let theme_foreground = app.theme.foreground;\n    let theme_selection = app.theme.selection;\n    let scroll_offset = app.scroll_offset;\n    let selected_index = app.selected_index;\n    let is_narrow = app.is_narrow();\n    let is_very_narrow = app.is_very_narrow();\n    let sort_field = app.sort_field;\n    let total_cost = app.data.total_cost;\n\n    let models_data: Vec\u003cModelRowData\u003e = app\n        .get_sorted_models()\n        .iter()\n        .map(|m| ModelRowData {\n            model: m.model.clone(),\n            tokens_input: m.tokens.input,\n            tokens_output: m.tokens.output,\n            tokens_cache_read: m.tokens.cache_read,\n            tokens_cache_write: m.tokens.cache_write,\n            cost: m.cost,\n        })\n        .collect();\n\n    let title = if is_very_narrow {\n        \"Top Models\".to_string()\n    } else {\n        match sort_field {\n            SortField::Tokens =\u003e \"Models by Tokens\".to_string(),\n            _ =\u003e \"Models by Cost\".to_string(),\n        }\n    };\n\n    let title_right = if is_very_narrow {\n        format_cost(total_cost)\n    } else {\n        format!(\"Total: {}\", format_cost(total_cost))\n    };\n\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(theme_border))\n        .title(Span::styled(\n            format!(\" {} \", title),\n            Style::default()\n                .fg(theme_accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .title_top(\n            Line::from(Span::styled(\n                format!(\" {} \", title_right),\n                Style::default().fg(Color::Green),\n            ))\n            .right_aligned(),\n        )\n        .style(Style::default().bg(theme_background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    if models_data.is_empty() {\n        let empty = Paragraph::new(\"No data available\")\n            .style(Style::default().fg(theme_muted))\n            .alignment(Alignment::Center);\n        frame.render_widget(empty, inner);\n        return;\n    }\n\n    let total = models_data\n        .iter()\n        .map(|m| if m.cost.is_finite() { m.cost } else { 0.0 })\n        .sum::\u003cf64\u003e()\n        .max(0.01);\n    let models_len = models_data.len();\n    let start = scroll_offset.min(models_len);\n    let end = (start + items_per_page).min(models_len);\n    let max_name_width = if is_narrow { 20 } else { 35 };\n\n    if start \u003e= models_len {\n        return;\n    }\n\n    let mut y = inner.y;\n    for (i, model) in models_data[start..end].iter().enumerate() {\n        if y + 1 \u003e= inner.y + inner.height {\n            break;\n        }\n\n        let idx = i + start;\n        let is_selected = idx == selected_index;\n        let row_style = if is_selected {\n            Style::default().bg(theme_selection).fg(theme_foreground)\n        } else {\n            Style::default()\n        };\n\n        let model_color = get_model_color(\u0026model.model);\n        let name = truncate_string(\u0026model.model, max_name_width);\n        let percentage = if model.cost.is_finite() \u0026\u0026 total.is_finite() \u0026\u0026 total \u003e 0.0 {\n            (model.cost / total) * 100.0\n        } else {\n            0.0\n        };\n\n        let line1_area = Rect::new(inner.x, y, inner.width, 1);\n        frame.render_widget(Paragraph::new(\"\").style(row_style), line1_area);\n\n        let line1_spans = vec![\n            Span::styled(\"â—\", Style::default().fg(model_color)),\n            Span::styled(\n                format!(\" {}\", name),\n                Style::default()\n                    .fg(if is_selected {\n                        theme_foreground\n                    } else {\n                        model_color\n                    })\n                    .add_modifier(Modifier::BOLD),\n            ),\n            Span::styled(\n                format!(\" ({:.1}%)\", percentage),\n                Style::default().fg(theme_muted),\n            ),\n        ];\n        let line1 = Line::from(line1_spans);\n        let line1_para = Paragraph::new(line1).style(row_style);\n        frame.render_widget(line1_para, line1_area);\n\n        y += 1;\n        if y \u003e= inner.y + inner.height {\n            break;\n        }\n\n        let line2_area = Rect::new(inner.x, y, inner.width, 1);\n        frame.render_widget(Paragraph::new(\"\").style(row_style), line2_area);\n\n        let line2_spans = if is_narrow {\n            vec![\n                Span::raw(\"  \"),\n                Span::styled(\n                    format_tokens(model.tokens_input),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_output),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_read),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_write),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n            ]\n        } else {\n            vec![\n                Span::styled(\"  In: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_input),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\" Â· Out: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_output),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\" Â· CR: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_read),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\" Â· CW: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_write),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n            ]\n        };\n\n        let line2 = Line::from(line2_spans);\n        let line2_para = Paragraph::new(line2).style(row_style);\n        frame.render_widget(line2_para, line2_area);\n\n        y += 1;\n    }\n\n    if models_len \u003e items_per_page {\n        let scrollbar = Scrollbar::new(ScrollbarOrientation::VerticalRight)\n            .begin_symbol(Some(\"â–²\"))\n            .end_symbol(Some(\"â–¼\"))\n            .track_symbol(Some(\"â”‚\"))\n            .thumb_symbol(\"â–ˆ\");\n\n        let mut scrollbar_state = ScrollbarState::new(models_len).position(scroll_offset);\n\n        frame.render_stateful_widget(\n            scrollbar,\n            inner.inner(Margin {\n                horizontal: 0,\n                vertical: 0,\n            }),\n            \u0026mut scrollbar_state,\n        );\n    }\n}\n\nfn truncate_string(s: \u0026str, max_chars: usize) -\u003e String {\n    if max_chars == 0 {\n        return String::new();\n    }\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        s.to_string()\n    } else if max_chars == 1 {\n        \"â€¦\".to_string()\n    } else {\n        let head: String = s.chars().take(max_chars - 1).collect();\n        format!(\"{}â€¦\", head)\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":212},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","spinner.rs"],"content":"use ratatui::prelude::*;\n\nconst WIDTH: usize = 8;\nconst HOLD_START: usize = 30;\nconst HOLD_END: usize = 9;\nconst TRAIL_LENGTH: usize = 4;\n\nconst TRAIL_COLORS: \u0026[Color] = \u0026[\n    Color::Rgb(0, 255, 255), // #00FFFF - cyan\n    Color::Rgb(0, 215, 215), // #00D7D7\n    Color::Rgb(0, 175, 175), // #00AFAF\n    Color::Rgb(0, 135, 135), // #008787\n];\nconst INACTIVE_COLOR: Color = Color::Rgb(68, 68, 68);\n\npub struct ScannerState {\n    pub position: usize,\n    pub forward: bool,\n}\n\npub fn get_scanner_state(frame: usize) -\u003e ScannerState {\n    let forward_frames = WIDTH;\n    let backward_frames = WIDTH - 1;\n    let total_cycle = forward_frames + HOLD_END + backward_frames + HOLD_START;\n    let normalized = frame % total_cycle;\n\n    if normalized \u003c forward_frames {\n        ScannerState {\n            position: normalized,\n            forward: true,\n        }\n    } else if normalized \u003c forward_frames + HOLD_END {\n        ScannerState {\n            position: WIDTH - 1,\n            forward: true,\n        }\n    } else if normalized \u003c forward_frames + HOLD_END + backward_frames {\n        ScannerState {\n            position: WIDTH - 2 - (normalized - forward_frames - HOLD_END),\n            forward: false,\n        }\n    } else {\n        ScannerState {\n            position: 0,\n            forward: false,\n        }\n    }\n}\n\npub fn get_scanner_spans(frame: usize) -\u003e Vec\u003cSpan\u003c'static\u003e\u003e {\n    let state = get_scanner_state(frame);\n    let mut spans = Vec::with_capacity(WIDTH);\n\n    for i in 0..WIDTH {\n        let distance = if state.forward {\n            if state.position \u003e= i {\n                state.position - i\n            } else {\n                usize::MAX\n            }\n        } else if i \u003e= state.position {\n            i - state.position\n        } else {\n            usize::MAX\n        };\n\n        let (ch, color) = if distance \u003c TRAIL_LENGTH {\n            ('â– ', TRAIL_COLORS[distance])\n        } else {\n            ('â¬', INACTIVE_COLOR)\n        };\n\n        spans.push(Span::styled(ch.to_string(), Style::default().fg(color)));\n    }\n\n    spans\n}\n\npub fn get_phase_message(phase: \u0026str) -\u003e \u0026'static str {\n    match phase {\n        \"idle\" =\u003e \"Initializing...\",\n        \"parsing-sources\" =\u003e \"Scanning session data...\",\n        \"loading-pricing\" =\u003e \"Loading pricing data...\",\n        \"finalizing-report\" =\u003e \"Finalizing report...\",\n        \"complete\" =\u003e \"Complete\",\n        _ =\u003e \"Loading data...\",\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","stats.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Paragraph};\n\nuse super::widgets::{\n    format_cost, format_tokens, get_model_color, get_source_color, get_source_display_name,\n};\nuse crate::tui::app::{App, ClickAction};\n\nconst CELL_WIDTH: u16 = 2;\nconst MONTH_LABELS: \u0026[\u0026str] = \u0026[\n    \"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\",\n];\nconst DAY_LABELS: \u0026[\u0026str] = \u0026[\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let chunks = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([Constraint::Min(12), Constraint::Length(12)])\n        .split(area);\n\n    render_graph(frame, app, chunks[0]);\n\n    if app.selected_graph_cell.is_some() {\n        render_breakdown_panel(frame, app, chunks[1]);\n    } else {\n        render_stats_panel(frame, app, chunks[1]);\n    }\n}\n\nfn render_graph(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let theme_border = app.theme.border;\n    let theme_accent = app.theme.accent;\n    let theme_background = app.theme.background;\n    let theme_muted = app.theme.muted;\n    let theme_colors = app.theme.colors;\n    let selected_cell = app.selected_graph_cell;\n    let is_narrow = app.is_narrow();\n\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(theme_border))\n        .title(Span::styled(\n            \" Contribution Graph (52 weeks) \",\n            Style::default()\n                .fg(theme_accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(theme_background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let graph = match \u0026app.data.graph {\n        Some(g) =\u003e g.clone(),\n        None =\u003e return,\n    };\n\n    let label_width = if is_narrow { 2u16 } else { 4u16 };\n    let graph_start_x = inner.x + label_width;\n    let graph_start_y = inner.y + 2;\n\n    for (day_idx, label) in DAY_LABELS.iter().enumerate() {\n        if day_idx % 2 == 1 {\n            let y = graph_start_y + day_idx as u16;\n            if y \u003c inner.y + inner.height {\n                let display_label = if is_narrow { \"\" } else { *label };\n                let text = Paragraph::new(display_label).style(Style::default().fg(theme_muted));\n                frame.render_widget(text, Rect::new(inner.x, y, label_width, 1));\n            }\n        }\n    }\n\n    let max_weeks = (inner.width.saturating_sub(label_width) / CELL_WIDTH) as usize;\n    let weeks_to_show = graph.weeks.len().min(max_weeks);\n    let start_week = graph.weeks.len().saturating_sub(weeks_to_show);\n\n    let intensity_color = |intensity: f64| -\u003e Color {\n        let safe_intensity = if intensity.is_finite() {\n            intensity.clamp(0.0, 1.0)\n        } else {\n            0.0\n        };\n        let idx = match safe_intensity {\n            x if x \u003c= 0.0 =\u003e 0,\n            x if x \u003c 0.25 =\u003e 1,\n            x if x \u003c 0.50 =\u003e 2,\n            x if x \u003c 0.75 =\u003e 3,\n            _ =\u003e 4,\n        };\n        theme_colors[idx]\n    };\n\n    let mut click_areas_to_add: Vec\u003c(Rect, usize, usize)\u003e = Vec::new();\n\n    for (week_idx, week) in graph.weeks.iter().skip(start_week).enumerate() {\n        let x = graph_start_x + (week_idx as u16 * CELL_WIDTH);\n\n        for (day_idx, day_opt) in week.iter().enumerate() {\n            let y = graph_start_y + day_idx as u16;\n\n            if x \u003e= inner.x + inner.width || y \u003e= inner.y + inner.height {\n                continue;\n            }\n\n            let actual_week_idx = week_idx + start_week;\n            let is_selected = selected_cell == Some((actual_week_idx, day_idx));\n\n            let (cell_str, style) = match day_opt {\n                Some(day) =\u003e {\n                    let color = intensity_color(day.intensity);\n                    if is_selected {\n                        (\"â–“â–“\", Style::default().fg(Color::White).bg(color))\n                    } else {\n                        (\"â–ˆâ–ˆ\", Style::default().fg(color))\n                    }\n                }\n                None =\u003e {\n                    if is_selected {\n                        (\"â–“â–“\", Style::default().fg(Color::White).bg(theme_colors[0]))\n                    } else {\n                        (\"Â· \", Style::default().fg(Color::Rgb(102, 102, 102)))\n                    }\n                }\n            };\n\n            let cell = Paragraph::new(cell_str).style(style);\n            frame.render_widget(cell, Rect::new(x, y, CELL_WIDTH, 1));\n\n            click_areas_to_add.push((Rect::new(x, y, CELL_WIDTH, 1), actual_week_idx, day_idx));\n        }\n    }\n\n    for (rect, week, day) in click_areas_to_add {\n        app.add_click_area(rect, ClickAction::GraphCell { week, day });\n    }\n\n    let month_y = inner.y;\n    let mut current_month: Option\u003cusize\u003e = None;\n\n    for (week_idx, week) in graph.weeks.iter().skip(start_week).enumerate() {\n        if let Some(Some(day)) = week.first() {\n            let month = day\n                .date\n                .format(\"%m\")\n                .to_string()\n                .parse::\u003cusize\u003e()\n                .unwrap_or(1)\n                - 1;\n            if current_month != Some(month) {\n                current_month = Some(month);\n                let x = graph_start_x + (week_idx as u16 * CELL_WIDTH);\n                if x + 3 \u003c inner.x + inner.width \u0026\u0026 month \u003c MONTH_LABELS.len() {\n                    let label =\n                        Paragraph::new(MONTH_LABELS[month]).style(Style::default().fg(theme_muted));\n                    frame.render_widget(label, Rect::new(x, month_y, 3, 1));\n                }\n            }\n        }\n    }\n}\n\nfn render_stats_panel(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Stats \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let is_narrow = app.is_narrow();\n    let graph = \u0026app.data.graph;\n\n    let total_tokens: u64 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter_map(|d| d.as_ref())\n                .map(|d| d.tokens)\n                .sum()\n        })\n        .unwrap_or(0);\n\n    let total_cost: f64 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter_map(|d| d.as_ref())\n                .map(|d| d.cost)\n                .sum()\n        })\n        .unwrap_or(0.0);\n\n    let active_days: u32 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter_map(|d| d.as_ref())\n                .filter(|d| d.tokens \u003e 0)\n                .count() as u32\n        })\n        .unwrap_or(0);\n\n    let total_days: u32 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter(|d| d.is_some())\n                .count() as u32\n        })\n        .unwrap_or(365);\n\n    let favorite_model = app\n        .data\n        .models\n        .iter()\n        .max_by(|a, b| {\n            a.cost\n                .partial_cmp(\u0026b.cost)\n                .unwrap_or(std::cmp::Ordering::Equal)\n        })\n        .map(|m| m.model.as_str())\n        .unwrap_or(\"N/A\");\n\n    let model_color = get_model_color(favorite_model);\n    let sessions: u32 = app.data.models.iter().map(|m| m.session_count).sum();\n\n    let col1_width = if is_narrow { 18u16 } else { 30u16 };\n    let col2_x = inner.x + col1_width;\n\n    let mut y = inner.y;\n\n    let row1_label = if is_narrow {\n        \"Model:\"\n    } else {\n        \"Favorite model:\"\n    };\n    let row1 = Line::from(vec![\n        Span::styled(row1_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            truncate_model_name(favorite_model, if is_narrow { 15 } else { 30 }),\n            Style::default().fg(model_color),\n        ),\n    ]);\n    frame.render_widget(Paragraph::new(row1), Rect::new(inner.x, y, col1_width, 1));\n\n    let tokens_label = if is_narrow {\n        \"Tokens:\"\n    } else {\n        \"Total tokens:\"\n    };\n    let row1_col2 = Line::from(vec![\n        Span::styled(tokens_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format_tokens(total_tokens),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(\n        Paragraph::new(row1_col2),\n        Rect::new(col2_x, y, inner.width.saturating_sub(col1_width), 1),\n    );\n\n    y += 1;\n\n    let row2 = Line::from(vec![\n        Span::styled(\"Sessions:\", Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(sessions.to_string(), Style::default().fg(Color::Cyan)),\n    ]);\n    frame.render_widget(Paragraph::new(row2), Rect::new(inner.x, y, col1_width, 1));\n\n    let cost_label = if is_narrow { \"Cost:\" } else { \"Total cost:\" };\n    let row2_col2 = Line::from(vec![\n        Span::styled(cost_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(format_cost(total_cost), Style::default().fg(Color::Green)),\n    ]);\n    frame.render_widget(\n        Paragraph::new(row2_col2),\n        Rect::new(col2_x, y, inner.width.saturating_sub(col1_width), 1),\n    );\n\n    y += 1;\n\n    // Row 3: Current streak / Longest streak\n    let streak_label = if is_narrow {\n        \"Streak:\"\n    } else {\n        \"Current streak:\"\n    };\n    let row3 = Line::from(vec![\n        Span::styled(streak_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format!(\"{} days\", app.data.current_streak),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(Paragraph::new(row3), Rect::new(inner.x, y, col1_width, 1));\n\n    let longest_label = if is_narrow {\n        \"Max streak:\"\n    } else {\n        \"Longest streak:\"\n    };\n    let row3_col2 = Line::from(vec![\n        Span::styled(longest_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format!(\"{} days\", app.data.longest_streak),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(\n        Paragraph::new(row3_col2),\n        Rect::new(col2_x, y, inner.width.saturating_sub(col1_width), 1),\n    );\n\n    y += 1;\n\n    let active_label = if is_narrow { \"Active:\" } else { \"Active days:\" };\n    let active_days_line = Line::from(vec![\n        Span::styled(active_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format!(\"{}/{}\", active_days, total_days),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(\n        Paragraph::new(active_days_line),\n        Rect::new(inner.x, y, col1_width, 1),\n    );\n\n    y += 2;\n\n    let legend_spans = vec![\n        Span::styled(\"Less \", Style::default().fg(app.theme.muted)),\n        Span::styled(\"Â· \", Style::default().fg(Color::Rgb(102, 102, 102))),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[1])),\n        Span::raw(\" \"),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[2])),\n        Span::raw(\" \"),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[3])),\n        Span::raw(\" \"),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[4])),\n        Span::styled(\" More\", Style::default().fg(app.theme.muted)),\n    ];\n    let legend_line = Line::from(legend_spans);\n    frame.render_widget(\n        Paragraph::new(legend_line),\n        Rect::new(inner.x, y, inner.width, 1),\n    );\n\n    y += 2;\n\n    if !is_narrow {\n        let footer = Line::from(Span::styled(\n            format!(\n                \"Your total spending is ${:.2} on AI coding assistants!\",\n                total_cost\n            ),\n            Style::default()\n                .fg(Color::Yellow)\n                .add_modifier(Modifier::ITALIC),\n        ));\n        frame.render_widget(\n            Paragraph::new(footer),\n            Rect::new(inner.x, y, inner.width, 1),\n        );\n    }\n}\n\nfn render_breakdown_panel(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Day Breakdown (ESC to close) \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let (week_idx, day_idx) = match app.selected_graph_cell {\n        Some(cell) =\u003e cell,\n        None =\u003e return,\n    };\n\n    let graph = match \u0026app.data.graph {\n        Some(g) =\u003e g,\n        None =\u003e return,\n    };\n\n    let day = match graph\n        .weeks\n        .get(week_idx)\n        .and_then(|w| w.get(day_idx))\n        .and_then(|d| d.as_ref())\n    {\n        Some(d) =\u003e d,\n        None =\u003e {\n            let no_data = Paragraph::new(\"No data for this day\")\n                .style(Style::default().fg(app.theme.muted))\n                .alignment(Alignment::Center);\n            frame.render_widget(no_data, inner);\n            return;\n        }\n    };\n\n    let daily_usage = app.data.daily.iter().find(|d| d.date == day.date);\n\n    let mut lines = vec![\n        Line::from(vec![\n            Span::styled(\n                day.date.format(\"%a, %b %d, %Y\").to_string(),\n                Style::default()\n                    .fg(Color::White)\n                    .add_modifier(Modifier::BOLD),\n            ),\n            Span::raw(\"  \"),\n            Span::styled(format_tokens(day.tokens), Style::default().fg(Color::Cyan)),\n            Span::raw(\"  \"),\n            Span::styled(\n                format_cost(day.cost),\n                Style::default()\n                    .fg(Color::Green)\n                    .add_modifier(Modifier::BOLD),\n            ),\n        ]),\n        Line::from(\"\"),\n    ];\n\n    if let Some(daily) = daily_usage {\n        let mut grouped: std::collections::HashMap\u003c\n            String,\n            Vec\u003c(String, \u0026crate::tui::data::DailyModelInfo)\u003e,\n        \u003e = std::collections::HashMap::new();\n        for (model_name, model_info) in \u0026daily.models {\n            grouped\n                .entry(model_info.source.clone())\n                .or_default()\n                .push((model_name.clone(), model_info));\n        }\n\n        for (source, mut models) in grouped {\n            models.sort_by(|a, b| b.1.tokens.total().cmp(\u0026a.1.tokens.total()));\n\n            let source_color = get_source_color(\u0026source);\n            let source_name = get_source_display_name(\u0026source);\n            let model_count = models.len();\n            let plural = if model_count \u003e 1 { \"s\" } else { \"\" };\n\n            lines.push(Line::from(vec![\n                Span::styled(\n                    format!(\"â— {}\", source_name),\n                    Style::default()\n                        .fg(source_color)\n                        .add_modifier(Modifier::BOLD),\n                ),\n                Span::styled(\n                    format!(\" ({} model{})\", model_count, plural),\n                    Style::default().fg(app.theme.muted),\n                ),\n            ]));\n\n            for (model_name, model_info) in models {\n                let model_color = get_model_color(\u0026model_name);\n                lines.push(Line::from(vec![\n                    Span::raw(\"  \"),\n                    Span::styled(\"â—\", Style::default().fg(model_color)),\n                    Span::styled(\n                        format!(\" {}\", truncate_model_name(\u0026model_name, 25)),\n                        Style::default().fg(Color::White),\n                    ),\n                ]));\n\n                let is_narrow = app.is_narrow();\n                if is_narrow {\n                    lines.push(Line::from(vec![\n                        Span::styled(\"    \", Style::default()),\n                        Span::styled(\n                            format_tokens(model_info.tokens.input),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.output),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_read),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_write),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                    ]));\n                } else {\n                    lines.push(Line::from(vec![\n                        Span::styled(\"    In: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.input),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\" Â· Out: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.output),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\" Â· CR: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_read),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\" Â· CW: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_write),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                    ]));\n                }\n            }\n        }\n    } else {\n        lines.push(Line::from(Span::styled(\n            \"No detailed breakdown available\",\n            Style::default().fg(app.theme.muted),\n        )));\n    }\n\n    let paragraph = Paragraph::new(lines);\n    frame.render_widget(paragraph, inner);\n}\n\nfn truncate_model_name(s: \u0026str, max_chars: usize) -\u003e String {\n    if max_chars == 0 {\n        return String::new();\n    }\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        s.to_string()\n    } else if max_chars == 1 {\n        \"â€¦\".to_string()\n    } else {\n        let head: String = s.chars().take(max_chars - 1).collect();\n        format!(\"{}â€¦\", head)\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":378},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","widgets.rs"],"content":"use ratatui::prelude::*;\n\nuse crate::tui::config::TokscaleConfig;\n\npub fn format_tokens_compact(tokens: u64) -\u003e String {\n    if tokens \u003e= 1_000_000_000 {\n        format!(\"{:.1}B\", tokens as f64 / 1_000_000_000.0)\n    } else if tokens \u003e= 1_000_000 {\n        format!(\"{:.1}M\", tokens as f64 / 1_000_000.0)\n    } else if tokens \u003e= 1_000 {\n        format!(\"{}K\", tokens / 1_000)\n    } else {\n        format_tokens_with_commas(tokens)\n    }\n}\n\npub fn format_tokens(tokens: u64) -\u003e String {\n    format_tokens_compact(tokens)\n}\n\npub fn format_tokens_with_commas(n: u64) -\u003e String {\n    let s = n.to_string();\n    let mut result = String::new();\n    for (i, c) in s.chars().rev().enumerate() {\n        if i \u003e 0 \u0026\u0026 i % 3 == 0 {\n            result.insert(0, ',');\n        }\n        result.insert(0, c);\n    }\n    result\n}\n\npub fn format_cost(cost: f64) -\u003e String {\n    if !cost.is_finite() || cost \u003c 0.0 {\n        return \"$0.00\".to_string();\n    }\n    if cost \u003e= 1000.0 {\n        format!(\"${:.1}K\", cost / 1000.0)\n    } else {\n        format!(\"${:.2}\", cost)\n    }\n}\n\npub fn get_model_color(model: \u0026str) -\u003e Color {\n    let provider = get_provider_from_model(model);\n    let config = TokscaleConfig::load();\n    if let Some(color) = config.get_provider_color(provider) {\n        return color;\n    }\n    match provider {\n        \"anthropic\" =\u003e Color::Rgb(218, 119, 86), // #DA7756 Claude brand coral\n        \"openai\" =\u003e Color::Rgb(16, 185, 129),    // #10B981\n        \"google\" =\u003e Color::Rgb(59, 130, 246),    // #3B82F6\n        \"cursor\" =\u003e Color::Rgb(139, 92, 246),    // #8B5CF6\n        \"deepseek\" =\u003e Color::Rgb(6, 182, 212),   // #06B6D4\n        \"xai\" =\u003e Color::Rgb(234, 179, 8),        // #EAB308\n        \"meta\" =\u003e Color::Rgb(99, 102, 241),      // #6366F1\n        _ =\u003e Color::Rgb(255, 255, 255),          // #FFFFFF (unknown)\n    }\n}\n\nfn get_provider_from_model(model: \u0026str) -\u003e \u0026'static str {\n    let model_lower = model.to_lowercase();\n\n    if model_lower.contains(\"claude\")\n        || model_lower.contains(\"sonnet\")\n        || model_lower.contains(\"opus\")\n        || model_lower.contains(\"haiku\")\n    {\n        \"anthropic\"\n    } else if model_lower.contains(\"gpt\")\n        || model_lower.starts_with(\"o1\")\n        || model_lower.starts_with(\"o3\")\n        || model_lower.contains(\"codex\")\n        || model_lower.contains(\"text-embedding\")\n        || model_lower.contains(\"dall-e\")\n        || model_lower.contains(\"whisper\")\n        || model_lower.contains(\"tts\")\n    {\n        \"openai\"\n    } else if model_lower.contains(\"gemini\") {\n        \"google\"\n    } else if model_lower.contains(\"deepseek\") {\n        \"deepseek\"\n    } else if model_lower.contains(\"grok\") {\n        \"xai\"\n    } else if model_lower.contains(\"llama\") {\n        \"meta\"\n    } else if model_lower.contains(\"mixtral\") {\n        \"mistral\"\n    } else if model_lower == \"auto\" || model_lower.contains(\"cursor\") {\n        \"cursor\"\n    } else {\n        \"unknown\"\n    }\n}\n\npub fn get_source_color(source: \u0026str) -\u003e Color {\n    let config = TokscaleConfig::load();\n    if let Some(color) = config.get_source_color(source) {\n        return color;\n    }\n    match source.to_lowercase().as_str() {\n        \"opencode\" =\u003e Color::Rgb(34, 197, 94), // #22c55e\n        \"claude\" =\u003e Color::Rgb(218, 119, 86),  // #DA7756 Claude brand coral\n        \"codex\" =\u003e Color::Rgb(59, 130, 246),   // #3b82f6\n        \"cursor\" =\u003e Color::Rgb(168, 85, 247),  // #a855f7\n        \"gemini\" =\u003e Color::Rgb(6, 182, 212),   // #06b6d4\n        \"amp\" =\u003e Color::Rgb(236, 72, 153),     // #EC4899\n        \"droid\" =\u003e Color::Rgb(16, 185, 129),   // #10b981\n        \"openclaw\" =\u003e Color::Rgb(239, 68, 68), // #ef4444\n        _ =\u003e Color::Rgb(136, 136, 136),        // #888888\n    }\n}\n\npub fn get_source_display_name(source: \u0026str) -\u003e String {\n    let config = TokscaleConfig::load();\n    if let Some(name) = config.get_source_display_name(source) {\n        return name.to_string();\n    }\n    match source.to_lowercase().as_str() {\n        \"opencode\" =\u003e \"OpenCode\".to_string(),\n        \"claude\" =\u003e \"Claude\".to_string(),\n        \"codex\" =\u003e \"Codex\".to_string(),\n        \"cursor\" =\u003e \"Cursor\".to_string(),\n        \"gemini\" =\u003e \"Gemini\".to_string(),\n        \"amp\" =\u003e \"Amp\".to_string(),\n        \"droid\" =\u003e \"Droid\".to_string(),\n        \"openclaw\" =\u003e \"ðŸ¦ž OpenClaw\".to_string(),\n        \"pi\" =\u003e \"Pi\".to_string(),\n        _ =\u003e source.to_string(),\n    }\n}\n\npub fn get_provider_display_name(provider: \u0026str) -\u003e String {\n    let config = TokscaleConfig::load();\n    if let Some(name) = config.get_provider_display_name(provider) {\n        return name.to_string();\n    }\n    match provider.to_lowercase().as_str() {\n        \"anthropic\" =\u003e \"Anthropic\".to_string(),\n        \"openai\" =\u003e \"OpenAI\".to_string(),\n        \"google\" =\u003e \"Google\".to_string(),\n        \"cursor\" =\u003e \"Cursor\".to_string(),\n        \"deepseek\" =\u003e \"DeepSeek\".to_string(),\n        \"xai\" =\u003e \"xAI\".to_string(),\n        \"meta\" =\u003e \"Meta\".to_string(),\n        \"mistral\" =\u003e \"Mistral\".to_string(),\n        \"cohere\" =\u003e \"Cohere\".to_string(),\n        \"opencode\" =\u003e \"OpenCode\".to_string(),\n        s if s.starts_with(\"github-cop\") || s.contains(\"copilot\") =\u003e \"GitHub Copilot\".to_string(),\n        _ =\u003e capitalize_first(provider),\n    }\n}\n\nfn capitalize_first(s: \u0026str) -\u003e String {\n    let mut chars = s.chars();\n    match chars.next() {\n        None =\u003e String::new(),\n        Some(first) =\u003e first.to_uppercase().chain(chars).collect(),\n    }\n}\n","traces":[{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":118},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","aggregator.rs"],"content":"//! Parallel aggregation of session data\n//!\n//! Uses rayon for parallel map-reduce operations.\n\nuse crate::sessions::UnifiedMessage;\nuse crate::{\n    DailyContribution, DailyTotals, DataSummary, GraphMeta, GraphResult, SourceContribution,\n    TokenBreakdown, YearSummary,\n};\nuse rayon::prelude::*;\nuse std::collections::HashMap;\n\n/// Aggregate messages into daily contributions\npub fn aggregate_by_date(messages: Vec\u003cUnifiedMessage\u003e) -\u003e Vec\u003cDailyContribution\u003e {\n    if messages.is_empty() {\n        return Vec::new();\n    }\n\n    // Estimate unique days (typically 1-365) - use message count / 10 as heuristic\n    let estimated_days = (messages.len() / 10).clamp(30, 400);\n\n    // Parallel aggregation using fold/reduce pattern\n    let daily_map: HashMap\u003cString, DayAccumulator\u003e = messages\n        .into_par_iter()\n        .fold(\n            || HashMap::with_capacity(estimated_days),\n            |mut acc: HashMap\u003cString, DayAccumulator\u003e, msg| {\n                let entry = acc.entry(msg.date.clone()).or_default();\n                entry.add_message(\u0026msg);\n                acc\n            },\n        )\n        .reduce(\n            || HashMap::with_capacity(estimated_days),\n            |mut a, b| {\n                for (date, acc) in b {\n                    a.entry(date).or_default().merge(acc);\n                }\n                a\n            },\n        );\n\n    // Convert to sorted vector with pre-allocated capacity\n    let mut contributions: Vec\u003cDailyContribution\u003e = Vec::with_capacity(daily_map.len());\n    contributions.extend(\n        daily_map\n            .into_iter()\n            .map(|(date, acc)| acc.into_contribution(date)),\n    );\n\n    // Sort by date\n    contributions.sort_by(|a, b| a.date.cmp(\u0026b.date));\n\n    // Calculate intensities based on max cost\n    calculate_intensities(\u0026mut contributions);\n\n    contributions\n}\n\n/// Calculate summary statistics\npub fn calculate_summary(contributions: \u0026[DailyContribution]) -\u003e DataSummary {\n    let total_tokens: i64 = contributions.iter().map(|c| c.totals.tokens).sum();\n    let total_cost: f64 = contributions.iter().map(|c| c.totals.cost).sum();\n    let active_days = contributions.iter().filter(|c| c.totals.tokens \u003e 0).count() as i32;\n    let max_cost = contributions\n        .iter()\n        .map(|c| c.totals.cost)\n        .fold(0.0, f64::max);\n\n    let mut sources_set = std::collections::HashSet::with_capacity(5);\n    let mut models_set = std::collections::HashSet::with_capacity(20);\n\n    for c in contributions {\n        for s in \u0026c.sources {\n            sources_set.insert(s.source.clone());\n            models_set.insert(s.model_id.clone());\n        }\n    }\n\n    DataSummary {\n        total_tokens,\n        total_cost,\n        total_days: contributions.len() as i32,\n        active_days,\n        average_per_day: if active_days \u003e 0 {\n            total_cost / active_days as f64\n        } else {\n            0.0\n        },\n        max_cost_in_single_day: max_cost,\n        sources: sources_set.into_iter().collect(),\n        models: models_set.into_iter().collect(),\n    }\n}\n\n/// Calculate year summaries\npub fn calculate_years(contributions: \u0026[DailyContribution]) -\u003e Vec\u003cYearSummary\u003e {\n    let mut years_map: HashMap\u003cString, YearAccumulator\u003e = HashMap::with_capacity(5);\n\n    for c in contributions {\n        // Guard against short/invalid date strings\n        if c.date.len() \u003c 4 {\n            eprintln!(\n                \"Warning: Skipping contribution with invalid date '{}' ({} tokens, ${:.4} cost)\",\n                c.date, c.totals.tokens, c.totals.cost\n            );\n            continue;\n        }\n        let year = \u0026c.date[0..4];\n        let entry = years_map.entry(year.to_string()).or_default();\n        entry.tokens += c.totals.tokens;\n        entry.cost += c.totals.cost;\n\n        if entry.start.is_empty() || c.date \u003c entry.start {\n            entry.start = c.date.clone();\n        }\n        if entry.end.is_empty() || c.date \u003e entry.end {\n            entry.end = c.date.clone();\n        }\n    }\n\n    let mut years: Vec\u003cYearSummary\u003e = Vec::with_capacity(years_map.len());\n    years.extend(years_map.into_iter().map(|(year, acc)| YearSummary {\n        year,\n        total_tokens: acc.tokens,\n        total_cost: acc.cost,\n        range_start: acc.start,\n        range_end: acc.end,\n    }));\n\n    years.sort_by(|a, b| a.year.cmp(\u0026b.year));\n    years\n}\n\n/// Generate complete graph result\npub fn generate_graph_result(\n    contributions: Vec\u003cDailyContribution\u003e,\n    processing_time_ms: u32,\n) -\u003e GraphResult {\n    let summary = calculate_summary(\u0026contributions);\n    let years = calculate_years(\u0026contributions);\n\n    let date_range_start = contributions\n        .first()\n        .map(|c| c.date.clone())\n        .unwrap_or_default();\n    let date_range_end = contributions\n        .last()\n        .map(|c| c.date.clone())\n        .unwrap_or_default();\n\n    GraphResult {\n        meta: GraphMeta {\n            generated_at: chrono::Utc::now().to_rfc3339(),\n            version: env!(\"CARGO_PKG_VERSION\").to_string(),\n            date_range_start,\n            date_range_end,\n            processing_time_ms,\n        },\n        summary,\n        years,\n        contributions,\n    }\n}\n\n// =============================================================================\n// Internal helpers\n// =============================================================================\n\nstruct DayAccumulator {\n    totals: DailyTotals,\n    token_breakdown: TokenBreakdown,\n    sources: HashMap\u003cString, SourceContribution\u003e,\n}\n\nimpl Default for DayAccumulator {\n    fn default() -\u003e Self {\n        Self {\n            totals: DailyTotals::default(),\n            token_breakdown: TokenBreakdown::default(),\n            sources: HashMap::with_capacity(8),\n        }\n    }\n}\n\nimpl DayAccumulator {\n    fn add_message(\u0026mut self, msg: \u0026UnifiedMessage) {\n        let total_tokens = msg\n            .tokens\n            .input\n            .saturating_add(msg.tokens.output)\n            .saturating_add(msg.tokens.cache_read)\n            .saturating_add(msg.tokens.cache_write)\n            .saturating_add(msg.tokens.reasoning);\n\n        self.totals.tokens = self.totals.tokens.saturating_add(total_tokens);\n        self.totals.cost += msg.cost;\n        self.totals.messages = self.totals.messages.saturating_add(1);\n\n        self.token_breakdown.input = self.token_breakdown.input.saturating_add(msg.tokens.input);\n        self.token_breakdown.output = self\n            .token_breakdown\n            .output\n            .saturating_add(msg.tokens.output);\n        self.token_breakdown.cache_read = self\n            .token_breakdown\n            .cache_read\n            .saturating_add(msg.tokens.cache_read);\n        self.token_breakdown.cache_write = self\n            .token_breakdown\n            .cache_write\n            .saturating_add(msg.tokens.cache_write);\n        self.token_breakdown.reasoning = self\n            .token_breakdown\n            .reasoning\n            .saturating_add(msg.tokens.reasoning);\n\n        // Update source contribution\n        let key = format!(\n            \"{}:{}\",\n            msg.source,\n            crate::normalize_model_for_grouping(\u0026msg.model_id)\n        );\n        let source = self\n            .sources\n            .entry(key)\n            .or_insert_with(|| SourceContribution {\n                source: msg.source.clone(),\n                model_id: crate::normalize_model_for_grouping(\u0026msg.model_id),\n                provider_id: msg.provider_id.clone(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                messages: 0,\n            });\n\n        // Merge provider_id if different provider contributes to same source+model\n        if !source.provider_id.split(\", \").any(|p| p == msg.provider_id) {\n            source.provider_id = format!(\"{}, {}\", source.provider_id, msg.provider_id);\n        }\n\n        source.tokens.input = source.tokens.input.saturating_add(msg.tokens.input);\n        source.tokens.output = source.tokens.output.saturating_add(msg.tokens.output);\n        source.tokens.cache_read = source\n            .tokens\n            .cache_read\n            .saturating_add(msg.tokens.cache_read);\n        source.tokens.cache_write = source\n            .tokens\n            .cache_write\n            .saturating_add(msg.tokens.cache_write);\n        source.tokens.reasoning = source.tokens.reasoning.saturating_add(msg.tokens.reasoning);\n        source.cost += msg.cost;\n        source.messages = source.messages.saturating_add(1);\n\n        // Normalize provider order for deterministic output\n        let mut providers: Vec\u003c\u0026str\u003e = source.provider_id.split(\", \").collect();\n        providers.sort_unstable();\n        providers.dedup();\n        source.provider_id = providers.join(\", \");\n    }\n\n    fn merge(\u0026mut self, other: DayAccumulator) {\n        self.totals.tokens = self.totals.tokens.saturating_add(other.totals.tokens);\n        self.totals.cost += other.totals.cost;\n        self.totals.messages = self.totals.messages.saturating_add(other.totals.messages);\n\n        self.token_breakdown.input = self\n            .token_breakdown\n            .input\n            .saturating_add(other.token_breakdown.input);\n        self.token_breakdown.output = self\n            .token_breakdown\n            .output\n            .saturating_add(other.token_breakdown.output);\n        self.token_breakdown.cache_read = self\n            .token_breakdown\n            .cache_read\n            .saturating_add(other.token_breakdown.cache_read);\n        self.token_breakdown.cache_write = self\n            .token_breakdown\n            .cache_write\n            .saturating_add(other.token_breakdown.cache_write);\n        self.token_breakdown.reasoning = self\n            .token_breakdown\n            .reasoning\n            .saturating_add(other.token_breakdown.reasoning);\n\n        for (key, source) in other.sources {\n            let entry = self\n                .sources\n                .entry(key)\n                .or_insert_with(|| SourceContribution {\n                    source: source.source.clone(),\n                    model_id: source.model_id.clone(),\n                    provider_id: source.provider_id.clone(),\n                    tokens: TokenBreakdown::default(),\n                    cost: 0.0,\n                    messages: 0,\n                });\n\n            // Merge provider_ids from parallel reduction\n            for provider in source.provider_id.split(\", \") {\n                if !entry.provider_id.split(\", \").any(|p| p == provider) {\n                    entry.provider_id = format!(\"{}, {}\", entry.provider_id, provider);\n                }\n            }\n\n            entry.tokens.input = entry.tokens.input.saturating_add(source.tokens.input);\n            entry.tokens.output = entry.tokens.output.saturating_add(source.tokens.output);\n            entry.tokens.cache_read = entry\n                .tokens\n                .cache_read\n                .saturating_add(source.tokens.cache_read);\n            entry.tokens.cache_write = entry\n                .tokens\n                .cache_write\n                .saturating_add(source.tokens.cache_write);\n            entry.tokens.reasoning = entry\n                .tokens\n                .reasoning\n                .saturating_add(source.tokens.reasoning);\n            entry.cost += source.cost;\n            entry.messages = entry.messages.saturating_add(source.messages);\n        }\n\n        // Normalize provider order for deterministic output\n        for entry in self.sources.values_mut() {\n            let mut providers: Vec\u003c\u0026str\u003e = entry.provider_id.split(\", \").collect();\n            providers.sort_unstable();\n            providers.dedup();\n            entry.provider_id = providers.join(\", \");\n        }\n    }\n\n    fn into_contribution(self, date: String) -\u003e DailyContribution {\n        let token_breakdown = TokenBreakdown {\n            input: self.token_breakdown.input.max(0),\n            output: self.token_breakdown.output.max(0),\n            cache_read: self.token_breakdown.cache_read.max(0),\n            cache_write: self.token_breakdown.cache_write.max(0),\n            reasoning: self.token_breakdown.reasoning.max(0),\n        };\n\n        let sources: Vec\u003cSourceContribution\u003e = self\n            .sources\n            .into_values()\n            .map(|mut s| {\n                s.tokens.input = s.tokens.input.max(0);\n                s.tokens.output = s.tokens.output.max(0);\n                s.tokens.cache_read = s.tokens.cache_read.max(0);\n                s.tokens.cache_write = s.tokens.cache_write.max(0);\n                s.tokens.reasoning = s.tokens.reasoning.max(0);\n                s.cost = s.cost.max(0.0);\n                s\n            })\n            .collect();\n\n        DailyContribution {\n            date,\n            totals: DailyTotals {\n                tokens: self.totals.tokens.max(0),\n                cost: self.totals.cost.max(0.0),\n                messages: self.totals.messages.max(0),\n            },\n            intensity: 0,\n            token_breakdown,\n            sources,\n        }\n    }\n}\n\n#[derive(Default)]\nstruct YearAccumulator {\n    tokens: i64,\n    cost: f64,\n    start: String,\n    end: String,\n}\n\nfn calculate_intensities(contributions: \u0026mut [DailyContribution]) {\n    let max_cost = contributions\n        .iter()\n        .map(|c| c.totals.cost)\n        .fold(0.0, f64::max);\n\n    if max_cost == 0.0 {\n        return;\n    }\n\n    for c in contributions.iter_mut() {\n        let ratio = c.totals.cost / max_cost;\n        c.intensity = if ratio \u003e= 0.75 {\n            4\n        } else if ratio \u003e= 0.5 {\n            3\n        } else if ratio \u003e= 0.25 {\n            2\n        } else if ratio \u003e 0.0 {\n            1\n        } else {\n            0\n        };\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::{DateTime, Utc};\n\n    // Helper function to create mock UnifiedMessage\n    fn mock_unified_message(\n        date: \u0026str,\n        tokens: i64,\n        cost: f64,\n        model: \u0026str,\n        source: \u0026str,\n    ) -\u003e UnifiedMessage {\n        // Parse date string to timestamp\n        let datetime = format!(\"{}T00:00:00Z\", date)\n            .parse::\u003cDateTime\u003cUtc\u003e\u003e()\n            .unwrap();\n        let timestamp = datetime.timestamp_millis();\n\n        UnifiedMessage {\n            source: source.to_string(),\n            model_id: model.to_string(),\n            provider_id: \"test-provider\".to_string(),\n            session_id: \"test-session\".to_string(),\n            timestamp,\n            date: date.to_string(),\n            tokens: TokenBreakdown {\n                input: tokens / 2,\n                output: tokens / 2,\n                cache_read: 0,\n                cache_write: 0,\n                reasoning: 0,\n            },\n            cost,\n            agent: None,\n            dedup_key: None,\n        }\n    }\n\n    #[test]\n    fn test_aggregate_by_date_empty() {\n        let messages = Vec::new();\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 0);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_single_message() {\n        let messages = vec![mock_unified_message(\n            \"2024-01-01\",\n            1000,\n            0.05,\n            \"claude-3-5-sonnet\",\n            \"opencode\",\n        )];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].date, \"2024-01-01\");\n        assert_eq!(result[0].totals.tokens, 1000);\n        assert_eq!(result[0].totals.cost, 0.05);\n        assert_eq!(result[0].totals.messages, 1);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_multiple_dates() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-02\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-01-03\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 3);\n\n        // Verify sorted by date\n        assert_eq!(result[0].date, \"2024-01-01\");\n        assert_eq!(result[1].date, \"2024-01-02\");\n        assert_eq!(result[2].date, \"2024-01-03\");\n\n        // Verify totals\n        assert_eq!(result[0].totals.tokens, 1000);\n        assert_eq!(result[1].totals.tokens, 2000);\n        assert_eq!(result[2].totals.tokens, 1500);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_same_date_aggregation() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-01-01\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].date, \"2024-01-01\");\n        assert_eq!(result[0].totals.tokens, 4500);\n        assert!((result[0].totals.cost - 0.23).abs() \u003c 0.0001);\n        assert_eq!(result[0].totals.messages, 3);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_token_breakdown() {\n        let mut msg =\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\");\n        msg.tokens = TokenBreakdown {\n            input: 600,\n            output: 300,\n            cache_read: 50,\n            cache_write: 40,\n            reasoning: 10,\n        };\n\n        let result = aggregate_by_date(vec![msg]);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].token_breakdown.input, 600);\n        assert_eq!(result[0].token_breakdown.output, 300);\n        assert_eq!(result[0].token_breakdown.cache_read, 50);\n        assert_eq!(result[0].token_breakdown.cache_write, 40);\n        assert_eq!(result[0].token_breakdown.reasoning, 10);\n    }\n\n    #[test]\n    fn test_calculate_summary_empty() {\n        let contributions = Vec::new();\n        let summary = calculate_summary(\u0026contributions);\n\n        assert_eq!(summary.total_tokens, 0);\n        assert_eq!(summary.total_cost, 0.0);\n        assert_eq!(summary.total_days, 0);\n        assert_eq!(summary.active_days, 0);\n        assert_eq!(summary.average_per_day, 0.0);\n        assert_eq!(summary.max_cost_in_single_day, 0.0);\n    }\n\n    #[test]\n    fn test_calculate_summary_single_day() {\n        let messages = vec![mock_unified_message(\n            \"2024-01-01\",\n            1000,\n            0.05,\n            \"claude-3-5-sonnet\",\n            \"opencode\",\n        )];\n        let contributions = aggregate_by_date(messages);\n        let summary = calculate_summary(\u0026contributions);\n\n        assert_eq!(summary.total_tokens, 1000);\n        assert_eq!(summary.total_cost, 0.05);\n        assert_eq!(summary.total_days, 1);\n        assert_eq!(summary.active_days, 1);\n        assert_eq!(summary.average_per_day, 0.05);\n        assert_eq!(summary.max_cost_in_single_day, 0.05);\n    }\n\n    #[test]\n    fn test_calculate_summary_multiple_days() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-02\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-01-03\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let summary = calculate_summary(\u0026contributions);\n\n        assert_eq!(summary.total_tokens, 4500);\n        assert!((summary.total_cost - 0.23).abs() \u003c 0.0001);\n        assert_eq!(summary.total_days, 3);\n        assert_eq!(summary.active_days, 3);\n        assert!((summary.average_per_day - 0.23 / 3.0).abs() \u003c 0.0001);\n        assert!((summary.max_cost_in_single_day - 0.10).abs() \u003c 0.0001);\n    }\n\n    #[test]\n    fn test_calculate_summary_with_zero_token_days() {\n        let contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 0.05,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 0,\n                    cost: 0.0,\n                    messages: 0,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        let summary = calculate_summary(\u0026contributions);\n        assert_eq!(summary.total_days, 2);\n        assert_eq!(summary.active_days, 1);\n        assert!((summary.average_per_day - 0.05).abs() \u003c 0.0001);\n    }\n\n    #[test]\n    fn test_calculate_years_empty() {\n        let contributions = Vec::new();\n        let years = calculate_years(\u0026contributions);\n        assert_eq!(years.len(), 0);\n    }\n\n    #[test]\n    fn test_calculate_years_single_year() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-06-15\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-12-31\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let years = calculate_years(\u0026contributions);\n\n        assert_eq!(years.len(), 1);\n        assert_eq!(years[0].year, \"2024\");\n        assert_eq!(years[0].total_tokens, 4500);\n        assert!((years[0].total_cost - 0.23).abs() \u003c 0.0001);\n        assert_eq!(years[0].range_start, \"2024-01-01\");\n        assert_eq!(years[0].range_end, \"2024-12-31\");\n    }\n\n    #[test]\n    fn test_calculate_years_multiple_years() {\n        let messages = vec![\n            mock_unified_message(\"2023-12-31\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-06-15\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2025-01-01\", 3000, 0.15, \"gpt-4\", \"claude\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let years = calculate_years(\u0026contributions);\n\n        assert_eq!(years.len(), 3);\n\n        // Verify sorted by year\n        assert_eq!(years[0].year, \"2023\");\n        assert_eq!(years[1].year, \"2024\");\n        assert_eq!(years[2].year, \"2025\");\n\n        // Verify 2024 aggregation\n        assert_eq!(years[1].total_tokens, 3500);\n        assert!((years[1].total_cost - 0.18).abs() \u003c 0.0001);\n        assert_eq!(years[1].range_start, \"2024-01-01\");\n        assert_eq!(years[1].range_end, \"2024-06-15\");\n    }\n\n    #[test]\n    fn test_calculate_years_year_boundary() {\n        let messages = vec![\n            mock_unified_message(\"2024-12-31\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2025-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let years = calculate_years(\u0026contributions);\n\n        assert_eq!(years.len(), 2);\n        assert_eq!(years[0].year, \"2024\");\n        assert_eq!(years[0].total_tokens, 1000);\n        assert_eq!(years[1].year, \"2025\");\n        assert_eq!(years[1].total_tokens, 2000);\n    }\n\n    #[test]\n    fn test_calculate_years_invalid_date() {\n        let contributions = vec![DailyContribution {\n            date: \"abc\".to_string(), // Invalid date (less than 4 chars)\n            totals: DailyTotals {\n                tokens: 1000,\n                cost: 0.05,\n                messages: 1,\n            },\n            intensity: 0,\n            token_breakdown: TokenBreakdown::default(),\n            sources: Vec::new(),\n        }];\n\n        let years = calculate_years(\u0026contributions);\n        assert_eq!(years.len(), 0); // Should skip invalid dates\n    }\n\n    #[test]\n    fn test_generate_graph_result_empty() {\n        let contributions = Vec::new();\n        let result = generate_graph_result(contributions, 100);\n\n        assert_eq!(result.contributions.len(), 0);\n        assert_eq!(result.summary.total_tokens, 0);\n        assert_eq!(result.years.len(), 0);\n        assert_eq!(result.meta.processing_time_ms, 100);\n        assert_eq!(result.meta.date_range_start, \"\");\n        assert_eq!(result.meta.date_range_end, \"\");\n    }\n\n    #[test]\n    fn test_generate_graph_result_with_data() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-02\", 2000, 0.10, \"gpt-4\", \"claude\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let result = generate_graph_result(contributions, 150);\n\n        assert_eq!(result.contributions.len(), 2);\n        assert_eq!(result.summary.total_tokens, 3000);\n        assert_eq!(result.years.len(), 1);\n        assert_eq!(result.meta.processing_time_ms, 150);\n        assert_eq!(result.meta.date_range_start, \"2024-01-01\");\n        assert_eq!(result.meta.date_range_end, \"2024-01-02\");\n        assert_eq!(result.meta.version, env!(\"CARGO_PKG_VERSION\"));\n    }\n\n    #[test]\n    fn test_calculate_intensities_empty() {\n        let mut contributions = Vec::new();\n        calculate_intensities(\u0026mut contributions);\n        assert_eq!(contributions.len(), 0);\n    }\n\n    #[test]\n    fn test_calculate_intensities_zero_cost() {\n        let mut contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 0.0,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 2000,\n                    cost: 0.0,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        calculate_intensities(\u0026mut contributions);\n        assert_eq!(contributions[0].intensity, 0);\n        assert_eq!(contributions[1].intensity, 0);\n    }\n\n    #[test]\n    fn test_calculate_intensities_levels() {\n        let mut contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 1.0, // 100% of max\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 800,\n                    cost: 0.8, // 80% of max (\u003e= 0.75)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-03\".to_string(),\n                totals: DailyTotals {\n                    tokens: 600,\n                    cost: 0.6, // 60% of max (\u003e= 0.5)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-04\".to_string(),\n                totals: DailyTotals {\n                    tokens: 300,\n                    cost: 0.3, // 30% of max (\u003e= 0.25)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-05\".to_string(),\n                totals: DailyTotals {\n                    tokens: 100,\n                    cost: 0.1, // 10% of max (\u003e 0.0)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        calculate_intensities(\u0026mut contributions);\n\n        assert_eq!(contributions[0].intensity, 4); // 100%\n        assert_eq!(contributions[1].intensity, 4); // 80%\n        assert_eq!(contributions[2].intensity, 3); // 60%\n        assert_eq!(contributions[3].intensity, 2); // 30%\n        assert_eq!(contributions[4].intensity, 1); // 10%\n    }\n\n    #[test]\n    fn test_calculate_intensities_boundary_values() {\n        let mut contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 1.0,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 750,\n                    cost: 0.75, // Exactly 0.75 (should be level 4)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-03\".to_string(),\n                totals: DailyTotals {\n                    tokens: 500,\n                    cost: 0.5, // Exactly 0.5 (should be level 3)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-04\".to_string(),\n                totals: DailyTotals {\n                    tokens: 250,\n                    cost: 0.25, // Exactly 0.25 (should be level 2)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        calculate_intensities(\u0026mut contributions);\n\n        assert_eq!(contributions[0].intensity, 4);\n        assert_eq!(contributions[1].intensity, 4); // \u003e= 0.75\n        assert_eq!(contributions[2].intensity, 3); // \u003e= 0.5\n        assert_eq!(contributions[3].intensity, 2); // \u003e= 0.25\n    }\n\n    #[test]\n    fn test_aggregate_by_date_preserves_sources() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n        ];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].sources.len(), 2);\n\n        // Verify both sources are present\n        let source_names: Vec\u003c\u0026str\u003e = result[0]\n            .sources\n            .iter()\n            .map(|s| s.source.as_str())\n            .collect();\n        assert!(source_names.contains(\u0026\"opencode\"));\n        assert!(source_names.contains(\u0026\"claude\"));\n    }\n\n    #[test]\n    fn test_aggregate_by_date_large_dataset() {\n        // Test with 100 messages across 10 days\n        let mut messages = Vec::new();\n        for day in 1..=10 {\n            for _msg in 0..10 {\n                let date = format!(\"2024-01-{:02}\", day);\n                messages.push(mock_unified_message(\n                    \u0026date,\n                    1000,\n                    0.05,\n                    \"claude-3-5-sonnet\",\n                    \"opencode\",\n                ));\n            }\n        }\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 10);\n\n        // Each day should have 10 messages aggregated\n        for contribution in \u0026result {\n            assert_eq!(contribution.totals.messages, 10);\n            assert_eq!(contribution.totals.tokens, 10000);\n            assert!((contribution.totals.cost - 0.5).abs() \u003c 0.0001);\n        }\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":13}},{"line":15,"address":[],"length":0,"stats":{"Line":26}},{"line":16,"address":[],"length":0,"stats":{"Line":1}},{"line":20,"address":[],"length":0,"stats":{"Line":36}},{"line":23,"address":[],"length":0,"stats":{"Line":36}},{"line":26,"address":[],"length":0,"stats":{"Line":250}},{"line":27,"address":[],"length":0,"stats":{"Line":125}},{"line":28,"address":[],"length":0,"stats":{"Line":750}},{"line":29,"address":[],"length":0,"stats":{"Line":375}},{"line":30,"address":[],"length":0,"stats":{"Line":125}},{"line":34,"address":[],"length":0,"stats":{"Line":250}},{"line":35,"address":[],"length":0,"stats":{"Line":238}},{"line":36,"address":[],"length":0,"stats":{"Line":1036}},{"line":37,"address":[],"length":0,"stats":{"Line":1064}},{"line":39,"address":[],"length":0,"stats":{"Line":238}},{"line":44,"address":[],"length":0,"stats":{"Line":60}},{"line":45,"address":[],"length":0,"stats":{"Line":24}},{"line":46,"address":[],"length":0,"stats":{"Line":12}},{"line":47,"address":[],"length":0,"stats":{"Line":12}},{"line":48,"address":[],"length":0,"stats":{"Line":108}},{"line":52,"address":[],"length":0,"stats":{"Line":147}},{"line":55,"address":[],"length":0,"stats":{"Line":24}},{"line":57,"address":[],"length":0,"stats":{"Line":12}},{"line":61,"address":[],"length":0,"stats":{"Line":6}},{"line":62,"address":[],"length":0,"stats":{"Line":36}},{"line":63,"address":[],"length":0,"stats":{"Line":36}},{"line":64,"address":[],"length":0,"stats":{"Line":38}},{"line":65,"address":[],"length":0,"stats":{"Line":12}},{"line":67,"address":[],"length":0,"stats":{"Line":6}},{"line":68,"address":[],"length":0,"stats":{"Line":6}},{"line":70,"address":[],"length":0,"stats":{"Line":12}},{"line":71,"address":[],"length":0,"stats":{"Line":12}},{"line":73,"address":[],"length":0,"stats":{"Line":14}},{"line":74,"address":[],"length":0,"stats":{"Line":20}},{"line":75,"address":[],"length":0,"stats":{"Line":30}},{"line":76,"address":[],"length":0,"stats":{"Line":18}},{"line":83,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":6}},{"line":91,"address":[],"length":0,"stats":{"Line":18}},{"line":92,"address":[],"length":0,"stats":{"Line":18}},{"line":97,"address":[],"length":0,"stats":{"Line":7}},{"line":98,"address":[],"length":0,"stats":{"Line":21}},{"line":100,"address":[],"length":0,"stats":{"Line":19}},{"line":102,"address":[],"length":0,"stats":{"Line":12}},{"line":103,"address":[],"length":0,"stats":{"Line":1}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":22}},{"line":110,"address":[],"length":0,"stats":{"Line":66}},{"line":111,"address":[],"length":0,"stats":{"Line":11}},{"line":112,"address":[],"length":0,"stats":{"Line":11}},{"line":114,"address":[],"length":0,"stats":{"Line":33}},{"line":115,"address":[],"length":0,"stats":{"Line":14}},{"line":117,"address":[],"length":0,"stats":{"Line":37}},{"line":118,"address":[],"length":0,"stats":{"Line":22}},{"line":122,"address":[],"length":0,"stats":{"Line":35}},{"line":123,"address":[],"length":0,"stats":{"Line":35}},{"line":124,"address":[],"length":0,"stats":{"Line":7}},{"line":125,"address":[],"length":0,"stats":{"Line":7}},{"line":126,"address":[],"length":0,"stats":{"Line":7}},{"line":127,"address":[],"length":0,"stats":{"Line":7}},{"line":128,"address":[],"length":0,"stats":{"Line":7}},{"line":131,"address":[],"length":0,"stats":{"Line":26}},{"line":132,"address":[],"length":0,"stats":{"Line":7}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":140,"address":[],"length":0,"stats":{"Line":6}},{"line":141,"address":[],"length":0,"stats":{"Line":6}},{"line":143,"address":[],"length":0,"stats":{"Line":4}},{"line":145,"address":[],"length":0,"stats":{"Line":4}},{"line":147,"address":[],"length":0,"stats":{"Line":4}},{"line":149,"address":[],"length":0,"stats":{"Line":4}},{"line":153,"address":[],"length":0,"stats":{"Line":4}},{"line":177,"address":[],"length":0,"stats":{"Line":298}},{"line":179,"address":[],"length":0,"stats":{"Line":596}},{"line":180,"address":[],"length":0,"stats":{"Line":298}},{"line":181,"address":[],"length":0,"stats":{"Line":298}},{"line":187,"address":[],"length":0,"stats":{"Line":125}},{"line":188,"address":[],"length":0,"stats":{"Line":250}},{"line":189,"address":[],"length":0,"stats":{"Line":125}},{"line":190,"address":[],"length":0,"stats":{"Line":125}},{"line":191,"address":[],"length":0,"stats":{"Line":250}},{"line":192,"address":[],"length":0,"stats":{"Line":250}},{"line":193,"address":[],"length":0,"stats":{"Line":250}},{"line":194,"address":[],"length":0,"stats":{"Line":250}},{"line":196,"address":[],"length":0,"stats":{"Line":250}},{"line":197,"address":[],"length":0,"stats":{"Line":125}},{"line":198,"address":[],"length":0,"stats":{"Line":125}},{"line":200,"address":[],"length":0,"stats":{"Line":250}},{"line":201,"address":[],"length":0,"stats":{"Line":250}},{"line":202,"address":[],"length":0,"stats":{"Line":250}},{"line":203,"address":[],"length":0,"stats":{"Line":250}},{"line":204,"address":[],"length":0,"stats":{"Line":125}},{"line":205,"address":[],"length":0,"stats":{"Line":250}},{"line":206,"address":[],"length":0,"stats":{"Line":250}},{"line":207,"address":[],"length":0,"stats":{"Line":250}},{"line":208,"address":[],"length":0,"stats":{"Line":125}},{"line":209,"address":[],"length":0,"stats":{"Line":250}},{"line":210,"address":[],"length":0,"stats":{"Line":250}},{"line":211,"address":[],"length":0,"stats":{"Line":250}},{"line":212,"address":[],"length":0,"stats":{"Line":125}},{"line":213,"address":[],"length":0,"stats":{"Line":250}},{"line":214,"address":[],"length":0,"stats":{"Line":250}},{"line":215,"address":[],"length":0,"stats":{"Line":250}},{"line":216,"address":[],"length":0,"stats":{"Line":125}},{"line":219,"address":[],"length":0,"stats":{"Line":250}},{"line":222,"address":[],"length":0,"stats":{"Line":250}},{"line":224,"address":[],"length":0,"stats":{"Line":250}},{"line":225,"address":[],"length":0,"stats":{"Line":125}},{"line":226,"address":[],"length":0,"stats":{"Line":250}},{"line":227,"address":[],"length":0,"stats":{"Line":125}},{"line":228,"address":[],"length":0,"stats":{"Line":250}},{"line":229,"address":[],"length":0,"stats":{"Line":250}},{"line":230,"address":[],"length":0,"stats":{"Line":250}},{"line":231,"address":[],"length":0,"stats":{"Line":125}},{"line":237,"address":[],"length":0,"stats":{"Line":500}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":250}},{"line":242,"address":[],"length":0,"stats":{"Line":250}},{"line":243,"address":[],"length":0,"stats":{"Line":250}},{"line":244,"address":[],"length":0,"stats":{"Line":250}},{"line":245,"address":[],"length":0,"stats":{"Line":250}},{"line":246,"address":[],"length":0,"stats":{"Line":125}},{"line":247,"address":[],"length":0,"stats":{"Line":250}},{"line":248,"address":[],"length":0,"stats":{"Line":250}},{"line":249,"address":[],"length":0,"stats":{"Line":250}},{"line":250,"address":[],"length":0,"stats":{"Line":125}},{"line":251,"address":[],"length":0,"stats":{"Line":250}},{"line":252,"address":[],"length":0,"stats":{"Line":125}},{"line":253,"address":[],"length":0,"stats":{"Line":125}},{"line":256,"address":[],"length":0,"stats":{"Line":500}},{"line":257,"address":[],"length":0,"stats":{"Line":125}},{"line":258,"address":[],"length":0,"stats":{"Line":250}},{"line":259,"address":[],"length":0,"stats":{"Line":375}},{"line":262,"address":[],"length":0,"stats":{"Line":266}},{"line":263,"address":[],"length":0,"stats":{"Line":532}},{"line":264,"address":[],"length":0,"stats":{"Line":266}},{"line":265,"address":[],"length":0,"stats":{"Line":532}},{"line":267,"address":[],"length":0,"stats":{"Line":532}},{"line":268,"address":[],"length":0,"stats":{"Line":532}},{"line":269,"address":[],"length":0,"stats":{"Line":532}},{"line":270,"address":[],"length":0,"stats":{"Line":266}},{"line":271,"address":[],"length":0,"stats":{"Line":532}},{"line":272,"address":[],"length":0,"stats":{"Line":532}},{"line":273,"address":[],"length":0,"stats":{"Line":532}},{"line":274,"address":[],"length":0,"stats":{"Line":266}},{"line":275,"address":[],"length":0,"stats":{"Line":532}},{"line":276,"address":[],"length":0,"stats":{"Line":532}},{"line":277,"address":[],"length":0,"stats":{"Line":532}},{"line":278,"address":[],"length":0,"stats":{"Line":266}},{"line":279,"address":[],"length":0,"stats":{"Line":532}},{"line":280,"address":[],"length":0,"stats":{"Line":532}},{"line":281,"address":[],"length":0,"stats":{"Line":532}},{"line":282,"address":[],"length":0,"stats":{"Line":266}},{"line":283,"address":[],"length":0,"stats":{"Line":532}},{"line":284,"address":[],"length":0,"stats":{"Line":532}},{"line":285,"address":[],"length":0,"stats":{"Line":532}},{"line":286,"address":[],"length":0,"stats":{"Line":266}},{"line":288,"address":[],"length":0,"stats":{"Line":800}},{"line":289,"address":[],"length":0,"stats":{"Line":534}},{"line":290,"address":[],"length":0,"stats":{"Line":267}},{"line":291,"address":[],"length":0,"stats":{"Line":534}},{"line":292,"address":[],"length":0,"stats":{"Line":267}},{"line":293,"address":[],"length":0,"stats":{"Line":352}},{"line":294,"address":[],"length":0,"stats":{"Line":352}},{"line":295,"address":[],"length":0,"stats":{"Line":352}},{"line":296,"address":[],"length":0,"stats":{"Line":176}},{"line":302,"address":[],"length":0,"stats":{"Line":534}},{"line":303,"address":[],"length":0,"stats":{"Line":1068}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":534}},{"line":309,"address":[],"length":0,"stats":{"Line":534}},{"line":310,"address":[],"length":0,"stats":{"Line":534}},{"line":311,"address":[],"length":0,"stats":{"Line":534}},{"line":312,"address":[],"length":0,"stats":{"Line":534}},{"line":313,"address":[],"length":0,"stats":{"Line":267}},{"line":314,"address":[],"length":0,"stats":{"Line":534}},{"line":315,"address":[],"length":0,"stats":{"Line":534}},{"line":316,"address":[],"length":0,"stats":{"Line":534}},{"line":317,"address":[],"length":0,"stats":{"Line":267}},{"line":318,"address":[],"length":0,"stats":{"Line":534}},{"line":319,"address":[],"length":0,"stats":{"Line":534}},{"line":320,"address":[],"length":0,"stats":{"Line":534}},{"line":321,"address":[],"length":0,"stats":{"Line":267}},{"line":322,"address":[],"length":0,"stats":{"Line":267}},{"line":323,"address":[],"length":0,"stats":{"Line":534}},{"line":327,"address":[],"length":0,"stats":{"Line":1070}},{"line":328,"address":[],"length":0,"stats":{"Line":1345}},{"line":329,"address":[],"length":0,"stats":{"Line":538}},{"line":330,"address":[],"length":0,"stats":{"Line":807}},{"line":331,"address":[],"length":0,"stats":{"Line":807}},{"line":335,"address":[],"length":0,"stats":{"Line":32}},{"line":337,"address":[],"length":0,"stats":{"Line":96}},{"line":338,"address":[],"length":0,"stats":{"Line":96}},{"line":339,"address":[],"length":0,"stats":{"Line":96}},{"line":340,"address":[],"length":0,"stats":{"Line":96}},{"line":341,"address":[],"length":0,"stats":{"Line":32}},{"line":344,"address":[],"length":0,"stats":{"Line":96}},{"line":345,"address":[],"length":0,"stats":{"Line":32}},{"line":347,"address":[],"length":0,"stats":{"Line":66}},{"line":348,"address":[],"length":0,"stats":{"Line":34}},{"line":349,"address":[],"length":0,"stats":{"Line":34}},{"line":350,"address":[],"length":0,"stats":{"Line":34}},{"line":351,"address":[],"length":0,"stats":{"Line":34}},{"line":352,"address":[],"length":0,"stats":{"Line":34}},{"line":353,"address":[],"length":0,"stats":{"Line":34}},{"line":354,"address":[],"length":0,"stats":{"Line":34}},{"line":360,"address":[],"length":0,"stats":{"Line":64}},{"line":380,"address":[],"length":0,"stats":{"Line":16}},{"line":381,"address":[],"length":0,"stats":{"Line":32}},{"line":383,"address":[],"length":0,"stats":{"Line":16}},{"line":384,"address":[],"length":0,"stats":{"Line":16}},{"line":386,"address":[],"length":0,"stats":{"Line":16}},{"line":387,"address":[],"length":0,"stats":{"Line":2}},{"line":390,"address":[],"length":0,"stats":{"Line":69}},{"line":391,"address":[],"length":0,"stats":{"Line":82}},{"line":392,"address":[],"length":0,"stats":{"Line":41}},{"line":393,"address":[],"length":0,"stats":{"Line":28}},{"line":394,"address":[],"length":0,"stats":{"Line":13}},{"line":395,"address":[],"length":0,"stats":{"Line":9}},{"line":396,"address":[],"length":0,"stats":{"Line":4}},{"line":397,"address":[],"length":0,"stats":{"Line":3}},{"line":398,"address":[],"length":0,"stats":{"Line":1}},{"line":399,"address":[],"length":0,"stats":{"Line":1}},{"line":401,"address":[],"length":0,"stats":{"Line":0}}],"covered":220,"coverable":223},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","lib.rs"],"content":"#![deny(clippy::all)]\n\nmod aggregator;\nmod parser;\npub mod pricing;\npub mod scanner;\npub mod sessions;\n\npub use aggregator::*;\npub use parser::*;\npub use scanner::*;\npub use sessions::UnifiedMessage;\n\nuse rayon::prelude::*;\nuse std::collections::{HashMap, HashSet};\nuse std::path::{Path, PathBuf};\nuse std::time::Instant;\n\npub fn version() -\u003e String {\n    env!(\"CARGO_PKG_VERSION\").to_string()\n}\n\npub fn health_check() -\u003e String {\n    \"tokscale-core is healthy!\".to_string()\n}\n\npub fn normalize_model_for_grouping(model_id: \u0026str) -\u003e String {\n    let mut name = model_id.to_lowercase();\n\n    if name.len() \u003e 9 {\n        let potential_date = \u0026name[name.len() - 8..];\n        if potential_date.chars().all(|c| c.is_ascii_digit())\n            \u0026\u0026 name.as_bytes()[name.len() - 9] == b'-'\n        {\n            name = name[..name.len() - 9].to_string();\n        }\n    }\n\n    if name.contains(\"claude\") {\n        let chars: Vec\u003cchar\u003e = name.chars().collect();\n        let mut result = String::with_capacity(name.len());\n        for i in 0..chars.len() {\n            if chars[i] == '.'\n                \u0026\u0026 i \u003e 0\n                \u0026\u0026 i \u003c chars.len() - 1\n                \u0026\u0026 chars[i - 1].is_ascii_digit()\n                \u0026\u0026 chars[i + 1].is_ascii_digit()\n            {\n                result.push('-');\n            } else {\n                result.push(chars[i]);\n            }\n        }\n        name = result;\n    }\n\n    name\n}\n\n#[derive(Debug, Clone, PartialEq, serde::Serialize)]\npub enum GroupBy {\n    Model,\n    ClientModel,\n    ClientProviderModel,\n}\n\nimpl Default for GroupBy {\n    fn default() -\u003e Self {\n        GroupBy::ClientModel\n    }\n}\n\nimpl std::fmt::Display for GroupBy {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            GroupBy::Model =\u003e write!(f, \"model\"),\n            GroupBy::ClientModel =\u003e write!(f, \"client,model\"),\n            GroupBy::ClientProviderModel =\u003e write!(f, \"client,provider,model\"),\n        }\n    }\n}\n\nimpl std::str::FromStr for GroupBy {\n    type Err = String;\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        let normalized: String = s.split(',').map(|p| p.trim()).collect::\u003cVec\u003c_\u003e\u003e().join(\",\");\n        match normalized.to_lowercase().as_str() {\n            \"model\" =\u003e Ok(GroupBy::Model),\n            \"client,model\" | \"client-model\" =\u003e Ok(GroupBy::ClientModel),\n            \"client,provider,model\" | \"client-provider-model\" =\u003e Ok(GroupBy::ClientProviderModel),\n            _ =\u003e Err(format!(\n                \"Invalid group-by value: '{}'. Valid options: model, client,model, client,provider,model\",\n                s\n            )),\n        }\n    }\n}\n\n#[derive(Debug, Clone, Default, serde::Serialize)]\npub struct TokenBreakdown {\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub reasoning: i64,\n}\n\nimpl TokenBreakdown {\n    pub fn total(\u0026self) -\u003e i64 {\n        self.input + self.output + self.cache_read + self.cache_write + self.reasoning\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct ParsedMessage {\n    pub source: String,\n    pub model_id: String,\n    pub provider_id: String,\n    pub session_id: String,\n    pub timestamp: i64,\n    pub date: String,\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub reasoning: i64,\n    pub agent: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ParsedMessages {\n    pub messages: Vec\u003cParsedMessage\u003e,\n    pub opencode_count: i32,\n    pub claude_count: i32,\n    pub codex_count: i32,\n    pub gemini_count: i32,\n    pub amp_count: i32,\n    pub droid_count: i32,\n    pub openclaw_count: i32,\n    pub pi_count: i32,\n    pub processing_time_ms: u32,\n}\n\n#[derive(Debug, Clone)]\npub struct LocalParseOptions {\n    pub home_dir: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Default, serde::Serialize)]\npub struct DailyTotals {\n    pub tokens: i64,\n    pub cost: f64,\n    pub messages: i32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct SourceContribution {\n    pub source: String,\n    pub model_id: String,\n    pub provider_id: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub messages: i32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct DailyContribution {\n    pub date: String,\n    pub totals: DailyTotals,\n    pub intensity: u8,\n    pub token_breakdown: TokenBreakdown,\n    pub sources: Vec\u003cSourceContribution\u003e,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct YearSummary {\n    pub year: String,\n    pub total_tokens: i64,\n    pub total_cost: f64,\n    pub range_start: String,\n    pub range_end: String,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct DataSummary {\n    pub total_tokens: i64,\n    pub total_cost: f64,\n    pub total_days: i32,\n    pub active_days: i32,\n    pub average_per_day: f64,\n    pub max_cost_in_single_day: f64,\n    pub sources: Vec\u003cString\u003e,\n    pub models: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct GraphMeta {\n    pub generated_at: String,\n    pub version: String,\n    pub date_range_start: String,\n    pub date_range_end: String,\n    pub processing_time_ms: u32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct GraphResult {\n    pub meta: GraphMeta,\n    pub summary: DataSummary,\n    pub years: Vec\u003cYearSummary\u003e,\n    pub contributions: Vec\u003cDailyContribution\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ReportOptions {\n    pub home_dir: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n    pub group_by: GroupBy,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct ModelUsage {\n    pub source: String,\n    pub merged_clients: Option\u003cString\u003e,\n    pub model: String,\n    pub provider: String,\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub reasoning: i64,\n    pub message_count: i32,\n    pub cost: f64,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct MonthlyUsage {\n    pub month: String,\n    pub models: Vec\u003cString\u003e,\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub message_count: i32,\n    pub cost: f64,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct ModelReport {\n    pub entries: Vec\u003cModelUsage\u003e,\n    pub total_input: i64,\n    pub total_output: i64,\n    pub total_cache_read: i64,\n    pub total_cache_write: i64,\n    pub total_messages: i32,\n    pub total_cost: f64,\n    pub processing_time_ms: u32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct MonthlyReport {\n    pub entries: Vec\u003cMonthlyUsage\u003e,\n    pub total_cost: f64,\n    pub processing_time_ms: u32,\n}\n\npub fn get_home_dir_string(home_dir_option: \u0026Option\u003cString\u003e) -\u003e Result\u003cString, String\u003e {\n    home_dir_option\n        .clone()\n        .or_else(|| std::env::var(\"HOME\").ok())\n        .or_else(|| dirs::home_dir().map(|p| p.to_string_lossy().into_owned()))\n        .ok_or_else(|| {\n            \"HOME directory not specified and could not determine home directory\".to_string()\n        })\n}\n\nfn parse_all_messages_with_pricing(\n    home_dir: \u0026str,\n    sources: \u0026[String],\n    pricing: \u0026pricing::PricingService,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let scan_result = scanner::scan_all_sources(home_dir, sources);\n    let mut all_messages: Vec\u003cUnifiedMessage\u003e = Vec::new();\n\n    let opencode_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .opencode_files\n        .par_iter()\n        .filter_map(|path| {\n            let mut msg = sessions::opencode::parse_opencode_file(path)?;\n            msg.cost = pricing.calculate_cost(\n                \u0026msg.model_id,\n                msg.tokens.input,\n                msg.tokens.output,\n                msg.tokens.cache_read,\n                msg.tokens.cache_write,\n                msg.tokens.reasoning,\n            );\n            Some(msg)\n        })\n        .collect();\n    all_messages.extend(opencode_messages);\n\n    let claude_messages_raw: Vec\u003c(String, UnifiedMessage)\u003e = scan_result\n        .claude_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::claudecode::parse_claude_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    let dedup_key = msg.dedup_key.clone().unwrap_or_default();\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    (dedup_key, msg)\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n\n    let mut seen_keys: HashSet\u003cString\u003e = HashSet::new();\n    let claude_messages: Vec\u003cUnifiedMessage\u003e = claude_messages_raw\n        .into_iter()\n        .filter(|(key, _)| key.is_empty() || seen_keys.insert(key.clone()))\n        .map(|(_, msg)| msg)\n        .collect();\n    all_messages.extend(claude_messages);\n\n    let codex_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .codex_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::codex::parse_codex_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(codex_messages);\n\n    let gemini_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .gemini_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::gemini::parse_gemini_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output + msg.tokens.reasoning,\n                        0,\n                        0,\n                        0,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(gemini_messages);\n\n    let cursor_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .cursor_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::cursor::parse_cursor_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    let csv_cost = msg.cost;\n                    let calculated_cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg.cost = if calculated_cost \u003e 0.0 {\n                        calculated_cost\n                    } else {\n                        csv_cost\n                    };\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(cursor_messages);\n\n    let amp_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .amp_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::amp::parse_amp_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    let credits = msg.cost;\n                    let calculated_cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg.cost = if calculated_cost \u003e 0.0 {\n                        calculated_cost\n                    } else {\n                        credits\n                    };\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(amp_messages);\n\n    let droid_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .droid_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::droid::parse_droid_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(droid_messages);\n\n    let openclaw_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .openclaw_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::openclaw::parse_openclaw_index(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(openclaw_messages);\n\n    let pi_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .pi_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::pi::parse_pi_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(pi_messages);\n\n    all_messages\n}\n\npub async fn get_model_report(options: ReportOptions) -\u003e Result\u003cModelReport, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"cursor\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let pricing = pricing::PricingService::get_or_init().await?;\n    let all_messages = parse_all_messages_with_pricing(\u0026home_dir, \u0026sources, \u0026pricing);\n\n    let filtered = filter_messages_for_report(all_messages, \u0026options);\n\n    let mut model_map: HashMap\u003cString, ModelUsage\u003e = HashMap::new();\n    let group_by = \u0026options.group_by;\n\n    for msg in filtered {\n        let normalized = normalize_model_for_grouping(\u0026msg.model_id);\n        let key = match group_by {\n            GroupBy::Model =\u003e normalized.clone(),\n            GroupBy::ClientModel =\u003e format!(\"{}:{}\", msg.source, normalized),\n            GroupBy::ClientProviderModel =\u003e {\n                format!(\"{}:{}:{}\", msg.source, msg.provider_id, normalized)\n            }\n        };\n        let entry = model_map.entry(key).or_insert_with(|| ModelUsage {\n            source: msg.source.clone(),\n            merged_clients: if *group_by == GroupBy::Model {\n                Some(msg.source.clone())\n            } else {\n                None\n            },\n            model: normalized.clone(),\n            provider: msg.provider_id.clone(),\n            input: 0,\n            output: 0,\n            cache_read: 0,\n            cache_write: 0,\n            reasoning: 0,\n            message_count: 0,\n            cost: 0.0,\n        });\n\n        if *group_by == GroupBy::Model {\n            if !entry.source.split(\", \").any(|s| s == msg.source) {\n                entry.source = format!(\"{}, {}\", entry.source, msg.source);\n            }\n\n            if let Some(merged_clients) = \u0026mut entry.merged_clients {\n                if !merged_clients.split(\", \").any(|s| s == msg.source) {\n                    *merged_clients = format!(\"{}, {}\", merged_clients, msg.source);\n                }\n            }\n        }\n\n        if *group_by != GroupBy::ClientProviderModel {\n            if !entry.provider.split(\", \").any(|p| p == msg.provider_id) {\n                entry.provider = format!(\"{}, {}\", entry.provider, msg.provider_id);\n            }\n        }\n\n        entry.input += msg.tokens.input;\n        entry.output += msg.tokens.output;\n        entry.cache_read += msg.tokens.cache_read;\n        entry.cache_write += msg.tokens.cache_write;\n        entry.reasoning += msg.tokens.reasoning;\n        entry.message_count += 1;\n        entry.cost += msg.cost;\n    }\n\n    let mut entries: Vec\u003cModelUsage\u003e = model_map\n        .into_values()\n        .map(|mut entry| {\n            // Normalize provider order for deterministic output\n            let mut providers: Vec\u003c\u0026str\u003e = entry.provider.split(\", \").collect();\n            providers.sort_unstable();\n            providers.dedup();\n            entry.provider = providers.join(\", \");\n            entry\n        })\n        .collect();\n    entries.sort_by(|a, b| match (a.cost.is_nan(), b.cost.is_nan()) {\n        (true, true) =\u003e std::cmp::Ordering::Equal,\n        (true, false) =\u003e std::cmp::Ordering::Greater,\n        (false, true) =\u003e std::cmp::Ordering::Less,\n        (false, false) =\u003e b\n            .cost\n            .partial_cmp(\u0026a.cost)\n            .unwrap_or(std::cmp::Ordering::Equal),\n    });\n\n    let total_input: i64 = entries.iter().map(|e| e.input).sum();\n    let total_output: i64 = entries.iter().map(|e| e.output).sum();\n    let total_cache_read: i64 = entries.iter().map(|e| e.cache_read).sum();\n    let total_cache_write: i64 = entries.iter().map(|e| e.cache_write).sum();\n    let total_messages: i32 = entries.iter().map(|e| e.message_count).sum();\n    let total_cost: f64 = entries.iter().map(|e| e.cost).sum();\n\n    Ok(ModelReport {\n        entries,\n        total_input,\n        total_output,\n        total_cache_read,\n        total_cache_write,\n        total_messages,\n        total_cost,\n        processing_time_ms: start.elapsed().as_millis() as u32,\n    })\n}\n\n#[derive(Default)]\nstruct MonthAggregator {\n    models: HashSet\u003cString\u003e,\n    input: i64,\n    output: i64,\n    cache_read: i64,\n    cache_write: i64,\n    message_count: i32,\n    cost: f64,\n}\n\npub async fn get_monthly_report(options: ReportOptions) -\u003e Result\u003cMonthlyReport, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"cursor\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let pricing = pricing::PricingService::get_or_init().await?;\n    let all_messages = parse_all_messages_with_pricing(\u0026home_dir, \u0026sources, \u0026pricing);\n\n    let filtered = filter_messages_for_report(all_messages, \u0026options);\n\n    let mut month_map: HashMap\u003cString, MonthAggregator\u003e = HashMap::new();\n\n    for msg in filtered {\n        let month = if msg.date.len() \u003e= 7 {\n            msg.date[..7].to_string()\n        } else {\n            continue;\n        };\n\n        let entry = month_map.entry(month).or_default();\n\n        entry\n            .models\n            .insert(normalize_model_for_grouping(\u0026msg.model_id));\n        entry.input += msg.tokens.input;\n        entry.output += msg.tokens.output;\n        entry.cache_read += msg.tokens.cache_read;\n        entry.cache_write += msg.tokens.cache_write;\n        entry.message_count += 1;\n        entry.cost += msg.cost;\n    }\n\n    let mut entries: Vec\u003cMonthlyUsage\u003e = month_map\n        .into_iter()\n        .map(|(month, agg)| MonthlyUsage {\n            month,\n            models: agg.models.into_iter().collect(),\n            input: agg.input,\n            output: agg.output,\n            cache_read: agg.cache_read,\n            cache_write: agg.cache_write,\n            message_count: agg.message_count,\n            cost: agg.cost,\n        })\n        .collect();\n\n    entries.sort_by(|a, b| a.month.cmp(\u0026b.month));\n\n    let total_cost: f64 = entries.iter().map(|e| e.cost).sum();\n\n    Ok(MonthlyReport {\n        entries,\n        total_cost,\n        processing_time_ms: start.elapsed().as_millis() as u32,\n    })\n}\n\npub async fn generate_graph(options: ReportOptions) -\u003e Result\u003cGraphResult, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"cursor\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let pricing = pricing::PricingService::get_or_init().await?;\n    let all_messages = parse_all_messages_with_pricing(\u0026home_dir, \u0026sources, \u0026pricing);\n\n    let filtered = filter_messages_for_report(all_messages, \u0026options);\n\n    let contributions = aggregator::aggregate_by_date(filtered);\n\n    let processing_time_ms = start.elapsed().as_millis() as u32;\n    let result = aggregator::generate_graph_result(contributions, processing_time_ms);\n\n    Ok(result)\n}\n\nfn filter_messages_for_report(\n    messages: Vec\u003cUnifiedMessage\u003e,\n    options: \u0026ReportOptions,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let mut filtered = messages;\n\n    if let Some(year) = \u0026options.year {\n        let year_prefix = format!(\"{}-\", year);\n        filtered.retain(|m| m.date.starts_with(\u0026year_prefix));\n    }\n\n    if let Some(since) = \u0026options.since {\n        filtered.retain(|m| m.date.as_str() \u003e= since.as_str());\n    }\n\n    if let Some(until) = \u0026options.until {\n        filtered.retain(|m| m.date.as_str() \u003c= until.as_str());\n    }\n\n    filtered\n}\n\nfn is_headless_path(path: \u0026Path, headless_roots: \u0026[PathBuf]) -\u003e bool {\n    headless_roots.iter().any(|root| path.starts_with(root))\n}\n\nfn apply_headless_agent(message: \u0026mut UnifiedMessage, is_headless: bool) {\n    if is_headless \u0026\u0026 message.agent.is_none() {\n        message.agent = Some(\"headless\".to_string());\n    }\n}\n\npub fn parse_local_sources(options: LocalParseOptions) -\u003e Result\u003cParsedMessages, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let local_sources: Vec\u003cString\u003e = sources.into_iter().filter(|s| s != \"cursor\").collect();\n\n    let scan_result = scanner::scan_all_sources(\u0026home_dir, \u0026local_sources);\n    let headless_roots = scanner::headless_roots(\u0026home_dir);\n\n    let mut messages: Vec\u003cParsedMessage\u003e = Vec::new();\n\n    let opencode_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .opencode_files\n        .par_iter()\n        .filter_map(|path| {\n            let msg = sessions::opencode::parse_opencode_file(path)?;\n            Some(unified_to_parsed(\u0026msg))\n        })\n        .collect();\n    let opencode_count = opencode_msgs.len() as i32;\n    messages.extend(opencode_msgs);\n\n    let claude_msgs_raw: Vec\u003c(String, ParsedMessage)\u003e = scan_result\n        .claude_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::claudecode::parse_claude_file(path)\n                .into_iter()\n                .map(|msg| {\n                    let dedup_key = msg.dedup_key.clone().unwrap_or_default();\n                    (dedup_key, unified_to_parsed(\u0026msg))\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n\n    let mut seen_keys: HashSet\u003cString\u003e = HashSet::new();\n    let claude_msgs: Vec\u003cParsedMessage\u003e = claude_msgs_raw\n        .into_iter()\n        .filter(|(key, _)| key.is_empty() || seen_keys.insert(key.clone()))\n        .map(|(_, msg)| msg)\n        .collect();\n    let claude_count = claude_msgs.len() as i32;\n    messages.extend(claude_msgs);\n\n    let codex_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .codex_files\n        .par_iter()\n        .flat_map(|path| {\n            let is_headless = is_headless_path(path, \u0026headless_roots);\n            sessions::codex::parse_codex_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    apply_headless_agent(\u0026mut msg, is_headless);\n                    unified_to_parsed(\u0026msg)\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let codex_count = codex_msgs.len() as i32;\n    messages.extend(codex_msgs);\n\n    let gemini_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .gemini_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::gemini::parse_gemini_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let gemini_count = gemini_msgs.len() as i32;\n    messages.extend(gemini_msgs);\n\n    let amp_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .amp_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::amp::parse_amp_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let amp_count = amp_msgs.len() as i32;\n    messages.extend(amp_msgs);\n\n    let droid_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .droid_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::droid::parse_droid_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let droid_count = droid_msgs.len() as i32;\n    messages.extend(droid_msgs);\n\n    let openclaw_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .openclaw_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::openclaw::parse_openclaw_index(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let openclaw_count = openclaw_msgs.len() as i32;\n    messages.extend(openclaw_msgs);\n\n    let pi_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .pi_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::pi::parse_pi_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let pi_count = pi_msgs.len() as i32;\n    messages.extend(pi_msgs);\n\n    let filtered = filter_parsed_messages(messages, \u0026options);\n\n    Ok(ParsedMessages {\n        messages: filtered,\n        opencode_count,\n        claude_count,\n        codex_count,\n        gemini_count,\n        amp_count,\n        droid_count,\n        openclaw_count,\n        pi_count,\n        processing_time_ms: start.elapsed().as_millis() as u32,\n    })\n}\n\nfn unified_to_parsed(msg: \u0026UnifiedMessage) -\u003e ParsedMessage {\n    ParsedMessage {\n        source: msg.source.clone(),\n        model_id: msg.model_id.clone(),\n        provider_id: msg.provider_id.clone(),\n        session_id: msg.session_id.clone(),\n        timestamp: msg.timestamp,\n        date: msg.date.clone(),\n        input: msg.tokens.input,\n        output: msg.tokens.output,\n        cache_read: msg.tokens.cache_read,\n        cache_write: msg.tokens.cache_write,\n        reasoning: msg.tokens.reasoning,\n        agent: msg.agent.clone(),\n    }\n}\n\nfn filter_parsed_messages(\n    messages: Vec\u003cParsedMessage\u003e,\n    options: \u0026LocalParseOptions,\n) -\u003e Vec\u003cParsedMessage\u003e {\n    let mut filtered = messages;\n\n    if let Some(year) = \u0026options.year {\n        let year_prefix = format!(\"{}-\", year);\n        filtered.retain(|m| m.date.starts_with(\u0026year_prefix));\n    }\n\n    if let Some(since) = \u0026options.since {\n        filtered.retain(|m| m.date.as_str() \u003e= since.as_str());\n    }\n\n    if let Some(until) = \u0026options.until {\n        filtered.retain(|m| m.date.as_str() \u003c= until.as_str());\n    }\n\n    filtered\n}\n\npub fn parsed_to_unified(msg: \u0026ParsedMessage, cost: f64) -\u003e UnifiedMessage {\n    UnifiedMessage {\n        source: msg.source.clone(),\n        model_id: msg.model_id.clone(),\n        provider_id: msg.provider_id.clone(),\n        session_id: msg.session_id.clone(),\n        timestamp: msg.timestamp,\n        date: msg.date.clone(),\n        tokens: TokenBreakdown {\n            input: msg.input,\n            output: msg.output,\n            cache_read: msg.cache_read,\n            cache_write: msg.cache_write,\n            reasoning: msg.reasoning,\n        },\n        cost,\n        agent: msg.agent.clone(),\n        dedup_key: None,\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{normalize_model_for_grouping, GroupBy};\n    use std::str::FromStr;\n\n    #[test]\n    fn test_normalize_model_for_grouping() {\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4-5-20251101\"),\n            \"claude-opus-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4-5-20250929\"),\n            \"claude-sonnet-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4-20250514\"),\n            \"claude-sonnet-4\"\n        );\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4.5\"),\n            \"claude-opus-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4.5\"),\n            \"claude-sonnet-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4.6\"),\n            \"claude-opus-4-6\"\n        );\n\n        assert_eq!(normalize_model_for_grouping(\"gpt-5.2\"), \"gpt-5.2\");\n        assert_eq!(\n            normalize_model_for_grouping(\"gemini-2.5-pro\"),\n            \"gemini-2.5-pro\"\n        );\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4-5-high\"),\n            \"claude-opus-4-5-high\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4-5-thinking-high\"),\n            \"claude-opus-4-5-thinking-high\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4-5-high\"),\n            \"claude-sonnet-4-5-high\"\n        );\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-4-sonnet\"),\n            \"claude-4-sonnet\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-4-opus-thinking\"),\n            \"claude-4-opus-thinking\"\n        );\n\n        assert_eq!(normalize_model_for_grouping(\"big-pickle\"), \"big-pickle\");\n        assert_eq!(normalize_model_for_grouping(\"grok-code\"), \"grok-code\");\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4.5-20251101\"),\n            \"claude-opus-4-5\"\n        );\n    }\n\n    #[test]\n    fn test_group_by_from_str_valid_values() {\n        assert_eq!(GroupBy::from_str(\"model\").unwrap(), GroupBy::Model);\n        assert_eq!(\n            GroupBy::from_str(\"client,model\").unwrap(),\n            GroupBy::ClientModel\n        );\n        assert_eq!(\n            GroupBy::from_str(\"client-model\").unwrap(),\n            GroupBy::ClientModel\n        );\n        assert_eq!(\n            GroupBy::from_str(\"client,provider,model\").unwrap(),\n            GroupBy::ClientProviderModel\n        );\n        assert_eq!(\n            GroupBy::from_str(\"client-provider-model\").unwrap(),\n            GroupBy::ClientProviderModel\n        );\n        assert!(GroupBy::from_str(\"unknown\").is_err());\n    }\n\n    #[test]\n    fn test_group_by_default_is_client_model() {\n        assert_eq!(GroupBy::default(), GroupBy::ClientModel);\n    }\n\n    #[test]\n    fn test_group_by_display_round_trips_with_from_str() {\n        let variants = [\n            GroupBy::Model,\n            GroupBy::ClientModel,\n            GroupBy::ClientProviderModel,\n        ];\n\n        for variant in variants {\n            let rendered = variant.to_string();\n            let parsed = GroupBy::from_str(\u0026rendered).unwrap();\n            assert_eq!(parsed, variant);\n        }\n    }\n\n    #[test]\n    fn test_group_by_from_str_whitespace_handling() {\n        assert_eq!(GroupBy::from_str(\"client, model\").unwrap(), GroupBy::ClientModel);\n        assert_eq!(GroupBy::from_str(\" model \").unwrap(), GroupBy::Model);\n        assert_eq!(GroupBy::from_str(\"client , provider , model\").unwrap(), GroupBy::ClientProviderModel);\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":266}},{"line":28,"address":[],"length":0,"stats":{"Line":798}},{"line":30,"address":[],"length":0,"stats":{"Line":266}},{"line":31,"address":[],"length":0,"stats":{"Line":738}},{"line":32,"address":[],"length":0,"stats":{"Line":1510}},{"line":33,"address":[],"length":0,"stats":{"Line":12}},{"line":35,"address":[],"length":0,"stats":{"Line":12}},{"line":39,"address":[],"length":0,"stats":{"Line":266}},{"line":40,"address":[],"length":0,"stats":{"Line":976}},{"line":41,"address":[],"length":0,"stats":{"Line":976}},{"line":42,"address":[],"length":0,"stats":{"Line":4405}},{"line":43,"address":[],"length":0,"stats":{"Line":4161}},{"line":44,"address":[],"length":0,"stats":{"Line":4}},{"line":45,"address":[],"length":0,"stats":{"Line":8}},{"line":46,"address":[],"length":0,"stats":{"Line":8}},{"line":47,"address":[],"length":0,"stats":{"Line":8}},{"line":49,"address":[],"length":0,"stats":{"Line":4}},{"line":51,"address":[],"length":0,"stats":{"Line":12471}},{"line":54,"address":[],"length":0,"stats":{"Line":488}},{"line":57,"address":[],"length":0,"stats":{"Line":266}},{"line":68,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":74,"address":[],"length":0,"stats":{"Line":3}},{"line":75,"address":[],"length":0,"stats":{"Line":3}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":86,"address":[],"length":0,"stats":{"Line":14}},{"line":87,"address":[],"length":0,"stats":{"Line":162}},{"line":88,"address":[],"length":0,"stats":{"Line":14}},{"line":89,"address":[],"length":0,"stats":{"Line":17}},{"line":90,"address":[],"length":0,"stats":{"Line":23}},{"line":91,"address":[],"length":0,"stats":{"Line":11}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":2}},{"line":275,"address":[],"length":0,"stats":{"Line":2}},{"line":277,"address":[],"length":0,"stats":{"Line":6}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":2}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":8}},{"line":290,"address":[],"length":0,"stats":{"Line":6}},{"line":292,"address":[],"length":0,"stats":{"Line":6}},{"line":293,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":605892}},{"line":296,"address":[],"length":0,"stats":{"Line":1817670}},{"line":297,"address":[],"length":0,"stats":{"Line":1339524}},{"line":298,"address":[],"length":0,"stats":{"Line":893016}},{"line":299,"address":[],"length":0,"stats":{"Line":893016}},{"line":300,"address":[],"length":0,"stats":{"Line":893016}},{"line":301,"address":[],"length":0,"stats":{"Line":893016}},{"line":302,"address":[],"length":0,"stats":{"Line":446508}},{"line":303,"address":[],"length":0,"stats":{"Line":446508}},{"line":305,"address":[],"length":0,"stats":{"Line":446508}},{"line":308,"address":[],"length":0,"stats":{"Line":6}},{"line":310,"address":[],"length":0,"stats":{"Line":6}},{"line":311,"address":[],"length":0,"stats":{"Line":2}},{"line":313,"address":[],"length":0,"stats":{"Line":1686}},{"line":314,"address":[],"length":0,"stats":{"Line":3368}},{"line":315,"address":[],"length":0,"stats":{"Line":1684}},{"line":316,"address":[],"length":0,"stats":{"Line":33058}},{"line":317,"address":[],"length":0,"stats":{"Line":125496}},{"line":318,"address":[],"length":0,"stats":{"Line":94122}},{"line":319,"address":[],"length":0,"stats":{"Line":62748}},{"line":320,"address":[],"length":0,"stats":{"Line":62748}},{"line":321,"address":[],"length":0,"stats":{"Line":62748}},{"line":322,"address":[],"length":0,"stats":{"Line":62748}},{"line":323,"address":[],"length":0,"stats":{"Line":31374}},{"line":324,"address":[],"length":0,"stats":{"Line":31374}},{"line":326,"address":[],"length":0,"stats":{"Line":31374}},{"line":328,"address":[],"length":0,"stats":{"Line":1684}},{"line":332,"address":[],"length":0,"stats":{"Line":6}},{"line":333,"address":[],"length":0,"stats":{"Line":6}},{"line":335,"address":[],"length":0,"stats":{"Line":165246}},{"line":336,"address":[],"length":0,"stats":{"Line":2}},{"line":338,"address":[],"length":0,"stats":{"Line":6}},{"line":340,"address":[],"length":0,"stats":{"Line":6}},{"line":341,"address":[],"length":0,"stats":{"Line":2}},{"line":343,"address":[],"length":0,"stats":{"Line":36}},{"line":344,"address":[],"length":0,"stats":{"Line":68}},{"line":345,"address":[],"length":0,"stats":{"Line":34}},{"line":346,"address":[],"length":0,"stats":{"Line":50}},{"line":347,"address":[],"length":0,"stats":{"Line":48}},{"line":348,"address":[],"length":0,"stats":{"Line":32}},{"line":349,"address":[],"length":0,"stats":{"Line":32}},{"line":350,"address":[],"length":0,"stats":{"Line":32}},{"line":351,"address":[],"length":0,"stats":{"Line":32}},{"line":352,"address":[],"length":0,"stats":{"Line":16}},{"line":353,"address":[],"length":0,"stats":{"Line":16}},{"line":355,"address":[],"length":0,"stats":{"Line":16}},{"line":357,"address":[],"length":0,"stats":{"Line":34}},{"line":360,"address":[],"length":0,"stats":{"Line":6}},{"line":362,"address":[],"length":0,"stats":{"Line":6}},{"line":363,"address":[],"length":0,"stats":{"Line":2}},{"line":365,"address":[],"length":0,"stats":{"Line":26}},{"line":366,"address":[],"length":0,"stats":{"Line":48}},{"line":367,"address":[],"length":0,"stats":{"Line":24}},{"line":368,"address":[],"length":0,"stats":{"Line":594}},{"line":369,"address":[],"length":0,"stats":{"Line":1710}},{"line":370,"address":[],"length":0,"stats":{"Line":1140}},{"line":371,"address":[],"length":0,"stats":{"Line":1140}},{"line":372,"address":[],"length":0,"stats":{"Line":570}},{"line":373,"address":[],"length":0,"stats":{"Line":570}},{"line":374,"address":[],"length":0,"stats":{"Line":570}},{"line":375,"address":[],"length":0,"stats":{"Line":570}},{"line":377,"address":[],"length":0,"stats":{"Line":570}},{"line":379,"address":[],"length":0,"stats":{"Line":24}},{"line":382,"address":[],"length":0,"stats":{"Line":6}},{"line":384,"address":[],"length":0,"stats":{"Line":6}},{"line":385,"address":[],"length":0,"stats":{"Line":2}},{"line":387,"address":[],"length":0,"stats":{"Line":4}},{"line":388,"address":[],"length":0,"stats":{"Line":4}},{"line":389,"address":[],"length":0,"stats":{"Line":2}},{"line":390,"address":[],"length":0,"stats":{"Line":10068}},{"line":391,"address":[],"length":0,"stats":{"Line":20132}},{"line":392,"address":[],"length":0,"stats":{"Line":30198}},{"line":393,"address":[],"length":0,"stats":{"Line":10066}},{"line":394,"address":[],"length":0,"stats":{"Line":10066}},{"line":395,"address":[],"length":0,"stats":{"Line":10066}},{"line":396,"address":[],"length":0,"stats":{"Line":10066}},{"line":397,"address":[],"length":0,"stats":{"Line":10066}},{"line":398,"address":[],"length":0,"stats":{"Line":10066}},{"line":400,"address":[],"length":0,"stats":{"Line":10066}},{"line":401,"address":[],"length":0,"stats":{"Line":5890}},{"line":403,"address":[],"length":0,"stats":{"Line":4176}},{"line":405,"address":[],"length":0,"stats":{"Line":10066}},{"line":407,"address":[],"length":0,"stats":{"Line":2}},{"line":410,"address":[],"length":0,"stats":{"Line":6}},{"line":412,"address":[],"length":0,"stats":{"Line":6}},{"line":413,"address":[],"length":0,"stats":{"Line":2}},{"line":415,"address":[],"length":0,"stats":{"Line":6}},{"line":416,"address":[],"length":0,"stats":{"Line":8}},{"line":417,"address":[],"length":0,"stats":{"Line":4}},{"line":418,"address":[],"length":0,"stats":{"Line":234}},{"line":419,"address":[],"length":0,"stats":{"Line":460}},{"line":420,"address":[],"length":0,"stats":{"Line":690}},{"line":421,"address":[],"length":0,"stats":{"Line":230}},{"line":422,"address":[],"length":0,"stats":{"Line":230}},{"line":423,"address":[],"length":0,"stats":{"Line":230}},{"line":424,"address":[],"length":0,"stats":{"Line":230}},{"line":425,"address":[],"length":0,"stats":{"Line":230}},{"line":426,"address":[],"length":0,"stats":{"Line":230}},{"line":428,"address":[],"length":0,"stats":{"Line":230}},{"line":429,"address":[],"length":0,"stats":{"Line":230}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":230}},{"line":435,"address":[],"length":0,"stats":{"Line":4}},{"line":438,"address":[],"length":0,"stats":{"Line":6}},{"line":440,"address":[],"length":0,"stats":{"Line":6}},{"line":441,"address":[],"length":0,"stats":{"Line":2}},{"line":443,"address":[],"length":0,"stats":{"Line":4}},{"line":444,"address":[],"length":0,"stats":{"Line":4}},{"line":445,"address":[],"length":0,"stats":{"Line":2}},{"line":446,"address":[],"length":0,"stats":{"Line":4}},{"line":447,"address":[],"length":0,"stats":{"Line":6}},{"line":448,"address":[],"length":0,"stats":{"Line":4}},{"line":449,"address":[],"length":0,"stats":{"Line":4}},{"line":450,"address":[],"length":0,"stats":{"Line":4}},{"line":451,"address":[],"length":0,"stats":{"Line":4}},{"line":452,"address":[],"length":0,"stats":{"Line":2}},{"line":453,"address":[],"length":0,"stats":{"Line":2}},{"line":455,"address":[],"length":0,"stats":{"Line":2}},{"line":457,"address":[],"length":0,"stats":{"Line":2}},{"line":460,"address":[],"length":0,"stats":{"Line":6}},{"line":462,"address":[],"length":0,"stats":{"Line":6}},{"line":463,"address":[],"length":0,"stats":{"Line":2}},{"line":465,"address":[],"length":0,"stats":{"Line":4}},{"line":466,"address":[],"length":0,"stats":{"Line":4}},{"line":467,"address":[],"length":0,"stats":{"Line":2}},{"line":468,"address":[],"length":0,"stats":{"Line":2526}},{"line":469,"address":[],"length":0,"stats":{"Line":7572}},{"line":470,"address":[],"length":0,"stats":{"Line":5048}},{"line":471,"address":[],"length":0,"stats":{"Line":5048}},{"line":472,"address":[],"length":0,"stats":{"Line":5048}},{"line":473,"address":[],"length":0,"stats":{"Line":5048}},{"line":474,"address":[],"length":0,"stats":{"Line":2524}},{"line":475,"address":[],"length":0,"stats":{"Line":2524}},{"line":477,"address":[],"length":0,"stats":{"Line":2524}},{"line":479,"address":[],"length":0,"stats":{"Line":2}},{"line":482,"address":[],"length":0,"stats":{"Line":6}},{"line":484,"address":[],"length":0,"stats":{"Line":6}},{"line":485,"address":[],"length":0,"stats":{"Line":2}},{"line":487,"address":[],"length":0,"stats":{"Line":8}},{"line":488,"address":[],"length":0,"stats":{"Line":12}},{"line":489,"address":[],"length":0,"stats":{"Line":6}},{"line":490,"address":[],"length":0,"stats":{"Line":26}},{"line":491,"address":[],"length":0,"stats":{"Line":60}},{"line":492,"address":[],"length":0,"stats":{"Line":40}},{"line":493,"address":[],"length":0,"stats":{"Line":40}},{"line":494,"address":[],"length":0,"stats":{"Line":40}},{"line":495,"address":[],"length":0,"stats":{"Line":40}},{"line":496,"address":[],"length":0,"stats":{"Line":20}},{"line":497,"address":[],"length":0,"stats":{"Line":20}},{"line":499,"address":[],"length":0,"stats":{"Line":20}},{"line":501,"address":[],"length":0,"stats":{"Line":6}},{"line":504,"address":[],"length":0,"stats":{"Line":6}},{"line":506,"address":[],"length":0,"stats":{"Line":2}},{"line":509,"address":[],"length":0,"stats":{"Line":4}},{"line":510,"address":[],"length":0,"stats":{"Line":4}},{"line":512,"address":[],"length":0,"stats":{"Line":6}},{"line":514,"address":[],"length":0,"stats":{"Line":10}},{"line":515,"address":[],"length":0,"stats":{"Line":2}},{"line":516,"address":[],"length":0,"stats":{"Line":4}},{"line":517,"address":[],"length":0,"stats":{"Line":4}},{"line":518,"address":[],"length":0,"stats":{"Line":4}},{"line":519,"address":[],"length":0,"stats":{"Line":4}},{"line":520,"address":[],"length":0,"stats":{"Line":4}},{"line":521,"address":[],"length":0,"stats":{"Line":4}},{"line":522,"address":[],"length":0,"stats":{"Line":4}},{"line":523,"address":[],"length":0,"stats":{"Line":4}},{"line":524,"address":[],"length":0,"stats":{"Line":4}},{"line":528,"address":[],"length":0,"stats":{"Line":4}},{"line":529,"address":[],"length":0,"stats":{"Line":10}},{"line":531,"address":[],"length":0,"stats":{"Line":8}},{"line":533,"address":[],"length":0,"stats":{"Line":6}},{"line":534,"address":[],"length":0,"stats":{"Line":4}},{"line":536,"address":[],"length":0,"stats":{"Line":2}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":6}},{"line":592,"address":[],"length":0,"stats":{"Line":2}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":4}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":10}},{"line":612,"address":[],"length":0,"stats":{"Line":10}},{"line":613,"address":[],"length":0,"stats":{"Line":10}},{"line":614,"address":[],"length":0,"stats":{"Line":10}},{"line":615,"address":[],"length":0,"stats":{"Line":10}},{"line":616,"address":[],"length":0,"stats":{"Line":10}},{"line":618,"address":[],"length":0,"stats":{"Line":2}},{"line":619,"address":[],"length":0,"stats":{"Line":4}},{"line":620,"address":[],"length":0,"stats":{"Line":4}},{"line":621,"address":[],"length":0,"stats":{"Line":4}},{"line":622,"address":[],"length":0,"stats":{"Line":4}},{"line":623,"address":[],"length":0,"stats":{"Line":4}},{"line":624,"address":[],"length":0,"stats":{"Line":4}},{"line":625,"address":[],"length":0,"stats":{"Line":4}},{"line":626,"address":[],"length":0,"stats":{"Line":2}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":671,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":708,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":2}},{"line":748,"address":[],"length":0,"stats":{"Line":4}},{"line":750,"address":[],"length":0,"stats":{"Line":3}},{"line":751,"address":[],"length":0,"stats":{"Line":2}},{"line":752,"address":[],"length":0,"stats":{"Line":730313}},{"line":755,"address":[],"length":0,"stats":{"Line":3}},{"line":756,"address":[],"length":0,"stats":{"Line":486876}},{"line":759,"address":[],"length":0,"stats":{"Line":2}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":2}},{"line":766,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":788,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":812,"address":[],"length":0,"stats":{"Line":0}},{"line":813,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":836,"address":[],"length":0,"stats":{"Line":0}},{"line":838,"address":[],"length":0,"stats":{"Line":0}},{"line":839,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":853,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":0}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[],"length":0,"stats":{"Line":0}},{"line":862,"address":[],"length":0,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":865,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":868,"address":[],"length":0,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":881,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":885,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":889,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":902,"address":[],"length":0,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":907,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":914,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":919,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[],"length":0,"stats":{"Line":0}},{"line":925,"address":[],"length":0,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":927,"address":[],"length":0,"stats":{"Line":0}},{"line":928,"address":[],"length":0,"stats":{"Line":0}},{"line":929,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":937,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":941,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":0}},{"line":957,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[],"length":0,"stats":{"Line":0}},{"line":961,"address":[],"length":0,"stats":{"Line":0}},{"line":962,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":966,"address":[],"length":0,"stats":{"Line":0}},{"line":969,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":977,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":988,"address":[],"length":0,"stats":{"Line":0}}],"covered":245,"coverable":508},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","parser.rs"],"content":"//! SIMD-accelerated JSON parser\n//!\n//! Uses simd-json for fast JSON parsing with SIMD instructions.\n\nuse std::fs;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Parse a JSON file using SIMD-accelerated parsing\npub fn parse_json_file\u003cT: serde::de::DeserializeOwned\u003e(path: \u0026Path) -\u003e Result\u003cT, ParseError\u003e {\n    let mut data = fs::read(path).map_err(|e| ParseError::IoError(e.to_string()))?;\n\n    simd_json::from_slice(\u0026mut data).map_err(|e| ParseError::JsonError(e.to_string()))\n}\n\n/// Parse a JSONL file (one JSON object per line)\npub fn parse_jsonl_file\u003cT, F\u003e(path: \u0026Path, mut process: F) -\u003e Result\u003c(), ParseError\u003e\nwhere\n    T: serde::de::DeserializeOwned,\n    F: FnMut(T),\n{\n    let file = fs::File::open(path).map_err(|e| ParseError::IoError(e.to_string()))?;\n    let reader = BufReader::new(file);\n\n    for line in reader.lines() {\n        let line = line.map_err(|e| ParseError::IoError(e.to_string()))?;\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        match simd_json::from_slice::\u003cT\u003e(\u0026mut bytes) {\n            Ok(value) =\u003e process(value),\n            Err(_) =\u003e continue, // Skip malformed lines (match TypeScript behavior)\n        }\n    }\n\n    Ok(())\n}\n\n/// Parse error types\n#[derive(Debug, thiserror::Error)]\npub enum ParseError {\n    #[error(\"IO error: {0}\")]\n    IoError(String),\n\n    #[error(\"JSON parse error: {0}\")]\n    JsonError(String),\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde::Deserialize;\n    use std::fs::File;\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    #[derive(Debug, Deserialize, PartialEq)]\n    struct TestStruct {\n        name: String,\n        value: i32,\n    }\n\n    #[derive(Debug, Deserialize, PartialEq)]\n    struct NestedStruct {\n        id: String,\n        data: InnerData,\n    }\n\n    #[derive(Debug, Deserialize, PartialEq)]\n    struct InnerData {\n        tokens: i64,\n        cost: f64,\n    }\n\n    #[test]\n    fn test_parse_json_file_simple() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"test.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(br#\"{\"name\": \"test\", \"value\": 42}\"#).unwrap();\n\n        let result: TestStruct = parse_json_file(\u0026file_path).unwrap();\n        assert_eq!(result.name, \"test\");\n        assert_eq!(result.value, 42);\n    }\n\n    #[test]\n    fn test_parse_json_file_nested() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"nested.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(br#\"{\"id\": \"session-001\", \"data\": {\"tokens\": 1000, \"cost\": 0.05}}\"#)\n            .unwrap();\n\n        let result: NestedStruct = parse_json_file(\u0026file_path).unwrap();\n        assert_eq!(result.id, \"session-001\");\n        assert_eq!(result.data.tokens, 1000);\n        assert_eq!(result.data.cost, 0.05);\n    }\n\n    #[test]\n    fn test_parse_json_file_unicode() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"unicode.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(r#\"{\"name\": \"í…ŒìŠ¤íŠ¸\", \"value\": 100}\"#.as_bytes())\n            .unwrap();\n\n        let result: TestStruct = parse_json_file(\u0026file_path).unwrap();\n        assert_eq!(result.name, \"í…ŒìŠ¤íŠ¸\");\n        assert_eq!(result.value, 100);\n    }\n\n    #[test]\n    fn test_parse_json_file_not_found() {\n        let result: Result\u003cTestStruct, _\u003e = parse_json_file(Path::new(\"/nonexistent/file.json\"));\n        assert!(matches!(result, Err(ParseError::IoError(_))));\n    }\n\n    #[test]\n    fn test_parse_json_file_invalid_json() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"invalid.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(b\"not valid json {\").unwrap();\n\n        let result: Result\u003cTestStruct, _\u003e = parse_json_file(\u0026file_path);\n        assert!(matches!(result, Err(ParseError::JsonError(_))));\n    }\n\n    #[test]\n    fn test_parse_json_file_empty() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"empty.json\");\n\n        File::create(\u0026file_path).unwrap();\n\n        let result: Result\u003cTestStruct, _\u003e = parse_json_file(\u0026file_path);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_basic() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"test.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, r#\"{{\"name\": \"first\", \"value\": 1}}\"#).unwrap();\n        writeln!(file, r#\"{{\"name\": \"second\", \"value\": 2}}\"#).unwrap();\n        writeln!(file, r#\"{{\"name\": \"third\", \"value\": 3}}\"#).unwrap();\n\n        let mut results: Vec\u003cTestStruct\u003e = Vec::new();\n        parse_jsonl_file(\u0026file_path, |item: TestStruct| {\n            results.push(item);\n        })\n        .unwrap();\n\n        assert_eq!(results.len(), 3);\n        assert_eq!(results[0].name, \"first\");\n        assert_eq!(results[1].value, 2);\n        assert_eq!(results[2].name, \"third\");\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_with_empty_lines() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"with_empty.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, r#\"{{\"name\": \"a\", \"value\": 1}}\"#).unwrap();\n        writeln!(file, \"\").unwrap(); // Empty line\n        writeln!(file, \"   \").unwrap(); // Whitespace only\n        writeln!(file, r#\"{{\"name\": \"b\", \"value\": 2}}\"#).unwrap();\n\n        let mut results: Vec\u003cTestStruct\u003e = Vec::new();\n        parse_jsonl_file(\u0026file_path, |item: TestStruct| {\n            results.push(item);\n        })\n        .unwrap();\n\n        assert_eq!(results.len(), 2);\n        assert_eq!(results[0].name, \"a\");\n        assert_eq!(results[1].name, \"b\");\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_with_malformed_lines() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"malformed.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, r#\"{{\"name\": \"good\", \"value\": 1}}\"#).unwrap();\n        writeln!(file, \"not valid json\").unwrap(); // Should be skipped\n        writeln!(file, r#\"{{\"incomplete\"#).unwrap(); // Should be skipped\n        writeln!(file, r#\"{{\"name\": \"also good\", \"value\": 2}}\"#).unwrap();\n\n        let mut results: Vec\u003cTestStruct\u003e = Vec::new();\n        parse_jsonl_file(\u0026file_path, |item: TestStruct| {\n            results.push(item);\n        })\n        .unwrap();\n\n        // Only valid lines should be parsed\n        assert_eq!(results.len(), 2);\n        assert_eq!(results[0].name, \"good\");\n        assert_eq!(results[1].name, \"also good\");\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_empty() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"empty.jsonl\");\n\n        File::create(\u0026file_path).unwrap();\n\n        let mut count = 0;\n        parse_jsonl_file(\u0026file_path, |_: TestStruct| {\n            count += 1;\n        })\n        .unwrap();\n\n        assert_eq!(count, 0);\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_not_found() {\n        let result = parse_jsonl_file(Path::new(\"/nonexistent/file.jsonl\"), |_: TestStruct| {});\n        assert!(matches!(result, Err(ParseError::IoError(_))));\n    }\n\n    #[test]\n    fn test_parse_jsonl_large_file() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"large.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        for i in 0..1000 {\n            writeln!(file, r#\"{{\"name\": \"item-{}\", \"value\": {}}}\"#, i, i).unwrap();\n        }\n\n        let mut count = 0;\n        parse_jsonl_file(\u0026file_path, |_: TestStruct| {\n            count += 1;\n        })\n        .unwrap();\n\n        assert_eq!(count, 1000);\n    }\n\n    #[test]\n    fn test_parse_error_display() {\n        let io_error = ParseError::IoError(\"file not found\".to_string());\n        assert!(io_error.to_string().contains(\"IO error\"));\n\n        let json_error = ParseError::JsonError(\"unexpected token\".to_string());\n        assert!(json_error.to_string().contains(\"JSON parse error\"));\n    }\n}\n","traces":[{"line":10,"address":[],"length":0,"stats":{"Line":6}},{"line":11,"address":[],"length":0,"stats":{"Line":26}},{"line":13,"address":[],"length":0,"stats":{"Line":19}},{"line":17,"address":[],"length":0,"stats":{"Line":6}},{"line":22,"address":[],"length":0,"stats":{"Line":26}},{"line":23,"address":[],"length":0,"stats":{"Line":15}},{"line":25,"address":[],"length":0,"stats":{"Line":1021}},{"line":26,"address":[],"length":0,"stats":{"Line":3033}},{"line":27,"address":[],"length":0,"stats":{"Line":2022}},{"line":28,"address":[],"length":0,"stats":{"Line":2022}},{"line":29,"address":[],"length":0,"stats":{"Line":2}},{"line":32,"address":[],"length":0,"stats":{"Line":3027}},{"line":33,"address":[],"length":0,"stats":{"Line":1009}},{"line":34,"address":[],"length":0,"stats":{"Line":2014}},{"line":35,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":5}}],"covered":16,"coverable":16},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","aliases.rs"],"content":"use once_cell::sync::Lazy;\nuse std::collections::HashMap;\n\nstatic MODEL_ALIASES: Lazy\u003cHashMap\u003c\u0026'static str, \u0026'static str\u003e\u003e = Lazy::new(|| {\n    let mut m = HashMap::new();\n    m.insert(\"big-pickle\", \"glm-4.7\");\n    m.insert(\"big pickle\", \"glm-4.7\");\n    m.insert(\"bigpickle\", \"glm-4.7\");\n    m.insert(\"k2p5\", \"kimi-k2-thinking\");\n    m.insert(\"k2-p5\", \"kimi-k2-thinking\");\n    m.insert(\"kimi-k2.5-thinking\", \"kimi-k2-thinking\");\n    m\n});\n\npub fn resolve_alias(model_id: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    MODEL_ALIASES.get(model_id.to_lowercase().as_str()).copied()\n}\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":3}},{"line":5,"address":[],"length":0,"stats":{"Line":6}},{"line":6,"address":[],"length":0,"stats":{"Line":6}},{"line":7,"address":[],"length":0,"stats":{"Line":12}},{"line":8,"address":[],"length":0,"stats":{"Line":12}},{"line":9,"address":[],"length":0,"stats":{"Line":12}},{"line":10,"address":[],"length":0,"stats":{"Line":12}},{"line":11,"address":[],"length":0,"stats":{"Line":12}},{"line":12,"address":[],"length":0,"stats":{"Line":3}},{"line":15,"address":[],"length":0,"stats":{"Line":223}},{"line":16,"address":[],"length":0,"stats":{"Line":892}}],"covered":11,"coverable":11},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","cache.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::path::PathBuf;\nuse std::time::SystemTime;\n\nconst CACHE_TTL_SECS: u64 = 3600;\n\npub fn get_cache_dir() -\u003e PathBuf {\n    dirs::cache_dir()\n        .unwrap_or_else(|| PathBuf::from(\"/tmp\"))\n        .join(\"tokscale\")\n}\n\npub fn get_cache_path(filename: \u0026str) -\u003e PathBuf {\n    get_cache_dir().join(filename)\n}\n\n#[derive(Serialize, Deserialize)]\npub struct CachedData\u003cT\u003e {\n    pub timestamp: u64,\n    pub data: T,\n}\n\npub fn load_cache\u003cT: for\u003c'de\u003e Deserialize\u003c'de\u003e\u003e(filename: \u0026str) -\u003e Option\u003cT\u003e {\n    let path = get_cache_path(filename);\n    let content = fs::read_to_string(\u0026path).ok()?;\n    let cached: CachedData\u003cT\u003e = serde_json::from_str(\u0026content).ok()?;\n\n    let now = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .ok()?\n        .as_secs();\n\n    if cached.timestamp \u003e now || now.saturating_sub(cached.timestamp) \u003e CACHE_TTL_SECS {\n        return None;\n    }\n\n    Some(cached.data)\n}\n\npub fn save_cache\u003cT: Serialize\u003e(filename: \u0026str, data: \u0026T) -\u003e Result\u003c(), std::io::Error\u003e {\n    let dir = get_cache_dir();\n    fs::create_dir_all(\u0026dir)?;\n\n    let now = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .unwrap_or(std::time::Duration::ZERO)\n        .as_secs();\n\n    let cached = CachedData {\n        timestamp: now,\n        data,\n    };\n    let content = serde_json::to_string(\u0026cached)?;\n\n    let final_path = get_cache_path(filename);\n    let nanos = std::time::SystemTime::now()\n        .duration_since(std::time::UNIX_EPOCH)\n        .map(|d| d.as_nanos() as u64)\n        .unwrap_or(0);\n    let tmp_filename = format!(\".{}.{}.{:x}.tmp\", filename, std::process::id(), nanos);\n    let tmp_path = dir.join(\u0026tmp_filename);\n\n    use std::io::Write;\n    let write_result = (|| {\n        let mut file = fs::File::create(\u0026tmp_path)?;\n        file.write_all(content.as_bytes())?;\n        file.sync_all()?;\n        fs::rename(\u0026tmp_path, \u0026final_path)\n    })();\n\n    if write_result.is_err() {\n        let _ = fs::remove_file(\u0026tmp_path);\n    }\n\n    write_result\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":4}},{"line":9,"address":[],"length":0,"stats":{"Line":4}},{"line":10,"address":[],"length":0,"stats":{"Line":4}},{"line":14,"address":[],"length":0,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":8}},{"line":24,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":12}},{"line":26,"address":[],"length":0,"stats":{"Line":16}},{"line":27,"address":[],"length":0,"stats":{"Line":20}},{"line":29,"address":[],"length":0,"stats":{"Line":8}},{"line":30,"address":[],"length":0,"stats":{"Line":4}},{"line":34,"address":[],"length":0,"stats":{"Line":12}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}}],"covered":13,"coverable":35},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","litellm.rs"],"content":"use super::cache;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\nconst CACHE_FILENAME: \u0026str = \"pricing-litellm.json\";\nconst PRICING_URL: \u0026str =\n    \"https://raw.githubusercontent.com/BerriAI/litellm/main/model_prices_and_context_window.json\";\nconst MAX_RETRIES: u32 = 3;\nconst INITIAL_BACKOFF_MS: u64 = 200;\n\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct ModelPricing {\n    pub input_cost_per_token: Option\u003cf64\u003e,\n    pub output_cost_per_token: Option\u003cf64\u003e,\n    pub cache_creation_input_token_cost: Option\u003cf64\u003e,\n    pub cache_read_input_token_cost: Option\u003cf64\u003e,\n}\n\npub type PricingDataset = HashMap\u003cString, ModelPricing\u003e;\n\npub fn load_cached() -\u003e Option\u003cPricingDataset\u003e {\n    cache::load_cache(CACHE_FILENAME)\n}\n\npub async fn fetch() -\u003e Result\u003cPricingDataset, reqwest::Error\u003e {\n    if let Some(cached) = load_cached() {\n        return Ok(cached);\n    }\n\n    let client = reqwest::Client::builder()\n        .timeout(std::time::Duration::from_secs(30))\n        .connect_timeout(std::time::Duration::from_secs(10))\n        .build()?;\n\n    let mut last_error: Option\u003creqwest::Error\u003e = None;\n\n    for attempt in 0..MAX_RETRIES {\n        match client.get(PRICING_URL).send().await {\n            Ok(response) =\u003e {\n                let status = response.status();\n\n                if status.is_server_error() || status == reqwest::StatusCode::TOO_MANY_REQUESTS {\n                    eprintln!(\n                        \"[tokscale] LiteLLM HTTP {} (attempt {}/{})\",\n                        status,\n                        attempt + 1,\n                        MAX_RETRIES\n                    );\n                    let _ = response.bytes().await;\n                    if attempt \u003c MAX_RETRIES - 1 {\n                        tokio::time::sleep(std::time::Duration::from_millis(\n                            INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                        ))\n                        .await;\n                    }\n                    continue;\n                }\n\n                if !status.is_success() {\n                    eprintln!(\"[tokscale] LiteLLM HTTP {}\", status);\n                    return Err(response.error_for_status().unwrap_err());\n                }\n\n                match response.json::\u003cPricingDataset\u003e().await {\n                    Ok(data) =\u003e {\n                        let _ = cache::save_cache(CACHE_FILENAME, \u0026data);\n                        return Ok(data);\n                    }\n                    Err(e) =\u003e {\n                        eprintln!(\"[tokscale] LiteLLM JSON parse failed: {}\", e);\n                        return Err(e);\n                    }\n                }\n            }\n            Err(e) =\u003e {\n                eprintln!(\n                    \"[tokscale] LiteLLM network error (attempt {}/{}): {}\",\n                    attempt + 1,\n                    MAX_RETRIES,\n                    e\n                );\n                last_error = Some(e);\n                if attempt \u003c MAX_RETRIES - 1 {\n                    tokio::time::sleep(std::time::Duration::from_millis(\n                        INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                    ))\n                    .await;\n                }\n            }\n        }\n    }\n\n    Err(last_error.expect(\"should have error after retries\"))\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":22,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":4}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}}],"covered":5,"coverable":41},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","lookup.rs"],"content":"use super::{aliases, litellm::ModelPricing};\nuse std::collections::HashMap;\nuse std::sync::RwLock;\n\nconst PROVIDER_PREFIXES: \u0026[\u0026str] = \u0026[\n    \"openai/\",\n    \"anthropic/\",\n    \"google/\",\n    \"meta-llama/\",\n    \"mistralai/\",\n    \"deepseek/\",\n    \"qwen/\",\n    \"cohere/\",\n    \"perplexity/\",\n    \"x-ai/\",\n];\n\nconst ORIGINAL_PROVIDER_PREFIXES: \u0026[\u0026str] = \u0026[\n    \"x-ai/\",\n    \"xai/\",\n    \"anthropic/\",\n    \"openai/\",\n    \"google/\",\n    \"meta-llama/\",\n    \"mistralai/\",\n    \"deepseek/\",\n    \"z-ai/\",\n    \"qwen/\",\n    \"cohere/\",\n    \"perplexity/\",\n    \"moonshotai/\",\n];\n\nconst RESELLER_PROVIDER_PREFIXES: \u0026[\u0026str] = \u0026[\n    \"azure/\",\n    \"azure_ai/\",\n    \"bedrock/\",\n    \"vertex_ai/\",\n    \"together/\",\n    \"together_ai/\",\n    \"fireworks_ai/\",\n    \"groq/\",\n    \"openrouter/\",\n];\n\nconst FUZZY_BLOCKLIST: \u0026[\u0026str] = \u0026[\"auto\", \"mini\", \"chat\", \"base\"];\n\nconst MIN_FUZZY_MATCH_LEN: usize = 5;\n\n/// Minimum length for a model name candidate after prefix/suffix stripping.\n/// Prevents false positives like \"pro\" or \"flash\" being matched alone.\nconst MIN_MODEL_NAME_LEN: usize = 2;\n\n/// Maximum number of leading segments that can be treated as a routing prefix.\n/// Limits how aggressively we strip (e.g., \"a-b-claude-3\" strips at most \"a-b-\").\nconst MAX_PREFIX_STRIP_SEGMENTS: usize = 2;\n\n/// Maximum number of trailing segments that can be treated as a routing suffix.\n/// Handles tier suffixes (-high, -low) and variant suffixes (-thinking, -codex, -codex-max-xhigh).\nconst MAX_SUFFIX_STRIP_SEGMENTS: usize = 4;\n\n#[derive(Clone)]\nstruct CachedResult {\n    pricing: ModelPricing,\n    source: String,\n    matched_key: String,\n}\n\npub struct PricingLookup {\n    litellm: HashMap\u003cString, ModelPricing\u003e,\n    openrouter: HashMap\u003cString, ModelPricing\u003e,\n    litellm_keys: Vec\u003cString\u003e,\n    openrouter_keys: Vec\u003cString\u003e,\n    litellm_lower: HashMap\u003cString, String\u003e,\n    openrouter_lower: HashMap\u003cString, String\u003e,\n    openrouter_model_part: HashMap\u003cString, String\u003e,\n    lookup_cache: RwLock\u003cHashMap\u003cString, Option\u003cCachedResult\u003e\u003e\u003e,\n}\n\npub struct LookupResult {\n    pub pricing: ModelPricing,\n    pub source: String,\n    pub matched_key: String,\n}\n\nimpl PricingLookup {\n    pub fn new(\n        litellm: HashMap\u003cString, ModelPricing\u003e,\n        openrouter: HashMap\u003cString, ModelPricing\u003e,\n    ) -\u003e Self {\n        let mut litellm_keys: Vec\u003cString\u003e = litellm.keys().cloned().collect();\n        litellm_keys.sort_by_key(|k| std::cmp::Reverse(k.len()));\n\n        let mut openrouter_keys: Vec\u003cString\u003e = openrouter.keys().cloned().collect();\n        openrouter_keys.sort_by_key(|k| std::cmp::Reverse(k.len()));\n\n        let mut litellm_lower = HashMap::with_capacity(litellm.len());\n        for key in \u0026litellm_keys {\n            litellm_lower.insert(key.to_lowercase(), key.clone());\n        }\n\n        let mut openrouter_lower = HashMap::with_capacity(openrouter.len());\n        let mut openrouter_model_part = HashMap::with_capacity(openrouter.len());\n        for key in \u0026openrouter_keys {\n            let lower = key.to_lowercase();\n            openrouter_lower.insert(lower.clone(), key.clone());\n            if let Some(model_part) = lower.split('/').next_back() {\n                if model_part != lower {\n                    openrouter_model_part.insert(model_part.to_string(), key.clone());\n                }\n            }\n        }\n\n        Self {\n            litellm,\n            openrouter,\n            litellm_keys,\n            openrouter_keys,\n            litellm_lower,\n            openrouter_lower,\n            openrouter_model_part,\n            lookup_cache: RwLock::new(HashMap::with_capacity(64)),\n        }\n    }\n\n    pub fn lookup(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(cached) = self\n            .lookup_cache\n            .read()\n            .ok()\n            .and_then(|c| c.get(model_id).cloned())\n        {\n            return cached.map(|c| LookupResult {\n                pricing: c.pricing,\n                source: c.source,\n                matched_key: c.matched_key,\n            });\n        }\n\n        let result = self.lookup_with_source(model_id, None);\n\n        if let Ok(mut cache) = self.lookup_cache.write() {\n            cache.insert(\n                model_id.to_string(),\n                result.as_ref().map(|r| CachedResult {\n                    pricing: r.pricing.clone(),\n                    source: r.source.clone(),\n                    matched_key: r.matched_key.clone(),\n                }),\n            );\n        }\n\n        result\n    }\n\n    pub fn lookup_with_source(\n        \u0026self,\n        model_id: \u0026str,\n        force_source: Option\u003c\u0026str\u003e,\n    ) -\u003e Option\u003cLookupResult\u003e {\n        let canonical = aliases::resolve_alias(model_id).unwrap_or(model_id);\n        let lower = canonical.to_lowercase();\n\n        // Helper to perform lookup with the given source constraint\n        let do_lookup = |id: \u0026str| match force_source {\n            Some(\"litellm\") =\u003e self.lookup_litellm_only(id),\n            Some(\"openrouter\") =\u003e self.lookup_openrouter_only(id),\n            _ =\u003e self.lookup_auto(id),\n        };\n\n        // 1. Try direct lookup\n        if let Some(result) = do_lookup(\u0026lower) {\n            return Some(result);\n        }\n\n        // 2. Try stripping unknown suffixes (e.g., -thinking, -high, -codex)\n        if let Some(result) = try_strip_unknown_suffix(\u0026lower, do_lookup) {\n            return Some(result);\n        }\n\n        // 3. Try stripping unknown prefixes (e.g., antigravity-, myplugin-)\n        //    For each prefix candidate, also try suffix stripping\n        if let Some(result) = try_strip_unknown_prefix(\u0026lower, do_lookup) {\n            return Some(result);\n        }\n\n        None\n    }\n\n    fn lookup_auto(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(result) = self.exact_match_litellm(model_id) {\n            return Some(result);\n        }\n\n        if let Some(result) = self.exact_match_openrouter(model_id) {\n            return Some(result);\n        }\n\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n            if let Some(result) = self.exact_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n\n        if let Some(normalized) = normalize_model_name(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026normalized) {\n                return Some(result);\n            }\n            if let Some(result) = self.exact_match_openrouter(\u0026normalized) {\n                return Some(result);\n            }\n        }\n\n        if let Some(result) = self.prefix_match_litellm(model_id) {\n            return Some(result);\n        }\n        if let Some(result) = self.prefix_match_openrouter(model_id) {\n            return Some(result);\n        }\n\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.prefix_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n            if let Some(result) = self.prefix_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n\n        if !is_fuzzy_eligible(model_id) {\n            return None;\n        }\n\n        let litellm_result = self.fuzzy_match_litellm(model_id);\n        let openrouter_result = self.fuzzy_match_openrouter(model_id);\n\n        match (\u0026litellm_result, \u0026openrouter_result) {\n            (Some(l), Some(o)) =\u003e {\n                let l_is_original = is_original_provider(\u0026l.matched_key);\n                let o_is_original = is_original_provider(\u0026o.matched_key);\n                let l_is_reseller = is_reseller_provider(\u0026l.matched_key);\n                let o_is_reseller = is_reseller_provider(\u0026o.matched_key);\n\n                if o_is_original \u0026\u0026 !l_is_original {\n                    return openrouter_result;\n                }\n                if l_is_original \u0026\u0026 !o_is_original {\n                    return litellm_result;\n                }\n                if !l_is_reseller \u0026\u0026 o_is_reseller {\n                    return litellm_result;\n                }\n                if !o_is_reseller \u0026\u0026 l_is_reseller {\n                    return openrouter_result;\n                }\n                litellm_result\n            }\n            (Some(_), None) =\u003e litellm_result,\n            (None, Some(_)) =\u003e openrouter_result,\n            (None, None) =\u003e None,\n        }\n    }\n\n    fn lookup_litellm_only(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(result) = self.exact_match_litellm(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(normalized) = normalize_model_name(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(result) = self.prefix_match_litellm(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.prefix_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if is_fuzzy_eligible(model_id) {\n            if let Some(result) = self.fuzzy_match_litellm(model_id) {\n                return Some(result);\n            }\n        }\n        None\n    }\n\n    fn lookup_openrouter_only(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(result) = self.exact_match_openrouter(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.exact_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(normalized) = normalize_model_name(model_id) {\n            if let Some(result) = self.exact_match_openrouter(\u0026normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(result) = self.prefix_match_openrouter(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.prefix_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if is_fuzzy_eligible(model_id) {\n            if let Some(result) = self.fuzzy_match_openrouter(model_id) {\n                return Some(result);\n            }\n        }\n        None\n    }\n\n    fn exact_match_litellm(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        let key = self.litellm_lower.get(model_id)?;\n        let pricing = self.litellm.get(key)?;\n        Some(LookupResult {\n            pricing: pricing.clone(),\n            source: \"LiteLLM\".into(),\n            matched_key: key.clone(),\n        })\n    }\n\n    fn exact_match_openrouter(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(key) = self.openrouter_lower.get(model_id) {\n            if let Some(pricing) = self.openrouter.get(key) {\n                return Some(LookupResult {\n                    pricing: pricing.clone(),\n                    source: \"OpenRouter\".into(),\n                    matched_key: key.clone(),\n                });\n            }\n        }\n        if let Some(key) = self.openrouter_model_part.get(model_id) {\n            if let Some(pricing) = self.openrouter.get(key) {\n                return Some(LookupResult {\n                    pricing: pricing.clone(),\n                    source: \"OpenRouter\".into(),\n                    matched_key: key.clone(),\n                });\n            }\n        }\n        None\n    }\n\n    fn prefix_match_litellm(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        for prefix in PROVIDER_PREFIXES {\n            let key = format!(\"{}{}\", prefix, model_id);\n            if let Some(litellm_key) = self.litellm_lower.get(\u0026key) {\n                if let Some(pricing) = self.litellm.get(litellm_key) {\n                    return Some(LookupResult {\n                        pricing: pricing.clone(),\n                        source: \"LiteLLM\".into(),\n                        matched_key: litellm_key.clone(),\n                    });\n                }\n            }\n        }\n        None\n    }\n\n    fn prefix_match_openrouter(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        for prefix in PROVIDER_PREFIXES {\n            let key = format!(\"{}{}\", prefix, model_id);\n            if let Some(or_key) = self.openrouter_lower.get(\u0026key) {\n                if let Some(pricing) = self.openrouter.get(or_key) {\n                    return Some(LookupResult {\n                        pricing: pricing.clone(),\n                        source: \"OpenRouter\".into(),\n                        matched_key: or_key.clone(),\n                    });\n                }\n            }\n        }\n        None\n    }\n\n    fn fuzzy_match_litellm(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        let family = extract_model_family(model_id);\n        let mut family_matches_list: Vec\u003c\u0026String\u003e = Vec::new();\n\n        for key in \u0026self.litellm_keys {\n            let lower_key = key.to_lowercase();\n            if family_matches(\u0026lower_key, \u0026family) \u0026\u0026 contains_model_id(\u0026lower_key, model_id) {\n                family_matches_list.push(key);\n            }\n        }\n\n        if let Some(result) = select_best_match(\u0026family_matches_list, \u0026self.litellm, \"LiteLLM\") {\n            return Some(result);\n        }\n\n        let mut all_matches: Vec\u003c\u0026String\u003e = Vec::new();\n        for key in \u0026self.litellm_keys {\n            let lower_key = key.to_lowercase();\n            if contains_model_id(\u0026lower_key, model_id) {\n                all_matches.push(key);\n            }\n        }\n\n        select_best_match(\u0026all_matches, \u0026self.litellm, \"LiteLLM\")\n    }\n\n    fn fuzzy_match_openrouter(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        let family = extract_model_family(model_id);\n        let mut family_matches_list: Vec\u003c\u0026String\u003e = Vec::new();\n\n        for key in \u0026self.openrouter_keys {\n            let lower_key = key.to_lowercase();\n            let model_part = lower_key.split('/').next_back().unwrap_or(\u0026lower_key);\n            if family_matches(model_part, \u0026family) \u0026\u0026 contains_model_id(model_part, model_id) {\n                family_matches_list.push(key);\n            }\n        }\n\n        if let Some(result) =\n            select_best_match(\u0026family_matches_list, \u0026self.openrouter, \"OpenRouter\")\n        {\n            return Some(result);\n        }\n\n        let mut all_matches: Vec\u003c\u0026String\u003e = Vec::new();\n        for key in \u0026self.openrouter_keys {\n            let lower_key = key.to_lowercase();\n            let model_part = lower_key.split('/').next_back().unwrap_or(\u0026lower_key);\n            if contains_model_id(model_part, model_id) {\n                all_matches.push(key);\n            }\n        }\n\n        select_best_match(\u0026all_matches, \u0026self.openrouter, \"OpenRouter\")\n    }\n\n    pub fn calculate_cost(\n        \u0026self,\n        model_id: \u0026str,\n        input: i64,\n        output: i64,\n        cache_read: i64,\n        cache_write: i64,\n        reasoning: i64,\n    ) -\u003e f64 {\n        let result = match self.lookup(model_id) {\n            Some(r) =\u003e r,\n            None =\u003e return 0.0,\n        };\n\n        let p = \u0026result.pricing;\n        let safe_price =\n            |opt: Option\u003cf64\u003e| opt.filter(|v| v.is_finite() \u0026\u0026 *v \u003e= 0.0).unwrap_or(0.0);\n\n        // Clamp negative tokens to 0 to prevent negative costs\n        let input_clamped = input.max(0) as f64;\n        let output_clamped = output.max(0).saturating_add(reasoning.max(0)) as f64;\n        let cache_read_clamped = cache_read.max(0) as f64;\n        let cache_write_clamped = cache_write.max(0) as f64;\n\n        let input_cost = input_clamped * safe_price(p.input_cost_per_token);\n        let output_cost = output_clamped * safe_price(p.output_cost_per_token);\n        let cache_read_cost = cache_read_clamped * safe_price(p.cache_read_input_token_cost);\n        let cache_write_cost = cache_write_clamped * safe_price(p.cache_creation_input_token_cost);\n\n        input_cost + output_cost + cache_read_cost + cache_write_cost\n    }\n}\n\nfn extract_model_family(model_id: \u0026str) -\u003e String {\n    let lower = model_id.to_lowercase();\n\n    if lower.contains(\"gpt-5\") {\n        return \"gpt-5\".into();\n    }\n    if lower.contains(\"gpt-4.1\") {\n        return \"gpt-4.1\".into();\n    }\n    if lower.contains(\"gpt-4o\") {\n        return \"gpt-4o\".into();\n    }\n    if lower.contains(\"gpt-4\") {\n        return \"gpt-4\".into();\n    }\n    if lower.contains(\"o3\") {\n        return \"o3\".into();\n    }\n    if lower.contains(\"o4\") {\n        return \"o4\".into();\n    }\n\n    if lower.contains(\"opus\") {\n        return \"opus\".into();\n    }\n    if lower.contains(\"sonnet\") {\n        return \"sonnet\".into();\n    }\n    if lower.contains(\"haiku\") {\n        return \"haiku\".into();\n    }\n    if lower.contains(\"claude\") {\n        return \"claude\".into();\n    }\n\n    if lower.contains(\"gemini-3\") {\n        return \"gemini-3\".into();\n    }\n    if lower.contains(\"gemini-2.5\") {\n        return \"gemini-2.5\".into();\n    }\n    if lower.contains(\"gemini-2\") {\n        return \"gemini-2\".into();\n    }\n    if lower.contains(\"gemini\") {\n        return \"gemini\".into();\n    }\n\n    if lower.contains(\"llama\") {\n        return \"llama\".into();\n    }\n    if lower.contains(\"mistral\") {\n        return \"mistral\".into();\n    }\n    if lower.contains(\"deepseek\") {\n        return \"deepseek\".into();\n    }\n    if lower.contains(\"qwen\") {\n        return \"qwen\".into();\n    }\n\n    lower\n        .split(['-', '_', '.'])\n        .next()\n        .unwrap_or(\u0026lower)\n        .to_string()\n}\n\nfn family_matches(key: \u0026str, family: \u0026str) -\u003e bool {\n    if family.is_empty() {\n        return true;\n    }\n    key.contains(family)\n}\n\nfn contains_model_id(key: \u0026str, model_id: \u0026str) -\u003e bool {\n    if let Some(pos) = key.find(model_id) {\n        let before_ok = pos == 0 || !key[..pos].chars().last().unwrap().is_alphanumeric();\n        let after_pos = pos + model_id.len();\n        let after_ok =\n            after_pos == key.len() || !key[after_pos..].chars().next().unwrap().is_alphanumeric();\n        before_ok \u0026\u0026 after_ok\n    } else {\n        false\n    }\n}\n\nfn normalize_model_name(model_id: \u0026str) -\u003e Option\u003cString\u003e {\n    let lower = model_id.to_lowercase();\n\n    if lower.contains(\"opus\") {\n        if lower.contains(\"4.5\") || lower.contains(\"4-5\") {\n            return Some(\"claude-opus-4-5\".into());\n        } else if lower.contains(\"4\") {\n            return Some(\"claude-opus-4\".into());\n        }\n    }\n    if lower.contains(\"sonnet\") {\n        if lower.contains(\"4.5\") || lower.contains(\"4-5\") {\n            return Some(\"claude-sonnet-4-5\".into());\n        } else if lower.contains(\"4\") \u0026\u0026 !lower.contains(\"3.\") \u0026\u0026 !lower.contains(\"3-\") {\n            return Some(\"claude-sonnet-4\".into());\n        } else if lower.contains(\"3.7\") || lower.contains(\"3-7\") {\n            return Some(\"claude-3-7-sonnet\".into());\n        } else if lower.contains(\"3.5\") || lower.contains(\"3-5\") {\n            return Some(\"claude-3.5-sonnet\".into());\n        }\n    }\n    if lower.contains(\"haiku\") {\n        if lower.contains(\"4.5\") || lower.contains(\"4-5\") {\n            return Some(\"claude-haiku-4-5\".into());\n        } else if lower.contains(\"3.5\") || lower.contains(\"3-5\") {\n            return Some(\"claude-3.5-haiku\".into());\n        }\n    }\n\n    None\n}\n\nfn normalize_version_separator(model_id: \u0026str) -\u003e Option\u003cString\u003e {\n    let mut result = String::with_capacity(model_id.len());\n    let chars: Vec\u003cchar\u003e = model_id.chars().collect();\n    let mut changed = false;\n\n    for i in 0..chars.len() {\n        if chars[i] == '-'\n            \u0026\u0026 i \u003e 0\n            \u0026\u0026 i \u003c chars.len() - 1\n            \u0026\u0026 chars[i - 1].is_ascii_digit()\n            \u0026\u0026 chars[i + 1].is_ascii_digit()\n        {\n            let is_multi_digit_before = i \u003e= 2 \u0026\u0026 chars[i - 2].is_ascii_digit();\n            let is_multi_digit_after = i + 2 \u003c chars.len() \u0026\u0026 chars[i + 2].is_ascii_digit();\n            let looks_like_date = is_multi_digit_before || is_multi_digit_after;\n\n            if looks_like_date {\n                result.push(chars[i]);\n            } else {\n                result.push('.');\n                changed = true;\n            }\n        } else {\n            result.push(chars[i]);\n        }\n    }\n\n    if changed {\n        Some(result)\n    } else {\n        None\n    }\n}\n\nfn is_fuzzy_eligible(model_id: \u0026str) -\u003e bool {\n    if model_id.len() \u003c MIN_FUZZY_MATCH_LEN {\n        return false;\n    }\n    !FUZZY_BLOCKLIST.contains(\u0026model_id)\n}\n\n/// Attempts to find a model by progressively stripping trailing segments.\n/// Handles arbitrary suffixes (e.g., \"claude-sonnet-4-5-thinking\" â†’ \"claude-sonnet-4-5\").\n/// This replaces the hardcoded TIER_SUFFIXES and FALLBACK_SUFFIXES approach.\nfn try_strip_unknown_suffix\u003cF\u003e(model_id: \u0026str, do_lookup: F) -\u003e Option\u003cLookupResult\u003e\nwhere\n    F: Fn(\u0026str) -\u003e Option\u003cLookupResult\u003e,\n{\n    let parts: Vec\u003c\u0026str\u003e = model_id.split('-').collect();\n\n    if parts.len() \u003c 2 {\n        return None;\n    }\n\n    let max_strip = std::cmp::min(parts.len() - 1, MAX_SUFFIX_STRIP_SEGMENTS);\n\n    for strip in 1..=max_strip {\n        let candidate: String = parts[..parts.len() - strip].join(\"-\");\n\n        if candidate.len() \u003e= MIN_MODEL_NAME_LEN {\n            if let Some(result) = do_lookup(\u0026candidate) {\n                return Some(result);\n            }\n        }\n    }\n\n    None\n}\n\n/// Attempts to find a model by progressively stripping leading segments.\n/// Handles arbitrary routing prefixes (e.g., \"myplugin-claude-3.5-sonnet\" â†’ \"claude-3.5-sonnet\").\n/// This replaces the hardcoded STRIPPED_PREFIXES approach.\nfn try_strip_unknown_prefix\u003cF\u003e(model_id: \u0026str, do_lookup: F) -\u003e Option\u003cLookupResult\u003e\nwhere\n    F: Fn(\u0026str) -\u003e Option\u003cLookupResult\u003e,\n{\n    let parts: Vec\u003c\u0026str\u003e = model_id.split('-').collect();\n\n    if parts.len() \u003c 2 {\n        return None;\n    }\n\n    let max_skip = std::cmp::min(parts.len() - 1, MAX_PREFIX_STRIP_SEGMENTS);\n\n    for skip in 1..=max_skip {\n        let candidate: String = parts[skip..].join(\"-\");\n\n        if candidate.len() \u003e= MIN_MODEL_NAME_LEN {\n            // Try candidate directly\n            if let Some(result) = do_lookup(\u0026candidate) {\n                return Some(result);\n            }\n\n            // Try candidate with suffix stripping\n            if let Some(result) = try_strip_unknown_suffix(\u0026candidate, \u0026do_lookup) {\n                return Some(result);\n            }\n        }\n    }\n\n    None\n}\n\nfn is_original_provider(key: \u0026str) -\u003e bool {\n    let lower = key.to_lowercase();\n    ORIGINAL_PROVIDER_PREFIXES\n        .iter()\n        .any(|prefix| lower.starts_with(prefix))\n}\n\nfn is_reseller_provider(key: \u0026str) -\u003e bool {\n    let lower = key.to_lowercase();\n    RESELLER_PROVIDER_PREFIXES\n        .iter()\n        .any(|prefix| lower.starts_with(prefix))\n}\n\nfn select_best_match(\n    matches: \u0026[\u0026String],\n    dataset: \u0026HashMap\u003cString, ModelPricing\u003e,\n    source: \u0026str,\n) -\u003e Option\u003cLookupResult\u003e {\n    if matches.is_empty() {\n        return None;\n    }\n\n    if let Some(key) = matches.iter().find(|k| is_original_provider(k)) {\n        if let Some(pricing) = dataset.get(*key) {\n            return Some(LookupResult {\n                pricing: pricing.clone(),\n                source: source.into(),\n                matched_key: (*key).clone(),\n            });\n        }\n    }\n\n    if let Some(key) = matches.iter().find(|k| !is_reseller_provider(k)) {\n        if let Some(pricing) = dataset.get(*key) {\n            return Some(LookupResult {\n                pricing: pricing.clone(),\n                source: source.into(),\n                matched_key: (*key).clone(),\n            });\n        }\n    }\n\n    let key = matches[0];\n    dataset.get(key).map(|pricing| LookupResult {\n        pricing: pricing.clone(),\n        source: source.into(),\n        matched_key: key.clone(),\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// Mock LiteLLM data matching real API responses for OpenCode Zen models\n    fn mock_litellm() -\u003e HashMap\u003cString, ModelPricing\u003e {\n        let mut m = HashMap::new();\n\n        // === GPT-4 models (baseline) ===\n        m.insert(\n            \"gpt-4o\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000025),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(0.00000125),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-4o-mini\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000015),\n                output_cost_per_token: Some(0.0000006),\n                cache_read_input_token_cost: Some(0.000000075),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-4-turbo\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00001),\n                output_cost_per_token: Some(0.00003),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: GPT-5 family ===\n        m.insert(\n            \"gpt-5.2\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000175),\n                output_cost_per_token: Some(0.000014),\n                cache_read_input_token_cost: Some(1.75e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5.1\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5.1-codex\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5.1-codex-max\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5-codex\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5-nano\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(5e-8),\n                output_cost_per_token: Some(4e-7),\n                cache_read_input_token_cost: Some(5e-9),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Claude family (LiteLLM entries) ===\n        m.insert(\n            \"claude-3-5-sonnet-20241022\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(0.0000003),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"claude-sonnet-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(3e-7),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"claude-haiku-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000001),\n                output_cost_per_token: Some(0.000005),\n                cache_read_input_token_cost: Some(1e-7),\n                cache_creation_input_token_cost: Some(0.00000125),\n            },\n        );\n        m.insert(\n            \"bedrock/us.anthropic.claude-3-5-haiku-20241022-v1:0\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(8e-7),\n                output_cost_per_token: Some(0.000004),\n                cache_read_input_token_cost: Some(8e-8),\n                cache_creation_input_token_cost: Some(0.000001),\n            },\n        );\n        m.insert(\n            \"claude-opus-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000005),\n                output_cost_per_token: Some(0.000025),\n                cache_read_input_token_cost: Some(5e-7),\n                cache_creation_input_token_cost: Some(0.00000625),\n            },\n        );\n        m.insert(\n            \"claude-opus-4-1\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000015),\n                output_cost_per_token: Some(0.000075),\n                cache_read_input_token_cost: Some(0.0000015),\n                cache_creation_input_token_cost: Some(0.00001875),\n            },\n        );\n\n        // === OpenCode Zen: Gemini family (LiteLLM entries) ===\n        m.insert(\n            \"openrouter/google/gemini-3-pro-preview\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000002),\n                output_cost_per_token: Some(0.000012),\n                cache_read_input_token_cost: Some(2e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"vertex_ai/gemini-3-flash-preview\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(5e-7),\n                output_cost_per_token: Some(0.000003),\n                cache_read_input_token_cost: Some(5e-8),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Grok (LiteLLM entry) ===\n        m.insert(\n            \"xai/grok-code-fast-1-0825\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(2e-7),\n                output_cost_per_token: Some(0.0000015),\n                cache_read_input_token_cost: Some(2e-8),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m.insert(\n            \"azure_ai/grok-code-fast-1\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000035),\n                output_cost_per_token: Some(0.0000175),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"bedrock/anthropic.claude-sonnet-4\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(3e-7),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"vertex_ai/gemini-2.5-pro\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.000005),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"google/gemini-2.5-pro\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.000005),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m\n    }\n\n    /// Mock OpenRouter data matching real API responses for OpenCode Zen models\n    fn mock_openrouter() -\u003e HashMap\u003cString, ModelPricing\u003e {\n        let mut m = HashMap::new();\n\n        // === Baseline models ===\n        m.insert(\n            \"openai/gpt-4o\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000025),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(0.00000125),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Claude (OpenRouter entries) ===\n        m.insert(\n            \"anthropic/claude-sonnet-4\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(3e-7),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"anthropic/claude-opus-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000005),\n                output_cost_per_token: Some(0.000025),\n                cache_read_input_token_cost: Some(0.0000005),\n                cache_creation_input_token_cost: Some(0.00000625),\n            },\n        );\n        m.insert(\n            \"anthropic/claude-3.5-haiku\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(8e-7),\n                output_cost_per_token: Some(0.000004),\n                cache_read_input_token_cost: Some(8e-8),\n                cache_creation_input_token_cost: Some(0.000001),\n            },\n        );\n\n        // === OpenCode Zen: GLM family ===\n        m.insert(\n            \"z-ai/glm-4.7\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4e-7),\n                output_cost_per_token: Some(0.0000015),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"z-ai/glm-4.6\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(3.9e-7),\n                output_cost_per_token: Some(0.0000019),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m.insert(\n            \"moonshotai/kimi-k2\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4.56e-7),\n                output_cost_per_token: Some(0.00000184),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"moonshotai/kimi-k2.5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4.5e-7),\n                output_cost_per_token: Some(0.0000025),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"moonshotai/kimi-k2-thinking\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4e-7),\n                output_cost_per_token: Some(0.00000175),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Qwen family ===\n        m.insert(\n            \"qwen/qwen3-coder\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(2.2e-7),\n                output_cost_per_token: Some(9.5e-7),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m\n    }\n\n    fn create_lookup() -\u003e PricingLookup {\n        PricingLookup::new(mock_litellm(), mock_openrouter())\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GPT-5 FAMILY\n    // All models from https://opencode.ai/docs/zen/\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_gpt_5_2() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.2\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.2\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_1() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_1_codex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_1_codex_max() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex-max\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex-max\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_codex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5-codex\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_nano() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5-nano\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5-nano\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - CLAUDE FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_claude_sonnet_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_sonnet_4() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4\").unwrap();\n        assert_eq!(result.matched_key, \"anthropic/claude-sonnet-4\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_haiku_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-haiku-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-haiku-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_3_5_haiku() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-3-5-haiku\").unwrap();\n        assert_eq!(result.matched_key, \"anthropic/claude-3.5-haiku\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_3_5_haiku_with_dot() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-3.5-haiku\").unwrap();\n        assert_eq!(result.matched_key, \"anthropic/claude-3.5-haiku\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_opus_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-opus-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_opus_4_1() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-opus-4-1\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-1\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GLM FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_glm_4_7_free() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.7-free\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_glm_4_6() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.6\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.6\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_glm_4_7_with_hyphen() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4-7\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_glm_4_6_with_hyphen() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4-6\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.6\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_big_pickle() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"big-pickle\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GEMINI FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_gemini_3_pro() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-pro\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gemini_3_flash() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-flash\").unwrap();\n        assert_eq!(result.matched_key, \"vertex_ai/gemini-3-flash-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - KIMI FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_kimi_k2() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_kimi_k2_thinking() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2-thinking\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2-thinking\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_kimi_k2_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2.5\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2.5\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_kimi_k2_5_free() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2.5-free\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2.5\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - QWEN FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_qwen3_coder() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"qwen3-coder\").unwrap();\n        assert_eq!(result.matched_key, \"qwen/qwen3-coder\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GROK FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_grok_code() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"grok-code\").unwrap();\n        assert_eq!(result.matched_key, \"xai/grok-code-fast-1-0825\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // BASELINE / LEGACY TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_exact_match_litellm() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_exact_match_openrouter() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"z-ai/glm-4.7\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_openrouter_model_part_match() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.7\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_tier_suffix_low() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex-low\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_high() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-4o-high\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_free() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.7-free\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_tier_suffix_xhigh() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.2-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.2\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_xhigh_codex_max() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex-max-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex-max\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_normalize_opus_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"opus-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_blocklist_auto() {\n        let lookup = create_lookup();\n        assert!(lookup.lookup(\"auto\").is_none());\n    }\n\n    #[test]\n    fn test_blocklist_mini() {\n        let lookup = create_lookup();\n        assert!(lookup.lookup(\"mini\").is_none());\n    }\n\n    #[test]\n    fn test_force_source_litellm() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup_with_source(\"gpt-4o\", Some(\"litellm\"))\n            .unwrap();\n        assert_eq!(result.source, \"LiteLLM\");\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_force_source_openrouter() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup_with_source(\"gpt-4o\", Some(\"openrouter\"))\n            .unwrap();\n        assert_eq!(result.source, \"OpenRouter\");\n        assert_eq!(result.matched_key, \"openai/gpt-4o\");\n    }\n\n    #[test]\n    fn test_case_insensitive() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"GPT-4O\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_fuzzy_match_gemini() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-pro\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_with_fuzzy() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-pro-high\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n    }\n\n    #[test]\n    fn test_nonexistent_model() {\n        let lookup = create_lookup();\n        assert!(lookup.lookup(\"nonexistent-model-xyz\").is_none());\n    }\n\n    #[test]\n    fn test_fallback_suffix_lookup() {\n        // Create a lookup with only the base model (no -codex variant)\n        let mut litellm = HashMap::new();\n        litellm.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        // Note: gpt-5-codex is NOT in the pricing data\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n\n        // Looking up gpt-5-codex should fall back to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n\n        // Looking up gpt-5-codex-max should also fall back to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex-max\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_fallback_suffix_with_tier_suffix() {\n        // Test that tier suffix + fallback suffix both work together\n        let mut litellm = HashMap::new();\n        litellm.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n\n        // gpt-5-codex-high should strip -high first, then fall back from gpt-5-codex to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex-high\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n\n        // gpt-5-codex-max-xhigh should strip -xhigh first, then fall back from gpt-5-codex-max to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex-max-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_fallback_suffix_prefers_exact_match() {\n        // If the exact model exists, it should be used (no fallback)\n        let mut litellm = HashMap::new();\n        litellm.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        litellm.insert(\n            \"gpt-5-codex\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000002), // Different price to verify which one is used\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n\n        // Should use the exact match, not fall back\n        let result = lookup.lookup(\"gpt-5-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5-codex\");\n        assert_eq!(result.pricing.input_cost_per_token, Some(0.000002));\n    }\n\n    #[test]\n    fn test_normalize_version_separator() {\n        assert_eq!(\n            normalize_version_separator(\"glm-4-7\"),\n            Some(\"glm-4.7\".into())\n        );\n        assert_eq!(\n            normalize_version_separator(\"glm-4-6\"),\n            Some(\"glm-4.6\".into())\n        );\n        assert_eq!(\n            normalize_version_separator(\"claude-3-5-haiku\"),\n            Some(\"claude-3.5-haiku\".into())\n        );\n        assert_eq!(\n            normalize_version_separator(\"gpt-5-1-codex\"),\n            Some(\"gpt-5.1-codex\".into())\n        );\n        assert_eq!(normalize_version_separator(\"gpt-4o\"), None);\n        assert_eq!(normalize_version_separator(\"claude-sonnet\"), None);\n        assert_eq!(normalize_version_separator(\"big-pickle\"), None);\n    }\n\n    #[test]\n    fn test_normalize_version_separator_preserves_dates() {\n        assert_eq!(normalize_version_separator(\"2024-11-20\"), None);\n        assert_eq!(normalize_version_separator(\"model-2024-11-20\"), None);\n        assert_eq!(\n            normalize_version_separator(\"claude-3-5-sonnet-20241022\"),\n            Some(\"claude-3.5-sonnet-20241022\".into())\n        );\n        assert_eq!(normalize_version_separator(\"sonnet-20241022\"), None);\n        assert_eq!(normalize_version_separator(\"model-20241022-v1\"), None);\n    }\n\n    #[test]\n    fn test_is_fuzzy_eligible() {\n        assert!(!is_fuzzy_eligible(\"auto\"));\n        assert!(!is_fuzzy_eligible(\"mini\"));\n        assert!(!is_fuzzy_eligible(\"chat\"));\n        assert!(!is_fuzzy_eligible(\"base\"));\n        assert!(!is_fuzzy_eligible(\"abc\"));\n        assert!(is_fuzzy_eligible(\"gpt-4o\"));\n        assert!(is_fuzzy_eligible(\"claude\"));\n    }\n\n    // =========================================================================\n    // PROVIDER PREFERENCE TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_provider_preference_grok_prefers_xai_over_azure() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"grok-code\").unwrap();\n        assert_eq!(result.matched_key, \"xai/grok-code-fast-1-0825\");\n        assert_eq!(result.source, \"LiteLLM\");\n        assert!(!result.matched_key.starts_with(\"azure\"));\n    }\n\n    /// Test that documents the exact before/after behavior for grok-code provider preference.\n    /// This test explicitly verifies that the original provider (xai/) is preferred over resellers (azure_ai/).\n    #[test]\n    fn test_grok_code_prefers_xai_over_azure() {\n        // =========================================================================\n        // BEFORE FIX: grok-code â†’ azure_ai/grok-code-fast-1 ($3.50/$17.50) âŒ reseller\n        // AFTER FIX:  grok-code â†’ xai/grok-code-fast-1-0825 ($0.20/$1.50) âœ… original provider\n        //\n        // The azure_ai/ prefix indicates a reseller (Azure AI marketplace), which typically\n        // has higher prices. The xai/ prefix indicates the original provider (X.AI/Grok),\n        // which offers lower direct pricing. Our lookup should prefer the original provider.\n        // =========================================================================\n\n        let mut litellm = HashMap::new();\n\n        // Reseller entry: azure_ai/ prefix with higher prices ($3.50/$17.50 per 1M tokens)\n        litellm.insert(\n            \"azure_ai/grok-code-fast-1\".to_string(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000035),  // $3.50/1M tokens\n                output_cost_per_token: Some(0.0000175), // $17.50/1M tokens\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // Original provider entry: xai/ prefix with lower prices ($0.20/$1.50 per 1M tokens)\n        litellm.insert(\n            \"xai/grok-code-fast-1-0825\".to_string(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000002),  // $0.20/1M tokens\n                output_cost_per_token: Some(0.0000015), // $1.50/1M tokens\n                cache_read_input_token_cost: Some(0.00000002),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n        let result = lookup.lookup(\"grok-code\").unwrap();\n\n        // Must prefer xai (original provider) over azure_ai (reseller)\n        assert!(\n            result.matched_key.starts_with(\"xai/\"),\n            \"Expected xai/ prefix (original provider) but got: {}. \\\n             The lookup should prefer original providers over resellers.\",\n            result.matched_key\n        );\n        assert_eq!(\n            result.matched_key, \"xai/grok-code-fast-1-0825\",\n            \"Should match the xai/grok-code-fast-1-0825 entry, not azure_ai/grok-code-fast-1\"\n        );\n\n        // Verify we got the lower price (original provider)\n        let pricing = \u0026result.pricing;\n        assert!(\n            pricing.input_cost_per_token.unwrap() \u003c 0.000001,\n            \"Input cost should be ~$0.20/1M (0.0000002), not ~$3.50/1M (reseller price)\"\n        );\n        assert!(\n            pricing.output_cost_per_token.unwrap() \u003c 0.000005,\n            \"Output cost should be ~$1.50/1M (0.0000015), not ~$17.50/1M (reseller price)\"\n        );\n    }\n\n    #[test]\n    fn test_provider_preference_gemini_prefers_google_over_vertex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-2.5-pro\").unwrap();\n        assert_eq!(result.matched_key, \"google/gemini-2.5-pro\");\n        assert_eq!(result.source, \"LiteLLM\");\n        assert!(!result.matched_key.starts_with(\"vertex_ai\"));\n    }\n\n    #[test]\n    fn test_is_original_provider() {\n        assert!(is_original_provider(\"xai/grok-code\"));\n        assert!(is_original_provider(\"anthropic/claude-3\"));\n        assert!(is_original_provider(\"openai/gpt-4\"));\n        assert!(is_original_provider(\"google/gemini\"));\n        assert!(is_original_provider(\"x-ai/grok\"));\n        assert!(!is_original_provider(\"azure_ai/grok\"));\n        assert!(!is_original_provider(\"bedrock/anthropic\"));\n        assert!(!is_original_provider(\"vertex_ai/gemini\"));\n        assert!(!is_original_provider(\"unknown-provider/model\"));\n    }\n\n    #[test]\n    fn test_is_reseller_provider() {\n        assert!(is_reseller_provider(\"azure_ai/grok-code\"));\n        assert!(is_reseller_provider(\"azure/openai/gpt-4\"));\n        assert!(is_reseller_provider(\"bedrock/anthropic.claude\"));\n        assert!(is_reseller_provider(\"vertex_ai/gemini\"));\n        assert!(is_reseller_provider(\"together_ai/llama\"));\n        assert!(is_reseller_provider(\"groq/llama\"));\n        assert!(!is_reseller_provider(\"xai/grok\"));\n        assert!(!is_reseller_provider(\"anthropic/claude\"));\n        assert!(!is_reseller_provider(\"openai/gpt-4\"));\n    }\n\n    // =========================================================================\n    // COST CALCULATION TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_calculate_cost_gpt_5_2() {\n        let lookup = create_lookup();\n        // 1M input, 500K output tokens\n        let cost = lookup.calculate_cost(\"gpt-5.2\", 1_000_000, 500_000, 0, 0, 0);\n        // input: 1M * 0.00000175 = 1.75, output: 500K * 0.000014 = 7.0\n        assert!((cost - 8.75).abs() \u003c 0.001);\n    }\n\n    #[test]\n    fn test_calculate_cost_claude_sonnet_4_5() {\n        let lookup = create_lookup();\n        // 100K input, 50K output, 200K cache read\n        let cost = lookup.calculate_cost(\"claude-sonnet-4-5\", 100_000, 50_000, 200_000, 0, 0);\n        // input: 100K * 0.000003 = 0.30, output: 50K * 0.000015 = 0.75, cache: 200K * 3e-7 = 0.06\n        assert!((cost - 1.11).abs() \u003c 0.001);\n    }\n\n    #[test]\n    fn test_calculate_cost_unknown_model() {\n        let lookup = create_lookup();\n        let cost = lookup.calculate_cost(\"nonexistent-model\", 1_000_000, 500_000, 0, 0, 0);\n        assert_eq!(cost, 0.0);\n    }\n\n    // =========================================================================\n    // INTELLIGENT PREFIX/SUFFIX STRIPPING TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_antigravity_prefix_gemini_3_flash() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gemini-3-flash\").unwrap();\n        assert_eq!(result.matched_key, \"vertex_ai/gemini-3-flash-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_gemini_3_pro() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gemini-3-pro\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_with_tier_suffix() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gemini-3-pro-high\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_claude() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-claude-sonnet-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_gpt() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_case_insensitive() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"Antigravity-gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_antigravity_cost_calculation() {\n        let lookup = create_lookup();\n        let cost_with_prefix =\n            lookup.calculate_cost(\"antigravity-gpt-5.2\", 1_000_000, 500_000, 0, 0, 0);\n        let cost_without_prefix = lookup.calculate_cost(\"gpt-5.2\", 1_000_000, 500_000, 0, 0, 0);\n        assert!((cost_with_prefix - cost_without_prefix).abs() \u003c 0.001);\n        assert!(cost_with_prefix \u003e 0.0);\n    }\n\n    // New tests for intelligent detection\n\n    #[test]\n    fn test_unknown_prefix_generic() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"myplugin-gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_unknown_prefix_two_segments() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"router-v2-claude-sonnet-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_unknown_suffix_thinking() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5-thinking\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_unknown_suffix_two_segments() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-opus-4-5-thinking-pro\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n    }\n\n    #[test]\n    fn test_prefix_and_suffix_combined() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup(\"antigravity-claude-opus-4-5-thinking\")\n            .unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n    }\n\n    #[test]\n    fn test_prefix_and_suffix_with_tier() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup(\"antigravity-claude-opus-4-5-thinking-high\")\n            .unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n    }\n\n    #[test]\n    fn test_no_false_positive_valid_model() {\n        let lookup = create_lookup();\n        // gpt-4o-mini is a valid model, should NOT strip \"gpt\"\n        let result = lookup.lookup(\"gpt-4o-mini\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o-mini\");\n    }\n\n    #[test]\n    fn test_suffix_strip_high() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5-high\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_suffix_strip_xhigh() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_suffix_strip_low() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-4o-low\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_suffix_strip_codex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.2-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.2\");\n    }\n}\n","traces":[{"line":87,"address":[],"length":0,"stats":{"Line":73}},{"line":91,"address":[],"length":0,"stats":{"Line":438}},{"line":92,"address":[],"length":0,"stats":{"Line":180994}},{"line":94,"address":[],"length":0,"stats":{"Line":438}},{"line":95,"address":[],"length":0,"stats":{"Line":21218}},{"line":97,"address":[],"length":0,"stats":{"Line":292}},{"line":98,"address":[],"length":0,"stats":{"Line":13431}},{"line":99,"address":[],"length":0,"stats":{"Line":26716}},{"line":102,"address":[],"length":0,"stats":{"Line":292}},{"line":103,"address":[],"length":0,"stats":{"Line":292}},{"line":104,"address":[],"length":0,"stats":{"Line":1203}},{"line":105,"address":[],"length":0,"stats":{"Line":2260}},{"line":106,"address":[],"length":0,"stats":{"Line":6780}},{"line":107,"address":[],"length":0,"stats":{"Line":2260}},{"line":108,"address":[],"length":0,"stats":{"Line":2260}},{"line":109,"address":[],"length":0,"stats":{"Line":5650}},{"line":122,"address":[],"length":0,"stats":{"Line":73}},{"line":126,"address":[],"length":0,"stats":{"Line":491382}},{"line":127,"address":[],"length":0,"stats":{"Line":982543}},{"line":128,"address":[],"length":0,"stats":{"Line":491382}},{"line":131,"address":[],"length":0,"stats":{"Line":1965528}},{"line":133,"address":[],"length":0,"stats":{"Line":982322}},{"line":134,"address":[],"length":0,"stats":{"Line":488075}},{"line":135,"address":[],"length":0,"stats":{"Line":488075}},{"line":136,"address":[],"length":0,"stats":{"Line":488075}},{"line":140,"address":[],"length":0,"stats":{"Line":1105}},{"line":142,"address":[],"length":0,"stats":{"Line":442}},{"line":143,"address":[],"length":0,"stats":{"Line":442}},{"line":144,"address":[],"length":0,"stats":{"Line":442}},{"line":145,"address":[],"length":0,"stats":{"Line":663}},{"line":146,"address":[],"length":0,"stats":{"Line":414}},{"line":147,"address":[],"length":0,"stats":{"Line":414}},{"line":148,"address":[],"length":0,"stats":{"Line":414}},{"line":153,"address":[],"length":0,"stats":{"Line":221}},{"line":156,"address":[],"length":0,"stats":{"Line":223}},{"line":161,"address":[],"length":0,"stats":{"Line":1115}},{"line":162,"address":[],"length":0,"stats":{"Line":669}},{"line":165,"address":[],"length":0,"stats":{"Line":549}},{"line":166,"address":[],"length":0,"stats":{"Line":5}},{"line":167,"address":[],"length":0,"stats":{"Line":4}},{"line":168,"address":[],"length":0,"stats":{"Line":972}},{"line":172,"address":[],"length":0,"stats":{"Line":381}},{"line":173,"address":[],"length":0,"stats":{"Line":158}},{"line":177,"address":[],"length":0,"stats":{"Line":172}},{"line":178,"address":[],"length":0,"stats":{"Line":42}},{"line":183,"address":[],"length":0,"stats":{"Line":55}},{"line":184,"address":[],"length":0,"stats":{"Line":9}},{"line":187,"address":[],"length":0,"stats":{"Line":14}},{"line":190,"address":[],"length":0,"stats":{"Line":324}},{"line":191,"address":[],"length":0,"stats":{"Line":748}},{"line":192,"address":[],"length":0,"stats":{"Line":100}},{"line":195,"address":[],"length":0,"stats":{"Line":491}},{"line":196,"address":[],"length":0,"stats":{"Line":43}},{"line":199,"address":[],"length":0,"stats":{"Line":204}},{"line":200,"address":[],"length":0,"stats":{"Line":46}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":49}},{"line":204,"address":[],"length":0,"stats":{"Line":3}},{"line":208,"address":[],"length":0,"stats":{"Line":222}},{"line":209,"address":[],"length":0,"stats":{"Line":112}},{"line":210,"address":[],"length":0,"stats":{"Line":24}},{"line":212,"address":[],"length":0,"stats":{"Line":50}},{"line":213,"address":[],"length":0,"stats":{"Line":10}},{"line":217,"address":[],"length":0,"stats":{"Line":289}},{"line":218,"address":[],"length":0,"stats":{"Line":1}},{"line":220,"address":[],"length":0,"stats":{"Line":286}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":143}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":143}},{"line":234,"address":[],"length":0,"stats":{"Line":13}},{"line":237,"address":[],"length":0,"stats":{"Line":520}},{"line":238,"address":[],"length":0,"stats":{"Line":520}},{"line":240,"address":[],"length":0,"stats":{"Line":260}},{"line":241,"address":[],"length":0,"stats":{"Line":32}},{"line":242,"address":[],"length":0,"stats":{"Line":48}},{"line":243,"address":[],"length":0,"stats":{"Line":48}},{"line":244,"address":[],"length":0,"stats":{"Line":48}},{"line":245,"address":[],"length":0,"stats":{"Line":48}},{"line":247,"address":[],"length":0,"stats":{"Line":32}},{"line":248,"address":[],"length":0,"stats":{"Line":10}},{"line":250,"address":[],"length":0,"stats":{"Line":12}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":12}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":12}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":6}},{"line":261,"address":[],"length":0,"stats":{"Line":10}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":104}},{"line":267,"address":[],"length":0,"stats":{"Line":1}},{"line":268,"address":[],"length":0,"stats":{"Line":3}},{"line":269,"address":[],"length":0,"stats":{"Line":1}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":1}},{"line":298,"address":[],"length":0,"stats":{"Line":3}},{"line":299,"address":[],"length":0,"stats":{"Line":1}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":392}},{"line":328,"address":[],"length":0,"stats":{"Line":1568}},{"line":329,"address":[],"length":0,"stats":{"Line":500}},{"line":330,"address":[],"length":0,"stats":{"Line":125}},{"line":331,"address":[],"length":0,"stats":{"Line":375}},{"line":332,"address":[],"length":0,"stats":{"Line":375}},{"line":333,"address":[],"length":0,"stats":{"Line":125}},{"line":337,"address":[],"length":0,"stats":{"Line":268}},{"line":338,"address":[],"length":0,"stats":{"Line":537}},{"line":339,"address":[],"length":0,"stats":{"Line":3}},{"line":340,"address":[],"length":0,"stats":{"Line":1}},{"line":341,"address":[],"length":0,"stats":{"Line":3}},{"line":342,"address":[],"length":0,"stats":{"Line":3}},{"line":343,"address":[],"length":0,"stats":{"Line":1}},{"line":347,"address":[],"length":0,"stats":{"Line":590}},{"line":348,"address":[],"length":0,"stats":{"Line":168}},{"line":349,"address":[],"length":0,"stats":{"Line":56}},{"line":350,"address":[],"length":0,"stats":{"Line":168}},{"line":351,"address":[],"length":0,"stats":{"Line":168}},{"line":352,"address":[],"length":0,"stats":{"Line":56}},{"line":356,"address":[],"length":0,"stats":{"Line":211}},{"line":359,"address":[],"length":0,"stats":{"Line":144}},{"line":360,"address":[],"length":0,"stats":{"Line":1433}},{"line":361,"address":[],"length":0,"stats":{"Line":2866}},{"line":362,"address":[],"length":0,"stats":{"Line":2867}},{"line":363,"address":[],"length":0,"stats":{"Line":3}},{"line":364,"address":[],"length":0,"stats":{"Line":1}},{"line":365,"address":[],"length":0,"stats":{"Line":3}},{"line":366,"address":[],"length":0,"stats":{"Line":3}},{"line":367,"address":[],"length":0,"stats":{"Line":1}},{"line":372,"address":[],"length":0,"stats":{"Line":143}},{"line":375,"address":[],"length":0,"stats":{"Line":143}},{"line":376,"address":[],"length":0,"stats":{"Line":1430}},{"line":377,"address":[],"length":0,"stats":{"Line":2860}},{"line":378,"address":[],"length":0,"stats":{"Line":2860}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":143}},{"line":391,"address":[],"length":0,"stats":{"Line":130}},{"line":392,"address":[],"length":0,"stats":{"Line":390}},{"line":393,"address":[],"length":0,"stats":{"Line":390}},{"line":395,"address":[],"length":0,"stats":{"Line":175847}},{"line":396,"address":[],"length":0,"stats":{"Line":351434}},{"line":397,"address":[],"length":0,"stats":{"Line":541407}},{"line":398,"address":[],"length":0,"stats":{"Line":318}},{"line":402,"address":[],"length":0,"stats":{"Line":416}},{"line":403,"address":[],"length":0,"stats":{"Line":26}},{"line":406,"address":[],"length":0,"stats":{"Line":312}},{"line":407,"address":[],"length":0,"stats":{"Line":134556}},{"line":408,"address":[],"length":0,"stats":{"Line":268904}},{"line":409,"address":[],"length":0,"stats":{"Line":403356}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":416}},{"line":417,"address":[],"length":0,"stats":{"Line":130}},{"line":418,"address":[],"length":0,"stats":{"Line":390}},{"line":419,"address":[],"length":0,"stats":{"Line":390}},{"line":421,"address":[],"length":0,"stats":{"Line":16300}},{"line":422,"address":[],"length":0,"stats":{"Line":32340}},{"line":423,"address":[],"length":0,"stats":{"Line":80850}},{"line":424,"address":[],"length":0,"stats":{"Line":50292}},{"line":425,"address":[],"length":0,"stats":{"Line":60}},{"line":429,"address":[],"length":0,"stats":{"Line":16}},{"line":430,"address":[],"length":0,"stats":{"Line":390}},{"line":432,"address":[],"length":0,"stats":{"Line":16}},{"line":435,"address":[],"length":0,"stats":{"Line":342}},{"line":436,"address":[],"length":0,"stats":{"Line":12604}},{"line":437,"address":[],"length":0,"stats":{"Line":24980}},{"line":438,"address":[],"length":0,"stats":{"Line":62450}},{"line":439,"address":[],"length":0,"stats":{"Line":37470}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":456}},{"line":447,"address":[],"length":0,"stats":{"Line":491315}},{"line":456,"address":[],"length":0,"stats":{"Line":1470848}},{"line":457,"address":[],"length":0,"stats":{"Line":976436}},{"line":458,"address":[],"length":0,"stats":{"Line":3097}},{"line":461,"address":[],"length":0,"stats":{"Line":976436}},{"line":462,"address":[],"length":0,"stats":{"Line":488218}},{"line":463,"address":[],"length":0,"stats":{"Line":11287329}},{"line":466,"address":[],"length":0,"stats":{"Line":976436}},{"line":467,"address":[],"length":0,"stats":{"Line":2441090}},{"line":468,"address":[],"length":0,"stats":{"Line":976436}},{"line":469,"address":[],"length":0,"stats":{"Line":976436}},{"line":471,"address":[],"length":0,"stats":{"Line":1464654}},{"line":472,"address":[],"length":0,"stats":{"Line":1464654}},{"line":473,"address":[],"length":0,"stats":{"Line":1464654}},{"line":474,"address":[],"length":0,"stats":{"Line":1464654}},{"line":476,"address":[],"length":0,"stats":{"Line":488218}},{"line":480,"address":[],"length":0,"stats":{"Line":260}},{"line":481,"address":[],"length":0,"stats":{"Line":780}},{"line":483,"address":[],"length":0,"stats":{"Line":260}},{"line":484,"address":[],"length":0,"stats":{"Line":108}},{"line":486,"address":[],"length":0,"stats":{"Line":206}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":206}},{"line":490,"address":[],"length":0,"stats":{"Line":20}},{"line":492,"address":[],"length":0,"stats":{"Line":196}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":196}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":196}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":196}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":196}},{"line":506,"address":[],"length":0,"stats":{"Line":40}},{"line":508,"address":[],"length":0,"stats":{"Line":176}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":176}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":176}},{"line":516,"address":[],"length":0,"stats":{"Line":112}},{"line":518,"address":[],"length":0,"stats":{"Line":120}},{"line":519,"address":[],"length":0,"stats":{"Line":8}},{"line":521,"address":[],"length":0,"stats":{"Line":116}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":116}},{"line":525,"address":[],"length":0,"stats":{"Line":12}},{"line":528,"address":[],"length":0,"stats":{"Line":110}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":110}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":110}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":110}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":330}},{"line":542,"address":[],"length":0,"stats":{"Line":220}},{"line":544,"address":[],"length":0,"stats":{"Line":110}},{"line":548,"address":[],"length":0,"stats":{"Line":191887}},{"line":549,"address":[],"length":0,"stats":{"Line":383774}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":575661}},{"line":555,"address":[],"length":0,"stats":{"Line":152225}},{"line":556,"address":[],"length":0,"stats":{"Line":304639}},{"line":557,"address":[],"length":0,"stats":{"Line":990}},{"line":558,"address":[],"length":0,"stats":{"Line":567}},{"line":559,"address":[],"length":0,"stats":{"Line":189}},{"line":560,"address":[],"length":0,"stats":{"Line":837}},{"line":561,"address":[],"length":0,"stats":{"Line":378}},{"line":563,"address":[],"length":0,"stats":{"Line":152036}},{"line":567,"address":[],"length":0,"stats":{"Line":178}},{"line":568,"address":[],"length":0,"stats":{"Line":534}},{"line":570,"address":[],"length":0,"stats":{"Line":178}},{"line":571,"address":[],"length":0,"stats":{"Line":36}},{"line":572,"address":[],"length":0,"stats":{"Line":13}},{"line":573,"address":[],"length":0,"stats":{"Line":6}},{"line":574,"address":[],"length":0,"stats":{"Line":6}},{"line":577,"address":[],"length":0,"stats":{"Line":159}},{"line":578,"address":[],"length":0,"stats":{"Line":48}},{"line":579,"address":[],"length":0,"stats":{"Line":11}},{"line":580,"address":[],"length":0,"stats":{"Line":22}},{"line":581,"address":[],"length":0,"stats":{"Line":4}},{"line":582,"address":[],"length":0,"stats":{"Line":10}},{"line":583,"address":[],"length":0,"stats":{"Line":10}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":134}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":134}},{"line":599,"address":[],"length":0,"stats":{"Line":336}},{"line":600,"address":[],"length":0,"stats":{"Line":1344}},{"line":601,"address":[],"length":0,"stats":{"Line":1680}},{"line":602,"address":[],"length":0,"stats":{"Line":672}},{"line":604,"address":[],"length":0,"stats":{"Line":5206}},{"line":605,"address":[],"length":0,"stats":{"Line":4870}},{"line":606,"address":[],"length":0,"stats":{"Line":625}},{"line":607,"address":[],"length":0,"stats":{"Line":1250}},{"line":608,"address":[],"length":0,"stats":{"Line":1250}},{"line":609,"address":[],"length":0,"stats":{"Line":416}},{"line":611,"address":[],"length":0,"stats":{"Line":128}},{"line":612,"address":[],"length":0,"stats":{"Line":146}},{"line":613,"address":[],"length":0,"stats":{"Line":92}},{"line":615,"address":[],"length":0,"stats":{"Line":36}},{"line":616,"address":[],"length":0,"stats":{"Line":12}},{"line":618,"address":[],"length":0,"stats":{"Line":56}},{"line":619,"address":[],"length":0,"stats":{"Line":28}},{"line":622,"address":[],"length":0,"stats":{"Line":14514}},{"line":626,"address":[],"length":0,"stats":{"Line":336}},{"line":627,"address":[],"length":0,"stats":{"Line":28}},{"line":629,"address":[],"length":0,"stats":{"Line":308}},{"line":633,"address":[],"length":0,"stats":{"Line":150}},{"line":634,"address":[],"length":0,"stats":{"Line":150}},{"line":635,"address":[],"length":0,"stats":{"Line":18}},{"line":637,"address":[],"length":0,"stats":{"Line":264}},{"line":643,"address":[],"length":0,"stats":{"Line":75}},{"line":647,"address":[],"length":0,"stats":{"Line":375}},{"line":649,"address":[],"length":0,"stats":{"Line":75}},{"line":650,"address":[],"length":0,"stats":{"Line":12}},{"line":653,"address":[],"length":0,"stats":{"Line":189}},{"line":655,"address":[],"length":0,"stats":{"Line":148}},{"line":656,"address":[],"length":0,"stats":{"Line":595}},{"line":658,"address":[],"length":0,"stats":{"Line":85}},{"line":659,"address":[],"length":0,"stats":{"Line":128}},{"line":660,"address":[],"length":0,"stats":{"Line":43}},{"line":665,"address":[],"length":0,"stats":{"Line":20}},{"line":671,"address":[],"length":0,"stats":{"Line":23}},{"line":675,"address":[],"length":0,"stats":{"Line":115}},{"line":677,"address":[],"length":0,"stats":{"Line":23}},{"line":678,"address":[],"length":0,"stats":{"Line":8}},{"line":681,"address":[],"length":0,"stats":{"Line":45}},{"line":683,"address":[],"length":0,"stats":{"Line":35}},{"line":684,"address":[],"length":0,"stats":{"Line":100}},{"line":686,"address":[],"length":0,"stats":{"Line":20}},{"line":688,"address":[],"length":0,"stats":{"Line":26}},{"line":689,"address":[],"length":0,"stats":{"Line":8}},{"line":693,"address":[],"length":0,"stats":{"Line":21}},{"line":694,"address":[],"length":0,"stats":{"Line":1}},{"line":699,"address":[],"length":0,"stats":{"Line":6}},{"line":702,"address":[],"length":0,"stats":{"Line":200}},{"line":703,"address":[],"length":0,"stats":{"Line":600}},{"line":704,"address":[],"length":0,"stats":{"Line":200}},{"line":706,"address":[],"length":0,"stats":{"Line":6431}},{"line":709,"address":[],"length":0,"stats":{"Line":74}},{"line":710,"address":[],"length":0,"stats":{"Line":222}},{"line":711,"address":[],"length":0,"stats":{"Line":74}},{"line":713,"address":[],"length":0,"stats":{"Line":1814}},{"line":716,"address":[],"length":0,"stats":{"Line":478}},{"line":721,"address":[],"length":0,"stats":{"Line":956}},{"line":722,"address":[],"length":0,"stats":{"Line":436}},{"line":725,"address":[],"length":0,"stats":{"Line":427}},{"line":726,"address":[],"length":0,"stats":{"Line":75}},{"line":727,"address":[],"length":0,"stats":{"Line":25}},{"line":728,"address":[],"length":0,"stats":{"Line":75}},{"line":729,"address":[],"length":0,"stats":{"Line":75}},{"line":730,"address":[],"length":0,"stats":{"Line":25}},{"line":735,"address":[],"length":0,"stats":{"Line":110}},{"line":736,"address":[],"length":0,"stats":{"Line":30}},{"line":737,"address":[],"length":0,"stats":{"Line":10}},{"line":738,"address":[],"length":0,"stats":{"Line":30}},{"line":739,"address":[],"length":0,"stats":{"Line":30}},{"line":740,"address":[],"length":0,"stats":{"Line":10}},{"line":745,"address":[],"length":0,"stats":{"Line":14}},{"line":746,"address":[],"length":0,"stats":{"Line":28}},{"line":747,"address":[],"length":0,"stats":{"Line":14}},{"line":748,"address":[],"length":0,"stats":{"Line":14}},{"line":749,"address":[],"length":0,"stats":{"Line":14}}],"covered":306,"coverable":372},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","mod.rs"],"content":"pub mod aliases;\npub mod cache;\npub mod litellm;\npub mod lookup;\npub mod openrouter;\n\nuse lookup::{LookupResult, PricingLookup};\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse tokio::sync::OnceCell;\n\npub use litellm::ModelPricing;\n\nstatic PRICING_SERVICE: OnceCell\u003cArc\u003cPricingService\u003e\u003e = OnceCell::const_new();\n\npub struct PricingService {\n    lookup: PricingLookup,\n}\n\nimpl PricingService {\n    pub fn new(\n        litellm_data: HashMap\u003cString, ModelPricing\u003e,\n        openrouter_data: HashMap\u003cString, ModelPricing\u003e,\n    ) -\u003e Self {\n        Self {\n            lookup: PricingLookup::new(litellm_data, openrouter_data),\n        }\n    }\n\n    async fn fetch_inner() -\u003e Result\u003cSelf, String\u003e {\n        let (litellm_result, openrouter_data) =\n            tokio::join!(litellm::fetch(), openrouter::fetch_all_mapped());\n\n        let litellm_data = litellm_result.map_err(|e| e.to_string())?;\n\n        Ok(Self::new(litellm_data, openrouter_data))\n    }\n\n    pub async fn get_or_init() -\u003e Result\u003cArc\u003cPricingService\u003e, String\u003e {\n        PRICING_SERVICE\n            .get_or_try_init(|| async { Self::fetch_inner().await.map(Arc::new) })\n            .await\n            .map(Arc::clone)\n    }\n\n    pub fn lookup_with_source(\n        \u0026self,\n        model_id: \u0026str,\n        force_source: Option\u003c\u0026str\u003e,\n    ) -\u003e Option\u003cLookupResult\u003e {\n        self.lookup.lookup_with_source(model_id, force_source)\n    }\n\n    pub fn calculate_cost(\n        \u0026self,\n        model_id: \u0026str,\n        input: i64,\n        output: i64,\n        cache_read: i64,\n        cache_write: i64,\n        reasoning: i64,\n    ) -\u003e f64 {\n        self.lookup\n            .calculate_cost(model_id, input, output, cache_read, cache_write, reasoning)\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":30,"address":[],"length":0,"stats":{"Line":4}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":32,"address":[],"length":0,"stats":{"Line":6}},{"line":34,"address":[],"length":0,"stats":{"Line":6}},{"line":36,"address":[],"length":0,"stats":{"Line":4}},{"line":39,"address":[],"length":0,"stats":{"Line":4}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":12}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":491310}},{"line":63,"address":[],"length":0,"stats":{"Line":491310}},{"line":64,"address":[],"length":0,"stats":{"Line":3439170}}],"covered":15,"coverable":17},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","openrouter.rs"],"content":"use super::cache;\nuse super::litellm::ModelPricing;\nuse serde::Deserialize;\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse tokio::sync::Semaphore;\n\nconst CACHE_FILENAME: \u0026str = \"pricing-openrouter.json\";\nconst MODELS_URL: \u0026str = \"https://openrouter.ai/api/v1/models\";\nconst MAX_RETRIES: u32 = 3;\nconst INITIAL_BACKOFF_MS: u64 = 200;\nconst MAX_CONCURRENT_REQUESTS: usize = 10;\n\n/// Structs for `/api/v1/models` endpoint (list all models).\n\n#[derive(Deserialize)]\nstruct ModelListPricing {\n    prompt: String,\n    completion: String,\n}\n\n#[derive(Deserialize)]\nstruct ModelListItem {\n    id: String,\n    pricing: Option\u003cModelListPricing\u003e,\n}\n\n#[derive(Deserialize)]\nstruct ModelsListResponse {\n    data: Vec\u003cModelListItem\u003e,\n}\n\n/// Structs for `/api/v1/models/{id}/endpoints` endpoint (author pricing).\n\n#[derive(Deserialize)]\nstruct EndpointPricing {\n    prompt: String,\n    completion: String,\n    #[serde(default)]\n    input_cache_read: Option\u003cString\u003e,\n    #[serde(default)]\n    input_cache_write: Option\u003cString\u003e,\n}\n\n#[derive(Deserialize)]\nstruct Endpoint {\n    provider_name: String,\n    pricing: EndpointPricing,\n}\n\n#[derive(Deserialize)]\nstruct EndpointData {\n    #[allow(dead_code)]\n    id: String,\n    endpoints: Vec\u003cEndpoint\u003e,\n}\n\n#[derive(Deserialize)]\nstruct EndpointsResponse {\n    data: EndpointData,\n}\n\n/// Model ID prefix to provider name mapping.\n///\n/// Translates model ID prefixes like `z-ai` to their corresponding\n/// provider names in the endpoints API, such as `Z.AI`.\nfn get_author_provider_name(model_id: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    let prefix = model_id.split('/').next()?;\n\n    match prefix.to_lowercase().as_str() {\n        \"z-ai\" =\u003e Some(\"Z.AI\"),\n        \"x-ai\" =\u003e Some(\"xAI\"),\n        \"anthropic\" =\u003e Some(\"Anthropic\"),\n        \"openai\" =\u003e Some(\"OpenAI\"),\n        \"google\" =\u003e Some(\"Google\"),\n        \"meta-llama\" =\u003e Some(\"Meta\"),\n        \"mistralai\" =\u003e Some(\"Mistral\"),\n        \"deepseek\" =\u003e Some(\"DeepSeek\"),\n        \"qwen\" =\u003e Some(\"Alibaba\"),\n        \"cohere\" =\u003e Some(\"Cohere\"),\n        \"perplexity\" =\u003e Some(\"Perplexity\"),\n        \"moonshotai\" =\u003e Some(\"Moonshot AI\"),\n        _ =\u003e None,\n    }\n}\n\npub fn load_cached() -\u003e Option\u003cHashMap\u003cString, ModelPricing\u003e\u003e {\n    cache::load_cache(CACHE_FILENAME)\n}\n\nfn parse_price(s: \u0026str) -\u003e Option\u003cf64\u003e {\n    s.trim()\n        .parse::\u003cf64\u003e()\n        .ok()\n        .filter(|v| v.is_finite() \u0026\u0026 *v \u003e= 0.0)\n}\n\nasync fn fetch_author_pricing(\n    client: Arc\u003creqwest::Client\u003e,\n    model_id: String,\n    semaphore: Arc\u003cSemaphore\u003e,\n    fallback_pricing: Option\u003cModelPricing\u003e,\n) -\u003e Option\u003c(String, ModelPricing)\u003e {\n    let _permit = semaphore.acquire().await.ok()?;\n\n    let author_name = match get_author_provider_name(\u0026model_id) {\n        Some(name) =\u003e name,\n        None =\u003e return fallback_pricing.map(|p| (model_id, p)),\n    };\n\n    let url = format!(\"https://openrouter.ai/api/v1/models/{}/endpoints\", model_id);\n\n    let response = match client\n        .get(\u0026url)\n        .header(\"Content-Type\", \"application/json\")\n        .send()\n        .await\n    {\n        Ok(r) =\u003e r,\n        Err(_) =\u003e {\n            return fallback_pricing.map(|p| (model_id, p));\n        }\n    };\n\n    if !response.status().is_success() {\n        return fallback_pricing.map(|p| (model_id, p));\n    }\n\n    let data: EndpointsResponse = match response.json().await {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e {\n            return fallback_pricing.map(|p| (model_id, p));\n        }\n    };\n\n    // Find the endpoint from the author provider\n    let author_endpoint = match data\n        .data\n        .endpoints\n        .iter()\n        .find(|e| e.provider_name == author_name)\n    {\n        Some(ep) =\u003e ep,\n        None =\u003e {\n            return fallback_pricing.map(|p| (model_id, p));\n        }\n    };\n\n    let input_cost = parse_price(\u0026author_endpoint.pricing.prompt);\n    let output_cost = parse_price(\u0026author_endpoint.pricing.completion);\n\n    if input_cost.is_none() || output_cost.is_none() {\n        return fallback_pricing.map(|p| (model_id, p));\n    }\n\n    let pricing = ModelPricing {\n        input_cost_per_token: input_cost,\n        output_cost_per_token: output_cost,\n        cache_read_input_token_cost: author_endpoint\n            .pricing\n            .input_cache_read\n            .as_ref()\n            .and_then(|s| parse_price(s)),\n        cache_creation_input_token_cost: author_endpoint\n            .pricing\n            .input_cache_write\n            .as_ref()\n            .and_then(|s| parse_price(s)),\n    };\n\n    Some((model_id, pricing))\n}\n\n/// Fetch all models and get author pricing for each\npub async fn fetch_all_models() -\u003e HashMap\u003cString, ModelPricing\u003e {\n    if let Some(cached) = load_cached() {\n        return cached;\n    }\n\n    let client = Arc::new(\n        reqwest::Client::builder()\n            .timeout(std::time::Duration::from_secs(30))\n            .connect_timeout(std::time::Duration::from_secs(10))\n            .build()\n            .unwrap_or_default(),\n    );\n\n    let mut last_error: Option\u003cString\u003e = None;\n\n    let models_with_fallback: Vec\u003c(String, Option\u003cModelPricing\u003e)\u003e = 'retry: {\n        for attempt in 0..MAX_RETRIES {\n            let response = match client\n                .get(MODELS_URL)\n                .header(\"Content-Type\", \"application/json\")\n                .send()\n                .await\n            {\n                Ok(r) =\u003e r,\n                Err(e) =\u003e {\n                    last_error = Some(format!(\"network error: {}\", e));\n                    if attempt \u003c MAX_RETRIES - 1 {\n                        tokio::time::sleep(std::time::Duration::from_millis(\n                            INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                        ))\n                        .await;\n                    }\n                    continue;\n                }\n            };\n\n            let status = response.status();\n            if status.is_server_error() || status == reqwest::StatusCode::TOO_MANY_REQUESTS {\n                last_error = Some(format!(\"HTTP {}\", status));\n                let _ = response.bytes().await;\n                if attempt \u003c MAX_RETRIES - 1 {\n                    tokio::time::sleep(std::time::Duration::from_millis(\n                        INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                    ))\n                    .await;\n                }\n                continue;\n            }\n\n            if !status.is_success() {\n                eprintln!(\"[tokscale] OpenRouter models API returned {}\", status);\n                break 'retry Vec::new();\n            }\n\n            let data: ModelsListResponse = match response.json().await {\n                Ok(d) =\u003e d,\n                Err(e) =\u003e {\n                    eprintln!(\"[tokscale] OpenRouter models JSON parse failed: {}\", e);\n                    break 'retry Vec::new();\n                }\n            };\n\n            break 'retry data\n                .data\n                .into_iter()\n                .map(|m| {\n                    let fallback = m.pricing.and_then(|p| {\n                        let input = parse_price(\u0026p.prompt)?;\n                        let output = parse_price(\u0026p.completion)?;\n                        Some(ModelPricing {\n                            input_cost_per_token: Some(input),\n                            output_cost_per_token: Some(output),\n                            cache_read_input_token_cost: None,\n                            cache_creation_input_token_cost: None,\n                        })\n                    });\n                    (m.id, fallback)\n                })\n                .collect();\n        }\n\n        if let Some(err) = \u0026last_error {\n            eprintln!(\n                \"[tokscale] OpenRouter fetch failed after {} retries: {}\",\n                MAX_RETRIES, err\n            );\n        }\n        Vec::new()\n    };\n\n    if models_with_fallback.is_empty() {\n        return HashMap::new();\n    }\n\n    let models_with_authors: Vec\u003c(String, Option\u003cModelPricing\u003e)\u003e = models_with_fallback\n        .into_iter()\n        .filter(|(id, _)| get_author_provider_name(id).is_some())\n        .collect();\n\n    let semaphore = Arc::new(Semaphore::new(MAX_CONCURRENT_REQUESTS));\n\n    let mut handles = Vec::with_capacity(models_with_authors.len());\n\n    for (model_id, fallback) in models_with_authors {\n        let client = Arc::clone(\u0026client);\n        let sem = Arc::clone(\u0026semaphore);\n\n        let handle =\n            tokio::spawn(\n                async move { fetch_author_pricing(client, model_id, sem, fallback).await },\n            );\n\n        handles.push(handle);\n    }\n\n    // Collect results\n    let mut result = HashMap::new();\n\n    for handle in handles {\n        if let Ok(Some((model_id, pricing))) = handle.await {\n            result.insert(model_id, pricing);\n        }\n    }\n\n    if !result.is_empty() {\n        let _ = cache::save_cache(CACHE_FILENAME, \u0026result);\n    }\n\n    result\n}\n\npub async fn fetch_all_mapped() -\u003e HashMap\u003cString, ModelPricing\u003e {\n    fetch_all_models().await\n}\n","traces":[{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":2}},{"line":88,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":4}},{"line":176,"address":[],"length":0,"stats":{"Line":4}},{"line":177,"address":[],"length":0,"stats":{"Line":2}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":4}},{"line":307,"address":[],"length":0,"stats":{"Line":2}}],"covered":7,"coverable":134},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","scanner.rs"],"content":"//! Parallel file scanner for session directories\n//!\n//! Uses walkdir with rayon for parallel directory traversal.\n\nuse rayon::prelude::*;\nuse std::path::PathBuf;\nuse walkdir::WalkDir;\n\n/// Session source type\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum SessionType {\n    OpenCode,\n    Claude,\n    Codex,\n    Gemini,\n    Cursor,\n    Amp,\n    Droid,\n    OpenClaw,\n    Pi,\n}\n\n/// Result of scanning all session directories\n#[derive(Debug, Default)]\npub struct ScanResult {\n    pub opencode_files: Vec\u003cPathBuf\u003e,\n    pub claude_files: Vec\u003cPathBuf\u003e,\n    pub codex_files: Vec\u003cPathBuf\u003e,\n    pub gemini_files: Vec\u003cPathBuf\u003e,\n    pub cursor_files: Vec\u003cPathBuf\u003e,\n    pub amp_files: Vec\u003cPathBuf\u003e,\n    pub droid_files: Vec\u003cPathBuf\u003e,\n    pub openclaw_files: Vec\u003cPathBuf\u003e,\n    pub pi_files: Vec\u003cPathBuf\u003e,\n}\n\nimpl ScanResult {\n    /// Get total number of files found\n    pub fn total_files(\u0026self) -\u003e usize {\n        self.opencode_files.len()\n            + self.claude_files.len()\n            + self.codex_files.len()\n            + self.gemini_files.len()\n            + self.cursor_files.len()\n            + self.amp_files.len()\n            + self.droid_files.len()\n            + self.openclaw_files.len()\n            + self.pi_files.len()\n    }\n\n    /// Get all files as a single vector\n    pub fn all_files(\u0026self) -\u003e Vec\u003c(SessionType, PathBuf)\u003e {\n        let mut result = Vec::with_capacity(self.total_files());\n\n        for path in \u0026self.opencode_files {\n            result.push((SessionType::OpenCode, path.clone()));\n        }\n        for path in \u0026self.claude_files {\n            result.push((SessionType::Claude, path.clone()));\n        }\n        for path in \u0026self.codex_files {\n            result.push((SessionType::Codex, path.clone()));\n        }\n        for path in \u0026self.gemini_files {\n            result.push((SessionType::Gemini, path.clone()));\n        }\n        for path in \u0026self.cursor_files {\n            result.push((SessionType::Cursor, path.clone()));\n        }\n        for path in \u0026self.amp_files {\n            result.push((SessionType::Amp, path.clone()));\n        }\n        for path in \u0026self.droid_files {\n            result.push((SessionType::Droid, path.clone()));\n        }\n        for path in \u0026self.openclaw_files {\n            result.push((SessionType::OpenClaw, path.clone()));\n        }\n        for path in \u0026self.pi_files {\n            result.push((SessionType::Pi, path.clone()));\n        }\n\n        result\n    }\n}\n\npub fn headless_roots(home_dir: \u0026str) -\u003e Vec\u003cPathBuf\u003e {\n    if let Ok(path) = std::env::var(\"TOKSCALE_HEADLESS_DIR\") {\n        return vec![PathBuf::from(path)];\n    }\n\n    let mut roots = Vec::new();\n    roots.push(PathBuf::from(format!(\n        \"{}/.config/tokscale/headless\",\n        home_dir\n    )));\n\n    let mac_root = PathBuf::from(format!(\n        \"{}/Library/Application Support/tokscale/headless\",\n        home_dir\n    ));\n    roots.push(mac_root);\n\n    roots\n}\n\n/// Scan a single directory for session files\npub fn scan_directory(root: \u0026str, pattern: \u0026str) -\u003e Vec\u003cPathBuf\u003e {\n    if !std::path::Path::new(root).exists() {\n        return Vec::new();\n    }\n\n    WalkDir::new(root)\n        .into_iter()\n        .par_bridge()\n        .filter_map(|e| e.ok())\n        .filter(|e| {\n            let path = e.path();\n            if !path.is_file() {\n                return false;\n            }\n\n            let file_name = path.file_name().and_then(|n| n.to_str()).unwrap_or(\"\");\n\n            let is_in_archive_dir = path.components().any(|c| {\n                c.as_os_str()\n                    .to_string_lossy()\n                    .eq_ignore_ascii_case(\"archive\")\n            });\n\n            match pattern {\n                \"*.json\" =\u003e file_name.ends_with(\".json\"),\n                \"*.jsonl\" =\u003e file_name.ends_with(\".jsonl\"),\n                \"*.csv\" =\u003e file_name.ends_with(\".csv\"),\n                \"usage*.csv\" =\u003e {\n                    if is_in_archive_dir {\n                        return false;\n                    }\n\n                    if file_name == \"usage.csv\" {\n                        return true;\n                    }\n\n                    // Accept only per-account files: usage.\u003caccount\u003e.csv\n                    if !file_name.starts_with(\"usage.\") || !file_name.ends_with(\".csv\") {\n                        return false;\n                    }\n\n                    // Exclude legacy backups like usage.backup-\u003cts\u003e.csv\n                    if file_name.starts_with(\"usage.backup\") {\n                        return false;\n                    }\n\n                    true\n                }\n                \"session-*.json\" =\u003e {\n                    file_name.starts_with(\"session-\") \u0026\u0026 file_name.ends_with(\".json\")\n                }\n                \"T-*.json\" =\u003e file_name.starts_with(\"T-\") \u0026\u0026 file_name.ends_with(\".json\"),\n                \"*.settings.json\" =\u003e file_name.ends_with(\".settings.json\"),\n                \"sessions.json\" =\u003e file_name == \"sessions.json\",\n                _ =\u003e false,\n            }\n        })\n        .map(|e| e.path().to_path_buf())\n        .collect()\n}\n\n/// Scan all session source directories in parallel\npub fn scan_all_sources(home_dir: \u0026str, sources: \u0026[String]) -\u003e ScanResult {\n    let mut result = ScanResult::default();\n\n    let include_all = sources.is_empty();\n    let include_opencode = include_all || sources.iter().any(|s| s == \"opencode\");\n    let include_claude = include_all || sources.iter().any(|s| s == \"claude\");\n    let include_codex = include_all || sources.iter().any(|s| s == \"codex\");\n    let include_gemini = include_all || sources.iter().any(|s| s == \"gemini\");\n    let include_cursor = include_all || sources.iter().any(|s| s == \"cursor\");\n    let include_amp = include_all || sources.iter().any(|s| s == \"amp\");\n    let include_droid = include_all || sources.iter().any(|s| s == \"droid\");\n    let include_openclaw = include_all || sources.iter().any(|s| s == \"openclaw\");\n    let include_pi = include_all || sources.iter().any(|s| s == \"pi\");\n\n    let headless_roots = headless_roots(home_dir);\n\n    // Define scan tasks\n    let mut tasks: Vec\u003c(SessionType, String, \u0026str)\u003e = Vec::new();\n\n    if include_opencode {\n        // OpenCode: ~/.local/share/opencode/storage/message/*/*.json\n        let xdg_data =\n            std::env::var(\"XDG_DATA_HOME\").unwrap_or_else(|_| format!(\"{}/.local/share\", home_dir));\n        let opencode_path = format!(\"{}/opencode/storage/message\", xdg_data);\n        tasks.push((SessionType::OpenCode, opencode_path, \"*.json\"));\n    }\n\n    if include_claude {\n        // Claude: ~/.claude/projects/**/*.jsonl\n        let claude_path = format!(\"{}/.claude/projects\", home_dir);\n        tasks.push((SessionType::Claude, claude_path, \"*.jsonl\"));\n    }\n\n    if include_codex {\n        // Codex: ~/.codex/sessions/**/*.jsonl\n        let codex_home =\n            std::env::var(\"CODEX_HOME\").unwrap_or_else(|_| format!(\"{}/.codex\", home_dir));\n        let codex_path = format!(\"{}/sessions\", codex_home);\n        tasks.push((SessionType::Codex, codex_path, \"*.jsonl\"));\n\n        // Codex headless: \u003cheadless_root\u003e/codex/*.jsonl\n        for root in \u0026headless_roots {\n            let codex_headless_path = root.join(\"codex\");\n            let path = codex_headless_path.to_string_lossy().to_string();\n            tasks.push((SessionType::Codex, path, \"*.jsonl\"));\n        }\n    }\n\n    if include_gemini {\n        // Gemini: ~/.gemini/tmp/*/chats/session-*.json\n        let gemini_path = format!(\"{}/.gemini/tmp\", home_dir);\n        tasks.push((SessionType::Gemini, gemini_path, \"session-*.json\"));\n    }\n\n    if include_cursor {\n        // Cursor: ~/.config/tokscale/cursor-cache/*.csv (migrated from ~/.tokscale)\n        let cursor_path = format!(\"{}/.config/tokscale/cursor-cache\", home_dir);\n        // Only scan Cursor usage CSVs to avoid counting unrelated CSVs.\n        tasks.push((SessionType::Cursor, cursor_path, \"usage*.csv\"));\n    }\n\n    if include_amp {\n        // Amp: ~/.local/share/amp/threads/T-*.json\n        let xdg_data =\n            std::env::var(\"XDG_DATA_HOME\").unwrap_or_else(|_| format!(\"{}/.local/share\", home_dir));\n        let amp_path = format!(\"{}/amp/threads\", xdg_data);\n        tasks.push((SessionType::Amp, amp_path, \"T-*.json\"));\n    }\n\n    if include_droid {\n        // Droid: ~/.factory/sessions/*.settings.json\n        let droid_path = format!(\"{}/.factory/sessions\", home_dir);\n        tasks.push((SessionType::Droid, droid_path, \"*.settings.json\"));\n    }\n\n    if include_openclaw {\n        // Current path\n        let openclaw_path = format!(\"{}/.openclaw/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, openclaw_path, \"sessions.json\"));\n        // Legacy paths (Clawd -\u003e Moltbot -\u003e OpenClaw rebrand history)\n        let clawdbot_path = format!(\"{}/.clawdbot/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, clawdbot_path, \"sessions.json\"));\n        let moltbot_path = format!(\"{}/.moltbot/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, moltbot_path, \"sessions.json\"));\n        let moldbot_path = format!(\"{}/.moldbot/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, moldbot_path, \"sessions.json\"));\n    }\n\n    if include_pi {\n        // Pi (badlogic/pi-mono): ~/.pi/agent/sessions/**/*.jsonl\n        let pi_path = format!(\"{}/.pi/agent/sessions\", home_dir);\n        tasks.push((SessionType::Pi, pi_path, \"*.jsonl\"));\n    }\n\n    // Execute scans in parallel\n    let scan_results: Vec\u003c(SessionType, Vec\u003cPathBuf\u003e)\u003e = tasks\n        .into_par_iter()\n        .map(|(session_type, path, pattern)| {\n            let files = scan_directory(\u0026path, pattern);\n            (session_type, files)\n        })\n        .collect();\n\n    // Aggregate results\n    for (session_type, files) in scan_results {\n        match session_type {\n            SessionType::OpenCode =\u003e result.opencode_files.extend(files),\n            SessionType::Claude =\u003e result.claude_files.extend(files),\n            SessionType::Codex =\u003e result.codex_files.extend(files),\n            SessionType::Gemini =\u003e result.gemini_files.extend(files),\n            SessionType::Cursor =\u003e result.cursor_files.extend(files),\n            SessionType::Amp =\u003e result.amp_files.extend(files),\n            SessionType::Droid =\u003e result.droid_files.extend(files),\n            SessionType::OpenClaw =\u003e result.openclaw_files.extend(files),\n            SessionType::Pi =\u003e result.pi_files.extend(files),\n        }\n    }\n\n    result\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serial_test::serial;\n    use std::fs::{self, File};\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    fn restore_env(var: \u0026str, previous: Option\u003cString\u003e) {\n        match previous {\n            Some(value) =\u003e std::env::set_var(var, value),\n            None =\u003e std::env::remove_var(var),\n        }\n    }\n\n    #[test]\n    fn test_scan_result_total_files() {\n        let result = ScanResult {\n            opencode_files: vec![PathBuf::from(\"a.json\"), PathBuf::from(\"b.json\")],\n            claude_files: vec![PathBuf::from(\"c.jsonl\")],\n            codex_files: vec![],\n            gemini_files: vec![PathBuf::from(\"d.json\")],\n            cursor_files: vec![],\n            amp_files: vec![],\n            droid_files: vec![],\n            openclaw_files: vec![],\n            pi_files: vec![PathBuf::from(\"e.jsonl\")],\n        };\n        assert_eq!(result.total_files(), 5);\n    }\n\n    #[test]\n    fn test_scan_result_all_files() {\n        let result = ScanResult {\n            opencode_files: vec![PathBuf::from(\"a.json\")],\n            claude_files: vec![PathBuf::from(\"b.jsonl\")],\n            codex_files: vec![PathBuf::from(\"c.jsonl\")],\n            gemini_files: vec![PathBuf::from(\"d.json\")],\n            cursor_files: vec![PathBuf::from(\"e.csv\")],\n            amp_files: vec![],\n            droid_files: vec![],\n            openclaw_files: vec![],\n            pi_files: vec![PathBuf::from(\"f.jsonl\")],\n        };\n\n        let all = result.all_files();\n        assert_eq!(all.len(), 6);\n        assert_eq!(all[0], (SessionType::OpenCode, PathBuf::from(\"a.json\")));\n        assert_eq!(all[1], (SessionType::Claude, PathBuf::from(\"b.jsonl\")));\n        assert_eq!(all[2], (SessionType::Codex, PathBuf::from(\"c.jsonl\")));\n        assert_eq!(all[3], (SessionType::Gemini, PathBuf::from(\"d.json\")));\n        assert_eq!(all[4], (SessionType::Cursor, PathBuf::from(\"e.csv\")));\n        assert_eq!(all[5], (SessionType::Pi, PathBuf::from(\"f.jsonl\")));\n    }\n\n    #[test]\n    fn test_scan_result_empty() {\n        let result = ScanResult::default();\n        assert_eq!(result.total_files(), 0);\n        assert!(result.all_files().is_empty());\n    }\n\n    #[test]\n    fn test_session_type_equality() {\n        assert_eq!(SessionType::OpenCode, SessionType::OpenCode);\n        assert_ne!(SessionType::OpenCode, SessionType::Claude);\n    }\n\n    #[test]\n    fn test_scan_directory_json_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        // Create test files\n        File::create(path.join(\"test1.json\")).unwrap();\n        File::create(path.join(\"test2.json\")).unwrap();\n        File::create(path.join(\"data.txt\")).unwrap();\n        File::create(path.join(\"other.jsonl\")).unwrap();\n\n        let json_files = scan_directory(path.to_str().unwrap(), \"*.json\");\n        assert_eq!(json_files.len(), 2);\n        assert!(json_files.iter().all(|p| p.extension().unwrap() == \"json\"));\n    }\n\n    #[test]\n    fn test_scan_directory_jsonl_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        File::create(path.join(\"session.jsonl\")).unwrap();\n        File::create(path.join(\"log.jsonl\")).unwrap();\n        File::create(path.join(\"data.json\")).unwrap();\n\n        let jsonl_files = scan_directory(path.to_str().unwrap(), \"*.jsonl\");\n        assert_eq!(jsonl_files.len(), 2);\n        assert!(jsonl_files\n            .iter()\n            .all(|p| p.extension().unwrap() == \"jsonl\"));\n    }\n\n    #[test]\n    fn test_scan_directory_session_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        File::create(path.join(\"session-001.json\")).unwrap();\n        File::create(path.join(\"session-abc.json\")).unwrap();\n        File::create(path.join(\"other.json\")).unwrap();\n        File::create(path.join(\"session.json\")).unwrap(); // Shouldn't match\n\n        let session_files = scan_directory(path.to_str().unwrap(), \"session-*.json\");\n        assert_eq!(session_files.len(), 2);\n        assert!(session_files.iter().all(|p| {\n            let name = p.file_name().unwrap().to_str().unwrap();\n            name.starts_with(\"session-\") \u0026\u0026 name.ends_with(\".json\")\n        }));\n    }\n\n    #[test]\n    fn test_scan_directory_nested() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        // Create nested structure\n        let sub1 = path.join(\"project1\");\n        let sub2 = path.join(\"project2\");\n        fs::create_dir_all(\u0026sub1).unwrap();\n        fs::create_dir_all(\u0026sub2).unwrap();\n\n        File::create(sub1.join(\"session.json\")).unwrap();\n        File::create(sub2.join(\"session.json\")).unwrap();\n        File::create(path.join(\"root.json\")).unwrap();\n\n        let files = scan_directory(path.to_str().unwrap(), \"*.json\");\n        assert_eq!(files.len(), 3);\n    }\n\n    #[test]\n    fn test_scan_directory_csv_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        File::create(path.join(\"usage.csv\")).unwrap();\n        File::create(path.join(\"data.csv\")).unwrap();\n        File::create(path.join(\"other.json\")).unwrap();\n\n        let csv_files = scan_directory(path.to_str().unwrap(), \"*.csv\");\n        assert_eq!(csv_files.len(), 2);\n        assert!(csv_files.iter().all(|p| p.extension().unwrap() == \"csv\"));\n    }\n\n    #[test]\n    fn test_scan_directory_nonexistent() {\n        let files = scan_directory(\"/nonexistent/path/that/does/not/exist\", \"*.json\");\n        assert!(files.is_empty());\n    }\n\n    #[test]\n    fn test_scan_directory_empty() {\n        let dir = TempDir::new().unwrap();\n        let files = scan_directory(dir.path().to_str().unwrap(), \"*.json\");\n        assert!(files.is_empty());\n    }\n\n    fn setup_mock_opencode_dir(base: \u0026std::path::Path) {\n        let opencode_path = base.join(\".local/share/opencode/storage/message/proj1\");\n        fs::create_dir_all(\u0026opencode_path).unwrap();\n        let mut file = File::create(opencode_path.join(\"msg_001.json\")).unwrap();\n        file.write_all(b\"{}\").unwrap();\n    }\n\n    fn setup_mock_claude_dir(base: \u0026std::path::Path) {\n        let claude_path = base.join(\".claude/projects/myproject\");\n        fs::create_dir_all(\u0026claude_path).unwrap();\n        let mut file = File::create(claude_path.join(\"conversation.jsonl\")).unwrap();\n        file.write_all(b\"\").unwrap();\n    }\n\n    fn setup_mock_codex_dir(base: \u0026std::path::Path) {\n        let codex_path = base.join(\".codex/sessions\");\n        fs::create_dir_all(\u0026codex_path).unwrap();\n        let mut file = File::create(codex_path.join(\"session.jsonl\")).unwrap();\n        file.write_all(b\"\").unwrap();\n    }\n\n    fn setup_mock_gemini_dir(base: \u0026std::path::Path) {\n        let gemini_path = base.join(\".gemini/tmp/123/chats\");\n        fs::create_dir_all(\u0026gemini_path).unwrap();\n        let mut file = File::create(gemini_path.join(\"session-abc.json\")).unwrap();\n        file.write_all(b\"{}\").unwrap();\n    }\n\n    #[test]\n    #[serial]\n    fn test_headless_roots_default() {\n        let previous = std::env::var(\"TOKSCALE_HEADLESS_DIR\").ok();\n        std::env::remove_var(\"TOKSCALE_HEADLESS_DIR\");\n\n        let home = \"/tmp/tokscale-test-home\";\n        let roots = headless_roots(home);\n        let config_root = PathBuf::from(format!(\"{}/.config/tokscale/headless\", home));\n        let mac_root = PathBuf::from(format!(\n            \"{}/Library/Application Support/tokscale/headless\",\n            home\n        ));\n\n        assert_eq!(roots.len(), 2);\n        assert!(roots.contains(\u0026config_root));\n        assert!(roots.contains(\u0026mac_root));\n\n        restore_env(\"TOKSCALE_HEADLESS_DIR\", previous);\n    }\n\n    #[test]\n    #[serial]\n    fn test_headless_roots_override() {\n        let previous = std::env::var(\"TOKSCALE_HEADLESS_DIR\").ok();\n        std::env::set_var(\"TOKSCALE_HEADLESS_DIR\", \"/custom/headless\");\n\n        let roots = headless_roots(\"/tmp/home\");\n        assert_eq!(roots, vec![PathBuf::from(\"/custom/headless\")]);\n\n        restore_env(\"TOKSCALE_HEADLESS_DIR\", previous);\n    }\n\n    #[test]\n    #[serial]\n    fn test_scan_all_sources_opencode() {\n        let previous_xdg = std::env::var(\"XDG_DATA_HOME\").ok();\n\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_opencode_dir(home);\n\n        // Set XDG_DATA_HOME for the test\n        std::env::set_var(\"XDG_DATA_HOME\", home.join(\".local/share\"));\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"opencode\".to_string()]);\n        assert_eq!(result.opencode_files.len(), 1);\n        assert!(result.claude_files.is_empty());\n        assert!(result.codex_files.is_empty());\n        assert!(result.gemini_files.is_empty());\n\n        restore_env(\"XDG_DATA_HOME\", previous_xdg);\n    }\n\n    #[test]\n    fn test_scan_all_sources_claude() {\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_claude_dir(home);\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"claude\".to_string()]);\n        assert_eq!(result.claude_files.len(), 1);\n        assert!(result.opencode_files.is_empty());\n    }\n\n    #[test]\n    fn test_scan_all_sources_gemini() {\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_gemini_dir(home);\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"gemini\".to_string()]);\n        assert_eq!(result.gemini_files.len(), 1);\n        assert!(result.opencode_files.is_empty());\n    }\n\n    #[test]\n    fn test_scan_all_sources_multiple() {\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n\n        setup_mock_claude_dir(home);\n        setup_mock_gemini_dir(home);\n\n        let result = scan_all_sources(\n            home.to_str().unwrap(),\n            \u0026[\"claude\".to_string(), \"gemini\".to_string()],\n        );\n\n        assert_eq!(result.claude_files.len(), 1);\n        assert_eq!(result.gemini_files.len(), 1);\n        assert!(result.opencode_files.is_empty());\n        assert!(result.codex_files.is_empty());\n    }\n\n    #[test]\n    #[serial]\n    fn test_scan_all_sources_headless_paths() {\n        let previous_headless = std::env::var(\"TOKSCALE_HEADLESS_DIR\").ok();\n        std::env::remove_var(\"TOKSCALE_HEADLESS_DIR\");\n\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n\n        let mac_root = home\n            .join(\"Library\")\n            .join(\"Application Support\")\n            .join(\"tokscale\")\n            .join(\"headless\");\n\n        fs::create_dir_all(mac_root.join(\"codex\")).unwrap();\n        File::create(mac_root.join(\"codex\").join(\"codex.jsonl\")).unwrap();\n\n        let result = scan_all_sources(\n            home.to_str().unwrap(),\n            \u0026[\n                \"claude\".to_string(),\n                \"codex\".to_string(),\n                \"gemini\".to_string(),\n            ],\n        );\n\n        assert!(result.claude_files.is_empty());\n        assert_eq!(result.codex_files.len(), 1);\n        assert!(result.gemini_files.is_empty());\n\n        restore_env(\"TOKSCALE_HEADLESS_DIR\", previous_headless);\n    }\n\n    #[test]\n    #[serial]\n    fn test_scan_all_sources_codex_with_env() {\n        let previous_codex = std::env::var(\"CODEX_HOME\").ok();\n\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_codex_dir(home);\n\n        // Set CODEX_HOME environment variable\n        std::env::set_var(\"CODEX_HOME\", home.join(\".codex\"));\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"codex\".to_string()]);\n        assert_eq!(result.codex_files.len(), 1);\n\n        restore_env(\"CODEX_HOME\", previous_codex);\n    }\n}\n","traces":[{"line":39,"address":[],"length":0,"stats":{"Line":4}},{"line":40,"address":[],"length":0,"stats":{"Line":40}},{"line":41,"address":[],"length":0,"stats":{"Line":32}},{"line":42,"address":[],"length":0,"stats":{"Line":28}},{"line":43,"address":[],"length":0,"stats":{"Line":24}},{"line":44,"address":[],"length":0,"stats":{"Line":20}},{"line":45,"address":[],"length":0,"stats":{"Line":16}},{"line":46,"address":[],"length":0,"stats":{"Line":12}},{"line":47,"address":[],"length":0,"stats":{"Line":8}},{"line":48,"address":[],"length":0,"stats":{"Line":4}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":8}},{"line":55,"address":[],"length":0,"stats":{"Line":4}},{"line":56,"address":[],"length":0,"stats":{"Line":4}},{"line":58,"address":[],"length":0,"stats":{"Line":4}},{"line":59,"address":[],"length":0,"stats":{"Line":4}},{"line":61,"address":[],"length":0,"stats":{"Line":4}},{"line":62,"address":[],"length":0,"stats":{"Line":4}},{"line":64,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":4}},{"line":68,"address":[],"length":0,"stats":{"Line":4}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":4}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":83,"address":[],"length":0,"stats":{"Line":2}},{"line":87,"address":[],"length":0,"stats":{"Line":10}},{"line":88,"address":[],"length":0,"stats":{"Line":11}},{"line":89,"address":[],"length":0,"stats":{"Line":3}},{"line":92,"address":[],"length":0,"stats":{"Line":18}},{"line":93,"address":[],"length":0,"stats":{"Line":36}},{"line":98,"address":[],"length":0,"stats":{"Line":27}},{"line":102,"address":[],"length":0,"stats":{"Line":27}},{"line":104,"address":[],"length":0,"stats":{"Line":9}},{"line":108,"address":[],"length":0,"stats":{"Line":48}},{"line":109,"address":[],"length":0,"stats":{"Line":48}},{"line":110,"address":[],"length":0,"stats":{"Line":13}},{"line":113,"address":[],"length":0,"stats":{"Line":70}},{"line":116,"address":[],"length":0,"stats":{"Line":1288391}},{"line":117,"address":[],"length":0,"stats":{"Line":644213}},{"line":118,"address":[],"length":0,"stats":{"Line":1932534}},{"line":119,"address":[],"length":0,"stats":{"Line":644178}},{"line":120,"address":[],"length":0,"stats":{"Line":35714}},{"line":123,"address":[],"length":0,"stats":{"Line":4867712}},{"line":125,"address":[],"length":0,"stats":{"Line":7905045}},{"line":126,"address":[],"length":0,"stats":{"Line":12159306}},{"line":127,"address":[],"length":0,"stats":{"Line":12159306}},{"line":128,"address":[],"length":0,"stats":{"Line":6079653}},{"line":131,"address":[],"length":0,"stats":{"Line":608464}},{"line":132,"address":[],"length":0,"stats":{"Line":1820260}},{"line":133,"address":[],"length":0,"stats":{"Line":6828}},{"line":134,"address":[],"length":0,"stats":{"Line":441}},{"line":135,"address":[],"length":0,"stats":{"Line":432}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":2}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":430}},{"line":157,"address":[],"length":0,"stats":{"Line":136}},{"line":159,"address":[],"length":0,"stats":{"Line":406}},{"line":160,"address":[],"length":0,"stats":{"Line":394}},{"line":161,"address":[],"length":0,"stats":{"Line":764}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":1215367}},{"line":170,"address":[],"length":0,"stats":{"Line":8}},{"line":171,"address":[],"length":0,"stats":{"Line":16}},{"line":173,"address":[],"length":0,"stats":{"Line":24}},{"line":174,"address":[],"length":0,"stats":{"Line":54}},{"line":175,"address":[],"length":0,"stats":{"Line":52}},{"line":176,"address":[],"length":0,"stats":{"Line":60}},{"line":177,"address":[],"length":0,"stats":{"Line":66}},{"line":178,"address":[],"length":0,"stats":{"Line":70}},{"line":179,"address":[],"length":0,"stats":{"Line":74}},{"line":180,"address":[],"length":0,"stats":{"Line":78}},{"line":181,"address":[],"length":0,"stats":{"Line":82}},{"line":182,"address":[],"length":0,"stats":{"Line":86}},{"line":184,"address":[],"length":0,"stats":{"Line":24}},{"line":187,"address":[],"length":0,"stats":{"Line":24}},{"line":189,"address":[],"length":0,"stats":{"Line":8}},{"line":191,"address":[],"length":0,"stats":{"Line":3}},{"line":192,"address":[],"length":0,"stats":{"Line":8}},{"line":193,"address":[],"length":0,"stats":{"Line":6}},{"line":194,"address":[],"length":0,"stats":{"Line":12}},{"line":197,"address":[],"length":0,"stats":{"Line":13}},{"line":199,"address":[],"length":0,"stats":{"Line":15}},{"line":200,"address":[],"length":0,"stats":{"Line":20}},{"line":203,"address":[],"length":0,"stats":{"Line":8}},{"line":205,"address":[],"length":0,"stats":{"Line":4}},{"line":206,"address":[],"length":0,"stats":{"Line":11}},{"line":207,"address":[],"length":0,"stats":{"Line":8}},{"line":208,"address":[],"length":0,"stats":{"Line":16}},{"line":211,"address":[],"length":0,"stats":{"Line":20}},{"line":212,"address":[],"length":0,"stats":{"Line":24}},{"line":213,"address":[],"length":0,"stats":{"Line":32}},{"line":214,"address":[],"length":0,"stats":{"Line":32}},{"line":218,"address":[],"length":0,"stats":{"Line":13}},{"line":220,"address":[],"length":0,"stats":{"Line":15}},{"line":221,"address":[],"length":0,"stats":{"Line":20}},{"line":224,"address":[],"length":0,"stats":{"Line":10}},{"line":226,"address":[],"length":0,"stats":{"Line":6}},{"line":228,"address":[],"length":0,"stats":{"Line":8}},{"line":231,"address":[],"length":0,"stats":{"Line":8}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":6}},{"line":235,"address":[],"length":0,"stats":{"Line":4}},{"line":236,"address":[],"length":0,"stats":{"Line":8}},{"line":239,"address":[],"length":0,"stats":{"Line":10}},{"line":241,"address":[],"length":0,"stats":{"Line":6}},{"line":242,"address":[],"length":0,"stats":{"Line":8}},{"line":245,"address":[],"length":0,"stats":{"Line":10}},{"line":247,"address":[],"length":0,"stats":{"Line":6}},{"line":248,"address":[],"length":0,"stats":{"Line":10}},{"line":250,"address":[],"length":0,"stats":{"Line":6}},{"line":251,"address":[],"length":0,"stats":{"Line":10}},{"line":252,"address":[],"length":0,"stats":{"Line":6}},{"line":253,"address":[],"length":0,"stats":{"Line":10}},{"line":254,"address":[],"length":0,"stats":{"Line":6}},{"line":255,"address":[],"length":0,"stats":{"Line":8}},{"line":258,"address":[],"length":0,"stats":{"Line":10}},{"line":260,"address":[],"length":0,"stats":{"Line":6}},{"line":261,"address":[],"length":0,"stats":{"Line":8}},{"line":265,"address":[],"length":0,"stats":{"Line":24}},{"line":267,"address":[],"length":0,"stats":{"Line":49}},{"line":268,"address":[],"length":0,"stats":{"Line":164}},{"line":269,"address":[],"length":0,"stats":{"Line":41}},{"line":274,"address":[],"length":0,"stats":{"Line":90}},{"line":275,"address":[],"length":0,"stats":{"Line":41}},{"line":276,"address":[],"length":0,"stats":{"Line":9}},{"line":277,"address":[],"length":0,"stats":{"Line":15}},{"line":278,"address":[],"length":0,"stats":{"Line":36}},{"line":279,"address":[],"length":0,"stats":{"Line":15}},{"line":280,"address":[],"length":0,"stats":{"Line":6}},{"line":281,"address":[],"length":0,"stats":{"Line":6}},{"line":282,"address":[],"length":0,"stats":{"Line":6}},{"line":283,"address":[],"length":0,"stats":{"Line":24}},{"line":284,"address":[],"length":0,"stats":{"Line":6}},{"line":288,"address":[],"length":0,"stats":{"Line":8}}],"covered":137,"coverable":147},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","amp.rs"],"content":"//! Amp (Sourcegraph) session parser\n//!\n//! Parses JSON files from ~/.local/share/amp/threads/\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::path::Path;\n\n/// Amp usage event from usageLedger\n#[derive(Debug, Deserialize)]\npub struct AmpUsageEvent {\n    pub timestamp: Option\u003cString\u003e,\n    pub model: Option\u003cString\u003e,\n    pub credits: Option\u003cf64\u003e,\n    pub tokens: Option\u003cAmpTokens\u003e,\n    #[serde(rename = \"operationType\")]\n    pub _operation_type: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpTokens {\n    pub input: Option\u003ci64\u003e,\n    pub output: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheReadInputTokens\")]\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheCreationInputTokens\")]\n    pub cache_creation_input_tokens: Option\u003ci64\u003e,\n}\n\n/// Amp message usage (per-message, more detailed)\n#[derive(Debug, Deserialize)]\npub struct AmpMessageUsage {\n    pub model: Option\u003cString\u003e,\n    #[serde(rename = \"inputTokens\")]\n    pub input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"outputTokens\")]\n    pub output_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheReadInputTokens\")]\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheCreationInputTokens\")]\n    pub cache_creation_input_tokens: Option\u003ci64\u003e,\n    pub credits: Option\u003cf64\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpMessage {\n    pub role: Option\u003cString\u003e,\n    #[serde(rename = \"messageId\")]\n    pub message_id: Option\u003ci64\u003e,\n    pub usage: Option\u003cAmpMessageUsage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpUsageLedger {\n    pub events: Option\u003cVec\u003cAmpUsageEvent\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpThread {\n    pub id: Option\u003cString\u003e,\n    pub created: Option\u003ci64\u003e,\n    pub messages: Option\u003cVec\u003cAmpMessage\u003e\u003e,\n    #[serde(rename = \"usageLedger\")]\n    pub usage_ledger: Option\u003cAmpUsageLedger\u003e,\n}\n\n/// Get provider from model name\nfn get_provider_from_model(model: \u0026str) -\u003e \u0026'static str {\n    let model_lower = model.to_lowercase();\n    if model_lower.contains(\"claude\")\n        || model_lower.contains(\"opus\")\n        || model_lower.contains(\"sonnet\")\n        || model_lower.contains(\"haiku\")\n    {\n        return \"anthropic\";\n    }\n    if model_lower.contains(\"gpt\") || model_lower.contains(\"o1\") || model_lower.contains(\"o3\") {\n        return \"openai\";\n    }\n    if model_lower.contains(\"gemini\") {\n        return \"google\";\n    }\n    if model_lower.contains(\"grok\") {\n        return \"xai\";\n    }\n    \"anthropic\" // Default for Amp\n}\n\n/// Parse an Amp thread JSON file\npub fn parse_amp_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let content = match std::fs::read(path) {\n        Ok(c) =\u003e c,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = content;\n    let thread: AmpThread = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(t) =\u003e t,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let thread_id = thread.id.clone().unwrap_or_else(|| {\n        path.file_stem()\n            .and_then(|s| s.to_str())\n            .unwrap_or(\"unknown\")\n            .to_string()\n    });\n\n    let mut messages = Vec::new();\n\n    // Prefer usageLedger.events (cleaner aggregated data)\n    if let Some(ledger) = thread.usage_ledger {\n        if let Some(events) = ledger.events {\n            for event in events {\n                let model = match event.model {\n                    Some(m) =\u003e m,\n                    None =\u003e continue,\n                };\n\n                let timestamp = event\n                    .timestamp\n                    .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n                    .map(|dt| dt.timestamp_millis())\n                    .unwrap_or(0);\n\n                if timestamp == 0 {\n                    continue;\n                }\n\n                let tokens = event.tokens.unwrap_or(AmpTokens {\n                    input: Some(0),\n                    output: Some(0),\n                    cache_read_input_tokens: Some(0),\n                    cache_creation_input_tokens: Some(0),\n                });\n\n                messages.push(UnifiedMessage::new(\n                    \"amp\",\n                    \u0026model,\n                    get_provider_from_model(\u0026model),\n                    thread_id.clone(),\n                    timestamp,\n                    TokenBreakdown {\n                        input: tokens.input.unwrap_or(0).max(0),\n                        output: tokens.output.unwrap_or(0).max(0),\n                        cache_read: tokens.cache_read_input_tokens.unwrap_or(0).max(0),\n                        cache_write: tokens.cache_creation_input_tokens.unwrap_or(0).max(0),\n                        reasoning: 0,\n                    },\n                    event.credits.unwrap_or(0.0).max(0.0),\n                ));\n            }\n            if !messages.is_empty() {\n                return messages;\n            }\n        }\n    }\n\n    // Fallback: parse from individual message usage\n    let created = thread.created.unwrap_or(0);\n    if let Some(thread_messages) = thread.messages {\n        for msg in thread_messages {\n            if msg.role.as_deref() != Some(\"assistant\") {\n                continue;\n            }\n\n            let usage = match msg.usage {\n                Some(u) =\u003e u,\n                None =\u003e continue,\n            };\n\n            let model = match usage.model {\n                Some(m) =\u003e m,\n                None =\u003e continue,\n            };\n\n            // Approximate timestamp from created + messageId offset\n            let message_id = msg.message_id.unwrap_or(0);\n            let timestamp = created + (message_id * 1000);\n\n            messages.push(UnifiedMessage::new(\n                \"amp\",\n                \u0026model,\n                get_provider_from_model(\u0026model),\n                thread_id.clone(),\n                timestamp,\n                TokenBreakdown {\n                    input: usage.input_tokens.unwrap_or(0).max(0),\n                    output: usage.output_tokens.unwrap_or(0).max(0),\n                    cache_read: usage.cache_read_input_tokens.unwrap_or(0).max(0),\n                    cache_write: usage.cache_creation_input_tokens.unwrap_or(0).max(0),\n                    reasoning: 0,\n                },\n                usage.credits.unwrap_or(0.0).max(0.0),\n            ));\n        }\n    }\n\n    messages\n}\n","traces":[{"line":69,"address":[],"length":0,"stats":{"Line":230}},{"line":70,"address":[],"length":0,"stats":{"Line":690}},{"line":71,"address":[],"length":0,"stats":{"Line":230}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":230}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":4}},{"line":92,"address":[],"length":0,"stats":{"Line":8}},{"line":93,"address":[],"length":0,"stats":{"Line":8}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":8}},{"line":98,"address":[],"length":0,"stats":{"Line":12}},{"line":99,"address":[],"length":0,"stats":{"Line":8}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":16}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":8}},{"line":113,"address":[],"length":0,"stats":{"Line":6}},{"line":114,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":232}},{"line":116,"address":[],"length":0,"stats":{"Line":460}},{"line":117,"address":[],"length":0,"stats":{"Line":460}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":460}},{"line":122,"address":[],"length":0,"stats":{"Line":230}},{"line":123,"address":[],"length":0,"stats":{"Line":920}},{"line":124,"address":[],"length":0,"stats":{"Line":690}},{"line":127,"address":[],"length":0,"stats":{"Line":230}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":920}},{"line":132,"address":[],"length":0,"stats":{"Line":460}},{"line":133,"address":[],"length":0,"stats":{"Line":460}},{"line":134,"address":[],"length":0,"stats":{"Line":230}},{"line":135,"address":[],"length":0,"stats":{"Line":230}},{"line":138,"address":[],"length":0,"stats":{"Line":690}},{"line":140,"address":[],"length":0,"stats":{"Line":230}},{"line":141,"address":[],"length":0,"stats":{"Line":460}},{"line":142,"address":[],"length":0,"stats":{"Line":460}},{"line":143,"address":[],"length":0,"stats":{"Line":230}},{"line":144,"address":[],"length":0,"stats":{"Line":230}},{"line":145,"address":[],"length":0,"stats":{"Line":920}},{"line":146,"address":[],"length":0,"stats":{"Line":920}},{"line":147,"address":[],"length":0,"stats":{"Line":920}},{"line":148,"address":[],"length":0,"stats":{"Line":460}},{"line":149,"address":[],"length":0,"stats":{"Line":230}},{"line":151,"address":[],"length":0,"stats":{"Line":690}},{"line":154,"address":[],"length":0,"stats":{"Line":2}},{"line":155,"address":[],"length":0,"stats":{"Line":2}},{"line":161,"address":[],"length":0,"stats":{"Line":6}},{"line":162,"address":[],"length":0,"stats":{"Line":4}},{"line":163,"address":[],"length":0,"stats":{"Line":2}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":2}}],"covered":45,"coverable":85},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","claudecode.rs"],"content":"//! Claude Code session parser\n//!\n//! Parses JSONL files from ~/.claude/projects/\n\nuse super::utils::{\n    extract_i64, extract_string, file_modified_timestamp_ms, parse_timestamp_value,\n};\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse serde_json::Value;\nuse std::collections::HashSet;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Claude Code entry structure (from JSONL files)\n#[derive(Debug, Deserialize)]\npub struct ClaudeEntry {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    pub timestamp: Option\u003cString\u003e,\n    pub message: Option\u003cClaudeMessage\u003e,\n    /// Request ID for deduplication (used with message.id)\n    #[serde(rename = \"requestId\")]\n    pub request_id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ClaudeMessage {\n    pub model: Option\u003cString\u003e,\n    pub usage: Option\u003cClaudeUsage\u003e,\n    /// Message ID for deduplication (used with requestId)\n    pub id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ClaudeUsage {\n    pub input_tokens: Option\u003ci64\u003e,\n    pub output_tokens: Option\u003ci64\u003e,\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n    pub cache_creation_input_tokens: Option\u003ci64\u003e,\n}\n\n/// Parse a Claude Code JSONL file\npub fn parse_claude_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string();\n\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    if path.extension().and_then(|s| s.to_str()) == Some(\"json\") {\n        let json_messages = parse_claude_headless_json(path, \u0026session_id, fallback_timestamp);\n        if !json_messages.is_empty() {\n            return json_messages;\n        }\n    }\n\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n    let mut processed_hashes: HashSet\u003cString\u003e = HashSet::new();\n    let mut headless_state = ClaudeHeadlessState::default();\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut handled = false;\n        let mut bytes = trimmed.as_bytes().to_vec();\n        if let Ok(entry) = simd_json::from_slice::\u003cClaudeEntry\u003e(\u0026mut bytes) {\n            // Only process assistant messages with usage data\n            if entry.entry_type == \"assistant\" {\n                let message = match entry.message {\n                    Some(m) =\u003e m,\n                    None =\u003e continue,\n                };\n\n                // Build dedup key for global deduplication (messageId:requestId composite)\n                let dedup_key = match (\u0026message.id, \u0026entry.request_id) {\n                    (Some(msg_id), Some(req_id)) =\u003e {\n                        let hash = format!(\"{}:{}\", msg_id, req_id);\n                        if !processed_hashes.insert(hash.clone()) {\n                            continue;\n                        }\n                        Some(hash)\n                    }\n                    _ =\u003e None,\n                };\n\n                let usage = match message.usage {\n                    Some(u) =\u003e u,\n                    None =\u003e continue,\n                };\n\n                let model = match message.model {\n                    Some(m) =\u003e m,\n                    None =\u003e continue,\n                };\n\n                let timestamp = entry\n                    .timestamp\n                    .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n                    .map(|dt| dt.timestamp_millis())\n                    .unwrap_or(fallback_timestamp);\n\n                messages.push(UnifiedMessage::new_with_dedup(\n                    \"claude\",\n                    model,\n                    \"anthropic\",\n                    session_id.clone(),\n                    timestamp,\n                    TokenBreakdown {\n                        input: usage.input_tokens.unwrap_or(0).max(0),\n                        output: usage.output_tokens.unwrap_or(0).max(0),\n                        cache_read: usage.cache_read_input_tokens.unwrap_or(0).max(0),\n                        cache_write: usage.cache_creation_input_tokens.unwrap_or(0).max(0),\n                        reasoning: 0,\n                    },\n                    0.0,\n                    dedup_key,\n                ));\n                handled = true;\n            }\n        }\n\n        if handled {\n            continue;\n        }\n\n        if let Some(message) = process_claude_headless_line(\n            trimmed,\n            \u0026session_id,\n            \u0026mut headless_state,\n            fallback_timestamp,\n        ) {\n            messages.push(message);\n        }\n    }\n\n    if let Some(message) =\n        finalize_headless_state(\u0026mut headless_state, \u0026session_id, fallback_timestamp)\n    {\n        messages.push(message);\n    }\n\n    messages\n}\n\n#[derive(Default)]\nstruct ClaudeHeadlessState {\n    model: Option\u003cString\u003e,\n    input: i64,\n    output: i64,\n    cache_read: i64,\n    cache_write: i64,\n    timestamp_ms: Option\u003ci64\u003e,\n}\n\nfn parse_claude_headless_json(\n    path: \u0026Path,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let data = match std::fs::read(path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data;\n    let value: Value = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(v) =\u003e v,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut messages = Vec::new();\n    if let Some(message) = extract_claude_headless_message(\u0026value, session_id, fallback_timestamp) {\n        messages.push(message);\n    }\n\n    messages\n}\n\nfn process_claude_headless_line(\n    line: \u0026str,\n    session_id: \u0026str,\n    state: \u0026mut ClaudeHeadlessState,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let mut bytes = line.as_bytes().to_vec();\n    let value: Value = simd_json::from_slice(\u0026mut bytes).ok()?;\n\n    let event_type = value.get(\"type\").and_then(|val| val.as_str()).unwrap_or(\"\");\n    let mut completed_message: Option\u003cUnifiedMessage\u003e = None;\n\n    match event_type {\n        \"message_start\" =\u003e {\n            completed_message = finalize_headless_state(state, session_id, fallback_timestamp);\n\n            state.model = extract_claude_model(\u0026value);\n            state.timestamp_ms = extract_claude_timestamp(\u0026value).or(state.timestamp_ms);\n            if let Some(usage) = value\n                .get(\"message\")\n                .and_then(|msg| msg.get(\"usage\"))\n                .or_else(|| value.get(\"usage\"))\n            {\n                update_claude_usage(state, usage);\n            }\n        }\n        \"message_delta\" =\u003e {\n            if let Some(usage) = value\n                .get(\"usage\")\n                .or_else(|| value.get(\"delta\").and_then(|delta| delta.get(\"usage\")))\n            {\n                update_claude_usage(state, usage);\n            }\n        }\n        \"message_stop\" =\u003e {\n            completed_message = finalize_headless_state(state, session_id, fallback_timestamp);\n        }\n        _ =\u003e {\n            if let Some(message) =\n                extract_claude_headless_message(\u0026value, session_id, fallback_timestamp)\n            {\n                completed_message = Some(message);\n            }\n        }\n    }\n\n    completed_message\n}\n\nfn extract_claude_headless_message(\n    value: \u0026Value,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let usage = value\n        .get(\"usage\")\n        .or_else(|| value.get(\"message\").and_then(|msg| msg.get(\"usage\")))?;\n    let model = extract_claude_model(value)?;\n    let timestamp = extract_claude_timestamp(value).unwrap_or(fallback_timestamp);\n\n    Some(UnifiedMessage::new(\n        \"claude\",\n        model,\n        \"anthropic\",\n        session_id.to_string(),\n        timestamp,\n        TokenBreakdown {\n            input: extract_i64(usage.get(\"input_tokens\")).unwrap_or(0).max(0),\n            output: extract_i64(usage.get(\"output_tokens\")).unwrap_or(0).max(0),\n            cache_read: extract_i64(usage.get(\"cache_read_input_tokens\"))\n                .unwrap_or(0)\n                .max(0),\n            cache_write: extract_i64(usage.get(\"cache_creation_input_tokens\"))\n                .unwrap_or(0)\n                .max(0),\n            reasoning: 0,\n        },\n        0.0,\n    ))\n}\n\nfn extract_claude_model(value: \u0026Value) -\u003e Option\u003cString\u003e {\n    extract_string(value.get(\"model\")).or_else(|| {\n        value\n            .get(\"message\")\n            .and_then(|msg| extract_string(msg.get(\"model\")))\n    })\n}\n\nfn extract_claude_timestamp(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    value\n        .get(\"timestamp\")\n        .or_else(|| value.get(\"created_at\"))\n        .or_else(|| value.get(\"message\").and_then(|msg| msg.get(\"created_at\")))\n        .and_then(parse_timestamp_value)\n}\n\nfn update_claude_usage(state: \u0026mut ClaudeHeadlessState, usage: \u0026Value) {\n    if let Some(input) = extract_i64(usage.get(\"input_tokens\")) {\n        state.input = state.input.max(input);\n    }\n    if let Some(output) = extract_i64(usage.get(\"output_tokens\")) {\n        state.output = state.output.max(output);\n    }\n    if let Some(cache_read) = extract_i64(usage.get(\"cache_read_input_tokens\")) {\n        state.cache_read = state.cache_read.max(cache_read);\n    }\n    if let Some(cache_write) = extract_i64(usage.get(\"cache_creation_input_tokens\")) {\n        state.cache_write = state.cache_write.max(cache_write);\n    }\n}\n\nfn finalize_headless_state(\n    state: \u0026mut ClaudeHeadlessState,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let model = state.model.clone()?;\n    let timestamp = state.timestamp_ms.unwrap_or(fallback_timestamp);\n    if state.input == 0 \u0026\u0026 state.output == 0 \u0026\u0026 state.cache_read == 0 \u0026\u0026 state.cache_write == 0 {\n        *state = ClaudeHeadlessState::default();\n        return None;\n    }\n\n    let message = UnifiedMessage::new(\n        \"claude\",\n        model,\n        \"anthropic\",\n        session_id.to_string(),\n        timestamp,\n        TokenBreakdown {\n            input: state.input.max(0),\n            output: state.output.max(0),\n            cache_read: state.cache_read.max(0),\n            cache_write: state.cache_write.max(0),\n            reasoning: 0,\n        },\n        0.0,\n    );\n\n    *state = ClaudeHeadlessState::default();\n    Some(message)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n    use tempfile::NamedTempFile;\n\n    fn create_test_file(content: \u0026str) -\u003e NamedTempFile {\n        let mut file = NamedTempFile::new().unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n        file\n    }\n\n    #[test]\n    fn test_deduplication_skips_duplicate_entries() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:02.000Z\",\"requestId\":\"req_002\",\"message\":{\"id\":\"msg_002\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":200,\"output_tokens\":100}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(\n            messages.len(),\n            2,\n            \"Should deduplicate to 2 messages (first duplicate skipped)\"\n        );\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[1].tokens.input, 200);\n    }\n\n    #[test]\n    fn test_deduplication_allows_same_message_different_request() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"requestId\":\"req_002\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":150,\"output_tokens\":75}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(\n            messages.len(),\n            2,\n            \"Different requestId should not be deduplicated\"\n        );\n    }\n\n    #[test]\n    fn test_entries_without_dedup_fields_still_processed() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"message\":{\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"message\":{\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":200,\"output_tokens\":100}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(\n            messages.len(),\n            2,\n            \"Entries without messageId/requestId should still be processed\"\n        );\n    }\n\n    #[test]\n    fn test_user_messages_ignored() {\n        let content = r#\"{\"type\":\"user\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"message\":{\"content\":\"Hello\"}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1, \"User messages should be ignored\");\n        assert_eq!(messages[0].tokens.input, 100);\n    }\n\n    #[test]\n    fn test_token_breakdown_parsing() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":1000,\"output_tokens\":500,\"cache_read_input_tokens\":200,\"cache_creation_input_tokens\":100}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].tokens.input, 1000);\n        assert_eq!(messages[0].tokens.output, 500);\n        assert_eq!(messages[0].tokens.cache_read, 200);\n        assert_eq!(messages[0].tokens.cache_write, 100);\n        assert_eq!(messages[0].tokens.reasoning, 0);\n    }\n\n    #[test]\n    fn test_headless_json_output() {\n        let content = r#\"{\"type\":\"message\",\"message\":{\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":120,\"output_tokens\":60,\"cache_read_input_tokens\":10}}}\"#;\n        let file = tempfile::Builder::new().suffix(\".json\").tempfile().unwrap();\n        std::fs::write(file.path(), content).unwrap();\n\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"claude-3-5-sonnet\");\n        assert_eq!(messages[0].tokens.input, 120);\n        assert_eq!(messages[0].tokens.output, 60);\n        assert_eq!(messages[0].tokens.cache_read, 10);\n    }\n\n    #[test]\n    fn test_headless_stream_output() {\n        let content = r#\"{\"type\":\"message_start\",\"timestamp\":\"2025-01-01T00:00:00Z\",\"message\":{\"id\":\"msg_1\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":200,\"cache_read_input_tokens\":20,\"cache_creation_input_tokens\":5}}}\n{\"type\":\"message_delta\",\"usage\":{\"output_tokens\":80}}\n{\"type\":\"message_stop\"}\"#;\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"claude-3-5-sonnet\");\n        assert_eq!(messages[0].tokens.input, 200);\n        assert_eq!(messages[0].tokens.output, 80);\n        assert_eq!(messages[0].tokens.cache_read, 20);\n        assert_eq!(messages[0].tokens.cache_write, 5);\n    }\n}\n","traces":[{"line":45,"address":[],"length":0,"stats":{"Line":1691}},{"line":46,"address":[],"length":0,"stats":{"Line":3382}},{"line":48,"address":[],"length":0,"stats":{"Line":5073}},{"line":52,"address":[],"length":0,"stats":{"Line":5073}},{"line":54,"address":[],"length":0,"stats":{"Line":10134}},{"line":55,"address":[],"length":0,"stats":{"Line":5}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":3380}},{"line":62,"address":[],"length":0,"stats":{"Line":3380}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":5070}},{"line":67,"address":[],"length":0,"stats":{"Line":3380}},{"line":68,"address":[],"length":0,"stats":{"Line":5070}},{"line":69,"address":[],"length":0,"stats":{"Line":3380}},{"line":71,"address":[],"length":0,"stats":{"Line":185277}},{"line":72,"address":[],"length":0,"stats":{"Line":363794}},{"line":73,"address":[],"length":0,"stats":{"Line":363794}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":363794}},{"line":78,"address":[],"length":0,"stats":{"Line":363794}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":363794}},{"line":83,"address":[],"length":0,"stats":{"Line":545691}},{"line":84,"address":[],"length":0,"stats":{"Line":363794}},{"line":86,"address":[],"length":0,"stats":{"Line":181897}},{"line":87,"address":[],"length":0,"stats":{"Line":127098}},{"line":88,"address":[],"length":0,"stats":{"Line":127098}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":158480}},{"line":94,"address":[],"length":0,"stats":{"Line":115594}},{"line":95,"address":[],"length":0,"stats":{"Line":115594}},{"line":96,"address":[],"length":0,"stats":{"Line":173391}},{"line":97,"address":[],"length":0,"stats":{"Line":32167}},{"line":99,"address":[],"length":0,"stats":{"Line":25630}},{"line":101,"address":[],"length":0,"stats":{"Line":5752}},{"line":104,"address":[],"length":0,"stats":{"Line":62764}},{"line":105,"address":[],"length":0,"stats":{"Line":62764}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":62764}},{"line":110,"address":[],"length":0,"stats":{"Line":62764}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":62764}},{"line":115,"address":[],"length":0,"stats":{"Line":31382}},{"line":116,"address":[],"length":0,"stats":{"Line":125528}},{"line":117,"address":[],"length":0,"stats":{"Line":94146}},{"line":118,"address":[],"length":0,"stats":{"Line":62764}},{"line":120,"address":[],"length":0,"stats":{"Line":94146}},{"line":122,"address":[],"length":0,"stats":{"Line":31382}},{"line":124,"address":[],"length":0,"stats":{"Line":62764}},{"line":125,"address":[],"length":0,"stats":{"Line":31382}},{"line":126,"address":[],"length":0,"stats":{"Line":31382}},{"line":127,"address":[],"length":0,"stats":{"Line":125528}},{"line":128,"address":[],"length":0,"stats":{"Line":125528}},{"line":129,"address":[],"length":0,"stats":{"Line":125528}},{"line":130,"address":[],"length":0,"stats":{"Line":62764}},{"line":131,"address":[],"length":0,"stats":{"Line":31382}},{"line":134,"address":[],"length":0,"stats":{"Line":31382}},{"line":136,"address":[],"length":0,"stats":{"Line":31382}},{"line":140,"address":[],"length":0,"stats":{"Line":149730}},{"line":141,"address":[],"length":0,"stats":{"Line":31382}},{"line":145,"address":[],"length":0,"stats":{"Line":236696}},{"line":146,"address":[],"length":0,"stats":{"Line":236696}},{"line":147,"address":[],"length":0,"stats":{"Line":118348}},{"line":148,"address":[],"length":0,"stats":{"Line":118348}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":5070}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":1690}},{"line":173,"address":[],"length":0,"stats":{"Line":1}},{"line":178,"address":[],"length":0,"stats":{"Line":2}},{"line":179,"address":[],"length":0,"stats":{"Line":2}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":2}},{"line":184,"address":[],"length":0,"stats":{"Line":3}},{"line":185,"address":[],"length":0,"stats":{"Line":2}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":2}},{"line":190,"address":[],"length":0,"stats":{"Line":5}},{"line":191,"address":[],"length":0,"stats":{"Line":2}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":118348}},{"line":203,"address":[],"length":0,"stats":{"Line":355044}},{"line":204,"address":[],"length":0,"stats":{"Line":591740}},{"line":206,"address":[],"length":0,"stats":{"Line":946784}},{"line":207,"address":[],"length":0,"stats":{"Line":355044}},{"line":209,"address":[],"length":0,"stats":{"Line":118348}},{"line":210,"address":[],"length":0,"stats":{"Line":118348}},{"line":211,"address":[],"length":0,"stats":{"Line":5}},{"line":213,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":3}},{"line":215,"address":[],"length":0,"stats":{"Line":2}},{"line":217,"address":[],"length":0,"stats":{"Line":3}},{"line":218,"address":[],"length":0,"stats":{"Line":1}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":223,"address":[],"length":0,"stats":{"Line":118347}},{"line":224,"address":[],"length":0,"stats":{"Line":2}},{"line":226,"address":[],"length":0,"stats":{"Line":1}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":231,"address":[],"length":0,"stats":{"Line":118347}},{"line":232,"address":[],"length":0,"stats":{"Line":4}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":355035}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":118348}},{"line":246,"address":[],"length":0,"stats":{"Line":118346}},{"line":251,"address":[],"length":0,"stats":{"Line":118347}},{"line":253,"address":[],"length":0,"stats":{"Line":668729}},{"line":254,"address":[],"length":0,"stats":{"Line":3}},{"line":255,"address":[],"length":0,"stats":{"Line":5}},{"line":257,"address":[],"length":0,"stats":{"Line":2}},{"line":258,"address":[],"length":0,"stats":{"Line":1}},{"line":259,"address":[],"length":0,"stats":{"Line":2}},{"line":260,"address":[],"length":0,"stats":{"Line":1}},{"line":261,"address":[],"length":0,"stats":{"Line":3}},{"line":262,"address":[],"length":0,"stats":{"Line":2}},{"line":263,"address":[],"length":0,"stats":{"Line":1}},{"line":264,"address":[],"length":0,"stats":{"Line":6}},{"line":265,"address":[],"length":0,"stats":{"Line":6}},{"line":266,"address":[],"length":0,"stats":{"Line":4}},{"line":267,"address":[],"length":0,"stats":{"Line":2}},{"line":268,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":4}},{"line":270,"address":[],"length":0,"stats":{"Line":1}},{"line":271,"address":[],"length":0,"stats":{"Line":1}},{"line":272,"address":[],"length":0,"stats":{"Line":1}},{"line":274,"address":[],"length":0,"stats":{"Line":1}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":10}},{"line":280,"address":[],"length":0,"stats":{"Line":2}},{"line":281,"address":[],"length":0,"stats":{"Line":2}},{"line":282,"address":[],"length":0,"stats":{"Line":8}},{"line":286,"address":[],"length":0,"stats":{"Line":2}},{"line":287,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":4}},{"line":290,"address":[],"length":0,"stats":{"Line":7}},{"line":291,"address":[],"length":0,"stats":{"Line":2}},{"line":294,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":6}},{"line":296,"address":[],"length":0,"stats":{"Line":2}},{"line":298,"address":[],"length":0,"stats":{"Line":6}},{"line":299,"address":[],"length":0,"stats":{"Line":2}},{"line":301,"address":[],"length":0,"stats":{"Line":6}},{"line":302,"address":[],"length":0,"stats":{"Line":2}},{"line":304,"address":[],"length":0,"stats":{"Line":6}},{"line":305,"address":[],"length":0,"stats":{"Line":2}},{"line":309,"address":[],"length":0,"stats":{"Line":1692}},{"line":314,"address":[],"length":0,"stats":{"Line":5076}},{"line":315,"address":[],"length":0,"stats":{"Line":4}},{"line":316,"address":[],"length":0,"stats":{"Line":1}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":1}},{"line":325,"address":[],"length":0,"stats":{"Line":2}},{"line":326,"address":[],"length":0,"stats":{"Line":1}},{"line":327,"address":[],"length":0,"stats":{"Line":1}},{"line":328,"address":[],"length":0,"stats":{"Line":3}},{"line":329,"address":[],"length":0,"stats":{"Line":3}},{"line":330,"address":[],"length":0,"stats":{"Line":3}},{"line":331,"address":[],"length":0,"stats":{"Line":1}},{"line":332,"address":[],"length":0,"stats":{"Line":1}},{"line":337,"address":[],"length":0,"stats":{"Line":2}},{"line":338,"address":[],"length":0,"stats":{"Line":1}}],"covered":150,"coverable":164},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","codex.rs"],"content":"//! Codex CLI session parser\n//!\n//! Parses JSONL files from ~/.codex/sessions/\n//! Note: This parser has stateful logic to track model and delta calculations.\n\nuse super::utils::{\n    extract_i64, extract_string, file_modified_timestamp_ms, parse_timestamp_value,\n};\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse serde_json::Value;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Codex entry structure (from JSONL files)\n#[derive(Debug, Deserialize)]\npub struct CodexEntry {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    pub timestamp: Option\u003cString\u003e,\n    pub payload: Option\u003cCodexPayload\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct CodexPayload {\n    #[serde(rename = \"type\")]\n    pub payload_type: Option\u003cString\u003e,\n    pub model: Option\u003cString\u003e,\n    pub model_name: Option\u003cString\u003e,\n    pub info: Option\u003cCodexInfo\u003e,\n    pub source: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct CodexInfo {\n    pub model: Option\u003cString\u003e,\n    pub model_name: Option\u003cString\u003e,\n    pub last_token_usage: Option\u003cCodexTokenUsage\u003e,\n    pub total_token_usage: Option\u003cCodexTokenUsage\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct CodexTokenUsage {\n    pub input_tokens: Option\u003ci64\u003e,\n    pub output_tokens: Option\u003ci64\u003e,\n    pub cached_input_tokens: Option\u003ci64\u003e,\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n}\n\n/// Parse a Codex JSONL file with stateful tracking\npub fn parse_codex_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string();\n\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n\n    // Stateful tracking\n    let mut current_model: Option\u003cString\u003e = None;\n    let mut previous_totals: Option\u003c(i64, i64, i64)\u003e = None; // (input, output, cached)\n    let mut session_is_headless = false;\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut handled = false;\n        let mut bytes = trimmed.as_bytes().to_vec();\n        if let Ok(entry) = simd_json::from_slice::\u003cCodexEntry\u003e(\u0026mut bytes) {\n            if let Some(payload) = entry.payload {\n                // Check session_meta for headless exec sessions\n                if entry.entry_type == \"session_meta\" \u0026\u0026 payload.source.as_deref() == Some(\"exec\") {\n                    session_is_headless = true;\n                }\n                // Extract model from turn_context\n                if entry.entry_type == \"turn_context\" {\n                    current_model = extract_model(\u0026payload);\n                    handled = true;\n                }\n\n                // Process token_count events\n                if entry.entry_type == \"event_msg\"\n                    \u0026\u0026 payload.payload_type.as_deref() == Some(\"token_count\")\n                {\n                    // Try to extract model from payload\n                    if let Some(model) = extract_model(\u0026payload) {\n                        current_model = Some(model);\n                    }\n\n                    let info = match payload.info {\n                        Some(i) =\u003e i,\n                        None =\u003e continue,\n                    };\n\n                    // Try to extract model from info\n                    if let Some(model) = info.model.clone().or(info.model_name.clone()) {\n                        current_model = Some(model);\n                    }\n\n                    let model = current_model\n                        .clone()\n                        .unwrap_or_else(|| \"unknown\".to_string());\n\n                    // Calculate delta tokens\n                    // Note: OpenAI's input_tokens INCLUDES cached tokens (they are a subset).\n                    // We subtract cached from input to avoid double-counting when aggregating.\n                    let (input, output, cached) = if let Some(last) = \u0026info.last_token_usage {\n                        let total_input = last.input_tokens.unwrap_or(0);\n                        let cached = last\n                            .cached_input_tokens\n                            .or(last.cache_read_input_tokens)\n                            .unwrap_or(0);\n                        (\n                            total_input.saturating_sub(cached),\n                            last.output_tokens.unwrap_or(0),\n                            cached,\n                        )\n                    } else if let (Some(total), Some(prev)) =\n                        (\u0026info.total_token_usage, \u0026previous_totals)\n                    {\n                        let curr_input = total.input_tokens.unwrap_or(0);\n                        let curr_output = total.output_tokens.unwrap_or(0);\n                        let curr_cached = total\n                            .cached_input_tokens\n                            .or(total.cache_read_input_tokens)\n                            .unwrap_or(0);\n\n                        let delta_input = (curr_input - prev.0).max(0);\n                        let delta_cached = (curr_cached - prev.2).max(0);\n                        (\n                            (delta_input - delta_cached).max(0),\n                            (curr_output - prev.1).max(0),\n                            delta_cached,\n                        )\n                    } else {\n                        continue;\n                    };\n\n                    // Update previous totals\n                    if let Some(total) = \u0026info.total_token_usage {\n                        previous_totals = Some((\n                            total.input_tokens.unwrap_or(0),\n                            total.output_tokens.unwrap_or(0),\n                            total\n                                .cached_input_tokens\n                                .or(total.cache_read_input_tokens)\n                                .unwrap_or(0),\n                        ));\n                    }\n\n                    // Skip empty deltas\n                    if input == 0 \u0026\u0026 output == 0 \u0026\u0026 cached == 0 {\n                        continue;\n                    }\n\n                    let timestamp = entry\n                        .timestamp\n                        .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n                        .map(|dt| dt.timestamp_millis())\n                        .unwrap_or(fallback_timestamp);\n\n                    let agent = if session_is_headless {\n                        Some(\"headless\".to_string())\n                    } else {\n                        None\n                    };\n\n                    messages.push(UnifiedMessage::new_with_agent(\n                        \"codex\",\n                        model,\n                        \"openai\",\n                        session_id.clone(),\n                        timestamp,\n                        TokenBreakdown {\n                            input: input.max(0),\n                            output: output.max(0),\n                            cache_read: cached.max(0),\n                            cache_write: 0,\n                            reasoning: 0,\n                        },\n                        0.0,\n                        agent,\n                    ));\n                    handled = true;\n                }\n            }\n\n            // Mark session_meta as handled (even if payload was processed above)\n            if entry.entry_type == \"session_meta\" {\n                handled = true;\n            }\n        }\n\n        if handled {\n            continue;\n        }\n\n        if let Some(msg) =\n            parse_codex_headless_line(trimmed, \u0026session_id, \u0026mut current_model, fallback_timestamp)\n        {\n            let mut msg = msg;\n            if session_is_headless \u0026\u0026 msg.agent.is_none() {\n                msg.agent = Some(\"headless\".to_string());\n            }\n            messages.push(msg);\n        }\n    }\n\n    messages\n}\n\nfn extract_model(payload: \u0026CodexPayload) -\u003e Option\u003cString\u003e {\n    payload\n        .model\n        .clone()\n        .or(payload.model_name.clone())\n        .or(payload.info.as_ref().and_then(|i| i.model.clone()))\n        .or(payload.info.as_ref().and_then(|i| i.model_name.clone()))\n        .filter(|m| !m.is_empty())\n}\n\nstruct CodexHeadlessUsage {\n    input: i64,\n    output: i64,\n    cached: i64,\n    model: Option\u003cString\u003e,\n    timestamp_ms: Option\u003ci64\u003e,\n}\n\nfn parse_codex_headless_line(\n    line: \u0026str,\n    session_id: \u0026str,\n    current_model: \u0026mut Option\u003cString\u003e,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let mut bytes = line.as_bytes().to_vec();\n    let value: Value = simd_json::from_slice(\u0026mut bytes).ok()?;\n\n    if let Some(model) = extract_model_from_value(\u0026value) {\n        *current_model = Some(model);\n    }\n\n    let usage = extract_headless_usage(\u0026value)?;\n    let model = usage\n        .model\n        .or_else(|| current_model.clone())\n        .unwrap_or_else(|| \"unknown\".to_string());\n    let timestamp = usage.timestamp_ms.unwrap_or(fallback_timestamp);\n\n    if usage.input == 0 \u0026\u0026 usage.output == 0 \u0026\u0026 usage.cached == 0 {\n        return None;\n    }\n\n    Some(UnifiedMessage::new(\n        \"codex\",\n        model,\n        \"openai\",\n        session_id.to_string(),\n        timestamp,\n        TokenBreakdown {\n            input: usage.input.max(0),\n            output: usage.output.max(0),\n            cache_read: usage.cached.max(0),\n            cache_write: 0,\n            reasoning: 0,\n        },\n        0.0,\n    ))\n}\n\nfn extract_headless_usage(value: \u0026Value) -\u003e Option\u003cCodexHeadlessUsage\u003e {\n    let usage = value\n        .get(\"usage\")\n        .or_else(|| value.get(\"data\").and_then(|data| data.get(\"usage\")))\n        .or_else(|| value.get(\"result\").and_then(|data| data.get(\"usage\")))\n        .or_else(|| value.get(\"response\").and_then(|data| data.get(\"usage\")))?;\n\n    let input_tokens = extract_i64(usage.get(\"input_tokens\"))\n        .or_else(|| extract_i64(usage.get(\"prompt_tokens\")))\n        .or_else(|| extract_i64(usage.get(\"input\")))\n        .unwrap_or(0);\n    let output_tokens = extract_i64(usage.get(\"output_tokens\"))\n        .or_else(|| extract_i64(usage.get(\"completion_tokens\")))\n        .or_else(|| extract_i64(usage.get(\"output\")))\n        .unwrap_or(0);\n    let cached_tokens = extract_i64(usage.get(\"cached_input_tokens\"))\n        .or_else(|| extract_i64(usage.get(\"cache_read_input_tokens\")))\n        .or_else(|| extract_i64(usage.get(\"cached_tokens\")))\n        .unwrap_or(0);\n\n    let model = extract_model_from_value(value)\n        .or_else(|| value.get(\"data\").and_then(extract_model_from_value));\n    let timestamp_ms = extract_timestamp_from_value(value);\n\n    Some(CodexHeadlessUsage {\n        input: input_tokens.saturating_sub(cached_tokens),\n        output: output_tokens,\n        cached: cached_tokens,\n        model,\n        timestamp_ms,\n    })\n}\n\nfn extract_model_from_value(value: \u0026Value) -\u003e Option\u003cString\u003e {\n    extract_string(value.get(\"model\"))\n        .or_else(|| extract_string(value.get(\"model_name\")))\n        .or_else(|| {\n            value\n                .get(\"data\")\n                .and_then(|data| extract_string(data.get(\"model\")))\n        })\n        .or_else(|| {\n            value\n                .get(\"data\")\n                .and_then(|data| extract_string(data.get(\"model_name\")))\n        })\n        .or_else(|| {\n            value\n                .get(\"response\")\n                .and_then(|data| extract_string(data.get(\"model\")))\n        })\n}\n\nfn extract_timestamp_from_value(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    value\n        .get(\"timestamp\")\n        .or_else(|| value.get(\"time\"))\n        .or_else(|| value.get(\"created_at\"))\n        .or_else(|| value.get(\"data\").and_then(|data| data.get(\"timestamp\")))\n        .and_then(parse_timestamp_value)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n    use tempfile::NamedTempFile;\n\n    fn create_test_file(content: \u0026str) -\u003e NamedTempFile {\n        let mut file = NamedTempFile::new().unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n        file\n    }\n\n    #[test]\n    fn test_headless_usage_line() {\n        let content = r#\"{\"type\":\"turn.completed\",\"model\":\"gpt-4o-mini\",\"usage\":{\"input_tokens\":120,\"cached_input_tokens\":20,\"output_tokens\":30}}\"#;\n        let file = create_test_file(content);\n\n        let messages = parse_codex_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-4o-mini\");\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[0].tokens.output, 30);\n        assert_eq!(messages[0].tokens.cache_read, 20);\n    }\n\n    #[test]\n    fn test_headless_usage_nested_data() {\n        let content = r#\"{\"type\":\"result\",\"data\":{\"model_name\":\"gpt-4o\",\"usage\":{\"input_tokens\":50,\"cached_input_tokens\":5,\"output_tokens\":12}}}\"#;\n        let file = create_test_file(content);\n\n        let messages = parse_codex_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-4o\");\n        assert_eq!(messages[0].tokens.input, 45);\n        assert_eq!(messages[0].tokens.output, 12);\n        assert_eq!(messages[0].tokens.cache_read, 5);\n    }\n\n    #[test]\n    fn test_session_meta_exec_marks_headless() {\n        let line1 = r#\"{\"timestamp\":\"2026-01-01T00:00:00Z\",\"type\":\"session_meta\",\"payload\":{\"originator\":\"codex_exec\",\"source\":\"exec\"}}\"#;\n        let line2 = r#\"{\"timestamp\":\"2026-01-01T00:00:01Z\",\"type\":\"event_msg\",\"payload\":{\"type\":\"token_count\",\"info\":{\"last_token_usage\":{\"input_tokens\":10,\"cached_input_tokens\":2,\"output_tokens\":3}}}}\"#;\n        let content = format!(\"{}\\n{}\", line1, line2);\n        let file = create_test_file(\u0026content);\n\n        let messages = parse_codex_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].agent.as_deref(), Some(\"headless\"));\n    }\n}\n","traces":[{"line":52,"address":[],"length":0,"stats":{"Line":37}},{"line":53,"address":[],"length":0,"stats":{"Line":74}},{"line":54,"address":[],"length":0,"stats":{"Line":74}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":74}},{"line":60,"address":[],"length":0,"stats":{"Line":111}},{"line":64,"address":[],"length":0,"stats":{"Line":111}},{"line":66,"address":[],"length":0,"stats":{"Line":111}},{"line":67,"address":[],"length":0,"stats":{"Line":74}},{"line":70,"address":[],"length":0,"stats":{"Line":111}},{"line":71,"address":[],"length":0,"stats":{"Line":111}},{"line":72,"address":[],"length":0,"stats":{"Line":74}},{"line":74,"address":[],"length":0,"stats":{"Line":356}},{"line":75,"address":[],"length":0,"stats":{"Line":564}},{"line":76,"address":[],"length":0,"stats":{"Line":564}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":564}},{"line":81,"address":[],"length":0,"stats":{"Line":564}},{"line":82,"address":[],"length":0,"stats":{"Line":52}},{"line":85,"address":[],"length":0,"stats":{"Line":460}},{"line":86,"address":[],"length":0,"stats":{"Line":690}},{"line":87,"address":[],"length":0,"stats":{"Line":338}},{"line":88,"address":[],"length":0,"stats":{"Line":214}},{"line":90,"address":[],"length":0,"stats":{"Line":112}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":116}},{"line":95,"address":[],"length":0,"stats":{"Line":30}},{"line":96,"address":[],"length":0,"stats":{"Line":10}},{"line":100,"address":[],"length":0,"stats":{"Line":106}},{"line":101,"address":[],"length":0,"stats":{"Line":49}},{"line":104,"address":[],"length":0,"stats":{"Line":21}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":38}},{"line":109,"address":[],"length":0,"stats":{"Line":34}},{"line":110,"address":[],"length":0,"stats":{"Line":4}},{"line":114,"address":[],"length":0,"stats":{"Line":68}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":34}},{"line":120,"address":[],"length":0,"stats":{"Line":19}},{"line":125,"address":[],"length":0,"stats":{"Line":85}},{"line":126,"address":[],"length":0,"stats":{"Line":51}},{"line":127,"address":[],"length":0,"stats":{"Line":34}},{"line":128,"address":[],"length":0,"stats":{"Line":17}},{"line":129,"address":[],"length":0,"stats":{"Line":34}},{"line":132,"address":[],"length":0,"stats":{"Line":68}},{"line":133,"address":[],"length":0,"stats":{"Line":34}},{"line":134,"address":[],"length":0,"stats":{"Line":17}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":49}},{"line":159,"address":[],"length":0,"stats":{"Line":16}},{"line":160,"address":[],"length":0,"stats":{"Line":48}},{"line":161,"address":[],"length":0,"stats":{"Line":48}},{"line":162,"address":[],"length":0,"stats":{"Line":32}},{"line":163,"address":[],"length":0,"stats":{"Line":32}},{"line":164,"address":[],"length":0,"stats":{"Line":32}},{"line":165,"address":[],"length":0,"stats":{"Line":16}},{"line":170,"address":[],"length":0,"stats":{"Line":17}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":34}},{"line":175,"address":[],"length":0,"stats":{"Line":17}},{"line":176,"address":[],"length":0,"stats":{"Line":68}},{"line":177,"address":[],"length":0,"stats":{"Line":51}},{"line":178,"address":[],"length":0,"stats":{"Line":34}},{"line":180,"address":[],"length":0,"stats":{"Line":34}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":16}},{"line":186,"address":[],"length":0,"stats":{"Line":51}},{"line":188,"address":[],"length":0,"stats":{"Line":17}},{"line":190,"address":[],"length":0,"stats":{"Line":34}},{"line":191,"address":[],"length":0,"stats":{"Line":17}},{"line":192,"address":[],"length":0,"stats":{"Line":17}},{"line":193,"address":[],"length":0,"stats":{"Line":51}},{"line":194,"address":[],"length":0,"stats":{"Line":51}},{"line":195,"address":[],"length":0,"stats":{"Line":17}},{"line":196,"address":[],"length":0,"stats":{"Line":17}},{"line":197,"address":[],"length":0,"stats":{"Line":17}},{"line":200,"address":[],"length":0,"stats":{"Line":17}},{"line":202,"address":[],"length":0,"stats":{"Line":17}},{"line":207,"address":[],"length":0,"stats":{"Line":109}},{"line":208,"address":[],"length":0,"stats":{"Line":5}},{"line":212,"address":[],"length":0,"stats":{"Line":226}},{"line":213,"address":[],"length":0,"stats":{"Line":32}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":217,"address":[],"length":0,"stats":{"Line":776}},{"line":219,"address":[],"length":0,"stats":{"Line":4}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":6}},{"line":227,"address":[],"length":0,"stats":{"Line":37}},{"line":230,"address":[],"length":0,"stats":{"Line":31}},{"line":231,"address":[],"length":0,"stats":{"Line":31}},{"line":232,"address":[],"length":0,"stats":{"Line":31}},{"line":234,"address":[],"length":0,"stats":{"Line":93}},{"line":235,"address":[],"length":0,"stats":{"Line":158}},{"line":236,"address":[],"length":0,"stats":{"Line":158}},{"line":237,"address":[],"length":0,"stats":{"Line":51}},{"line":248,"address":[],"length":0,"stats":{"Line":194}},{"line":254,"address":[],"length":0,"stats":{"Line":582}},{"line":255,"address":[],"length":0,"stats":{"Line":848}},{"line":257,"address":[],"length":0,"stats":{"Line":76}},{"line":258,"address":[],"length":0,"stats":{"Line":2}},{"line":261,"address":[],"length":0,"stats":{"Line":216}},{"line":262,"address":[],"length":0,"stats":{"Line":4}},{"line":263,"address":[],"length":0,"stats":{"Line":2}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":265,"address":[],"length":0,"stats":{"Line":2}},{"line":266,"address":[],"length":0,"stats":{"Line":8}},{"line":268,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":4}},{"line":273,"address":[],"length":0,"stats":{"Line":2}},{"line":274,"address":[],"length":0,"stats":{"Line":4}},{"line":275,"address":[],"length":0,"stats":{"Line":2}},{"line":276,"address":[],"length":0,"stats":{"Line":6}},{"line":277,"address":[],"length":0,"stats":{"Line":4}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":6}},{"line":280,"address":[],"length":0,"stats":{"Line":6}},{"line":281,"address":[],"length":0,"stats":{"Line":2}},{"line":282,"address":[],"length":0,"stats":{"Line":2}},{"line":283,"address":[],"length":0,"stats":{"Line":2}},{"line":285,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":72}},{"line":290,"address":[],"length":0,"stats":{"Line":74}},{"line":292,"address":[],"length":0,"stats":{"Line":287}},{"line":293,"address":[],"length":0,"stats":{"Line":282}},{"line":294,"address":[],"length":0,"stats":{"Line":352}},{"line":296,"address":[],"length":0,"stats":{"Line":8}},{"line":297,"address":[],"length":0,"stats":{"Line":2}},{"line":298,"address":[],"length":0,"stats":{"Line":2}},{"line":300,"address":[],"length":0,"stats":{"Line":8}},{"line":301,"address":[],"length":0,"stats":{"Line":2}},{"line":302,"address":[],"length":0,"stats":{"Line":2}},{"line":304,"address":[],"length":0,"stats":{"Line":8}},{"line":305,"address":[],"length":0,"stats":{"Line":2}},{"line":306,"address":[],"length":0,"stats":{"Line":2}},{"line":309,"address":[],"length":0,"stats":{"Line":6}},{"line":310,"address":[],"length":0,"stats":{"Line":2}},{"line":311,"address":[],"length":0,"stats":{"Line":6}},{"line":313,"address":[],"length":0,"stats":{"Line":2}},{"line":314,"address":[],"length":0,"stats":{"Line":8}},{"line":315,"address":[],"length":0,"stats":{"Line":4}},{"line":316,"address":[],"length":0,"stats":{"Line":4}},{"line":317,"address":[],"length":0,"stats":{"Line":2}},{"line":318,"address":[],"length":0,"stats":{"Line":2}},{"line":322,"address":[],"length":0,"stats":{"Line":74}},{"line":323,"address":[],"length":0,"stats":{"Line":222}},{"line":324,"address":[],"length":0,"stats":{"Line":290}},{"line":325,"address":[],"length":0,"stats":{"Line":146}},{"line":326,"address":[],"length":0,"stats":{"Line":72}},{"line":327,"address":[],"length":0,"stats":{"Line":72}},{"line":328,"address":[],"length":0,"stats":{"Line":78}},{"line":330,"address":[],"length":0,"stats":{"Line":146}},{"line":331,"address":[],"length":0,"stats":{"Line":72}},{"line":332,"address":[],"length":0,"stats":{"Line":72}},{"line":333,"address":[],"length":0,"stats":{"Line":78}},{"line":335,"address":[],"length":0,"stats":{"Line":144}},{"line":336,"address":[],"length":0,"stats":{"Line":70}},{"line":337,"address":[],"length":0,"stats":{"Line":70}},{"line":338,"address":[],"length":0,"stats":{"Line":70}},{"line":342,"address":[],"length":0,"stats":{"Line":2}},{"line":343,"address":[],"length":0,"stats":{"Line":2}},{"line":345,"address":[],"length":0,"stats":{"Line":6}},{"line":346,"address":[],"length":0,"stats":{"Line":6}},{"line":347,"address":[],"length":0,"stats":{"Line":10}},{"line":348,"address":[],"length":0,"stats":{"Line":2}}],"covered":158,"coverable":178},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","cursor.rs"],"content":"//! Cursor IDE session parser\n//!\n//! Parses CSV files from the Cursor usage export API.\n//! CSV files are cached locally at ~/.config/tokscale/cursor-cache/*.csv\n//! (legacy single-account cache uses usage.csv; additional accounts may use usage.\u003caccount\u003e.csv)\n//!\n//! CSV Format (actual from API):\n//! Date,Kind,Model,Max Mode,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse std::path::Path;\n\nfn account_id_from_cursor_cache_path(path: \u0026Path) -\u003e String {\n    let file_name = path\n        .file_name()\n        .and_then(|n| n.to_str())\n        .unwrap_or(\"usage.csv\");\n\n    if file_name == \"usage.csv\" {\n        return \"active\".to_string();\n    }\n\n    if let Some(stem) = file_name\n        .strip_prefix(\"usage.\")\n        .and_then(|s| s.strip_suffix(\".csv\"))\n    {\n        // Keep it simple/ASCII. The CLI already sanitizes file names.\n        let cleaned = stem\n            .chars()\n            .map(|c| {\n                if c.is_ascii_alphanumeric() || c == '-' || c == '_' || c == '.' {\n                    c\n                } else {\n                    '-'\n                }\n            })\n            .collect::\u003cString\u003e();\n        if cleaned.is_empty() {\n            return \"unknown\".to_string();\n        }\n        return cleaned;\n    }\n\n    \"unknown\".to_string()\n}\n\n/// Provider inference from model name\nfn infer_provider(model: \u0026str) -\u003e \u0026'static str {\n    let lower = model.to_lowercase();\n\n    if lower.contains(\"claude\")\n        || lower.contains(\"sonnet\")\n        || lower.contains(\"opus\")\n        || lower.contains(\"haiku\")\n    {\n        \"anthropic\"\n    } else if lower.contains(\"gpt\") || lower.contains(\"o1\") || lower.contains(\"o3\") {\n        \"openai\"\n    } else if lower.contains(\"gemini\") {\n        \"google\"\n    } else if lower.contains(\"deepseek\") {\n        \"deepseek\"\n    } else if lower.contains(\"llama\") || lower.contains(\"mixtral\") {\n        \"meta\"\n    } else {\n        \"cursor\"\n    }\n}\n\n/// Parse a cost string like \"$0.50\" or \"0.50\" to f64\n/// Returns 0.0 for empty strings, NaN values, or invalid formats\nfn parse_cost(cost_str: \u0026str) -\u003e f64 {\n    let cleaned = cost_str.replace(['$', ','], \"\");\n    let trimmed = cleaned.trim();\n\n    // Handle empty or NaN values\n    if trimmed.is_empty() || trimmed.eq_ignore_ascii_case(\"nan\") {\n        return 0.0;\n    }\n\n    trimmed.parse().unwrap_or(0.0)\n}\n\n/// Parse a Cursor usage CSV file\n///\n/// Handles both formats:\n/// - New: Date,Kind,Model,Max Mode,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost\n/// - Old: Date,Model,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost,Cost to you\npub fn parse_cursor_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let content = match std::fs::read_to_string(path) {\n        Ok(c) =\u003e c,\n        Err(_) =\u003e return vec![],\n    };\n\n    let mut messages = Vec::new();\n    let mut lines = content.lines();\n\n    // Parse header line to determine column indices\n    let header = match lines.next() {\n        Some(h) =\u003e h,\n        None =\u003e return vec![],\n    };\n\n    // Verify this is a valid Cursor CSV\n    if !header.contains(\"Date\") || !header.contains(\"Model\") {\n        return vec![];\n    }\n\n    // Detect format by checking for \"Kind\" column\n    let header_fields: Vec\u003c\u0026str\u003e = parse_csv_line(header);\n    let has_kind_column = header_fields.iter().any(|f| f.trim() == \"Kind\");\n\n    // Column indices based on format\n    let (\n        model_idx,\n        input_cache_write_idx,\n        input_no_cache_idx,\n        cache_read_idx,\n        output_idx,\n        cost_idx,\n    ) = if has_kind_column {\n        // New format: Date,Kind,Model,Max Mode,Input (w/ Cache Write),...\n        (2, 4, 5, 6, 7, 9)\n    } else {\n        // Old format: Date,Model,Input (w/ Cache Write),...\n        (1, 2, 3, 4, 5, 7)\n    };\n\n    let account_id = account_id_from_cursor_cache_path(path);\n\n    for line in lines {\n        if line.trim().is_empty() {\n            continue;\n        }\n\n        // Parse CSV line (simple parsing, handles quoted fields)\n        let fields: Vec\u003c\u0026str\u003e = parse_csv_line(line);\n\n        // Need at least enough columns for the format\n        let min_fields = cost_idx + 1;\n        if fields.len() \u003c min_fields {\n            continue;\n        }\n\n        let date_str = fields[0].trim().trim_matches('\"');\n        let model = fields[model_idx].trim().trim_matches('\"');\n        let input_with_cache_write: i64 = fields[input_cache_write_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let input_without_cache_write: i64 = fields[input_no_cache_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let cache_read: i64 = fields[cache_read_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let output_tokens: i64 = fields[output_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let cost_str = fields[cost_idx].trim().trim_matches('\"');\n        let cost = parse_cost(cost_str);\n\n        // Skip empty or errored entries\n        if model.is_empty() {\n            continue;\n        }\n\n        // Parse timestamp from date string\n        let timestamp = parse_date_to_timestamp(date_str);\n        if timestamp == 0 {\n            continue;\n        }\n\n        // Cache write = input_with_cache_write - input_without_cache_write\n        let cache_write = (input_with_cache_write - input_without_cache_write).max(0);\n        // Input tokens = input_without_cache_write\n        let input = input_without_cache_write;\n\n        messages.push(UnifiedMessage::new(\n            \"cursor\",\n            model,\n            infer_provider(model),\n            format!(\"cursor-{}-{}\", account_id, date_str),\n            timestamp,\n            TokenBreakdown {\n                input: input.max(0),\n                output: output_tokens.max(0),\n                cache_read: cache_read.max(0),\n                cache_write, // Already clamped above with .max(0)\n                reasoning: 0,\n            },\n            cost.max(0.0),\n        ));\n    }\n\n    messages\n}\n\n/// Simple CSV line parser that handles quoted fields\nfn parse_csv_line(line: \u0026str) -\u003e Vec\u003c\u0026str\u003e {\n    let mut fields = Vec::new();\n    let mut start = 0;\n    let mut in_quotes = false;\n    let bytes = line.as_bytes();\n\n    for (i, \u0026byte) in bytes.iter().enumerate() {\n        match byte {\n            b'\"' =\u003e in_quotes = !in_quotes,\n            b',' if !in_quotes =\u003e {\n                fields.push(\u0026line[start..i]);\n                start = i + 1;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    // Add the last field\n    if start \u003c= line.len() {\n        fields.push(\u0026line[start..]);\n    }\n\n    fields\n}\n\n/// Parse a date string to Unix milliseconds timestamp\nfn parse_date_to_timestamp(date_str: \u0026str) -\u003e i64 {\n    use chrono::{NaiveDate, NaiveDateTime, TimeZone, Utc};\n\n    // Try ISO 8601 format with milliseconds: \"2025-02-05T12:00:00.123Z\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%S%.3fZ\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try ISO 8601 format with time: \"2025-02-05T12:00:00Z\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%SZ\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try ISO 8601 format with milliseconds without Z: \"2025-02-05T12:00:00.123\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%S%.3f\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try ISO 8601 format with time without Z: \"2025-02-05T12:00:00\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%S\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try date only format: \"2025-02-05\"\n    if let Ok(date) = NaiveDate::parse_from_str(date_str, \"%Y-%m-%d\") {\n        let dt = date.and_hms_opt(12, 0, 0).unwrap(); // Noon UTC\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    0\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_infer_provider() {\n        assert_eq!(infer_provider(\"claude-3-sonnet\"), \"anthropic\");\n        assert_eq!(infer_provider(\"gpt-4o\"), \"openai\");\n        assert_eq!(infer_provider(\"gemini-pro\"), \"google\");\n        assert_eq!(infer_provider(\"deepseek-coder\"), \"deepseek\");\n        assert_eq!(infer_provider(\"llama-3\"), \"meta\");\n        assert_eq!(infer_provider(\"unknown-model\"), \"cursor\");\n    }\n\n    #[test]\n    fn test_parse_cost() {\n        assert_eq!(parse_cost(\"$0.50\"), 0.50);\n        assert_eq!(parse_cost(\"0.50\"), 0.50);\n        assert_eq!(parse_cost(\"$1,234.56\"), 1234.56);\n        assert_eq!(parse_cost(\"\"), 0.0);\n        assert_eq!(parse_cost(\"NaN\"), 0.0);\n        assert_eq!(parse_cost(\"nan\"), 0.0);\n        assert_eq!(parse_cost(\"  \"), 0.0);\n    }\n\n    #[test]\n    fn test_parse_csv_line() {\n        let line = \"2025-02-01,gpt-4o,10,5,0,15,30,$0.10,$0.10\";\n        let fields = parse_csv_line(line);\n        assert_eq!(fields.len(), 9);\n        assert_eq!(fields[0], \"2025-02-01\");\n        assert_eq!(fields[1], \"gpt-4o\");\n        assert_eq!(fields[8], \"$0.10\");\n    }\n\n    #[test]\n    fn test_parse_date_to_timestamp() {\n        // ISO with milliseconds and Z (new Cursor format)\n        let ts = parse_date_to_timestamp(\"2025-11-13T18:36:05.846Z\");\n        assert!(ts \u003e 0);\n\n        // ISO with Z\n        let ts = parse_date_to_timestamp(\"2025-02-05T12:00:00Z\");\n        assert!(ts \u003e 0);\n\n        // Date only\n        let ts = parse_date_to_timestamp(\"2025-02-05\");\n        assert!(ts \u003e 0);\n\n        // Invalid\n        let ts = parse_date_to_timestamp(\"invalid\");\n        assert_eq!(ts, 0);\n    }\n\n    #[test]\n    fn test_parse_cursor_csv_sample_old_format() {\n        let csv = \"Date,Model,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost,Cost to you\n2025-02-01,gpt-4o,10,5,0,15,30,$0.10,$0.10\n2025-02-02,gpt-4o-mini,0,0,0,5,5,$0.05,$0.05\";\n\n        let temp_dir = tempfile::TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"usage.csv\");\n        std::fs::write(\u0026file_path, csv).unwrap();\n\n        let messages = parse_cursor_file(\u0026file_path);\n        assert_eq!(messages.len(), 2);\n\n        assert_eq!(messages[0].source, \"cursor\");\n        assert_eq!(messages[0].model_id, \"gpt-4o\");\n        assert_eq!(messages[0].provider_id, \"openai\");\n        assert_eq!(messages[0].tokens.input, 5);\n        assert_eq!(messages[0].tokens.output, 15);\n        assert_eq!(messages[0].tokens.cache_write, 5); // 10 - 5\n        assert!((messages[0].cost - 0.10).abs() \u003c 0.001);\n\n        assert_eq!(messages[1].model_id, \"gpt-4o-mini\");\n    }\n\n    #[test]\n    fn test_parse_cursor_csv_sample_new_format() {\n        // Real format from Cursor API\n        let csv = r#\"Date,Kind,Model,Max Mode,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost\n\"2025-11-13T18:36:05.846Z\",\"Included\",\"auto\",\"No\",\"28342\",\"775\",\"105891\",\"21282\",\"156290\",\"0.19\"\n\"2025-11-13T13:35:04.658Z\",\"On-Demand\",\"gpt-5-codex\",\"No\",\"0\",\"8263\",\"66964\",\"1612\",\"76839\",\"0.03\"\"#;\n\n        let temp_dir = tempfile::TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"usage.csv\");\n        std::fs::write(\u0026file_path, csv).unwrap();\n\n        let messages = parse_cursor_file(\u0026file_path);\n        assert_eq!(messages.len(), 2);\n\n        // First message: auto model\n        assert_eq!(messages[0].source, \"cursor\");\n        assert_eq!(messages[0].model_id, \"auto\");\n        assert_eq!(messages[0].provider_id, \"cursor\"); // unknown model -\u003e cursor\n        assert_eq!(messages[0].tokens.input, 775);\n        assert_eq!(messages[0].tokens.output, 21282);\n        assert_eq!(messages[0].tokens.cache_read, 105891);\n        assert_eq!(messages[0].tokens.cache_write, 28342 - 775); // 27567\n        assert!((messages[0].cost - 0.19).abs() \u003c 0.001);\n\n        // Second message: gpt-5-codex\n        assert_eq!(messages[1].model_id, \"gpt-5-codex\");\n        assert_eq!(messages[1].provider_id, \"openai\"); // gpt -\u003e openai\n        assert_eq!(messages[1].tokens.input, 8263);\n        assert_eq!(messages[1].tokens.cache_read, 66964);\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":8}},{"line":17,"address":[],"length":0,"stats":{"Line":12}},{"line":20,"address":[],"length":0,"stats":{"Line":4}},{"line":21,"address":[],"length":0,"stats":{"Line":8}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":10076}},{"line":50,"address":[],"length":0,"stats":{"Line":30228}},{"line":52,"address":[],"length":0,"stats":{"Line":10076}},{"line":53,"address":[],"length":0,"stats":{"Line":4763}},{"line":54,"address":[],"length":0,"stats":{"Line":4763}},{"line":55,"address":[],"length":0,"stats":{"Line":4763}},{"line":57,"address":[],"length":0,"stats":{"Line":5313}},{"line":58,"address":[],"length":0,"stats":{"Line":11165}},{"line":59,"address":[],"length":0,"stats":{"Line":1840}},{"line":60,"address":[],"length":0,"stats":{"Line":2923}},{"line":61,"address":[],"length":0,"stats":{"Line":105}},{"line":62,"address":[],"length":0,"stats":{"Line":2818}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":5633}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":67,"address":[],"length":0,"stats":{"Line":2816}},{"line":73,"address":[],"length":0,"stats":{"Line":10077}},{"line":74,"address":[],"length":0,"stats":{"Line":50385}},{"line":75,"address":[],"length":0,"stats":{"Line":20154}},{"line":78,"address":[],"length":0,"stats":{"Line":50379}},{"line":79,"address":[],"length":0,"stats":{"Line":3518}},{"line":82,"address":[],"length":0,"stats":{"Line":19677}},{"line":90,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":8}},{"line":92,"address":[],"length":0,"stats":{"Line":8}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":8}},{"line":97,"address":[],"length":0,"stats":{"Line":8}},{"line":100,"address":[],"length":0,"stats":{"Line":8}},{"line":101,"address":[],"length":0,"stats":{"Line":8}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":8}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":16}},{"line":112,"address":[],"length":0,"stats":{"Line":42}},{"line":116,"address":[],"length":0,"stats":{"Line":4}},{"line":117,"address":[],"length":0,"stats":{"Line":4}},{"line":118,"address":[],"length":0,"stats":{"Line":4}},{"line":119,"address":[],"length":0,"stats":{"Line":4}},{"line":120,"address":[],"length":0,"stats":{"Line":4}},{"line":121,"address":[],"length":0,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":4}},{"line":124,"address":[],"length":0,"stats":{"Line":3}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":12}},{"line":132,"address":[],"length":0,"stats":{"Line":10074}},{"line":133,"address":[],"length":0,"stats":{"Line":20140}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":40280}},{"line":141,"address":[],"length":0,"stats":{"Line":20140}},{"line":142,"address":[],"length":0,"stats":{"Line":20140}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":30210}},{"line":147,"address":[],"length":0,"stats":{"Line":30210}},{"line":148,"address":[],"length":0,"stats":{"Line":30210}},{"line":153,"address":[],"length":0,"stats":{"Line":30210}},{"line":158,"address":[],"length":0,"stats":{"Line":30210}},{"line":163,"address":[],"length":0,"stats":{"Line":30210}},{"line":168,"address":[],"length":0,"stats":{"Line":30210}},{"line":169,"address":[],"length":0,"stats":{"Line":30210}},{"line":172,"address":[],"length":0,"stats":{"Line":20140}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":30210}},{"line":178,"address":[],"length":0,"stats":{"Line":10070}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":30210}},{"line":185,"address":[],"length":0,"stats":{"Line":20140}},{"line":187,"address":[],"length":0,"stats":{"Line":30210}},{"line":189,"address":[],"length":0,"stats":{"Line":10070}},{"line":190,"address":[],"length":0,"stats":{"Line":20140}},{"line":191,"address":[],"length":0,"stats":{"Line":10070}},{"line":192,"address":[],"length":0,"stats":{"Line":10070}},{"line":193,"address":[],"length":0,"stats":{"Line":10070}},{"line":194,"address":[],"length":0,"stats":{"Line":30210}},{"line":195,"address":[],"length":0,"stats":{"Line":30210}},{"line":196,"address":[],"length":0,"stats":{"Line":20140}},{"line":197,"address":[],"length":0,"stats":{"Line":10070}},{"line":198,"address":[],"length":0,"stats":{"Line":10070}},{"line":200,"address":[],"length":0,"stats":{"Line":20140}},{"line":204,"address":[],"length":0,"stats":{"Line":4}},{"line":208,"address":[],"length":0,"stats":{"Line":10075}},{"line":209,"address":[],"length":0,"stats":{"Line":20150}},{"line":210,"address":[],"length":0,"stats":{"Line":20150}},{"line":211,"address":[],"length":0,"stats":{"Line":20150}},{"line":212,"address":[],"length":0,"stats":{"Line":30225}},{"line":214,"address":[],"length":0,"stats":{"Line":1993105}},{"line":215,"address":[],"length":0,"stats":{"Line":91155}},{"line":216,"address":[],"length":0,"stats":{"Line":201360}},{"line":217,"address":[],"length":0,"stats":{"Line":181342}},{"line":218,"address":[],"length":0,"stats":{"Line":362684}},{"line":219,"address":[],"length":0,"stats":{"Line":90671}},{"line":221,"address":[],"length":0,"stats":{"Line":689409}},{"line":226,"address":[],"length":0,"stats":{"Line":30225}},{"line":227,"address":[],"length":0,"stats":{"Line":30225}},{"line":230,"address":[],"length":0,"stats":{"Line":10075}},{"line":234,"address":[],"length":0,"stats":{"Line":10074}},{"line":238,"address":[],"length":0,"stats":{"Line":30218}},{"line":239,"address":[],"length":0,"stats":{"Line":30210}},{"line":243,"address":[],"length":0,"stats":{"Line":8}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":8}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":8}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":11}},{"line":259,"address":[],"length":0,"stats":{"Line":12}},{"line":260,"address":[],"length":0,"stats":{"Line":9}},{"line":263,"address":[],"length":0,"stats":{"Line":1}}],"covered":103,"coverable":124},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","droid.rs"],"content":"//! Droid (Factory.ai) session parser\n//!\n//! Parses JSON files from ~/.factory/sessions/\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Droid settings.json structure\n#[derive(Debug, Deserialize)]\npub struct DroidSettingsJson {\n    pub model: Option\u003cString\u003e,\n    #[serde(rename = \"providerLock\")]\n    pub provider_lock: Option\u003cString\u003e,\n    #[serde(rename = \"providerLockTimestamp\")]\n    pub provider_lock_timestamp: Option\u003cString\u003e,\n    #[serde(rename = \"tokenUsage\")]\n    pub token_usage: Option\u003cDroidTokenUsage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct DroidTokenUsage {\n    #[serde(rename = \"inputTokens\")]\n    pub input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"outputTokens\")]\n    pub output_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheCreationTokens\")]\n    pub cache_creation_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheReadTokens\")]\n    pub cache_read_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"thinkingTokens\")]\n    pub thinking_tokens: Option\u003ci64\u003e,\n}\n\n/// Normalize model name from Droid's custom format\n/// e.g., \"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\" -\u003e \"claude-opus-4-5-thinking-0\"\n/// e.g., \"gemini-2.5-pro\" -\u003e \"gemini-2-5-pro\"\n/// e.g., \"Claude-Sonnet-4-[Anthropic]\" -\u003e \"claude-sonnet-4\"\nfn normalize_model_name(model: \u0026str) -\u003e String {\n    // Remove \"custom:\" prefix if present\n    let mut normalized = model.strip_prefix(\"custom:\").unwrap_or(model).to_string();\n\n    // Handle bracket notation like \"Claude-Opus-4.5-Thinking-[Anthropic]-0\"\n    // Remove [anything] patterns (like TypeScript's .replace(/\\[.*?\\]/g, \"\"))\n    let mut result = String::new();\n    let mut in_bracket = false;\n\n    for ch in normalized.chars() {\n        match ch {\n            '[' =\u003e in_bracket = true,\n            ']' =\u003e in_bracket = false,\n            _ if !in_bracket =\u003e result.push(ch),\n            _ =\u003e {}\n        }\n    }\n\n    normalized = result;\n\n    // Remove trailing hyphens only (like TypeScript's .replace(/-+$/, \"\"))\n    // NOTE: Do NOT remove trailing digits - TypeScript keeps them\n    normalized = normalized.trim_end_matches('-').to_string();\n\n    // Convert to lowercase (like TypeScript's .toLowerCase())\n    normalized = normalized.to_lowercase();\n\n    // Replace dots with hyphens (like TypeScript's .replace(/\\./g, \"-\"))\n    normalized = normalized.replace('.', \"-\");\n\n    // Collapse multiple consecutive hyphens into one (like TypeScript's .replace(/-+/g, \"-\"))\n    let mut collapsed = String::new();\n    let mut last_was_hyphen = false;\n    for ch in normalized.chars() {\n        if ch == '-' {\n            if !last_was_hyphen {\n                collapsed.push(ch);\n            }\n            last_was_hyphen = true;\n        } else {\n            collapsed.push(ch);\n            last_was_hyphen = false;\n        }\n    }\n\n    collapsed\n}\n\nfn get_provider_from_model(model: \u0026str) -\u003e \u0026'static str {\n    let lower = model.to_lowercase();\n\n    if lower.contains(\"claude\")\n        || lower.contains(\"anthropic\")\n        || lower.contains(\"opus\")\n        || lower.contains(\"sonnet\")\n        || lower.contains(\"haiku\")\n    {\n        return \"anthropic\";\n    }\n    if lower.contains(\"gpt\")\n        || lower.contains(\"openai\")\n        || lower.contains(\"o1\")\n        || lower.contains(\"o3\")\n    {\n        return \"openai\";\n    }\n    if lower.contains(\"gemini\") || lower.contains(\"google\") {\n        return \"google\";\n    }\n    if lower.contains(\"grok\") {\n        return \"xai\";\n    }\n\n    \"unknown\"\n}\n\n/// Get default model name based on provider when model field is missing\nfn get_default_model_from_provider(provider: \u0026str) -\u003e String {\n    match provider.to_lowercase().as_str() {\n        \"anthropic\" =\u003e \"claude-unknown\".to_string(),\n        \"openai\" =\u003e \"gpt-unknown\".to_string(),\n        \"google\" =\u003e \"gemini-unknown\".to_string(),\n        \"xai\" =\u003e \"grok-unknown\".to_string(),\n        _ =\u003e format!(\"{}-unknown\", provider),\n    }\n}\n\n/// Try to extract model name from JSONL file's system-reminder\n/// Looks for pattern: \"Model: Claude Opus 4.5 Thinking [Anthropic]\"\nfn extract_model_from_jsonl(jsonl_path: \u0026Path) -\u003e Option\u003cString\u003e {\n    let file = std::fs::File::open(jsonl_path).ok()?;\n    let reader = BufReader::new(file);\n\n    // Scan more lines for parity with TypeScript which reads entire file\n    // Cap at 500 lines to avoid performance issues with very large files\n    for line in reader.lines().take(500) {\n        let line = line.ok()?;\n        // Look for Model: pattern in system-reminder\n        if let Some(pos) = line.find(\"Model:\") {\n            let after_model = \u0026line[pos + 6..];\n            // Extract until [ or end of string/newline\n            let model_part: String = after_model\n                .chars()\n                .take_while(|\u0026c| c != '[' \u0026\u0026 c != '\\\\' \u0026\u0026 c != '\"')\n                .collect();\n            let model_name = model_part.trim();\n            if !model_name.is_empty() {\n                return Some(normalize_model_name(model_name));\n            }\n        }\n    }\n\n    None\n}\n\n/// Parse a Droid settings.json file\npub fn parse_droid_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let data = match std::fs::read(path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data;\n    let settings: DroidSettingsJson = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(s) =\u003e s,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    // Skip if no token usage data\n    let usage = match settings.token_usage {\n        Some(u) =\u003e u,\n        None =\u003e return Vec::new(),\n    };\n\n    // Calculate total tokens to check if any were used\n    let total_tokens = usage.input_tokens.unwrap_or(0)\n        + usage.output_tokens.unwrap_or(0)\n        + usage.cache_creation_tokens.unwrap_or(0)\n        + usage.cache_read_tokens.unwrap_or(0)\n        + usage.thinking_tokens.unwrap_or(0);\n\n    if total_tokens == 0 {\n        return Vec::new();\n    }\n\n    // Extract session ID from filename (e.g., \"uuid.settings.json\" -\u003e \"uuid\")\n    let session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string()\n        .replace(\".settings\", \"\");\n\n    // Get model and provider\n    let provider = settings.provider_lock.clone().unwrap_or_else(|| {\n        get_provider_from_model(settings.model.as_deref().unwrap_or(\"\")).to_string()\n    });\n\n    let model = if let Some(m) = settings.model {\n        normalize_model_name(\u0026m)\n    } else {\n        // Try to extract from JSONL file\n        let jsonl_path = path\n            .to_str()\n            .map(|s| s.replace(\".settings.json\", \".jsonl\"))\n            .map(std::path::PathBuf::from);\n\n        if let Some(ref jsonl) = jsonl_path {\n            extract_model_from_jsonl(jsonl)\n                .unwrap_or_else(|| get_default_model_from_provider(\u0026provider))\n        } else {\n            get_default_model_from_provider(\u0026provider)\n        }\n    };\n\n    // Get timestamp from providerLockTimestamp or file mtime\n    let timestamp = settings\n        .provider_lock_timestamp\n        .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n        .map(|dt| dt.timestamp_millis())\n        .or_else(|| {\n            std::fs::metadata(path)\n                .ok()\n                .and_then(|m| m.modified().ok())\n                .map(|t| {\n                    t.duration_since(std::time::UNIX_EPOCH)\n                        .map(|d| d.as_millis() as i64)\n                        .unwrap_or(0)\n                })\n        })\n        .unwrap_or(0);\n\n    if timestamp == 0 {\n        return Vec::new();\n    }\n\n    vec![UnifiedMessage::new(\n        \"droid\",\n        model,\n        provider,\n        session_id,\n        timestamp,\n        TokenBreakdown {\n            input: usage.input_tokens.unwrap_or(0).max(0),\n            output: usage.output_tokens.unwrap_or(0).max(0),\n            cache_read: usage.cache_read_tokens.unwrap_or(0).max(0),\n            cache_write: usage.cache_creation_tokens.unwrap_or(0).max(0),\n            reasoning: usage.thinking_tokens.unwrap_or(0).max(0),\n        },\n        0.0,\n    )]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_normalize_model_name_custom_prefix() {\n        // TypeScript keeps trailing digits: \"claude-opus-4-5-thinking-0\"\n        assert_eq!(\n            normalize_model_name(\"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\"),\n            \"claude-opus-4-5-thinking-0\"\n        );\n    }\n\n    #[test]\n    fn test_normalize_model_name_simple() {\n        // Dots become hyphens: \"gemini-2.5-pro\" -\u003e \"gemini-2-5-pro\"\n        assert_eq!(normalize_model_name(\"gemini-2.5-pro\"), \"gemini-2-5-pro\");\n    }\n\n    #[test]\n    fn test_normalize_model_name_brackets() {\n        // TypeScript keeps trailing digits: \"claude-sonnet-4\"\n        assert_eq!(\n            normalize_model_name(\"Claude-Sonnet-4-[Anthropic]\"),\n            \"claude-sonnet-4\"\n        );\n    }\n\n    #[test]\n    fn test_get_provider_from_model() {\n        assert_eq!(get_provider_from_model(\"claude-3-sonnet\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"opus-4\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"sonnet-4\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"haiku-3\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"gpt-4o\"), \"openai\");\n        assert_eq!(get_provider_from_model(\"o1-preview\"), \"openai\");\n        assert_eq!(get_provider_from_model(\"o3-mini\"), \"openai\");\n        assert_eq!(get_provider_from_model(\"gemini-pro\"), \"google\");\n        assert_eq!(get_provider_from_model(\"grok-2\"), \"xai\");\n        assert_eq!(get_provider_from_model(\"unknown-model\"), \"unknown\");\n    }\n\n    #[test]\n    fn test_get_default_model_from_provider() {\n        assert_eq!(\n            get_default_model_from_provider(\"anthropic\"),\n            \"claude-unknown\"\n        );\n        assert_eq!(get_default_model_from_provider(\"openai\"), \"gpt-unknown\");\n        assert_eq!(get_default_model_from_provider(\"google\"), \"gemini-unknown\");\n        assert_eq!(get_default_model_from_provider(\"xai\"), \"grok-unknown\");\n        assert_eq!(get_default_model_from_provider(\"custom\"), \"custom-unknown\");\n    }\n\n    #[test]\n    fn test_parse_droid_settings_structure() {\n        let json = r#\"{\n            \"model\": \"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\",\n            \"providerLock\": \"anthropic\",\n            \"providerLockTimestamp\": \"2024-12-26T12:00:00Z\",\n            \"tokenUsage\": {\n                \"inputTokens\": 1234,\n                \"outputTokens\": 567,\n                \"cacheCreationTokens\": 89,\n                \"cacheReadTokens\": 12,\n                \"thinkingTokens\": 34\n            }\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let settings: DroidSettingsJson = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(\n            settings.model,\n            Some(\"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\".to_string())\n        );\n        assert_eq!(settings.provider_lock, Some(\"anthropic\".to_string()));\n\n        let usage = settings.token_usage.unwrap();\n        assert_eq!(usage.input_tokens, Some(1234));\n        assert_eq!(usage.output_tokens, Some(567));\n        assert_eq!(usage.cache_creation_tokens, Some(89));\n        assert_eq!(usage.cache_read_tokens, Some(12));\n        assert_eq!(usage.thinking_tokens, Some(34));\n    }\n}\n","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":5}},{"line":43,"address":[],"length":0,"stats":{"Line":25}},{"line":47,"address":[],"length":0,"stats":{"Line":10}},{"line":48,"address":[],"length":0,"stats":{"Line":10}},{"line":50,"address":[],"length":0,"stats":{"Line":132}},{"line":51,"address":[],"length":0,"stats":{"Line":123}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":420}},{"line":55,"address":[],"length":0,"stats":{"Line":18}},{"line":59,"address":[],"length":0,"stats":{"Line":10}},{"line":63,"address":[],"length":0,"stats":{"Line":15}},{"line":66,"address":[],"length":0,"stats":{"Line":10}},{"line":69,"address":[],"length":0,"stats":{"Line":15}},{"line":72,"address":[],"length":0,"stats":{"Line":10}},{"line":73,"address":[],"length":0,"stats":{"Line":10}},{"line":74,"address":[],"length":0,"stats":{"Line":109}},{"line":75,"address":[],"length":0,"stats":{"Line":104}},{"line":76,"address":[],"length":0,"stats":{"Line":37}},{"line":77,"address":[],"length":0,"stats":{"Line":36}},{"line":79,"address":[],"length":0,"stats":{"Line":19}},{"line":81,"address":[],"length":0,"stats":{"Line":255}},{"line":82,"address":[],"length":0,"stats":{"Line":85}},{"line":86,"address":[],"length":0,"stats":{"Line":5}},{"line":89,"address":[],"length":0,"stats":{"Line":10}},{"line":90,"address":[],"length":0,"stats":{"Line":30}},{"line":92,"address":[],"length":0,"stats":{"Line":10}},{"line":93,"address":[],"length":0,"stats":{"Line":9}},{"line":94,"address":[],"length":0,"stats":{"Line":9}},{"line":95,"address":[],"length":0,"stats":{"Line":8}},{"line":96,"address":[],"length":0,"stats":{"Line":7}},{"line":98,"address":[],"length":0,"stats":{"Line":4}},{"line":100,"address":[],"length":0,"stats":{"Line":6}},{"line":101,"address":[],"length":0,"stats":{"Line":5}},{"line":102,"address":[],"length":0,"stats":{"Line":5}},{"line":103,"address":[],"length":0,"stats":{"Line":4}},{"line":105,"address":[],"length":0,"stats":{"Line":3}},{"line":107,"address":[],"length":0,"stats":{"Line":5}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":2}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":5}},{"line":119,"address":[],"length":0,"stats":{"Line":5}},{"line":120,"address":[],"length":0,"stats":{"Line":7}},{"line":121,"address":[],"length":0,"stats":{"Line":6}},{"line":122,"address":[],"length":0,"stats":{"Line":5}},{"line":123,"address":[],"length":0,"stats":{"Line":4}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":158,"address":[],"length":0,"stats":{"Line":4}},{"line":159,"address":[],"length":0,"stats":{"Line":4}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":4}},{"line":164,"address":[],"length":0,"stats":{"Line":6}},{"line":165,"address":[],"length":0,"stats":{"Line":4}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":4}},{"line":171,"address":[],"length":0,"stats":{"Line":4}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":14}},{"line":177,"address":[],"length":0,"stats":{"Line":8}},{"line":178,"address":[],"length":0,"stats":{"Line":6}},{"line":179,"address":[],"length":0,"stats":{"Line":4}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":2}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":4}},{"line":189,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":8}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":6}},{"line":200,"address":[],"length":0,"stats":{"Line":4}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":4}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":8}},{"line":220,"address":[],"length":0,"stats":{"Line":6}},{"line":221,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":4}},{"line":239,"address":[],"length":0,"stats":{"Line":2}},{"line":240,"address":[],"length":0,"stats":{"Line":2}},{"line":241,"address":[],"length":0,"stats":{"Line":2}},{"line":242,"address":[],"length":0,"stats":{"Line":2}},{"line":243,"address":[],"length":0,"stats":{"Line":2}},{"line":244,"address":[],"length":0,"stats":{"Line":8}},{"line":245,"address":[],"length":0,"stats":{"Line":8}},{"line":246,"address":[],"length":0,"stats":{"Line":8}},{"line":247,"address":[],"length":0,"stats":{"Line":8}},{"line":248,"address":[],"length":0,"stats":{"Line":4}}],"covered":85,"coverable":118},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","gemini.rs"],"content":"//! Gemini CLI session parser\n//!\n//! Parses JSON session files from ~/.gemini/tmp/*/chats/session-*.json\n\nuse super::utils::{\n    extract_i64, extract_string, file_modified_timestamp_ms, parse_timestamp_value,\n};\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse serde_json::Value;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Gemini session structure\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GeminiSession {\n    #[serde(rename = \"sessionId\")]\n    pub session_id: String,\n    #[serde(rename = \"projectHash\")]\n    pub project_hash: String,\n    #[serde(rename = \"startTime\")]\n    pub start_time: String,\n    #[serde(rename = \"lastUpdated\")]\n    pub last_updated: String,\n    pub messages: Vec\u003cGeminiMessage\u003e,\n}\n\n/// Gemini message structure\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GeminiMessage {\n    pub id: String,\n    pub timestamp: Option\u003cString\u003e,\n    #[serde(rename = \"type\")]\n    pub message_type: String,\n    pub content: Option\u003cString\u003e,\n    pub tokens: Option\u003cGeminiTokens\u003e,\n    pub model: Option\u003cString\u003e,\n}\n\n/// Gemini token structure\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GeminiTokens {\n    pub input: Option\u003ci64\u003e,\n    pub output: Option\u003ci64\u003e,\n    pub cached: Option\u003ci64\u003e,\n    pub thoughts: Option\u003ci64\u003e,\n    pub tool: Option\u003ci64\u003e,\n    pub total: Option\u003ci64\u003e,\n}\n\n/// Parse a Gemini session file\npub fn parse_gemini_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    if path.extension().and_then(|s| s.to_str()) == Some(\"jsonl\") {\n        return parse_gemini_headless_jsonl(path, fallback_timestamp);\n    }\n\n    let data = match std::fs::read(path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data.clone();\n    if let Ok(session) = simd_json::from_slice::\u003cGeminiSession\u003e(\u0026mut bytes) {\n        return parse_gemini_session(session, fallback_timestamp);\n    }\n\n    let mut bytes = data;\n    if let Ok(value) = simd_json::from_slice::\u003cValue\u003e(\u0026mut bytes) {\n        let session_id = path\n            .file_stem()\n            .and_then(|s| s.to_str())\n            .unwrap_or(\"unknown\")\n            .to_string();\n        let messages = parse_gemini_headless_value(\u0026value, \u0026session_id, fallback_timestamp);\n        if !messages.is_empty() {\n            return messages;\n        }\n    }\n\n    parse_gemini_headless_jsonl(path, fallback_timestamp)\n}\n\nfn parse_gemini_session(session: GeminiSession, fallback_timestamp: i64) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let mut messages = Vec::new();\n    let session_id = session.session_id.clone();\n\n    for msg in session.messages {\n        // Only process gemini messages with token data\n        if msg.message_type != \"gemini\" {\n            continue;\n        }\n\n        let tokens = match msg.tokens {\n            Some(t) =\u003e t,\n            None =\u003e continue,\n        };\n\n        let model = match msg.model {\n            Some(m) =\u003e m,\n            None =\u003e continue,\n        };\n\n        let timestamp = msg\n            .timestamp\n            .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n            .map(|dt| dt.timestamp_millis())\n            .unwrap_or(fallback_timestamp);\n\n        messages.push(UnifiedMessage::new(\n            \"gemini\",\n            model,\n            \"google\",\n            session_id.clone(),\n            timestamp,\n            TokenBreakdown {\n                input: tokens.input.unwrap_or(0).max(0),\n                output: tokens.output.unwrap_or(0).max(0),\n                cache_read: tokens.cached.unwrap_or(0).max(0),\n                cache_write: 0,\n                reasoning: tokens.thoughts.unwrap_or(0).max(0),\n            },\n            0.0,\n        ));\n    }\n\n    messages\n}\n\nfn parse_gemini_headless_jsonl(path: \u0026Path, fallback_timestamp: i64) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string();\n    let mut current_model: Option\u003cString\u003e = None;\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        let value: Value = match simd_json::from_slice(\u0026mut bytes) {\n            Ok(v) =\u003e v,\n            Err(_) =\u003e continue,\n        };\n\n        let event_type = value.get(\"type\").and_then(|val| val.as_str()).unwrap_or(\"\");\n        if event_type == \"init\" {\n            if let Some(model) = extract_string(value.get(\"model\")) {\n                current_model = Some(model);\n            }\n            if let Some(id) =\n                extract_string(value.get(\"session_id\").or_else(|| value.get(\"sessionId\")))\n            {\n                session_id = id;\n            }\n            continue;\n        }\n\n        let stats = value\n            .get(\"stats\")\n            .or_else(|| value.get(\"result\").and_then(|result| result.get(\"stats\")));\n        if let Some(stats) = stats {\n            let timestamp = extract_timestamp_from_value(\u0026value).unwrap_or(fallback_timestamp);\n            messages.extend(build_messages_from_stats(\n                stats,\n                current_model.clone(),\n                \u0026session_id,\n                timestamp,\n            ));\n        }\n    }\n\n    messages\n}\n\nfn parse_gemini_headless_value(\n    value: \u0026Value,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let stats = match value\n        .get(\"stats\")\n        .or_else(|| value.get(\"result\").and_then(|result| result.get(\"stats\")))\n    {\n        Some(s) =\u003e s,\n        None =\u003e return Vec::new(),\n    };\n\n    let model_hint = extract_string(value.get(\"model\"));\n    let timestamp = extract_timestamp_from_value(value).unwrap_or(fallback_timestamp);\n\n    build_messages_from_stats(stats, model_hint, session_id, timestamp)\n}\n\nfn build_messages_from_stats(\n    stats: \u0026Value,\n    model_hint: Option\u003cString\u003e,\n    session_id: \u0026str,\n    timestamp: i64,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let usages = extract_gemini_usages(stats, model_hint);\n    usages\n        .into_iter()\n        .map(|usage| {\n            UnifiedMessage::new(\n                \"gemini\",\n                usage.model,\n                \"google\",\n                session_id.to_string(),\n                timestamp,\n                TokenBreakdown {\n                    input: usage.input.max(0),\n                    output: usage.output.max(0),\n                    cache_read: usage.cached.max(0),\n                    cache_write: 0,\n                    reasoning: usage.reasoning.max(0),\n                },\n                0.0,\n            )\n        })\n        .collect()\n}\n\nstruct GeminiHeadlessUsage {\n    model: String,\n    input: i64,\n    output: i64,\n    cached: i64,\n    reasoning: i64,\n}\n\nfn extract_gemini_usages(stats: \u0026Value, model_hint: Option\u003cString\u003e) -\u003e Vec\u003cGeminiHeadlessUsage\u003e {\n    if let Some(models) = stats.get(\"models\").and_then(|val| val.as_object()) {\n        let mut usages = Vec::new();\n        for (model, data) in models {\n            let tokens = match data.get(\"tokens\") {\n                Some(t) =\u003e t,\n                None =\u003e continue,\n            };\n            let input = extract_i64(tokens.get(\"prompt\"))\n                .or_else(|| extract_i64(tokens.get(\"input\")))\n                .or_else(|| extract_i64(tokens.get(\"input_tokens\")))\n                .unwrap_or(0);\n            let output = extract_i64(tokens.get(\"candidates\"))\n                .or_else(|| extract_i64(tokens.get(\"output\")))\n                .or_else(|| extract_i64(tokens.get(\"output_tokens\")))\n                .unwrap_or(0);\n            let cached = extract_i64(tokens.get(\"cached\"))\n                .or_else(|| extract_i64(tokens.get(\"cached_tokens\")))\n                .unwrap_or(0);\n            let reasoning = extract_i64(tokens.get(\"thoughts\"))\n                .or_else(|| extract_i64(tokens.get(\"reasoning\")))\n                .unwrap_or(0);\n\n            if input == 0 \u0026\u0026 output == 0 \u0026\u0026 cached == 0 \u0026\u0026 reasoning == 0 {\n                continue;\n            }\n\n            usages.push(GeminiHeadlessUsage {\n                model: model.clone(),\n                input,\n                output,\n                cached,\n                reasoning,\n            });\n        }\n\n        if !usages.is_empty() {\n            return usages;\n        }\n    }\n\n    let input = extract_i64(stats.get(\"input_tokens\"))\n        .or_else(|| extract_i64(stats.get(\"prompt_tokens\")))\n        .unwrap_or(0);\n    let output = extract_i64(stats.get(\"output_tokens\"))\n        .or_else(|| extract_i64(stats.get(\"candidates_tokens\")))\n        .unwrap_or(0);\n    let cached = extract_i64(stats.get(\"cached_tokens\")).unwrap_or(0);\n    let reasoning = extract_i64(stats.get(\"thoughts_tokens\"))\n        .or_else(|| extract_i64(stats.get(\"reasoning_tokens\")))\n        .unwrap_or(0);\n\n    if input == 0 \u0026\u0026 output == 0 \u0026\u0026 cached == 0 \u0026\u0026 reasoning == 0 {\n        return Vec::new();\n    }\n\n    vec![GeminiHeadlessUsage {\n        model: model_hint.unwrap_or_else(|| \"unknown\".to_string()),\n        input,\n        output,\n        cached,\n        reasoning,\n    }]\n}\n\nfn extract_timestamp_from_value(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    value\n        .get(\"timestamp\")\n        .or_else(|| value.get(\"created_at\"))\n        .and_then(parse_timestamp_value)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n\n    #[test]\n    fn test_parse_gemini_structure() {\n        let json = r#\"{\n            \"sessionId\": \"ses_123\",\n            \"projectHash\": \"abc123\",\n            \"startTime\": \"2025-06-15T12:00:00Z\",\n            \"lastUpdated\": \"2025-06-15T12:30:00Z\",\n            \"messages\": [\n                {\n                    \"id\": \"msg_1\",\n                    \"timestamp\": \"2025-06-15T12:00:00Z\",\n                    \"type\": \"user\",\n                    \"content\": \"Hello\"\n                },\n                {\n                    \"id\": \"msg_2\",\n                    \"timestamp\": \"2025-06-15T12:01:00Z\",\n                    \"type\": \"gemini\",\n                    \"content\": \"Hi there!\",\n                    \"model\": \"gemini-2.0-flash\",\n                    \"tokens\": {\n                        \"input\": 10,\n                        \"output\": 20,\n                        \"cached\": 5,\n                        \"thoughts\": 0,\n                        \"tool\": 0,\n                        \"total\": 35\n                    }\n                }\n            ]\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let session: GeminiSession = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(session.messages.len(), 2);\n        assert_eq!(\n            session.messages[1].model,\n            Some(\"gemini-2.0-flash\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_parse_headless_json() {\n        let json = r#\"{\"response\":\"Hi\",\"stats\":{\"models\":{\"gemini-2.5-pro\":{\"tokens\":{\"prompt\":12,\"candidates\":34,\"cached\":5,\"thoughts\":2}}}}}\"#;\n        let file = tempfile::Builder::new().suffix(\".json\").tempfile().unwrap();\n        std::fs::write(file.path(), json).unwrap();\n\n        let messages = parse_gemini_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gemini-2.5-pro\");\n        assert_eq!(messages[0].tokens.input, 12);\n        assert_eq!(messages[0].tokens.output, 34);\n        assert_eq!(messages[0].tokens.cache_read, 5);\n        assert_eq!(messages[0].tokens.reasoning, 2);\n    }\n\n    #[test]\n    fn test_parse_headless_stream_jsonl() {\n        let content = r#\"{\"type\":\"init\",\"model\":\"gemini-2.5-pro\",\"session_id\":\"session-1\"}\n{\"type\":\"result\",\"stats\":{\"input_tokens\":10,\"output_tokens\":20}}\"#;\n        let mut file = tempfile::Builder::new()\n            .suffix(\".jsonl\")\n            .tempfile()\n            .unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n\n        let messages = parse_gemini_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gemini-2.5-pro\");\n        assert_eq!(messages[0].tokens.input, 10);\n        assert_eq!(messages[0].tokens.output, 20);\n    }\n}\n","traces":[{"line":56,"address":[],"length":0,"stats":{"Line":26}},{"line":57,"address":[],"length":0,"stats":{"Line":78}},{"line":59,"address":[],"length":0,"stats":{"Line":156}},{"line":60,"address":[],"length":0,"stats":{"Line":3}},{"line":63,"address":[],"length":0,"stats":{"Line":50}},{"line":64,"address":[],"length":0,"stats":{"Line":50}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":75}},{"line":69,"address":[],"length":0,"stats":{"Line":49}},{"line":70,"address":[],"length":0,"stats":{"Line":72}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":3}},{"line":80,"address":[],"length":0,"stats":{"Line":5}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":24}},{"line":90,"address":[],"length":0,"stats":{"Line":48}},{"line":91,"address":[],"length":0,"stats":{"Line":72}},{"line":93,"address":[],"length":0,"stats":{"Line":760}},{"line":95,"address":[],"length":0,"stats":{"Line":736}},{"line":96,"address":[],"length":0,"stats":{"Line":166}},{"line":99,"address":[],"length":0,"stats":{"Line":1140}},{"line":100,"address":[],"length":0,"stats":{"Line":1140}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":1140}},{"line":105,"address":[],"length":0,"stats":{"Line":1140}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":1140}},{"line":110,"address":[],"length":0,"stats":{"Line":570}},{"line":111,"address":[],"length":0,"stats":{"Line":2280}},{"line":112,"address":[],"length":0,"stats":{"Line":1710}},{"line":113,"address":[],"length":0,"stats":{"Line":1140}},{"line":115,"address":[],"length":0,"stats":{"Line":1710}},{"line":117,"address":[],"length":0,"stats":{"Line":570}},{"line":119,"address":[],"length":0,"stats":{"Line":1140}},{"line":120,"address":[],"length":0,"stats":{"Line":570}},{"line":121,"address":[],"length":0,"stats":{"Line":570}},{"line":122,"address":[],"length":0,"stats":{"Line":2280}},{"line":123,"address":[],"length":0,"stats":{"Line":2280}},{"line":124,"address":[],"length":0,"stats":{"Line":2280}},{"line":125,"address":[],"length":0,"stats":{"Line":570}},{"line":126,"address":[],"length":0,"stats":{"Line":1140}},{"line":132,"address":[],"length":0,"stats":{"Line":24}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":143,"address":[],"length":0,"stats":{"Line":3}},{"line":146,"address":[],"length":0,"stats":{"Line":3}},{"line":147,"address":[],"length":0,"stats":{"Line":3}},{"line":148,"address":[],"length":0,"stats":{"Line":2}},{"line":150,"address":[],"length":0,"stats":{"Line":4}},{"line":151,"address":[],"length":0,"stats":{"Line":4}},{"line":152,"address":[],"length":0,"stats":{"Line":4}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":4}},{"line":157,"address":[],"length":0,"stats":{"Line":4}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":6}},{"line":162,"address":[],"length":0,"stats":{"Line":6}},{"line":163,"address":[],"length":0,"stats":{"Line":4}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":16}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":4}},{"line":170,"address":[],"length":0,"stats":{"Line":1}},{"line":172,"address":[],"length":0,"stats":{"Line":1}},{"line":173,"address":[],"length":0,"stats":{"Line":4}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":3}},{"line":184,"address":[],"length":0,"stats":{"Line":6}},{"line":185,"address":[],"length":0,"stats":{"Line":4}},{"line":186,"address":[],"length":0,"stats":{"Line":2}},{"line":187,"address":[],"length":0,"stats":{"Line":3}},{"line":188,"address":[],"length":0,"stats":{"Line":1}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":203,"address":[],"length":0,"stats":{"Line":1}},{"line":204,"address":[],"length":0,"stats":{"Line":1}},{"line":206,"address":[],"length":0,"stats":{"Line":2}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":4}},{"line":211,"address":[],"length":0,"stats":{"Line":5}},{"line":213,"address":[],"length":0,"stats":{"Line":5}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":8}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":2}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":4}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":232,"address":[],"length":0,"stats":{"Line":2}},{"line":233,"address":[],"length":0,"stats":{"Line":6}},{"line":234,"address":[],"length":0,"stats":{"Line":6}},{"line":235,"address":[],"length":0,"stats":{"Line":6}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":237,"address":[],"length":0,"stats":{"Line":2}},{"line":253,"address":[],"length":0,"stats":{"Line":2}},{"line":254,"address":[],"length":0,"stats":{"Line":9}},{"line":255,"address":[],"length":0,"stats":{"Line":2}},{"line":256,"address":[],"length":0,"stats":{"Line":3}},{"line":257,"address":[],"length":0,"stats":{"Line":2}},{"line":258,"address":[],"length":0,"stats":{"Line":2}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":4}},{"line":262,"address":[],"length":0,"stats":{"Line":1}},{"line":263,"address":[],"length":0,"stats":{"Line":1}},{"line":265,"address":[],"length":0,"stats":{"Line":4}},{"line":266,"address":[],"length":0,"stats":{"Line":1}},{"line":267,"address":[],"length":0,"stats":{"Line":1}},{"line":269,"address":[],"length":0,"stats":{"Line":4}},{"line":270,"address":[],"length":0,"stats":{"Line":1}},{"line":272,"address":[],"length":0,"stats":{"Line":4}},{"line":273,"address":[],"length":0,"stats":{"Line":1}},{"line":276,"address":[],"length":0,"stats":{"Line":1}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":3}},{"line":281,"address":[],"length":0,"stats":{"Line":3}},{"line":282,"address":[],"length":0,"stats":{"Line":2}},{"line":283,"address":[],"length":0,"stats":{"Line":2}},{"line":284,"address":[],"length":0,"stats":{"Line":1}},{"line":285,"address":[],"length":0,"stats":{"Line":1}},{"line":289,"address":[],"length":0,"stats":{"Line":1}},{"line":290,"address":[],"length":0,"stats":{"Line":1}},{"line":294,"address":[],"length":0,"stats":{"Line":4}},{"line":295,"address":[],"length":0,"stats":{"Line":1}},{"line":297,"address":[],"length":0,"stats":{"Line":4}},{"line":298,"address":[],"length":0,"stats":{"Line":1}},{"line":300,"address":[],"length":0,"stats":{"Line":5}},{"line":301,"address":[],"length":0,"stats":{"Line":4}},{"line":302,"address":[],"length":0,"stats":{"Line":4}},{"line":305,"address":[],"length":0,"stats":{"Line":1}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":1}},{"line":310,"address":[],"length":0,"stats":{"Line":2}},{"line":311,"address":[],"length":0,"stats":{"Line":1}},{"line":312,"address":[],"length":0,"stats":{"Line":1}},{"line":313,"address":[],"length":0,"stats":{"Line":1}},{"line":314,"address":[],"length":0,"stats":{"Line":1}},{"line":318,"address":[],"length":0,"stats":{"Line":2}},{"line":319,"address":[],"length":0,"stats":{"Line":2}},{"line":321,"address":[],"length":0,"stats":{"Line":6}},{"line":322,"address":[],"length":0,"stats":{"Line":2}}],"covered":141,"coverable":153},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","mod.rs"],"content":"//! Session parsers for different AI coding assistant formats\n//!\n//! Each source has its own parser that converts to a unified message format.\n\npub mod amp;\npub mod claudecode;\npub mod codex;\npub mod cursor;\npub mod droid;\npub mod gemini;\npub mod openclaw;\npub mod opencode;\npub mod pi;\npub(crate) mod utils;\n\nuse crate::TokenBreakdown;\n\n#[derive(Debug, Clone)]\npub struct UnifiedMessage {\n    pub source: String,\n    pub model_id: String,\n    pub provider_id: String,\n    pub session_id: String,\n    pub timestamp: i64,\n    pub date: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub agent: Option\u003cString\u003e,\n    pub dedup_key: Option\u003cString\u003e,\n}\n\npub fn normalize_agent_name(agent: \u0026str) -\u003e String {\n    let agent_lower = agent.to_lowercase();\n\n    if agent_lower.contains(\"plan\") {\n        if agent_lower.contains(\"omo\") || agent_lower.contains(\"sisyphus\") {\n            return \"Planner-Sisyphus\".to_string();\n        }\n        return agent.to_string();\n    }\n\n    if agent_lower == \"omo\" || agent_lower == \"sisyphus\" {\n        return \"Sisyphus\".to_string();\n    }\n\n    agent.to_string()\n}\n\nimpl UnifiedMessage {\n    pub fn new(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n    ) -\u003e Self {\n        Self::new_full(\n            source,\n            model_id,\n            provider_id,\n            session_id,\n            timestamp,\n            tokens,\n            cost,\n            None,\n            None,\n        )\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    pub fn new_with_agent(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n        agent: Option\u003cString\u003e,\n    ) -\u003e Self {\n        Self::new_full(\n            source,\n            model_id,\n            provider_id,\n            session_id,\n            timestamp,\n            tokens,\n            cost,\n            agent,\n            None,\n        )\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    pub fn new_with_dedup(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n        dedup_key: Option\u003cString\u003e,\n    ) -\u003e Self {\n        Self::new_full(\n            source,\n            model_id,\n            provider_id,\n            session_id,\n            timestamp,\n            tokens,\n            cost,\n            None,\n            dedup_key,\n        )\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    fn new_full(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n        agent: Option\u003cString\u003e,\n        dedup_key: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let date = timestamp_to_date(timestamp);\n        Self {\n            source: source.into(),\n            model_id: model_id.into(),\n            provider_id: provider_id.into(),\n            session_id: session_id.into(),\n            timestamp,\n            date,\n            tokens,\n            cost,\n            agent,\n            dedup_key,\n        }\n    }\n}\n\n/// Convert Unix milliseconds timestamp to YYYY-MM-DD date string\nfn timestamp_to_date(timestamp_ms: i64) -\u003e String {\n    use chrono::{TimeZone, Utc};\n\n    let datetime = Utc.timestamp_millis_opt(timestamp_ms);\n    match datetime {\n        chrono::LocalResult::Single(dt) =\u003e dt.format(\"%Y-%m-%d\").to_string(),\n        _ =\u003e String::new(),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_timestamp_to_date() {\n        // 2025-06-16 12:00:00 UTC (1750075200 seconds since epoch)\n        let ts = 1750075200000_i64;\n        let date = timestamp_to_date(ts);\n        assert_eq!(date, \"2025-06-16\");\n    }\n\n    #[test]\n    fn test_timestamp_to_date_epoch() {\n        // Unix epoch: 1970-01-01\n        let ts = 0_i64;\n        let date = timestamp_to_date(ts);\n        assert_eq!(date, \"1970-01-01\");\n    }\n\n    #[test]\n    fn test_timestamp_to_date_recent() {\n        // 2024-12-01 00:00:00 UTC\n        let ts = 1733011200000_i64;\n        let date = timestamp_to_date(ts);\n        assert_eq!(date, \"2024-12-01\");\n    }\n\n    #[test]\n    fn test_unified_message_creation() {\n        let tokens = TokenBreakdown {\n            input: 100,\n            output: 50,\n            cache_read: 0,\n            cache_write: 0,\n            reasoning: 0,\n        };\n\n        let msg = UnifiedMessage::new(\n            \"opencode\",\n            \"claude-3-5-sonnet\",\n            \"anthropic\",\n            \"test-session-id\",\n            1733011200000,\n            tokens,\n            0.05,\n        );\n\n        assert_eq!(msg.source, \"opencode\");\n        assert_eq!(msg.model_id, \"claude-3-5-sonnet\");\n        assert_eq!(msg.session_id, \"test-session-id\");\n        assert_eq!(msg.date, \"2024-12-01\");\n        assert_eq!(msg.cost, 0.05);\n        assert_eq!(msg.agent, None);\n    }\n\n    #[test]\n    fn test_normalize_agent_name() {\n        assert_eq!(normalize_agent_name(\"OmO\"), \"Sisyphus\");\n        assert_eq!(normalize_agent_name(\"Sisyphus\"), \"Sisyphus\");\n        assert_eq!(normalize_agent_name(\"omo\"), \"Sisyphus\");\n        assert_eq!(normalize_agent_name(\"sisyphus\"), \"Sisyphus\");\n\n        assert_eq!(normalize_agent_name(\"OmO-Plan\"), \"Planner-Sisyphus\");\n        assert_eq!(normalize_agent_name(\"Planner-Sisyphus\"), \"Planner-Sisyphus\");\n        assert_eq!(normalize_agent_name(\"omo-plan\"), \"Planner-Sisyphus\");\n\n        assert_eq!(normalize_agent_name(\"explore\"), \"explore\");\n        assert_eq!(normalize_agent_name(\"CustomAgent\"), \"CustomAgent\");\n    }\n}\n","traces":[{"line":32,"address":[],"length":0,"stats":{"Line":446517}},{"line":33,"address":[],"length":0,"stats":{"Line":1339551}},{"line":35,"address":[],"length":0,"stats":{"Line":446517}},{"line":36,"address":[],"length":0,"stats":{"Line":8100}},{"line":37,"address":[],"length":0,"stats":{"Line":510}},{"line":39,"address":[],"length":0,"stats":{"Line":7620}},{"line":42,"address":[],"length":0,"stats":{"Line":874490}},{"line":43,"address":[],"length":0,"stats":{"Line":201656}},{"line":46,"address":[],"length":0,"stats":{"Line":683248}},{"line":50,"address":[],"length":0,"stats":{"Line":13428}},{"line":60,"address":[],"length":0,"stats":{"Line":13428}},{"line":61,"address":[],"length":0,"stats":{"Line":13428}},{"line":62,"address":[],"length":0,"stats":{"Line":13428}},{"line":63,"address":[],"length":0,"stats":{"Line":13428}},{"line":64,"address":[],"length":0,"stats":{"Line":13428}},{"line":65,"address":[],"length":0,"stats":{"Line":13428}},{"line":66,"address":[],"length":0,"stats":{"Line":13428}},{"line":67,"address":[],"length":0,"stats":{"Line":13428}},{"line":68,"address":[],"length":0,"stats":{"Line":13428}},{"line":73,"address":[],"length":0,"stats":{"Line":446526}},{"line":84,"address":[],"length":0,"stats":{"Line":446526}},{"line":85,"address":[],"length":0,"stats":{"Line":446526}},{"line":86,"address":[],"length":0,"stats":{"Line":446526}},{"line":87,"address":[],"length":0,"stats":{"Line":446526}},{"line":88,"address":[],"length":0,"stats":{"Line":446526}},{"line":89,"address":[],"length":0,"stats":{"Line":446526}},{"line":90,"address":[],"length":0,"stats":{"Line":446526}},{"line":91,"address":[],"length":0,"stats":{"Line":446526}},{"line":92,"address":[],"length":0,"stats":{"Line":446526}},{"line":97,"address":[],"length":0,"stats":{"Line":31382}},{"line":108,"address":[],"length":0,"stats":{"Line":31382}},{"line":109,"address":[],"length":0,"stats":{"Line":31382}},{"line":110,"address":[],"length":0,"stats":{"Line":31382}},{"line":111,"address":[],"length":0,"stats":{"Line":31382}},{"line":112,"address":[],"length":0,"stats":{"Line":31382}},{"line":113,"address":[],"length":0,"stats":{"Line":31382}},{"line":114,"address":[],"length":0,"stats":{"Line":31382}},{"line":115,"address":[],"length":0,"stats":{"Line":31382}},{"line":116,"address":[],"length":0,"stats":{"Line":31382}},{"line":121,"address":[],"length":0,"stats":{"Line":491336}},{"line":132,"address":[],"length":0,"stats":{"Line":1474008}},{"line":134,"address":[],"length":0,"stats":{"Line":1474008}},{"line":135,"address":[],"length":0,"stats":{"Line":1474008}},{"line":136,"address":[],"length":0,"stats":{"Line":1474008}},{"line":137,"address":[],"length":0,"stats":{"Line":1474008}},{"line":149,"address":[],"length":0,"stats":{"Line":491339}},{"line":152,"address":[],"length":0,"stats":{"Line":1965356}},{"line":153,"address":[],"length":0,"stats":{"Line":491339}},{"line":154,"address":[],"length":0,"stats":{"Line":1965356}},{"line":155,"address":[],"length":0,"stats":{"Line":0}}],"covered":49,"coverable":50},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","openclaw.rs"],"content":"//! OpenClaw session parser\n//!\n//! Parses JSONL files from ~/.openclaw/ or ~/.clawdbot/\n//! Uses sessions.json index to find actual session file paths\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::collections::HashMap;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n#[derive(Debug, Deserialize)]\nstruct SessionIndex {\n    #[serde(flatten)]\n    sessions: HashMap\u003cString, SessionEntry\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct SessionEntry {\n    #[serde(rename = \"sessionId\")]\n    session_id: String,\n    #[serde(rename = \"sessionFile\")]\n    session_file: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawEntry {\n    #[serde(rename = \"type\")]\n    entry_type: String,\n    message: Option\u003cOpenClawMessage\u003e,\n    #[serde(rename = \"modelId\")]\n    model_id: Option\u003cString\u003e,\n    provider: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawMessage {\n    role: Option\u003cString\u003e,\n    usage: Option\u003cOpenClawUsage\u003e,\n    timestamp: Option\u003ci64\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawUsage {\n    input: Option\u003ci64\u003e,\n    output: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheRead\")]\n    cache_read: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheWrite\")]\n    cache_write: Option\u003ci64\u003e,\n    #[serde(rename = \"totalTokens\")]\n    #[allow(dead_code)]\n    total_tokens: Option\u003ci64\u003e,\n    cost: Option\u003cOpenClawCost\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawCost {\n    total: Option\u003cf64\u003e,\n}\n\npub fn parse_openclaw_index(index_path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let data = match std::fs::read(index_path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data;\n    let index: SessionIndex = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(i) =\u003e i,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut all_messages = Vec::new();\n\n    for (_key, entry) in index.sessions {\n        if let Some(session_file) = entry.session_file {\n            let session_path = Path::new(\u0026session_file);\n            if session_path.exists() {\n                let messages = parse_openclaw_session(session_path, \u0026entry.session_id);\n                all_messages.extend(messages);\n            }\n        }\n    }\n\n    all_messages\n}\n\nfn parse_openclaw_session(session_path: \u0026Path, session_id: \u0026str) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(session_path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    // Get file modification time as fallback for missing timestamps\n    let file_mtime_ms = std::fs::metadata(session_path)\n        .and_then(|m| m.modified())\n        .ok()\n        .and_then(|t| t.duration_since(std::time::UNIX_EPOCH).ok())\n        .map(|d| d.as_millis() as i64)\n        .unwrap_or(0);\n\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n    let mut current_model: Option\u003cString\u003e = None;\n    let mut current_provider: Option\u003cString\u003e = None;\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        let entry: OpenClawEntry = match simd_json::from_slice(\u0026mut bytes) {\n            Ok(e) =\u003e e,\n            Err(_) =\u003e continue,\n        };\n\n        match entry.entry_type.as_str() {\n            \"model_change\" =\u003e {\n                if let Some(model) = entry.model_id {\n                    current_model = Some(model);\n                }\n                if let Some(provider) = entry.provider {\n                    current_provider = Some(provider);\n                }\n            }\n            \"message\" =\u003e {\n                if let Some(msg) = entry.message {\n                    if msg.role.as_deref() != Some(\"assistant\") {\n                        continue;\n                    }\n\n                    let usage = match msg.usage {\n                        Some(u) =\u003e u,\n                        None =\u003e continue,\n                    };\n\n                    let model = match \u0026current_model {\n                        Some(m) =\u003e m.clone(),\n                        None =\u003e continue,\n                    };\n\n                    let provider = current_provider\n                        .clone()\n                        .unwrap_or_else(|| \"unknown\".to_string());\n                    let timestamp = msg.timestamp.unwrap_or(file_mtime_ms);\n                    let cost = usage.cost.and_then(|c| c.total).unwrap_or(0.0);\n\n                    messages.push(UnifiedMessage::new(\n                        \"openclaw\",\n                        model,\n                        provider,\n                        session_id.to_string(),\n                        timestamp,\n                        TokenBreakdown {\n                            input: usage.input.unwrap_or(0).max(0),\n                            output: usage.output.unwrap_or(0).max(0),\n                            cache_read: usage.cache_read.unwrap_or(0).max(0),\n                            cache_write: usage.cache_write.unwrap_or(0).max(0),\n                            reasoning: 0,\n                        },\n                        cost.max(0.0),\n                    ));\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    messages\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs::File;\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    fn create_test_session(dir: \u0026TempDir, filename: \u0026str, content: \u0026str) -\u003e String {\n        let path = dir.path().join(filename);\n        let mut file = File::create(\u0026path).unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        path.to_string_lossy().to_string()\n    }\n\n    #[test]\n    fn test_parse_openclaw_session_with_model_change() {\n        let dir = TempDir::new().unwrap();\n        let content = r#\"{\"type\":\"model_change\",\"id\":\"abc\",\"provider\":\"openai-codex\",\"modelId\":\"gpt-5.2\"}\n{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":200,\"totalTokens\":350,\"cost\":{\"total\":0.05}},\"timestamp\":1700000000000}}\"#;\n\n        let session_path = create_test_session(\u0026dir, \"session.jsonl\", content);\n        let messages = parse_openclaw_session(Path::new(\u0026session_path), \"test-session\");\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-5.2\");\n        assert_eq!(messages[0].provider_id, \"openai-codex\");\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[0].tokens.output, 50);\n        assert_eq!(messages[0].tokens.cache_read, 200);\n        assert_eq!(messages[0].cost, 0.05);\n    }\n\n    #[test]\n    fn test_parse_openclaw_session_user_messages_ignored() {\n        let dir = TempDir::new().unwrap();\n        let content = r#\"{\"type\":\"model_change\",\"provider\":\"anthropic\",\"modelId\":\"claude-3.5-sonnet\"}\n{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"user\",\"content\":[{\"type\":\"text\",\"text\":\"hello\"}]}}\n{\"type\":\"message\",\"id\":\"msg2\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":50,\"output\":25},\"timestamp\":1700000000000}}\"#;\n\n        let session_path = create_test_session(\u0026dir, \"session.jsonl\", content);\n        let messages = parse_openclaw_session(Path::new(\u0026session_path), \"test-session\");\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].tokens.input, 50);\n    }\n\n    #[test]\n    fn test_parse_openclaw_session_no_model_change() {\n        let dir = TempDir::new().unwrap();\n        let content = r#\"{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":100,\"output\":50},\"timestamp\":1700000000000}}\"#;\n\n        let session_path = create_test_session(\u0026dir, \"session.jsonl\", content);\n        let messages = parse_openclaw_session(Path::new(\u0026session_path), \"test-session\");\n\n        assert_eq!(messages.len(), 0);\n    }\n\n    #[test]\n    fn test_parse_openclaw_index() {\n        let dir = TempDir::new().unwrap();\n\n        let session_content = r#\"{\"type\":\"model_change\",\"provider\":\"anthropic\",\"modelId\":\"claude-3.5-sonnet\"}\n{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":0,\"cacheWrite\":0},\"timestamp\":1700000000000}}\"#;\n        let session_path = create_test_session(\u0026dir, \"session-abc.jsonl\", session_content);\n\n        let index_content = format!(\n            r#\"{{\n            \"agent:main:main\": {{\n                \"sessionId\": \"abc-123\",\n                \"sessionFile\": \"{}\"\n            }}\n        }}\"#,\n            session_path.replace('\\\\', \"\\\\\\\\\")\n        );\n\n        let index_path = dir.path().join(\"sessions.json\");\n        let mut file = File::create(\u0026index_path).unwrap();\n        file.write_all(index_content.as_bytes()).unwrap();\n\n        let messages = parse_openclaw_index(\u0026index_path);\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"claude-3.5-sonnet\");\n        assert_eq!(messages[0].session_id, \"abc-123\");\n    }\n}\n","traces":[{"line":63,"address":[],"length":0,"stats":{"Line":3}},{"line":64,"address":[],"length":0,"stats":{"Line":6}},{"line":65,"address":[],"length":0,"stats":{"Line":6}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":6}},{"line":70,"address":[],"length":0,"stats":{"Line":9}},{"line":71,"address":[],"length":0,"stats":{"Line":6}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":6}},{"line":77,"address":[],"length":0,"stats":{"Line":661}},{"line":78,"address":[],"length":0,"stats":{"Line":656}},{"line":79,"address":[],"length":0,"stats":{"Line":981}},{"line":80,"address":[],"length":0,"stats":{"Line":981}},{"line":81,"address":[],"length":0,"stats":{"Line":1635}},{"line":82,"address":[],"length":0,"stats":{"Line":654}},{"line":87,"address":[],"length":0,"stats":{"Line":3}},{"line":90,"address":[],"length":0,"stats":{"Line":330}},{"line":91,"address":[],"length":0,"stats":{"Line":660}},{"line":92,"address":[],"length":0,"stats":{"Line":660}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":990}},{"line":98,"address":[],"length":0,"stats":{"Line":990}},{"line":100,"address":[],"length":0,"stats":{"Line":1320}},{"line":101,"address":[],"length":0,"stats":{"Line":990}},{"line":104,"address":[],"length":0,"stats":{"Line":990}},{"line":105,"address":[],"length":0,"stats":{"Line":660}},{"line":106,"address":[],"length":0,"stats":{"Line":990}},{"line":107,"address":[],"length":0,"stats":{"Line":990}},{"line":109,"address":[],"length":0,"stats":{"Line":7496}},{"line":110,"address":[],"length":0,"stats":{"Line":13672}},{"line":111,"address":[],"length":0,"stats":{"Line":13672}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":13672}},{"line":116,"address":[],"length":0,"stats":{"Line":13672}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":20508}},{"line":121,"address":[],"length":0,"stats":{"Line":20508}},{"line":122,"address":[],"length":0,"stats":{"Line":13672}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":6836}},{"line":127,"address":[],"length":0,"stats":{"Line":6836}},{"line":128,"address":[],"length":0,"stats":{"Line":243}},{"line":129,"address":[],"length":0,"stats":{"Line":81}},{"line":131,"address":[],"length":0,"stats":{"Line":243}},{"line":132,"address":[],"length":0,"stats":{"Line":81}},{"line":135,"address":[],"length":0,"stats":{"Line":6755}},{"line":136,"address":[],"length":0,"stats":{"Line":11122}},{"line":137,"address":[],"length":0,"stats":{"Line":5561}},{"line":138,"address":[],"length":0,"stats":{"Line":2609}},{"line":141,"address":[],"length":0,"stats":{"Line":5904}},{"line":142,"address":[],"length":0,"stats":{"Line":5904}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":5479}},{"line":147,"address":[],"length":0,"stats":{"Line":7581}},{"line":148,"address":[],"length":0,"stats":{"Line":425}},{"line":151,"address":[],"length":0,"stats":{"Line":5054}},{"line":153,"address":[],"length":0,"stats":{"Line":2527}},{"line":154,"address":[],"length":0,"stats":{"Line":10108}},{"line":155,"address":[],"length":0,"stats":{"Line":10108}},{"line":157,"address":[],"length":0,"stats":{"Line":7581}},{"line":159,"address":[],"length":0,"stats":{"Line":2527}},{"line":160,"address":[],"length":0,"stats":{"Line":2527}},{"line":161,"address":[],"length":0,"stats":{"Line":5054}},{"line":162,"address":[],"length":0,"stats":{"Line":2527}},{"line":163,"address":[],"length":0,"stats":{"Line":2527}},{"line":164,"address":[],"length":0,"stats":{"Line":10108}},{"line":165,"address":[],"length":0,"stats":{"Line":10108}},{"line":166,"address":[],"length":0,"stats":{"Line":10108}},{"line":167,"address":[],"length":0,"stats":{"Line":5054}},{"line":168,"address":[],"length":0,"stats":{"Line":2527}},{"line":170,"address":[],"length":0,"stats":{"Line":5054}},{"line":174,"address":[],"length":0,"stats":{"Line":1194}},{"line":178,"address":[],"length":0,"stats":{"Line":330}}],"covered":66,"coverable":73},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","opencode.rs"],"content":"//! OpenCode session parser\n//!\n//! Parses individual JSON files from ~/.local/share/opencode/storage/message/\n\nuse super::{normalize_agent_name, UnifiedMessage};\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::path::Path;\n\n/// OpenCode message structure (from JSON files)\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct OpenCodeMessage {\n    pub id: String,\n    #[serde(rename = \"sessionID\")]\n    pub session_id: String,\n    pub role: String,\n    #[serde(rename = \"modelID\")]\n    pub model_id: Option\u003cString\u003e,\n    #[serde(rename = \"providerID\")]\n    pub provider_id: Option\u003cString\u003e,\n    pub cost: Option\u003cf64\u003e,\n    pub tokens: Option\u003cOpenCodeTokens\u003e,\n    pub time: OpenCodeTime,\n    pub agent: Option\u003cString\u003e,\n    pub mode: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct OpenCodeTokens {\n    pub input: i64,\n    pub output: i64,\n    pub reasoning: Option\u003ci64\u003e,\n    pub cache: OpenCodeCache,\n}\n\n#[derive(Debug, Deserialize)]\npub struct OpenCodeCache {\n    pub read: i64,\n    pub write: i64,\n}\n\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct OpenCodeTime {\n    pub created: f64, // Unix timestamp in milliseconds (as float)\n    pub completed: Option\u003cf64\u003e,\n}\n\npub fn parse_opencode_file(path: \u0026Path) -\u003e Option\u003cUnifiedMessage\u003e {\n    let data = std::fs::read(path).ok()?;\n    let mut bytes = data;\n\n    let msg: OpenCodeMessage = simd_json::from_slice(\u0026mut bytes).ok()?;\n\n    if msg.role != \"assistant\" {\n        return None;\n    }\n\n    let tokens = msg.tokens?;\n    let model_id = msg.model_id?;\n    let agent_or_mode = msg.mode.or(msg.agent);\n    let agent = agent_or_mode.map(|a| normalize_agent_name(\u0026a));\n\n    Some(UnifiedMessage::new_with_agent(\n        \"opencode\",\n        model_id,\n        msg.provider_id.unwrap_or_else(|| \"unknown\".to_string()),\n        msg.session_id.clone(),\n        msg.time.created as i64,\n        TokenBreakdown {\n            input: tokens.input.max(0),\n            output: tokens.output.max(0),\n            cache_read: tokens.cache.read.max(0),\n            cache_write: tokens.cache.write.max(0),\n            reasoning: tokens.reasoning.unwrap_or(0).max(0),\n        },\n        msg.cost.unwrap_or(0.0).max(0.0),\n        agent,\n    ))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_opencode_structure() {\n        let json = r#\"{\n            \"id\": \"msg_123\",\n            \"sessionID\": \"ses_456\",\n            \"role\": \"assistant\",\n            \"modelID\": \"claude-sonnet-4\",\n            \"providerID\": \"anthropic\",\n            \"cost\": 0.05,\n            \"tokens\": {\n                \"input\": 1000,\n                \"output\": 500,\n                \"reasoning\": 100,\n                \"cache\": { \"read\": 200, \"write\": 50 }\n            },\n            \"time\": { \"created\": 1700000000000.0 }\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let msg: OpenCodeMessage = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(msg.model_id, Some(\"claude-sonnet-4\".to_string()));\n        assert_eq!(msg.tokens.unwrap().input, 1000);\n        assert_eq!(msg.agent, None);\n    }\n\n    #[test]\n    fn test_parse_opencode_with_agent() {\n        let json = r#\"{\n            \"id\": \"msg_123\",\n            \"sessionID\": \"ses_456\",\n            \"role\": \"assistant\",\n            \"modelID\": \"claude-sonnet-4\",\n            \"providerID\": \"anthropic\",\n            \"agent\": \"OmO\",\n            \"cost\": 0.05,\n            \"tokens\": {\n                \"input\": 1000,\n                \"output\": 500,\n                \"reasoning\": 100,\n                \"cache\": { \"read\": 200, \"write\": 50 }\n            },\n            \"time\": { \"created\": 1700000000000.0 }\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let msg: OpenCodeMessage = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(msg.agent, Some(\"OmO\".to_string()));\n    }\n\n    #[test]\n    fn test_negative_values_clamped_to_zero() {\n        use std::io::Write;\n\n        let json = r#\"{\n            \"id\": \"msg_negative\",\n            \"sessionID\": \"ses_negative\",\n            \"role\": \"assistant\",\n            \"modelID\": \"claude-sonnet-4\",\n            \"providerID\": \"anthropic\",\n            \"cost\": -0.05,\n            \"tokens\": {\n                \"input\": -100,\n                \"output\": -50,\n                \"reasoning\": -25,\n                \"cache\": { \"read\": -200, \"write\": -10 }\n            },\n            \"time\": { \"created\": 1700000000000.0 }\n        }\"#;\n\n        let mut temp_file = tempfile::Builder::new().suffix(\".json\").tempfile().unwrap();\n        temp_file.write_all(json.as_bytes()).unwrap();\n\n        let result = parse_opencode_file(temp_file.path());\n        assert!(result.is_some(), \"Should parse file with negative values\");\n\n        let msg = result.unwrap();\n        assert_eq!(msg.tokens.input, 0, \"Negative input should be clamped to 0\");\n        assert_eq!(\n            msg.tokens.output, 0,\n            \"Negative output should be clamped to 0\"\n        );\n        assert_eq!(\n            msg.tokens.cache_read, 0,\n            \"Negative cache_read should be clamped to 0\"\n        );\n        assert_eq!(\n            msg.tokens.cache_write, 0,\n            \"Negative cache_write should be clamped to 0\"\n        );\n        assert_eq!(\n            msg.tokens.reasoning, 0,\n            \"Negative reasoning should be clamped to 0\"\n        );\n        assert!(\n            msg.cost \u003e= 0.0,\n            \"Negative cost should be clamped to 0.0, got {}\",\n            msg.cost\n        );\n    }\n}\n","traces":[{"line":50,"address":[],"length":0,"stats":{"Line":605891}},{"line":51,"address":[],"length":0,"stats":{"Line":2423564}},{"line":52,"address":[],"length":0,"stats":{"Line":1211782}},{"line":54,"address":[],"length":0,"stats":{"Line":3029449}},{"line":56,"address":[],"length":0,"stats":{"Line":605885}},{"line":57,"address":[],"length":0,"stats":{"Line":159376}},{"line":60,"address":[],"length":0,"stats":{"Line":893018}},{"line":61,"address":[],"length":0,"stats":{"Line":893018}},{"line":62,"address":[],"length":0,"stats":{"Line":1786036}},{"line":63,"address":[],"length":0,"stats":{"Line":2232543}},{"line":65,"address":[],"length":0,"stats":{"Line":446509}},{"line":67,"address":[],"length":0,"stats":{"Line":446509}},{"line":68,"address":[],"length":0,"stats":{"Line":893018}},{"line":69,"address":[],"length":0,"stats":{"Line":893018}},{"line":70,"address":[],"length":0,"stats":{"Line":446509}},{"line":71,"address":[],"length":0,"stats":{"Line":446509}},{"line":72,"address":[],"length":0,"stats":{"Line":1339527}},{"line":73,"address":[],"length":0,"stats":{"Line":1339527}},{"line":74,"address":[],"length":0,"stats":{"Line":1339527}},{"line":75,"address":[],"length":0,"stats":{"Line":1339527}},{"line":76,"address":[],"length":0,"stats":{"Line":893018}},{"line":78,"address":[],"length":0,"stats":{"Line":1339527}},{"line":79,"address":[],"length":0,"stats":{"Line":446509}}],"covered":23,"coverable":23},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","pi.rs"],"content":"//! Pi (badlogic/pi-mono) session parser\n//!\n//! Parses JSONL files from ~/.pi/agent/sessions/\u003cencoded-cwd\u003e/*.jsonl\n\nuse super::utils::file_modified_timestamp_ms;\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Pi session header (first line of JSONL)\n#[derive(Debug, Deserialize)]\npub struct PiSessionHeader {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    pub id: String,\n    #[allow(dead_code)]\n    pub timestamp: Option\u003cString\u003e,\n    #[allow(dead_code)]\n    pub cwd: Option\u003cString\u003e,\n}\n\n/// Pi session entry (subsequent lines of JSONL)\n#[derive(Debug, Deserialize)]\npub struct PiSessionEntry {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    #[allow(dead_code)]\n    pub id: Option\u003cString\u003e,\n    #[serde(rename = \"parentId\")]\n    #[allow(dead_code)]\n    pub parent_id: Option\u003cString\u003e,\n    pub timestamp: Option\u003cString\u003e,\n    pub message: Option\u003cPiMessage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PiMessage {\n    pub role: Option\u003cString\u003e,\n    pub usage: Option\u003cPiUsage\u003e,\n    pub model: Option\u003cString\u003e,\n    pub provider: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\npub struct PiUsage {\n    pub input: Option\u003ci64\u003e,\n    pub output: Option\u003ci64\u003e,\n    pub cache_read: Option\u003ci64\u003e,\n    pub cache_write: Option\u003ci64\u003e,\n    #[allow(dead_code)]\n    pub total_tokens: Option\u003ci64\u003e,\n}\n\n/// Parse a Pi JSONL session file\npub fn parse_pi_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    let reader = BufReader::new(file);\n    let mut messages: Vec\u003cUnifiedMessage\u003e = Vec::new();\n\n    let mut session_id: Option\u003cString\u003e = None;\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        if session_id.is_none() {\n            let mut bytes = trimmed.as_bytes().to_vec();\n            let header = match simd_json::from_slice::\u003cPiSessionHeader\u003e(\u0026mut bytes) {\n                Ok(h) =\u003e h,\n                Err(_) =\u003e return Vec::new(),\n            };\n\n            if header.entry_type != \"session\" {\n                return Vec::new();\n            }\n            session_id = Some(header.id);\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        let entry = match simd_json::from_slice::\u003cPiSessionEntry\u003e(\u0026mut bytes) {\n            Ok(e) =\u003e e,\n            Err(_) =\u003e continue,\n        };\n\n        if entry.entry_type != \"message\" {\n            continue;\n        }\n\n        let message = match entry.message {\n            Some(m) =\u003e m,\n            None =\u003e continue,\n        };\n\n        if message.role.as_deref() != Some(\"assistant\") {\n            continue;\n        }\n\n        let usage = match message.usage {\n            Some(u) =\u003e u,\n            None =\u003e continue,\n        };\n\n        let model = match message.model {\n            Some(m) =\u003e m,\n            None =\u003e continue,\n        };\n\n        let provider = match message.provider {\n            Some(p) =\u003e p,\n            None =\u003e continue,\n        };\n\n        let timestamp = entry\n            .timestamp\n            .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n            .map(|dt| dt.timestamp_millis())\n            .unwrap_or(fallback_timestamp);\n\n        messages.push(UnifiedMessage::new(\n            \"pi\",\n            model,\n            provider,\n            session_id.clone().unwrap_or_else(|| \"unknown\".to_string()),\n            timestamp,\n            TokenBreakdown {\n                input: usage.input.unwrap_or(0).max(0),\n                output: usage.output.unwrap_or(0).max(0),\n                cache_read: usage.cache_read.unwrap_or(0).max(0),\n                cache_write: usage.cache_write.unwrap_or(0).max(0),\n                reasoning: 0,\n            },\n            0.0,\n        ));\n    }\n\n    messages\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n    use tempfile::NamedTempFile;\n\n    fn create_test_file(content: \u0026str) -\u003e NamedTempFile {\n        let mut file = NamedTempFile::new().unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n        file\n    }\n\n    #[test]\n    fn test_parse_pi_jsonl_valid_assistant_message() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_001\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\n{\"type\":\"message\",\"id\":\"msg_001\",\"parentId\":null,\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"assistant\",\"model\":\"claude-3-5-sonnet\",\"provider\":\"anthropic\",\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":10,\"cacheWrite\":5,\"totalTokens\":165}}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].source, \"pi\");\n        assert_eq!(messages[0].session_id, \"pi_ses_001\");\n        assert_eq!(messages[0].model_id, \"claude-3-5-sonnet\");\n        assert_eq!(messages[0].provider_id, \"anthropic\");\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[0].tokens.output, 50);\n        assert_eq!(messages[0].tokens.cache_read, 10);\n        assert_eq!(messages[0].tokens.cache_write, 5);\n    }\n\n    #[test]\n    fn test_parse_pi_skips_non_assistant_messages() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_002\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\n{\"type\":\"message\",\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"user\",\"model\":\"claude-3-5-sonnet\",\"provider\":\"anthropic\",\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":0,\"cacheWrite\":0,\"totalTokens\":150}}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert!(messages.is_empty());\n    }\n\n    #[test]\n    fn test_parse_pi_skips_missing_usage() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_003\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\n{\"type\":\"message\",\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"assistant\",\"model\":\"claude-3-5-sonnet\",\"provider\":\"anthropic\"}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert!(messages.is_empty());\n    }\n\n    #[test]\n    fn test_parse_pi_skips_malformed_json_lines() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_004\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\nnot valid json\n{\"type\":\"message\",\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"assistant\",\"model\":\"gpt-4o-mini\",\"provider\":\"openai\",\"usage\":{\"input\":10,\"output\":5,\"cacheRead\":0,\"cacheWrite\":0,\"totalTokens\":15}}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-4o-mini\");\n        assert_eq!(messages[0].provider_id, \"openai\");\n    }\n}\n","traces":[{"line":58,"address":[],"length":0,"stats":{"Line":10}},{"line":59,"address":[],"length":0,"stats":{"Line":20}},{"line":60,"address":[],"length":0,"stats":{"Line":20}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":30}},{"line":66,"address":[],"length":0,"stats":{"Line":30}},{"line":67,"address":[],"length":0,"stats":{"Line":30}},{"line":69,"address":[],"length":0,"stats":{"Line":30}},{"line":70,"address":[],"length":0,"stats":{"Line":81}},{"line":71,"address":[],"length":0,"stats":{"Line":122}},{"line":72,"address":[],"length":0,"stats":{"Line":122}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":122}},{"line":77,"address":[],"length":0,"stats":{"Line":122}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":122}},{"line":82,"address":[],"length":0,"stats":{"Line":30}},{"line":83,"address":[],"length":0,"stats":{"Line":20}},{"line":84,"address":[],"length":0,"stats":{"Line":20}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":10}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":20}},{"line":92,"address":[],"length":0,"stats":{"Line":10}},{"line":95,"address":[],"length":0,"stats":{"Line":153}},{"line":96,"address":[],"length":0,"stats":{"Line":101}},{"line":97,"address":[],"length":0,"stats":{"Line":100}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":50}},{"line":102,"address":[],"length":0,"stats":{"Line":10}},{"line":105,"address":[],"length":0,"stats":{"Line":80}},{"line":106,"address":[],"length":0,"stats":{"Line":80}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":40}},{"line":111,"address":[],"length":0,"stats":{"Line":17}},{"line":114,"address":[],"length":0,"stats":{"Line":45}},{"line":115,"address":[],"length":0,"stats":{"Line":44}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":44}},{"line":120,"address":[],"length":0,"stats":{"Line":44}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":44}},{"line":125,"address":[],"length":0,"stats":{"Line":44}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":44}},{"line":130,"address":[],"length":0,"stats":{"Line":22}},{"line":131,"address":[],"length":0,"stats":{"Line":88}},{"line":132,"address":[],"length":0,"stats":{"Line":66}},{"line":133,"address":[],"length":0,"stats":{"Line":44}},{"line":135,"address":[],"length":0,"stats":{"Line":66}},{"line":137,"address":[],"length":0,"stats":{"Line":22}},{"line":138,"address":[],"length":0,"stats":{"Line":22}},{"line":139,"address":[],"length":0,"stats":{"Line":66}},{"line":140,"address":[],"length":0,"stats":{"Line":22}},{"line":141,"address":[],"length":0,"stats":{"Line":22}},{"line":142,"address":[],"length":0,"stats":{"Line":88}},{"line":143,"address":[],"length":0,"stats":{"Line":88}},{"line":144,"address":[],"length":0,"stats":{"Line":88}},{"line":145,"address":[],"length":0,"stats":{"Line":44}},{"line":146,"address":[],"length":0,"stats":{"Line":22}},{"line":152,"address":[],"length":0,"stats":{"Line":10}}],"covered":53,"coverable":61},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","utils.rs"],"content":"//! Shared parsing helpers for session logs.\n\nuse serde_json::Value;\nuse std::path::Path;\nuse std::time::SystemTime;\n\npub(crate) fn extract_i64(value: Option\u003c\u0026Value\u003e) -\u003e Option\u003ci64\u003e {\n    value.and_then(|val| {\n        val.as_i64()\n            .or_else(|| val.as_u64().map(|v| v as i64))\n            .or_else(|| val.as_str().and_then(|s| s.parse::\u003ci64\u003e().ok()))\n    })\n}\n\npub(crate) fn extract_string(value: Option\u003c\u0026Value\u003e) -\u003e Option\u003cString\u003e {\n    value.and_then(|val| val.as_str().map(|s| s.to_string()))\n}\n\npub(crate) fn parse_timestamp_value(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    if let Some(ts) = value.as_str() {\n        return parse_timestamp_str(ts);\n    }\n\n    let numeric = value\n        .as_i64()\n        .or_else(|| value.as_u64().map(|v| v as i64))?;\n    // Heuristic: values \u003e= 1e12 are treated as milliseconds, smaller values as seconds.\n    if numeric \u003e= 1_000_000_000_000 {\n        Some(numeric)\n    } else {\n        Some(numeric * 1000)\n    }\n}\n\npub(crate) fn parse_timestamp_str(value: \u0026str) -\u003e Option\u003ci64\u003e {\n    if let Ok(dt) = chrono::DateTime::parse_from_rfc3339(value) {\n        return Some(dt.timestamp_millis());\n    }\n\n    if let Ok(numeric) = value.parse::\u003ci64\u003e() {\n        if numeric \u003e= 1_000_000_000_000 {\n            return Some(numeric);\n        }\n        return Some(numeric * 1000);\n    }\n\n    None\n}\n\npub(crate) fn file_modified_timestamp_ms(path: \u0026Path) -\u003e i64 {\n    std::fs::metadata(path)\n        .and_then(|meta| meta.modified())\n        .ok()\n        .and_then(|time| time.duration_since(SystemTime::UNIX_EPOCH).ok())\n        .map(|duration| duration.as_millis() as i64)\n        .unwrap_or_else(|| chrono::Utc::now().timestamp_millis())\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":27}},{"line":8,"address":[],"length":0,"stats":{"Line":73}},{"line":9,"address":[],"length":0,"stats":{"Line":38}},{"line":10,"address":[],"length":0,"stats":{"Line":19}},{"line":11,"address":[],"length":0,"stats":{"Line":19}},{"line":15,"address":[],"length":0,"stats":{"Line":157}},{"line":16,"address":[],"length":0,"stats":{"Line":354}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":20,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":1764}},{"line":51,"address":[],"length":0,"stats":{"Line":3528}},{"line":52,"address":[],"length":0,"stats":{"Line":5292}},{"line":54,"address":[],"length":0,"stats":{"Line":7056}},{"line":55,"address":[],"length":0,"stats":{"Line":5292}},{"line":56,"address":[],"length":0,"stats":{"Line":1764}}],"covered":19,"coverable":29},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","ref-cast-1857e63b21a95446","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","ref-cast-7939b7e7acc3e71e","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde-665f6ab63001e214","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde-dde27930001b779e","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde_core-09521bb1b8098d69","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde_core-8eddb0ff265402db","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","thiserror-4d0e29a2b88c31e4","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","thiserror-e309592d4eb83dc1","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","ref-cast-78f9f9ca79b61740","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","ref-cast-eb37870212ac28fd","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde-10a694e452197c04","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde-e3c3562ee00ca109","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde_core-487cb66012287aa7","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde_core-498164a011434064","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","thiserror-65d3345fc07e6d75","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","thiserror-b9b7135a3bfc1f54","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","ref-cast-d880b57f0fb530d4","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","serde-0c575a0a454094dd","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","serde_core-1e62b028c28d8306","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","thiserror-718e39c79d0a4b8a","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","auth.rs"],"content":"use anyhow::{Context, Result};\nuse serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::io::Write;\nuse std::path::PathBuf;\n\nfn home_dir() -\u003e Result\u003cPathBuf\u003e {\n    dirs::home_dir().context(\"Could not determine home directory\")\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Credentials {\n    pub token: String,\n    pub username: String,\n    #[serde(rename = \"avatarUrl\", skip_serializing_if = \"Option::is_none\")]\n    pub avatar_url: Option\u003cString\u003e,\n    #[serde(rename = \"createdAt\")]\n    pub created_at: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct DeviceCodeResponse {\n    #[serde(rename = \"deviceCode\")]\n    device_code: String,\n    #[serde(rename = \"userCode\")]\n    user_code: String,\n    #[serde(rename = \"verificationUrl\")]\n    verification_url: String,\n    #[serde(rename = \"expiresIn\")]\n    #[allow(dead_code)]\n    expires_in: u64,\n    interval: u64,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PollResponse {\n    status: String,\n    token: Option\u003cString\u003e,\n    user: Option\u003cUserInfo\u003e,\n    #[allow(dead_code)]\n    error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct UserInfo {\n    username: String,\n    #[serde(rename = \"avatarUrl\")]\n    avatar_url: Option\u003cString\u003e,\n}\n\nfn get_credentials_path() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".config/tokscale/credentials.json\"))\n}\n\nfn ensure_config_dir() -\u003e Result\u003c()\u003e {\n    let config_dir = home_dir()?.join(\".config/tokscale\");\n\n    if !config_dir.exists() {\n        fs::create_dir_all(\u0026config_dir)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(\u0026config_dir, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n    Ok(())\n}\n\npub fn save_credentials(credentials: \u0026Credentials) -\u003e Result\u003c()\u003e {\n    ensure_config_dir()?;\n    let path = get_credentials_path()?;\n    let json = serde_json::to_string_pretty(credentials)?;\n\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::OpenOptionsExt;\n\n        let mut file = fs::OpenOptions::new()\n            .create(true)\n            .write(true)\n            .truncate(true)\n            .mode(0o600)\n            .open(\u0026path)?;\n        file.write_all(json.as_bytes())?;\n    }\n\n    #[cfg(not(unix))]\n    {\n        fs::write(\u0026path, json)?;\n    }\n\n    Ok(())\n}\n\npub fn load_credentials() -\u003e Option\u003cCredentials\u003e {\n    let path = get_credentials_path().ok()?;\n    if !path.exists() {\n        return None;\n    }\n\n    let content = fs::read_to_string(path).ok()?;\n    serde_json::from_str(\u0026content).ok()\n}\n\npub fn clear_credentials() -\u003e Result\u003cbool\u003e {\n    let path = get_credentials_path()?;\n    if path.exists() {\n        fs::remove_file(path)?;\n        Ok(true)\n    } else {\n        Ok(false)\n    }\n}\n\npub fn get_api_base_url() -\u003e String {\n    std::env::var(\"TOKSCALE_API_URL\").unwrap_or_else(|_| \"https://tokscale.ai\".to_string())\n}\n\nfn get_device_name() -\u003e String {\n    let hostname = hostname::get()\n        .ok()\n        .and_then(|h| h.into_string().ok())\n        .unwrap_or_else(|| \"unknown\".to_string());\n    format!(\"CLI on {}\", hostname)\n}\n\nfn open_browser(url: \u0026str) {\n    #[cfg(target_os = \"macos\")]\n    {\n        let _ = std::process::Command::new(\"open\").arg(url).spawn();\n    }\n\n    #[cfg(target_os = \"windows\")]\n    {\n        let _ = std::process::Command::new(\"cmd\")\n            .args([\"/C\", \"start\", \"\", url])\n            .spawn();\n    }\n\n    #[cfg(target_os = \"linux\")]\n    {\n        let _ = std::process::Command::new(\"xdg-open\").arg(url).spawn();\n    }\n}\n\npub async fn login() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    if let Some(creds) = load_credentials() {\n        println!(\n            \"\\n  {}\",\n            format!(\"Already logged in as {}\", creds.username.bold()).yellow()\n        );\n        println!(\n            \"{}\",\n            \"  Run 'tokscale logout' to sign out first.\\n\".bright_black()\n        );\n        return Ok(());\n    }\n\n    let base_url = get_api_base_url();\n\n    println!(\"\\n  {}\\n\", \"Tokscale - Login\".cyan());\n    println!(\"{}\", \"  Requesting authorization code...\".bright_black());\n\n    let client = reqwest::Client::builder()\n        .timeout(std::time::Duration::from_secs(30))\n        .build()?;\n\n    let device_code_response = client\n        .post(format!(\"{}/api/auth/device\", base_url))\n        .json(\u0026serde_json::json!({\n            \"deviceName\": get_device_name()\n        }))\n        .send()\n        .await?;\n\n    if !device_code_response.status().is_success() {\n        anyhow::bail!(\"Server returned {}\", device_code_response.status());\n    }\n\n    let device_data: DeviceCodeResponse = device_code_response.json().await?;\n\n    println!();\n    println!(\"{}\", \"  Open this URL in your browser:\".white());\n    println!(\"{}\", format!(\"  {}\\n\", device_data.verification_url).cyan());\n    println!(\"{}\", \"  Enter this code:\".white());\n    println!(\n        \"{}\\n\",\n        format!(\"  {}\", device_data.user_code).green().bold()\n    );\n\n    open_browser(\u0026device_data.verification_url);\n\n    println!(\"{}\", \"  Waiting for authorization...\".bright_black());\n\n    let poll_interval = std::time::Duration::from_secs(device_data.interval);\n    let max_attempts = 180;\n\n    for attempt in 0..max_attempts {\n        tokio::time::sleep(poll_interval).await;\n\n        let poll_response = client\n            .post(format!(\"{}/api/auth/device/poll\", base_url))\n            .json(\u0026serde_json::json!({\n                \"deviceCode\": device_data.device_code\n            }))\n            .send()\n            .await;\n\n        match poll_response {\n            Ok(response) =\u003e {\n                if let Ok(data) = response.json::\u003cPollResponse\u003e().await {\n                    if data.status == \"complete\" {\n                        if let (Some(token), Some(user)) = (data.token, data.user) {\n                            let credentials = Credentials {\n                                token,\n                                username: user.username.clone(),\n                                avatar_url: user.avatar_url,\n                                created_at: chrono::Utc::now().to_rfc3339(),\n                            };\n\n                            save_credentials(\u0026credentials)?;\n\n                            println!(\n                                \"\\n  {}\",\n                                format!(\"Success! Logged in as {}\", user.username.bold()).green()\n                            );\n                            println!(\n                                \"{}\",\n                                \"  You can now use 'tokscale submit' to share your usage.\\n\"\n                                    .bright_black()\n                            );\n                            return Ok(());\n                        }\n                    }\n\n                    if data.status == \"expired\" {\n                        anyhow::bail!(\"Authorization code expired. Please try again.\");\n                    }\n\n                    print!(\"{}\", \".\".bright_black());\n                    use std::io::Write;\n                    std::io::stdout().flush()?;\n                }\n            }\n            Err(_) =\u003e {\n                print!(\"{}\", \"!\".red());\n                use std::io::Write;\n                std::io::stdout().flush()?;\n            }\n        }\n\n        if attempt \u003e= max_attempts - 1 {\n            anyhow::bail!(\"Timeout: Authorization took too long. Please try again.\");\n        }\n    }\n\n    Ok(())\n}\n\npub fn logout() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    let credentials = load_credentials();\n\n    let Some(creds) = credentials else {\n        println!(\"\\n  {}\\n\", \"Not logged in.\".yellow());\n        return Ok(());\n    };\n\n    let username = creds.username;\n    let cleared = clear_credentials()?;\n\n    if cleared {\n        println!(\n            \"\\n  {}\\n\",\n            format!(\"Logged out from {}\", username.bold()).green()\n        );\n    } else {\n        anyhow::bail!(\"Failed to clear credentials.\");\n    }\n\n    Ok(())\n}\n\npub fn whoami() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    let Some(creds) = load_credentials() else {\n        println!(\"\\n  {}\", \"Not logged in.\".yellow());\n        println!(\n            \"{}\",\n            \"  Run 'tokscale login' to authenticate.\\n\".bright_black()\n        );\n        return Ok(());\n    };\n\n    println!(\"\\n  {}\\n\", \"Tokscale - Account Info\".cyan());\n    println!(\n        \"{}\",\n        format!(\"  Username:  {}\", creds.username.bold()).white()\n    );\n\n    if let Ok(created) = chrono::DateTime::parse_from_rfc3339(\u0026creds.created_at) {\n        println!(\n            \"{}\",\n            format!(\"  Logged in: {}\", created.format(\"%Y-%m-%d\")).bright_black()\n        );\n    }\n\n    println!();\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serial_test::serial;\n    use std::env;\n    use tempfile::TempDir;\n\n    #[test]\n    fn test_get_api_base_url_default() {\n        unsafe {\n            env::remove_var(\"TOKSCALE_API_URL\");\n        }\n        assert_eq!(get_api_base_url(), \"https://tokscale.ai\");\n    }\n\n    #[test]\n    #[serial]\n    fn test_get_api_base_url_custom() {\n        unsafe {\n            env::set_var(\"TOKSCALE_API_URL\", \"https://custom.api.url\");\n        }\n        assert_eq!(get_api_base_url(), \"https://custom.api.url\");\n        unsafe {\n            env::remove_var(\"TOKSCALE_API_URL\");\n        }\n    }\n\n    #[test]\n    fn test_credentials_serialization() {\n        let creds = Credentials {\n            token: \"test_token_123\".to_string(),\n            username: \"testuser\".to_string(),\n            avatar_url: Some(\"https://example.com/avatar.png\".to_string()),\n            created_at: \"2024-01-01T00:00:00Z\".to_string(),\n        };\n\n        let json = serde_json::to_string(\u0026creds).unwrap();\n        let deserialized: Credentials = serde_json::from_str(\u0026json).unwrap();\n\n        assert_eq!(deserialized.token, creds.token);\n        assert_eq!(deserialized.username, creds.username);\n        assert_eq!(deserialized.avatar_url, creds.avatar_url);\n        assert_eq!(deserialized.created_at, creds.created_at);\n    }\n\n    #[test]\n    fn test_credentials_serialization_without_avatar() {\n        let creds = Credentials {\n            token: \"test_token_456\".to_string(),\n            username: \"testuser2\".to_string(),\n            avatar_url: None,\n            created_at: \"2024-01-02T00:00:00Z\".to_string(),\n        };\n\n        let json = serde_json::to_string(\u0026creds).unwrap();\n        let deserialized: Credentials = serde_json::from_str(\u0026json).unwrap();\n\n        assert_eq!(deserialized.token, creds.token);\n        assert_eq!(deserialized.username, creds.username);\n        assert_eq!(deserialized.avatar_url, None);\n        assert_eq!(deserialized.created_at, creds.created_at);\n\n        assert!(!json.contains(\"avatarUrl\"));\n    }\n\n    #[test]\n    #[serial]\n    fn test_get_credentials_path() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let path = get_credentials_path().unwrap();\n        let expected = temp_dir.path().join(\".config/tokscale/credentials.json\");\n\n        assert_eq!(path, expected);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_save_credentials() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let creds = Credentials {\n            token: \"save_test_token\".to_string(),\n            username: \"saveuser\".to_string(),\n            avatar_url: Some(\"https://example.com/save.png\".to_string()),\n            created_at: \"2024-01-03T00:00:00Z\".to_string(),\n        };\n\n        save_credentials(\u0026creds).unwrap();\n\n        let path = get_credentials_path().unwrap();\n        assert!(path.exists());\n\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let metadata = fs::metadata(\u0026path).unwrap();\n            let permissions = metadata.permissions();\n            assert_eq!(permissions.mode() \u0026 0o777, 0o600);\n        }\n\n        let content = fs::read_to_string(\u0026path).unwrap();\n        let loaded: Credentials = serde_json::from_str(\u0026content).unwrap();\n        assert_eq!(loaded.token, creds.token);\n        assert_eq!(loaded.username, creds.username);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_load_credentials() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let creds = Credentials {\n            token: \"load_test_token\".to_string(),\n            username: \"loaduser\".to_string(),\n            avatar_url: None,\n            created_at: \"2024-01-04T00:00:00Z\".to_string(),\n        };\n\n        save_credentials(\u0026creds).unwrap();\n\n        let loaded = load_credentials().unwrap();\n\n        assert_eq!(loaded.token, creds.token);\n        assert_eq!(loaded.username, creds.username);\n        assert_eq!(loaded.avatar_url, creds.avatar_url);\n        assert_eq!(loaded.created_at, creds.created_at);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_load_credentials_nonexistent() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let loaded = load_credentials();\n        assert!(loaded.is_none());\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_clear_credentials() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let creds = Credentials {\n            token: \"clear_test_token\".to_string(),\n            username: \"clearuser\".to_string(),\n            avatar_url: None,\n            created_at: \"2024-01-05T00:00:00Z\".to_string(),\n        };\n\n        save_credentials(\u0026creds).unwrap();\n        let path = get_credentials_path().unwrap();\n        assert!(path.exists());\n\n        let cleared = clear_credentials().unwrap();\n        assert!(cleared);\n        assert!(!path.exists());\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_clear_credentials_nonexistent() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let cleared = clear_credentials().unwrap();\n        assert!(!cleared);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_ensure_config_dir() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let config_dir = temp_dir.path().join(\".config/tokscale\");\n        assert!(!config_dir.exists());\n\n        ensure_config_dir().unwrap();\n\n        assert!(config_dir.exists());\n\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let metadata = fs::metadata(\u0026config_dir).unwrap();\n            let permissions = metadata.permissions();\n            assert_eq!(permissions.mode() \u0026 0o777, 0o700);\n        }\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n\n    #[test]\n    #[serial]\n    fn test_save_and_load_roundtrip() {\n        let temp_dir = TempDir::new().unwrap();\n        unsafe {\n            env::set_var(\"HOME\", temp_dir.path());\n        }\n\n        let original = Credentials {\n            token: \"roundtrip_token\".to_string(),\n            username: \"roundtripuser\".to_string(),\n            avatar_url: Some(\"https://example.com/roundtrip.png\".to_string()),\n            created_at: \"2024-01-06T12:34:56Z\".to_string(),\n        };\n\n        save_credentials(\u0026original).unwrap();\n        let loaded = load_credentials().unwrap();\n\n        assert_eq!(loaded.token, original.token);\n        assert_eq!(loaded.username, original.username);\n        assert_eq!(loaded.avatar_url, original.avatar_url);\n        assert_eq!(loaded.created_at, original.created_at);\n\n        unsafe {\n            env::remove_var(\"HOME\");\n        }\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":128},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","commands","mod.rs"],"content":"pub mod wrapped;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","commands","wrapped.rs"],"content":"use crate::{auth, cursor};\nuse ab_glyph::{point, Font, FontArc, GlyphId, PxScale, ScaleFont};\nuse anyhow::{Context, Result};\nuse chrono::{Datelike, Duration, Local, NaiveDate, Utc};\nuse colored::Colorize;\nuse image::{imageops::FilterType, Rgba, RgbaImage};\nuse imageproc::drawing::draw_filled_circle_mut;\nuse std::cmp::Ordering;\nuse std::collections::HashMap;\nuse std::fs;\nuse std::path::{Path, PathBuf};\nuse tokio::runtime::Runtime;\nuse tokscale_core::{generate_graph, parse_local_sources, GroupBy, LocalParseOptions, ReportOptions};\n\nconst SCALE: i32 = 2;\nconst IMAGE_WIDTH: i32 = 1200 * SCALE;\nconst IMAGE_HEIGHT: i32 = 1200 * SCALE;\nconst PADDING: i32 = 56 * SCALE;\n\nconst TOKSCALE_LOGO_SVG_URL: \u0026str = \"https://tokscale.ai/tokscale-logo.svg\";\nconst TOKSCALE_LOGO_PNG_SIZE: i32 = 400;\nconst FIGTREE_REGULAR_FILE: \u0026str = \"Figtree-Regular.ttf\";\nconst FIGTREE_REGULAR_URL: \u0026str =\n    \"https://fonts.gstatic.com/s/figtree/v9/_Xmz-HUzqDCFdgfMsYiV_F7wfS-Bs_d_QF5e.ttf\";\nconst FIGTREE_BOLD_FILE: \u0026str = \"Figtree-Bold.ttf\";\nconst FIGTREE_BOLD_URL: \u0026str =\n    \"https://fonts.gstatic.com/s/figtree/v9/_Xmz-HUzqDCFdgfMsYiV_F7wfS-Bs_eYR15e.ttf\";\n\nconst PINNED_AGENTS: [\u0026str; 2] = [\"Sisyphus\", \"Planner-Sisyphus\"];\n\nconst COLOR_BACKGROUND: Rgba\u003cu8\u003e = Rgba([0x10, 0x12, 0x1C, 0xFF]);\nconst COLOR_TEXT_PRIMARY: Rgba\u003cu8\u003e = Rgba([0xFF, 0xFF, 0xFF, 0xFF]);\nconst COLOR_TEXT_SECONDARY: Rgba\u003cu8\u003e = Rgba([0x88, 0x88, 0x88, 0xFF]);\nconst COLOR_GRADE0: Rgba\u003cu8\u003e = Rgba([0x14, 0x1A, 0x25, 0xFF]);\nconst COLOR_GRADE1: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0x44]);\nconst COLOR_GRADE2: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0x88]);\nconst COLOR_GRADE3: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0xCC]);\nconst COLOR_GRADE4: Rgba\u003cu8\u003e = Rgba([0x00, 0xB2, 0xFF, 0xFF]);\nconst COLOR_SISYPHUS: Rgba\u003cu8\u003e = Rgba([0x00, 0xCE, 0xD1, 0xFF]);\n\n#[derive(Debug, Clone)]\npub struct WrappedOptions {\n    pub output: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub short: bool,\n    pub include_agents: bool,\n    pub pin_sisyphus: bool,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedData {\n    year: String,\n    active_days: i32,\n    total_tokens: i64,\n    total_cost: f64,\n    longest_streak: i32,\n    top_models: Vec\u003cWrappedRankedEntry\u003e,\n    top_clients: Vec\u003cWrappedRankedEntry\u003e,\n    top_agents: Option\u003cVec\u003cWrappedAgentEntry\u003e\u003e,\n    contributions: Vec\u003cWrappedContribution\u003e,\n    total_messages: i32,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedRankedEntry {\n    name: String,\n    cost: f64,\n    tokens: i64,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedAgentEntry {\n    name: String,\n    tokens: i64,\n    messages: i32,\n}\n\n#[derive(Debug, Clone)]\nstruct WrappedContribution {\n    date: String,\n    level: u8,\n}\n\n#[derive(Debug, Clone)]\nstruct FontSet {\n    regular: FontArc,\n    bold: FontArc,\n}\n\n#[derive(Debug, Clone)]\nstruct RenderOptions {\n    short: bool,\n    include_agents: bool,\n    pin_sisyphus: bool,\n}\n\npub fn run(options: WrappedOptions) -\u003e Result\u003cString\u003e {\n    let rt = Runtime::new()?;\n    rt.block_on(async move { generate_wrapped(options).await })\n}\n\nasync fn generate_wrapped(options: WrappedOptions) -\u003e Result\u003cString\u003e {\n    let data = load_wrapped_data(\u0026options).await?;\n\n    let agents_requested = options.include_agents;\n    let has_agent_data = data\n        .top_agents\n        .as_ref()\n        .map(|agents| !agents.is_empty())\n        .unwrap_or(false);\n    let opencode_enabled = options\n        .sources\n        .as_ref()\n        .map_or(true, |sources| sources.iter().any(|s| s == \"opencode\"));\n    let effective_include_agents = agents_requested \u0026\u0026 has_agent_data;\n\n    if agents_requested \u0026\u0026 opencode_enabled \u0026\u0026 !has_agent_data {\n        println!(\n            \"{}\",\n            format!(\"\\n  âš  No OpenCode agent data found for {}.\", data.year).yellow()\n        );\n        println!(\"{}\", \"    Falling back to clients view.\".bright_black());\n        println!(\n            \"{}\",\n            \"    Use --clients to always show clients view.\\n\".bright_black()\n        );\n    }\n\n    let image = generate_wrapped_image(\n        \u0026data,\n        \u0026RenderOptions {\n            short: options.short,\n            include_agents: effective_include_agents,\n            pin_sisyphus: options.pin_sisyphus,\n        },\n    )\n    .await?;\n\n    let output = options\n        .output\n        .clone()\n        .unwrap_or_else(|| format!(\"tokscale-{}-wrapped.png\", data.year));\n    let output_path = PathBuf::from(\u0026output);\n    let absolute = if output_path.is_absolute() {\n        output_path\n    } else {\n        std::env::current_dir()?.join(output_path)\n    };\n\n    image\n        .save_with_format(\u0026absolute, image::ImageFormat::Png)\n        .with_context(|| format!(\"Failed to save wrapped image to {}\", absolute.display()))?;\n\n    Ok(absolute.to_string_lossy().to_string())\n}\n\nasync fn load_wrapped_data(options: \u0026WrappedOptions) -\u003e Result\u003cWrappedData\u003e {\n    let year = options\n        .year\n        .clone()\n        .unwrap_or_else(|| Local::now().year().to_string());\n    let sources = options.sources.clone().unwrap_or_else(default_sources);\n    let local_sources: Vec\u003cString\u003e = sources\n        .iter()\n        .filter(|src| src.as_str() != \"cursor\")\n        .cloned()\n        .collect();\n    let include_cursor = sources.iter().any(|src| src == \"cursor\");\n\n    let since = format!(\"{}-01-01\", year);\n    let until = format!(\"{}-12-31\", year);\n\n    let has_cursor_cache = cursor::has_cursor_usage_cache();\n    let mut cursor_sync_result: Option\u003ccursor::SyncCursorResult\u003e = None;\n\n    if include_cursor \u0026\u0026 cursor::is_cursor_logged_in() {\n        cursor_sync_result = Some(cursor::sync_cursor_cache().await);\n    }\n\n    if let Some(sync) = cursor_sync_result.as_ref() {\n        if let Some(error) = sync.error.as_ref() {\n            if sync.synced || has_cursor_cache {\n                let prefix = if sync.synced {\n                    \"Cursor sync warning\"\n                } else {\n                    \"Cursor sync failed; using cached data\"\n                };\n                println!(\"{}\", format!(\"  {}: {}\", prefix, error).yellow());\n            }\n        }\n    }\n\n    let include_cursor_in_graph = if include_cursor {\n        let synced = cursor_sync_result\n            .as_ref()\n            .map(|sync| sync.synced)\n            .unwrap_or(false);\n        synced || has_cursor_cache\n    } else {\n        false\n    };\n\n    let graph_sources = if include_cursor \u0026\u0026 !include_cursor_in_graph {\n        sources\n            .iter()\n            .filter(|src| src.as_str() != \"cursor\")\n            .cloned()\n            .collect::\u003cVec\u003c_\u003e\u003e()\n    } else {\n        sources.clone()\n    };\n\n    let parsed_local = if options.include_agents \u0026\u0026 !local_sources.is_empty() {\n        Some(\n            parse_local_sources(LocalParseOptions {\n                home_dir: None,\n                sources: Some(local_sources),\n                since: Some(since.clone()),\n                until: Some(until.clone()),\n                year: Some(year.clone()),\n            })\n            .map_err(anyhow::Error::msg)?,\n        )\n    } else {\n        None\n    };\n\n    let graph = generate_graph(ReportOptions {\n        home_dir: None,\n        sources: Some(graph_sources),\n        since: Some(since),\n        until: Some(until),\n        year: Some(year.clone()),\n        group_by: GroupBy::default(),\n    })\n    .await\n    .map_err(anyhow::Error::msg)?;\n\n    let mut model_map: HashMap\u003cString, WrappedRankedEntry\u003e = HashMap::new();\n    let mut client_map: HashMap\u003cString, WrappedRankedEntry\u003e = HashMap::new();\n    let mut total_messages = 0i32;\n\n    for day in \u0026graph.contributions {\n        total_messages += day.totals.messages;\n\n        for source in \u0026day.sources {\n            let model_name = format_model_name(\u0026source.model_id);\n            let model_entry =\n                model_map\n                    .entry(model_name.clone())\n                    .or_insert_with(|| WrappedRankedEntry {\n                        name: model_name,\n                        cost: 0.0,\n                        tokens: 0,\n                    });\n            model_entry.cost += source.cost;\n            model_entry.tokens += source.tokens.input\n                + source.tokens.output\n                + source.tokens.cache_read\n                + source.tokens.cache_write;\n\n            let client_name = source_display_name(\u0026source.source)\n                .unwrap_or(source.source.as_str())\n                .to_string();\n            let client_entry =\n                client_map\n                    .entry(client_name.clone())\n                    .or_insert_with(|| WrappedRankedEntry {\n                        name: client_name,\n                        cost: 0.0,\n                        tokens: 0,\n                    });\n            client_entry.cost += source.cost;\n            client_entry.tokens += source.tokens.input\n                + source.tokens.output\n                + source.tokens.cache_read\n                + source.tokens.cache_write;\n        }\n    }\n\n    let mut top_models: Vec\u003cWrappedRankedEntry\u003e = model_map.into_values().collect();\n    top_models.sort_by(|a, b| b.cost.partial_cmp(\u0026a.cost).unwrap_or(Ordering::Equal));\n    top_models.truncate(3);\n\n    let mut top_clients: Vec\u003cWrappedRankedEntry\u003e = client_map.into_values().collect();\n    top_clients.sort_by(|a, b| b.cost.partial_cmp(\u0026a.cost).unwrap_or(Ordering::Equal));\n    top_clients.truncate(3);\n\n    let top_agents = if options.include_agents {\n        parsed_local\n            .as_ref()\n            .map(build_top_agents)\n            .filter(|agents| !agents.is_empty())\n    } else {\n        None\n    };\n\n    let max_cost = graph\n        .contributions\n        .iter()\n        .map(|c| c.totals.cost)\n        .fold(1.0, f64::max);\n    let contributions: Vec\u003cWrappedContribution\u003e = graph\n        .contributions\n        .iter()\n        .map(|c| WrappedContribution {\n            date: c.date.clone(),\n            level: calculate_intensity(c.totals.cost, max_cost),\n        })\n        .collect();\n\n    let mut sorted_dates: Vec\u003cString\u003e = contributions\n        .iter()\n        .map(|c| c.date.clone())\n        .filter(|date| date.starts_with(\u0026year))\n        .collect();\n    sorted_dates.sort();\n\n    let (_current_streak, longest_streak) = calculate_streaks(\u0026sorted_dates);\n    let _first_day = sorted_dates\n        .first()\n        .cloned()\n        .unwrap_or_else(|| format!(\"{}-01-01\", year));\n\n    Ok(WrappedData {\n        year,\n        active_days: graph.summary.active_days,\n        total_tokens: graph.summary.total_tokens,\n        total_cost: graph.summary.total_cost,\n        longest_streak,\n        top_models,\n        top_clients,\n        top_agents,\n        contributions,\n        total_messages,\n    })\n}\n\nfn build_top_agents(parsed: \u0026tokscale_core::ParsedMessages) -\u003e Vec\u003cWrappedAgentEntry\u003e {\n    let mut agent_map: HashMap\u003cString, WrappedAgentEntry\u003e = HashMap::new();\n\n    for message in \u0026parsed.messages {\n        if message.source != \"opencode\" {\n            continue;\n        }\n\n        let Some(agent) = message.agent.as_ref() else {\n            continue;\n        };\n\n        let normalized = tokscale_core::sessions::normalize_agent_name(agent);\n        let tokens = message.input\n            + message.output\n            + message.cache_read\n            + message.cache_write\n            + message.reasoning;\n\n        let entry = agent_map\n            .entry(normalized.clone())\n            .or_insert_with(|| WrappedAgentEntry {\n                name: normalized,\n                tokens: 0,\n                messages: 0,\n            });\n        entry.tokens += tokens;\n        entry.messages += 1;\n    }\n\n    let mut agents: Vec\u003cWrappedAgentEntry\u003e = agent_map.into_values().collect();\n\n    let mut pinned = agents\n        .iter()\n        .filter(|agent| PINNED_AGENTS.contains(\u0026agent.name.as_str()))\n        .cloned()\n        .collect::\u003cVec\u003c_\u003e\u003e();\n    let mut unpinned = agents\n        .drain(..)\n        .filter(|agent| !PINNED_AGENTS.contains(\u0026agent.name.as_str()))\n        .collect::\u003cVec\u003c_\u003e\u003e();\n\n    pinned.sort_by_key(|agent| {\n        PINNED_AGENTS\n            .iter()\n            .position(|name| *name == agent.name)\n            .unwrap_or(usize::MAX)\n    });\n    unpinned.sort_by(|a, b| b.messages.cmp(\u0026a.messages));\n\n    let mut combined = Vec::new();\n    combined.extend(pinned);\n    combined.extend(unpinned.into_iter().take(2));\n    combined\n}\n\nasync fn generate_wrapped_image(data: \u0026WrappedData, options: \u0026RenderOptions) -\u003e Result\u003cRgbaImage\u003e {\n    let client = reqwest::Client::new();\n    let fonts = ensure_fonts_loaded(\u0026client).await?;\n\n    let mut canvas =\n        RgbaImage::from_pixel(IMAGE_WIDTH as u32, IMAGE_HEIGHT as u32, COLOR_BACKGROUND);\n\n    let left_width = (IMAGE_WIDTH as f32 * 0.45) as i32;\n    let right_width = (IMAGE_WIDTH as f32 * 0.55) as i32;\n    let right_x = left_width;\n\n    let mut y_pos = PADDING + 24 * SCALE;\n\n    let credentials = auth::load_credentials();\n    let display_username = credentials\n        .as_ref()\n        .and_then(|cred| truncate_username(\u0026cred.username, 30));\n    let title_text = display_username\n        .map(|username| format!(\"@{}'s Wrapped {}\", username, data.year))\n        .unwrap_or_else(|| format!(\"My Wrapped {}\", data.year));\n\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.bold,\n        (28 * SCALE) as f32,\n        COLOR_TEXT_PRIMARY,\n        PADDING,\n        y_pos,\n        \u0026title_text,\n    );\n    y_pos += 60 * SCALE;\n\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.regular,\n        (20 * SCALE) as f32,\n        COLOR_TEXT_SECONDARY,\n        PADDING,\n        y_pos,\n        \"Total Tokens\",\n    );\n    y_pos += 64 * SCALE;\n\n    let total_tokens_display = if options.short {\n        format_tokens_short(data.total_tokens)\n    } else {\n        format_number_with_commas_i64(data.total_tokens)\n    };\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.bold,\n        (56 * SCALE) as f32,\n        COLOR_GRADE4,\n        PADDING,\n        y_pos,\n        \u0026total_tokens_display,\n    );\n    y_pos += 50 * SCALE + 40 * SCALE;\n\n    let logo_size = 32 * SCALE;\n    let logo_radius = 6 * SCALE;\n\n    draw_text_mut_baseline(\n        \u0026mut canvas,\n        \u0026fonts.regular,\n        (20 * SCALE) as f32,\n        COLOR_TEXT_SECONDARY,\n        PADDING,\n        y_pos,\n        \"Top Models\",\n    );\n    y_pos += 48 * SCALE;\n\n    for (index, model) in data.top_models.iter().enumerate() {\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.bold,\n            (32 * SCALE) as f32,\n            COLOR_TEXT_PRIMARY,\n            PADDING,\n            y_pos,\n            \u0026(index + 1).to_string(),\n        );\n\n        let mut text_x = PADDING + 40 * SCALE;\n\n        if let Some(provider) = get_provider_from_model(\u0026model.name) {\n            if let Some(logo_url) = provider_logo_url(provider) {\n                let filename = format!(\"provider-{}@2x.jpg\", provider);\n                if let Ok(path) = fetch_and_cache_image(\u0026client, logo_url, \u0026filename).await {\n                    if let Ok(logo) = load_rgba_image(\u0026path) {\n                        let logo_y = y_pos - logo_size + 6 * SCALE;\n                        let logo_x = PADDING + 40 * SCALE;\n\n                        draw_image_rounded(\n                            \u0026mut canvas,\n                            \u0026logo,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                        );\n                        draw_rounded_border(\n                            \u0026mut canvas,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                            1 * SCALE,\n                            COLOR_GRADE0,\n                        );\n\n                        text_x = logo_x + logo_size + 12 * SCALE;\n                    }\n                }\n            }\n        }\n\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.regular,\n            (32 * SCALE) as f32,\n            COLOR_TEXT_PRIMARY,\n            text_x,\n            y_pos,\n            \u0026model.name,\n        );\n        y_pos += 50 * SCALE;\n    }\n    y_pos += 40 * SCALE;\n\n    if options.include_agents {\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.regular,\n            (20 * SCALE) as f32,\n            COLOR_TEXT_SECONDARY,\n            PADDING,\n            y_pos,\n            \"Top OpenCode Agents\",\n        );\n        y_pos += 48 * SCALE;\n\n        let agents = data.top_agents.clone().unwrap_or_default();\n        let mut rank_index = 1;\n\n        for agent in agents {\n            let is_sisyphus_agent = PINNED_AGENTS.contains(\u0026agent.name.as_str());\n            let show_with_dash = options.pin_sisyphus \u0026\u0026 is_sisyphus_agent;\n            let prefix = if show_with_dash {\n                \"\\u{2022}\".to_string()\n            } else {\n                rank_index.to_string()\n            };\n            let prefix_color = if show_with_dash {\n                COLOR_SISYPHUS\n            } else {\n                COLOR_TEXT_PRIMARY\n            };\n\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.bold,\n                (32 * SCALE) as f32,\n                prefix_color,\n                PADDING,\n                y_pos,\n                \u0026prefix,\n            );\n\n            if !show_with_dash {\n                rank_index += 1;\n            }\n\n            let name_x = PADDING + 40 * SCALE;\n            let name_color = if is_sisyphus_agent {\n                COLOR_SISYPHUS\n            } else {\n                COLOR_TEXT_PRIMARY\n            };\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (32 * SCALE) as f32,\n                name_color,\n                name_x,\n                y_pos,\n                \u0026agent.name,\n            );\n\n            let name_width = measure_text_width(\u0026fonts.regular, (32 * SCALE) as f32, \u0026agent.name);\n            let suffix = format!(\n                \" ({})\",\n                format_number_with_commas_i64(agent.messages as i64)\n            );\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (32 * SCALE) as f32,\n                COLOR_TEXT_SECONDARY,\n                name_x + name_width.round() as i32,\n                y_pos,\n                \u0026suffix,\n            );\n\n            y_pos += 50 * SCALE;\n        }\n    } else {\n        draw_text_mut_baseline(\n            \u0026mut canvas,\n            \u0026fonts.regular,\n            (20 * SCALE) as f32,\n            COLOR_TEXT_SECONDARY,\n            PADDING,\n            y_pos,\n            \"Top Clients\",\n        );\n        y_pos += 48 * SCALE;\n\n        for (index, client_entry) in data.top_clients.iter().enumerate() {\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.bold,\n                (32 * SCALE) as f32,\n                COLOR_TEXT_PRIMARY,\n                PADDING,\n                y_pos,\n                \u0026(index + 1).to_string(),\n            );\n\n            if let Some(logo_url) = client_logo_url(\u0026client_entry.name) {\n                let filename = format!(\n                    \"client-{}@2x.png\",\n                    client_entry\n                        .name\n                        .to_lowercase()\n                        .split_whitespace()\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"-\")\n                );\n\n                if let Ok(path) = fetch_and_cache_image(\u0026client, logo_url, \u0026filename).await {\n                    if let Ok(logo) = load_rgba_image(\u0026path) {\n                        let logo_x = PADDING + 40 * SCALE;\n                        let logo_y = y_pos - logo_size + 6 * SCALE;\n\n                        draw_image_rounded(\n                            \u0026mut canvas,\n                            \u0026logo,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                        );\n                        draw_rounded_border(\n                            \u0026mut canvas,\n                            logo_x,\n                            logo_y,\n                            logo_size,\n                            logo_size,\n                            logo_radius,\n                            1 * SCALE,\n                            COLOR_GRADE0,\n                        );\n                    }\n                }\n            }\n\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (32 * SCALE) as f32,\n                COLOR_TEXT_PRIMARY,\n                PADDING + 40 * SCALE + logo_size + 12 * SCALE,\n                y_pos,\n                \u0026client_entry.name,\n            );\n            y_pos += 50 * SCALE;\n        }\n    }\n\n    y_pos += 40 * SCALE;\n\n    let stats_start_y = y_pos;\n    let stat_width = (left_width - PADDING * 2) / 2;\n\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING,\n        stats_start_y,\n        \"Messages\",\n        \u0026format_number_with_commas_i64(data.total_messages as i64),\n    );\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING + stat_width,\n        stats_start_y,\n        \"Active Days\",\n        \u0026data.active_days.to_string(),\n    );\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING,\n        stats_start_y + 100 * SCALE,\n        \"Cost\",\n        \u0026format_cost(data.total_cost),\n    );\n    draw_stat(\n        \u0026mut canvas,\n        \u0026fonts,\n        PADDING + stat_width,\n        stats_start_y + 100 * SCALE,\n        \"Streak\",\n        \u0026format!(\"{}d\", data.longest_streak),\n    );\n\n    draw_contribution_graph(\n        \u0026mut canvas,\n        data,\n        right_x,\n        PADDING,\n        right_width - PADDING,\n        IMAGE_HEIGHT - PADDING * 2,\n    );\n\n    let footer_bottom_y = IMAGE_HEIGHT - PADDING;\n    let tokscale_logo_height = 72 * SCALE;\n\n    if let Ok(logo_path) = fetch_svg_and_convert_to_png(\n        \u0026client,\n        TOKSCALE_LOGO_SVG_URL,\n        \"tokscale-logo@2x.png\",\n        TOKSCALE_LOGO_PNG_SIZE * SCALE,\n    )\n    .await\n    {\n        if let Ok(logo) = load_rgba_image(\u0026logo_path) {\n            draw_text_mut_baseline(\n                \u0026mut canvas,\n                \u0026fonts.regular,\n                (18 * SCALE) as f32,\n                COLOR_TEXT_SECONDARY,\n                PADDING,\n                footer_bottom_y,\n                \"github.com/junhoyeo/tokscale\",\n            );\n\n            let logo_width = ((logo.width() as f32 / logo.height() as f32)\n                * tokscale_logo_height as f32)\n                .round() as i32;\n            let logo_y = footer_bottom_y - 18 * SCALE - 16 * SCALE - tokscale_logo_height;\n            draw_image(\n                \u0026mut canvas,\n                \u0026logo,\n                PADDING,\n                logo_y,\n                logo_width,\n                tokscale_logo_height,\n            );\n        }\n    }\n\n    Ok(canvas)\n}\n\nfn draw_contribution_graph(\n    canvas: \u0026mut RgbaImage,\n    data: \u0026WrappedData,\n    x: i32,\n    y: i32,\n    width: i32,\n    height: i32,\n) {\n    let year = data\n        .year\n        .parse::\u003ci32\u003e()\n        .unwrap_or_else(|_| Local::now().year());\n    let Some(start_date) = NaiveDate::from_ymd_opt(year, 1, 1) else {\n        return;\n    };\n    let Some(end_date) = NaiveDate::from_ymd_opt(year, 12, 31) else {\n        return;\n    };\n\n    let contrib_map: HashMap\u003c\u0026str, u8\u003e = data\n        .contributions\n        .iter()\n        .map(|contribution| (contribution.date.as_str(), contribution.level))\n        .collect();\n\n    const DAYS_PER_ROW: i32 = 14;\n    let total_days = (end_date - start_date).num_days() + 1;\n    let total_rows = ((total_days + (DAYS_PER_ROW as i64) - 1) / DAYS_PER_ROW as i64) as i32;\n\n    let cell_size = ((height as f32 / total_rows as f32).floor() as i32)\n        .min((width as f32 / DAYS_PER_ROW as f32).floor() as i32)\n        .max(1);\n    let dot_radius = (((cell_size - 2 * SCALE) as f32) / 2.0).floor().max(1.0) as i32;\n\n    let graph_width = DAYS_PER_ROW * cell_size;\n    let _graph_height = total_rows * cell_size;\n    let offset_x = x + (width - graph_width) / 2;\n    let offset_y = y;\n\n    let grade_colors = [\n        COLOR_GRADE0,\n        COLOR_GRADE1,\n        COLOR_GRADE2,\n        COLOR_GRADE3,\n        COLOR_GRADE4,\n    ];\n\n    let mut current_date = start_date;\n    let mut day_index = 0i32;\n\n    while current_date \u003c= end_date {\n        let date_key = current_date.format(\"%Y-%m-%d\").to_string();\n        let level = *contrib_map.get(date_key.as_str()).unwrap_or(\u00260);\n\n        let col = day_index % DAYS_PER_ROW;\n        let row = day_index / DAYS_PER_ROW;\n\n        let center_x = offset_x + col * cell_size + cell_size / 2;\n        let center_y = offset_y + row * cell_size + cell_size / 2;\n\n        draw_filled_circle_mut(\n            canvas,\n            (center_x, center_y),\n            dot_radius,\n            grade_colors[level as usize],\n        );\n\n        current_date += Duration::days(1);\n        day_index += 1;\n    }\n}\n\nfn draw_stat(canvas: \u0026mut RgbaImage, fonts: \u0026FontSet, x: i32, y: i32, label: \u0026str, value: \u0026str) {\n    draw_text_mut_baseline(\n        canvas,\n        \u0026fonts.regular,\n        (18 * SCALE) as f32,\n        COLOR_TEXT_SECONDARY,\n        x,\n        y,\n        label,\n    );\n    draw_text_mut_baseline(\n        canvas,\n        \u0026fonts.bold,\n        (36 * SCALE) as f32,\n        COLOR_TEXT_PRIMARY,\n        x,\n        y + 48 * SCALE,\n        value,\n    );\n}\n\nfn draw_text_mut_baseline(\n    canvas: \u0026mut RgbaImage,\n    font: \u0026FontArc,\n    font_size: f32,\n    color: Rgba\u003cu8\u003e,\n    x: i32,\n    baseline_y: i32,\n    text: \u0026str,\n) {\n    let scale = PxScale::from(font_size);\n    let scaled_font = font.as_scaled(scale);\n\n    let mut caret_x = x as f32;\n    let baseline = baseline_y as f32;\n    let mut prev_glyph: Option\u003cGlyphId\u003e = None;\n\n    for ch in text.chars() {\n        let glyph_id = scaled_font.glyph_id(ch);\n        if let Some(prev) = prev_glyph {\n            caret_x += scaled_font.kern(prev, glyph_id);\n        }\n\n        let glyph = glyph_id.with_scale_and_position(scale, point(caret_x, baseline));\n        if let Some(outlined) = font.outline_glyph(glyph) {\n            let bounds = outlined.px_bounds();\n            outlined.draw(|gx, gy, coverage| {\n                let px = bounds.min.x as i32 + gx as i32;\n                let py = bounds.min.y as i32 + gy as i32;\n                blend_pixel_with_coverage(canvas, px, py, color, coverage);\n            });\n        }\n\n        caret_x += scaled_font.h_advance(glyph_id);\n        prev_glyph = Some(glyph_id);\n    }\n}\n\nfn measure_text_width(font: \u0026FontArc, font_size: f32, text: \u0026str) -\u003e f32 {\n    let scale = PxScale::from(font_size);\n    let scaled_font = font.as_scaled(scale);\n    let mut width = 0.0f32;\n    let mut prev_glyph: Option\u003cGlyphId\u003e = None;\n\n    for ch in text.chars() {\n        let glyph_id = scaled_font.glyph_id(ch);\n        if let Some(prev) = prev_glyph {\n            width += scaled_font.kern(prev, glyph_id);\n        }\n        width += scaled_font.h_advance(glyph_id);\n        prev_glyph = Some(glyph_id);\n    }\n\n    width\n}\n\nfn draw_image(canvas: \u0026mut RgbaImage, source: \u0026RgbaImage, x: i32, y: i32, width: i32, height: i32) {\n    if width \u003c= 0 || height \u003c= 0 {\n        return;\n    }\n\n    let resized =\n        image::imageops::resize(source, width as u32, height as u32, FilterType::CatmullRom);\n    for dy in 0..height {\n        for dx in 0..width {\n            let src = *resized.get_pixel(dx as u32, dy as u32);\n            blend_pixel(canvas, x + dx, y + dy, src);\n        }\n    }\n}\n\nfn draw_image_rounded(\n    canvas: \u0026mut RgbaImage,\n    source: \u0026RgbaImage,\n    x: i32,\n    y: i32,\n    width: i32,\n    height: i32,\n    radius: i32,\n) {\n    if width \u003c= 0 || height \u003c= 0 {\n        return;\n    }\n\n    let resized =\n        image::imageops::resize(source, width as u32, height as u32, FilterType::CatmullRom);\n    for dy in 0..height {\n        for dx in 0..width {\n            let px = x + dx;\n            let py = y + dy;\n            if point_in_rounded_rect(\n                px as f32 + 0.5,\n                py as f32 + 0.5,\n                x as f32,\n                y as f32,\n                width as f32,\n                height as f32,\n                radius as f32,\n            ) {\n                let src = *resized.get_pixel(dx as u32, dy as u32);\n                blend_pixel(canvas, px, py, src);\n            }\n        }\n    }\n}\n\nfn draw_rounded_border(\n    canvas: \u0026mut RgbaImage,\n    x: i32,\n    y: i32,\n    width: i32,\n    height: i32,\n    radius: i32,\n    line_width: i32,\n    color: Rgba\u003cu8\u003e,\n) {\n    if width \u003c= 0 || height \u003c= 0 || line_width \u003c= 0 {\n        return;\n    }\n\n    for py in y..(y + height) {\n        for px in x..(x + width) {\n            let cx = px as f32 + 0.5;\n            let cy = py as f32 + 0.5;\n            let outer = point_in_rounded_rect(\n                cx,\n                cy,\n                x as f32,\n                y as f32,\n                width as f32,\n                height as f32,\n                radius as f32,\n            );\n            if !outer {\n                continue;\n            }\n\n            let inner = point_in_rounded_rect(\n                cx,\n                cy,\n                (x + line_width) as f32,\n                (y + line_width) as f32,\n                (width - 2 * line_width) as f32,\n                (height - 2 * line_width) as f32,\n                (radius - line_width).max(0) as f32,\n            );\n\n            if !inner {\n                blend_pixel(canvas, px, py, color);\n            }\n        }\n    }\n}\n\nfn point_in_rounded_rect(\n    px: f32,\n    py: f32,\n    x: f32,\n    y: f32,\n    width: f32,\n    height: f32,\n    radius: f32,\n) -\u003e bool {\n    if width \u003c= 0.0 || height \u003c= 0.0 {\n        return false;\n    }\n\n    let r = radius.max(0.0).min(width / 2.0).min(height / 2.0);\n    if r \u003c= 0.0 {\n        return px \u003e= x \u0026\u0026 px \u003c x + width \u0026\u0026 py \u003e= y \u0026\u0026 py \u003c y + height;\n    }\n\n    let nearest_x = px.clamp(x + r, x + width - r);\n    let nearest_y = py.clamp(y + r, y + height - r);\n    let dx = px - nearest_x;\n    let dy = py - nearest_y;\n    dx * dx + dy * dy \u003c= r * r\n}\n\nfn blend_pixel_with_coverage(\n    canvas: \u0026mut RgbaImage,\n    x: i32,\n    y: i32,\n    color: Rgba\u003cu8\u003e,\n    coverage: f32,\n) {\n    let mut src = color;\n    src.0[3] = ((src.0[3] as f32) * coverage.clamp(0.0, 1.0)).round() as u8;\n    blend_pixel(canvas, x, y, src);\n}\n\nfn blend_pixel(canvas: \u0026mut RgbaImage, x: i32, y: i32, src: Rgba\u003cu8\u003e) {\n    if x \u003c 0 || y \u003c 0 {\n        return;\n    }\n\n    let width = canvas.width() as i32;\n    let height = canvas.height() as i32;\n    if x \u003e= width || y \u003e= height {\n        return;\n    }\n\n    let dst = canvas.get_pixel_mut(x as u32, y as u32);\n    let src_alpha = src.0[3] as f32 / 255.0;\n    if src_alpha \u003c= 0.0 {\n        return;\n    }\n\n    let dst_alpha = dst.0[3] as f32 / 255.0;\n    let out_alpha = src_alpha + dst_alpha * (1.0 - src_alpha);\n\n    if out_alpha \u003c= 0.0 {\n        *dst = Rgba([0, 0, 0, 0]);\n        return;\n    }\n\n    for channel in 0..3 {\n        let src_channel = src.0[channel] as f32 / 255.0;\n        let dst_channel = dst.0[channel] as f32 / 255.0;\n        let out_channel =\n            (src_channel * src_alpha + dst_channel * dst_alpha * (1.0 - src_alpha)) / out_alpha;\n        dst.0[channel] = (out_channel * 255.0).round().clamp(0.0, 255.0) as u8;\n    }\n\n    dst.0[3] = (out_alpha * 255.0).round().clamp(0.0, 255.0) as u8;\n}\n\nasync fn ensure_fonts_loaded(client: \u0026reqwest::Client) -\u003e Result\u003cFontSet\u003e {\n    let cache_dir = get_font_cache_dir()?;\n    ensure_cache_dir(\u0026cache_dir)?;\n\n    let regular_path = cache_dir.join(FIGTREE_REGULAR_FILE);\n    let bold_path = cache_dir.join(FIGTREE_BOLD_FILE);\n\n    if !regular_path.exists() {\n        let _ = fetch_to_file(client, FIGTREE_REGULAR_URL, \u0026regular_path).await;\n    }\n    if !bold_path.exists() {\n        let _ = fetch_to_file(client, FIGTREE_BOLD_URL, \u0026bold_path).await;\n    }\n\n    let regular_font = if regular_path.exists() {\n        fs::read(\u0026regular_path)\n            .ok()\n            .and_then(|bytes| FontArc::try_from_vec(bytes).ok())\n    } else {\n        None\n    };\n    let bold_font = if bold_path.exists() {\n        fs::read(\u0026bold_path)\n            .ok()\n            .and_then(|bytes| FontArc::try_from_vec(bytes).ok())\n    } else {\n        None\n    };\n\n    let (regular, bold) = match (regular_font, bold_font) {\n        (Some(regular), Some(bold)) =\u003e (regular, bold),\n        (Some(regular), None) =\u003e (regular.clone(), regular),\n        (None, Some(bold)) =\u003e (bold.clone(), bold),\n        (None, None) =\u003e {\n            anyhow::bail!(\n                \"Failed to load Figtree fonts. Could not download or parse cached font files.\"\n            )\n        }\n    };\n\n    Ok(FontSet { regular, bold })\n}\n\nasync fn fetch_and_cache_image(\n    client: \u0026reqwest::Client,\n    url: \u0026str,\n    filename: \u0026str,\n) -\u003e Result\u003cPathBuf\u003e {\n    let cache_dir = get_image_cache_dir()?;\n    ensure_cache_dir(\u0026cache_dir)?;\n\n    let cached_path = cache_dir.join(filename);\n    if !cached_path.exists() {\n        fetch_to_file(client, url, \u0026cached_path).await?;\n    }\n\n    Ok(cached_path)\n}\n\nasync fn fetch_svg_and_convert_to_png(\n    client: \u0026reqwest::Client,\n    svg_url: \u0026str,\n    filename: \u0026str,\n    size: i32,\n) -\u003e Result\u003cPathBuf\u003e {\n    let cache_dir = get_image_cache_dir()?;\n    ensure_cache_dir(\u0026cache_dir)?;\n\n    let cached_path = cache_dir.join(filename);\n    if cached_path.exists() {\n        return Ok(cached_path);\n    }\n\n    let response = client\n        .get(svg_url)\n        .send()\n        .await\n        .with_context(|| format!(\"Failed to fetch {}\", svg_url))?;\n    if !response.status().is_success() {\n        anyhow::bail!(\"Failed to fetch {} (status {})\", svg_url, response.status());\n    }\n\n    let svg_bytes = response.bytes().await?;\n    let options = usvg::Options::default();\n    let tree = usvg::Tree::from_data(\u0026svg_bytes, \u0026options)\n        .map_err(|err| anyhow::anyhow!(\"Failed to parse SVG: {err:?}\"))?;\n\n    let base_size = tree.size().to_int_size();\n    let scale = size as f32 / base_size.width() as f32;\n    let scaled_size = base_size\n        .scale_by(scale)\n        .ok_or_else(|| anyhow::anyhow!(\"Invalid scaled SVG size\"))?;\n\n    let mut pixmap = resvg::tiny_skia::Pixmap::new(scaled_size.width(), scaled_size.height())\n        .ok_or_else(|| anyhow::anyhow!(\"Failed to create pixmap\"))?;\n    let transform = resvg::tiny_skia::Transform::from_scale(scale, scale);\n    resvg::render(\u0026tree, transform, \u0026mut pixmap.as_mut());\n\n    let png = pixmap\n        .encode_png()\n        .map_err(|err| anyhow::anyhow!(\"Failed to encode PNG: {err:?}\"))?;\n    fs::write(\u0026cached_path, png)?;\n\n    Ok(cached_path)\n}\n\nasync fn fetch_to_file(client: \u0026reqwest::Client, url: \u0026str, path: \u0026Path) -\u003e Result\u003c()\u003e {\n    let response = client\n        .get(url)\n        .send()\n        .await\n        .with_context(|| format!(\"Failed to fetch {}\", url))?;\n\n    if !response.status().is_success() {\n        anyhow::bail!(\"Failed to fetch {} (status {})\", url, response.status());\n    }\n\n    let bytes = response.bytes().await?;\n    fs::write(path, \u0026bytes)?;\n    Ok(())\n}\n\nfn ensure_cache_dir(path: \u0026Path) -\u003e Result\u003c()\u003e {\n    if !path.exists() {\n        fs::create_dir_all(path)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(path, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n    Ok(())\n}\n\nfn load_rgba_image(path: \u0026Path) -\u003e Result\u003cRgbaImage\u003e {\n    Ok(image::open(path)\n        .with_context(|| format!(\"Failed to decode image {}\", path.display()))?\n        .to_rgba8())\n}\n\nfn get_image_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    let home = dirs::home_dir().context(\"Could not determine home directory\")?;\n    Ok(home.join(\".cache\").join(\"tokscale\").join(\"images\"))\n}\n\nfn get_font_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    let home = dirs::home_dir().context(\"Could not determine home directory\")?;\n    Ok(home.join(\".cache\").join(\"tokscale\").join(\"fonts\"))\n}\n\nfn calculate_intensity(cost: f64, max_cost: f64) -\u003e u8 {\n    if cost == 0.0 || max_cost == 0.0 {\n        return 0;\n    }\n\n    let ratio = cost / max_cost;\n    if ratio \u003e= 0.75 {\n        4\n    } else if ratio \u003e= 0.5 {\n        3\n    } else if ratio \u003e= 0.25 {\n        2\n    } else {\n        1\n    }\n}\n\nfn calculate_streaks(sorted_dates: \u0026[String]) -\u003e (i32, i32) {\n    if sorted_dates.is_empty() {\n        return (0, 0);\n    }\n\n    let today = Utc::now().date_naive().format(\"%Y-%m-%d\").to_string();\n    let mut current_streak = 0;\n    let mut longest_streak = 0;\n    let mut streak = 1;\n\n    for index in (0..sorted_dates.len()).rev() {\n        if index == sorted_dates.len() - 1 {\n            let days_diff = date_diff_days(\u0026sorted_dates[index], \u0026today);\n            if days_diff \u003c= 1 {\n                current_streak = 1;\n            } else {\n                break;\n            }\n        } else {\n            let days_diff = date_diff_days(\u0026sorted_dates[index], \u0026sorted_dates[index + 1]);\n            if days_diff == 1 {\n                current_streak += 1;\n            } else {\n                break;\n            }\n        }\n    }\n\n    for index in 1..sorted_dates.len() {\n        let days_diff = date_diff_days(\u0026sorted_dates[index - 1], \u0026sorted_dates[index]);\n        if days_diff == 1 {\n            streak += 1;\n        } else {\n            longest_streak = longest_streak.max(streak);\n            streak = 1;\n        }\n    }\n    longest_streak = longest_streak.max(streak);\n\n    (current_streak, longest_streak)\n}\n\nfn date_diff_days(date1: \u0026str, date2: \u0026str) -\u003e i64 {\n    let parsed1 = NaiveDate::parse_from_str(date1, \"%Y-%m-%d\");\n    let parsed2 = NaiveDate::parse_from_str(date2, \"%Y-%m-%d\");\n\n    match (parsed1, parsed2) {\n        (Ok(d1), Ok(d2)) =\u003e (d2 - d1).num_days().abs(),\n        _ =\u003e 0,\n    }\n}\n\nfn format_tokens_short(tokens: i64) -\u003e String {\n    if tokens \u003e= 1_000_000_000 {\n        format!(\"{:.2}B\", tokens as f64 / 1_000_000_000.0)\n    } else if tokens \u003e= 1_000_000 {\n        format!(\"{:.2}M\", tokens as f64 / 1_000_000.0)\n    } else if tokens \u003e= 1_000 {\n        format!(\"{:.1}K\", tokens as f64 / 1_000.0)\n    } else {\n        tokens.to_string()\n    }\n}\n\nfn format_cost(cost: f64) -\u003e String {\n    if cost \u003e= 1000.0 {\n        format!(\"${:.2}K\", cost / 1000.0)\n    } else {\n        format!(\"${:.2}\", cost)\n    }\n}\n\nfn format_number_with_commas_i64(value: i64) -\u003e String {\n    let sign = if value \u003c 0 { \"-\" } else { \"\" };\n    let digits = value.abs().to_string();\n    let mut result = String::with_capacity(digits.len() + digits.len() / 3 + sign.len());\n\n    result.push_str(sign);\n    for (index, ch) in digits.chars().enumerate() {\n        if index \u003e 0 \u0026\u0026 (digits.len() - index).is_multiple_of(3) {\n            result.push(',');\n        }\n        result.push(ch);\n    }\n\n    result\n}\n\nfn source_display_name(source: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match source {\n        \"opencode\" =\u003e Some(\"OpenCode\"),\n        \"claude\" =\u003e Some(\"Claude Code\"),\n        \"codex\" =\u003e Some(\"Codex CLI\"),\n        \"gemini\" =\u003e Some(\"Gemini CLI\"),\n        \"cursor\" =\u003e Some(\"Cursor IDE\"),\n        \"amp\" =\u003e Some(\"Amp\"),\n        \"droid\" =\u003e Some(\"Droid\"),\n        \"openclaw\" =\u003e Some(\"OpenClaw\"),\n        \"pi\" =\u003e Some(\"Pi\"),\n        _ =\u003e None,\n    }\n}\n\nfn client_logo_url(client_name: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match client_name {\n        \"OpenCode\" =\u003e Some(\"https://tokscale.ai/assets/logos/opencode.png\"),\n        \"Claude Code\" =\u003e Some(\"https://tokscale.ai/assets/logos/claude.jpg\"),\n        \"Codex CLI\" =\u003e Some(\"https://tokscale.ai/assets/logos/openai.jpg\"),\n        \"Gemini CLI\" =\u003e Some(\"https://tokscale.ai/assets/logos/gemini.png\"),\n        \"Cursor IDE\" =\u003e Some(\"https://tokscale.ai/assets/logos/cursor.jpg\"),\n        \"Amp\" =\u003e Some(\"https://tokscale.ai/assets/logos/amp.png\"),\n        \"Droid\" =\u003e Some(\"https://tokscale.ai/assets/logos/droid.png\"),\n        \"OpenClaw\" =\u003e Some(\"https://tokscale.ai/assets/logos/openclaw.png\"),\n        \"Pi\" =\u003e Some(\"https://tokscale.ai/assets/logos/pi.png\"),\n        _ =\u003e None,\n    }\n}\n\nfn provider_logo_url(provider: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match provider {\n        \"anthropic\" =\u003e Some(\"https://tokscale.ai/assets/logos/claude.jpg\"),\n        \"openai\" =\u003e Some(\"https://tokscale.ai/assets/logos/openai.jpg\"),\n        \"google\" =\u003e Some(\"https://tokscale.ai/assets/logos/gemini.png\"),\n        \"xai\" =\u003e Some(\"https://tokscale.ai/assets/logos/grok.jpg\"),\n        \"zai\" =\u003e Some(\"https://tokscale.ai/assets/logos/zai.jpg\"),\n        _ =\u003e None,\n    }\n}\n\nfn get_provider_from_model(model_id: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    let lower = model_id.to_lowercase();\n    if lower.contains(\"claude\")\n        || lower.contains(\"opus\")\n        || lower.contains(\"sonnet\")\n        || lower.contains(\"haiku\")\n    {\n        return Some(\"anthropic\");\n    }\n    if lower.contains(\"gpt\")\n        || lower.contains(\"o1\")\n        || lower.contains(\"o3\")\n        || lower.contains(\"codex\")\n    {\n        return Some(\"openai\");\n    }\n    if lower.contains(\"gemini\") {\n        return Some(\"google\");\n    }\n    if lower.contains(\"grok\") {\n        return Some(\"xai\");\n    }\n    if lower.contains(\"glm\") || lower.contains(\"pickle\") {\n        return Some(\"zai\");\n    }\n    None\n}\n\nfn format_model_name(model: \u0026str) -\u003e String {\n    if let Some(display) = exact_model_display_name(model) {\n        return display.to_string();\n    }\n\n    let (without_quality, suffix) = split_quality_suffix(model);\n    let mut cleaned = without_quality;\n\n    if let Some(index) = cleaned.rfind(':') {\n        let tail = \u0026cleaned[index + 1..];\n        if !tail.is_empty()\n            \u0026\u0026 tail\n                .chars()\n                .all(|c| c.is_ascii_alphanumeric() || c == '-' || c == '_')\n        {\n            cleaned.truncate(index);\n        }\n    }\n\n    if cleaned.to_lowercase().ends_with(\"-thinking\") {\n        cleaned.truncate(cleaned.len() - \"-thinking\".len());\n    } else if cleaned.to_lowercase().ends_with(\"_thinking\") {\n        cleaned.truncate(cleaned.len() - \"_thinking\".len());\n    }\n\n    cleaned = strip_date_suffix(cleaned);\n\n    let normalized = cleaned\n        .to_lowercase()\n        .chars()\n        .filter(|c| c.is_ascii_alphanumeric())\n        .collect::\u003cString\u003e();\n\n    if normalized.contains(\"claudeopus45\") {\n        return format!(\"Claude Opus 4.5{}\", suffix);\n    }\n    if normalized.contains(\"claude4opus\") {\n        return format!(\"Claude 4 Opus{}\", suffix);\n    }\n    if normalized.contains(\"claudeopus4\") {\n        return format!(\"Claude Opus 4{}\", suffix);\n    }\n    if normalized.contains(\"claudesonnet45\") {\n        return format!(\"Claude Sonnet 4.5{}\", suffix);\n    }\n    if normalized.contains(\"claude4sonnet\") {\n        return format!(\"Claude 4 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claudesonnet4\") {\n        return format!(\"Claude Sonnet 4{}\", suffix);\n    }\n    if normalized.contains(\"claudehaiku45\") {\n        return format!(\"Claude Haiku 4.5{}\", suffix);\n    }\n    if normalized.contains(\"claude4haiku\") {\n        return format!(\"Claude 4 Haiku{}\", suffix);\n    }\n    if normalized.contains(\"claudehaiku4\") {\n        return format!(\"Claude Haiku 4{}\", suffix);\n    }\n    if normalized.contains(\"claude37sonnet\") {\n        return format!(\"Claude 3.7 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claude35sonnet\") {\n        return format!(\"Claude 3.5 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claude35haiku\") {\n        return format!(\"Claude 3.5 Haiku{}\", suffix);\n    }\n    if normalized.contains(\"claude3opus\") {\n        return format!(\"Claude 3 Opus{}\", suffix);\n    }\n    if normalized.contains(\"claude3sonnet\") {\n        return format!(\"Claude 3 Sonnet{}\", suffix);\n    }\n    if normalized.contains(\"claude3haiku\") {\n        return format!(\"Claude 3 Haiku{}\", suffix);\n    }\n    if normalized.contains(\"gpt51\") {\n        return format!(\"GPT-5.1{}\", suffix);\n    }\n    if normalized.contains(\"gpt5\") {\n        return format!(\"GPT-5{}\", suffix);\n    }\n    if normalized.contains(\"gpt4omini\") {\n        return format!(\"GPT-4o Mini{}\", suffix);\n    }\n    if normalized.contains(\"gpt4o\") {\n        return format!(\"GPT-4o{}\", suffix);\n    }\n    if normalized.contains(\"gpt4turbo\") {\n        return format!(\"GPT-4 Turbo{}\", suffix);\n    }\n    if normalized.contains(\"gpt4\") {\n        return format!(\"GPT-4{}\", suffix);\n    }\n    if normalized.starts_with(\"o1mini\") {\n        return format!(\"o1 Mini{}\", suffix);\n    }\n    if normalized.starts_with(\"o1preview\") {\n        return format!(\"o1 Preview{}\", suffix);\n    }\n    if normalized.starts_with(\"o3mini\") {\n        return format!(\"o3 Mini{}\", suffix);\n    }\n    if normalized == \"o1\" {\n        return format!(\"o1{}\", suffix);\n    }\n    if normalized == \"o3\" {\n        return format!(\"o3{}\", suffix);\n    }\n    if normalized.contains(\"gemini3pro\") {\n        return format!(\"Gemini 3 Pro{}\", suffix);\n    }\n    if normalized.contains(\"gemini3flash\") {\n        return format!(\"Gemini 3 Flash{}\", suffix);\n    }\n    if normalized.contains(\"gemini25pro\") {\n        return format!(\"Gemini 2.5 Pro{}\", suffix);\n    }\n    if normalized.contains(\"gemini25flash\") {\n        return format!(\"Gemini 2.5 Flash{}\", suffix);\n    }\n    if normalized.contains(\"gemini20flash\") {\n        return format!(\"Gemini 2.0 Flash{}\", suffix);\n    }\n    if normalized.contains(\"gemini15pro\") {\n        return format!(\"Gemini 1.5 Pro{}\", suffix);\n    }\n    if normalized.contains(\"gemini15flash\") {\n        return format!(\"Gemini 1.5 Flash{}\", suffix);\n    }\n    if normalized.contains(\"grok3mini\") {\n        return format!(\"Grok Code 3 Mini{}\", suffix);\n    }\n    if normalized.contains(\"grok3\") {\n        return format!(\"Grok Code 3{}\", suffix);\n    }\n    if normalized.contains(\"grok\") {\n        return format!(\"Grok Code{}\", suffix);\n    }\n    if normalized.contains(\"deepseekv3\") {\n        return format!(\"DeepSeek V3{}\", suffix);\n    }\n    if normalized.contains(\"deepseekr1\") {\n        return format!(\"DeepSeek R1{}\", suffix);\n    }\n    if normalized.contains(\"deepseek\") {\n        return format!(\"DeepSeek{}\", suffix);\n    }\n\n    let mut fallback = cleaned;\n    let fallback_lower = fallback.to_lowercase();\n    if fallback_lower.starts_with(\"claude-\") || fallback_lower.starts_with(\"claude_\") {\n        fallback = format!(\"Claude {}\", \u0026fallback[7..]);\n    } else if fallback_lower.starts_with(\"gpt-\") || fallback_lower.starts_with(\"gpt_\") {\n        fallback = format!(\"GPT-{}\", \u0026fallback[4..]);\n    } else if fallback_lower.starts_with(\"gemini-\") || fallback_lower.starts_with(\"gemini_\") {\n        fallback = format!(\"Gemini {}\", \u0026fallback[7..]);\n    } else if fallback_lower.starts_with(\"grok-\") || fallback_lower.starts_with(\"grok_\") {\n        fallback = format!(\"Grok Code {}\", \u0026fallback[5..]);\n    }\n\n    let base_name = fallback\n        .split(['-', '_'])\n        .filter(|word| !word.is_empty())\n        .map(capitalize_word)\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\" \")\n        .trim()\n        .to_string();\n\n    if base_name.is_empty() {\n        format!(\"{}{}\", model, suffix)\n    } else {\n        format!(\"{}{}\", base_name, suffix)\n    }\n}\n\nfn exact_model_display_name(model: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    match model {\n        \"claude-sonnet-4-20250514\" =\u003e Some(\"Claude Sonnet 4\"),\n        \"claude-3-5-sonnet-20241022\" =\u003e Some(\"Claude 3.5 Sonnet\"),\n        \"claude-3-5-sonnet-20240620\" =\u003e Some(\"Claude 3.5 Sonnet\"),\n        \"claude-3-opus-20240229\" =\u003e Some(\"Claude 3 Opus\"),\n        \"claude-3-haiku-20240307\" =\u003e Some(\"Claude 3 Haiku\"),\n        \"gpt-4o\" =\u003e Some(\"GPT-4o\"),\n        \"gpt-4o-mini\" =\u003e Some(\"GPT-4o Mini\"),\n        \"gpt-4-turbo\" =\u003e Some(\"GPT-4 Turbo\"),\n        \"o1\" =\u003e Some(\"o1\"),\n        \"o1-mini\" =\u003e Some(\"o1 Mini\"),\n        \"o1-preview\" =\u003e Some(\"o1 Preview\"),\n        \"o3-mini\" =\u003e Some(\"o3 Mini\"),\n        \"gemini-2.5-pro\" =\u003e Some(\"Gemini 2.5 Pro\"),\n        \"gemini-2.5-flash\" =\u003e Some(\"Gemini 2.5 Flash\"),\n        \"gemini-2.0-flash\" =\u003e Some(\"Gemini 2.0 Flash\"),\n        \"gemini-1.5-pro\" =\u003e Some(\"Gemini 1.5 Pro\"),\n        \"gemini-1.5-flash\" =\u003e Some(\"Gemini 1.5 Flash\"),\n        \"grok-3\" =\u003e Some(\"Grok 3\"),\n        \"grok-3-mini\" =\u003e Some(\"Grok 3 Mini\"),\n        _ =\u003e None,\n    }\n}\n\nfn split_quality_suffix(model: \u0026str) -\u003e (String, String) {\n    let lower = model.to_lowercase();\n\n    for (needle, label) in [\n        (\"-high\", \" High\"),\n        (\"_high\", \" High\"),\n        (\"-medium\", \" Medium\"),\n        (\"_medium\", \" Medium\"),\n        (\"-low\", \" Low\"),\n        (\"_low\", \" Low\"),\n    ] {\n        if lower.ends_with(needle) {\n            let base = model[..model.len() - needle.len()].to_string();\n            return (base, label.to_string());\n        }\n    }\n\n    (model.to_string(), String::new())\n}\n\nfn strip_date_suffix(mut model: String) -\u003e String {\n    let lower = model.to_lowercase();\n    if lower.len() \u003e 9 {\n        if let Some(last_dash) = model.rfind('-') {\n            let tail = \u0026model[last_dash + 1..];\n            if tail.len() == 8 \u0026\u0026 tail.chars().all(|ch| ch.is_ascii_digit()) {\n                model.truncate(last_dash);\n            }\n        }\n    }\n\n    if let Some(last_dash) = model.rfind('-') {\n        let tail = \u0026model[last_dash + 1..];\n        if tail.chars().all(|ch| ch.is_ascii_digit()) {\n            if let Some(prev_dash) = model[..last_dash].rfind('-') {\n                let prev_tail = \u0026model[prev_dash + 1..last_dash];\n                if prev_tail.starts_with(\"20\")\n                    \u0026\u0026 prev_tail.len() \u003e= 8\n                    \u0026\u0026 prev_tail.len() \u003c= 10\n                    \u0026\u0026 prev_tail.chars().all(|ch| ch.is_ascii_digit())\n                {\n                    model.truncate(prev_dash);\n                }\n            }\n        }\n    }\n\n    model\n}\n\nfn capitalize_word(word: \u0026str) -\u003e String {\n    if word.is_empty() {\n        return String::new();\n    }\n\n    let mut chars = word.chars();\n    let Some(first) = chars.next() else {\n        return String::new();\n    };\n\n    let mut result = String::new();\n    result.extend(first.to_uppercase());\n    result.push_str(\u0026chars.as_str().to_lowercase());\n    result\n}\n\nfn truncate_username(username: \u0026str, max_chars: usize) -\u003e Option\u003cString\u003e {\n    if username.is_empty() {\n        return None;\n    }\n\n    let len = username.chars().count();\n    if len \u003c= max_chars {\n        return Some(username.to_string());\n    }\n\n    if max_chars \u003c= 1 {\n        return Some(\"\\u{2026}\".to_string());\n    }\n\n    let truncated = username.chars().take(max_chars - 1).collect::\u003cString\u003e();\n    Some(format!(\"{}\\u{2026}\", truncated))\n}\n\nfn default_sources() -\u003e Vec\u003cString\u003e {\n    vec![\n        \"opencode\".to_string(),\n        \"claude\".to_string(),\n        \"codex\".to_string(),\n        \"gemini\".to_string(),\n        \"cursor\".to_string(),\n        \"amp\".to_string(),\n        \"droid\".to_string(),\n        \"openclaw\".to_string(),\n        \"pi\".to_string(),\n    ]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    // ========== format_tokens_short tests ==========\n\n    #[test]\n    fn test_format_tokens_short_billions() {\n        assert_eq!(format_tokens_short(1_500_000_000), \"1.50B\");\n        assert_eq!(format_tokens_short(2_340_000_000), \"2.34B\");\n        assert_eq!(format_tokens_short(10_000_000_000), \"10.00B\");\n    }\n\n    #[test]\n    fn test_format_tokens_short_millions() {\n        assert_eq!(format_tokens_short(234_000_000), \"234.00M\");\n        assert_eq!(format_tokens_short(1_500_000), \"1.50M\");\n        assert_eq!(format_tokens_short(999_999_999), \"1000.00M\");\n    }\n\n    #[test]\n    fn test_format_tokens_short_thousands() {\n        assert_eq!(format_tokens_short(5_678), \"5.7K\");\n        assert_eq!(format_tokens_short(1_000), \"1.0K\");\n        assert_eq!(format_tokens_short(999_999), \"1000.0K\");\n    }\n\n    #[test]\n    fn test_format_tokens_short_small_numbers() {\n        assert_eq!(format_tokens_short(123), \"123\");\n        assert_eq!(format_tokens_short(0), \"0\");\n        assert_eq!(format_tokens_short(999), \"999\");\n    }\n\n    // ========== format_cost tests ==========\n\n    #[test]\n    fn test_format_cost_standard() {\n        assert_eq!(format_cost(12.34), \"$12.34\");\n        assert_eq!(format_cost(0.99), \"$0.99\");\n        assert_eq!(format_cost(100.00), \"$100.00\");\n    }\n\n    #[test]\n    fn test_format_cost_thousands() {\n        assert_eq!(format_cost(1234.56), \"$1.23K\");\n        assert_eq!(format_cost(5000.00), \"$5.00K\");\n        assert_eq!(format_cost(999.99), \"$999.99\");\n    }\n\n    #[test]\n    fn test_format_cost_zero() {\n        assert_eq!(format_cost(0.0), \"$0.00\");\n    }\n\n    // ========== format_number_with_commas_i64 tests ==========\n\n    #[test]\n    fn test_format_number_with_commas_i64_large() {\n        assert_eq!(format_number_with_commas_i64(1_234_567), \"1,234,567\");\n        assert_eq!(format_number_with_commas_i64(1_000_000_000), \"1,000,000,000\");\n    }\n\n    #[test]\n    fn test_format_number_with_commas_i64_small() {\n        assert_eq!(format_number_with_commas_i64(100), \"100\");\n        assert_eq!(format_number_with_commas_i64(999), \"999\");\n    }\n\n    #[test]\n    fn test_format_number_with_commas_i64_negative() {\n        assert_eq!(format_number_with_commas_i64(-1_234_567), \"-1,234,567\");\n        assert_eq!(format_number_with_commas_i64(-100), \"-100\");\n    }\n\n    #[test]\n    fn test_format_number_with_commas_i64_zero() {\n        assert_eq!(format_number_with_commas_i64(0), \"0\");\n    }\n\n    // ========== truncate_username tests ==========\n\n    #[test]\n    fn test_truncate_username_long() {\n        assert_eq!(\n            truncate_username(\"very_long_username\", 10),\n            Some(\"very_longâ€¦\".to_string())\n        );\n        assert_eq!(\n            truncate_username(\"abcdefghijklmnop\", 8),\n            Some(\"abcdefgâ€¦\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_truncate_username_short() {\n        assert_eq!(truncate_username(\"short\", 10), Some(\"short\".to_string()));\n        assert_eq!(truncate_username(\"user\", 4), Some(\"user\".to_string()));\n    }\n\n    #[test]\n    fn test_truncate_username_empty() {\n        assert_eq!(truncate_username(\"\", 10), None);\n    }\n\n    #[test]\n    fn test_truncate_username_edge_cases() {\n        assert_eq!(truncate_username(\"a\", 1), Some(\"a\".to_string()));\n        assert_eq!(truncate_username(\"ab\", 1), Some(\"â€¦\".to_string()));\n    }\n\n    // ========== capitalize_word tests ==========\n\n    #[test]\n    fn test_capitalize_word_lowercase() {\n        assert_eq!(capitalize_word(\"hello\"), \"Hello\");\n        assert_eq!(capitalize_word(\"world\"), \"World\");\n    }\n\n    #[test]\n    fn test_capitalize_word_uppercase() {\n        assert_eq!(capitalize_word(\"WORLD\"), \"World\");\n        assert_eq!(capitalize_word(\"HELLO\"), \"Hello\");\n    }\n\n    #[test]\n    fn test_capitalize_word_mixed() {\n        assert_eq!(capitalize_word(\"hElLo\"), \"Hello\");\n        assert_eq!(capitalize_word(\"WoRlD\"), \"World\");\n    }\n\n    #[test]\n    fn test_capitalize_word_empty() {\n        assert_eq!(capitalize_word(\"\"), \"\");\n    }\n\n    #[test]\n    fn test_capitalize_word_single_char() {\n        assert_eq!(capitalize_word(\"a\"), \"A\");\n        assert_eq!(capitalize_word(\"Z\"), \"Z\");\n    }\n\n    // ========== strip_date_suffix tests ==========\n\n    #[test]\n    fn test_strip_date_suffix_with_date() {\n        assert_eq!(\n            strip_date_suffix(\"claude-4-20250514\".to_string()),\n            \"claude-4\"\n        );\n        assert_eq!(\n            strip_date_suffix(\"gpt-4-20240101\".to_string()),\n            \"gpt-4\"\n        );\n    }\n\n    #[test]\n    fn test_strip_date_suffix_without_date() {\n        assert_eq!(strip_date_suffix(\"gpt-5\".to_string()), \"gpt-5\");\n        assert_eq!(strip_date_suffix(\"claude-opus\".to_string()), \"claude-opus\");\n    }\n\n    #[test]\n    fn test_strip_date_suffix_complex() {\n        assert_eq!(\n            strip_date_suffix(\"model-2024-01-15-123\".to_string()),\n            \"model-2024-01-15-123\"\n        );\n    }\n\n    // ========== split_quality_suffix tests ==========\n\n    #[test]\n    fn test_split_quality_suffix_high() {\n        assert_eq!(\n            split_quality_suffix(\"model-high\"),\n            (\"model\".to_string(), \" High\".to_string())\n        );\n        assert_eq!(\n            split_quality_suffix(\"gpt-4_high\"),\n            (\"gpt-4\".to_string(), \" High\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_split_quality_suffix_medium() {\n        assert_eq!(\n            split_quality_suffix(\"model-medium\"),\n            (\"model\".to_string(), \" Medium\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_split_quality_suffix_low() {\n        assert_eq!(\n            split_quality_suffix(\"model-low\"),\n            (\"model\".to_string(), \" Low\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_split_quality_suffix_none() {\n        assert_eq!(\n            split_quality_suffix(\"model\"),\n            (\"model\".to_string(), String::new())\n        );\n        assert_eq!(\n            split_quality_suffix(\"gpt-4\"),\n            (\"gpt-4\".to_string(), String::new())\n        );\n    }\n\n    // ========== format_model_name tests ==========\n\n    #[test]\n    fn test_format_model_name_claude() {\n        assert_eq!(\n            format_model_name(\"claude-sonnet-4-20250514\"),\n            \"Claude Sonnet 4\"\n        );\n        assert_eq!(\n            format_model_name(\"claude-3-5-sonnet-20241022\"),\n            \"Claude 3.5 Sonnet\"\n        );\n        assert_eq!(\n            format_model_name(\"claude-3-opus-20240229\"),\n            \"Claude 3 Opus\"\n        );\n    }\n\n    #[test]\n    fn test_format_model_name_gpt() {\n        assert_eq!(format_model_name(\"gpt-4o\"), \"GPT-4o\");\n        assert_eq!(format_model_name(\"gpt-4o-mini\"), \"GPT-4o Mini\");\n        assert_eq!(format_model_name(\"gpt-5\"), \"GPT-5\");\n    }\n\n    #[test]\n    fn test_format_model_name_gemini() {\n        assert_eq!(format_model_name(\"gemini-2.5-pro\"), \"Gemini 2.5 Pro\");\n        assert_eq!(format_model_name(\"gemini-1.5-flash\"), \"Gemini 1.5 Flash\");\n    }\n\n    #[test]\n    fn test_format_model_name_with_quality_suffix() {\n        assert_eq!(format_model_name(\"gpt-4-high\"), \"GPT-4 High\");\n        assert_eq!(format_model_name(\"claude-opus-low\"), \"Claude opus Low\");\n    }\n\n    // ========== get_provider_from_model tests ==========\n\n    #[test]\n    fn test_get_provider_from_model_anthropic() {\n        assert_eq!(get_provider_from_model(\"claude-3-opus\"), Some(\"anthropic\"));\n        assert_eq!(get_provider_from_model(\"sonnet-4\"), Some(\"anthropic\"));\n        assert_eq!(get_provider_from_model(\"haiku-3.5\"), Some(\"anthropic\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_openai() {\n        assert_eq!(get_provider_from_model(\"gpt-4\"), Some(\"openai\"));\n        assert_eq!(get_provider_from_model(\"o1-preview\"), Some(\"openai\"));\n        assert_eq!(get_provider_from_model(\"codex-001\"), Some(\"openai\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_google() {\n        assert_eq!(get_provider_from_model(\"gemini-pro\"), Some(\"google\"));\n        assert_eq!(get_provider_from_model(\"gemini-2.5-flash\"), Some(\"google\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_xai() {\n        assert_eq!(get_provider_from_model(\"grok-3\"), Some(\"xai\"));\n        assert_eq!(get_provider_from_model(\"grok-code\"), Some(\"xai\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_zai() {\n        assert_eq!(get_provider_from_model(\"glm-4.7\"), Some(\"zai\"));\n        assert_eq!(get_provider_from_model(\"pickle-model\"), Some(\"zai\"));\n    }\n\n    #[test]\n    fn test_get_provider_from_model_unknown() {\n        assert_eq!(get_provider_from_model(\"unknown-model\"), None);\n        assert_eq!(get_provider_from_model(\"random-123\"), None);\n    }\n\n    // ========== calculate_intensity tests ==========\n\n    #[test]\n    fn test_calculate_intensity_grade4() {\n        assert_eq!(calculate_intensity(100.0, 100.0), 4);\n        assert_eq!(calculate_intensity(75.0, 100.0), 4);\n        assert_eq!(calculate_intensity(80.0, 100.0), 4);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade3() {\n        assert_eq!(calculate_intensity(50.0, 100.0), 3);\n        assert_eq!(calculate_intensity(60.0, 100.0), 3);\n        assert_eq!(calculate_intensity(74.9, 100.0), 3);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade2() {\n        assert_eq!(calculate_intensity(25.0, 100.0), 2);\n        assert_eq!(calculate_intensity(30.0, 100.0), 2);\n        assert_eq!(calculate_intensity(49.9, 100.0), 2);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade1() {\n        assert_eq!(calculate_intensity(10.0, 100.0), 1);\n        assert_eq!(calculate_intensity(24.9, 100.0), 1);\n        assert_eq!(calculate_intensity(0.1, 100.0), 1);\n    }\n\n    #[test]\n    fn test_calculate_intensity_grade0() {\n        assert_eq!(calculate_intensity(0.0, 100.0), 0);\n        assert_eq!(calculate_intensity(0.0, 0.0), 0);\n    }\n\n    // ========== calculate_streaks tests ==========\n\n    #[test]\n    fn test_calculate_streaks_consecutive() {\n        let dates = vec![\n            \"2024-01-01\".to_string(),\n            \"2024-01-02\".to_string(),\n            \"2024-01-03\".to_string(),\n            \"2024-01-04\".to_string(),\n        ];\n        let (_current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(longest, 4);\n    }\n\n    #[test]\n    fn test_calculate_streaks_with_gaps() {\n        let dates = vec![\n            \"2024-01-01\".to_string(),\n            \"2024-01-02\".to_string(),\n            \"2024-01-05\".to_string(),\n            \"2024-01-06\".to_string(),\n            \"2024-01-07\".to_string(),\n        ];\n        let (_current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(longest, 3);\n    }\n\n    #[test]\n    fn test_calculate_streaks_empty() {\n        let dates: Vec\u003cString\u003e = vec![];\n        let (current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(current, 0);\n        assert_eq!(longest, 0);\n    }\n\n    #[test]\n    fn test_calculate_streaks_single_day() {\n        let dates = vec![\"2024-01-01\".to_string()];\n        let (_current, longest) = calculate_streaks(\u0026dates);\n        assert_eq!(longest, 1);\n    }\n\n    // ========== date_diff_days tests ==========\n\n    #[test]\n    fn test_date_diff_days_forward() {\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-01-10\"), 9);\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-01-02\"), 1);\n    }\n\n    #[test]\n    fn test_date_diff_days_backward() {\n        assert_eq!(date_diff_days(\"2024-01-10\", \"2024-01-01\"), 9);\n        assert_eq!(date_diff_days(\"2024-01-02\", \"2024-01-01\"), 1);\n    }\n\n    #[test]\n    fn test_date_diff_days_same_day() {\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-01-01\"), 0);\n    }\n\n    #[test]\n    fn test_date_diff_days_invalid() {\n        assert_eq!(date_diff_days(\"invalid\", \"2024-01-01\"), 0);\n        assert_eq!(date_diff_days(\"2024-01-01\", \"invalid\"), 0);\n        assert_eq!(date_diff_days(\"invalid\", \"invalid\"), 0);\n    }\n\n    #[test]\n    fn test_date_diff_days_cross_month() {\n        assert_eq!(date_diff_days(\"2024-01-31\", \"2024-02-01\"), 1);\n        assert_eq!(date_diff_days(\"2024-01-01\", \"2024-02-01\"), 31);\n    }\n}\n","traces":[{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":793,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":808,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":811,"address":[],"length":0,"stats":{"Line":0}},{"line":814,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":828,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":831,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":839,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":854,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":873,"address":[],"length":0,"stats":{"Line":0}},{"line":874,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":885,"address":[],"length":0,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":893,"address":[],"length":0,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":899,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":903,"address":[],"length":0,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":912,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[],"length":0,"stats":{"Line":0}},{"line":925,"address":[],"length":0,"stats":{"Line":0}},{"line":930,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":955,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[],"length":0,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":982,"address":[],"length":0,"stats":{"Line":0}},{"line":984,"address":[],"length":0,"stats":{"Line":0}},{"line":985,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":987,"address":[],"length":0,"stats":{"Line":0}},{"line":988,"address":[],"length":0,"stats":{"Line":0}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":990,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":997,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1000,"address":[],"length":0,"stats":{"Line":0}},{"line":1001,"address":[],"length":0,"stats":{"Line":0}},{"line":1002,"address":[],"length":0,"stats":{"Line":0}},{"line":1003,"address":[],"length":0,"stats":{"Line":0}},{"line":1006,"address":[],"length":0,"stats":{"Line":0}},{"line":1007,"address":[],"length":0,"stats":{"Line":0}},{"line":1013,"address":[],"length":0,"stats":{"Line":0}},{"line":1022,"address":[],"length":0,"stats":{"Line":0}},{"line":1023,"address":[],"length":0,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1032,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1034,"address":[],"length":0,"stats":{"Line":0}},{"line":1035,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1045,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[],"length":0,"stats":{"Line":0}},{"line":1047,"address":[],"length":0,"stats":{"Line":0}},{"line":1050,"address":[],"length":0,"stats":{"Line":0}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1052,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[],"length":0,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1070,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1075,"address":[],"length":0,"stats":{"Line":0}},{"line":1076,"address":[],"length":0,"stats":{"Line":0}},{"line":1077,"address":[],"length":0,"stats":{"Line":0}},{"line":1078,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1080,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1087,"address":[],"length":0,"stats":{"Line":0}},{"line":1088,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1094,"address":[],"length":0,"stats":{"Line":0}},{"line":1096,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1100,"address":[],"length":0,"stats":{"Line":0}},{"line":1101,"address":[],"length":0,"stats":{"Line":0}},{"line":1103,"address":[],"length":0,"stats":{"Line":0}},{"line":1105,"address":[],"length":0,"stats":{"Line":0}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1115,"address":[],"length":0,"stats":{"Line":0}},{"line":1116,"address":[],"length":0,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1120,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1135,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":0}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1139,"address":[],"length":0,"stats":{"Line":0}},{"line":1142,"address":[],"length":0,"stats":{"Line":0}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1151,"address":[],"length":0,"stats":{"Line":0}},{"line":1152,"address":[],"length":0,"stats":{"Line":0}},{"line":1154,"address":[],"length":0,"stats":{"Line":0}},{"line":1155,"address":[],"length":0,"stats":{"Line":0}},{"line":1156,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1162,"address":[],"length":0,"stats":{"Line":0}},{"line":1163,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1165,"address":[],"length":0,"stats":{"Line":0}},{"line":1168,"address":[],"length":0,"stats":{"Line":0}},{"line":1169,"address":[],"length":0,"stats":{"Line":0}},{"line":1170,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1173,"address":[],"length":0,"stats":{"Line":0}},{"line":1174,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1180,"address":[],"length":0,"stats":{"Line":0}},{"line":1181,"address":[],"length":0,"stats":{"Line":0}},{"line":1182,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1194,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1199,"address":[],"length":0,"stats":{"Line":0}},{"line":1200,"address":[],"length":0,"stats":{"Line":0}},{"line":1203,"address":[],"length":0,"stats":{"Line":0}},{"line":1204,"address":[],"length":0,"stats":{"Line":0}},{"line":1205,"address":[],"length":0,"stats":{"Line":0}},{"line":1208,"address":[],"length":0,"stats":{"Line":0}},{"line":1209,"address":[],"length":0,"stats":{"Line":0}},{"line":1210,"address":[],"length":0,"stats":{"Line":0}},{"line":1214,"address":[],"length":0,"stats":{"Line":0}},{"line":1217,"address":[],"length":0,"stats":{"Line":0}},{"line":1220,"address":[],"length":0,"stats":{"Line":0}},{"line":1221,"address":[],"length":0,"stats":{"Line":0}},{"line":1222,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":0}},{"line":1226,"address":[],"length":0,"stats":{"Line":0}},{"line":1227,"address":[],"length":0,"stats":{"Line":0}},{"line":1228,"address":[],"length":0,"stats":{"Line":0}},{"line":1231,"address":[],"length":0,"stats":{"Line":0}},{"line":1232,"address":[],"length":0,"stats":{"Line":0}},{"line":1233,"address":[],"length":0,"stats":{"Line":0}},{"line":1236,"address":[],"length":0,"stats":{"Line":0}},{"line":1237,"address":[],"length":0,"stats":{"Line":0}},{"line":1238,"address":[],"length":0,"stats":{"Line":0}},{"line":1241,"address":[],"length":0,"stats":{"Line":0}},{"line":1242,"address":[],"length":0,"stats":{"Line":0}},{"line":1243,"address":[],"length":0,"stats":{"Line":0}},{"line":1244,"address":[],"length":0,"stats":{"Line":0}},{"line":1245,"address":[],"length":0,"stats":{"Line":0}},{"line":1246,"address":[],"length":0,"stats":{"Line":0}},{"line":1247,"address":[],"length":0,"stats":{"Line":0}},{"line":1249,"address":[],"length":0,"stats":{"Line":0}},{"line":1253,"address":[],"length":0,"stats":{"Line":0}},{"line":1254,"address":[],"length":0,"stats":{"Line":0}},{"line":1255,"address":[],"length":0,"stats":{"Line":0}},{"line":1258,"address":[],"length":0,"stats":{"Line":0}},{"line":1259,"address":[],"length":0,"stats":{"Line":0}},{"line":1260,"address":[],"length":0,"stats":{"Line":0}},{"line":1261,"address":[],"length":0,"stats":{"Line":0}},{"line":1263,"address":[],"length":0,"stats":{"Line":0}},{"line":1264,"address":[],"length":0,"stats":{"Line":0}},{"line":1265,"address":[],"length":0,"stats":{"Line":0}},{"line":1266,"address":[],"length":0,"stats":{"Line":0}},{"line":1267,"address":[],"length":0,"stats":{"Line":0}},{"line":1269,"address":[],"length":0,"stats":{"Line":0}},{"line":1272,"address":[],"length":0,"stats":{"Line":0}},{"line":1273,"address":[],"length":0,"stats":{"Line":0}},{"line":1274,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1281,"address":[],"length":0,"stats":{"Line":0}},{"line":1282,"address":[],"length":0,"stats":{"Line":0}},{"line":1283,"address":[],"length":0,"stats":{"Line":0}},{"line":1284,"address":[],"length":0,"stats":{"Line":0}},{"line":1286,"address":[],"length":0,"stats":{"Line":0}},{"line":1287,"address":[],"length":0,"stats":{"Line":0}},{"line":1290,"address":[],"length":0,"stats":{"Line":0}},{"line":1292,"address":[],"length":0,"stats":{"Line":0}},{"line":1295,"address":[],"length":0,"stats":{"Line":0}},{"line":1296,"address":[],"length":0,"stats":{"Line":0}},{"line":1297,"address":[],"length":0,"stats":{"Line":0}},{"line":1299,"address":[],"length":0,"stats":{"Line":0}},{"line":1300,"address":[],"length":0,"stats":{"Line":0}},{"line":1301,"address":[],"length":0,"stats":{"Line":0}},{"line":1305,"address":[],"length":0,"stats":{"Line":0}},{"line":1306,"address":[],"length":0,"stats":{"Line":0}},{"line":1307,"address":[],"length":0,"stats":{"Line":0}},{"line":1308,"address":[],"length":0,"stats":{"Line":0}},{"line":1309,"address":[],"length":0,"stats":{"Line":0}},{"line":1310,"address":[],"length":0,"stats":{"Line":0}},{"line":1311,"address":[],"length":0,"stats":{"Line":0}},{"line":1313,"address":[],"length":0,"stats":{"Line":0}},{"line":1317,"address":[],"length":0,"stats":{"Line":0}},{"line":1318,"address":[],"length":0,"stats":{"Line":0}},{"line":1319,"address":[],"length":0,"stats":{"Line":0}},{"line":1321,"address":[],"length":0,"stats":{"Line":0}},{"line":1325,"address":[],"length":0,"stats":{"Line":0}},{"line":1326,"address":[],"length":0,"stats":{"Line":0}},{"line":1327,"address":[],"length":0,"stats":{"Line":0}},{"line":1328,"address":[],"length":0,"stats":{"Line":0}},{"line":1330,"address":[],"length":0,"stats":{"Line":0}},{"line":1331,"address":[],"length":0,"stats":{"Line":0}},{"line":1332,"address":[],"length":0,"stats":{"Line":0}},{"line":1333,"address":[],"length":0,"stats":{"Line":0}},{"line":1335,"address":[],"length":0,"stats":{"Line":0}},{"line":1338,"address":[],"length":0,"stats":{"Line":0}},{"line":1341,"address":[],"length":0,"stats":{"Line":0}},{"line":1342,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1345,"address":[],"length":0,"stats":{"Line":0}},{"line":1346,"address":[],"length":0,"stats":{"Line":0}},{"line":1347,"address":[],"length":0,"stats":{"Line":0}},{"line":1348,"address":[],"length":0,"stats":{"Line":0}},{"line":1349,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1351,"address":[],"length":0,"stats":{"Line":0}},{"line":1352,"address":[],"length":0,"stats":{"Line":0}},{"line":1356,"address":[],"length":0,"stats":{"Line":0}},{"line":1357,"address":[],"length":0,"stats":{"Line":0}},{"line":1358,"address":[],"length":0,"stats":{"Line":0}},{"line":1359,"address":[],"length":0,"stats":{"Line":0}},{"line":1360,"address":[],"length":0,"stats":{"Line":0}},{"line":1361,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1365,"address":[],"length":0,"stats":{"Line":0}},{"line":1366,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1371,"address":[],"length":0,"stats":{"Line":0}},{"line":1372,"address":[],"length":0,"stats":{"Line":0}},{"line":1373,"address":[],"length":0,"stats":{"Line":0}},{"line":1374,"address":[],"length":0,"stats":{"Line":0}},{"line":1375,"address":[],"length":0,"stats":{"Line":0}},{"line":1376,"address":[],"length":0,"stats":{"Line":0}},{"line":1377,"address":[],"length":0,"stats":{"Line":0}},{"line":1378,"address":[],"length":0,"stats":{"Line":0}},{"line":1382,"address":[],"length":0,"stats":{"Line":0}},{"line":1383,"address":[],"length":0,"stats":{"Line":0}},{"line":1384,"address":[],"length":0,"stats":{"Line":0}},{"line":1385,"address":[],"length":0,"stats":{"Line":0}},{"line":1386,"address":[],"length":0,"stats":{"Line":0}},{"line":1387,"address":[],"length":0,"stats":{"Line":0}},{"line":1389,"address":[],"length":0,"stats":{"Line":0}},{"line":1391,"address":[],"length":0,"stats":{"Line":0}},{"line":1392,"address":[],"length":0,"stats":{"Line":0}},{"line":1393,"address":[],"length":0,"stats":{"Line":0}},{"line":1394,"address":[],"length":0,"stats":{"Line":0}},{"line":1396,"address":[],"length":0,"stats":{"Line":0}},{"line":1398,"address":[],"length":0,"stats":{"Line":0}},{"line":1399,"address":[],"length":0,"stats":{"Line":0}},{"line":1401,"address":[],"length":0,"stats":{"Line":0}},{"line":1402,"address":[],"length":0,"stats":{"Line":0}},{"line":1404,"address":[],"length":0,"stats":{"Line":0}},{"line":1405,"address":[],"length":0,"stats":{"Line":0}},{"line":1407,"address":[],"length":0,"stats":{"Line":0}},{"line":1410,"address":[],"length":0,"stats":{"Line":0}},{"line":1411,"address":[],"length":0,"stats":{"Line":0}},{"line":1412,"address":[],"length":0,"stats":{"Line":0}},{"line":1415,"address":[],"length":0,"stats":{"Line":0}},{"line":1416,"address":[],"length":0,"stats":{"Line":0}},{"line":1418,"address":[],"length":0,"stats":{"Line":0}},{"line":1419,"address":[],"length":0,"stats":{"Line":0}},{"line":1420,"address":[],"length":0,"stats":{"Line":0}},{"line":1421,"address":[],"length":0,"stats":{"Line":0}},{"line":1422,"address":[],"length":0,"stats":{"Line":0}},{"line":1423,"address":[],"length":0,"stats":{"Line":0}},{"line":1425,"address":[],"length":0,"stats":{"Line":0}},{"line":1429,"address":[],"length":0,"stats":{"Line":0}},{"line":1430,"address":[],"length":0,"stats":{"Line":0}},{"line":1431,"address":[],"length":0,"stats":{"Line":0}},{"line":1432,"address":[],"length":0,"stats":{"Line":0}},{"line":1435,"address":[],"length":0,"stats":{"Line":0}},{"line":1437,"address":[],"length":0,"stats":{"Line":0}},{"line":1440,"address":[],"length":0,"stats":{"Line":0}},{"line":1443,"address":[],"length":0,"stats":{"Line":0}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":0}},{"line":1447,"address":[],"length":0,"stats":{"Line":0}},{"line":1449,"address":[],"length":0,"stats":{"Line":0}},{"line":1450,"address":[],"length":0,"stats":{"Line":0}},{"line":1452,"address":[],"length":0,"stats":{"Line":0}},{"line":1453,"address":[],"length":0,"stats":{"Line":0}},{"line":1455,"address":[],"length":0,"stats":{"Line":0}},{"line":1456,"address":[],"length":0,"stats":{"Line":0}},{"line":1458,"address":[],"length":0,"stats":{"Line":0}},{"line":1459,"address":[],"length":0,"stats":{"Line":0}},{"line":1461,"address":[],"length":0,"stats":{"Line":0}},{"line":1462,"address":[],"length":0,"stats":{"Line":0}},{"line":1464,"address":[],"length":0,"stats":{"Line":0}},{"line":1465,"address":[],"length":0,"stats":{"Line":0}},{"line":1467,"address":[],"length":0,"stats":{"Line":0}},{"line":1468,"address":[],"length":0,"stats":{"Line":0}},{"line":1470,"address":[],"length":0,"stats":{"Line":0}},{"line":1471,"address":[],"length":0,"stats":{"Line":0}},{"line":1473,"address":[],"length":0,"stats":{"Line":0}},{"line":1474,"address":[],"length":0,"stats":{"Line":0}},{"line":1476,"address":[],"length":0,"stats":{"Line":0}},{"line":1477,"address":[],"length":0,"stats":{"Line":0}},{"line":1479,"address":[],"length":0,"stats":{"Line":0}},{"line":1480,"address":[],"length":0,"stats":{"Line":0}},{"line":1482,"address":[],"length":0,"stats":{"Line":0}},{"line":1483,"address":[],"length":0,"stats":{"Line":0}},{"line":1485,"address":[],"length":0,"stats":{"Line":0}},{"line":1486,"address":[],"length":0,"stats":{"Line":0}},{"line":1488,"address":[],"length":0,"stats":{"Line":0}},{"line":1489,"address":[],"length":0,"stats":{"Line":0}},{"line":1491,"address":[],"length":0,"stats":{"Line":0}},{"line":1492,"address":[],"length":0,"stats":{"Line":0}},{"line":1494,"address":[],"length":0,"stats":{"Line":0}},{"line":1495,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":0}},{"line":1498,"address":[],"length":0,"stats":{"Line":0}},{"line":1500,"address":[],"length":0,"stats":{"Line":0}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1503,"address":[],"length":0,"stats":{"Line":0}},{"line":1504,"address":[],"length":0,"stats":{"Line":0}},{"line":1506,"address":[],"length":0,"stats":{"Line":0}},{"line":1507,"address":[],"length":0,"stats":{"Line":0}},{"line":1509,"address":[],"length":0,"stats":{"Line":0}},{"line":1510,"address":[],"length":0,"stats":{"Line":0}},{"line":1512,"address":[],"length":0,"stats":{"Line":0}},{"line":1513,"address":[],"length":0,"stats":{"Line":0}},{"line":1515,"address":[],"length":0,"stats":{"Line":0}},{"line":1516,"address":[],"length":0,"stats":{"Line":0}},{"line":1518,"address":[],"length":0,"stats":{"Line":0}},{"line":1519,"address":[],"length":0,"stats":{"Line":0}},{"line":1521,"address":[],"length":0,"stats":{"Line":0}},{"line":1522,"address":[],"length":0,"stats":{"Line":0}},{"line":1524,"address":[],"length":0,"stats":{"Line":0}},{"line":1525,"address":[],"length":0,"stats":{"Line":0}},{"line":1527,"address":[],"length":0,"stats":{"Line":0}},{"line":1528,"address":[],"length":0,"stats":{"Line":0}},{"line":1530,"address":[],"length":0,"stats":{"Line":0}},{"line":1531,"address":[],"length":0,"stats":{"Line":0}},{"line":1533,"address":[],"length":0,"stats":{"Line":0}},{"line":1534,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":0}},{"line":1537,"address":[],"length":0,"stats":{"Line":0}},{"line":1539,"address":[],"length":0,"stats":{"Line":0}},{"line":1540,"address":[],"length":0,"stats":{"Line":0}},{"line":1542,"address":[],"length":0,"stats":{"Line":0}},{"line":1543,"address":[],"length":0,"stats":{"Line":0}},{"line":1545,"address":[],"length":0,"stats":{"Line":0}},{"line":1546,"address":[],"length":0,"stats":{"Line":0}},{"line":1548,"address":[],"length":0,"stats":{"Line":0}},{"line":1549,"address":[],"length":0,"stats":{"Line":0}},{"line":1551,"address":[],"length":0,"stats":{"Line":0}},{"line":1552,"address":[],"length":0,"stats":{"Line":0}},{"line":1554,"address":[],"length":0,"stats":{"Line":0}},{"line":1555,"address":[],"length":0,"stats":{"Line":0}},{"line":1557,"address":[],"length":0,"stats":{"Line":0}},{"line":1558,"address":[],"length":0,"stats":{"Line":0}},{"line":1561,"address":[],"length":0,"stats":{"Line":0}},{"line":1562,"address":[],"length":0,"stats":{"Line":0}},{"line":1563,"address":[],"length":0,"stats":{"Line":0}},{"line":1564,"address":[],"length":0,"stats":{"Line":0}},{"line":1565,"address":[],"length":0,"stats":{"Line":0}},{"line":1566,"address":[],"length":0,"stats":{"Line":0}},{"line":1567,"address":[],"length":0,"stats":{"Line":0}},{"line":1568,"address":[],"length":0,"stats":{"Line":0}},{"line":1569,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1573,"address":[],"length":0,"stats":{"Line":0}},{"line":1574,"address":[],"length":0,"stats":{"Line":0}},{"line":1575,"address":[],"length":0,"stats":{"Line":0}},{"line":1576,"address":[],"length":0,"stats":{"Line":0}},{"line":1582,"address":[],"length":0,"stats":{"Line":0}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1585,"address":[],"length":0,"stats":{"Line":0}},{"line":1589,"address":[],"length":0,"stats":{"Line":0}},{"line":1590,"address":[],"length":0,"stats":{"Line":0}},{"line":1591,"address":[],"length":0,"stats":{"Line":0}},{"line":1592,"address":[],"length":0,"stats":{"Line":0}},{"line":1593,"address":[],"length":0,"stats":{"Line":0}},{"line":1594,"address":[],"length":0,"stats":{"Line":0}},{"line":1595,"address":[],"length":0,"stats":{"Line":0}},{"line":1596,"address":[],"length":0,"stats":{"Line":0}},{"line":1597,"address":[],"length":0,"stats":{"Line":0}},{"line":1598,"address":[],"length":0,"stats":{"Line":0}},{"line":1599,"address":[],"length":0,"stats":{"Line":0}},{"line":1600,"address":[],"length":0,"stats":{"Line":0}},{"line":1601,"address":[],"length":0,"stats":{"Line":0}},{"line":1602,"address":[],"length":0,"stats":{"Line":0}},{"line":1603,"address":[],"length":0,"stats":{"Line":0}},{"line":1604,"address":[],"length":0,"stats":{"Line":0}},{"line":1605,"address":[],"length":0,"stats":{"Line":0}},{"line":1606,"address":[],"length":0,"stats":{"Line":0}},{"line":1607,"address":[],"length":0,"stats":{"Line":0}},{"line":1608,"address":[],"length":0,"stats":{"Line":0}},{"line":1609,"address":[],"length":0,"stats":{"Line":0}},{"line":1610,"address":[],"length":0,"stats":{"Line":0}},{"line":1614,"address":[],"length":0,"stats":{"Line":0}},{"line":1615,"address":[],"length":0,"stats":{"Line":0}},{"line":1617,"address":[],"length":0,"stats":{"Line":0}},{"line":1618,"address":[],"length":0,"stats":{"Line":0}},{"line":1619,"address":[],"length":0,"stats":{"Line":0}},{"line":1620,"address":[],"length":0,"stats":{"Line":0}},{"line":1621,"address":[],"length":0,"stats":{"Line":0}},{"line":1622,"address":[],"length":0,"stats":{"Line":0}},{"line":1623,"address":[],"length":0,"stats":{"Line":0}},{"line":1625,"address":[],"length":0,"stats":{"Line":0}},{"line":1626,"address":[],"length":0,"stats":{"Line":0}},{"line":1627,"address":[],"length":0,"stats":{"Line":0}},{"line":1631,"address":[],"length":0,"stats":{"Line":0}},{"line":1634,"address":[],"length":0,"stats":{"Line":0}},{"line":1635,"address":[],"length":0,"stats":{"Line":0}},{"line":1636,"address":[],"length":0,"stats":{"Line":0}},{"line":1637,"address":[],"length":0,"stats":{"Line":0}},{"line":1638,"address":[],"length":0,"stats":{"Line":0}},{"line":1639,"address":[],"length":0,"stats":{"Line":0}},{"line":1640,"address":[],"length":0,"stats":{"Line":0}},{"line":1645,"address":[],"length":0,"stats":{"Line":0}},{"line":1646,"address":[],"length":0,"stats":{"Line":0}},{"line":1647,"address":[],"length":0,"stats":{"Line":0}},{"line":1648,"address":[],"length":0,"stats":{"Line":0}},{"line":1649,"address":[],"length":0,"stats":{"Line":0}},{"line":1650,"address":[],"length":0,"stats":{"Line":0}},{"line":1651,"address":[],"length":0,"stats":{"Line":0}},{"line":1652,"address":[],"length":0,"stats":{"Line":0}},{"line":1653,"address":[],"length":0,"stats":{"Line":0}},{"line":1655,"address":[],"length":0,"stats":{"Line":0}},{"line":1661,"address":[],"length":0,"stats":{"Line":0}},{"line":1664,"address":[],"length":0,"stats":{"Line":0}},{"line":1665,"address":[],"length":0,"stats":{"Line":0}},{"line":1666,"address":[],"length":0,"stats":{"Line":0}},{"line":1669,"address":[],"length":0,"stats":{"Line":0}},{"line":1670,"address":[],"length":0,"stats":{"Line":0}},{"line":1671,"address":[],"length":0,"stats":{"Line":0}},{"line":1674,"address":[],"length":0,"stats":{"Line":0}},{"line":1675,"address":[],"length":0,"stats":{"Line":0}},{"line":1676,"address":[],"length":0,"stats":{"Line":0}},{"line":1677,"address":[],"length":0,"stats":{"Line":0}},{"line":1680,"address":[],"length":0,"stats":{"Line":0}},{"line":1681,"address":[],"length":0,"stats":{"Line":0}},{"line":1682,"address":[],"length":0,"stats":{"Line":0}},{"line":1685,"address":[],"length":0,"stats":{"Line":0}},{"line":1686,"address":[],"length":0,"stats":{"Line":0}},{"line":1687,"address":[],"length":0,"stats":{"Line":0}},{"line":1690,"address":[],"length":0,"stats":{"Line":0}},{"line":1691,"address":[],"length":0,"stats":{"Line":0}},{"line":1694,"address":[],"length":0,"stats":{"Line":0}},{"line":1695,"address":[],"length":0,"stats":{"Line":0}},{"line":1698,"address":[],"length":0,"stats":{"Line":0}},{"line":1699,"address":[],"length":0,"stats":{"Line":0}},{"line":1700,"address":[],"length":0,"stats":{"Line":0}},{"line":1701,"address":[],"length":0,"stats":{"Line":0}},{"line":1702,"address":[],"length":0,"stats":{"Line":0}},{"line":1703,"address":[],"length":0,"stats":{"Line":0}},{"line":1704,"address":[],"length":0,"stats":{"Line":0}},{"line":1705,"address":[],"length":0,"stats":{"Line":0}},{"line":1706,"address":[],"length":0,"stats":{"Line":0}},{"line":1707,"address":[],"length":0,"stats":{"Line":0}},{"line":1708,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":981},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","cursor.rs"],"content":"use anyhow::{Context, Result};\nuse serde::{Deserialize, Serialize};\nuse sha2::{Digest, Sha256};\nuse std::collections::HashMap;\nuse std::fs;\nuse std::io::Write;\nuse std::path::PathBuf;\n\nfn home_dir() -\u003e Result\u003cPathBuf\u003e {\n    dirs::home_dir().context(\"Could not determine home directory\")\n}\n\nconst USAGE_CSV_ENDPOINT: \u0026str =\n    \"https://cursor.com/api/dashboard/export-usage-events-csv?strategy=tokens\";\nconst USAGE_SUMMARY_ENDPOINT: \u0026str = \"https://cursor.com/api/usage-summary\";\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CursorCredentials {\n    #[serde(rename = \"sessionToken\")]\n    pub session_token: String,\n    #[serde(rename = \"userId\", skip_serializing_if = \"Option::is_none\")]\n    pub user_id: Option\u003cString\u003e,\n    #[serde(rename = \"createdAt\")]\n    pub created_at: String,\n    #[serde(rename = \"expiresAt\", skip_serializing_if = \"Option::is_none\")]\n    pub expires_at: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub label: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct CursorCredentialsStore {\n    pub version: i32,\n    #[serde(rename = \"activeAccountId\")]\n    pub active_account_id: String,\n    pub accounts: HashMap\u003cString, CursorCredentials\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct AccountInfo {\n    pub id: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub label: Option\u003cString\u003e,\n    #[serde(rename = \"userId\", skip_serializing_if = \"Option::is_none\")]\n    pub user_id: Option\u003cString\u003e,\n    #[serde(rename = \"createdAt\")]\n    pub created_at: String,\n    #[serde(rename = \"isActive\")]\n    pub is_active: bool,\n}\n\n#[derive(Debug)]\npub struct SyncCursorResult {\n    pub synced: bool,\n    pub rows: usize,\n    pub error: Option\u003cString\u003e,\n}\n\npub fn get_cursor_credentials_path() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".config/tokscale/cursor-credentials.json\"))\n}\n\nfn get_old_cursor_credentials_path() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".tokscale/cursor-credentials.json\"))\n}\n\npub fn get_cursor_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".config/tokscale/cursor-cache\"))\n}\n\nfn get_old_cursor_cache_dir() -\u003e Result\u003cPathBuf\u003e {\n    Ok(home_dir()?.join(\".tokscale/cursor-cache\"))\n}\n\nfn migrate_cache_dir_from_old_path() {\n    let Ok(old_dir) = get_old_cursor_cache_dir() else {\n        return;\n    };\n    let Ok(new_dir) = get_cursor_cache_dir() else {\n        return;\n    };\n    if !new_dir.exists() \u0026\u0026 old_dir.exists() {\n        if fs::create_dir_all(\u0026new_dir).is_ok() {\n            if copy_dir_recursive(\u0026old_dir, \u0026new_dir).is_ok() {\n                let _ = fs::remove_dir_all(\u0026old_dir);\n            }\n        }\n    }\n}\n\nfn copy_dir_recursive(src: \u0026std::path::Path, dst: \u0026std::path::Path) -\u003e Result\u003c()\u003e {\n    for entry in fs::read_dir(src)? {\n        let entry = entry?;\n        let path = entry.path();\n        let target = dst.join(entry.file_name());\n        if path.is_dir() {\n            fs::create_dir_all(\u0026target)?;\n            copy_dir_recursive(\u0026path, \u0026target)?;\n        } else {\n            fs::copy(\u0026path, \u0026target)?;\n        }\n    }\n    Ok(())\n}\n\nfn build_cursor_headers(session_token: \u0026str) -\u003e reqwest::header::HeaderMap {\n    use reqwest::header::HeaderValue;\n\n    let mut headers = reqwest::header::HeaderMap::new();\n    headers.insert(\"Accept\", HeaderValue::from_static(\"*/*\"));\n    headers.insert(\n        \"Accept-Language\",\n        HeaderValue::from_static(\"en-US,en;q=0.9\"),\n    );\n    if let Ok(cookie) = format!(\"WorkosCursorSessionToken={}\", session_token).parse() {\n        headers.insert(\"Cookie\", cookie);\n    }\n    headers.insert(\n        \"Referer\",\n        HeaderValue::from_static(\"https://www.cursor.com/settings\"),\n    );\n    headers.insert(\n        \"User-Agent\",\n        HeaderValue::from_static(\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"),\n    );\n    headers\n}\n\nfn count_cursor_csv_rows(csv_text: \u0026str) -\u003e usize {\n    let mut reader = csv::ReaderBuilder::new()\n        .has_headers(true)\n        .flexible(true)\n        .from_reader(csv_text.as_bytes());\n    reader.records().filter_map(|r| r.ok()).count()\n}\n\nfn atomic_write_file(path: \u0026std::path::Path, contents: \u0026str) -\u003e Result\u003c()\u003e {\n     let parent = path\n         .parent()\n         .ok_or_else(|| anyhow::anyhow!(\"Invalid cache path\"))?;\n     if !parent.exists() {\n         fs::create_dir_all(parent)?;\n     }\n\n     let temp_name = format!(\n         \".tmp-{}-{}\",\n         path.file_name()\n             .and_then(|name| name.to_str())\n             .unwrap_or(\"cursor\"),\n         std::process::id()\n     );\n     let temp_path = parent.join(temp_name);\n\n     #[cfg(unix)]\n     {\n         use std::fs::OpenOptions;\n         use std::os::unix::fs::OpenOptionsExt;\n\n         let mut file = OpenOptions::new()\n             .write(true)\n             .create(true)\n             .truncate(true)\n             .mode(0o600)\n             .open(\u0026temp_path)?;\n         file.write_all(contents.as_bytes())?;\n     }\n\n     #[cfg(not(unix))]\n     {\n         fs::write(\u0026temp_path, contents)?;\n     }\n\n     if let Err(err) = fs::rename(\u0026temp_path, path) {\n         if path.exists() {\n             match fs::copy(\u0026temp_path, path) {\n                 Ok(_) =\u003e {\n                     let _ = fs::remove_file(\u0026temp_path);\n                 }\n                 Err(copy_err) =\u003e {\n                     let _ = fs::remove_file(\u0026temp_path);\n                     return Err(anyhow::anyhow!(\n                         \"Failed to persist file with rename ({}) and copy fallback ({})\",\n                         err,\n                         copy_err\n                     ));\n                 }\n             }\n         } else {\n             let _ = fs::remove_file(\u0026temp_path);\n             return Err(err.into());\n         }\n     }\n     Ok(())\n }\n\nfn ensure_config_dir() -\u003e Result\u003c()\u003e {\n    let config_dir = home_dir()?.join(\".config/tokscale\");\n\n    if !config_dir.exists() {\n        fs::create_dir_all(\u0026config_dir)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(\u0026config_dir, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n    Ok(())\n}\n\nfn extract_user_id_from_session_token(token: \u0026str) -\u003e Option\u003cString\u003e {\n    let token = token.trim();\n    if token.contains(\"%3A%3A\") {\n        let user_id = token.split(\"%3A%3A\").next()?.trim();\n        if user_id.is_empty() {\n            return None;\n        }\n        return Some(user_id.to_string());\n    }\n    if token.contains(\"::\") {\n        let user_id = token.split(\"::\").next()?.trim();\n        if user_id.is_empty() {\n            return None;\n        }\n        return Some(user_id.to_string());\n    }\n    None\n}\n\nfn derive_account_id(session_token: \u0026str) -\u003e String {\n    if let Some(user_id) = extract_user_id_from_session_token(session_token) {\n        return user_id;\n    }\n    let mut hasher = Sha256::new();\n    hasher.update(session_token.as_bytes());\n    let hash = hasher.finalize();\n    let hex = format!(\"{:x}\", hash);\n    format!(\"anon-{}\", \u0026hex[..12])\n}\n\nfn sanitize_account_id_for_filename(account_id: \u0026str) -\u003e String {\n    let sanitized: String = account_id\n        .trim()\n        .to_lowercase()\n        .chars()\n        .map(|c| {\n            if c.is_ascii_alphanumeric() || c == '.' || c == '_' || c == '-' {\n                c\n            } else {\n                '-'\n            }\n        })\n        .collect();\n    let trimmed = sanitized.trim_matches('-');\n    let result = if trimmed.len() \u003e 80 {\n        \u0026trimmed[..80]\n    } else {\n        trimmed\n    };\n    if result.is_empty() {\n        \"account\".to_string()\n    } else {\n        result.to_string()\n    }\n}\n\npub fn load_credentials_store() -\u003e Option\u003cCursorCredentialsStore\u003e {\n    let path = get_cursor_credentials_path().ok()?;\n    let old_path = get_old_cursor_credentials_path().ok()?;\n    let read_path = if path.exists() {\n        path.clone()\n    } else if old_path.exists() {\n        old_path\n    } else {\n        return None;\n    };\n\n    let content = fs::read_to_string(\u0026read_path).ok()?;\n\n    if let Ok(mut store) = serde_json::from_str::\u003cCursorCredentialsStore\u003e(\u0026content) {\n        if store.version == 1 \u0026\u0026 !store.accounts.is_empty() {\n            let mut changed = false;\n            if !store.accounts.contains_key(\u0026store.active_account_id) {\n                if let Some(first_id) = store.accounts.keys().next().cloned() {\n                    store.active_account_id = first_id;\n                    changed = true;\n                }\n            }\n            if changed || read_path != path {\n                let _ = save_credentials_store(\u0026store);\n            }\n            if read_path != path {\n                if let Ok(old) = get_old_cursor_credentials_path() {\n                    let _ = fs::remove_file(old);\n                }\n            }\n            return Some(store);\n        }\n    }\n\n    if let Ok(single) = serde_json::from_str::\u003cCursorCredentials\u003e(\u0026content) {\n        let account_id = derive_account_id(\u0026single.session_token);\n        let mut accounts = HashMap::new();\n        accounts.insert(account_id.clone(), single);\n        let migrated = CursorCredentialsStore {\n            version: 1,\n            active_account_id: account_id,\n            accounts,\n        };\n\n        let _ = save_credentials_store(\u0026migrated);\n        if read_path != path {\n            if let Ok(old) = get_old_cursor_credentials_path() {\n                let _ = fs::remove_file(old);\n            }\n        }\n        return Some(migrated);\n    }\n\n    None\n}\n\npub fn save_credentials_store(store: \u0026CursorCredentialsStore) -\u003e Result\u003c()\u003e {\n    ensure_config_dir()?;\n    let path = get_cursor_credentials_path()?;\n    let json = serde_json::to_string_pretty(store)?;\n    atomic_write_file(\u0026path, \u0026json)?;\n\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::PermissionsExt;\n        fs::set_permissions(\u0026path, fs::Permissions::from_mode(0o600))?;\n    }\n\n    Ok(())\n}\n\nfn resolve_account_id(store: \u0026CursorCredentialsStore, name_or_id: \u0026str) -\u003e Option\u003cString\u003e {\n    let needle = name_or_id.trim();\n    if needle.is_empty() {\n        return None;\n    }\n\n    if store.accounts.contains_key(needle) {\n        return Some(needle.to_string());\n    }\n\n    let needle_lower = needle.to_lowercase();\n    for (id, acct) in \u0026store.accounts {\n        if let Some(label) = \u0026acct.label {\n            if label.to_lowercase() == needle_lower {\n                return Some(id.clone());\n            }\n        }\n    }\n\n    None\n}\n\npub fn list_accounts() -\u003e Vec\u003cAccountInfo\u003e {\n    let store = match load_credentials_store() {\n        Some(s) =\u003e s,\n        None =\u003e return vec![],\n    };\n\n    let mut accounts: Vec\u003cAccountInfo\u003e = store\n        .accounts\n        .iter()\n        .map(|(id, acct)| AccountInfo {\n            id: id.clone(),\n            label: acct.label.clone(),\n            user_id: acct.user_id.clone(),\n            created_at: acct.created_at.clone(),\n            is_active: id == \u0026store.active_account_id,\n        })\n        .collect();\n\n    accounts.sort_by(|a, b| {\n        if a.is_active != b.is_active {\n            return if a.is_active {\n                std::cmp::Ordering::Less\n            } else {\n                std::cmp::Ordering::Greater\n            };\n        }\n        let la = a.label.as_deref().unwrap_or(\u0026a.id).to_lowercase();\n        let lb = b.label.as_deref().unwrap_or(\u0026b.id).to_lowercase();\n        la.cmp(\u0026lb)\n    });\n\n    accounts\n}\n\npub fn find_account(name_or_id: \u0026str) -\u003e Option\u003cAccountInfo\u003e {\n    let store = load_credentials_store()?;\n    let resolved = resolve_account_id(\u0026store, name_or_id)?;\n    let acct = store.accounts.get(\u0026resolved)?;\n\n    Some(AccountInfo {\n        id: resolved.clone(),\n        label: acct.label.clone(),\n        user_id: acct.user_id.clone(),\n        created_at: acct.created_at.clone(),\n        is_active: resolved == store.active_account_id,\n    })\n}\n\npub fn save_credentials(token: \u0026str, label: Option\u003c\u0026str\u003e) -\u003e Result\u003cString\u003e {\n    let account_id = derive_account_id(token);\n    let user_id = extract_user_id_from_session_token(token);\n\n    let mut store = load_credentials_store().unwrap_or_else(|| CursorCredentialsStore {\n        version: 1,\n        active_account_id: account_id.clone(),\n        accounts: HashMap::new(),\n    });\n\n    if let Some(lbl) = label {\n        let needle = lbl.trim().to_lowercase();\n        if !needle.is_empty() {\n            for (id, acct) in \u0026store.accounts {\n                if id == \u0026account_id {\n                    continue;\n                }\n                if let Some(existing_label) = \u0026acct.label {\n                    if existing_label.trim().to_lowercase() == needle {\n                        anyhow::bail!(\"Cursor account label already exists: {}\", lbl);\n                    }\n                }\n            }\n        }\n    }\n\n    let credentials = CursorCredentials {\n        session_token: token.to_string(),\n        user_id,\n        created_at: chrono::Utc::now().to_rfc3339(),\n        expires_at: None,\n        label: label.map(|s| s.to_string()),\n    };\n\n    store.accounts.insert(account_id.clone(), credentials);\n    store.active_account_id = account_id.clone();\n\n    save_credentials_store(\u0026store)?;\n\n    Ok(account_id)\n}\n\npub fn remove_account(name_or_id: \u0026str, purge_cache: bool) -\u003e Result\u003c()\u003e {\n    let mut store =\n        load_credentials_store().ok_or_else(|| anyhow::anyhow!(\"No saved Cursor accounts\"))?;\n\n    let resolved = resolve_account_id(\u0026store, name_or_id)\n        .ok_or_else(|| anyhow::anyhow!(\"Account not found: {}\", name_or_id))?;\n\n    let was_active = resolved == store.active_account_id;\n\n    let cache_dir = get_cursor_cache_dir()?;\n    if cache_dir.exists() {\n        let per_account = cache_dir.join(format!(\n            \"usage.{}.csv\",\n            sanitize_account_id_for_filename(\u0026resolved)\n        ));\n        if per_account.exists() {\n            if purge_cache {\n                let _ = fs::remove_file(\u0026per_account);\n            } else {\n                let _ = archive_cache_file(\u0026per_account, \u0026format!(\"usage.{}\", resolved));\n            }\n        }\n        if was_active {\n            let active_file = cache_dir.join(\"usage.csv\");\n            if active_file.exists() {\n                if purge_cache {\n                    let _ = fs::remove_file(\u0026active_file);\n                } else {\n                    let _ = archive_cache_file(\u0026active_file, \u0026format!(\"usage.active.{}\", resolved));\n                }\n            }\n        }\n    }\n\n    store.accounts.remove(\u0026resolved);\n\n    if store.accounts.is_empty() {\n        let path = get_cursor_credentials_path()?;\n        if path.exists() {\n            fs::remove_file(path)?;\n        }\n        return Ok(());\n    }\n\n    if was_active {\n        if let Some(first_id) = store.accounts.keys().next().cloned() {\n            let new_account_file = cache_dir.join(format!(\n                \"usage.{}.csv\",\n                sanitize_account_id_for_filename(\u0026first_id)\n            ));\n            let active_file = cache_dir.join(\"usage.csv\");\n            if new_account_file.exists() {\n                let _ = fs::rename(\u0026new_account_file, \u0026active_file);\n            }\n            store.active_account_id = first_id;\n        }\n    }\n\n    save_credentials_store(\u0026store)?;\n    Ok(())\n}\n\npub fn remove_all_accounts(purge_cache: bool) -\u003e Result\u003c()\u003e {\n    let cache_dir = get_cursor_cache_dir()?;\n    if cache_dir.exists() {\n        if let Ok(entries) = fs::read_dir(\u0026cache_dir) {\n            for entry in entries.flatten() {\n                let name = entry.file_name().to_string_lossy().to_string();\n                if name.starts_with(\"usage\") \u0026\u0026 name.ends_with(\".csv\") {\n                    if purge_cache {\n                        let _ = fs::remove_file(entry.path());\n                    } else {\n                        let _ = archive_cache_file(\u0026entry.path(), \u0026format!(\"usage.all.{}\", name));\n                    }\n                }\n            }\n        }\n    }\n\n    let path = get_cursor_credentials_path()?;\n    if path.exists() {\n        fs::remove_file(path)?;\n    }\n    Ok(())\n}\n\npub fn set_active_account(name_or_id: \u0026str) -\u003e Result\u003c()\u003e {\n    let mut store =\n        load_credentials_store().ok_or_else(|| anyhow::anyhow!(\"No saved Cursor accounts\"))?;\n\n    let resolved = resolve_account_id(\u0026store, name_or_id)\n        .ok_or_else(|| anyhow::anyhow!(\"Account not found: {}\", name_or_id))?;\n\n    let old_active_id = store.active_account_id.clone();\n\n    if resolved != old_active_id {\n        let _ = reconcile_cache_files(\u0026old_active_id, \u0026resolved);\n    }\n\n    store.active_account_id = resolved;\n    save_credentials_store(\u0026store)?;\n\n    Ok(())\n}\n\nfn reconcile_cache_files(old_account_id: \u0026str, new_account_id: \u0026str) -\u003e Result\u003c()\u003e {\n    let cache_dir = get_cursor_cache_dir()?;\n    if !cache_dir.exists() {\n        return Ok(());\n    }\n\n    let active_file = cache_dir.join(\"usage.csv\");\n    let old_account_file = cache_dir.join(format!(\n        \"usage.{}.csv\",\n        sanitize_account_id_for_filename(old_account_id)\n    ));\n    let new_account_file = cache_dir.join(format!(\n        \"usage.{}.csv\",\n        sanitize_account_id_for_filename(new_account_id)\n    ));\n\n    if active_file.exists() {\n        if old_account_file.exists() {\n            let _ = archive_cache_file(\u0026old_account_file, old_account_id);\n        }\n        fs::rename(\u0026active_file, \u0026old_account_file)?;\n    }\n\n    if new_account_file.exists() {\n        if active_file.exists() {\n            let _ = archive_cache_file(\u0026active_file, \"usage.active\");\n        }\n        fs::rename(\u0026new_account_file, \u0026active_file)?;\n    }\n\n    Ok(())\n}\n\npub fn load_active_credentials() -\u003e Option\u003cCursorCredentials\u003e {\n    let store = load_credentials_store()?;\n    store.accounts.get(\u0026store.active_account_id).cloned()\n}\n\nfn is_cursor_usage_csv_filename(name: \u0026str) -\u003e bool {\n    if name == \"usage.csv\" {\n        return true;\n    }\n    if !name.starts_with(\"usage.\") || !name.ends_with(\".csv\") {\n        return false;\n    }\n    if name.starts_with(\"usage.backup\") {\n        return false;\n    }\n    let stem = name.trim_start_matches(\"usage.\").trim_end_matches(\".csv\");\n    !stem.is_empty()\n        \u0026\u0026 stem\n            .chars()\n            .all(|c| c.is_ascii_alphanumeric() || c == '.' || c == '_' || c == '-')\n}\n\npub fn has_cursor_usage_cache() -\u003e bool {\n    migrate_cache_dir_from_old_path();\n    let cache_dir = match get_cursor_cache_dir() {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return false,\n    };\n    if !cache_dir.exists() {\n        return false;\n    }\n\n    match fs::read_dir(cache_dir) {\n        Ok(entries) =\u003e entries\n            .filter_map(|entry| entry.ok())\n            .filter_map(|entry| entry.file_name().into_string().ok())\n            .any(|name| is_cursor_usage_csv_filename(\u0026name)),\n        Err(_) =\u003e false,\n    }\n}\n\npub fn is_cursor_logged_in() -\u003e bool {\n    load_active_credentials().is_some()\n}\n\npub fn load_credentials_for(name_or_id: \u0026str) -\u003e Option\u003cCursorCredentials\u003e {\n    let store = load_credentials_store()?;\n    let resolved = resolve_account_id(\u0026store, name_or_id)?;\n    store.accounts.get(\u0026resolved).cloned()\n}\n\n#[derive(Debug)]\npub struct ValidateSessionResult {\n    pub valid: bool,\n    pub membership_type: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n}\n\npub async fn validate_cursor_session(token: \u0026str) -\u003e ValidateSessionResult {\n    let client = reqwest::Client::new();\n    let response = match client\n        .get(USAGE_SUMMARY_ENDPOINT)\n        .headers(build_cursor_headers(token))\n        .send()\n        .await\n    {\n        Ok(resp) =\u003e resp,\n        Err(e) =\u003e {\n            return ValidateSessionResult {\n                valid: false,\n                membership_type: None,\n                error: Some(format!(\"Failed to connect: {}\", e)),\n            };\n        }\n    };\n\n    if response.status() == reqwest::StatusCode::UNAUTHORIZED\n        || response.status() == reqwest::StatusCode::FORBIDDEN\n    {\n        return ValidateSessionResult {\n            valid: false,\n            membership_type: None,\n            error: Some(\"Session token expired or invalid\".to_string()),\n        };\n    }\n\n    if !response.status().is_success() {\n        return ValidateSessionResult {\n            valid: false,\n            membership_type: None,\n            error: Some(format!(\"API returned status {}\", response.status())),\n        };\n    }\n\n    let data: serde_json::Value = match response.json().await {\n        Ok(d) =\u003e d,\n        Err(e) =\u003e {\n            return ValidateSessionResult {\n                valid: false,\n                membership_type: None,\n                error: Some(format!(\"Failed to parse response: {}\", e)),\n            };\n        }\n    };\n\n    let has_billing_start = data\n        .get(\"billingCycleStart\")\n        .and_then(|v| v.as_str())\n        .is_some();\n    let has_billing_end = data\n        .get(\"billingCycleEnd\")\n        .and_then(|v| v.as_str())\n        .is_some();\n\n    if has_billing_start \u0026\u0026 has_billing_end {\n        let membership_type = data\n            .get(\"membershipType\")\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string());\n        ValidateSessionResult {\n            valid: true,\n            membership_type,\n            error: None,\n        }\n    } else {\n        ValidateSessionResult {\n            valid: false,\n            membership_type: None,\n            error: Some(\"Invalid response format\".to_string()),\n        }\n    }\n}\n\npub async fn fetch_cursor_usage_csv(session_token: \u0026str) -\u003e Result\u003cString\u003e {\n    let client = reqwest::Client::new();\n    let response = client\n        .get(USAGE_CSV_ENDPOINT)\n        .headers(build_cursor_headers(session_token))\n        .send()\n        .await?;\n\n    if response.status() == reqwest::StatusCode::UNAUTHORIZED\n        || response.status() == reqwest::StatusCode::FORBIDDEN\n    {\n        anyhow::bail!(\n            \"Cursor session expired. Please run 'tokscale cursor login' to re-authenticate.\"\n        );\n    }\n\n    if !response.status().is_success() {\n        anyhow::bail!(\"Cursor API returned status {}\", response.status());\n    }\n\n    let text = response.text().await?;\n\n    if !text.starts_with(\"Date,\") {\n        anyhow::bail!(\"Invalid response from Cursor API - expected CSV format\");\n    }\n\n    Ok(text)\n}\n\npub async fn sync_cursor_cache() -\u003e SyncCursorResult {\n    migrate_cache_dir_from_old_path();\n\n    let store = match load_credentials_store() {\n        Some(s) =\u003e s,\n        None =\u003e {\n            return SyncCursorResult {\n                synced: false,\n                rows: 0,\n                error: Some(\"Not authenticated\".to_string()),\n            };\n        }\n    };\n\n    if store.accounts.is_empty() {\n        return SyncCursorResult {\n            synced: false,\n            rows: 0,\n            error: Some(\"Not authenticated\".to_string()),\n        };\n    }\n\n    let cache_dir = match get_cursor_cache_dir() {\n        Ok(d) =\u003e d,\n        Err(e) =\u003e {\n            return SyncCursorResult {\n                synced: false,\n                rows: 0,\n                error: Some(format!(\"Failed to get cache dir: {}\", e)),\n            };\n        }\n    };\n    if let Err(e) = fs::create_dir_all(\u0026cache_dir) {\n        return SyncCursorResult {\n            synced: false,\n            rows: 0,\n            error: Some(format!(\"Failed to create cache dir: {}\", e)),\n        };\n    }\n    #[cfg(unix)]\n    {\n        use std::os::unix::fs::PermissionsExt;\n        let _ = fs::set_permissions(\u0026cache_dir, fs::Permissions::from_mode(0o700));\n    }\n\n    let active_dup = cache_dir.join(format!(\n        \"usage.{}.csv\",\n        sanitize_account_id_for_filename(\u0026store.active_account_id)\n    ));\n    if active_dup.exists() {\n        let _ = fs::remove_file(\u0026active_dup);\n    }\n\n    let mut total_rows = 0;\n    let mut success_count = 0;\n    let mut errors: Vec\u003cString\u003e = Vec::new();\n\n    for (account_id, credentials) in \u0026store.accounts {\n        let is_active = account_id == \u0026store.active_account_id;\n\n        match fetch_cursor_usage_csv(\u0026credentials.session_token).await {\n            Ok(csv_text) =\u003e {\n                let file_path = if is_active {\n                    cache_dir.join(\"usage.csv\")\n                } else {\n                    cache_dir.join(format!(\n                        \"usage.{}.csv\",\n                        sanitize_account_id_for_filename(account_id)\n                    ))\n                };\n\n                let row_count = count_cursor_csv_rows(\u0026csv_text);\n\n                if let Err(e) = atomic_write_file(\u0026file_path, \u0026csv_text) {\n                    errors.push(format!(\"{}: {}\", account_id, e));\n                } else {\n                    total_rows += row_count;\n                    success_count += 1;\n                }\n            }\n            Err(e) =\u003e {\n                errors.push(format!(\"{}: {}\", account_id, e));\n            }\n        }\n    }\n\n    if success_count == 0 {\n        return SyncCursorResult {\n            synced: false,\n            rows: 0,\n            error: Some(\n                errors\n                    .first()\n                    .cloned()\n                    .unwrap_or_else(|| \"Cursor sync failed\".to_string()),\n            ),\n        };\n    }\n\n    SyncCursorResult {\n        synced: true,\n        rows: total_rows,\n        error: if errors.is_empty() {\n            None\n        } else {\n            Some(format!(\n                \"Some accounts failed to sync ({}/{})\",\n                errors.len(),\n                store.accounts.len()\n            ))\n        },\n    }\n}\n\nfn archive_cache_file(file_path: \u0026std::path::Path, label: \u0026str) -\u003e Result\u003c()\u003e {\n    let cache_dir = get_cursor_cache_dir()?;\n    let archive_dir = cache_dir.join(\"archive\");\n    if !archive_dir.exists() {\n        fs::create_dir_all(\u0026archive_dir)?;\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            fs::set_permissions(\u0026archive_dir, fs::Permissions::from_mode(0o700))?;\n        }\n    }\n\n    let safe_label = sanitize_account_id_for_filename(label);\n    let ts = chrono::Utc::now().format(\"%Y-%m-%dT%H-%M-%S\").to_string();\n    let dest = archive_dir.join(format!(\"{}-{}.csv\", safe_label, ts));\n    fs::rename(file_path, dest)?;\n    Ok(())\n}\n\npub fn run_cursor_login(name: Option\u003cString\u003e) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use tokio::runtime::Runtime;\n\n    let rt = Runtime::new()?;\n\n    println!(\"\\n  {}\\n\", \"Cursor IDE - Login\".cyan());\n\n    if let Some(ref label) = name {\n        if find_account(label).is_some() {\n            println!(\n                \"  {}\",\n                format!(\n                    \"Account '{}' already exists. Use 'tokscale cursor logout --name {}' first.\",\n                    label, label\n                )\n                .yellow()\n            );\n            println!();\n            return Ok(());\n        }\n    }\n\n    print!(\"  Enter Cursor session token: \");\n    std::io::stdout().flush()?;\n    let token = rpassword::read_password().context(\"Failed to read session token\")?;\n    let token = token.trim().to_string();\n\n    if token.is_empty() {\n        println!(\"\\n  {}\\n\", \"No token provided.\".yellow());\n        return Ok(());\n    }\n\n    println!();\n    println!(\"{}\", \"  Validating session token...\".bright_black());\n\n    let result = rt.block_on(async { validate_cursor_session(\u0026token).await });\n\n    if !result.valid {\n        let msg = result\n            .error\n            .unwrap_or_else(|| \"Invalid session token\".to_string());\n        println!(\n            \"\\n  {}\\n\",\n            format!(\"{}. Please check and try again.\", msg).red()\n        );\n        std::process::exit(1);\n    }\n\n    let account_id = save_credentials(\u0026token, name.as_deref())?;\n\n    let display_name = name.as_deref().unwrap_or(\u0026account_id);\n    println!(\n        \"\\n  {}\",\n        format!(\n            \"Successfully logged in to Cursor as {}\",\n            display_name.bold()\n        )\n        .green()\n    );\n    println!(\"{}\", format!(\"  Account ID: {}\", account_id).bright_black());\n    println!();\n\n    Ok(())\n}\n\npub fn run_cursor_logout(name: Option\u003cString\u003e, all: bool, purge_cache: bool) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    if all {\n        let accounts = list_accounts();\n        if accounts.is_empty() {\n            println!(\"\\n  {}\\n\", \"No saved Cursor accounts.\".yellow());\n            return Ok(());\n        }\n\n        remove_all_accounts(purge_cache)?;\n        println!(\"\\n  {}\\n\", \"Logged out from all Cursor accounts.\".green());\n        return Ok(());\n    }\n\n    if let Some(ref account_name) = name {\n        remove_account(account_name, purge_cache)?;\n        println!(\n            \"\\n  {}\\n\",\n            format!(\"Logged out from Cursor account '{}'.\", account_name).green()\n        );\n        return Ok(());\n    }\n\n    let Some(store) = load_credentials_store() else {\n        println!(\"\\n  {}\\n\", \"No saved Cursor accounts.\".yellow());\n        return Ok(());\n    };\n    let active_id = store.active_account_id.clone();\n    let display = store\n        .accounts\n        .get(\u0026active_id)\n        .and_then(|a| a.label.clone())\n        .unwrap_or_else(|| active_id.clone());\n\n    remove_account(\u0026active_id, purge_cache)?;\n    println!(\n        \"\\n  {}\\n\",\n        format!(\"Logged out from Cursor account '{}'.\", display).green()\n    );\n\n    Ok(())\n}\n\npub fn run_cursor_status(name: Option\u003cString\u003e) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use tokio::runtime::Runtime;\n\n    let rt = Runtime::new()?;\n\n    let credentials = if let Some(ref account_name) = name {\n        load_credentials_for(account_name)\n    } else {\n        load_active_credentials()\n    };\n\n    let credentials = match credentials {\n        Some(c) =\u003e c,\n        None =\u003e {\n            if let Some(ref account_name) = name {\n                println!(\n                    \"\\n  {}\\n\",\n                    format!(\"Account not found: {}\", account_name).red()\n                );\n            } else {\n                println!(\"\\n  {}\", \"No saved Cursor accounts.\".yellow());\n                println!(\n                    \"{}\",\n                    \"  Run 'tokscale cursor login' to authenticate.\\n\".bright_black()\n                );\n            }\n            return Ok(());\n        }\n    };\n\n    println!(\"\\n  {}\\n\", \"Cursor IDE - Status\".cyan());\n\n    let display_name = credentials.label.as_deref().unwrap_or(\"(no label)\");\n    println!(\"{}\", format!(\"  Account: {}\", display_name).white());\n    if let Some(ref uid) = credentials.user_id {\n        println!(\"{}\", format!(\"  User ID: {}\", uid).bright_black());\n    }\n\n    println!(\"{}\", \"  Validating session...\".bright_black());\n\n    let result = rt.block_on(async { validate_cursor_session(\u0026credentials.session_token).await });\n\n    if result.valid {\n        println!(\"  {}\", \"Session: Valid\".green());\n        if let Some(membership) = result.membership_type {\n            println!(\"{}\", format!(\"  Membership: {}\", membership).bright_black());\n        }\n    } else {\n        let msg = result\n            .error\n            .unwrap_or_else(|| \"Invalid / Expired\".to_string());\n        println!(\"  {}\", format!(\"Session: {}\", msg).red());\n    }\n    println!();\n\n    Ok(())\n}\n\npub fn run_cursor_accounts(json: bool) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    let accounts = list_accounts();\n\n    if json {\n        #[derive(Serialize)]\n        struct Output {\n            accounts: Vec\u003cAccountInfo\u003e,\n        }\n        let output = Output { accounts };\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n        return Ok(());\n    }\n\n    if accounts.is_empty() {\n        println!(\"\\n  {}\\n\", \"No saved Cursor accounts.\".yellow());\n        return Ok(());\n    }\n\n    println!(\"{}\", \"\\n  Cursor IDE - Accounts\\n\".cyan());\n    for acct in \u0026accounts {\n        let name = if let Some(ref label) = acct.label {\n            format!(\"{} ({})\", label, acct.id)\n        } else {\n            acct.id.clone()\n        };\n        let marker = if acct.is_active { \"*\" } else { \"-\" };\n        let marker_colored = if acct.is_active {\n            marker.green().to_string()\n        } else {\n            marker.bright_black().to_string()\n        };\n        println!(\"  {} {}\", marker_colored, name);\n    }\n    println!();\n\n    Ok(())\n}\n\npub fn run_cursor_switch(name: \u0026str) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    set_active_account(name)?;\n    println!(\n        \"\\n  {}\\n\",\n        format!(\"Active Cursor account set to {}\", name.bold()).green()\n    );\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::TempDir;\n\n    #[test]\n    fn test_extract_user_id_from_session_token_with_url_encoding() {\n        // Test URL-encoded separator (%3A%3A)\n        assert_eq!(\n            extract_user_id_from_session_token(\"user123%3A%3Atoken456\"),\n            Some(\"user123\".to_string())\n        );\n        assert_eq!(\n            extract_user_id_from_session_token(\"  user123%3A%3Atoken456  \"),\n            Some(\"user123\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_user_id_from_session_token_with_double_colon() {\n        // Test plain :: separator\n        assert_eq!(\n            extract_user_id_from_session_token(\"user456::token789\"),\n            Some(\"user456\".to_string())\n        );\n        assert_eq!(\n            extract_user_id_from_session_token(\"  user456::token789  \"),\n            Some(\"user456\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_extract_user_id_from_session_token_invalid() {\n        // No separator\n        assert_eq!(extract_user_id_from_session_token(\"invalidtoken\"), None);\n        // Empty user ID\n        assert_eq!(extract_user_id_from_session_token(\"%3A%3Atoken\"), None);\n        assert_eq!(extract_user_id_from_session_token(\"::token\"), None);\n        // Empty string\n        assert_eq!(extract_user_id_from_session_token(\"\"), None);\n        // Whitespace only\n        assert_eq!(extract_user_id_from_session_token(\"   \"), None);\n    }\n\n    #[test]\n    fn test_derive_account_id_with_user_id() {\n        // Should extract user ID when present\n        let account_id = derive_account_id(\"user123%3A%3Atoken456\");\n        assert_eq!(account_id, \"user123\");\n\n        let account_id = derive_account_id(\"user456::token789\");\n        assert_eq!(account_id, \"user456\");\n    }\n\n    #[test]\n    fn test_derive_account_id_without_user_id() {\n        // Should generate anon-{hash} when no user ID\n        let account_id = derive_account_id(\"randomtoken\");\n        assert!(account_id.starts_with(\"anon-\"));\n        assert_eq!(account_id.len(), 17); // \"anon-\" + 12 hex chars\n\n        // Same token should produce same hash\n        let account_id2 = derive_account_id(\"randomtoken\");\n        assert_eq!(account_id, account_id2);\n\n        // Different tokens should produce different hashes\n        let account_id3 = derive_account_id(\"differenttoken\");\n        assert_ne!(account_id, account_id3);\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_basic() {\n        // Alphanumeric, dots, underscores, hyphens should be preserved\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user123\"),\n            \"user123\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user.name_123-test\"),\n            \"user.name_123-test\"\n        );\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_unsafe_chars() {\n        // Unsafe characters should be replaced with hyphens\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user@example.com\"),\n            \"user-example.com\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user/name\\\\test\"),\n            \"user-name-test\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"user name\"),\n            \"user-name\"\n        );\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_edge_cases() {\n        // Uppercase should be lowercased\n        assert_eq!(\n            sanitize_account_id_for_filename(\"UserName123\"),\n            \"username123\"\n        );\n\n        // Leading/trailing hyphens should be trimmed\n        assert_eq!(\n            sanitize_account_id_for_filename(\"---user---\"),\n            \"user\"\n        );\n\n        // Empty after sanitization should return \"account\"\n        assert_eq!(\n            sanitize_account_id_for_filename(\"@@@\"),\n            \"account\"\n        );\n        assert_eq!(\n            sanitize_account_id_for_filename(\"\"),\n            \"account\"\n        );\n\n        // Whitespace only should return \"account\"\n        assert_eq!(\n            sanitize_account_id_for_filename(\"   \"),\n            \"account\"\n        );\n    }\n\n    #[test]\n    fn test_sanitize_account_id_for_filename_length_limit() {\n        // Should truncate to 80 characters\n        let long_id = \"a\".repeat(100);\n        let sanitized = sanitize_account_id_for_filename(\u0026long_id);\n        assert_eq!(sanitized.len(), 80);\n        assert_eq!(sanitized, \"a\".repeat(80));\n\n        // Should preserve exactly 80 characters\n        let exactly_80 = \"b\".repeat(80);\n        let sanitized = sanitize_account_id_for_filename(\u0026exactly_80);\n        assert_eq!(sanitized.len(), 80);\n    }\n\n    #[test]\n    fn test_count_cursor_csv_rows_valid() {\n        // Valid CSV with header\n        let csv = \"Date,Model,Tokens\\n2024-01-01,gpt-4,100\\n2024-01-02,gpt-4,200\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 2);\n\n        // Single row\n        let csv = \"Date,Model,Tokens\\n2024-01-01,gpt-4,100\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 1);\n    }\n\n    #[test]\n    fn test_count_cursor_csv_rows_empty() {\n        // Header only\n        let csv = \"Date,Model,Tokens\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 0);\n\n        // Empty string\n        let csv = \"\";\n        assert_eq!(count_cursor_csv_rows(csv), 0);\n    }\n\n    #[test]\n    fn test_count_cursor_csv_rows_malformed() {\n        // CSV reader with flexible=true accepts rows with different column counts\n        // This test verifies the actual behavior: all parseable rows are counted\n        let csv = \"Date,Model,Tokens\\n2024-01-01,gpt-4,100\\ninvalid,row\\n2024-01-02,gpt-4,200\\n\";\n        assert_eq!(count_cursor_csv_rows(csv), 3);\n    }\n\n    #[test]\n    fn test_atomic_write_file_basic() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let file_path = temp_dir.path().join(\"test.txt\");\n        let contents = \"Hello, world!\";\n\n        atomic_write_file(\u0026file_path, contents)?;\n\n        // Verify file was created and contains correct content\n        assert!(file_path.exists());\n        let read_contents = fs::read_to_string(\u0026file_path)?;\n        assert_eq!(read_contents, contents);\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_atomic_write_file_creates_parent_dirs() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let nested_path = temp_dir.path().join(\"a\").join(\"b\").join(\"c\").join(\"test.txt\");\n        let contents = \"Nested file\";\n\n        atomic_write_file(\u0026nested_path, contents)?;\n\n        // Verify parent directories were created\n        assert!(nested_path.exists());\n        let read_contents = fs::read_to_string(\u0026nested_path)?;\n        assert_eq!(read_contents, contents);\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_atomic_write_file_overwrites_existing() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let file_path = temp_dir.path().join(\"test.txt\");\n\n        // Write initial content\n        atomic_write_file(\u0026file_path, \"Initial\")?;\n        assert_eq!(fs::read_to_string(\u0026file_path)?, \"Initial\");\n\n        // Overwrite with new content\n        atomic_write_file(\u0026file_path, \"Updated\")?;\n        assert_eq!(fs::read_to_string(\u0026file_path)?, \"Updated\");\n\n        Ok(())\n    }\n\n    #[test]\n    #[cfg(unix)]\n    fn test_atomic_write_file_permissions() -\u003e Result\u003c()\u003e {\n        use std::os::unix::fs::PermissionsExt;\n\n        let temp_dir = TempDir::new()?;\n        let file_path = temp_dir.path().join(\"test.txt\");\n\n        atomic_write_file(\u0026file_path, \"Secret\")?;\n\n        // Verify file has 0o600 permissions (owner read/write only)\n        let metadata = fs::metadata(\u0026file_path)?;\n        let permissions = metadata.permissions();\n        assert_eq!(permissions.mode() \u0026 0o777, 0o600);\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_copy_dir_recursive_basic() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let src = temp_dir.path().join(\"src\");\n        let dst = temp_dir.path().join(\"dst\");\n\n        // Create source directory structure\n        fs::create_dir_all(\u0026src)?;\n        fs::write(src.join(\"file1.txt\"), \"Content 1\")?;\n        fs::write(src.join(\"file2.txt\"), \"Content 2\")?;\n\n        // Create destination directory\n        fs::create_dir_all(\u0026dst)?;\n\n        // Copy recursively\n        copy_dir_recursive(\u0026src, \u0026dst)?;\n\n        // Verify files were copied\n        assert!(dst.join(\"file1.txt\").exists());\n        assert!(dst.join(\"file2.txt\").exists());\n        assert_eq!(fs::read_to_string(dst.join(\"file1.txt\"))?, \"Content 1\");\n        assert_eq!(fs::read_to_string(dst.join(\"file2.txt\"))?, \"Content 2\");\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_copy_dir_recursive_nested() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let src = temp_dir.path().join(\"src\");\n        let dst = temp_dir.path().join(\"dst\");\n\n        // Create nested source directory structure\n        fs::create_dir_all(src.join(\"subdir1\").join(\"subdir2\"))?;\n        fs::write(src.join(\"root.txt\"), \"Root\")?;\n        fs::write(src.join(\"subdir1\").join(\"file1.txt\"), \"File 1\")?;\n        fs::write(src.join(\"subdir1\").join(\"subdir2\").join(\"file2.txt\"), \"File 2\")?;\n\n        // Create destination directory\n        fs::create_dir_all(\u0026dst)?;\n\n        // Copy recursively\n        copy_dir_recursive(\u0026src, \u0026dst)?;\n\n        // Verify nested structure was copied\n        assert!(dst.join(\"root.txt\").exists());\n        assert!(dst.join(\"subdir1\").join(\"file1.txt\").exists());\n        assert!(dst.join(\"subdir1\").join(\"subdir2\").join(\"file2.txt\").exists());\n        assert_eq!(fs::read_to_string(dst.join(\"root.txt\"))?, \"Root\");\n        assert_eq!(fs::read_to_string(dst.join(\"subdir1\").join(\"file1.txt\"))?, \"File 1\");\n        assert_eq!(fs::read_to_string(dst.join(\"subdir1\").join(\"subdir2\").join(\"file2.txt\"))?, \"File 2\");\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_copy_dir_recursive_empty_dir() -\u003e Result\u003c()\u003e {\n        let temp_dir = TempDir::new()?;\n        let src = temp_dir.path().join(\"src\");\n        let dst = temp_dir.path().join(\"dst\");\n\n        // Create empty source directory\n        fs::create_dir_all(\u0026src)?;\n        fs::create_dir_all(\u0026dst)?;\n\n        // Copy recursively (should succeed with no files)\n        copy_dir_recursive(\u0026src, \u0026dst)?;\n\n        // Verify destination exists but is empty\n        assert!(dst.exists());\n        assert_eq!(fs::read_dir(\u0026dst)?.count(), 0);\n\n        Ok(())\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":746,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":765,"address":[],"length":0,"stats":{"Line":0}},{"line":766,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":791,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":811,"address":[],"length":0,"stats":{"Line":0}},{"line":812,"address":[],"length":0,"stats":{"Line":0}},{"line":814,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":864,"address":[],"length":0,"stats":{"Line":0}},{"line":865,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":867,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":890,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":907,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":912,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[],"length":0,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":928,"address":[],"length":0,"stats":{"Line":0}},{"line":931,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":937,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":955,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[],"length":0,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":960,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":967,"address":[],"length":0,"stats":{"Line":0}},{"line":969,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":973,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":977,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":984,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":996,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1001,"address":[],"length":0,"stats":{"Line":0}},{"line":1004,"address":[],"length":0,"stats":{"Line":0}},{"line":1005,"address":[],"length":0,"stats":{"Line":0}},{"line":1007,"address":[],"length":0,"stats":{"Line":0}},{"line":1008,"address":[],"length":0,"stats":{"Line":0}},{"line":1009,"address":[],"length":0,"stats":{"Line":0}},{"line":1010,"address":[],"length":0,"stats":{"Line":0}},{"line":1013,"address":[],"length":0,"stats":{"Line":0}},{"line":1014,"address":[],"length":0,"stats":{"Line":0}},{"line":1015,"address":[],"length":0,"stats":{"Line":0}},{"line":1016,"address":[],"length":0,"stats":{"Line":0}},{"line":1019,"address":[],"length":0,"stats":{"Line":0}},{"line":1023,"address":[],"length":0,"stats":{"Line":0}},{"line":1025,"address":[],"length":0,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1035,"address":[],"length":0,"stats":{"Line":0}},{"line":1036,"address":[],"length":0,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1041,"address":[],"length":0,"stats":{"Line":0}},{"line":1042,"address":[],"length":0,"stats":{"Line":0}},{"line":1043,"address":[],"length":0,"stats":{"Line":0}},{"line":1044,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[],"length":0,"stats":{"Line":0}},{"line":1048,"address":[],"length":0,"stats":{"Line":0}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":0}},{"line":1074,"address":[],"length":0,"stats":{"Line":0}},{"line":1076,"address":[],"length":0,"stats":{"Line":0}},{"line":1078,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1080,"address":[],"length":0,"stats":{"Line":0}},{"line":1082,"address":[],"length":0,"stats":{"Line":0}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1088,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1094,"address":[],"length":0,"stats":{"Line":0}},{"line":1095,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1100,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":581},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","main.rs"],"content":"mod auth;\nmod commands;\nmod cursor;\nmod tui;\n\nuse anyhow::Result;\nuse clap::{Parser, Subcommand};\nuse std::io::{self, IsTerminal, Write};\nuse std::path::{Path, PathBuf};\nuse std::sync::atomic::{AtomicBool, Ordering};\nuse std::sync::Arc;\nuse std::thread::{self, JoinHandle};\nuse std::time::Duration;\nuse tui::Tab;\n\n#[derive(Parser)]\n#[command(name = \"tokscale\")]\n#[command(author, version, about = \"AI token usage analytics\")]\nstruct Cli {\n    #[command(subcommand)]\n    command: Option\u003cCommands\u003e,\n\n    #[arg(short, long, default_value = \"blue\")]\n    theme: String,\n\n    #[arg(short, long, default_value = \"0\")]\n    refresh: u64,\n\n    #[arg(long)]\n    debug: bool,\n\n    #[arg(long)]\n    test_data: bool,\n\n    #[arg(long, help = \"Output as JSON\")]\n    json: bool,\n\n    #[arg(long, help = \"Use legacy CLI table output\")]\n    light: bool,\n\n    #[arg(long, help = \"Show only OpenCode usage\")]\n    opencode: bool,\n\n    #[arg(long, help = \"Show only Claude Code usage\")]\n    claude: bool,\n\n    #[arg(long, help = \"Show only Codex CLI usage\")]\n    codex: bool,\n\n    #[arg(long, help = \"Show only Gemini CLI usage\")]\n    gemini: bool,\n\n    #[arg(long, help = \"Show only Cursor IDE usage\")]\n    cursor: bool,\n\n    #[arg(long, help = \"Show only Amp usage\")]\n    amp: bool,\n\n    #[arg(long, help = \"Show only Droid usage\")]\n    droid: bool,\n\n    #[arg(long, help = \"Show only OpenClaw usage\")]\n    openclaw: bool,\n\n    #[arg(long, help = \"Show only Pi usage\")]\n    pi: bool,\n\n    #[arg(long, help = \"Show only today's usage\")]\n    today: bool,\n\n    #[arg(long, help = \"Show last 7 days\")]\n    week: bool,\n\n    #[arg(long, help = \"Show current month\")]\n    month: bool,\n\n    #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n    since: Option\u003cString\u003e,\n\n    #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n    until: Option\u003cString\u003e,\n\n    #[arg(long, help = \"Filter by year (YYYY)\")]\n    year: Option\u003cString\u003e,\n\n    #[arg(long, help = \"Show processing time\")]\n    benchmark: bool,\n\n    #[arg(\n        long,\n        value_name = \"STRATEGY\",\n        default_value = \"client,model\",\n        help = \"Grouping strategy for --light and --json output: model, client,model, client,provider,model\"\n    )]\n    group_by: String,\n\n    #[arg(long, help = \"Disable spinner (for AI agents and scripts)\")]\n    no_spinner: bool,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    #[command(about = \"Show model usage report\")]\n    Models {\n        #[arg(long)]\n        json: bool,\n        #[arg(long)]\n        light: bool,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show processing time\")]\n        benchmark: bool,\n        #[arg(\n            long,\n            value_name = \"STRATEGY\",\n            default_value = \"client,model\",\n            help = \"Grouping strategy for --light and --json output: model, client,model, client,provider,model\"\n        )]\n        group_by: String,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Show monthly usage report\")]\n    Monthly {\n        #[arg(long)]\n        json: bool,\n        #[arg(long)]\n        light: bool,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show processing time\")]\n        benchmark: bool,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Show pricing for a model\")]\n    Pricing {\n        model_id: String,\n        #[arg(long, help = \"Output as JSON\")]\n        json: bool,\n        #[arg(long, help = \"Force specific provider (litellm or openrouter)\")]\n        provider: Option\u003cString\u003e,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Show local scan locations and session counts\")]\n    Sources {\n        #[arg(long, help = \"Output as JSON\")]\n        json: bool,\n    },\n    #[command(about = \"Login to Tokscale (opens browser for GitHub auth)\")]\n    Login,\n    #[command(about = \"Logout from Tokscale\")]\n    Logout,\n    #[command(about = \"Show current logged in user\")]\n    Whoami,\n    #[command(about = \"Export contribution graph data as JSON\")]\n    Graph {\n        #[arg(long, help = \"Write to file instead of stdout\")]\n        output: Option\u003cString\u003e,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show processing time\")]\n        benchmark: bool,\n        #[arg(long, help = \"Disable spinner\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Launch interactive TUI with optional filters\")]\n    Tui {\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(long, help = \"Show only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Show last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Show current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n    },\n    #[command(about = \"Submit usage data to the Tokscale social platform\")]\n    Submit {\n        #[arg(long, help = \"Include only OpenCode data\")]\n        opencode: bool,\n        #[arg(long, help = \"Include only Claude Code data\")]\n        claude: bool,\n        #[arg(long, help = \"Include only Codex CLI data\")]\n        codex: bool,\n        #[arg(long, help = \"Include only Gemini CLI data\")]\n        gemini: bool,\n        #[arg(long, help = \"Include only Cursor IDE data\")]\n        cursor: bool,\n        #[arg(long, help = \"Include only Amp data\")]\n        amp: bool,\n        #[arg(long, help = \"Include only Droid data\")]\n        droid: bool,\n        #[arg(long, help = \"Include only OpenClaw data\")]\n        openclaw: bool,\n        #[arg(long, help = \"Include only Pi data\")]\n        pi: bool,\n        #[arg(long, help = \"Submit only today's usage\")]\n        today: bool,\n        #[arg(long, help = \"Submit last 7 days\")]\n        week: bool,\n        #[arg(long, help = \"Submit current month\")]\n        month: bool,\n        #[arg(long, help = \"Start date (YYYY-MM-DD)\")]\n        since: Option\u003cString\u003e,\n        #[arg(long, help = \"End date (YYYY-MM-DD)\")]\n        until: Option\u003cString\u003e,\n        #[arg(long, help = \"Filter by year (YYYY)\")]\n        year: Option\u003cString\u003e,\n        #[arg(\n            long,\n            help = \"Show what would be submitted without actually submitting\"\n        )]\n        dry_run: bool,\n    },\n    #[command(about = \"Capture subprocess output for token usage tracking\")]\n    Headless {\n        #[arg(help = \"Source CLI (currently only 'codex' supported)\")]\n        source: String,\n        #[arg(trailing_var_arg = true, allow_hyphen_values = true)]\n        args: Vec\u003cString\u003e,\n        #[arg(long, help = \"Override output format (json or jsonl)\")]\n        format: Option\u003cString\u003e,\n        #[arg(long, help = \"Write captured output to file\")]\n        output: Option\u003cString\u003e,\n        #[arg(long, help = \"Do not auto-add JSON output flags\")]\n        no_auto_flags: bool,\n    },\n    #[command(about = \"Generate year-in-review wrapped image\")]\n    Wrapped {\n        #[arg(long, help = \"Output file path (default: tokscale-{year}-wrapped.png)\")]\n        output: Option\u003cString\u003e,\n        #[arg(long, help = \"Year to generate (default: current year)\")]\n        year: Option\u003cString\u003e,\n        #[arg(long, help = \"Show only OpenCode usage\")]\n        opencode: bool,\n        #[arg(long, help = \"Show only Claude Code usage\")]\n        claude: bool,\n        #[arg(long, help = \"Show only Codex CLI usage\")]\n        codex: bool,\n        #[arg(long, help = \"Show only Gemini CLI usage\")]\n        gemini: bool,\n        #[arg(long, help = \"Show only Cursor IDE usage\")]\n        cursor: bool,\n        #[arg(long, help = \"Show only Amp usage\")]\n        amp: bool,\n        #[arg(long, help = \"Show only Droid usage\")]\n        droid: bool,\n        #[arg(long, help = \"Show only OpenClaw usage\")]\n        openclaw: bool,\n        #[arg(long, help = \"Show only Pi usage\")]\n        pi: bool,\n        #[arg(\n            long,\n            help = \"Display total tokens in abbreviated format (e.g., 7.14B)\"\n        )]\n        short: bool,\n        #[arg(long, help = \"Show Top OpenCode Agents (default)\")]\n        agents: bool,\n        #[arg(long, help = \"Show Top Clients instead of Top OpenCode Agents\")]\n        clients: bool,\n        #[arg(long, help = \"Disable pinning of Sisyphus agents in rankings\")]\n        disable_pinned: bool,\n        #[arg(long, help = \"Disable loading spinner (for scripting)\")]\n        no_spinner: bool,\n    },\n    #[command(about = \"Cursor IDE integration commands\")]\n    Cursor {\n        #[command(subcommand)]\n        subcommand: CursorSubcommand,\n    },\n}\n\n#[derive(Subcommand)]\nenum CursorSubcommand {\n    #[command(about = \"Login to Cursor (paste your session token)\")]\n    Login {\n        #[arg(long, help = \"Label for this Cursor account (e.g., work, personal)\")]\n        name: Option\u003cString\u003e,\n    },\n    #[command(about = \"Logout from a Cursor account\")]\n    Logout {\n        #[arg(long, help = \"Account label or id\")]\n        name: Option\u003cString\u003e,\n        #[arg(long, help = \"Logout from all Cursor accounts\")]\n        all: bool,\n        #[arg(long, help = \"Also delete cached Cursor usage\")]\n        purge_cache: bool,\n    },\n    #[command(about = \"Check Cursor authentication status\")]\n    Status {\n        #[arg(long, help = \"Account label or id\")]\n        name: Option\u003cString\u003e,\n    },\n    #[command(about = \"List saved Cursor accounts\")]\n    Accounts {\n        #[arg(long, help = \"Output as JSON\")]\n        json: bool,\n    },\n    #[command(about = \"Switch active Cursor account\")]\n    Switch {\n        #[arg(help = \"Account label or id\")]\n        name: String,\n    },\n}\n\nfn main() -\u003e Result\u003c()\u003e {\n    use std::io::IsTerminal;\n\n    let cli = Cli::parse();\n    let can_use_tui = std::io::stdin().is_terminal() \u0026\u0026 std::io::stdout().is_terminal();\n\n    if cli.test_data {\n        return tui::test_data_loading();\n    }\n\n    match cli.command {\n        Some(Commands::Models {\n            json,\n            light,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            benchmark,\n            group_by,\n            no_spinner,\n        }) =\u003e {\n            use tokscale_core::GroupBy;\n\n            let group_by: GroupBy = group_by.parse().unwrap_or_else(|e| {\n                eprintln!(\"Error: {}\", e);\n                std::process::exit(1);\n            });\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            if json || light || !can_use_tui {\n                run_models_report(\n                    json,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    benchmark,\n                    no_spinner || !can_use_tui,\n                    today,\n                    week,\n                    month,\n                    group_by,\n                )\n            } else {\n                tui::run(\n                    \u0026cli.theme,\n                    cli.refresh,\n                    cli.debug,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    Some(Tab::Models),\n                )\n            }\n        }\n        Some(Commands::Monthly {\n            json,\n            light,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            benchmark,\n            no_spinner,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            if json || light || !can_use_tui {\n                run_monthly_report(\n                    json,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    benchmark,\n                    no_spinner || !can_use_tui,\n                    today,\n                    week,\n                    month,\n                )\n            } else {\n                tui::run(\n                    \u0026cli.theme,\n                    cli.refresh,\n                    cli.debug,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    Some(Tab::Daily),\n                )\n            }\n        }\n        Some(Commands::Pricing {\n            model_id,\n            json,\n            provider,\n            no_spinner,\n        }) =\u003e run_pricing_lookup(\u0026model_id, json, provider.as_deref(), no_spinner),\n        Some(Commands::Sources { json }) =\u003e run_sources_command(json),\n        Some(Commands::Login) =\u003e run_login_command(),\n        Some(Commands::Logout) =\u003e run_logout_command(),\n        Some(Commands::Whoami) =\u003e run_whoami_command(),\n        Some(Commands::Graph {\n            output,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            benchmark,\n            no_spinner,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            run_graph_command(output, sources, since, until, year, benchmark, no_spinner)\n        }\n        Some(Commands::Tui {\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            tui::run(\n                \u0026cli.theme,\n                cli.refresh,\n                cli.debug,\n                sources,\n                since,\n                until,\n                year,\n                None,\n            )\n        }\n        Some(Commands::Submit {\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            today,\n            week,\n            month,\n            since,\n            until,\n            year,\n            dry_run,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            let (since, until) = build_date_filter(today, week, month, since, until);\n            let year = normalize_year_filter(today, week, month, year);\n            run_submit_command(sources, since, until, year, dry_run)\n        }\n        Some(Commands::Headless {\n            source,\n            args,\n            format,\n            output,\n            no_auto_flags,\n        }) =\u003e run_headless_command(\u0026source, args, format, output, no_auto_flags),\n        Some(Commands::Wrapped {\n            output,\n            year,\n            opencode,\n            claude,\n            codex,\n            gemini,\n            cursor,\n            amp,\n            droid,\n            openclaw,\n            pi,\n            short,\n            agents,\n            clients,\n            disable_pinned,\n            no_spinner: _,\n        }) =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode,\n                claude,\n                codex,\n                gemini,\n                cursor,\n                amp,\n                droid,\n                openclaw,\n                pi,\n            });\n            run_wrapped_command(\n                output,\n                year,\n                sources,\n                short,\n                agents,\n                clients,\n                disable_pinned,\n            )\n        }\n        Some(Commands::Cursor { subcommand }) =\u003e run_cursor_command(subcommand),\n        None =\u003e {\n            let sources = build_source_filter(SourceFlags {\n                opencode: cli.opencode,\n                claude: cli.claude,\n                codex: cli.codex,\n                gemini: cli.gemini,\n                cursor: cli.cursor,\n                amp: cli.amp,\n                droid: cli.droid,\n                openclaw: cli.openclaw,\n                pi: cli.pi,\n            });\n            let (since, until) =\n                build_date_filter(cli.today, cli.week, cli.month, cli.since, cli.until);\n            let year = normalize_year_filter(cli.today, cli.week, cli.month, cli.year);\n            let group_by: tokscale_core::GroupBy = cli.group_by.parse().unwrap_or_else(|e| {\n                eprintln!(\"Error: {}\", e);\n                std::process::exit(1);\n            });\n\n            if cli.json {\n                run_models_report(\n                    cli.json,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    cli.benchmark,\n                    cli.no_spinner || cli.json,\n                    cli.today,\n                    cli.week,\n                    cli.month,\n                    group_by,\n                )\n            } else if cli.light || !can_use_tui {\n                run_models_report(\n                    false,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    cli.benchmark,\n                    cli.no_spinner || !can_use_tui,\n                    cli.today,\n                    cli.week,\n                    cli.month,\n                    group_by,\n                )\n            } else {\n                tui::run(\n                    \u0026cli.theme,\n                    cli.refresh,\n                    cli.debug,\n                    sources,\n                    since,\n                    until,\n                    year,\n                    None,\n                )\n            }\n        }\n    }\n}\n\nstruct SourceFlags {\n    opencode: bool,\n    claude: bool,\n    codex: bool,\n    gemini: bool,\n    cursor: bool,\n    amp: bool,\n    droid: bool,\n    openclaw: bool,\n    pi: bool,\n}\n\nfn build_source_filter(flags: SourceFlags) -\u003e Option\u003cVec\u003cString\u003e\u003e {\n    let mut sources = Vec::new();\n    if flags.opencode {\n        sources.push(\"opencode\".to_string());\n    }\n    if flags.claude {\n        sources.push(\"claude\".to_string());\n    }\n    if flags.codex {\n        sources.push(\"codex\".to_string());\n    }\n    if flags.gemini {\n        sources.push(\"gemini\".to_string());\n    }\n    if flags.cursor {\n        sources.push(\"cursor\".to_string());\n    }\n    if flags.amp {\n        sources.push(\"amp\".to_string());\n    }\n    if flags.droid {\n        sources.push(\"droid\".to_string());\n    }\n    if flags.openclaw {\n        sources.push(\"openclaw\".to_string());\n    }\n    if flags.pi {\n        sources.push(\"pi\".to_string());\n    }\n\n    if sources.is_empty() {\n        None\n    } else {\n        Some(sources)\n    }\n}\n\nfn build_date_filter(\n    today: bool,\n    week: bool,\n    month: bool,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n) -\u003e (Option\u003cString\u003e, Option\u003cString\u003e) {\n    use chrono::{Datelike, Duration, Utc};\n\n    // Use UTC for date shortcuts to match TypeScript behavior\n    // TS uses: new Date().toISOString().split(\"T\")[0]\n    if today {\n        let date = Utc::now().format(\"%Y-%m-%d\").to_string();\n        return (Some(date.clone()), Some(date));\n    }\n\n    if week {\n        let end = Utc::now();\n        let start = end - Duration::days(6);\n        return (\n            Some(start.format(\"%Y-%m-%d\").to_string()),\n            Some(end.format(\"%Y-%m-%d\").to_string()),\n        );\n    }\n\n    if month {\n        let now = Utc::now();\n        let start = now.with_day(1).unwrap_or(now);\n        return (\n            Some(start.format(\"%Y-%m-%d\").to_string()),\n            Some(now.format(\"%Y-%m-%d\").to_string()),\n        );\n    }\n\n    (since, until)\n}\n\nfn normalize_year_filter(\n    today: bool,\n    week: bool,\n    month: bool,\n    year: Option\u003cString\u003e,\n) -\u003e Option\u003cString\u003e {\n    if today || week || month {\n        None\n    } else {\n        year\n    }\n}\n\nfn get_date_range_label(\n    today: bool,\n    week: bool,\n    month: bool,\n    since: \u0026Option\u003cString\u003e,\n    until: \u0026Option\u003cString\u003e,\n    year: \u0026Option\u003cString\u003e,\n) -\u003e Option\u003cString\u003e {\n    if today {\n        return Some(\"Today\".to_string());\n    }\n    if week {\n        return Some(\"Last 7 days\".to_string());\n    }\n    if month {\n        let now = chrono::Utc::now();\n        return Some(now.format(\"%B %Y\").to_string());\n    }\n    if let Some(y) = year {\n        return Some(y.clone());\n    }\n    let mut parts = Vec::new();\n    if let Some(s) = since {\n        parts.push(format!(\"from {}\", s));\n    }\n    if let Some(u) = until {\n        parts.push(format!(\"to {}\", u));\n    }\n    if parts.is_empty() {\n        None\n    } else {\n        Some(parts.join(\" \"))\n    }\n}\n\nstruct LightSpinner {\n    running: Arc\u003cAtomicBool\u003e,\n    handle: Option\u003cJoinHandle\u003c()\u003e\u003e,\n}\n\nconst TABLE_PRESET: \u0026str = \"â”‚â”‚â”€â”€â”œâ”€â”¼â”¤â”‚â”€â”¼â”œâ”¤â”¬â”´â”Œâ”â””â”˜\";\n\nimpl LightSpinner {\n    const WIDTH: usize = 8;\n    const HOLD_START: usize = 30;\n    const HOLD_END: usize = 9;\n    const TRAIL_LENGTH: usize = 4;\n    const TRAIL_COLORS: [u8; 6] = [51, 44, 37, 30, 23, 17];\n    const INACTIVE_COLOR: u8 = 240;\n    const FRAME_MS: u64 = 40;\n\n    fn start(message: \u0026'static str) -\u003e Self {\n        let running = Arc::new(AtomicBool::new(true));\n        let running_thread = Arc::clone(\u0026running);\n        let message = message.to_string();\n\n        let handle = thread::spawn(move || {\n            let mut frame = 0usize;\n            let mut stderr = io::stderr().lock();\n\n            let _ = write!(stderr, \"\\x1b[?25l\");\n            let _ = stderr.flush();\n\n            while running_thread.load(Ordering::Relaxed) {\n                let spinner = Self::frame(frame);\n                let _ = write!(stderr, \"\\r\\x1b[K  {} {}\", spinner, message);\n                let _ = stderr.flush();\n                frame = frame.wrapping_add(1);\n                thread::sleep(Duration::from_millis(Self::FRAME_MS));\n            }\n\n            let _ = write!(stderr, \"\\r\\x1b[K\\x1b[?25h\");\n            let _ = stderr.flush();\n        });\n\n        Self {\n            running,\n            handle: Some(handle),\n        }\n    }\n\n    fn stop(mut self) {\n        self.stop_inner();\n    }\n\n    fn stop_inner(\u0026mut self) {\n        self.running.store(false, Ordering::Relaxed);\n        if let Some(handle) = self.handle.take() {\n            let _ = handle.join();\n        }\n    }\n\n    fn frame(frame: usize) -\u003e String {\n        let (position, forward) = Self::scanner_state(frame);\n        let mut out = String::new();\n\n        for i in 0..Self::WIDTH {\n            let distance = if forward {\n                if position \u003e= i {\n                    position - i\n                } else {\n                    usize::MAX\n                }\n            } else if i \u003e= position {\n                i - position\n            } else {\n                usize::MAX\n            };\n\n            if distance \u003c Self::TRAIL_LENGTH {\n                let color = Self::TRAIL_COLORS[distance.min(Self::TRAIL_COLORS.len() - 1)];\n                out.push_str(\u0026format!(\"\\x1b[38;5;{}mâ– \\x1b[0m\", color));\n            } else {\n                out.push_str(\u0026format!(\"\\x1b[38;5;{}mâ¬\\x1b[0m\", Self::INACTIVE_COLOR));\n            }\n        }\n\n        out\n    }\n\n    fn scanner_state(frame: usize) -\u003e (usize, bool) {\n        let forward_frames = Self::WIDTH;\n        let backward_frames = Self::WIDTH - 1;\n        let total_cycle = forward_frames + Self::HOLD_END + backward_frames + Self::HOLD_START;\n        let normalized = frame % total_cycle;\n\n        if normalized \u003c forward_frames {\n            (normalized, true)\n        } else if normalized \u003c forward_frames + Self::HOLD_END {\n            (Self::WIDTH - 1, true)\n        } else if normalized \u003c forward_frames + Self::HOLD_END + backward_frames {\n            (\n                Self::WIDTH - 2 - (normalized - forward_frames - Self::HOLD_END),\n                false,\n            )\n        } else {\n            (0, false)\n        }\n    }\n}\n\nimpl Drop for LightSpinner {\n    fn drop(\u0026mut self) {\n        self.stop_inner();\n    }\n}\n\nfn run_models_report(\n    json: bool,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    benchmark: bool,\n    no_spinner: bool,\n    today: bool,\n    week: bool,\n    month_flag: bool,\n    group_by: tokscale_core::GroupBy,\n) -\u003e Result\u003c()\u003e {\n    use std::time::Instant;\n    use tokio::runtime::Runtime;\n    use tokscale_core::{get_model_report, GroupBy, ReportOptions};\n\n    let date_range = get_date_range_label(today, week, month_flag, \u0026since, \u0026until, \u0026year);\n\n    let spinner = if no_spinner {\n        None\n    } else {\n        Some(LightSpinner::start(\"Scanning session data...\"))\n    };\n    let start = Instant::now();\n    let rt = Runtime::new()?;\n    let report = rt\n        .block_on(async {\n            get_model_report(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: group_by.clone(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    if let Some(spinner) = spinner {\n        spinner.stop();\n    }\n\n    let processing_time_ms = start.elapsed().as_millis();\n\n    if json {\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct ModelUsageJson {\n            source: String,\n            merged_clients: Option\u003cString\u003e,\n            model: String,\n            provider: String,\n            input: i64,\n            output: i64,\n            cache_read: i64,\n            cache_write: i64,\n            reasoning: i64,\n            message_count: i32,\n            cost: f64,\n        }\n\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct ModelReportJson {\n            group_by: String,\n            entries: Vec\u003cModelUsageJson\u003e,\n            total_input: i64,\n            total_output: i64,\n            total_cache_read: i64,\n            total_cache_write: i64,\n            total_messages: i32,\n            total_cost: f64,\n            processing_time_ms: u32,\n        }\n\n        let output = ModelReportJson {\n            group_by: group_by.to_string(),\n            entries: report\n                .entries\n                .into_iter()\n                .map(|e| ModelUsageJson {\n                    source: e.source,\n                    merged_clients: e.merged_clients,\n                    model: e.model,\n                    provider: e.provider,\n                    input: e.input,\n                    output: e.output,\n                    cache_read: e.cache_read,\n                    cache_write: e.cache_write,\n                    reasoning: e.reasoning,\n                    message_count: e.message_count,\n                    cost: e.cost,\n                })\n                .collect(),\n            total_input: report.total_input,\n            total_output: report.total_output,\n            total_cache_read: report.total_cache_read,\n            total_cache_write: report.total_cache_write,\n            total_messages: report.total_messages,\n            total_cost: report.total_cost,\n            processing_time_ms: report.processing_time_ms,\n        };\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n    } else {\n        use comfy_table::{Attribute, Cell, CellAlignment, Color, ContentArrangement, Table};\n\n        let term_width = crossterm::terminal::size()\n            .map(|(w, _)| w as usize)\n            .unwrap_or(120);\n        let compact = term_width \u003c 100;\n\n        let mut table = Table::new();\n        table.load_preset(TABLE_PRESET);\n        let arrangement = if std::io::stdout().is_terminal() {\n            ContentArrangement::DynamicFullWidth\n        } else {\n            ContentArrangement::Dynamic\n        };\n        table.set_content_arrangement(arrangement);\n        table.enforce_styling();\n\n        if compact {\n            match group_by {\n                GroupBy::Model =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Clients\").fg(Color::Cyan),\n                        Cell::new(\"Providers\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        let clients_str = entry.merged_clients.as_deref().unwrap_or(\u0026entry.source);\n                        let capitalized_clients = clients_str\n                            .split(\", \")\n                            .map(|s| capitalize_source(s))\n                            .collect::\u003cVec\u003c_\u003e\u003e()\n                            .join(\", \");\n                        table.add_row(vec![\n                            Cell::new(capitalized_clients),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n                GroupBy::ClientModel | GroupBy::ClientProviderModel =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Client\").fg(Color::Cyan),\n                        Cell::new(\"Provider\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        table.add_row(vec![\n                            Cell::new(capitalize_source(\u0026entry.source)),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n            }\n        } else {\n            match group_by {\n                GroupBy::Model =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Clients\").fg(Color::Cyan),\n                        Cell::new(\"Providers\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cache Write\").fg(Color::Cyan),\n                        Cell::new(\"Cache Read\").fg(Color::Cyan),\n                        Cell::new(\"Total\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        let total = entry.input + entry.output + entry.cache_write + entry.cache_read;\n\n                        let clients_str = entry.merged_clients.as_deref().unwrap_or(\u0026entry.source);\n                        let capitalized_clients = clients_str\n                            .split(\", \")\n                            .map(|s| capitalize_source(s))\n                            .collect::\u003cVec\u003c_\u003e\u003e()\n                            .join(\", \");\n                        table.add_row(vec![\n                            Cell::new(capitalized_clients),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_write))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_read))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(total))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    let total_all = report.total_input\n                        + report.total_output\n                        + report.total_cache_write\n                        + report.total_cache_read;\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_write))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_read))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(total_all))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n                GroupBy::ClientModel | GroupBy::ClientProviderModel =\u003e {\n                    table.set_header(vec![\n                        Cell::new(\"Client\").fg(Color::Cyan),\n                        Cell::new(\"Provider\").fg(Color::Cyan),\n                        Cell::new(\"Model\").fg(Color::Cyan),\n                        Cell::new(\"Resolved\").fg(Color::Cyan),\n                        Cell::new(\"Input\").fg(Color::Cyan),\n                        Cell::new(\"Output\").fg(Color::Cyan),\n                        Cell::new(\"Cache Write\").fg(Color::Cyan),\n                        Cell::new(\"Cache Read\").fg(Color::Cyan),\n                        Cell::new(\"Total\").fg(Color::Cyan),\n                        Cell::new(\"Cost\").fg(Color::Cyan),\n                    ]);\n\n                    for entry in \u0026report.entries {\n                        let total = entry.input + entry.output + entry.cache_write + entry.cache_read;\n\n                        table.add_row(vec![\n                            Cell::new(capitalize_source(\u0026entry.source)),\n                            Cell::new(\u0026entry.provider).add_attribute(Attribute::Dim),\n                            Cell::new(\u0026entry.model),\n                            Cell::new(format_model_name(\u0026entry.model)),\n                            Cell::new(format_tokens_with_commas(entry.input))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.output))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_write))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(entry.cache_read))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_tokens_with_commas(total))\n                                .set_alignment(CellAlignment::Right),\n                            Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                        ]);\n                    }\n\n                    let total_all = report.total_input\n                        + report.total_output\n                        + report.total_cache_write\n                        + report.total_cache_read;\n                    table.add_row(vec![\n                        Cell::new(\"Total\")\n                            .fg(Color::Yellow)\n                            .add_attribute(Attribute::Bold),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(\"\"),\n                        Cell::new(format_tokens_with_commas(report.total_input))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_output))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_write))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(report.total_cache_read))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_tokens_with_commas(total_all))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                        Cell::new(format_currency(report.total_cost))\n                            .fg(Color::Yellow)\n                            .set_alignment(CellAlignment::Right),\n                    ]);\n                }\n            }\n        }\n\n        let title = match \u0026date_range {\n            Some(range) =\u003e format!(\"Token Usage Report by Model ({})\", range),\n            None =\u003e \"Token Usage Report by Model\".to_string(),\n        };\n        println!(\"\\n  \\x1b[36m{}\\x1b[0m\\n\", title);\n        println!(\"{}\", dim_borders(\u0026table.to_string()));\n\n        let total_tokens =\n            report.total_input + report.total_output + report.total_cache_write + report.total_cache_read;\n        println!(\n            \"\\x1b[90m\\n  Total: {} messages, {} tokens, \\x1b[32m{}\\x1b[90m\\x1b[0m\",\n            format_tokens_with_commas(report.total_messages as i64),\n            format_tokens_with_commas(total_tokens),\n            format_currency(report.total_cost)\n        );\n\n        if benchmark {\n            use colored::Colorize;\n            println!(\n                \"{}\",\n                format!(\"  Processing time: {}ms (Rust native)\", processing_time_ms).bright_black()\n            );\n        }\n    }\n\n    Ok(())\n}\n\nfn run_monthly_report(\n    json: bool,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    benchmark: bool,\n    no_spinner: bool,\n    today: bool,\n    week: bool,\n    month_flag: bool,\n) -\u003e Result\u003c()\u003e {\n    use std::time::Instant;\n    use tokio::runtime::Runtime;\n    use tokscale_core::{get_monthly_report, GroupBy, ReportOptions};\n\n    let date_range = get_date_range_label(today, week, month_flag, \u0026since, \u0026until, \u0026year);\n\n    let spinner = if no_spinner {\n        None\n    } else {\n        Some(LightSpinner::start(\"Scanning session data...\"))\n    };\n    let start = Instant::now();\n    let rt = Runtime::new()?;\n    let report = rt\n        .block_on(async {\n            get_monthly_report(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: GroupBy::default(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    if let Some(spinner) = spinner {\n        spinner.stop();\n    }\n\n    let processing_time_ms = start.elapsed().as_millis();\n\n    if json {\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct MonthlyUsageJson {\n            month: String,\n            models: Vec\u003cString\u003e,\n            input: i64,\n            output: i64,\n            cache_read: i64,\n            cache_write: i64,\n            message_count: i32,\n            cost: f64,\n        }\n\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct MonthlyReportJson {\n            entries: Vec\u003cMonthlyUsageJson\u003e,\n            total_cost: f64,\n            processing_time_ms: u32,\n        }\n\n        let output = MonthlyReportJson {\n            entries: report\n                .entries\n                .into_iter()\n                .map(|e| MonthlyUsageJson {\n                    month: e.month,\n                    models: e.models,\n                    input: e.input,\n                    output: e.output,\n                    cache_read: e.cache_read,\n                    cache_write: e.cache_write,\n                    message_count: e.message_count,\n                    cost: e.cost,\n                })\n                .collect(),\n            total_cost: report.total_cost,\n            processing_time_ms: report.processing_time_ms,\n        };\n\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n    } else {\n        use comfy_table::{Attribute, Cell, CellAlignment, Color, ContentArrangement, Table};\n\n        let term_width = crossterm::terminal::size()\n            .map(|(w, _)| w as usize)\n            .unwrap_or(120);\n        let compact = term_width \u003c 100;\n\n        let mut table = Table::new();\n        table.load_preset(TABLE_PRESET);\n        let arrangement = if std::io::stdout().is_terminal() {\n            ContentArrangement::DynamicFullWidth\n        } else {\n            ContentArrangement::Dynamic\n        };\n        table.set_content_arrangement(arrangement);\n        table.enforce_styling();\n        if compact {\n            table.set_header(vec![\n                Cell::new(\"Month\").fg(Color::Cyan),\n                Cell::new(\"Models\").fg(Color::Cyan),\n                Cell::new(\"Input\").fg(Color::Cyan),\n                Cell::new(\"Output\").fg(Color::Cyan),\n                Cell::new(\"Cost\").fg(Color::Cyan),\n            ]);\n\n            for entry in \u0026report.entries {\n                let models_col = if entry.models.is_empty() {\n                    \"-\".to_string()\n                } else {\n                    let mut unique_models: Vec\u003cString\u003e = entry\n                        .models\n                        .iter()\n                        .map(|model| format_model_name(model))\n                        .collect::\u003cstd::collections::BTreeSet\u003c_\u003e\u003e()\n                        .into_iter()\n                        .collect();\n                    unique_models.sort();\n                    unique_models\n                        .iter()\n                        .map(|m| format!(\"- {}\", m))\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"\\n\")\n                };\n\n                table.add_row(vec![\n                    Cell::new(entry.month.clone()),\n                    Cell::new(models_col),\n                    Cell::new(format_tokens_with_commas(entry.input)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.output)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                ]);\n            }\n\n            table.add_row(vec![\n                Cell::new(\"Total\")\n                    .fg(Color::Yellow)\n                    .add_attribute(Attribute::Bold),\n                Cell::new(\"\"),\n                Cell::new(format_tokens_with_commas(report.entries.iter().map(|e| e.input).sum()))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(report.entries.iter().map(|e| e.output).sum()))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_currency(report.total_cost))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n            ]);\n        } else {\n            table.set_header(vec![\n                Cell::new(\"Month\").fg(Color::Cyan),\n                Cell::new(\"Models\").fg(Color::Cyan),\n                Cell::new(\"Input\").fg(Color::Cyan),\n                Cell::new(\"Output\").fg(Color::Cyan),\n                Cell::new(\"Cache Write\").fg(Color::Cyan),\n                Cell::new(\"Cache Read\").fg(Color::Cyan),\n                Cell::new(\"Total\").fg(Color::Cyan),\n                Cell::new(\"Cost\").fg(Color::Cyan),\n            ]);\n\n            for entry in \u0026report.entries {\n                let models_col = if entry.models.is_empty() {\n                    \"-\".to_string()\n                } else {\n                    let mut unique_models: Vec\u003cString\u003e = entry\n                        .models\n                        .iter()\n                        .map(|model| format_model_name(model))\n                        .collect::\u003cstd::collections::BTreeSet\u003c_\u003e\u003e()\n                        .into_iter()\n                        .collect();\n                    unique_models.sort();\n                    unique_models\n                        .iter()\n                        .map(|m| format!(\"- {}\", m))\n                        .collect::\u003cVec\u003c_\u003e\u003e()\n                        .join(\"\\n\")\n                };\n                let total = entry.input + entry.output + entry.cache_write + entry.cache_read;\n\n                table.add_row(vec![\n                    Cell::new(entry.month.clone()),\n                    Cell::new(models_col),\n                    Cell::new(format_tokens_with_commas(entry.input)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.output)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.cache_write))\n                        .set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(entry.cache_read))\n                        .set_alignment(CellAlignment::Right),\n                    Cell::new(format_tokens_with_commas(total)).set_alignment(CellAlignment::Right),\n                    Cell::new(format_currency(entry.cost)).set_alignment(CellAlignment::Right),\n                ]);\n            }\n\n            let total_input: i64 = report.entries.iter().map(|e| e.input).sum();\n            let total_output: i64 = report.entries.iter().map(|e| e.output).sum();\n            let total_cache_write: i64 = report.entries.iter().map(|e| e.cache_write).sum();\n            let total_cache_read: i64 = report.entries.iter().map(|e| e.cache_read).sum();\n            let total_all = total_input + total_output + total_cache_write + total_cache_read;\n\n            table.add_row(vec![\n                Cell::new(\"Total\")\n                    .fg(Color::Yellow)\n                    .add_attribute(Attribute::Bold),\n                Cell::new(\"\"),\n                Cell::new(format_tokens_with_commas(total_input))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_output))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_cache_write))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_cache_read))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_tokens_with_commas(total_all))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n                Cell::new(format_currency(report.total_cost))\n                    .fg(Color::Yellow)\n                    .set_alignment(CellAlignment::Right),\n            ]);\n        }\n\n        let title = match \u0026date_range {\n            Some(range) =\u003e format!(\"Monthly Token Usage Report ({})\", range),\n            None =\u003e \"Monthly Token Usage Report\".to_string(),\n        };\n        println!(\"\\n  \\x1b[36m{}\\x1b[0m\\n\", title);\n        println!(\"{}\", dim_borders(\u0026table.to_string()));\n\n        println!(\n            \"\\x1b[90m\\n  Total Cost: \\x1b[32m{}\\x1b[90m\\x1b[0m\",\n            format_currency(report.total_cost)\n        );\n\n        if benchmark {\n            use colored::Colorize;\n            println!(\n                \"{}\",\n                format!(\"  Processing time: {}ms (Rust native)\", processing_time_ms).bright_black()\n            );\n        }\n    }\n\n    Ok(())\n}\n\nfn run_wrapped_command(\n    output: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    short: bool,\n    agents: bool,\n    clients: bool,\n    disable_pinned: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n\n    println!(\"{}\", \"\\n  Tokscale - Generate Wrapped Image\\n\".cyan());\n\n    println!(\"{}\", \"  Generating wrapped image...\".bright_black());\n    println!();\n\n    let include_agents = !clients || agents;\n    let wrapped_options = commands::wrapped::WrappedOptions {\n        output,\n        year,\n        sources,\n        short,\n        include_agents,\n        pin_sisyphus: !disable_pinned,\n    };\n\n    match commands::wrapped::run(wrapped_options) {\n        Ok(output_path) =\u003e {\n            println!(\n                \"{}\",\n                format!(\"\\n  âœ“ Generated wrapped image: {}\\n\", output_path).green()\n            );\n        }\n        Err(err) =\u003e {\n            eprintln!(\"{}\", \"\\nError generating wrapped image:\".red());\n            eprintln!(\"{}\", format!(\"  {}\\n\", err));\n            std::process::exit(1);\n        }\n    }\n\n    Ok(())\n}\n\nfn run_pricing_lookup(\n    model_id: \u0026str,\n    json: bool,\n    provider: Option\u003c\u0026str\u003e,\n    no_spinner: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use indicatif::ProgressBar;\n    use indicatif::ProgressStyle;\n    use tokio::runtime::Runtime;\n    use tokscale_core::pricing::PricingService;\n\n    let provider_normalized = provider.map(|p| p.to_lowercase());\n    if let Some(ref p) = provider_normalized {\n        if p != \"litellm\" \u0026\u0026 p != \"openrouter\" {\n            println!(\n                \"\\n  {}\",\n                format!(\"Invalid provider: {}\", provider.unwrap_or(\"\")).red()\n            );\n            println!(\n                \"{}\\n\",\n                \"  Valid providers: litellm, openrouter\".bright_black()\n            );\n            std::process::exit(1);\n        }\n    }\n\n    let spinner = if no_spinner {\n        None\n    } else {\n        let provider_label = provider.map(|p| format!(\" from {}\", p)).unwrap_or_default();\n        let pb = ProgressBar::new_spinner();\n        pb.set_style(ProgressStyle::default_spinner());\n        pb.set_message(format!(\"Fetching pricing data{}...\", provider_label));\n        pb.enable_steady_tick(std::time::Duration::from_millis(100));\n        Some(pb)\n    };\n\n    let rt = Runtime::new()?;\n    let result = match rt.block_on(async {\n        let svc = PricingService::get_or_init().await?;\n        Ok::\u003c_, String\u003e(svc.lookup_with_source(model_id, provider_normalized.as_deref()))\n    }) {\n        Ok(result) =\u003e result,\n        Err(err) =\u003e {\n            if let Some(pb) = spinner {\n                pb.finish_and_clear();\n            }\n            if json {\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct ErrorOutput {\n                    error: String,\n                    model_id: String,\n                }\n                println!(\n                    \"{}\",\n                    serde_json::to_string_pretty(\u0026ErrorOutput {\n                        error: err,\n                        model_id: model_id.to_string(),\n                    })?\n                );\n                std::process::exit(1);\n            }\n            return Err(anyhow::anyhow!(err));\n        }\n    };\n\n    if let Some(pb) = spinner {\n        pb.finish_and_clear();\n    }\n\n    if json {\n        match result {\n            Some(pricing) =\u003e {\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct PricingValues {\n                    input_cost_per_token: f64,\n                    output_cost_per_token: f64,\n                    #[serde(skip_serializing_if = \"Option::is_none\")]\n                    cache_read_input_token_cost: Option\u003cf64\u003e,\n                    #[serde(skip_serializing_if = \"Option::is_none\")]\n                    cache_creation_input_token_cost: Option\u003cf64\u003e,\n                }\n\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct PricingOutput {\n                    model_id: String,\n                    matched_key: String,\n                    source: String,\n                    pricing: PricingValues,\n                }\n\n                let output = PricingOutput {\n                    model_id: model_id.to_string(),\n                    matched_key: pricing.matched_key,\n                    source: pricing.source,\n                    pricing: PricingValues {\n                        input_cost_per_token: pricing.pricing.input_cost_per_token.unwrap_or(0.0),\n                        output_cost_per_token: pricing.pricing.output_cost_per_token.unwrap_or(0.0),\n                        cache_read_input_token_cost: pricing.pricing.cache_read_input_token_cost,\n                        cache_creation_input_token_cost: pricing\n                            .pricing\n                            .cache_creation_input_token_cost,\n                    },\n                };\n\n                println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n            }\n            None =\u003e {\n                #[derive(serde::Serialize)]\n                #[serde(rename_all = \"camelCase\")]\n                struct ErrorOutput {\n                    error: String,\n                    model_id: String,\n                }\n\n                let output = ErrorOutput {\n                    error: \"Model not found\".to_string(),\n                    model_id: model_id.to_string(),\n                };\n\n                println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n                std::process::exit(1);\n            }\n        }\n    } else {\n        match result {\n            Some(pricing) =\u003e {\n                println!(\"\\n  Pricing for: {}\", model_id.bold());\n                println!(\"  Matched key: {}\", pricing.matched_key);\n                let source_label = if pricing.source.eq_ignore_ascii_case(\"litellm\") {\n                    \"LiteLLM\"\n                } else {\n                    \"OpenRouter\"\n                };\n                println!(\"  Source: {}\", source_label);\n                println!();\n                let input = pricing.pricing.input_cost_per_token.unwrap_or(0.0);\n                let output = pricing.pricing.output_cost_per_token.unwrap_or(0.0);\n                println!(\"  Input:  ${:.2} / 1M tokens\", input * 1_000_000.0);\n                println!(\"  Output: ${:.2} / 1M tokens\", output * 1_000_000.0);\n                if let Some(cache_read) = pricing.pricing.cache_read_input_token_cost {\n                    println!(\n                        \"  Cache Read:  ${:.2} / 1M tokens\",\n                        cache_read * 1_000_000.0\n                    );\n                }\n                if let Some(cache_write) = pricing.pricing.cache_creation_input_token_cost {\n                    println!(\n                        \"  Cache Write: ${:.2} / 1M tokens\",\n                        cache_write * 1_000_000.0\n                    );\n                }\n                println!();\n            }\n            None =\u003e {\n                println!(\"\\n  {}\\n\", format!(\"Model not found: {}\", model_id).red());\n                std::process::exit(1);\n            }\n        }\n    }\n\n    Ok(())\n}\n\nfn format_currency(n: f64) -\u003e String {\n    format!(\"${:.2}\", n)\n}\n\nfn dim_borders(table_str: \u0026str) -\u003e String {\n    let border_chars: \u0026[char] = \u0026['â”Œ', 'â”€', 'â”¬', 'â”', 'â”‚', 'â”œ', 'â”¼', 'â”¤', 'â””', 'â”´', 'â”˜'];\n    let mut result = String::with_capacity(table_str.len() * 2);\n\n    for ch in table_str.chars() {\n        if border_chars.contains(\u0026ch) {\n            result.push_str(\"\\x1b[90m\");\n            result.push(ch);\n            result.push_str(\"\\x1b[0m\");\n        } else {\n            result.push(ch);\n        }\n    }\n\n    result\n}\n\nfn format_model_name(model: \u0026str) -\u003e String {\n    let name = model.strip_prefix(\"claude-\").unwrap_or(model);\n    if name.len() \u003e 9 {\n        let potential_date = \u0026name[name.len() - 8..];\n        if potential_date.chars().all(|c| c.is_ascii_digit()) \u0026\u0026 name.as_bytes()[name.len() - 9] == b'-' {\n            return name[..name.len() - 9].to_string();\n        }\n    }\n    name.to_string()\n}\n\nfn capitalize_source(source: \u0026str) -\u003e String {\n    match source {\n        \"opencode\" =\u003e \"OpenCode\".to_string(),\n        \"claude\" =\u003e \"Claude\".to_string(),\n        \"codex\" =\u003e \"Codex\".to_string(),\n        \"cursor\" =\u003e \"Cursor\".to_string(),\n        \"gemini\" =\u003e \"Gemini\".to_string(),\n        \"amp\" =\u003e \"Amp\".to_string(),\n        \"droid\" =\u003e \"Droid\".to_string(),\n        \"openclaw\" =\u003e \"openclaw\".to_string(),\n        \"pi\" =\u003e \"Pi\".to_string(),\n        other =\u003e other.to_string(),\n    }\n}\n\nfn run_sources_command(json: bool) -\u003e Result\u003c()\u003e {\n    use tokscale_core::{parse_local_sources, LocalParseOptions};\n\n    let home_dir =\n        dirs::home_dir().ok_or_else(|| anyhow::anyhow!(\"Could not determine home directory\"))?;\n\n    let parsed = parse_local_sources(LocalParseOptions {\n        home_dir: Some(home_dir.to_string_lossy().to_string()),\n        sources: Some(vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]),\n        since: None,\n        until: None,\n        year: None,\n    })\n    .map_err(|e| anyhow::anyhow!(e))?;\n\n    let headless_roots = get_headless_roots(\u0026home_dir);\n    let headless_codex_count = parsed\n        .messages\n        .iter()\n        .filter(|m| m.agent.as_deref() == Some(\"headless\") \u0026\u0026 m.source == \"codex\")\n        .count() as i32;\n\n    #[derive(serde::Serialize)]\n    #[serde(rename_all = \"camelCase\")]\n    struct SourceRow {\n        source: String,\n        label: String,\n        sessions_path: String,\n        sessions_path_exists: bool,\n        #[serde(skip_serializing_if = \"Vec::is_empty\")]\n        legacy_paths: Vec\u003cLegacyPath\u003e,\n        message_count: i32,\n        headless_supported: bool,\n        #[serde(skip_serializing_if = \"Vec::is_empty\")]\n        headless_paths: Vec\u003cHeadlessPath\u003e,\n        headless_message_count: i32,\n    }\n\n    #[derive(serde::Serialize)]\n    #[serde(rename_all = \"camelCase\")]\n    struct LegacyPath {\n        path: String,\n        exists: bool,\n    }\n\n    #[derive(serde::Serialize)]\n    #[serde(rename_all = \"camelCase\")]\n    struct HeadlessPath {\n        path: String,\n        exists: bool,\n    }\n\n    let sources = vec![\n        SourceRow {\n            source: \"opencode\".to_string(),\n            label: \"OpenCode\".to_string(),\n            sessions_path: home_dir\n                .join(\".local/share/opencode/storage/message\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir\n                .join(\".local/share/opencode/storage/message\")\n                .exists(),\n            legacy_paths: vec![],\n            message_count: parsed.opencode_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"claude\".to_string(),\n            label: \"Claude Code\".to_string(),\n            sessions_path: home_dir\n                .join(\".claude/projects\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".claude/projects\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.claude_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"codex\".to_string(),\n            label: \"Codex CLI\".to_string(),\n            sessions_path: get_codex_home(\u0026home_dir)\n                .join(\"sessions\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: get_codex_home(\u0026home_dir).join(\"sessions\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.codex_count,\n            headless_supported: true,\n            headless_paths: headless_roots\n                .iter()\n                .map(|root| {\n                    let path = root.join(\"codex\");\n                    HeadlessPath {\n                        path: path.to_string_lossy().to_string(),\n                        exists: path.exists(),\n                    }\n                })\n                .collect(),\n            headless_message_count: headless_codex_count,\n        },\n        SourceRow {\n            source: \"gemini\".to_string(),\n            label: \"Gemini CLI\".to_string(),\n            sessions_path: home_dir.join(\".gemini/tmp\").to_string_lossy().to_string(),\n            sessions_path_exists: home_dir.join(\".gemini/tmp\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.gemini_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"cursor\".to_string(),\n            label: \"Cursor IDE\".to_string(),\n            sessions_path: home_dir\n                .join(\".config/tokscale/cursor-cache\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".config/tokscale/cursor-cache\").exists(),\n            legacy_paths: vec![],\n            message_count: 0,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"amp\".to_string(),\n            label: \"Amp\".to_string(),\n            sessions_path: home_dir\n                .join(\".local/share/amp/threads\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".local/share/amp/threads\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.amp_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"droid\".to_string(),\n            label: \"Droid\".to_string(),\n            sessions_path: home_dir\n                .join(\".factory/sessions\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".factory/sessions\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.droid_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"openclaw\".to_string(),\n            label: \"OpenClaw\".to_string(),\n            sessions_path: home_dir\n                .join(\".openclaw/agents\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".openclaw/agents\").exists(),\n            legacy_paths: vec![\n                LegacyPath {\n                    path: home_dir\n                        .join(\".clawdbot/agents\")\n                        .to_string_lossy()\n                        .to_string(),\n                    exists: home_dir.join(\".clawdbot/agents\").exists(),\n                },\n                LegacyPath {\n                    path: home_dir\n                        .join(\".moltbot/agents\")\n                        .to_string_lossy()\n                        .to_string(),\n                    exists: home_dir.join(\".moltbot/agents\").exists(),\n                },\n                LegacyPath {\n                    path: home_dir\n                        .join(\".moldbot/agents\")\n                        .to_string_lossy()\n                        .to_string(),\n                    exists: home_dir.join(\".moldbot/agents\").exists(),\n                },\n            ],\n            message_count: parsed.openclaw_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n        SourceRow {\n            source: \"pi\".to_string(),\n            label: \"Pi\".to_string(),\n            sessions_path: home_dir\n                .join(\".pi/agent/sessions\")\n                .to_string_lossy()\n                .to_string(),\n            sessions_path_exists: home_dir.join(\".pi/agent/sessions\").exists(),\n            legacy_paths: vec![],\n            message_count: parsed.pi_count,\n            headless_supported: false,\n            headless_paths: vec![],\n            headless_message_count: 0,\n        },\n    ];\n\n    if json {\n        #[derive(serde::Serialize)]\n        #[serde(rename_all = \"camelCase\")]\n        struct Output {\n            headless_roots: Vec\u003cString\u003e,\n            sources: Vec\u003cSourceRow\u003e,\n            note: String,\n        }\n\n        let output = Output {\n            headless_roots: headless_roots\n                .iter()\n                .map(|p| p.to_string_lossy().to_string())\n                .collect(),\n            sources,\n            note: \"Headless capture is supported for Codex CLI only.\".to_string(),\n        };\n\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output)?);\n    } else {\n        use colored::Colorize;\n\n        println!(\"\\n  {}\", \"Local sources \u0026 session counts\".cyan());\n        println!(\n            \"  {}\",\n            format!(\n                \"Headless roots: {}\",\n                headless_roots\n                    .iter()\n                    .map(|p| p.to_string_lossy())\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\", \")\n            )\n            .bright_black()\n        );\n        println!();\n\n        for row in sources {\n            println!(\"  {}\", row.label.white());\n            println!(\n                \"  {}\",\n                format!(\n                    \"sessions: {}\",\n                    describe_path(\u0026row.sessions_path, row.sessions_path_exists)\n                )\n                .bright_black()\n            );\n\n            if !row.legacy_paths.is_empty() {\n                let legacy_desc: Vec\u003cString\u003e = row\n                    .legacy_paths\n                    .iter()\n                    .map(|lp| describe_path(\u0026lp.path, lp.exists))\n                    .collect();\n                println!(\n                    \"  {}\",\n                    format!(\"legacy: {}\", legacy_desc.join(\", \")).bright_black()\n                );\n            }\n\n            if row.headless_supported {\n                let headless_desc: Vec\u003cString\u003e = row\n                    .headless_paths\n                    .iter()\n                    .map(|hp| describe_path(\u0026hp.path, hp.exists))\n                    .collect();\n                println!(\n                    \"  {}\",\n                    format!(\"headless: {}\", headless_desc.join(\", \")).bright_black()\n                );\n                println!(\n                    \"  {}\",\n                    format!(\n                        \"messages: {} (headless: {})\",\n                        format_number(row.message_count),\n                        format_number(row.headless_message_count)\n                    )\n                    .bright_black()\n                );\n            } else {\n                println!(\n                    \"  {}\",\n                    format!(\"messages: {}\", format_number(row.message_count)).bright_black()\n                );\n            }\n\n            println!();\n        }\n\n        println!(\n            \"  {}\",\n            \"Note: Headless capture is supported for Codex CLI only.\".bright_black()\n        );\n        println!();\n    }\n\n    Ok(())\n}\n\nfn get_headless_roots(home_dir: \u0026Path) -\u003e Vec\u003cPathBuf\u003e {\n    let mut roots = Vec::new();\n\n    if let Ok(env_dir) = std::env::var(\"TOKSCALE_HEADLESS_DIR\") {\n        roots.push(PathBuf::from(env_dir));\n    } else {\n        roots.push(home_dir.join(\".config/tokscale/headless\"));\n\n        #[cfg(target_os = \"macos\")]\n        {\n            roots.push(home_dir.join(\"Library/Application Support/tokscale/headless\"));\n        }\n    }\n\n    roots\n}\n\nfn get_codex_home(home_dir: \u0026Path) -\u003e PathBuf {\n    if let Ok(codex_home) = std::env::var(\"CODEX_HOME\") {\n        PathBuf::from(codex_home)\n    } else {\n        home_dir.join(\".codex\")\n    }\n}\n\nfn describe_path(path: \u0026str, exists: bool) -\u003e String {\n    let path_display = if let Some(home) = dirs::home_dir() {\n        path.replace(\u0026home.to_string_lossy().to_string(), \"~\")\n    } else {\n        path.to_string()\n    };\n    if exists {\n        format!(\"{} âœ“\", path_display)\n    } else {\n        format!(\"{} âœ—\", path_display)\n    }\n}\n\nfn format_number(n: i32) -\u003e String {\n    if n \u003e= 1_000_000 {\n        format!(\"{:.1}M\", n as f64 / 1_000_000.0)\n    } else if n \u003e= 1_000 {\n        format!(\"{:.1}K\", n as f64 / 1_000.0)\n    } else {\n        n.to_string()\n    }\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsTokenBreakdown {\n    input: i64,\n    output: i64,\n    cache_read: i64,\n    cache_write: i64,\n    reasoning: i64,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsSourceContribution {\n    source: String,\n    model_id: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    provider_id: Option\u003cString\u003e,\n    tokens: TsTokenBreakdown,\n    cost: f64,\n    messages: i32,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsDailyTotals {\n    tokens: i64,\n    cost: f64,\n    messages: i32,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsDailyContribution {\n    date: String,\n    totals: TsDailyTotals,\n    intensity: u8,\n    token_breakdown: TsTokenBreakdown,\n    sources: Vec\u003cTsSourceContribution\u003e,\n}\n\n#[derive(serde::Serialize)]\nstruct DateRange {\n    start: String,\n    end: String,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsYearSummary {\n    year: String,\n    total_tokens: i64,\n    total_cost: f64,\n    range: DateRange,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsDataSummary {\n    total_tokens: i64,\n    total_cost: f64,\n    total_days: i32,\n    active_days: i32,\n    average_per_day: f64,\n    max_cost_in_single_day: f64,\n    sources: Vec\u003cString\u003e,\n    models: Vec\u003cString\u003e,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsExportMeta {\n    generated_at: String,\n    version: String,\n    date_range: DateRange,\n}\n\n#[derive(serde::Serialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct TsTokenContributionData {\n    meta: TsExportMeta,\n    summary: TsDataSummary,\n    years: Vec\u003cTsYearSummary\u003e,\n    contributions: Vec\u003cTsDailyContribution\u003e,\n}\n\nfn to_ts_token_contribution_data(graph: \u0026tokscale_core::GraphResult) -\u003e TsTokenContributionData {\n    TsTokenContributionData {\n        meta: TsExportMeta {\n            generated_at: graph.meta.generated_at.clone(),\n            version: graph.meta.version.clone(),\n            date_range: DateRange {\n                start: graph.meta.date_range_start.clone(),\n                end: graph.meta.date_range_end.clone(),\n            },\n        },\n        summary: TsDataSummary {\n            total_tokens: graph.summary.total_tokens,\n            total_cost: graph.summary.total_cost,\n            total_days: graph.summary.total_days,\n            active_days: graph.summary.active_days,\n            average_per_day: graph.summary.average_per_day,\n            max_cost_in_single_day: graph.summary.max_cost_in_single_day,\n            sources: graph.summary.sources.clone(),\n            models: graph.summary.models.clone(),\n        },\n        years: graph\n            .years\n            .iter()\n            .map(|y| TsYearSummary {\n                year: y.year.clone(),\n                total_tokens: y.total_tokens,\n                total_cost: y.total_cost,\n                range: DateRange {\n                    start: y.range_start.clone(),\n                    end: y.range_end.clone(),\n                },\n            })\n            .collect(),\n        contributions: graph\n            .contributions\n            .iter()\n            .map(|d| TsDailyContribution {\n                date: d.date.clone(),\n                totals: TsDailyTotals {\n                    tokens: d.totals.tokens,\n                    cost: d.totals.cost,\n                    messages: d.totals.messages,\n                },\n                intensity: d.intensity,\n                token_breakdown: TsTokenBreakdown {\n                    input: d.token_breakdown.input,\n                    output: d.token_breakdown.output,\n                    cache_read: d.token_breakdown.cache_read,\n                    cache_write: d.token_breakdown.cache_write,\n                    reasoning: d.token_breakdown.reasoning,\n                },\n                sources: d\n                    .sources\n                    .iter()\n                    .map(|s| TsSourceContribution {\n                        source: s.source.clone(),\n                        model_id: s.model_id.clone(),\n                        provider_id: if s.provider_id.is_empty() {\n                            None\n                        } else {\n                            Some(s.provider_id.clone())\n                        },\n                        tokens: TsTokenBreakdown {\n                            input: s.tokens.input,\n                            output: s.tokens.output,\n                            cache_read: s.tokens.cache_read,\n                            cache_write: s.tokens.cache_write,\n                            reasoning: s.tokens.reasoning,\n                        },\n                        cost: s.cost,\n                        messages: s.messages,\n                    })\n                    .collect(),\n            })\n            .collect(),\n    }\n}\n\nfn run_login_command() -\u003e Result\u003c()\u003e {\n    use tokio::runtime::Runtime;\n\n    let rt = Runtime::new()?;\n    rt.block_on(async { auth::login().await })\n}\n\nfn run_logout_command() -\u003e Result\u003c()\u003e {\n    auth::logout()\n}\n\nfn run_whoami_command() -\u003e Result\u003c()\u003e {\n    auth::whoami()\n}\n\nfn prompt_star_repo() -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use std::io::{self, Write};\n    use std::process::Command;\n\n    let gh_available = Command::new(\"gh\")\n        .arg(\"--version\")\n        .output()\n        .map(|out| out.status.success())\n        .unwrap_or(false);\n\n    if !gh_available {\n        return Ok(());\n    }\n\n    println!(\n        \"{}\",\n        \"  Please consider starring tokscale on GitHub!\".bright_black()\n    );\n    print!(\"  Star now with gh CLI? [y/N]: \");\n    io::stdout().flush()?;\n\n    let mut input = String::new();\n    io::stdin().read_line(\u0026mut input)?;\n    let answer = input.trim().to_lowercase();\n    if answer != \"y\" \u0026\u0026 answer != \"yes\" {\n        println!();\n        return Ok(());\n    }\n\n    let status = Command::new(\"gh\")\n        .args([\"repo\", \"star\", \"junhoyeo/tokscale\"])\n        .status();\n    match status {\n        Ok(s) if s.success() =\u003e {\n            println!(\"{}\", \"  âœ“ Starred! Thank you for your support.\".green());\n            println!();\n        }\n        _ =\u003e {\n            println!(\n                \"{}\",\n                \"  Failed to star via gh CLI. Continuing to submit...\".yellow()\n            );\n            println!();\n        }\n    }\n\n    Ok(())\n}\n\nfn run_graph_command(\n    output: Option\u003cString\u003e,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    benchmark: bool,\n    no_spinner: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use std::time::Instant;\n    use tokscale_core::{generate_graph, GroupBy, ReportOptions};\n\n    let show_progress = output.is_some() \u0026\u0026 !no_spinner;\n    let include_cursor = sources\n        .as_ref()\n        .map_or(true, |s| s.iter().any(|src| src == \"cursor\"));\n    let has_cursor_cache = cursor::has_cursor_usage_cache();\n    let mut cursor_sync_result: Option\u003ccursor::SyncCursorResult\u003e = None;\n\n    if include_cursor \u0026\u0026 cursor::is_cursor_logged_in() {\n        let rt_sync = tokio::runtime::Runtime::new()?;\n        cursor_sync_result = Some(rt_sync.block_on(async { cursor::sync_cursor_cache().await }));\n    }\n\n    if show_progress {\n        eprintln!(\"  Scanning session data...\");\n    }\n    let start = Instant::now();\n\n    if show_progress {\n        eprintln!(\"  Generating graph data...\");\n    }\n    let rt = tokio::runtime::Runtime::new()?;\n    let graph_result = rt\n        .block_on(async {\n            generate_graph(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: GroupBy::default(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    let processing_time_ms = start.elapsed().as_millis() as u32;\n    let output_data = to_ts_token_contribution_data(\u0026graph_result);\n    let json_output = serde_json::to_string_pretty(\u0026output_data)?;\n\n    if let Some(output_path) = output {\n        std::fs::write(\u0026output_path, json_output)?;\n\n        eprintln!(\n            \"{}\",\n            format!(\"âœ“ Graph data written to {}\", output_path).green()\n        );\n        eprintln!(\n            \"{}\",\n            format!(\n                \"  {} days, {} sources, {} models\",\n                output_data.contributions.len(),\n                output_data.summary.sources.len(),\n                output_data.summary.models.len()\n            )\n            .bright_black()\n        );\n        eprintln!(\n            \"{}\",\n            format!(\n                \"  Total: {}\",\n                format_currency(output_data.summary.total_cost)\n            )\n            .bright_black()\n        );\n\n        if benchmark {\n            eprintln!(\n                \"{}\",\n                format!(\"  Processing time: {}ms (Rust native)\", processing_time_ms).bright_black()\n            );\n            if let Some(sync) = cursor_sync_result {\n                if sync.synced {\n                    eprintln!(\n                        \"{}\",\n                        format!(\n                            \"  Cursor: {} usage events synced (full lifetime data)\",\n                            sync.rows\n                        )\n                        .bright_black()\n                    );\n                } else if let Some(err) = sync.error {\n                    if has_cursor_cache {\n                        eprintln!(\"{}\", format!(\"  Cursor: sync failed - {}\", err).yellow());\n                    }\n                }\n            }\n        }\n    } else {\n        println!(\"{}\", json_output);\n    }\n\n    Ok(())\n}\n\n#[derive(serde::Deserialize)]\nstruct SubmitResponse {\n    #[serde(rename = \"submissionId\")]\n    submission_id: Option\u003cString\u003e,\n    #[allow(dead_code)]\n    username: Option\u003cString\u003e,\n    metrics: Option\u003cSubmitMetrics\u003e,\n    warnings: Option\u003cVec\u003cString\u003e\u003e,\n    error: Option\u003cString\u003e,\n    details: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(serde::Deserialize)]\nstruct SubmitMetrics {\n    #[serde(rename = \"totalTokens\")]\n    total_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"totalCost\")]\n    total_cost: Option\u003cf64\u003e,\n    #[serde(rename = \"activeDays\")]\n    active_days: Option\u003ci32\u003e,\n    #[allow(dead_code)]\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n}\n\nfn run_submit_command(\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    dry_run: bool,\n) -\u003e Result\u003c()\u003e {\n    use colored::Colorize;\n    use std::io::IsTerminal;\n    use tokio::runtime::Runtime;\n    use tokscale_core::{generate_graph, GroupBy, ReportOptions};\n\n    let credentials = match auth::load_credentials() {\n        Some(creds) =\u003e creds,\n        None =\u003e {\n            eprintln!(\"\\n  {}\", \"Not logged in.\".yellow());\n            eprintln!(\"{}\", \"  Run 'tokscale login' first.\\n\".bright_black());\n            std::process::exit(1);\n        }\n    };\n\n    if std::io::stdin().is_terminal() \u0026\u0026 std::io::stdout().is_terminal() {\n        let _ = prompt_star_repo();\n    }\n\n    println!(\"\\n  {}\\n\", \"Tokscale - Submit Usage Data\".cyan());\n\n    let include_cursor = sources\n        .as_ref()\n        .map_or(true, |s| s.iter().any(|src| src == \"cursor\"));\n    let has_cursor_cache = cursor::has_cursor_usage_cache();\n    if include_cursor \u0026\u0026 cursor::is_cursor_logged_in() {\n        println!(\"{}\", \"  Syncing Cursor usage data...\".bright_black());\n        let rt_sync = Runtime::new()?;\n        let sync_result = rt_sync.block_on(async { cursor::sync_cursor_cache().await });\n        if sync_result.synced {\n            println!(\n                \"{}\",\n                format!(\"  Cursor: {} usage events synced\", sync_result.rows).bright_black()\n            );\n        } else if let Some(err) = sync_result.error {\n            if has_cursor_cache {\n                println!(\n                    \"{}\",\n                    format!(\"  Cursor sync failed; using cached data: {}\", err).yellow()\n                );\n            }\n        }\n    }\n\n    println!(\"{}\", \"  Scanning local session data...\".bright_black());\n\n    let rt = Runtime::new()?;\n    let graph_result = rt\n        .block_on(async {\n            generate_graph(ReportOptions {\n                home_dir: None,\n                sources,\n                since,\n                until,\n                year,\n                group_by: GroupBy::default(),\n            })\n            .await\n        })\n        .map_err(|e| anyhow::anyhow!(e))?;\n\n    println!(\"{}\", \"  Data to submit:\".white());\n    println!(\n        \"{}\",\n        format!(\n            \"    Date range: {} to {}\",\n            graph_result.meta.date_range_start, graph_result.meta.date_range_end,\n        )\n        .bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\"    Active days: {}\", graph_result.summary.active_days).bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\n            \"    Total tokens: {}\",\n            format_tokens_with_commas(graph_result.summary.total_tokens)\n        )\n        .bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\n            \"    Total cost: {}\",\n            format_currency(graph_result.summary.total_cost)\n        )\n        .bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\"    Sources: {}\", graph_result.summary.sources.join(\", \")).bright_black()\n    );\n    println!(\n        \"{}\",\n        format!(\"    Models: {} models\", graph_result.summary.models.len()).bright_black()\n    );\n    println!();\n\n    if graph_result.summary.total_tokens == 0 {\n        println!(\"{}\", \"  No usage data found to submit.\\n\".yellow());\n        return Ok(());\n    }\n\n    if dry_run {\n        println!(\"{}\", \"  Dry run - not submitting data.\\n\".yellow());\n        return Ok(());\n    }\n\n    println!(\"{}\", \"  Submitting to server...\".bright_black());\n\n    let api_url = auth::get_api_base_url();\n\n    let submit_payload = to_ts_token_contribution_data(\u0026graph_result);\n\n    let response = rt.block_on(async {\n        reqwest::Client::new()\n            .post(format!(\"{}/api/submit\", api_url))\n            .header(\"Content-Type\", \"application/json\")\n            .header(\"Authorization\", format!(\"Bearer {}\", credentials.token))\n            .json(\u0026submit_payload)\n            .send()\n            .await\n    });\n\n    match response {\n        Ok(resp) =\u003e {\n            let status = resp.status();\n            let body: SubmitResponse =\n                rt.block_on(async { resp.json().await })\n                    .unwrap_or_else(|_| SubmitResponse {\n                        submission_id: None,\n                        username: None,\n                        metrics: None,\n                        warnings: None,\n                        error: Some(format!(\n                            \"Server returned {} with unparseable response\",\n                            status\n                        )),\n                        details: None,\n                    });\n\n            if !status.is_success() {\n                eprintln!(\n                    \"\\n  {}\",\n                    format!(\n                        \"Error: {}\",\n                        body.error\n                            .unwrap_or_else(|| \"Submission failed\".to_string())\n                    )\n                    .red()\n                );\n                if let Some(details) = body.details {\n                    for detail in details {\n                        eprintln!(\"{}\", format!(\"    - {}\", detail).bright_black());\n                    }\n                }\n                println!();\n                std::process::exit(1);\n            }\n\n            println!(\"\\n  {}\", \"Successfully submitted!\".green());\n            println!();\n            println!(\"{}\", \"  Summary:\".white());\n            if let Some(id) = body.submission_id {\n                println!(\"{}\", format!(\"    Submission ID: {}\", id).bright_black());\n            }\n            if let Some(metrics) = \u0026body.metrics {\n                if let Some(tokens) = metrics.total_tokens {\n                    println!(\n                        \"{}\",\n                        format!(\"    Total tokens: {}\", format_tokens_with_commas(tokens))\n                            .bright_black()\n                    );\n                }\n                if let Some(cost) = metrics.total_cost {\n                    println!(\n                        \"{}\",\n                        format!(\"    Total cost: {}\", format_currency(cost)).bright_black()\n                    );\n                }\n                if let Some(days) = metrics.active_days {\n                    println!(\"{}\", format!(\"    Active days: {}\", days).bright_black());\n                }\n            }\n            println!();\n            println!(\n                \"{}\",\n                format!(\n                    \"  View your profile: {}/u/{}\",\n                    api_url, credentials.username\n                )\n                .cyan()\n            );\n            println!();\n\n            if let Some(warnings) = body.warnings {\n                if !warnings.is_empty() {\n                    println!(\"{}\", \"  Warnings:\".yellow());\n                    for warning in warnings {\n                        println!(\"{}\", format!(\"    - {}\", warning).bright_black());\n                    }\n                    println!();\n                }\n            }\n        }\n        Err(err) =\u003e {\n            eprintln!(\"\\n  {}\", \"Error: Failed to connect to server.\".red());\n            eprintln!(\"{}\\n\", format!(\"  {}\", err).bright_black());\n            std::process::exit(1);\n        }\n    }\n\n    Ok(())\n}\n\nfn run_cursor_command(subcommand: CursorSubcommand) -\u003e Result\u003c()\u003e {\n    match subcommand {\n        CursorSubcommand::Login { name } =\u003e cursor::run_cursor_login(name),\n        CursorSubcommand::Logout {\n            name,\n            all,\n            purge_cache,\n        } =\u003e cursor::run_cursor_logout(name, all, purge_cache),\n        CursorSubcommand::Status { name } =\u003e cursor::run_cursor_status(name),\n        CursorSubcommand::Accounts { json } =\u003e cursor::run_cursor_accounts(json),\n        CursorSubcommand::Switch { name } =\u003e cursor::run_cursor_switch(\u0026name),\n    }\n}\n\nfn format_tokens_with_commas(n: i64) -\u003e String {\n    let s = n.to_string();\n    let bytes = s.as_bytes();\n    let len = bytes.len();\n    let mut result = String::with_capacity(len + len / 3);\n    for (i, \u0026b) in bytes.iter().enumerate() {\n        if i \u003e 0 \u0026\u0026 (len - i).is_multiple_of(3) {\n            result.push(',');\n        }\n        result.push(b as char);\n    }\n    result\n}\n\nfn run_headless_command(\n    source: \u0026str,\n    args: Vec\u003cString\u003e,\n    format: Option\u003cString\u003e,\n    output: Option\u003cString\u003e,\n    no_auto_flags: bool,\n) -\u003e Result\u003c()\u003e {\n    use chrono::Utc;\n    use std::io::{Read, Write};\n    use std::process::Command;\n    use std::sync::atomic::{AtomicBool, Ordering};\n    use std::sync::Arc;\n    use uuid::Uuid;\n\n    let source_lower = source.to_lowercase();\n    if source_lower != \"codex\" {\n        eprintln!(\"\\n  Error: Unknown headless source '{}'.\", source);\n        eprintln!(\"  Currently only 'codex' is supported.\\n\");\n        std::process::exit(1);\n    }\n\n    let resolved_format = match format {\n        Some(f) if f == \"json\" || f == \"jsonl\" =\u003e f,\n        Some(f) =\u003e {\n            eprintln!(\"\\n  Error: Invalid format '{}'. Use json or jsonl.\\n\", f);\n            std::process::exit(1);\n        }\n        None =\u003e \"jsonl\".to_string(),\n    };\n\n    let mut final_args = args.clone();\n    if !no_auto_flags \u0026\u0026 source_lower == \"codex\" \u0026\u0026 !final_args.contains(\u0026\"--json\".to_string()) {\n        final_args.push(\"--json\".to_string());\n    }\n\n    let home_dir =\n        dirs::home_dir().ok_or_else(|| anyhow::anyhow!(\"Could not determine home directory\"))?;\n    let headless_roots = get_headless_roots(\u0026home_dir);\n\n    let output_path = if let Some(custom_output) = output {\n        let parent = Path::new(\u0026custom_output)\n            .parent()\n            .unwrap_or_else(|| Path::new(\".\"));\n        std::fs::create_dir_all(parent)?;\n        custom_output\n    } else {\n        let root = headless_roots\n            .first()\n            .cloned()\n            .unwrap_or_else(|| home_dir.join(\".config/tokscale/headless\"));\n        let dir = root.join(\u0026source_lower);\n        std::fs::create_dir_all(\u0026dir)?;\n\n        let now = Utc::now();\n        let timestamp = now.format(\"%Y-%m-%dT%H-%M-%S-%3fZ\").to_string();\n        let uuid_short = Uuid::new_v4()\n            .to_string()\n            .replace(\"-\", \"\")\n            .chars()\n            .take(8)\n            .collect::\u003cString\u003e();\n        let filename = format!(\n            \"{}-{}-{}.{}\",\n            source_lower, timestamp, uuid_short, resolved_format\n        );\n\n        dir.join(filename).to_string_lossy().to_string()\n    };\n\n    let settings = tui::settings::Settings::load();\n    let timeout = settings.get_native_timeout();\n\n    use colored::Colorize;\n    println!(\"\\n  {}\", \"Headless capture\".cyan());\n    println!(\"  {}\", format!(\"source: {}\", source_lower).bright_black());\n    println!(\"  {}\", format!(\"output: {}\", output_path).bright_black());\n    println!(\n        \"  {}\",\n        format!(\"timeout: {}s\", timeout.as_secs()).bright_black()\n    );\n    println!();\n\n    let mut child = Command::new(\u0026source_lower)\n        .args(\u0026final_args)\n        .stdout(std::process::Stdio::piped())\n        .stderr(std::process::Stdio::inherit())\n        .stdin(std::process::Stdio::inherit())\n        .spawn()\n        .map_err(|e| anyhow::anyhow!(\"Failed to spawn '{}': {}\", source_lower, e))?;\n\n    let stdout = child\n        .stdout\n        .take()\n        .ok_or_else(|| anyhow::anyhow!(\"Failed to capture stdout from command\"))?;\n\n    let mut output_file = std::fs::File::create(\u0026output_path)\n        .map_err(|e| anyhow::anyhow!(\"Failed to create output file '{}': {}\", output_path, e))?;\n\n    let timed_out = Arc::new(AtomicBool::new(false));\n    let timed_out_clone = Arc::clone(\u0026timed_out);\n    let child_id = child.id();\n\n    let timeout_handle = std::thread::spawn(move || {\n        std::thread::sleep(timeout);\n        if !timed_out_clone.load(Ordering::SeqCst) {\n            timed_out_clone.store(true, Ordering::SeqCst);\n            #[cfg(unix)]\n            {\n                let _ = std::process::Command::new(\"kill\")\n                    .arg(\"-9\")\n                    .arg(child_id.to_string())\n                    .output();\n            }\n            #[cfg(windows)]\n            {\n                let _ = std::process::Command::new(\"taskkill\")\n                    .args([\"/F\", \"/PID\", \u0026child_id.to_string()])\n                    .output();\n            }\n        }\n    });\n\n    let mut reader = std::io::BufReader::new(stdout);\n    let mut buffer = [0; 8192];\n    loop {\n        match reader.read(\u0026mut buffer) {\n            Ok(0) =\u003e break,\n            Ok(n) =\u003e {\n                output_file\n                    .write_all(\u0026buffer[..n])\n                    .map_err(|e| anyhow::anyhow!(\"Failed to write to output file: {}\", e))?;\n            }\n            Err(e) =\u003e {\n                if timed_out.load(Ordering::SeqCst) {\n                    break;\n                }\n                return Err(anyhow::anyhow!(\n                    \"Failed to read from subprocess stdout: {}\",\n                    e\n                ));\n            }\n        }\n    }\n\n    let status = child\n        .wait()\n        .map_err(|e| anyhow::anyhow!(\"Failed to wait for subprocess: {}\", e))?;\n\n    timed_out.store(true, Ordering::SeqCst);\n    let _ = timeout_handle.join();\n\n    if timed_out.load(Ordering::SeqCst) \u0026\u0026 !status.success() {\n        eprintln!(\n            \"{}\",\n            format!(\"\\n  Subprocess timed out after {}s\", timeout.as_secs()).red()\n        );\n        eprintln!(\"{}\", \"  Partial output saved. Increase timeout with TOKSCALE_NATIVE_TIMEOUT_MS or settings.json\".bright_black());\n        println!();\n        std::process::exit(124);\n    }\n\n    let exit_code = status.code().unwrap_or(1);\n\n    println!(\n        \"{}\",\n        format!(\"âœ“ Saved headless output to {}\", output_path).green()\n    );\n    println!();\n\n    if exit_code != 0 {\n        std::process::exit(exit_code);\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_build_source_filter_all_false() {\n        let flags = SourceFlags {\n            opencode: false,\n            claude: false,\n            codex: false,\n            gemini: false,\n            cursor: false,\n            amp: false,\n            droid: false,\n            openclaw: false,\n            pi: false,\n        };\n        assert_eq!(build_source_filter(flags), None);\n    }\n\n    #[test]\n    fn test_build_source_filter_single_source() {\n        let flags = SourceFlags {\n            opencode: true,\n            claude: false,\n            codex: false,\n            gemini: false,\n            cursor: false,\n            amp: false,\n            droid: false,\n            openclaw: false,\n            pi: false,\n        };\n        assert_eq!(\n            build_source_filter(flags),\n            Some(vec![\"opencode\".to_string()])\n        );\n    }\n\n    #[test]\n    fn test_build_source_filter_multiple_sources() {\n        let flags = SourceFlags {\n            opencode: true,\n            claude: true,\n            codex: false,\n            gemini: false,\n            cursor: false,\n            amp: false,\n            droid: false,\n            openclaw: false,\n            pi: true,\n        };\n        assert_eq!(\n            build_source_filter(flags),\n            Some(vec![\n                \"opencode\".to_string(),\n                \"claude\".to_string(),\n                \"pi\".to_string()\n            ])\n        );\n    }\n\n    #[test]\n    fn test_build_source_filter_all_sources() {\n        let flags = SourceFlags {\n            opencode: true,\n            claude: true,\n            codex: true,\n            gemini: true,\n            cursor: true,\n            amp: true,\n            droid: true,\n            openclaw: true,\n            pi: true,\n        };\n        let result = build_source_filter(flags);\n        assert!(result.is_some());\n        let sources = result.unwrap();\n        assert_eq!(sources.len(), 9);\n        assert!(sources.contains(\u0026\"opencode\".to_string()));\n        assert!(sources.contains(\u0026\"claude\".to_string()));\n        assert!(sources.contains(\u0026\"codex\".to_string()));\n        assert!(sources.contains(\u0026\"gemini\".to_string()));\n        assert!(sources.contains(\u0026\"cursor\".to_string()));\n        assert!(sources.contains(\u0026\"amp\".to_string()));\n        assert!(sources.contains(\u0026\"droid\".to_string()));\n        assert!(sources.contains(\u0026\"openclaw\".to_string()));\n        assert!(sources.contains(\u0026\"pi\".to_string()));\n    }\n\n    #[test]\n    fn test_build_date_filter_custom_range() {\n        let (since, until) = build_date_filter(\n            false,\n            false,\n            false,\n            Some(\"2024-01-01\".to_string()),\n            Some(\"2024-12-31\".to_string()),\n        );\n        assert_eq!(since, Some(\"2024-01-01\".to_string()));\n        assert_eq!(until, Some(\"2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_build_date_filter_no_filters() {\n        let (since, until) = build_date_filter(false, false, false, None, None);\n        assert_eq!(since, None);\n        assert_eq!(until, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_year() {\n        let year = normalize_year_filter(false, false, false, Some(\"2024\".to_string()));\n        assert_eq!(year, Some(\"2024\".to_string()));\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_today() {\n        let year = normalize_year_filter(true, false, false, Some(\"2024\".to_string()));\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_week() {\n        let year = normalize_year_filter(false, true, false, Some(\"2024\".to_string()));\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_with_month() {\n        let year = normalize_year_filter(false, false, true, Some(\"2024\".to_string()));\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_normalize_year_filter_no_year() {\n        let year = normalize_year_filter(false, false, false, None);\n        assert_eq!(year, None);\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_small() {\n        assert_eq!(format_tokens_with_commas(123), \"123\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_thousands() {\n        assert_eq!(format_tokens_with_commas(1234), \"1,234\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_millions() {\n        assert_eq!(format_tokens_with_commas(1234567), \"1,234,567\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_billions() {\n        assert_eq!(format_tokens_with_commas(1234567890), \"1,234,567,890\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_zero() {\n        assert_eq!(format_tokens_with_commas(0), \"0\");\n    }\n\n    #[test]\n    fn test_format_tokens_with_commas_negative() {\n        assert_eq!(format_tokens_with_commas(-1234567), \"-1,234,567\");\n    }\n\n    #[test]\n    fn test_format_currency_zero() {\n        assert_eq!(format_currency(0.0), \"$0.00\");\n    }\n\n    #[test]\n    fn test_format_currency_small() {\n        assert_eq!(format_currency(12.34), \"$12.34\");\n    }\n\n    #[test]\n    fn test_format_currency_large() {\n        assert_eq!(format_currency(1234.56), \"$1234.56\");\n    }\n\n    #[test]\n    fn test_format_currency_rounds() {\n        assert_eq!(format_currency(12.345), \"$12.35\");\n        assert_eq!(format_currency(12.344), \"$12.34\");\n    }\n\n    #[test]\n    fn test_capitalize_source_opencode() {\n        assert_eq!(capitalize_source(\"opencode\"), \"OpenCode\");\n    }\n\n    #[test]\n    fn test_capitalize_source_claude() {\n        assert_eq!(capitalize_source(\"claude\"), \"Claude\");\n    }\n\n    #[test]\n    fn test_capitalize_source_codex() {\n        assert_eq!(capitalize_source(\"codex\"), \"Codex\");\n    }\n\n    #[test]\n    fn test_capitalize_source_cursor() {\n        assert_eq!(capitalize_source(\"cursor\"), \"Cursor\");\n    }\n\n    #[test]\n    fn test_capitalize_source_gemini() {\n        assert_eq!(capitalize_source(\"gemini\"), \"Gemini\");\n    }\n\n    #[test]\n    fn test_capitalize_source_amp() {\n        assert_eq!(capitalize_source(\"amp\"), \"Amp\");\n    }\n\n    #[test]\n    fn test_capitalize_source_droid() {\n        assert_eq!(capitalize_source(\"droid\"), \"Droid\");\n    }\n\n    #[test]\n    fn test_capitalize_source_openclaw() {\n        assert_eq!(capitalize_source(\"openclaw\"), \"openclaw\");\n    }\n\n    #[test]\n    fn test_capitalize_source_pi() {\n        assert_eq!(capitalize_source(\"pi\"), \"Pi\");\n    }\n\n    #[test]\n    fn test_capitalize_source_unknown() {\n        assert_eq!(capitalize_source(\"unknown\"), \"unknown\");\n    }\n\n    #[test]\n    fn test_get_date_range_label_today() {\n        let label = get_date_range_label(true, false, false, \u0026None, \u0026None, \u0026None);\n        assert_eq!(label, Some(\"Today\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_week() {\n        let label = get_date_range_label(false, true, false, \u0026None, \u0026None, \u0026None);\n        assert_eq!(label, Some(\"Last 7 days\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_year() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026None,\n            \u0026None,\n            \u0026Some(\"2024\".to_string()),\n        );\n        assert_eq!(label, Some(\"2024\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_custom_since() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026Some(\"2024-01-01\".to_string()),\n            \u0026None,\n            \u0026None,\n        );\n        assert_eq!(label, Some(\"from 2024-01-01\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_custom_until() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026None,\n            \u0026Some(\"2024-12-31\".to_string()),\n            \u0026None,\n        );\n        assert_eq!(label, Some(\"to 2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_custom_range() {\n        let label = get_date_range_label(\n            false,\n            false,\n            false,\n            \u0026Some(\"2024-01-01\".to_string()),\n            \u0026Some(\"2024-12-31\".to_string()),\n            \u0026None,\n        );\n        assert_eq!(label, Some(\"from 2024-01-01 to 2024-12-31\".to_string()));\n    }\n\n    #[test]\n    fn test_get_date_range_label_none() {\n        let label = get_date_range_label(false, false, false, \u0026None, \u0026None, \u0026None);\n        assert_eq!(label, None);\n    }\n\n    #[test]\n    fn test_light_spinner_frame_0() {\n        let frame = LightSpinner::frame(0);\n        assert!(frame.contains(\"â– \"));\n        assert!(frame.contains(\"â¬\"));\n    }\n\n    #[test]\n    fn test_light_spinner_frame_1() {\n        let frame = LightSpinner::frame(1);\n        assert!(frame.contains(\"â– \"));\n        assert!(frame.contains(\"â¬\"));\n    }\n\n    #[test]\n    fn test_light_spinner_frame_2() {\n        let frame = LightSpinner::frame(2);\n        assert!(frame.contains(\"â– \"));\n        assert!(frame.contains(\"â¬\"));\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_forward_start() {\n        let (position, forward) = LightSpinner::scanner_state(0);\n        assert_eq!(position, 0);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_forward_mid() {\n        let (position, forward) = LightSpinner::scanner_state(4);\n        assert_eq!(position, 4);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_forward_end() {\n        let (position, forward) = LightSpinner::scanner_state(7);\n        assert_eq!(position, 7);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_hold_end() {\n        let (position, forward) = LightSpinner::scanner_state(8);\n        assert_eq!(position, 7);\n        assert_eq!(forward, true);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_backward_start() {\n        let (position, forward) = LightSpinner::scanner_state(17);\n        assert_eq!(position, 6);\n        assert_eq!(forward, false);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_backward_end() {\n        let (position, forward) = LightSpinner::scanner_state(23);\n        assert_eq!(position, 0);\n        assert_eq!(forward, false);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_hold_start() {\n        let (position, forward) = LightSpinner::scanner_state(24);\n        assert_eq!(position, 0);\n        assert_eq!(forward, false);\n    }\n\n    #[test]\n    fn test_light_spinner_scanner_state_cycle_wrap() {\n        // Total cycle = 8 + 9 + 7 + 30 = 54\n        let (position1, forward1) = LightSpinner::scanner_state(0);\n        let (position2, forward2) = LightSpinner::scanner_state(54);\n        assert_eq!(position1, position2);\n        assert_eq!(forward1, forward2);\n    }\n}\n","traces":[{"line":414,"address":[],"length":0,"stats":{"Line":22}},{"line":417,"address":[],"length":0,"stats":{"Line":44}},{"line":418,"address":[],"length":0,"stats":{"Line":66}},{"line":420,"address":[],"length":0,"stats":{"Line":22}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":3}},{"line":426,"address":[],"length":0,"stats":{"Line":2}},{"line":427,"address":[],"length":0,"stats":{"Line":2}},{"line":428,"address":[],"length":0,"stats":{"Line":2}},{"line":429,"address":[],"length":0,"stats":{"Line":2}},{"line":430,"address":[],"length":0,"stats":{"Line":2}},{"line":431,"address":[],"length":0,"stats":{"Line":2}},{"line":432,"address":[],"length":0,"stats":{"Line":2}},{"line":433,"address":[],"length":0,"stats":{"Line":2}},{"line":434,"address":[],"length":0,"stats":{"Line":2}},{"line":435,"address":[],"length":0,"stats":{"Line":2}},{"line":436,"address":[],"length":0,"stats":{"Line":2}},{"line":437,"address":[],"length":0,"stats":{"Line":2}},{"line":438,"address":[],"length":0,"stats":{"Line":2}},{"line":439,"address":[],"length":0,"stats":{"Line":2}},{"line":440,"address":[],"length":0,"stats":{"Line":2}},{"line":441,"address":[],"length":0,"stats":{"Line":2}},{"line":442,"address":[],"length":0,"stats":{"Line":2}},{"line":443,"address":[],"length":0,"stats":{"Line":2}},{"line":444,"address":[],"length":0,"stats":{"Line":2}},{"line":445,"address":[],"length":0,"stats":{"Line":2}},{"line":449,"address":[],"length":0,"stats":{"Line":8}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":6}},{"line":454,"address":[],"length":0,"stats":{"Line":4}},{"line":455,"address":[],"length":0,"stats":{"Line":4}},{"line":456,"address":[],"length":0,"stats":{"Line":4}},{"line":457,"address":[],"length":0,"stats":{"Line":4}},{"line":458,"address":[],"length":0,"stats":{"Line":4}},{"line":459,"address":[],"length":0,"stats":{"Line":4}},{"line":460,"address":[],"length":0,"stats":{"Line":4}},{"line":461,"address":[],"length":0,"stats":{"Line":2}},{"line":462,"address":[],"length":0,"stats":{"Line":2}},{"line":464,"address":[],"length":0,"stats":{"Line":14}},{"line":465,"address":[],"length":0,"stats":{"Line":12}},{"line":466,"address":[],"length":0,"stats":{"Line":4}},{"line":468,"address":[],"length":0,"stats":{"Line":2}},{"line":469,"address":[],"length":0,"stats":{"Line":2}},{"line":470,"address":[],"length":0,"stats":{"Line":2}},{"line":471,"address":[],"length":0,"stats":{"Line":2}},{"line":472,"address":[],"length":0,"stats":{"Line":2}},{"line":473,"address":[],"length":0,"stats":{"Line":2}},{"line":474,"address":[],"length":0,"stats":{"Line":4}},{"line":475,"address":[],"length":0,"stats":{"Line":2}},{"line":476,"address":[],"length":0,"stats":{"Line":2}},{"line":477,"address":[],"length":0,"stats":{"Line":2}},{"line":478,"address":[],"length":0,"stats":{"Line":2}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":1}},{"line":674,"address":[],"length":0,"stats":{"Line":1}},{"line":675,"address":[],"length":0,"stats":{"Line":1}},{"line":676,"address":[],"length":0,"stats":{"Line":1}},{"line":677,"address":[],"length":0,"stats":{"Line":1}},{"line":678,"address":[],"length":0,"stats":{"Line":6}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":57}},{"line":721,"address":[],"length":0,"stats":{"Line":38}},{"line":722,"address":[],"length":0,"stats":{"Line":38}},{"line":723,"address":[],"length":0,"stats":{"Line":38}},{"line":724,"address":[],"length":0,"stats":{"Line":38}},{"line":725,"address":[],"length":0,"stats":{"Line":38}},{"line":726,"address":[],"length":0,"stats":{"Line":38}},{"line":727,"address":[],"length":0,"stats":{"Line":38}},{"line":728,"address":[],"length":0,"stats":{"Line":19}},{"line":729,"address":[],"length":0,"stats":{"Line":19}},{"line":731,"address":[],"length":0,"stats":{"Line":38}},{"line":732,"address":[],"length":0,"stats":{"Line":95}},{"line":733,"address":[],"length":0,"stats":{"Line":114}},{"line":734,"address":[],"length":0,"stats":{"Line":76}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":19}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":746,"address":[],"length":0,"stats":{"Line":0}},{"line":747,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":19}},{"line":756,"address":[],"length":0,"stats":{"Line":19}},{"line":757,"address":[],"length":0,"stats":{"Line":19}},{"line":758,"address":[],"length":0,"stats":{"Line":19}},{"line":759,"address":[],"length":0,"stats":{"Line":19}},{"line":760,"address":[],"length":0,"stats":{"Line":19}},{"line":761,"address":[],"length":0,"stats":{"Line":38}},{"line":762,"address":[],"length":0,"stats":{"Line":19}},{"line":763,"address":[],"length":0,"stats":{"Line":19}},{"line":764,"address":[],"length":0,"stats":{"Line":19}},{"line":765,"address":[],"length":0,"stats":{"Line":19}},{"line":769,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":2}},{"line":796,"address":[],"length":0,"stats":{"Line":4}},{"line":797,"address":[],"length":0,"stats":{"Line":2}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":800,"address":[],"length":0,"stats":{"Line":2}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":2}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":2}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":2}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":812,"address":[],"length":0,"stats":{"Line":2}},{"line":813,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":2}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":2}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":2}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":4}},{"line":826,"address":[],"length":0,"stats":{"Line":2}},{"line":828,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":2}},{"line":843,"address":[],"length":0,"stats":{"Line":2}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":848,"address":[],"length":0,"stats":{"Line":2}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":851,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":853,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":2}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":861,"address":[],"length":0,"stats":{"Line":0}},{"line":862,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":2}},{"line":869,"address":[],"length":0,"stats":{"Line":2}},{"line":875,"address":[],"length":0,"stats":{"Line":6}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":2}},{"line":882,"address":[],"length":0,"stats":{"Line":2}},{"line":890,"address":[],"length":0,"stats":{"Line":2}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":893,"address":[],"length":0,"stats":{"Line":2}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":2}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":3}},{"line":901,"address":[],"length":0,"stats":{"Line":1}},{"line":903,"address":[],"length":0,"stats":{"Line":2}},{"line":904,"address":[],"length":0,"stats":{"Line":3}},{"line":905,"address":[],"length":0,"stats":{"Line":2}},{"line":907,"address":[],"length":0,"stats":{"Line":1}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":2}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":913,"address":[],"length":0,"stats":{"Line":2}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":949,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":967,"address":[],"length":0,"stats":{"Line":0}},{"line":968,"address":[],"length":0,"stats":{"Line":0}},{"line":969,"address":[],"length":0,"stats":{"Line":0}},{"line":970,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":985,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":988,"address":[],"length":0,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":995,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1002,"address":[],"length":0,"stats":{"Line":0}},{"line":1003,"address":[],"length":0,"stats":{"Line":0}},{"line":1004,"address":[],"length":0,"stats":{"Line":0}},{"line":1005,"address":[],"length":0,"stats":{"Line":0}},{"line":1006,"address":[],"length":0,"stats":{"Line":0}},{"line":1008,"address":[],"length":0,"stats":{"Line":0}},{"line":1009,"address":[],"length":0,"stats":{"Line":0}},{"line":1010,"address":[],"length":0,"stats":{"Line":0}},{"line":1011,"address":[],"length":0,"stats":{"Line":0}},{"line":1012,"address":[],"length":0,"stats":{"Line":0}},{"line":1014,"address":[],"length":0,"stats":{"Line":0}},{"line":1015,"address":[],"length":0,"stats":{"Line":0}},{"line":1018,"address":[],"length":0,"stats":{"Line":0}},{"line":1024,"address":[],"length":0,"stats":{"Line":0}},{"line":1025,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":2}},{"line":1046,"address":[],"length":0,"stats":{"Line":16}},{"line":1048,"address":[],"length":0,"stats":{"Line":4}},{"line":1049,"address":[],"length":0,"stats":{"Line":2}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1053,"address":[],"length":0,"stats":{"Line":4}},{"line":1054,"address":[],"length":0,"stats":{"Line":4}},{"line":1055,"address":[],"length":0,"stats":{"Line":4}},{"line":1056,"address":[],"length":0,"stats":{"Line":4}},{"line":1057,"address":[],"length":0,"stats":{"Line":4}},{"line":1058,"address":[],"length":0,"stats":{"Line":4}},{"line":1059,"address":[],"length":0,"stats":{"Line":4}},{"line":1060,"address":[],"length":0,"stats":{"Line":4}},{"line":1061,"address":[],"length":0,"stats":{"Line":4}},{"line":1062,"address":[],"length":0,"stats":{"Line":4}},{"line":1063,"address":[],"length":0,"stats":{"Line":2}},{"line":1065,"address":[],"length":0,"stats":{"Line":2}},{"line":1067,"address":[],"length":0,"stats":{"Line":2}},{"line":1069,"address":[],"length":0,"stats":{"Line":2}},{"line":1070,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":6}},{"line":1075,"address":[],"length":0,"stats":{"Line":2}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1127,"address":[],"length":0,"stats":{"Line":0}},{"line":1128,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1130,"address":[],"length":0,"stats":{"Line":0}},{"line":1131,"address":[],"length":0,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":4}},{"line":1138,"address":[],"length":0,"stats":{"Line":4}},{"line":1140,"address":[],"length":0,"stats":{"Line":4}},{"line":1142,"address":[],"length":0,"stats":{"Line":4}},{"line":1143,"address":[],"length":0,"stats":{"Line":6}},{"line":1144,"address":[],"length":0,"stats":{"Line":6}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1147,"address":[],"length":0,"stats":{"Line":2}},{"line":1149,"address":[],"length":0,"stats":{"Line":6}},{"line":1150,"address":[],"length":0,"stats":{"Line":4}},{"line":1152,"address":[],"length":0,"stats":{"Line":2}},{"line":1153,"address":[],"length":0,"stats":{"Line":2}},{"line":1155,"address":[],"length":0,"stats":{"Line":0}},{"line":1156,"address":[],"length":0,"stats":{"Line":0}},{"line":1157,"address":[],"length":0,"stats":{"Line":0}},{"line":1158,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1161,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1165,"address":[],"length":0,"stats":{"Line":0}},{"line":1166,"address":[],"length":0,"stats":{"Line":0}},{"line":1168,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1172,"address":[],"length":0,"stats":{"Line":0}},{"line":1173,"address":[],"length":0,"stats":{"Line":0}},{"line":1174,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[],"length":0,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1183,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1185,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1188,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1191,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1194,"address":[],"length":0,"stats":{"Line":0}},{"line":1195,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1201,"address":[],"length":0,"stats":{"Line":6}},{"line":1202,"address":[],"length":0,"stats":{"Line":6}},{"line":1203,"address":[],"length":0,"stats":{"Line":6}},{"line":1204,"address":[],"length":0,"stats":{"Line":6}},{"line":1205,"address":[],"length":0,"stats":{"Line":6}},{"line":1206,"address":[],"length":0,"stats":{"Line":6}},{"line":1207,"address":[],"length":0,"stats":{"Line":6}},{"line":1210,"address":[],"length":0,"stats":{"Line":2}},{"line":1211,"address":[],"length":0,"stats":{"Line":0}},{"line":1212,"address":[],"length":0,"stats":{"Line":0}},{"line":1213,"address":[],"length":0,"stats":{"Line":0}},{"line":1214,"address":[],"length":0,"stats":{"Line":0}},{"line":1215,"address":[],"length":0,"stats":{"Line":0}},{"line":1216,"address":[],"length":0,"stats":{"Line":0}},{"line":1217,"address":[],"length":0,"stats":{"Line":0}},{"line":1218,"address":[],"length":0,"stats":{"Line":0}},{"line":1219,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":6}},{"line":1224,"address":[],"length":0,"stats":{"Line":2}},{"line":1225,"address":[],"length":0,"stats":{"Line":4}},{"line":1226,"address":[],"length":0,"stats":{"Line":4}},{"line":1227,"address":[],"length":0,"stats":{"Line":2}},{"line":1228,"address":[],"length":0,"stats":{"Line":2}},{"line":1229,"address":[],"length":0,"stats":{"Line":6}},{"line":1230,"address":[],"length":0,"stats":{"Line":4}},{"line":1231,"address":[],"length":0,"stats":{"Line":4}},{"line":1232,"address":[],"length":0,"stats":{"Line":6}},{"line":1233,"address":[],"length":0,"stats":{"Line":4}},{"line":1234,"address":[],"length":0,"stats":{"Line":4}},{"line":1235,"address":[],"length":0,"stats":{"Line":6}},{"line":1236,"address":[],"length":0,"stats":{"Line":4}},{"line":1237,"address":[],"length":0,"stats":{"Line":4}},{"line":1242,"address":[],"length":0,"stats":{"Line":0}},{"line":1244,"address":[],"length":0,"stats":{"Line":0}},{"line":1245,"address":[],"length":0,"stats":{"Line":0}},{"line":1246,"address":[],"length":0,"stats":{"Line":0}},{"line":1247,"address":[],"length":0,"stats":{"Line":0}},{"line":1248,"address":[],"length":0,"stats":{"Line":0}},{"line":1249,"address":[],"length":0,"stats":{"Line":0}},{"line":1250,"address":[],"length":0,"stats":{"Line":0}},{"line":1251,"address":[],"length":0,"stats":{"Line":0}},{"line":1252,"address":[],"length":0,"stats":{"Line":0}},{"line":1253,"address":[],"length":0,"stats":{"Line":0}},{"line":1256,"address":[],"length":0,"stats":{"Line":0}},{"line":1257,"address":[],"length":0,"stats":{"Line":0}},{"line":1259,"address":[],"length":0,"stats":{"Line":0}},{"line":1260,"address":[],"length":0,"stats":{"Line":0}},{"line":1262,"address":[],"length":0,"stats":{"Line":0}},{"line":1265,"address":[],"length":0,"stats":{"Line":0}},{"line":1266,"address":[],"length":0,"stats":{"Line":0}},{"line":1267,"address":[],"length":0,"stats":{"Line":0}},{"line":1268,"address":[],"length":0,"stats":{"Line":0}},{"line":1269,"address":[],"length":0,"stats":{"Line":0}},{"line":1270,"address":[],"length":0,"stats":{"Line":0}},{"line":1271,"address":[],"length":0,"stats":{"Line":0}},{"line":1272,"address":[],"length":0,"stats":{"Line":0}},{"line":1273,"address":[],"length":0,"stats":{"Line":0}},{"line":1274,"address":[],"length":0,"stats":{"Line":0}},{"line":1275,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1277,"address":[],"length":0,"stats":{"Line":0}},{"line":1278,"address":[],"length":0,"stats":{"Line":0}},{"line":1279,"address":[],"length":0,"stats":{"Line":0}},{"line":1283,"address":[],"length":0,"stats":{"Line":0}},{"line":1284,"address":[],"length":0,"stats":{"Line":0}},{"line":1285,"address":[],"length":0,"stats":{"Line":0}},{"line":1286,"address":[],"length":0,"stats":{"Line":0}},{"line":1287,"address":[],"length":0,"stats":{"Line":0}},{"line":1288,"address":[],"length":0,"stats":{"Line":0}},{"line":1289,"address":[],"length":0,"stats":{"Line":0}},{"line":1290,"address":[],"length":0,"stats":{"Line":0}},{"line":1291,"address":[],"length":0,"stats":{"Line":0}},{"line":1292,"address":[],"length":0,"stats":{"Line":0}},{"line":1293,"address":[],"length":0,"stats":{"Line":0}},{"line":1294,"address":[],"length":0,"stats":{"Line":0}},{"line":1295,"address":[],"length":0,"stats":{"Line":0}},{"line":1296,"address":[],"length":0,"stats":{"Line":0}},{"line":1297,"address":[],"length":0,"stats":{"Line":0}},{"line":1298,"address":[],"length":0,"stats":{"Line":0}},{"line":1299,"address":[],"length":0,"stats":{"Line":0}},{"line":1300,"address":[],"length":0,"stats":{"Line":0}},{"line":1301,"address":[],"length":0,"stats":{"Line":0}},{"line":1302,"address":[],"length":0,"stats":{"Line":0}},{"line":1303,"address":[],"length":0,"stats":{"Line":0}},{"line":1304,"address":[],"length":0,"stats":{"Line":0}},{"line":1305,"address":[],"length":0,"stats":{"Line":0}},{"line":1306,"address":[],"length":0,"stats":{"Line":0}},{"line":1307,"address":[],"length":0,"stats":{"Line":0}},{"line":1308,"address":[],"length":0,"stats":{"Line":0}},{"line":1309,"address":[],"length":0,"stats":{"Line":0}},{"line":1310,"address":[],"length":0,"stats":{"Line":0}},{"line":1314,"address":[],"length":0,"stats":{"Line":0}},{"line":1315,"address":[],"length":0,"stats":{"Line":0}},{"line":1316,"address":[],"length":0,"stats":{"Line":0}},{"line":1317,"address":[],"length":0,"stats":{"Line":0}},{"line":1318,"address":[],"length":0,"stats":{"Line":0}},{"line":1319,"address":[],"length":0,"stats":{"Line":0}},{"line":1320,"address":[],"length":0,"stats":{"Line":0}},{"line":1321,"address":[],"length":0,"stats":{"Line":0}},{"line":1322,"address":[],"length":0,"stats":{"Line":0}},{"line":1323,"address":[],"length":0,"stats":{"Line":0}},{"line":1324,"address":[],"length":0,"stats":{"Line":0}},{"line":1327,"address":[],"length":0,"stats":{"Line":0}},{"line":1328,"address":[],"length":0,"stats":{"Line":0}},{"line":1330,"address":[],"length":0,"stats":{"Line":0}},{"line":1331,"address":[],"length":0,"stats":{"Line":0}},{"line":1332,"address":[],"length":0,"stats":{"Line":0}},{"line":1333,"address":[],"length":0,"stats":{"Line":0}},{"line":1334,"address":[],"length":0,"stats":{"Line":0}},{"line":1335,"address":[],"length":0,"stats":{"Line":0}},{"line":1336,"address":[],"length":0,"stats":{"Line":0}},{"line":1337,"address":[],"length":0,"stats":{"Line":0}},{"line":1338,"address":[],"length":0,"stats":{"Line":0}},{"line":1339,"address":[],"length":0,"stats":{"Line":0}},{"line":1340,"address":[],"length":0,"stats":{"Line":0}},{"line":1341,"address":[],"length":0,"stats":{"Line":0}},{"line":1342,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1345,"address":[],"length":0,"stats":{"Line":0}},{"line":1349,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1351,"address":[],"length":0,"stats":{"Line":0}},{"line":1352,"address":[],"length":0,"stats":{"Line":0}},{"line":1353,"address":[],"length":0,"stats":{"Line":0}},{"line":1354,"address":[],"length":0,"stats":{"Line":0}},{"line":1355,"address":[],"length":0,"stats":{"Line":0}},{"line":1356,"address":[],"length":0,"stats":{"Line":0}},{"line":1357,"address":[],"length":0,"stats":{"Line":0}},{"line":1358,"address":[],"length":0,"stats":{"Line":0}},{"line":1359,"address":[],"length":0,"stats":{"Line":0}},{"line":1360,"address":[],"length":0,"stats":{"Line":0}},{"line":1361,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1365,"address":[],"length":0,"stats":{"Line":0}},{"line":1366,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1368,"address":[],"length":0,"stats":{"Line":0}},{"line":1369,"address":[],"length":0,"stats":{"Line":0}},{"line":1370,"address":[],"length":0,"stats":{"Line":0}},{"line":1371,"address":[],"length":0,"stats":{"Line":0}},{"line":1372,"address":[],"length":0,"stats":{"Line":0}},{"line":1373,"address":[],"length":0,"stats":{"Line":0}},{"line":1374,"address":[],"length":0,"stats":{"Line":0}},{"line":1375,"address":[],"length":0,"stats":{"Line":0}},{"line":1376,"address":[],"length":0,"stats":{"Line":0}},{"line":1377,"address":[],"length":0,"stats":{"Line":0}},{"line":1383,"address":[],"length":0,"stats":{"Line":4}},{"line":1384,"address":[],"length":0,"stats":{"Line":4}},{"line":1385,"address":[],"length":0,"stats":{"Line":0}},{"line":1387,"address":[],"length":0,"stats":{"Line":2}},{"line":1388,"address":[],"length":0,"stats":{"Line":6}},{"line":1390,"address":[],"length":0,"stats":{"Line":2}},{"line":1391,"address":[],"length":0,"stats":{"Line":2}},{"line":1392,"address":[],"length":0,"stats":{"Line":2}},{"line":1394,"address":[],"length":0,"stats":{"Line":4}},{"line":1395,"address":[],"length":0,"stats":{"Line":4}},{"line":1396,"address":[],"length":0,"stats":{"Line":4}},{"line":1399,"address":[],"length":0,"stats":{"Line":2}},{"line":1401,"address":[],"length":0,"stats":{"Line":0}},{"line":1403,"address":[],"length":0,"stats":{"Line":0}},{"line":1408,"address":[],"length":0,"stats":{"Line":2}},{"line":1411,"address":[],"length":0,"stats":{"Line":0}},{"line":1427,"address":[],"length":0,"stats":{"Line":0}},{"line":1429,"address":[],"length":0,"stats":{"Line":0}},{"line":1430,"address":[],"length":0,"stats":{"Line":0}},{"line":1432,"address":[],"length":0,"stats":{"Line":0}},{"line":1434,"address":[],"length":0,"stats":{"Line":0}},{"line":1435,"address":[],"length":0,"stats":{"Line":0}},{"line":1436,"address":[],"length":0,"stats":{"Line":0}},{"line":1437,"address":[],"length":0,"stats":{"Line":0}},{"line":1438,"address":[],"length":0,"stats":{"Line":0}},{"line":1439,"address":[],"length":0,"stats":{"Line":0}},{"line":1440,"address":[],"length":0,"stats":{"Line":0}},{"line":1441,"address":[],"length":0,"stats":{"Line":0}},{"line":1442,"address":[],"length":0,"stats":{"Line":0}},{"line":1443,"address":[],"length":0,"stats":{"Line":0}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":0}},{"line":1448,"address":[],"length":0,"stats":{"Line":0}},{"line":1450,"address":[],"length":0,"stats":{"Line":0}},{"line":1451,"address":[],"length":0,"stats":{"Line":0}},{"line":1454,"address":[],"length":0,"stats":{"Line":0}},{"line":1456,"address":[],"length":0,"stats":{"Line":0}},{"line":1479,"address":[],"length":0,"stats":{"Line":0}},{"line":1493,"address":[],"length":0,"stats":{"Line":0}},{"line":1494,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":0}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1502,"address":[],"length":0,"stats":{"Line":0}},{"line":1504,"address":[],"length":0,"stats":{"Line":0}},{"line":1506,"address":[],"length":0,"stats":{"Line":0}},{"line":1507,"address":[],"length":0,"stats":{"Line":0}},{"line":1508,"address":[],"length":0,"stats":{"Line":0}},{"line":1509,"address":[],"length":0,"stats":{"Line":0}},{"line":1511,"address":[],"length":0,"stats":{"Line":0}},{"line":1513,"address":[],"length":0,"stats":{"Line":0}},{"line":1514,"address":[],"length":0,"stats":{"Line":0}},{"line":1515,"address":[],"length":0,"stats":{"Line":0}},{"line":1516,"address":[],"length":0,"stats":{"Line":0}},{"line":1517,"address":[],"length":0,"stats":{"Line":0}},{"line":1518,"address":[],"length":0,"stats":{"Line":0}},{"line":1519,"address":[],"length":0,"stats":{"Line":0}},{"line":1520,"address":[],"length":0,"stats":{"Line":0}},{"line":1521,"address":[],"length":0,"stats":{"Line":0}},{"line":1524,"address":[],"length":0,"stats":{"Line":0}},{"line":1525,"address":[],"length":0,"stats":{"Line":0}},{"line":1526,"address":[],"length":0,"stats":{"Line":0}},{"line":1528,"address":[],"length":0,"stats":{"Line":0}},{"line":1529,"address":[],"length":0,"stats":{"Line":0}},{"line":1531,"address":[],"length":0,"stats":{"Line":0}},{"line":1535,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":0}},{"line":1538,"address":[],"length":0,"stats":{"Line":0}},{"line":1543,"address":[],"length":0,"stats":{"Line":0}},{"line":1544,"address":[],"length":0,"stats":{"Line":0}},{"line":1545,"address":[],"length":0,"stats":{"Line":0}},{"line":1546,"address":[],"length":0,"stats":{"Line":0}},{"line":1547,"address":[],"length":0,"stats":{"Line":0}},{"line":1548,"address":[],"length":0,"stats":{"Line":0}},{"line":1552,"address":[],"length":0,"stats":{"Line":0}},{"line":1553,"address":[],"length":0,"stats":{"Line":0}},{"line":1554,"address":[],"length":0,"stats":{"Line":0}},{"line":1555,"address":[],"length":0,"stats":{"Line":0}},{"line":1556,"address":[],"length":0,"stats":{"Line":0}},{"line":1557,"address":[],"length":0,"stats":{"Line":0}},{"line":1558,"address":[],"length":0,"stats":{"Line":0}},{"line":1559,"address":[],"length":0,"stats":{"Line":0}},{"line":1560,"address":[],"length":0,"stats":{"Line":0}},{"line":1561,"address":[],"length":0,"stats":{"Line":0}},{"line":1562,"address":[],"length":0,"stats":{"Line":0}},{"line":1563,"address":[],"length":0,"stats":{"Line":0}},{"line":1564,"address":[],"length":0,"stats":{"Line":0}},{"line":1565,"address":[],"length":0,"stats":{"Line":0}},{"line":1568,"address":[],"length":0,"stats":{"Line":0}},{"line":1569,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1571,"address":[],"length":0,"stats":{"Line":0}},{"line":1572,"address":[],"length":0,"stats":{"Line":0}},{"line":1573,"address":[],"length":0,"stats":{"Line":0}},{"line":1574,"address":[],"length":0,"stats":{"Line":0}},{"line":1575,"address":[],"length":0,"stats":{"Line":0}},{"line":1576,"address":[],"length":0,"stats":{"Line":0}},{"line":1579,"address":[],"length":0,"stats":{"Line":0}},{"line":1580,"address":[],"length":0,"stats":{"Line":0}},{"line":1581,"address":[],"length":0,"stats":{"Line":0}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1584,"address":[],"length":0,"stats":{"Line":0}},{"line":1586,"address":[],"length":0,"stats":{"Line":0}},{"line":1590,"address":[],"length":0,"stats":{"Line":0}},{"line":1591,"address":[],"length":0,"stats":{"Line":0}},{"line":1593,"address":[],"length":0,"stats":{"Line":0}},{"line":1597,"address":[],"length":0,"stats":{"Line":0}},{"line":1599,"address":[],"length":0,"stats":{"Line":0}},{"line":1600,"address":[],"length":0,"stats":{"Line":0}},{"line":1601,"address":[],"length":0,"stats":{"Line":0}},{"line":1602,"address":[],"length":0,"stats":{"Line":0}},{"line":1603,"address":[],"length":0,"stats":{"Line":0}},{"line":1604,"address":[],"length":0,"stats":{"Line":0}},{"line":1605,"address":[],"length":0,"stats":{"Line":0}},{"line":1606,"address":[],"length":0,"stats":{"Line":0}},{"line":1607,"address":[],"length":0,"stats":{"Line":0}},{"line":1608,"address":[],"length":0,"stats":{"Line":0}},{"line":1609,"address":[],"length":0,"stats":{"Line":0}},{"line":1613,"address":[],"length":0,"stats":{"Line":0}},{"line":1614,"address":[],"length":0,"stats":{"Line":0}},{"line":1615,"address":[],"length":0,"stats":{"Line":0}},{"line":1616,"address":[],"length":0,"stats":{"Line":0}},{"line":1617,"address":[],"length":0,"stats":{"Line":0}},{"line":1619,"address":[],"length":0,"stats":{"Line":0}},{"line":1620,"address":[],"length":0,"stats":{"Line":0}},{"line":1621,"address":[],"length":0,"stats":{"Line":0}},{"line":1622,"address":[],"length":0,"stats":{"Line":0}},{"line":1623,"address":[],"length":0,"stats":{"Line":0}},{"line":1624,"address":[],"length":0,"stats":{"Line":0}},{"line":1625,"address":[],"length":0,"stats":{"Line":0}},{"line":1626,"address":[],"length":0,"stats":{"Line":0}},{"line":1627,"address":[],"length":0,"stats":{"Line":0}},{"line":1628,"address":[],"length":0,"stats":{"Line":0}},{"line":1629,"address":[],"length":0,"stats":{"Line":0}},{"line":1630,"address":[],"length":0,"stats":{"Line":0}},{"line":1631,"address":[],"length":0,"stats":{"Line":0}},{"line":1632,"address":[],"length":0,"stats":{"Line":0}},{"line":1633,"address":[],"length":0,"stats":{"Line":0}},{"line":1634,"address":[],"length":0,"stats":{"Line":0}},{"line":1635,"address":[],"length":0,"stats":{"Line":0}},{"line":1636,"address":[],"length":0,"stats":{"Line":0}},{"line":1637,"address":[],"length":0,"stats":{"Line":0}},{"line":1638,"address":[],"length":0,"stats":{"Line":0}},{"line":1639,"address":[],"length":0,"stats":{"Line":0}},{"line":1640,"address":[],"length":0,"stats":{"Line":0}},{"line":1641,"address":[],"length":0,"stats":{"Line":0}},{"line":1645,"address":[],"length":0,"stats":{"Line":0}},{"line":1646,"address":[],"length":0,"stats":{"Line":0}},{"line":1647,"address":[],"length":0,"stats":{"Line":0}},{"line":1649,"address":[],"length":0,"stats":{"Line":0}},{"line":1650,"address":[],"length":0,"stats":{"Line":0}},{"line":1652,"address":[],"length":0,"stats":{"Line":0}},{"line":1654,"address":[],"length":0,"stats":{"Line":0}},{"line":1657,"address":[],"length":0,"stats":{"Line":0}},{"line":1659,"address":[],"length":0,"stats":{"Line":0}},{"line":1661,"address":[],"length":0,"stats":{"Line":0}},{"line":1666,"address":[],"length":0,"stats":{"Line":0}},{"line":1669,"address":[],"length":0,"stats":{"Line":0}},{"line":1680,"address":[],"length":0,"stats":{"Line":0}},{"line":1682,"address":[],"length":0,"stats":{"Line":0}},{"line":1683,"address":[],"length":0,"stats":{"Line":0}},{"line":1685,"address":[],"length":0,"stats":{"Line":0}},{"line":1692,"address":[],"length":0,"stats":{"Line":0}},{"line":1695,"address":[],"length":0,"stats":{"Line":0}},{"line":1696,"address":[],"length":0,"stats":{"Line":0}},{"line":1697,"address":[],"length":0,"stats":{"Line":0}},{"line":1698,"address":[],"length":0,"stats":{"Line":0}},{"line":1699,"address":[],"length":0,"stats":{"Line":0}},{"line":1702,"address":[],"length":0,"stats":{"Line":0}},{"line":1703,"address":[],"length":0,"stats":{"Line":0}},{"line":1704,"address":[],"length":0,"stats":{"Line":0}},{"line":1705,"address":[],"length":0,"stats":{"Line":0}},{"line":1709,"address":[],"length":0,"stats":{"Line":0}},{"line":1712,"address":[],"length":0,"stats":{"Line":0}},{"line":1724,"address":[],"length":0,"stats":{"Line":0}},{"line":1725,"address":[],"length":0,"stats":{"Line":0}},{"line":1726,"address":[],"length":0,"stats":{"Line":0}},{"line":1727,"address":[],"length":0,"stats":{"Line":0}},{"line":1729,"address":[],"length":0,"stats":{"Line":0}},{"line":1731,"address":[],"length":0,"stats":{"Line":0}},{"line":1733,"address":[],"length":0,"stats":{"Line":0}},{"line":1735,"address":[],"length":0,"stats":{"Line":0}},{"line":1739,"address":[],"length":0,"stats":{"Line":0}},{"line":1740,"address":[],"length":0,"stats":{"Line":0}},{"line":1742,"address":[],"length":0,"stats":{"Line":0}},{"line":1743,"address":[],"length":0,"stats":{"Line":0}},{"line":1744,"address":[],"length":0,"stats":{"Line":0}},{"line":1745,"address":[],"length":0,"stats":{"Line":0}},{"line":1746,"address":[],"length":0,"stats":{"Line":0}},{"line":1747,"address":[],"length":0,"stats":{"Line":0}},{"line":1750,"address":[],"length":0,"stats":{"Line":0}},{"line":1751,"address":[],"length":0,"stats":{"Line":0}},{"line":1752,"address":[],"length":0,"stats":{"Line":0}},{"line":1753,"address":[],"length":0,"stats":{"Line":0}},{"line":1755,"address":[],"length":0,"stats":{"Line":0}},{"line":1756,"address":[],"length":0,"stats":{"Line":0}},{"line":1757,"address":[],"length":0,"stats":{"Line":0}},{"line":1758,"address":[],"length":0,"stats":{"Line":0}},{"line":1760,"address":[],"length":0,"stats":{"Line":0}},{"line":1767,"address":[],"length":0,"stats":{"Line":0}},{"line":1769,"address":[],"length":0,"stats":{"Line":0}},{"line":1770,"address":[],"length":0,"stats":{"Line":0}},{"line":1771,"address":[],"length":0,"stats":{"Line":0}},{"line":1774,"address":[],"length":0,"stats":{"Line":0}},{"line":1776,"address":[],"length":0,"stats":{"Line":0}},{"line":1780,"address":[],"length":0,"stats":{"Line":0}},{"line":1781,"address":[],"length":0,"stats":{"Line":0}},{"line":1784,"address":[],"length":0,"stats":{"Line":0}},{"line":1785,"address":[],"length":0,"stats":{"Line":0}},{"line":1786,"address":[],"length":0,"stats":{"Line":0}},{"line":1808,"address":[],"length":0,"stats":{"Line":0}},{"line":1809,"address":[],"length":0,"stats":{"Line":0}},{"line":1810,"address":[],"length":0,"stats":{"Line":0}},{"line":1811,"address":[],"length":0,"stats":{"Line":0}},{"line":1821,"address":[],"length":0,"stats":{"Line":0}},{"line":1832,"address":[],"length":0,"stats":{"Line":0}},{"line":1833,"address":[],"length":0,"stats":{"Line":0}},{"line":1836,"address":[],"length":0,"stats":{"Line":0}},{"line":1837,"address":[],"length":0,"stats":{"Line":0}},{"line":1841,"address":[],"length":0,"stats":{"Line":0}},{"line":1842,"address":[],"length":0,"stats":{"Line":0}},{"line":1843,"address":[],"length":0,"stats":{"Line":0}},{"line":1844,"address":[],"length":0,"stats":{"Line":0}},{"line":1845,"address":[],"length":0,"stats":{"Line":0}},{"line":1846,"address":[],"length":0,"stats":{"Line":0}},{"line":1848,"address":[],"length":0,"stats":{"Line":0}},{"line":1850,"address":[],"length":0,"stats":{"Line":0}},{"line":1851,"address":[],"length":0,"stats":{"Line":0}},{"line":1852,"address":[],"length":0,"stats":{"Line":0}},{"line":1853,"address":[],"length":0,"stats":{"Line":0}},{"line":1854,"address":[],"length":0,"stats":{"Line":0}},{"line":1855,"address":[],"length":0,"stats":{"Line":0}},{"line":1856,"address":[],"length":0,"stats":{"Line":0}},{"line":1857,"address":[],"length":0,"stats":{"Line":0}},{"line":1858,"address":[],"length":0,"stats":{"Line":0}},{"line":1859,"address":[],"length":0,"stats":{"Line":0}},{"line":1862,"address":[],"length":0,"stats":{"Line":0}},{"line":1863,"address":[],"length":0,"stats":{"Line":0}},{"line":1864,"address":[],"length":0,"stats":{"Line":0}},{"line":1865,"address":[],"length":0,"stats":{"Line":0}},{"line":1868,"address":[],"length":0,"stats":{"Line":0}},{"line":1871,"address":[],"length":0,"stats":{"Line":0}},{"line":1872,"address":[],"length":0,"stats":{"Line":0}},{"line":1877,"address":[],"length":0,"stats":{"Line":0}},{"line":1880,"address":[],"length":0,"stats":{"Line":4}},{"line":1881,"address":[],"length":0,"stats":{"Line":4}},{"line":1884,"address":[],"length":0,"stats":{"Line":2}},{"line":1885,"address":[],"length":0,"stats":{"Line":6}},{"line":1886,"address":[],"length":0,"stats":{"Line":6}},{"line":1888,"address":[],"length":0,"stats":{"Line":868}},{"line":1889,"address":[],"length":0,"stats":{"Line":2950}},{"line":1890,"address":[],"length":0,"stats":{"Line":1432}},{"line":1891,"address":[],"length":0,"stats":{"Line":1432}},{"line":1892,"address":[],"length":0,"stats":{"Line":716}},{"line":1894,"address":[],"length":0,"stats":{"Line":1012}},{"line":1898,"address":[],"length":0,"stats":{"Line":2}},{"line":1901,"address":[],"length":0,"stats":{"Line":0}},{"line":1902,"address":[],"length":0,"stats":{"Line":0}},{"line":1903,"address":[],"length":0,"stats":{"Line":0}},{"line":1904,"address":[],"length":0,"stats":{"Line":0}},{"line":1905,"address":[],"length":0,"stats":{"Line":0}},{"line":1906,"address":[],"length":0,"stats":{"Line":0}},{"line":1909,"address":[],"length":0,"stats":{"Line":0}},{"line":1912,"address":[],"length":0,"stats":{"Line":0}},{"line":1913,"address":[],"length":0,"stats":{"Line":0}},{"line":1914,"address":[],"length":0,"stats":{"Line":0}},{"line":1915,"address":[],"length":0,"stats":{"Line":0}},{"line":1916,"address":[],"length":0,"stats":{"Line":0}},{"line":1917,"address":[],"length":0,"stats":{"Line":0}},{"line":1918,"address":[],"length":0,"stats":{"Line":0}},{"line":1919,"address":[],"length":0,"stats":{"Line":0}},{"line":1920,"address":[],"length":0,"stats":{"Line":0}},{"line":1921,"address":[],"length":0,"stats":{"Line":0}},{"line":1922,"address":[],"length":0,"stats":{"Line":0}},{"line":1923,"address":[],"length":0,"stats":{"Line":0}},{"line":1927,"address":[],"length":0,"stats":{"Line":0}},{"line":1930,"address":[],"length":0,"stats":{"Line":0}},{"line":1931,"address":[],"length":0,"stats":{"Line":0}},{"line":1933,"address":[],"length":0,"stats":{"Line":0}},{"line":1934,"address":[],"length":0,"stats":{"Line":0}},{"line":1935,"address":[],"length":0,"stats":{"Line":0}},{"line":1936,"address":[],"length":0,"stats":{"Line":0}},{"line":1937,"address":[],"length":0,"stats":{"Line":0}},{"line":1938,"address":[],"length":0,"stats":{"Line":0}},{"line":1939,"address":[],"length":0,"stats":{"Line":0}},{"line":1940,"address":[],"length":0,"stats":{"Line":0}},{"line":1941,"address":[],"length":0,"stats":{"Line":0}},{"line":1942,"address":[],"length":0,"stats":{"Line":0}},{"line":1943,"address":[],"length":0,"stats":{"Line":0}},{"line":1945,"address":[],"length":0,"stats":{"Line":0}},{"line":1946,"address":[],"length":0,"stats":{"Line":0}},{"line":1947,"address":[],"length":0,"stats":{"Line":0}},{"line":1949,"address":[],"length":0,"stats":{"Line":0}},{"line":1951,"address":[],"length":0,"stats":{"Line":0}},{"line":1952,"address":[],"length":0,"stats":{"Line":0}},{"line":1953,"address":[],"length":0,"stats":{"Line":0}},{"line":1954,"address":[],"length":0,"stats":{"Line":0}},{"line":1955,"address":[],"length":0,"stats":{"Line":0}},{"line":1956,"address":[],"length":0,"stats":{"Line":0}},{"line":1988,"address":[],"length":0,"stats":{"Line":0}},{"line":1989,"address":[],"length":0,"stats":{"Line":0}},{"line":1990,"address":[],"length":0,"stats":{"Line":0}},{"line":1991,"address":[],"length":0,"stats":{"Line":0}},{"line":1992,"address":[],"length":0,"stats":{"Line":0}},{"line":1993,"address":[],"length":0,"stats":{"Line":0}},{"line":1994,"address":[],"length":0,"stats":{"Line":0}},{"line":1995,"address":[],"length":0,"stats":{"Line":0}},{"line":1996,"address":[],"length":0,"stats":{"Line":0}},{"line":1997,"address":[],"length":0,"stats":{"Line":0}},{"line":1998,"address":[],"length":0,"stats":{"Line":0}},{"line":1999,"address":[],"length":0,"stats":{"Line":0}},{"line":2000,"address":[],"length":0,"stats":{"Line":0}},{"line":2001,"address":[],"length":0,"stats":{"Line":0}},{"line":2002,"address":[],"length":0,"stats":{"Line":0}},{"line":2003,"address":[],"length":0,"stats":{"Line":0}},{"line":2005,"address":[],"length":0,"stats":{"Line":0}},{"line":2006,"address":[],"length":0,"stats":{"Line":0}},{"line":2007,"address":[],"length":0,"stats":{"Line":0}},{"line":2008,"address":[],"length":0,"stats":{"Line":0}},{"line":2009,"address":[],"length":0,"stats":{"Line":0}},{"line":2010,"address":[],"length":0,"stats":{"Line":0}},{"line":2011,"address":[],"length":0,"stats":{"Line":0}},{"line":2012,"address":[],"length":0,"stats":{"Line":0}},{"line":2013,"address":[],"length":0,"stats":{"Line":0}},{"line":2014,"address":[],"length":0,"stats":{"Line":0}},{"line":2015,"address":[],"length":0,"stats":{"Line":0}},{"line":2016,"address":[],"length":0,"stats":{"Line":0}},{"line":2017,"address":[],"length":0,"stats":{"Line":0}},{"line":2020,"address":[],"length":0,"stats":{"Line":0}},{"line":2021,"address":[],"length":0,"stats":{"Line":0}},{"line":2022,"address":[],"length":0,"stats":{"Line":0}},{"line":2023,"address":[],"length":0,"stats":{"Line":0}},{"line":2024,"address":[],"length":0,"stats":{"Line":0}},{"line":2025,"address":[],"length":0,"stats":{"Line":0}},{"line":2026,"address":[],"length":0,"stats":{"Line":0}},{"line":2027,"address":[],"length":0,"stats":{"Line":0}},{"line":2028,"address":[],"length":0,"stats":{"Line":0}},{"line":2030,"address":[],"length":0,"stats":{"Line":0}},{"line":2031,"address":[],"length":0,"stats":{"Line":0}},{"line":2032,"address":[],"length":0,"stats":{"Line":0}},{"line":2033,"address":[],"length":0,"stats":{"Line":0}},{"line":2034,"address":[],"length":0,"stats":{"Line":0}},{"line":2035,"address":[],"length":0,"stats":{"Line":0}},{"line":2036,"address":[],"length":0,"stats":{"Line":0}},{"line":2039,"address":[],"length":0,"stats":{"Line":0}},{"line":2040,"address":[],"length":0,"stats":{"Line":0}},{"line":2042,"address":[],"length":0,"stats":{"Line":0}},{"line":2043,"address":[],"length":0,"stats":{"Line":0}},{"line":2044,"address":[],"length":0,"stats":{"Line":0}},{"line":2045,"address":[],"length":0,"stats":{"Line":0}},{"line":2046,"address":[],"length":0,"stats":{"Line":0}},{"line":2047,"address":[],"length":0,"stats":{"Line":0}},{"line":2048,"address":[],"length":0,"stats":{"Line":0}},{"line":2049,"address":[],"length":0,"stats":{"Line":0}},{"line":2050,"address":[],"length":0,"stats":{"Line":0}},{"line":2051,"address":[],"length":0,"stats":{"Line":0}},{"line":2053,"address":[],"length":0,"stats":{"Line":0}},{"line":2054,"address":[],"length":0,"stats":{"Line":0}},{"line":2055,"address":[],"length":0,"stats":{"Line":0}},{"line":2056,"address":[],"length":0,"stats":{"Line":0}},{"line":2057,"address":[],"length":0,"stats":{"Line":0}},{"line":2058,"address":[],"length":0,"stats":{"Line":0}},{"line":2059,"address":[],"length":0,"stats":{"Line":0}},{"line":2060,"address":[],"length":0,"stats":{"Line":0}},{"line":2061,"address":[],"length":0,"stats":{"Line":0}},{"line":2062,"address":[],"length":0,"stats":{"Line":0}},{"line":2063,"address":[],"length":0,"stats":{"Line":0}},{"line":2064,"address":[],"length":0,"stats":{"Line":0}},{"line":2065,"address":[],"length":0,"stats":{"Line":0}},{"line":2067,"address":[],"length":0,"stats":{"Line":0}},{"line":2068,"address":[],"length":0,"stats":{"Line":0}},{"line":2069,"address":[],"length":0,"stats":{"Line":0}},{"line":2070,"address":[],"length":0,"stats":{"Line":0}},{"line":2071,"address":[],"length":0,"stats":{"Line":0}},{"line":2072,"address":[],"length":0,"stats":{"Line":0}},{"line":2073,"address":[],"length":0,"stats":{"Line":0}},{"line":2074,"address":[],"length":0,"stats":{"Line":0}},{"line":2075,"address":[],"length":0,"stats":{"Line":0}},{"line":2076,"address":[],"length":0,"stats":{"Line":0}},{"line":2077,"address":[],"length":0,"stats":{"Line":0}},{"line":2078,"address":[],"length":0,"stats":{"Line":0}},{"line":2079,"address":[],"length":0,"stats":{"Line":0}},{"line":2081,"address":[],"length":0,"stats":{"Line":0}},{"line":2082,"address":[],"length":0,"stats":{"Line":0}},{"line":2083,"address":[],"length":0,"stats":{"Line":0}},{"line":2084,"address":[],"length":0,"stats":{"Line":0}},{"line":2085,"address":[],"length":0,"stats":{"Line":0}},{"line":2086,"address":[],"length":0,"stats":{"Line":0}},{"line":2087,"address":[],"length":0,"stats":{"Line":0}},{"line":2088,"address":[],"length":0,"stats":{"Line":0}},{"line":2089,"address":[],"length":0,"stats":{"Line":0}},{"line":2090,"address":[],"length":0,"stats":{"Line":0}},{"line":2091,"address":[],"length":0,"stats":{"Line":0}},{"line":2092,"address":[],"length":0,"stats":{"Line":0}},{"line":2093,"address":[],"length":0,"stats":{"Line":0}},{"line":2095,"address":[],"length":0,"stats":{"Line":0}},{"line":2096,"address":[],"length":0,"stats":{"Line":0}},{"line":2097,"address":[],"length":0,"stats":{"Line":0}},{"line":2098,"address":[],"length":0,"stats":{"Line":0}},{"line":2099,"address":[],"length":0,"stats":{"Line":0}},{"line":2100,"address":[],"length":0,"stats":{"Line":0}},{"line":2101,"address":[],"length":0,"stats":{"Line":0}},{"line":2102,"address":[],"length":0,"stats":{"Line":0}},{"line":2103,"address":[],"length":0,"stats":{"Line":0}},{"line":2104,"address":[],"length":0,"stats":{"Line":0}},{"line":2105,"address":[],"length":0,"stats":{"Line":0}},{"line":2106,"address":[],"length":0,"stats":{"Line":0}},{"line":2107,"address":[],"length":0,"stats":{"Line":0}},{"line":2108,"address":[],"length":0,"stats":{"Line":0}},{"line":2109,"address":[],"length":0,"stats":{"Line":0}},{"line":2111,"address":[],"length":0,"stats":{"Line":0}},{"line":2112,"address":[],"length":0,"stats":{"Line":0}},{"line":2113,"address":[],"length":0,"stats":{"Line":0}},{"line":2114,"address":[],"length":0,"stats":{"Line":0}},{"line":2115,"address":[],"length":0,"stats":{"Line":0}},{"line":2116,"address":[],"length":0,"stats":{"Line":0}},{"line":2118,"address":[],"length":0,"stats":{"Line":0}},{"line":2119,"address":[],"length":0,"stats":{"Line":0}},{"line":2120,"address":[],"length":0,"stats":{"Line":0}},{"line":2121,"address":[],"length":0,"stats":{"Line":0}},{"line":2122,"address":[],"length":0,"stats":{"Line":0}},{"line":2123,"address":[],"length":0,"stats":{"Line":0}},{"line":2126,"address":[],"length":0,"stats":{"Line":0}},{"line":2127,"address":[],"length":0,"stats":{"Line":0}},{"line":2128,"address":[],"length":0,"stats":{"Line":0}},{"line":2129,"address":[],"length":0,"stats":{"Line":0}},{"line":2131,"address":[],"length":0,"stats":{"Line":0}},{"line":2132,"address":[],"length":0,"stats":{"Line":0}},{"line":2133,"address":[],"length":0,"stats":{"Line":0}},{"line":2134,"address":[],"length":0,"stats":{"Line":0}},{"line":2135,"address":[],"length":0,"stats":{"Line":0}},{"line":2136,"address":[],"length":0,"stats":{"Line":0}},{"line":2137,"address":[],"length":0,"stats":{"Line":0}},{"line":2138,"address":[],"length":0,"stats":{"Line":0}},{"line":2139,"address":[],"length":0,"stats":{"Line":0}},{"line":2140,"address":[],"length":0,"stats":{"Line":0}},{"line":2141,"address":[],"length":0,"stats":{"Line":0}},{"line":2142,"address":[],"length":0,"stats":{"Line":0}},{"line":2143,"address":[],"length":0,"stats":{"Line":0}},{"line":2147,"address":[],"length":0,"stats":{"Line":0}},{"line":2157,"address":[],"length":0,"stats":{"Line":0}},{"line":2162,"address":[],"length":0,"stats":{"Line":0}},{"line":2165,"address":[],"length":0,"stats":{"Line":0}},{"line":2169,"address":[],"length":0,"stats":{"Line":0}},{"line":2170,"address":[],"length":0,"stats":{"Line":0}},{"line":2172,"address":[],"length":0,"stats":{"Line":0}},{"line":2174,"address":[],"length":0,"stats":{"Line":0}},{"line":2175,"address":[],"length":0,"stats":{"Line":0}},{"line":2176,"address":[],"length":0,"stats":{"Line":0}},{"line":2177,"address":[],"length":0,"stats":{"Line":0}},{"line":2178,"address":[],"length":0,"stats":{"Line":0}},{"line":2180,"address":[],"length":0,"stats":{"Line":0}},{"line":2182,"address":[],"length":0,"stats":{"Line":0}},{"line":2184,"address":[],"length":0,"stats":{"Line":0}},{"line":2185,"address":[],"length":0,"stats":{"Line":0}},{"line":2186,"address":[],"length":0,"stats":{"Line":0}},{"line":2188,"address":[],"length":0,"stats":{"Line":0}},{"line":2189,"address":[],"length":0,"stats":{"Line":0}},{"line":2190,"address":[],"length":0,"stats":{"Line":0}},{"line":2192,"address":[],"length":0,"stats":{"Line":0}},{"line":2195,"address":[],"length":0,"stats":{"Line":0}},{"line":2196,"address":[],"length":0,"stats":{"Line":0}},{"line":2197,"address":[],"length":0,"stats":{"Line":0}},{"line":2199,"address":[],"length":0,"stats":{"Line":0}},{"line":2201,"address":[],"length":0,"stats":{"Line":0}},{"line":2203,"address":[],"length":0,"stats":{"Line":0}},{"line":2207,"address":[],"length":0,"stats":{"Line":0}},{"line":2208,"address":[],"length":0,"stats":{"Line":0}},{"line":2209,"address":[],"length":0,"stats":{"Line":0}},{"line":2211,"address":[],"length":0,"stats":{"Line":0}},{"line":2213,"address":[],"length":0,"stats":{"Line":0}},{"line":2215,"address":[],"length":0,"stats":{"Line":0}},{"line":2217,"address":[],"length":0,"stats":{"Line":0}},{"line":2219,"address":[],"length":0,"stats":{"Line":0}},{"line":2220,"address":[],"length":0,"stats":{"Line":0}},{"line":2221,"address":[],"length":0,"stats":{"Line":0}},{"line":2222,"address":[],"length":0,"stats":{"Line":0}},{"line":2224,"address":[],"length":0,"stats":{"Line":0}},{"line":2227,"address":[],"length":0,"stats":{"Line":0}},{"line":2228,"address":[],"length":0,"stats":{"Line":0}},{"line":2229,"address":[],"length":0,"stats":{"Line":0}},{"line":2233,"address":[],"length":0,"stats":{"Line":0}},{"line":2236,"address":[],"length":0,"stats":{"Line":0}},{"line":2238,"address":[],"length":0,"stats":{"Line":0}},{"line":2240,"address":[],"length":0,"stats":{"Line":0}},{"line":2243,"address":[],"length":0,"stats":{"Line":0}},{"line":2246,"address":[],"length":0,"stats":{"Line":0}},{"line":2247,"address":[],"length":0,"stats":{"Line":0}},{"line":2249,"address":[],"length":0,"stats":{"Line":0}},{"line":2250,"address":[],"length":0,"stats":{"Line":0}},{"line":2252,"address":[],"length":0,"stats":{"Line":0}},{"line":2256,"address":[],"length":0,"stats":{"Line":0}},{"line":2260,"address":[],"length":0,"stats":{"Line":0}},{"line":2263,"address":[],"length":0,"stats":{"Line":0}},{"line":2264,"address":[],"length":0,"stats":{"Line":0}},{"line":2265,"address":[],"length":0,"stats":{"Line":0}},{"line":2267,"address":[],"length":0,"stats":{"Line":0}},{"line":2271,"address":[],"length":0,"stats":{"Line":0}},{"line":2272,"address":[],"length":0,"stats":{"Line":0}},{"line":2273,"address":[],"length":0,"stats":{"Line":0}},{"line":2275,"address":[],"length":0,"stats":{"Line":0}},{"line":2277,"address":[],"length":0,"stats":{"Line":0}},{"line":2278,"address":[],"length":0,"stats":{"Line":0}},{"line":2280,"address":[],"length":0,"stats":{"Line":0}},{"line":2284,"address":[],"length":0,"stats":{"Line":0}},{"line":2285,"address":[],"length":0,"stats":{"Line":0}},{"line":2286,"address":[],"length":0,"stats":{"Line":0}},{"line":2287,"address":[],"length":0,"stats":{"Line":0}},{"line":2288,"address":[],"length":0,"stats":{"Line":0}},{"line":2290,"address":[],"length":0,"stats":{"Line":0}},{"line":2379,"address":[],"length":0,"stats":{"Line":0}},{"line":2381,"address":[],"length":0,"stats":{"Line":0}},{"line":2389,"address":[],"length":0,"stats":{"Line":0}},{"line":2399,"address":[],"length":0,"stats":{"Line":0}},{"line":2412,"address":[],"length":0,"stats":{"Line":0}},{"line":2457,"address":[],"length":0,"stats":{"Line":0}},{"line":2460,"address":[],"length":0,"stats":{"Line":0}},{"line":2461,"address":[],"length":0,"stats":{"Line":0}},{"line":2464,"address":[],"length":0,"stats":{"Line":0}},{"line":2465,"address":[],"length":0,"stats":{"Line":0}},{"line":2468,"address":[],"length":0,"stats":{"Line":0}},{"line":2469,"address":[],"length":0,"stats":{"Line":0}},{"line":2472,"address":[],"length":0,"stats":{"Line":0}},{"line":2477,"address":[],"length":0,"stats":{"Line":0}},{"line":2480,"address":[],"length":0,"stats":{"Line":0}},{"line":2483,"address":[],"length":0,"stats":{"Line":0}},{"line":2484,"address":[],"length":0,"stats":{"Line":0}},{"line":2487,"address":[],"length":0,"stats":{"Line":0}},{"line":2489,"address":[],"length":0,"stats":{"Line":0}},{"line":2491,"address":[],"length":0,"stats":{"Line":0}},{"line":2492,"address":[],"length":0,"stats":{"Line":0}},{"line":2494,"address":[],"length":0,"stats":{"Line":0}},{"line":2495,"address":[],"length":0,"stats":{"Line":0}},{"line":2496,"address":[],"length":0,"stats":{"Line":0}},{"line":2497,"address":[],"length":0,"stats":{"Line":0}},{"line":2498,"address":[],"length":0,"stats":{"Line":0}},{"line":2499,"address":[],"length":0,"stats":{"Line":0}},{"line":2502,"address":[],"length":0,"stats":{"Line":0}},{"line":2503,"address":[],"length":0,"stats":{"Line":0}},{"line":2505,"address":[],"length":0,"stats":{"Line":0}},{"line":2506,"address":[],"length":0,"stats":{"Line":0}},{"line":2507,"address":[],"length":0,"stats":{"Line":0}},{"line":2508,"address":[],"length":0,"stats":{"Line":0}},{"line":2510,"address":[],"length":0,"stats":{"Line":0}},{"line":2511,"address":[],"length":0,"stats":{"Line":0}},{"line":2512,"address":[],"length":0,"stats":{"Line":0}},{"line":2513,"address":[],"length":0,"stats":{"Line":0}},{"line":2515,"address":[],"length":0,"stats":{"Line":0}},{"line":2519,"address":[],"length":0,"stats":{"Line":0}},{"line":2522,"address":[],"length":0,"stats":{"Line":0}},{"line":2535,"address":[],"length":0,"stats":{"Line":0}},{"line":2536,"address":[],"length":0,"stats":{"Line":0}},{"line":2538,"address":[],"length":0,"stats":{"Line":0}},{"line":2539,"address":[],"length":0,"stats":{"Line":0}},{"line":2540,"address":[],"length":0,"stats":{"Line":0}},{"line":2542,"address":[],"length":0,"stats":{"Line":0}},{"line":2543,"address":[],"length":0,"stats":{"Line":0}},{"line":2544,"address":[],"length":0,"stats":{"Line":0}},{"line":2547,"address":[],"length":0,"stats":{"Line":0}},{"line":2548,"address":[],"length":0,"stats":{"Line":0}},{"line":2550,"address":[],"length":0,"stats":{"Line":0}},{"line":2552,"address":[],"length":0,"stats":{"Line":0}},{"line":2553,"address":[],"length":0,"stats":{"Line":0}},{"line":2555,"address":[],"length":0,"stats":{"Line":0}},{"line":2556,"address":[],"length":0,"stats":{"Line":0}},{"line":2557,"address":[],"length":0,"stats":{"Line":0}},{"line":2558,"address":[],"length":0,"stats":{"Line":0}},{"line":2559,"address":[],"length":0,"stats":{"Line":0}},{"line":2560,"address":[],"length":0,"stats":{"Line":0}},{"line":2561,"address":[],"length":0,"stats":{"Line":0}},{"line":2562,"address":[],"length":0,"stats":{"Line":0}},{"line":2563,"address":[],"length":0,"stats":{"Line":0}},{"line":2564,"address":[],"length":0,"stats":{"Line":0}},{"line":2566,"address":[],"length":0,"stats":{"Line":0}},{"line":2568,"address":[],"length":0,"stats":{"Line":0}},{"line":2570,"address":[],"length":0,"stats":{"Line":0}},{"line":2571,"address":[],"length":0,"stats":{"Line":0}},{"line":2572,"address":[],"length":0,"stats":{"Line":0}},{"line":2574,"address":[],"length":0,"stats":{"Line":0}},{"line":2575,"address":[],"length":0,"stats":{"Line":0}},{"line":2577,"address":[],"length":0,"stats":{"Line":0}},{"line":2579,"address":[],"length":0,"stats":{"Line":0}},{"line":2581,"address":[],"length":0,"stats":{"Line":0}},{"line":2583,"address":[],"length":0,"stats":{"Line":0}},{"line":2584,"address":[],"length":0,"stats":{"Line":0}},{"line":2585,"address":[],"length":0,"stats":{"Line":0}},{"line":2586,"address":[],"length":0,"stats":{"Line":0}},{"line":2587,"address":[],"length":0,"stats":{"Line":0}},{"line":2589,"address":[],"length":0,"stats":{"Line":0}},{"line":2591,"address":[],"length":0,"stats":{"Line":0}},{"line":2593,"address":[],"length":0,"stats":{"Line":0}},{"line":2594,"address":[],"length":0,"stats":{"Line":0}},{"line":2595,"address":[],"length":0,"stats":{"Line":0}},{"line":2597,"address":[],"length":0,"stats":{"Line":0}},{"line":2600,"address":[],"length":0,"stats":{"Line":0}},{"line":2601,"address":[],"length":0,"stats":{"Line":0}},{"line":2603,"address":[],"length":0,"stats":{"Line":0}},{"line":2605,"address":[],"length":0,"stats":{"Line":0}},{"line":2606,"address":[],"length":0,"stats":{"Line":0}},{"line":2607,"address":[],"length":0,"stats":{"Line":0}},{"line":2608,"address":[],"length":0,"stats":{"Line":0}},{"line":2609,"address":[],"length":0,"stats":{"Line":0}},{"line":2610,"address":[],"length":0,"stats":{"Line":0}},{"line":2611,"address":[],"length":0,"stats":{"Line":0}},{"line":2613,"address":[],"length":0,"stats":{"Line":0}},{"line":2615,"address":[],"length":0,"stats":{"Line":0}},{"line":2616,"address":[],"length":0,"stats":{"Line":0}},{"line":2617,"address":[],"length":0,"stats":{"Line":0}},{"line":2623,"address":[],"length":0,"stats":{"Line":0}},{"line":2626,"address":[],"length":0,"stats":{"Line":0}},{"line":2653,"address":[],"length":0,"stats":{"Line":0}},{"line":2665,"address":[],"length":0,"stats":{"Line":0}},{"line":2666,"address":[],"length":0,"stats":{"Line":0}},{"line":2668,"address":[],"length":0,"stats":{"Line":0}},{"line":2669,"address":[],"length":0,"stats":{"Line":0}},{"line":2670,"address":[],"length":0,"stats":{"Line":0}},{"line":2674,"address":[],"length":0,"stats":{"Line":0}},{"line":2675,"address":[],"length":0,"stats":{"Line":0}},{"line":2678,"address":[],"length":0,"stats":{"Line":0}},{"line":2680,"address":[],"length":0,"stats":{"Line":0}},{"line":2682,"address":[],"length":0,"stats":{"Line":0}},{"line":2683,"address":[],"length":0,"stats":{"Line":0}},{"line":2684,"address":[],"length":0,"stats":{"Line":0}},{"line":2685,"address":[],"length":0,"stats":{"Line":0}},{"line":2686,"address":[],"length":0,"stats":{"Line":0}},{"line":2687,"address":[],"length":0,"stats":{"Line":0}},{"line":2688,"address":[],"length":0,"stats":{"Line":0}},{"line":2689,"address":[],"length":0,"stats":{"Line":0}},{"line":2690,"address":[],"length":0,"stats":{"Line":0}},{"line":2691,"address":[],"length":0,"stats":{"Line":0}},{"line":2693,"address":[],"length":0,"stats":{"Line":0}},{"line":2694,"address":[],"length":0,"stats":{"Line":0}},{"line":2695,"address":[],"length":0,"stats":{"Line":0}},{"line":2696,"address":[],"length":0,"stats":{"Line":0}},{"line":2697,"address":[],"length":0,"stats":{"Line":0}},{"line":2703,"address":[],"length":0,"stats":{"Line":0}},{"line":2705,"address":[],"length":0,"stats":{"Line":0}},{"line":2706,"address":[],"length":0,"stats":{"Line":0}},{"line":2707,"address":[],"length":0,"stats":{"Line":0}},{"line":2708,"address":[],"length":0,"stats":{"Line":0}},{"line":2709,"address":[],"length":0,"stats":{"Line":0}},{"line":2710,"address":[],"length":0,"stats":{"Line":0}},{"line":2711,"address":[],"length":0,"stats":{"Line":0}},{"line":2712,"address":[],"length":0,"stats":{"Line":0}},{"line":2713,"address":[],"length":0,"stats":{"Line":0}},{"line":2714,"address":[],"length":0,"stats":{"Line":0}},{"line":2716,"address":[],"length":0,"stats":{"Line":0}},{"line":2718,"address":[],"length":0,"stats":{"Line":0}},{"line":2720,"address":[],"length":0,"stats":{"Line":0}},{"line":2721,"address":[],"length":0,"stats":{"Line":0}},{"line":2723,"address":[],"length":0,"stats":{"Line":0}},{"line":2724,"address":[],"length":0,"stats":{"Line":0}},{"line":2725,"address":[],"length":0,"stats":{"Line":0}},{"line":2727,"address":[],"length":0,"stats":{"Line":0}},{"line":2729,"address":[],"length":0,"stats":{"Line":0}},{"line":2731,"address":[],"length":0,"stats":{"Line":0}},{"line":2733,"address":[],"length":0,"stats":{"Line":0}},{"line":2735,"address":[],"length":0,"stats":{"Line":0}},{"line":2736,"address":[],"length":0,"stats":{"Line":0}},{"line":2737,"address":[],"length":0,"stats":{"Line":0}},{"line":2739,"address":[],"length":0,"stats":{"Line":0}},{"line":2741,"address":[],"length":0,"stats":{"Line":0}},{"line":2743,"address":[],"length":0,"stats":{"Line":0}},{"line":2744,"address":[],"length":0,"stats":{"Line":0}},{"line":2745,"address":[],"length":0,"stats":{"Line":0}},{"line":2747,"address":[],"length":0,"stats":{"Line":0}},{"line":2749,"address":[],"length":0,"stats":{"Line":0}},{"line":2751,"address":[],"length":0,"stats":{"Line":0}},{"line":2753,"address":[],"length":0,"stats":{"Line":0}},{"line":2755,"address":[],"length":0,"stats":{"Line":0}},{"line":2757,"address":[],"length":0,"stats":{"Line":0}},{"line":2759,"address":[],"length":0,"stats":{"Line":0}},{"line":2760,"address":[],"length":0,"stats":{"Line":0}},{"line":2761,"address":[],"length":0,"stats":{"Line":0}},{"line":2764,"address":[],"length":0,"stats":{"Line":0}},{"line":2765,"address":[],"length":0,"stats":{"Line":0}},{"line":2766,"address":[],"length":0,"stats":{"Line":0}},{"line":2769,"address":[],"length":0,"stats":{"Line":0}},{"line":2771,"address":[],"length":0,"stats":{"Line":0}},{"line":2773,"address":[],"length":0,"stats":{"Line":0}},{"line":2775,"address":[],"length":0,"stats":{"Line":0}},{"line":2776,"address":[],"length":0,"stats":{"Line":0}},{"line":2777,"address":[],"length":0,"stats":{"Line":0}},{"line":2778,"address":[],"length":0,"stats":{"Line":0}},{"line":2779,"address":[],"length":0,"stats":{"Line":0}},{"line":2780,"address":[],"length":0,"stats":{"Line":0}},{"line":2781,"address":[],"length":0,"stats":{"Line":0}},{"line":2782,"address":[],"length":0,"stats":{"Line":0}},{"line":2785,"address":[],"length":0,"stats":{"Line":0}},{"line":2786,"address":[],"length":0,"stats":{"Line":0}},{"line":2787,"address":[],"length":0,"stats":{"Line":0}},{"line":2788,"address":[],"length":0,"stats":{"Line":0}},{"line":2789,"address":[],"length":0,"stats":{"Line":0}},{"line":2790,"address":[],"length":0,"stats":{"Line":0}},{"line":2791,"address":[],"length":0,"stats":{"Line":0}},{"line":2792,"address":[],"length":0,"stats":{"Line":0}},{"line":2793,"address":[],"length":0,"stats":{"Line":0}},{"line":2794,"address":[],"length":0,"stats":{"Line":0}},{"line":2795,"address":[],"length":0,"stats":{"Line":0}},{"line":2796,"address":[],"length":0,"stats":{"Line":0}},{"line":2797,"address":[],"length":0,"stats":{"Line":0}},{"line":2799,"address":[],"length":0,"stats":{"Line":0}},{"line":2802,"address":[],"length":0,"stats":{"Line":0}},{"line":2803,"address":[],"length":0,"stats":{"Line":0}},{"line":2805,"address":[],"length":0,"stats":{"Line":0}},{"line":2807,"address":[],"length":0,"stats":{"Line":0}},{"line":2808,"address":[],"length":0,"stats":{"Line":0}},{"line":2810,"address":[],"length":0,"stats":{"Line":0}},{"line":2812,"address":[],"length":0,"stats":{"Line":0}},{"line":2813,"address":[],"length":0,"stats":{"Line":0}},{"line":2814,"address":[],"length":0,"stats":{"Line":0}},{"line":2817,"address":[],"length":0,"stats":{"Line":0}},{"line":2818,"address":[],"length":0,"stats":{"Line":0}},{"line":2821,"address":[],"length":0,"stats":{"Line":0}},{"line":2822,"address":[],"length":0,"stats":{"Line":0}},{"line":2823,"address":[],"length":0,"stats":{"Line":0}},{"line":2824,"address":[],"length":0,"stats":{"Line":0}},{"line":2825,"address":[],"length":0,"stats":{"Line":0}},{"line":2827,"address":[],"length":0,"stats":{"Line":0}},{"line":2828,"address":[],"length":0,"stats":{"Line":0}},{"line":2829,"address":[],"length":0,"stats":{"Line":0}},{"line":2830,"address":[],"length":0,"stats":{"Line":0}},{"line":2831,"address":[],"length":0,"stats":{"Line":0}},{"line":2832,"address":[],"length":0,"stats":{"Line":0}},{"line":2835,"address":[],"length":0,"stats":{"Line":0}},{"line":2836,"address":[],"length":0,"stats":{"Line":0}},{"line":2837,"address":[],"length":0,"stats":{"Line":0}},{"line":2838,"address":[],"length":0,"stats":{"Line":0}},{"line":2841,"address":[],"length":0,"stats":{"Line":0}},{"line":2842,"address":[],"length":0,"stats":{"Line":0}},{"line":2845,"address":[],"length":0,"stats":{"Line":0}},{"line":2846,"address":[],"length":0,"stats":{"Line":0}},{"line":2848,"address":[],"length":0,"stats":{"Line":0}},{"line":2849,"address":[],"length":0,"stats":{"Line":0}},{"line":2850,"address":[],"length":0,"stats":{"Line":0}},{"line":2852,"address":[],"length":0,"stats":{"Line":0}},{"line":2854,"address":[],"length":0,"stats":{"Line":0}},{"line":2856,"address":[],"length":0,"stats":{"Line":0}},{"line":2857,"address":[],"length":0,"stats":{"Line":0}},{"line":2858,"address":[],"length":0,"stats":{"Line":0}},{"line":2859,"address":[],"length":0,"stats":{"Line":0}},{"line":2860,"address":[],"length":0,"stats":{"Line":0}},{"line":2862,"address":[],"length":0,"stats":{"Line":0}},{"line":2866,"address":[],"length":0,"stats":{"Line":0}},{"line":2867,"address":[],"length":0,"stats":{"Line":0}},{"line":2868,"address":[],"length":0,"stats":{"Line":0}},{"line":2869,"address":[],"length":0,"stats":{"Line":0}},{"line":2873,"address":[],"length":0,"stats":{"Line":0}},{"line":2876,"address":[],"length":0,"stats":{"Line":0}},{"line":2877,"address":[],"length":0,"stats":{"Line":0}},{"line":2878,"address":[],"length":0,"stats":{"Line":0}},{"line":2880,"address":[],"length":0,"stats":{"Line":0}},{"line":2881,"address":[],"length":0,"stats":{"Line":0}},{"line":2882,"address":[],"length":0,"stats":{"Line":0}},{"line":2883,"address":[],"length":0,"stats":{"Line":0}},{"line":2884,"address":[],"length":0,"stats":{"Line":0}},{"line":2885,"address":[],"length":0,"stats":{"Line":0}},{"line":2886,"address":[],"length":0,"stats":{"Line":0}},{"line":2890,"address":[],"length":0,"stats":{"Line":8}},{"line":2891,"address":[],"length":0,"stats":{"Line":24}},{"line":2892,"address":[],"length":0,"stats":{"Line":24}},{"line":2893,"address":[],"length":0,"stats":{"Line":24}},{"line":2894,"address":[],"length":0,"stats":{"Line":24}},{"line":2895,"address":[],"length":0,"stats":{"Line":40}},{"line":2896,"address":[],"length":0,"stats":{"Line":8}},{"line":2897,"address":[],"length":0,"stats":{"Line":0}},{"line":2899,"address":[],"length":0,"stats":{"Line":24}},{"line":2901,"address":[],"length":0,"stats":{"Line":8}},{"line":2904,"address":[],"length":0,"stats":{"Line":1}},{"line":2918,"address":[],"length":0,"stats":{"Line":3}},{"line":2919,"address":[],"length":0,"stats":{"Line":1}},{"line":2920,"address":[],"length":0,"stats":{"Line":1}},{"line":2921,"address":[],"length":0,"stats":{"Line":1}},{"line":2922,"address":[],"length":0,"stats":{"Line":1}},{"line":2925,"address":[],"length":0,"stats":{"Line":0}},{"line":2926,"address":[],"length":0,"stats":{"Line":0}},{"line":2927,"address":[],"length":0,"stats":{"Line":0}},{"line":2928,"address":[],"length":0,"stats":{"Line":0}},{"line":2929,"address":[],"length":0,"stats":{"Line":0}},{"line":2931,"address":[],"length":0,"stats":{"Line":0}},{"line":2934,"address":[],"length":0,"stats":{"Line":0}},{"line":2935,"address":[],"length":0,"stats":{"Line":0}},{"line":2936,"address":[],"length":0,"stats":{"Line":0}},{"line":2939,"address":[],"length":0,"stats":{"Line":0}},{"line":2940,"address":[],"length":0,"stats":{"Line":0}},{"line":2941,"address":[],"length":0,"stats":{"Line":0}},{"line":2943,"address":[],"length":0,"stats":{"Line":0}},{"line":2944,"address":[],"length":0,"stats":{"Line":0}},{"line":2946,"address":[],"length":0,"stats":{"Line":0}},{"line":2947,"address":[],"length":0,"stats":{"Line":0}},{"line":2948,"address":[],"length":0,"stats":{"Line":0}},{"line":2950,"address":[],"length":0,"stats":{"Line":0}},{"line":2953,"address":[],"length":0,"stats":{"Line":0}},{"line":2954,"address":[],"length":0,"stats":{"Line":0}},{"line":2955,"address":[],"length":0,"stats":{"Line":0}},{"line":2957,"address":[],"length":0,"stats":{"Line":0}},{"line":2958,"address":[],"length":0,"stats":{"Line":0}},{"line":2959,"address":[],"length":0,"stats":{"Line":0}},{"line":2965,"address":[],"length":0,"stats":{"Line":0}},{"line":2970,"address":[],"length":0,"stats":{"Line":0}},{"line":2973,"address":[],"length":0,"stats":{"Line":0}},{"line":2974,"address":[],"length":0,"stats":{"Line":0}},{"line":2977,"address":[],"length":0,"stats":{"Line":0}},{"line":2978,"address":[],"length":0,"stats":{"Line":0}},{"line":2979,"address":[],"length":0,"stats":{"Line":0}},{"line":2980,"address":[],"length":0,"stats":{"Line":0}},{"line":2982,"address":[],"length":0,"stats":{"Line":0}},{"line":2984,"address":[],"length":0,"stats":{"Line":0}},{"line":2986,"address":[],"length":0,"stats":{"Line":0}},{"line":2987,"address":[],"length":0,"stats":{"Line":0}},{"line":2988,"address":[],"length":0,"stats":{"Line":0}},{"line":2989,"address":[],"length":0,"stats":{"Line":0}},{"line":2990,"address":[],"length":0,"stats":{"Line":0}},{"line":2992,"address":[],"length":0,"stats":{"Line":0}},{"line":2994,"address":[],"length":0,"stats":{"Line":0}},{"line":2995,"address":[],"length":0,"stats":{"Line":0}},{"line":2997,"address":[],"length":0,"stats":{"Line":0}},{"line":2999,"address":[],"length":0,"stats":{"Line":0}},{"line":3000,"address":[],"length":0,"stats":{"Line":0}},{"line":3002,"address":[],"length":0,"stats":{"Line":0}},{"line":3003,"address":[],"length":0,"stats":{"Line":0}},{"line":3004,"address":[],"length":0,"stats":{"Line":0}},{"line":3006,"address":[],"length":0,"stats":{"Line":0}},{"line":3007,"address":[],"length":0,"stats":{"Line":0}},{"line":3008,"address":[],"length":0,"stats":{"Line":0}},{"line":3009,"address":[],"length":0,"stats":{"Line":0}},{"line":3012,"address":[],"length":0,"stats":{"Line":0}},{"line":3013,"address":[],"length":0,"stats":{"Line":0}},{"line":3014,"address":[],"length":0,"stats":{"Line":0}},{"line":3015,"address":[],"length":0,"stats":{"Line":0}},{"line":3026,"address":[],"length":0,"stats":{"Line":0}},{"line":3027,"address":[],"length":0,"stats":{"Line":0}},{"line":3029,"address":[],"length":0,"stats":{"Line":0}},{"line":3030,"address":[],"length":0,"stats":{"Line":0}},{"line":3031,"address":[],"length":0,"stats":{"Line":0}},{"line":3032,"address":[],"length":0,"stats":{"Line":0}},{"line":3033,"address":[],"length":0,"stats":{"Line":0}},{"line":3034,"address":[],"length":0,"stats":{"Line":0}},{"line":3036,"address":[],"length":0,"stats":{"Line":0}},{"line":3037,"address":[],"length":0,"stats":{"Line":0}},{"line":3038,"address":[],"length":0,"stats":{"Line":0}},{"line":3040,"address":[],"length":0,"stats":{"Line":0}},{"line":3041,"address":[],"length":0,"stats":{"Line":0}},{"line":3042,"address":[],"length":0,"stats":{"Line":0}},{"line":3048,"address":[],"length":0,"stats":{"Line":0}},{"line":3050,"address":[],"length":0,"stats":{"Line":0}},{"line":3052,"address":[],"length":0,"stats":{"Line":0}},{"line":3053,"address":[],"length":0,"stats":{"Line":0}},{"line":3055,"address":[],"length":0,"stats":{"Line":0}},{"line":3056,"address":[],"length":0,"stats":{"Line":0}},{"line":3058,"address":[],"length":0,"stats":{"Line":0}},{"line":3060,"address":[],"length":0,"stats":{"Line":0}},{"line":3061,"address":[],"length":0,"stats":{"Line":0}},{"line":3062,"address":[],"length":0,"stats":{"Line":0}},{"line":3065,"address":[],"length":0,"stats":{"Line":0}},{"line":3067,"address":[],"length":0,"stats":{"Line":0}},{"line":3069,"address":[],"length":0,"stats":{"Line":0}},{"line":3071,"address":[],"length":0,"stats":{"Line":0}},{"line":3073,"address":[],"length":0,"stats":{"Line":0}},{"line":3074,"address":[],"length":0,"stats":{"Line":0}},{"line":3077,"address":[],"length":0,"stats":{"Line":0}}],"covered":208,"coverable":1506},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","app.rs"],"content":"use std::collections::HashSet;\nuse std::time::{Duration, Instant};\n\nuse anyhow::Result;\nuse crossterm::event::{KeyCode, KeyEvent, KeyModifiers, MouseButton, MouseEvent, MouseEventKind};\nuse ratatui::layout::Rect;\n\nuse super::data::{DailyUsage, DataLoader, ModelUsage, Source, UsageData};\nuse super::settings::Settings;\nuse super::themes::{Theme, ThemeName};\n\n/// Configuration for TUI initialization\npub struct TuiConfig {\n    pub theme: String,\n    pub refresh: u64,\n    pub sessions_path: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n    pub initial_tab: Option\u003cTab\u003e,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum Tab {\n    Overview,\n    Models,\n    Daily,\n    Stats,\n}\n\nimpl Tab {\n    pub fn all() -\u003e \u0026'static [Tab] {\n        \u0026[Tab::Overview, Tab::Models, Tab::Daily, Tab::Stats]\n    }\n\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Tab::Overview =\u003e \"Overview\",\n            Tab::Models =\u003e \"Models\",\n            Tab::Daily =\u003e \"Daily\",\n            Tab::Stats =\u003e \"Stats\",\n        }\n    }\n\n    pub fn short_name(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Tab::Overview =\u003e \"Ovw\",\n            Tab::Models =\u003e \"Mod\",\n            Tab::Daily =\u003e \"Day\",\n            Tab::Stats =\u003e \"Sta\",\n        }\n    }\n\n    pub fn next(self) -\u003e Tab {\n        match self {\n            Tab::Overview =\u003e Tab::Models,\n            Tab::Models =\u003e Tab::Daily,\n            Tab::Daily =\u003e Tab::Stats,\n            Tab::Stats =\u003e Tab::Overview,\n        }\n    }\n\n    pub fn prev(self) -\u003e Tab {\n        match self {\n            Tab::Overview =\u003e Tab::Stats,\n            Tab::Models =\u003e Tab::Overview,\n            Tab::Daily =\u003e Tab::Models,\n            Tab::Stats =\u003e Tab::Daily,\n        }\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum SortField {\n    Cost,\n    Tokens,\n    Date,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum SortDirection {\n    Ascending,\n    Descending,\n}\n\npub struct ClickArea {\n    pub rect: Rect,\n    pub action: ClickAction,\n}\n\n#[derive(Debug, Clone)]\npub enum ClickAction {\n    Tab(Tab),\n    Source(Source),\n    Sort(SortField),\n    GraphCell { week: usize, day: usize },\n}\n\npub struct App {\n    pub should_quit: bool,\n    pub current_tab: Tab,\n    pub theme: Theme,\n    pub settings: Settings,\n    pub data: UsageData,\n    pub data_loader: DataLoader,\n\n    pub enabled_sources: HashSet\u003cSource\u003e,\n    pub sort_field: SortField,\n    pub sort_direction: SortDirection,\n\n    pub scroll_offset: usize,\n    pub selected_index: usize,\n    pub max_visible_items: usize,\n\n    pub selected_graph_cell: Option\u003c(usize, usize)\u003e,\n\n    pub auto_refresh: bool,\n    pub auto_refresh_interval: Duration,\n    pub last_refresh: Instant,\n\n    pub status_message: Option\u003cString\u003e,\n    pub status_message_time: Option\u003cInstant\u003e,\n\n    pub terminal_width: u16,\n    pub terminal_height: u16,\n\n    pub click_areas: Vec\u003cClickArea\u003e,\n\n    pub spinner_frame: usize,\n\n    pub background_loading: bool,\n}\n\nimpl App {\n    pub fn new_with_cached_data(config: TuiConfig, cached_data: Option\u003cUsageData\u003e) -\u003e Result\u003cSelf\u003e {\n        let settings = Settings::load();\n        let theme_name: ThemeName = config\n            .theme\n            .parse()\n            .unwrap_or_else(|_| settings.theme_name());\n        let theme = Theme::from_name(theme_name);\n\n        let mut enabled_sources = HashSet::new();\n\n        if let Some(ref cli_sources) = config.sources {\n            for source_str in cli_sources {\n                match source_str.as_str() {\n                    \"opencode\" =\u003e enabled_sources.insert(Source::OpenCode),\n                    \"claude\" =\u003e enabled_sources.insert(Source::Claude),\n                    \"codex\" =\u003e enabled_sources.insert(Source::Codex),\n                    \"cursor\" =\u003e enabled_sources.insert(Source::Cursor),\n                    \"gemini\" =\u003e enabled_sources.insert(Source::Gemini),\n                    \"amp\" =\u003e enabled_sources.insert(Source::Amp),\n                    \"droid\" =\u003e enabled_sources.insert(Source::Droid),\n                    \"openclaw\" =\u003e enabled_sources.insert(Source::OpenClaw),\n                    \"pi\" =\u003e enabled_sources.insert(Source::Pi),\n                    _ =\u003e false,\n                };\n            }\n        } else {\n            for source in Source::all() {\n                enabled_sources.insert(*source);\n            }\n        }\n\n        let auto_refresh_interval = if config.refresh \u003e 0 {\n            Duration::from_secs(config.refresh)\n        } else if let Some(interval) = settings.get_auto_refresh_interval() {\n            interval\n        } else {\n            Duration::from_secs(30)\n        };\n\n        let auto_refresh = config.refresh \u003e 0 || settings.auto_refresh_enabled;\n\n        let data_loader = DataLoader::with_filters(\n            config.sessions_path.map(std::path::PathBuf::from),\n            config.since,\n            config.until,\n            config.year,\n        );\n\n        let data = cached_data.unwrap_or_default();\n        let has_data = !data.models.is_empty();\n\n        Ok(Self {\n            should_quit: false,\n            current_tab: config.initial_tab.unwrap_or(Tab::Overview),\n            theme,\n            settings,\n            data,\n            data_loader,\n            enabled_sources,\n            sort_field: SortField::Cost,\n            sort_direction: SortDirection::Descending,\n            scroll_offset: 0,\n            selected_index: 0,\n            max_visible_items: 20,\n            selected_graph_cell: None,\n            auto_refresh,\n            auto_refresh_interval,\n            last_refresh: Instant::now(),\n            status_message: if has_data {\n                Some(\"Loaded from cache\".to_string())\n            } else {\n                None\n            },\n            status_message_time: if has_data { Some(Instant::now()) } else { None },\n            terminal_width: 80,\n            terminal_height: 24,\n            click_areas: Vec::new(),\n            spinner_frame: 0,\n            background_loading: false,\n        })\n    }\n\n    pub fn load_data(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.data.loading = true;\n        let sources: Vec\u003cSource\u003e = self.enabled_sources.iter().copied().collect();\n        match self.data_loader.load(\u0026sources) {\n            Ok(data) =\u003e {\n                self.data = data;\n                self.last_refresh = Instant::now();\n                self.clamp_selection();\n                self.set_status(\"Data loaded\");\n            }\n            Err(e) =\u003e {\n                self.data.loading = false;\n                self.data.error = Some(e.to_string());\n                self.set_status(\u0026format!(\"Error: {}\", e));\n            }\n        }\n        Ok(())\n    }\n\n    pub fn set_background_loading(\u0026mut self, loading: bool) {\n        self.background_loading = loading;\n        // Don't set data.loading - let cached data remain visible during background refresh\n    }\n\n    pub fn update_data(\u0026mut self, data: UsageData) {\n        self.data = data;\n        self.last_refresh = Instant::now();\n        self.clamp_selection();\n    }\n\n    pub fn set_error(\u0026mut self, error: Option\u003cString\u003e) {\n        self.data.error = error;\n    }\n\n    pub fn on_tick(\u0026mut self) {\n        self.spinner_frame = (self.spinner_frame + 1) % 20;\n\n        if let Some(status_time) = self.status_message_time {\n            if status_time.elapsed() \u003e Duration::from_secs(3) {\n                self.status_message = None;\n                self.status_message_time = None;\n            }\n        }\n\n        if self.auto_refresh \u0026\u0026 self.last_refresh.elapsed() \u003e= self.auto_refresh_interval {\n            let _ = self.load_data();\n        }\n    }\n\n    pub fn handle_key_event(\u0026mut self, key: KeyEvent) -\u003e bool {\n        if key.code == KeyCode::Char('c') \u0026\u0026 key.modifiers.contains(KeyModifiers::CONTROL) {\n            self.should_quit = true;\n            return true;\n        }\n\n        match key.code {\n            KeyCode::Char('q') =\u003e {\n                self.should_quit = true;\n                return true;\n            }\n            KeyCode::Tab =\u003e {\n                self.current_tab = self.current_tab.next();\n                self.reset_selection();\n            }\n            KeyCode::BackTab =\u003e {\n                self.current_tab = self.current_tab.prev();\n                self.reset_selection();\n            }\n            KeyCode::Left =\u003e {\n                self.current_tab = self.current_tab.prev();\n                self.reset_selection();\n            }\n            KeyCode::Right =\u003e {\n                self.current_tab = self.current_tab.next();\n                self.reset_selection();\n            }\n            KeyCode::Up =\u003e {\n                self.move_selection_up();\n            }\n            KeyCode::Down =\u003e {\n                self.move_selection_down();\n            }\n            KeyCode::Char('c') =\u003e {\n                self.set_sort(SortField::Cost);\n            }\n            KeyCode::Char('t') =\u003e {\n                self.set_sort(SortField::Tokens);\n            }\n            KeyCode::Char('d') =\u003e {\n                self.set_sort(SortField::Date);\n            }\n            KeyCode::Char('p') =\u003e {\n                self.cycle_theme();\n            }\n            KeyCode::Char('r') =\u003e {\n                let _ = self.load_data();\n            }\n            KeyCode::Char('R') if key.modifiers.contains(KeyModifiers::SHIFT) =\u003e {\n                self.toggle_auto_refresh();\n            }\n            KeyCode::Char('+') | KeyCode::Char('=') =\u003e {\n                self.increase_refresh_interval();\n            }\n            KeyCode::Char('-') =\u003e {\n                self.decrease_refresh_interval();\n            }\n            KeyCode::Char('y') =\u003e {\n                self.copy_selected_to_clipboard();\n            }\n            KeyCode::Char('e') =\u003e {\n                self.export_to_json();\n            }\n            KeyCode::Char(c @ '1'..='9') =\u003e {\n                self.toggle_source(c);\n            }\n            KeyCode::Enter =\u003e {\n                if self.current_tab == Tab::Stats {\n                    self.handle_graph_selection();\n                }\n            }\n            KeyCode::Esc =\u003e {\n                self.selected_graph_cell = None;\n            }\n            _ =\u003e {}\n        }\n        false\n    }\n\n    pub fn handle_mouse_event(\u0026mut self, event: MouseEvent) {\n        if let MouseEventKind::Down(MouseButton::Left) = event.kind {\n            let x = event.column;\n            let y = event.row;\n\n            for area in \u0026self.click_areas {\n                if x \u003e= area.rect.x\n                    \u0026\u0026 x \u003c area.rect.x + area.rect.width\n                    \u0026\u0026 y \u003e= area.rect.y\n                    \u0026\u0026 y \u003c area.rect.y + area.rect.height\n                {\n                    match \u0026area.action {\n                        ClickAction::Tab(tab) =\u003e {\n                            self.current_tab = *tab;\n                            self.reset_selection();\n                        }\n                        ClickAction::Source(source) =\u003e {\n                            self.toggle_source(source.key());\n                        }\n                        ClickAction::Sort(field) =\u003e {\n                            self.set_sort(*field);\n                        }\n                        ClickAction::GraphCell { week, day } =\u003e {\n                            self.selected_graph_cell = Some((*week, *day));\n                        }\n                    }\n                    break;\n                }\n            }\n        }\n    }\n\n    pub fn handle_resize(\u0026mut self, width: u16, height: u16) {\n        self.terminal_width = width;\n        self.terminal_height = height;\n        // Ensure at least 1 visible item to prevent division/slice issues\n        self.max_visible_items = (height.saturating_sub(10) as usize).max(1);\n        self.clamp_selection();\n    }\n\n    /// Clamp selection and scroll offset to valid bounds after data/resize changes\n    fn clamp_selection(\u0026mut self) {\n        let len = self.get_current_list_len();\n        if len == 0 {\n            self.selected_index = 0;\n            self.scroll_offset = 0;\n            return;\n        }\n        self.selected_index = self.selected_index.min(len.saturating_sub(1));\n        let max_scroll = len.saturating_sub(self.max_visible_items);\n        self.scroll_offset = self.scroll_offset.min(max_scroll);\n    }\n\n    pub fn clear_click_areas(\u0026mut self) {\n        self.click_areas.clear();\n    }\n\n    pub fn add_click_area(\u0026mut self, rect: Rect, action: ClickAction) {\n        self.click_areas.push(ClickArea { rect, action });\n    }\n\n    fn reset_selection(\u0026mut self) {\n        self.scroll_offset = 0;\n        self.selected_index = 0;\n        self.selected_graph_cell = None;\n    }\n\n    fn move_selection_up(\u0026mut self) {\n        if self.selected_index \u003e 0 {\n            self.selected_index -= 1;\n            if self.selected_index \u003c self.scroll_offset {\n                self.scroll_offset = self.selected_index;\n            }\n        }\n    }\n\n    fn move_selection_down(\u0026mut self) {\n        let max_index = self.get_current_list_len().saturating_sub(1);\n        if self.selected_index \u003c max_index {\n            self.selected_index += 1;\n            if self.selected_index \u003e= self.scroll_offset + self.max_visible_items {\n                self.scroll_offset = self.selected_index - self.max_visible_items + 1;\n            }\n        }\n    }\n\n    fn get_current_list_len(\u0026self) -\u003e usize {\n        match self.current_tab {\n            Tab::Overview | Tab::Models =\u003e self.data.models.len(),\n            Tab::Daily =\u003e self.data.daily.len(),\n            Tab::Stats =\u003e 0,\n        }\n    }\n\n    fn set_sort(\u0026mut self, field: SortField) {\n        if self.sort_field == field {\n            self.sort_direction = match self.sort_direction {\n                SortDirection::Ascending =\u003e SortDirection::Descending,\n                SortDirection::Descending =\u003e SortDirection::Ascending,\n            };\n        } else {\n            self.sort_field = field;\n            self.sort_direction = SortDirection::Descending;\n        }\n        self.reset_selection();\n        self.set_status(\u0026format!(\n            \"Sorted by {:?} {:?}\",\n            self.sort_field, self.sort_direction\n        ));\n    }\n\n    fn cycle_theme(\u0026mut self) {\n        let new_theme = self.theme.name.next();\n        self.theme = Theme::from_name(new_theme);\n        self.settings.set_theme(new_theme);\n        if let Err(e) = self.settings.save() {\n            self.set_status(\u0026format!(\n                \"Theme: {} (save failed: {})\",\n                new_theme.as_str(),\n                e\n            ));\n        } else {\n            self.set_status(\u0026format!(\"Theme: {}\", new_theme.as_str()));\n        }\n    }\n\n    fn toggle_source(\u0026mut self, key: char) {\n        if let Some(source) = Source::from_key(key) {\n            if self.enabled_sources.contains(\u0026source) {\n                if self.enabled_sources.len() \u003e 1 {\n                    self.enabled_sources.remove(\u0026source);\n                    self.set_status(\u0026format!(\"Disabled {}\", source.as_str()));\n                }\n            } else {\n                self.enabled_sources.insert(source);\n                self.set_status(\u0026format!(\"Enabled {}\", source.as_str()));\n            }\n            let _ = self.load_data();\n        }\n    }\n\n    fn toggle_auto_refresh(\u0026mut self) {\n        self.auto_refresh = !self.auto_refresh;\n        self.settings.auto_refresh_enabled = self.auto_refresh;\n        let save_result = self.settings.save();\n        let msg = if self.auto_refresh {\n            format!(\n                \"Auto-refresh ON ({}s)\",\n                self.auto_refresh_interval.as_secs()\n            )\n        } else {\n            \"Auto-refresh OFF\".to_string()\n        };\n        if let Err(e) = save_result {\n            self.set_status(\u0026format!(\"{} (save failed: {})\", msg, e));\n        } else {\n            self.set_status(\u0026msg);\n        }\n    }\n\n    fn increase_refresh_interval(\u0026mut self) {\n        let ms = self.auto_refresh_interval.as_millis() as u64;\n        let new_ms = ms.saturating_add(10_000).min(300_000);\n        self.auto_refresh_interval = Duration::from_millis(new_ms);\n        self.settings.auto_refresh_ms = new_ms;\n        let save_result = self.settings.save();\n        let msg = format!(\"Refresh interval: {}s\", new_ms / 1000);\n        if let Err(e) = save_result {\n            self.set_status(\u0026format!(\"{} (save failed: {})\", msg, e));\n        } else {\n            self.set_status(\u0026msg);\n        }\n    }\n\n    fn decrease_refresh_interval(\u0026mut self) {\n        let ms = self.auto_refresh_interval.as_millis() as u64;\n        let new_ms = ms.saturating_sub(10_000).max(30_000);\n        self.auto_refresh_interval = Duration::from_millis(new_ms);\n        self.settings.auto_refresh_ms = new_ms;\n        let save_result = self.settings.save();\n        let msg = format!(\"Refresh interval: {}s\", new_ms / 1000);\n        if let Err(e) = save_result {\n            self.set_status(\u0026format!(\"{} (save failed: {})\", msg, e));\n        } else {\n            self.set_status(\u0026msg);\n        }\n    }\n\n    fn copy_selected_to_clipboard(\u0026mut self) {\n        let text = match self.current_tab {\n            Tab::Overview | Tab::Models =\u003e self\n                .get_sorted_models()\n                .get(self.selected_index)\n                .map(|m| format!(\"{}: {} tokens, ${:.4}\", m.model, m.tokens.total(), m.cost)),\n            Tab::Daily =\u003e self\n                .get_sorted_daily()\n                .get(self.selected_index)\n                .map(|d| format!(\"{}: {} tokens, ${:.4}\", d.date, d.tokens.total(), d.cost)),\n            Tab::Stats =\u003e None,\n        };\n\n        if let Some(text) = text {\n            match arboard::Clipboard::new().and_then(|mut cb| cb.set_text(\u0026text)) {\n                Ok(_) =\u003e self.set_status(\"Copied to clipboard\"),\n                Err(_) =\u003e self.set_status(\"Failed to copy\"),\n            }\n        }\n    }\n\n    fn export_to_json(\u0026mut self) {\n        let export_data = serde_json::json!({\n            \"models\": self.data.models.iter().map(|m| serde_json::json!({\n                \"model\": m.model,\n                \"provider\": m.provider,\n                \"source\": m.source,\n                \"tokens\": {\n                    \"input\": m.tokens.input,\n                    \"output\": m.tokens.output,\n                    \"cacheRead\": m.tokens.cache_read,\n                    \"cacheWrite\": m.tokens.cache_write,\n                    \"total\": m.tokens.total()\n                },\n                \"cost\": m.cost,\n                \"sessionCount\": m.session_count\n            })).collect::\u003cVec\u003c_\u003e\u003e(),\n            \"daily\": self.data.daily.iter().map(|d| serde_json::json!({\n                \"date\": d.date.to_string(),\n                \"tokens\": {\n                    \"input\": d.tokens.input,\n                    \"output\": d.tokens.output,\n                    \"cacheRead\": d.tokens.cache_read,\n                    \"cacheWrite\": d.tokens.cache_write,\n                    \"total\": d.tokens.total()\n                },\n                \"cost\": d.cost\n            })).collect::\u003cVec\u003c_\u003e\u003e(),\n            \"totals\": {\n                \"tokens\": self.data.total_tokens,\n                \"cost\": self.data.total_cost\n            }\n        });\n\n        let filename = format!(\n            \"tokscale-export-{}.json\",\n            chrono::Utc::now().format(\"%Y%m%d-%H%M%S\")\n        );\n\n        match serde_json::to_string_pretty(\u0026export_data) {\n            Ok(json) =\u003e match std::fs::write(\u0026filename, json) {\n                Ok(_) =\u003e self.set_status(\u0026format!(\"Exported to {}\", filename)),\n                Err(e) =\u003e self.set_status(\u0026format!(\"Export failed: {}\", e)),\n            },\n            Err(e) =\u003e self.set_status(\u0026format!(\"Export failed: {}\", e)),\n        }\n    }\n\n    fn handle_graph_selection(\u0026mut self) {\n        if self.current_tab == Tab::Stats \u0026\u0026 self.selected_graph_cell.is_some() {\n            self.set_status(\"Press ESC to deselect\");\n        }\n    }\n\n    pub fn set_status(\u0026mut self, message: \u0026str) {\n        self.status_message = Some(message.to_string());\n        self.status_message_time = Some(Instant::now());\n    }\n\n    pub fn get_sorted_models(\u0026self) -\u003e Vec\u003c\u0026ModelUsage\u003e {\n        let mut models: Vec\u003c\u0026ModelUsage\u003e = self.data.models.iter().collect();\n\n        let tie_breaker = |a: \u0026\u0026ModelUsage, b: \u0026\u0026ModelUsage| {\n            a.model\n                .cmp(\u0026b.model)\n                .then_with(|| a.provider.cmp(\u0026b.provider))\n                .then_with(|| a.source.cmp(\u0026b.source))\n        };\n\n        match (self.sort_field, self.sort_direction) {\n            (SortField::Cost, SortDirection::Descending) =\u003e {\n                models.sort_by(|a, b| b.cost.total_cmp(\u0026a.cost).then_with(|| tie_breaker(a, b)))\n            }\n            (SortField::Cost, SortDirection::Ascending) =\u003e {\n                models.sort_by(|a, b| a.cost.total_cmp(\u0026b.cost).then_with(|| tie_breaker(a, b)))\n            }\n            (SortField::Tokens, SortDirection::Descending) =\u003e models.sort_by(|a, b| {\n                b.tokens\n                    .total()\n                    .cmp(\u0026a.tokens.total())\n                    .then_with(|| tie_breaker(a, b))\n            }),\n            (SortField::Tokens, SortDirection::Ascending) =\u003e models.sort_by(|a, b| {\n                a.tokens\n                    .total()\n                    .cmp(\u0026b.tokens.total())\n                    .then_with(|| tie_breaker(a, b))\n            }),\n            (SortField::Date, _) =\u003e {\n                models.sort_by(|a, b| tie_breaker(a, b));\n            }\n        }\n\n        models\n    }\n\n    pub fn get_sorted_daily(\u0026self) -\u003e Vec\u003c\u0026DailyUsage\u003e {\n        let mut daily: Vec\u003c\u0026DailyUsage\u003e = self.data.daily.iter().collect();\n\n        match (self.sort_field, self.sort_direction) {\n            (SortField::Cost, SortDirection::Descending) =\u003e {\n                daily.sort_by(|a, b| b.cost.total_cmp(\u0026a.cost).then_with(|| a.date.cmp(\u0026b.date)))\n            }\n            (SortField::Cost, SortDirection::Ascending) =\u003e {\n                daily.sort_by(|a, b| a.cost.total_cmp(\u0026b.cost).then_with(|| a.date.cmp(\u0026b.date)))\n            }\n            (SortField::Tokens, SortDirection::Descending) =\u003e daily.sort_by(|a, b| {\n                b.tokens\n                    .total()\n                    .cmp(\u0026a.tokens.total())\n                    .then_with(|| a.date.cmp(\u0026b.date))\n            }),\n            (SortField::Tokens, SortDirection::Ascending) =\u003e daily.sort_by(|a, b| {\n                a.tokens\n                    .total()\n                    .cmp(\u0026b.tokens.total())\n                    .then_with(|| a.date.cmp(\u0026b.date))\n            }),\n            (SortField::Date, SortDirection::Descending) =\u003e {\n                daily.sort_by(|a, b| b.date.cmp(\u0026a.date))\n            }\n            (SortField::Date, SortDirection::Ascending) =\u003e {\n                daily.sort_by(|a, b| a.date.cmp(\u0026b.date))\n            }\n        }\n\n        daily\n    }\n\n    pub fn is_narrow(\u0026self) -\u003e bool {\n        self.terminal_width \u003c 80\n    }\n\n    pub fn is_very_narrow(\u0026self) -\u003e bool {\n        self.terminal_width \u003c 60\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::tui::data::{ModelUsage, TokenBreakdown};\n\n    #[test]\n    fn test_tab_all() {\n        let tabs = Tab::all();\n        assert_eq!(tabs.len(), 4);\n        assert_eq!(tabs[0], Tab::Overview);\n        assert_eq!(tabs[1], Tab::Models);\n        assert_eq!(tabs[2], Tab::Daily);\n        assert_eq!(tabs[3], Tab::Stats);\n    }\n\n    #[test]\n    fn test_tab_next() {\n        assert_eq!(Tab::Overview.next(), Tab::Models);\n        assert_eq!(Tab::Models.next(), Tab::Daily);\n        assert_eq!(Tab::Daily.next(), Tab::Stats);\n        assert_eq!(Tab::Stats.next(), Tab::Overview);\n    }\n\n    #[test]\n    fn test_tab_prev() {\n        assert_eq!(Tab::Overview.prev(), Tab::Stats);\n        assert_eq!(Tab::Models.prev(), Tab::Overview);\n        assert_eq!(Tab::Daily.prev(), Tab::Models);\n        assert_eq!(Tab::Stats.prev(), Tab::Daily);\n    }\n\n    #[test]\n    fn test_tab_as_str() {\n        assert_eq!(Tab::Overview.as_str(), \"Overview\");\n        assert_eq!(Tab::Models.as_str(), \"Models\");\n        assert_eq!(Tab::Daily.as_str(), \"Daily\");\n        assert_eq!(Tab::Stats.as_str(), \"Stats\");\n    }\n\n    #[test]\n    fn test_tab_short_name() {\n        assert_eq!(Tab::Overview.short_name(), \"Ovw\");\n        assert_eq!(Tab::Models.short_name(), \"Mod\");\n        assert_eq!(Tab::Daily.short_name(), \"Day\");\n        assert_eq!(Tab::Stats.short_name(), \"Sta\");\n    }\n\n    #[test]\n    fn test_reset_selection() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        app.selected_index = 5;\n        app.scroll_offset = 3;\n        app.selected_graph_cell = Some((2, 4));\n\n        app.reset_selection();\n\n        assert_eq!(app.selected_index, 0);\n        assert_eq!(app.scroll_offset, 0);\n        assert_eq!(app.selected_graph_cell, None);\n    }\n\n    #[test]\n    fn test_move_selection_up() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Add some mock data\n        app.data.models = vec![\n            ModelUsage {\n                model: \"model1\".to_string(),\n                provider: \"provider1\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n            ModelUsage {\n                model: \"model2\".to_string(),\n                provider: \"provider2\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n        ];\n\n        app.selected_index = 1;\n        app.move_selection_up();\n        assert_eq!(app.selected_index, 0);\n\n        // At top boundary - should not move\n        app.move_selection_up();\n        assert_eq!(app.selected_index, 0);\n    }\n\n    #[test]\n    fn test_move_selection_down() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Add some mock data\n        app.data.models = vec![\n            ModelUsage {\n                model: \"model1\".to_string(),\n                provider: \"provider1\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n            ModelUsage {\n                model: \"model2\".to_string(),\n                provider: \"provider2\".to_string(),\n                source: \"opencode\".to_string(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 1,\n            },\n        ];\n\n        app.selected_index = 0;\n        app.move_selection_down();\n        assert_eq!(app.selected_index, 1);\n\n        // At bottom boundary - should not move\n        app.move_selection_down();\n        assert_eq!(app.selected_index, 1);\n    }\n\n    #[test]\n    fn test_clamp_selection() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Add some mock data\n        app.data.models = vec![ModelUsage {\n            model: \"model1\".to_string(),\n            provider: \"provider1\".to_string(),\n            source: \"opencode\".to_string(),\n            tokens: TokenBreakdown::default(),\n            cost: 0.0,\n            session_count: 1,\n        }];\n\n        // Set selection beyond bounds\n        app.selected_index = 10;\n        app.clamp_selection();\n        assert_eq!(app.selected_index, 0);\n\n        // Empty data\n        app.data.models.clear();\n        app.selected_index = 5;\n        app.clamp_selection();\n        assert_eq!(app.selected_index, 0);\n        assert_eq!(app.scroll_offset, 0);\n    }\n\n    #[test]\n    fn test_set_sort() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let mut app = App::new_with_cached_data(config, None).unwrap();\n\n        // Initial state\n        assert_eq!(app.sort_field, SortField::Cost);\n        assert_eq!(app.sort_direction, SortDirection::Descending);\n\n        // Change to different field\n        app.set_sort(SortField::Tokens);\n        assert_eq!(app.sort_field, SortField::Tokens);\n        assert_eq!(app.sort_direction, SortDirection::Descending);\n\n        // Toggle same field\n        app.set_sort(SortField::Tokens);\n        assert_eq!(app.sort_field, SortField::Tokens);\n        assert_eq!(app.sort_direction, SortDirection::Ascending);\n\n        // Toggle again\n        app.set_sort(SortField::Tokens);\n        assert_eq!(app.sort_field, SortField::Tokens);\n        assert_eq!(app.sort_direction, SortDirection::Descending);\n    }\n\n    #[test]\n    fn test_should_quit() {\n        let config = TuiConfig {\n            theme: \"blue\".to_string(),\n            refresh: 0,\n            sessions_path: None,\n            sources: None,\n            since: None,\n            until: None,\n            year: None,\n            initial_tab: None,\n        };\n        let app = App::new_with_cached_data(config, None).unwrap();\n\n        assert_eq!(app.should_quit, false);\n    }\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":375},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","cache.rs"],"content":"//! TUI data caching for instant startup.\n//!\n//! This module provides disk-based caching for TUI data to enable instant UI display\n//! while fresh data loads in the background (matching TypeScript implementation behavior).\n\nuse std::collections::HashSet;\nuse std::fs::{self, File};\nuse std::io::{BufReader, BufWriter};\nuse std::path::PathBuf;\nuse std::time::{SystemTime, UNIX_EPOCH};\n\nuse serde::{Deserialize, Serialize};\n\nuse super::data::{\n    ContributionDay, DailyModelInfo, DailyUsage, GraphData, ModelUsage, Source, TokenBreakdown,\n    UsageData,\n};\n\n/// Cache staleness threshold: 5 minutes (matches TS implementation)\nconst CACHE_STALE_THRESHOLD_MS: u64 = 5 * 60 * 1000;\n\n/// Get the cache directory path\n/// Uses `~/.cache/tokscale/` to match TypeScript implementation for cache sharing\nfn cache_dir() -\u003e Option\u003cPathBuf\u003e {\n    dirs::home_dir().map(|h| h.join(\".cache\").join(\"tokscale\"))\n}\n\n/// Get the cache file path\nfn cache_file() -\u003e Option\u003cPathBuf\u003e {\n    cache_dir().map(|d| d.join(\"tui-data-cache.json\"))\n}\n\n/// Cached TUI data structure (serializable)\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedTUIData {\n    timestamp: u64,\n    enabled_sources: Vec\u003cString\u003e,\n    data: CachedUsageData,\n}\n\n/// Serializable version of UsageData\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedUsageData {\n    models: Vec\u003cCachedModelUsage\u003e,\n    daily: Vec\u003cCachedDailyUsage\u003e,\n    graph: Option\u003cCachedGraphData\u003e,\n    total_tokens: u64,\n    total_cost: f64,\n    current_streak: u32,\n    longest_streak: u32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedTokenBreakdown {\n    input: u64,\n    output: u64,\n    cache_read: u64,\n    cache_write: u64,\n    reasoning: u64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedModelUsage {\n    model: String,\n    provider: String,\n    source: String,\n    tokens: CachedTokenBreakdown,\n    cost: f64,\n    session_count: u32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedDailyModelInfo {\n    source: String,\n    tokens: CachedTokenBreakdown,\n    cost: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedDailyUsage {\n    date: String, // NaiveDate serialized as string\n    tokens: CachedTokenBreakdown,\n    cost: f64,\n    models: Vec\u003c(String, CachedDailyModelInfo)\u003e, // HashMap as vec of tuples\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedContributionDay {\n    date: String,\n    tokens: u64,\n    cost: f64,\n    intensity: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CachedGraphData {\n    weeks: Vec\u003cVec\u003cOption\u003cCachedContributionDay\u003e\u003e\u003e,\n}\n\n// Conversion implementations\n\nimpl From\u003c\u0026TokenBreakdown\u003e for CachedTokenBreakdown {\n    fn from(t: \u0026TokenBreakdown) -\u003e Self {\n        Self {\n            input: t.input,\n            output: t.output,\n            cache_read: t.cache_read,\n            cache_write: t.cache_write,\n            reasoning: t.reasoning,\n        }\n    }\n}\n\nimpl From\u003cCachedTokenBreakdown\u003e for TokenBreakdown {\n    fn from(t: CachedTokenBreakdown) -\u003e Self {\n        Self {\n            input: t.input,\n            output: t.output,\n            cache_read: t.cache_read,\n            cache_write: t.cache_write,\n            reasoning: t.reasoning,\n        }\n    }\n}\n\nimpl From\u003c\u0026ModelUsage\u003e for CachedModelUsage {\n    fn from(m: \u0026ModelUsage) -\u003e Self {\n        Self {\n            model: m.model.clone(),\n            provider: m.provider.clone(),\n            source: m.source.clone(),\n            tokens: (\u0026m.tokens).into(),\n            cost: m.cost,\n            session_count: m.session_count,\n        }\n    }\n}\n\nimpl From\u003cCachedModelUsage\u003e for ModelUsage {\n    fn from(m: CachedModelUsage) -\u003e Self {\n        Self {\n            model: m.model,\n            provider: m.provider,\n            source: m.source,\n            tokens: m.tokens.into(),\n            cost: m.cost,\n            session_count: m.session_count,\n        }\n    }\n}\n\nimpl From\u003c\u0026DailyModelInfo\u003e for CachedDailyModelInfo {\n    fn from(d: \u0026DailyModelInfo) -\u003e Self {\n        Self {\n            source: d.source.clone(),\n            tokens: (\u0026d.tokens).into(),\n            cost: d.cost,\n        }\n    }\n}\n\nimpl From\u003cCachedDailyModelInfo\u003e for DailyModelInfo {\n    fn from(d: CachedDailyModelInfo) -\u003e Self {\n        Self {\n            source: d.source,\n            tokens: d.tokens.into(),\n            cost: d.cost,\n        }\n    }\n}\n\nimpl From\u003c\u0026DailyUsage\u003e for CachedDailyUsage {\n    fn from(d: \u0026DailyUsage) -\u003e Self {\n        Self {\n            date: d.date.to_string(),\n            tokens: (\u0026d.tokens).into(),\n            cost: d.cost,\n            models: d\n                .models\n                .iter()\n                .map(|(k, v)| (k.clone(), v.into()))\n                .collect(),\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedDailyUsage\u003e for DailyUsage {\n    type Error = chrono::ParseError;\n\n    fn try_from(d: CachedDailyUsage) -\u003e Result\u003cSelf, Self::Error\u003e {\n        use chrono::NaiveDate;\n        Ok(Self {\n            date: NaiveDate::parse_from_str(\u0026d.date, \"%Y-%m-%d\")?,\n            tokens: d.tokens.into(),\n            cost: d.cost,\n            models: d.models.into_iter().map(|(k, v)| (k, v.into())).collect(),\n        })\n    }\n}\n\nimpl From\u003c\u0026ContributionDay\u003e for CachedContributionDay {\n    fn from(c: \u0026ContributionDay) -\u003e Self {\n        Self {\n            date: c.date.to_string(),\n            tokens: c.tokens,\n            cost: c.cost,\n            intensity: c.intensity,\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedContributionDay\u003e for ContributionDay {\n    type Error = chrono::ParseError;\n\n    fn try_from(c: CachedContributionDay) -\u003e Result\u003cSelf, Self::Error\u003e {\n        use chrono::NaiveDate;\n        Ok(Self {\n            date: NaiveDate::parse_from_str(\u0026c.date, \"%Y-%m-%d\")?,\n            tokens: c.tokens,\n            cost: c.cost,\n            intensity: c.intensity,\n        })\n    }\n}\n\nimpl From\u003c\u0026GraphData\u003e for CachedGraphData {\n    fn from(g: \u0026GraphData) -\u003e Self {\n        Self {\n            weeks: g\n                .weeks\n                .iter()\n                .map(|week| {\n                    week.iter()\n                        .map(|day| day.as_ref().map(|d| d.into()))\n                        .collect()\n                })\n                .collect(),\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedGraphData\u003e for GraphData {\n    type Error = chrono::ParseError;\n\n    fn try_from(g: CachedGraphData) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let weeks: Result\u003cVec\u003cVec\u003cOption\u003cContributionDay\u003e\u003e\u003e, _\u003e = g\n            .weeks\n            .into_iter()\n            .map(|week| {\n                week.into_iter()\n                    .map(|day| day.map(|d| d.try_into()).transpose())\n                    .collect()\n            })\n            .collect();\n        Ok(Self { weeks: weeks? })\n    }\n}\n\nimpl From\u003c\u0026UsageData\u003e for CachedUsageData {\n    fn from(u: \u0026UsageData) -\u003e Self {\n        Self {\n            models: u.models.iter().map(|m| m.into()).collect(),\n            daily: u.daily.iter().map(|d| d.into()).collect(),\n            graph: u.graph.as_ref().map(|g| g.into()),\n            total_tokens: u.total_tokens,\n            total_cost: u.total_cost,\n            current_streak: u.current_streak,\n            longest_streak: u.longest_streak,\n        }\n    }\n}\n\nimpl TryFrom\u003cCachedUsageData\u003e for UsageData {\n    type Error = chrono::ParseError;\n\n    fn try_from(u: CachedUsageData) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let daily: Result\u003cVec\u003cDailyUsage\u003e, _\u003e = u.daily.into_iter().map(|d| d.try_into()).collect();\n        let graph: Option\u003cResult\u003cGraphData, _\u003e\u003e = u.graph.map(|g| g.try_into());\n\n        Ok(Self {\n            models: u.models.into_iter().map(|m| m.into()).collect(),\n            daily: daily?,\n            graph: graph.transpose()?,\n            total_tokens: u.total_tokens,\n            total_cost: u.total_cost,\n            loading: false,\n            error: None,\n            current_streak: u.current_streak,\n            longest_streak: u.longest_streak,\n        })\n    }\n}\n\n/// Check if sources match between enabled and cached\nfn sources_match(enabled_sources: \u0026HashSet\u003cSource\u003e, cached_sources: \u0026[String]) -\u003e bool {\n    if enabled_sources.len() != cached_sources.len() {\n        return false;\n    }\n    for source in enabled_sources {\n        if !cached_sources.contains(\u0026source.as_str().to_lowercase()) {\n            return false;\n        }\n    }\n    true\n}\n\n/// Load cached TUI data from disk\npub fn load_cached_data(enabled_sources: \u0026HashSet\u003cSource\u003e) -\u003e Option\u003cUsageData\u003e {\n    let cache_path = cache_file()?;\n\n    if !cache_path.exists() {\n        return None;\n    }\n\n    let file = File::open(\u0026cache_path).ok()?;\n    let reader = BufReader::new(file);\n    let cached: CachedTUIData = serde_json::from_reader(reader).ok()?;\n\n    // Check if sources match\n    if !sources_match(enabled_sources, \u0026cached.enabled_sources) {\n        return None;\n    }\n\n    // Convert cached data to UsageData\n    cached.data.try_into().ok()\n}\n\n/// Save TUI data to disk cache\npub fn save_cached_data(data: \u0026UsageData, enabled_sources: \u0026HashSet\u003cSource\u003e) {\n    let Some(cache_path) = cache_file() else {\n        return;\n    };\n\n    // Ensure cache directory exists\n    if let Some(dir) = cache_path.parent() {\n        if let Err(_) = fs::create_dir_all(dir) {\n            return;\n        }\n    }\n\n    let timestamp = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_millis() as u64;\n\n    let cached = CachedTUIData {\n        timestamp,\n        enabled_sources: enabled_sources\n            .iter()\n            .map(|s| s.as_str().to_lowercase())\n            .collect(),\n        data: data.into(),\n    };\n\n    // Write to temp file first, then rename (atomic)\n    let temp_path = cache_path.with_extension(\"json.tmp\");\n    let file = match File::create(\u0026temp_path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return,\n    };\n    let writer = BufWriter::new(file);\n\n    if serde_json::to_writer(writer, \u0026cached).is_ok() {\n        let _ = fs::rename(\u0026temp_path, \u0026cache_path);\n    } else {\n        let _ = fs::remove_file(\u0026temp_path);\n    }\n}\n\n/// Check if cache is stale (older than threshold)\npub fn is_cache_stale(enabled_sources: \u0026HashSet\u003cSource\u003e) -\u003e bool {\n    let Some(cache_path) = cache_file() else {\n        return true;\n    };\n\n    if !cache_path.exists() {\n        return true;\n    }\n\n    let file = match File::open(\u0026cache_path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return true,\n    };\n    let reader = BufReader::new(file);\n    let cached: CachedTUIData = match serde_json::from_reader(reader) {\n        Ok(c) =\u003e c,\n        Err(_) =\u003e return true,\n    };\n\n    // Check if sources match\n    if !sources_match(enabled_sources, \u0026cached.enabled_sources) {\n        return true;\n    }\n\n    // Check age\n    let now = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_millis() as u64;\n\n    let cache_age = now.saturating_sub(cached.timestamp);\n    cache_age \u003e CACHE_STALE_THRESHOLD_MS\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":144},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","config.rs"],"content":"use std::collections::HashMap;\nuse std::fs;\nuse std::path::PathBuf;\nuse std::sync::OnceLock;\n\nuse ratatui::style::Color;\nuse serde::Deserialize;\n\nstatic CONFIG: OnceLock\u003cTokscaleConfig\u003e = OnceLock::new();\n\n#[derive(Debug, Clone, Default, Deserialize)]\npub struct TokscaleConfig {\n    #[serde(default)]\n    pub colors: ColorsConfig,\n    #[serde(default)]\n    pub display_names: DisplayNamesConfig,\n}\n\n#[derive(Debug, Clone, Default, Deserialize)]\npub struct ColorsConfig {\n    #[serde(default)]\n    pub providers: HashMap\u003cString, String\u003e,\n    #[serde(default)]\n    pub sources: HashMap\u003cString, String\u003e,\n}\n\n#[derive(Debug, Clone, Default, Deserialize)]\npub struct DisplayNamesConfig {\n    #[serde(default)]\n    pub providers: HashMap\u003cString, String\u003e,\n    #[serde(default)]\n    pub sources: HashMap\u003cString, String\u003e,\n}\n\nimpl TokscaleConfig {\n    fn config_path() -\u003e Option\u003cPathBuf\u003e {\n        dirs::home_dir().map(|h| h.join(\".tokscale\"))\n    }\n\n    pub fn load() -\u003e \u0026'static TokscaleConfig {\n        CONFIG.get_or_init(|| {\n            Self::config_path()\n                .and_then(|path| fs::read_to_string(path).ok())\n                .and_then(|content| toml::from_str(\u0026content).ok())\n                .unwrap_or_default()\n        })\n    }\n\n    pub fn get_provider_color(\u0026self, provider: \u0026str) -\u003e Option\u003cColor\u003e {\n        self.colors\n            .providers\n            .get(\u0026provider.to_lowercase())\n            .and_then(|hex| parse_hex_color(hex))\n    }\n\n    pub fn get_source_color(\u0026self, source: \u0026str) -\u003e Option\u003cColor\u003e {\n        self.colors\n            .sources\n            .get(\u0026source.to_lowercase())\n            .and_then(|hex| parse_hex_color(hex))\n    }\n\n    pub fn get_provider_display_name(\u0026self, provider: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        self.display_names\n            .providers\n            .get(\u0026provider.to_lowercase())\n            .map(|s| s.as_str())\n    }\n\n    pub fn get_source_display_name(\u0026self, source: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        self.display_names\n            .sources\n            .get(\u0026source.to_lowercase())\n            .map(|s| s.as_str())\n    }\n}\n\nfn parse_hex_color(hex: \u0026str) -\u003e Option\u003cColor\u003e {\n    let hex = hex.trim().trim_start_matches('#');\n    if hex.len() != 6 {\n        return None;\n    }\n    let r = u8::from_str_radix(\u0026hex[0..2], 16).ok()?;\n    let g = u8::from_str_radix(\u0026hex[2..4], 16).ok()?;\n    let b = u8::from_str_radix(\u0026hex[4..6], 16).ok()?;\n    Some(Color::Rgb(r, g, b))\n}\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","data","mod.rs"],"content":"use std::collections::{HashMap, HashSet};\nuse std::path::PathBuf;\n\nuse anyhow::Result;\nuse chrono::{Datelike, NaiveDate, Utc};\nuse rayon::prelude::*;\nuse tokio::runtime::Runtime;\n\nuse tokscale_core::pricing::PricingService;\nuse tokscale_core::sessions::UnifiedMessage;\nuse tokscale_core::{scanner, sessions};\n\n#[derive(Debug, Clone, Default)]\npub struct TokenBreakdown {\n    pub input: u64,\n    pub output: u64,\n    pub cache_read: u64,\n    pub cache_write: u64,\n    pub reasoning: u64,\n}\n\nimpl TokenBreakdown {\n    pub fn total(\u0026self) -\u003e u64 {\n        self.input\n            .saturating_add(self.output)\n            .saturating_add(self.cache_read)\n            .saturating_add(self.cache_write)\n            .saturating_add(self.reasoning)\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct ModelUsage {\n    pub model: String,\n    pub provider: String,\n    pub source: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub session_count: u32,\n}\n\n#[derive(Debug, Clone)]\npub struct DailyModelInfo {\n    pub source: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n}\n\n#[derive(Debug, Clone)]\npub struct DailyUsage {\n    pub date: NaiveDate,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub models: HashMap\u003cString, DailyModelInfo\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ContributionDay {\n    pub date: NaiveDate,\n    pub tokens: u64,\n    pub cost: f64,\n    pub intensity: f64,\n}\n\n#[derive(Debug, Clone)]\npub struct GraphData {\n    pub weeks: Vec\u003cVec\u003cOption\u003cContributionDay\u003e\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Default)]\npub struct UsageData {\n    pub models: Vec\u003cModelUsage\u003e,\n    pub daily: Vec\u003cDailyUsage\u003e,\n    pub graph: Option\u003cGraphData\u003e,\n    pub total_tokens: u64,\n    pub total_cost: f64,\n    pub loading: bool,\n    pub error: Option\u003cString\u003e,\n    pub current_streak: u32,\n    pub longest_streak: u32,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum Source {\n    OpenCode,\n    Claude,\n    Codex,\n    Cursor,\n    Gemini,\n    Amp,\n    Droid,\n    OpenClaw,\n    Pi,\n}\n\nimpl Source {\n    pub fn all() -\u003e \u0026'static [Source] {\n        \u0026[\n            Source::OpenCode,\n            Source::Claude,\n            Source::Codex,\n            Source::Cursor,\n            Source::Gemini,\n            Source::Amp,\n            Source::Droid,\n            Source::OpenClaw,\n            Source::Pi,\n        ]\n    }\n\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Source::OpenCode =\u003e \"OpenCode\",\n            Source::Claude =\u003e \"Claude\",\n            Source::Codex =\u003e \"Codex\",\n            Source::Cursor =\u003e \"Cursor\",\n            Source::Gemini =\u003e \"Gemini\",\n            Source::Amp =\u003e \"Amp\",\n            Source::Droid =\u003e \"Droid\",\n            Source::OpenClaw =\u003e \"OpenClaw\",\n            Source::Pi =\u003e \"Pi\",\n        }\n    }\n\n    pub fn key(\u0026self) -\u003e char {\n        match self {\n            Source::OpenCode =\u003e '1',\n            Source::Claude =\u003e '2',\n            Source::Codex =\u003e '3',\n            Source::Cursor =\u003e '4',\n            Source::Gemini =\u003e '5',\n            Source::Amp =\u003e '6',\n            Source::Droid =\u003e '7',\n            Source::OpenClaw =\u003e '8',\n            Source::Pi =\u003e '9',\n        }\n    }\n\n    pub fn from_key(key: char) -\u003e Option\u003cSource\u003e {\n        match key {\n            '1' =\u003e Some(Source::OpenCode),\n            '2' =\u003e Some(Source::Claude),\n            '3' =\u003e Some(Source::Codex),\n            '4' =\u003e Some(Source::Cursor),\n            '5' =\u003e Some(Source::Gemini),\n            '6' =\u003e Some(Source::Amp),\n            '7' =\u003e Some(Source::Droid),\n            '8' =\u003e Some(Source::OpenClaw),\n            '9' =\u003e Some(Source::Pi),\n            _ =\u003e None,\n        }\n    }\n\n    fn to_core_source(self) -\u003e \u0026'static str {\n        match self {\n            Source::OpenCode =\u003e \"opencode\",\n            Source::Claude =\u003e \"claude\",\n            Source::Codex =\u003e \"codex\",\n            Source::Cursor =\u003e \"cursor\",\n            Source::Gemini =\u003e \"gemini\",\n            Source::Amp =\u003e \"amp\",\n            Source::Droid =\u003e \"droid\",\n            Source::OpenClaw =\u003e \"openclaw\",\n            Source::Pi =\u003e \"pi\",\n        }\n    }\n}\n\npub struct DataLoader {\n    _sessions_path: Option\u003cPathBuf\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n}\n\nimpl DataLoader {\n    pub fn new(sessions_path: Option\u003cPathBuf\u003e) -\u003e Self {\n        Self {\n            _sessions_path: sessions_path,\n            since: None,\n            until: None,\n            year: None,\n        }\n    }\n\n    pub fn with_filters(\n        sessions_path: Option\u003cPathBuf\u003e,\n        since: Option\u003cString\u003e,\n        until: Option\u003cString\u003e,\n        year: Option\u003cString\u003e,\n    ) -\u003e Self {\n        Self {\n            _sessions_path: sessions_path,\n            since,\n            until,\n            year,\n        }\n    }\n\n    pub fn load(\u0026self, enabled_sources: \u0026[Source]) -\u003e Result\u003cUsageData\u003e {\n        let home = dirs::home_dir()\n            .ok_or_else(|| anyhow::anyhow!(\"Could not find home directory\"))?\n            .to_string_lossy()\n            .to_string();\n\n        let rt = Runtime::new()?;\n        let pricing_result = rt.block_on(async { PricingService::get_or_init().await });\n        let pricing = pricing_result.as_ref().ok();\n\n        let sources: Vec\u003cString\u003e = enabled_sources\n            .iter()\n            .map(|s| s.to_core_source().to_string())\n            .collect();\n\n        let scan_result = scanner::scan_all_sources(\u0026home, \u0026sources);\n\n        let mut all_messages: Vec\u003cUnifiedMessage\u003e = Vec::new();\n\n        if enabled_sources.contains(\u0026Source::OpenCode) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .opencode_files\n                .par_iter()\n                .filter_map(|path| sessions::opencode::parse_opencode_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Claude) {\n            let msgs_raw: Vec\u003cUnifiedMessage\u003e = scan_result\n                .claude_files\n                .par_iter()\n                .flat_map(|path| sessions::claudecode::parse_claude_file(path))\n                .collect();\n\n            let mut seen_keys: HashSet\u003cString\u003e = HashSet::new();\n            let msgs: Vec\u003cUnifiedMessage\u003e = msgs_raw\n                .into_iter()\n                .filter(|m| {\n                    m.dedup_key\n                        .as_ref()\n                        .is_none_or(|k| k.is_empty() || seen_keys.insert(k.clone()))\n                })\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Codex) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .codex_files\n                .par_iter()\n                .flat_map(|path| sessions::codex::parse_codex_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Cursor) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .cursor_files\n                .par_iter()\n                .flat_map(|path| sessions::cursor::parse_cursor_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Gemini) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .gemini_files\n                .par_iter()\n                .flat_map(|path| sessions::gemini::parse_gemini_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Amp) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .amp_files\n                .par_iter()\n                .flat_map(|path| sessions::amp::parse_amp_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Droid) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .droid_files\n                .par_iter()\n                .flat_map(|path| sessions::droid::parse_droid_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::OpenClaw) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .openclaw_files\n                .par_iter()\n                .flat_map(|path| sessions::openclaw::parse_openclaw_index(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if enabled_sources.contains(\u0026Source::Pi) {\n            let msgs: Vec\u003cUnifiedMessage\u003e = scan_result\n                .pi_files\n                .par_iter()\n                .flat_map(|path| sessions::pi::parse_pi_file(path))\n                .collect();\n            all_messages.extend(msgs);\n        }\n\n        if let Some(svc) = pricing {\n            for msg in \u0026mut all_messages {\n                let calculated_cost = svc.calculate_cost(\n                    \u0026msg.model_id,\n                    msg.tokens.input,\n                    msg.tokens.output,\n                    msg.tokens.cache_read,\n                    msg.tokens.cache_write,\n                    msg.tokens.reasoning,\n                );\n                // Only overwrite cost if pricing service returns a positive value\n                // Preserve original cost for sources like cursor/amp that provide pre-calculated costs\n                if calculated_cost \u003e 0.0 {\n                    msg.cost = calculated_cost;\n                }\n            }\n        }\n\n        // Apply date filters if specified\n        let filtered_messages = self.apply_date_filters(all_messages);\n\n        self.aggregate_messages(filtered_messages)\n    }\n\n    fn aggregate_messages(\u0026self, messages: Vec\u003cUnifiedMessage\u003e) -\u003e Result\u003cUsageData\u003e {\n        let mut model_map: HashMap\u003cString, ModelUsage\u003e = HashMap::new();\n        let mut daily_map: HashMap\u003cNaiveDate, DailyUsage\u003e = HashMap::new();\n        let mut model_session_ids: HashMap\u003cString, HashSet\u003cString\u003e\u003e = HashMap::new();\n\n        for msg in \u0026messages {\n            let key = format!(\"{}:{}:{}\", msg.source, msg.provider_id, msg.model_id);\n\n            let model_entry = model_map.entry(key.clone()).or_insert_with(|| ModelUsage {\n                model: msg.model_id.clone(),\n                provider: msg.provider_id.clone(),\n                source: msg.source.clone(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                session_count: 0,\n            });\n\n            model_entry.tokens.input = model_entry\n                .tokens\n                .input\n                .saturating_add(msg.tokens.input.max(0) as u64);\n            model_entry.tokens.output = model_entry\n                .tokens\n                .output\n                .saturating_add(msg.tokens.output.max(0) as u64);\n            model_entry.tokens.cache_read = model_entry\n                .tokens\n                .cache_read\n                .saturating_add(msg.tokens.cache_read.max(0) as u64);\n            model_entry.tokens.cache_write = model_entry\n                .tokens\n                .cache_write\n                .saturating_add(msg.tokens.cache_write.max(0) as u64);\n            model_entry.tokens.reasoning = model_entry\n                .tokens\n                .reasoning\n                .saturating_add(msg.tokens.reasoning.max(0) as u64);\n            let msg_cost = if msg.cost.is_finite() \u0026\u0026 msg.cost \u003e= 0.0 {\n                msg.cost\n            } else {\n                0.0\n            };\n            model_entry.cost += msg_cost;\n\n            let session_key = format!(\"{}:{}\", msg.source, msg.session_id);\n            let model_sessions = model_session_ids.entry(key).or_insert_with(HashSet::new);\n            if model_sessions.insert(session_key) {\n                model_entry.session_count += 1;\n            }\n\n            if let Some(date) = parse_date(\u0026msg.date) {\n                let daily_entry = daily_map.entry(date).or_insert_with(|| DailyUsage {\n                    date,\n                    tokens: TokenBreakdown::default(),\n                    cost: 0.0,\n                    models: HashMap::new(),\n                });\n\n                daily_entry.tokens.input = daily_entry\n                    .tokens\n                    .input\n                    .saturating_add(msg.tokens.input.max(0) as u64);\n                daily_entry.tokens.output = daily_entry\n                    .tokens\n                    .output\n                    .saturating_add(msg.tokens.output.max(0) as u64);\n                daily_entry.tokens.cache_read = daily_entry\n                    .tokens\n                    .cache_read\n                    .saturating_add(msg.tokens.cache_read.max(0) as u64);\n                daily_entry.tokens.cache_write = daily_entry\n                    .tokens\n                    .cache_write\n                    .saturating_add(msg.tokens.cache_write.max(0) as u64);\n                daily_entry.tokens.reasoning = daily_entry\n                    .tokens\n                    .reasoning\n                    .saturating_add(msg.tokens.reasoning.max(0) as u64);\n                let msg_cost = if msg.cost.is_finite() \u0026\u0026 msg.cost \u003e= 0.0 {\n                    msg.cost\n                } else {\n                    0.0\n                };\n                daily_entry.cost += msg_cost;\n\n                let model_info = daily_entry\n                    .models\n                    .entry(msg.model_id.clone())\n                    .or_insert_with(|| DailyModelInfo {\n                        source: msg.source.clone(),\n                        tokens: TokenBreakdown::default(),\n                        cost: 0.0,\n                    });\n\n                model_info.tokens.input = model_info\n                    .tokens\n                    .input\n                    .saturating_add(msg.tokens.input.max(0) as u64);\n                model_info.tokens.output = model_info\n                    .tokens\n                    .output\n                    .saturating_add(msg.tokens.output.max(0) as u64);\n                model_info.tokens.cache_read = model_info\n                    .tokens\n                    .cache_read\n                    .saturating_add(msg.tokens.cache_read.max(0) as u64);\n                model_info.tokens.cache_write = model_info\n                    .tokens\n                    .cache_write\n                    .saturating_add(msg.tokens.cache_write.max(0) as u64);\n                model_info.tokens.reasoning = model_info\n                    .tokens\n                    .reasoning\n                    .saturating_add(msg.tokens.reasoning.max(0) as u64);\n                let model_msg_cost = if msg.cost.is_finite() \u0026\u0026 msg.cost \u003e= 0.0 {\n                    msg.cost\n                } else {\n                    0.0\n                };\n                model_info.cost += model_msg_cost;\n            }\n        }\n\n        let mut models: Vec\u003cModelUsage\u003e = model_map.into_values().collect();\n        models.sort_by(|a, b| {\n            b.cost\n                .total_cmp(\u0026a.cost)\n                .then_with(|| a.model.cmp(\u0026b.model))\n                .then_with(|| a.provider.cmp(\u0026b.provider))\n                .then_with(|| a.source.cmp(\u0026b.source))\n        });\n\n        let mut daily: Vec\u003cDailyUsage\u003e = daily_map.into_values().collect();\n        daily.sort_by(|a, b| b.date.cmp(\u0026a.date));\n\n        let total_tokens: u64 = models.iter().map(|m| m.tokens.total()).sum();\n        let total_cost: f64 = models\n            .iter()\n            .map(|m| if m.cost.is_finite() { m.cost } else { 0.0 })\n            .sum();\n\n        let graph = build_contribution_graph(\u0026daily);\n        let (current_streak, longest_streak) = calculate_streaks(\u0026daily);\n\n        Ok(UsageData {\n            models,\n            daily,\n            graph: Some(graph),\n            total_tokens,\n            total_cost,\n            loading: false,\n            error: None,\n            current_streak,\n            longest_streak,\n        })\n    }\n\n    fn apply_date_filters(\u0026self, messages: Vec\u003cUnifiedMessage\u003e) -\u003e Vec\u003cUnifiedMessage\u003e {\n        // If no filters are specified, return all messages\n        if self.since.is_none() \u0026\u0026 self.until.is_none() \u0026\u0026 self.year.is_none() {\n            return messages;\n        }\n\n        messages\n            .into_iter()\n            .filter(|msg| {\n                if let Some(date) = parse_date(\u0026msg.date) {\n                    // Check year filter\n                    if let Some(ref year_str) = self.year {\n                        if let Ok(year) = year_str.parse::\u003ci32\u003e() {\n                            if date.year() != year {\n                                return false;\n                            }\n                        }\n                    }\n\n                    // Check since filter\n                    if let Some(ref since_str) = self.since {\n                        if let Some(since_date) = parse_date(since_str) {\n                            if date \u003c since_date {\n                                return false;\n                            }\n                        }\n                    }\n\n                    // Check until filter\n                    if let Some(ref until_str) = self.until {\n                        if let Some(until_date) = parse_date(until_str) {\n                            if date \u003e until_date {\n                                return false;\n                            }\n                        }\n                    }\n\n                    true\n                } else {\n                    false\n                }\n            })\n            .collect()\n    }\n}\n\nfn parse_date(date_str: \u0026str) -\u003e Option\u003cNaiveDate\u003e {\n    NaiveDate::parse_from_str(date_str, \"%Y-%m-%d\").ok()\n}\n\nfn build_contribution_graph(daily: \u0026[DailyUsage]) -\u003e GraphData {\n    if daily.is_empty() {\n        return GraphData { weeks: vec![] };\n    }\n\n    let today = Utc::now().date_naive();\n    let days_to_sunday = today.weekday().num_days_from_sunday();\n    let end_date = today;\n    let start_date = end_date - chrono::Duration::days(364 + days_to_sunday as i64);\n\n    let daily_map: HashMap\u003cNaiveDate, \u0026DailyUsage\u003e = daily.iter().map(|d| (d.date, d)).collect();\n\n    let max_cost = daily.iter().map(|d| d.cost).fold(0.0_f64, |a, b| a.max(b));\n\n    let mut weeks: Vec\u003cVec\u003cOption\u003cContributionDay\u003e\u003e\u003e = Vec::new();\n    let mut current_week: Vec\u003cOption\u003cContributionDay\u003e\u003e = Vec::new();\n\n    let mut current_date = start_date;\n    while current_date \u003c= end_date {\n        let day = if let Some(usage) = daily_map.get(\u0026current_date) {\n            let raw_intensity = if max_cost \u003e 0.0 {\n                usage.cost / max_cost\n            } else {\n                0.0\n            };\n            let intensity = if raw_intensity.is_finite() {\n                raw_intensity.clamp(0.0, 1.0)\n            } else {\n                0.0\n            };\n            Some(ContributionDay {\n                date: current_date,\n                tokens: usage.tokens.total(),\n                cost: usage.cost,\n                intensity,\n            })\n        } else {\n            Some(ContributionDay {\n                date: current_date,\n                tokens: 0,\n                cost: 0.0,\n                intensity: 0.0,\n            })\n        };\n\n        current_week.push(day);\n\n        if current_date.weekday() == chrono::Weekday::Sat || current_date == end_date {\n            weeks.push(current_week);\n            current_week = Vec::new();\n        }\n\n        current_date += chrono::Duration::days(1);\n    }\n\n    GraphData { weeks }\n}\n\nfn calculate_streaks(daily: \u0026[DailyUsage]) -\u003e (u32, u32) {\n    if daily.is_empty() {\n        return (0, 0);\n    }\n\n    let today = Utc::now().date_naive();\n    let dates: HashSet\u003cNaiveDate\u003e = daily.iter().map(|d| d.date).collect();\n\n    let mut current_streak = 0u32;\n    let mut check_date = today;\n\n    while dates.contains(\u0026check_date) {\n        current_streak += 1;\n        check_date -= chrono::Duration::days(1);\n    }\n\n    if current_streak == 0 {\n        let yesterday = today - chrono::Duration::days(1);\n        check_date = yesterday;\n        while dates.contains(\u0026check_date) {\n            current_streak += 1;\n            check_date -= chrono::Duration::days(1);\n        }\n    }\n\n    let mut longest_streak = 0u32;\n    let mut sorted_dates: Vec\u003cNaiveDate\u003e = dates.into_iter().collect();\n    sorted_dates.sort();\n\n    let mut streak = 0u32;\n    let mut prev_date: Option\u003cNaiveDate\u003e = None;\n\n    for date in sorted_dates {\n        if let Some(prev) = prev_date {\n            if date == prev + chrono::Duration::days(1) {\n                streak += 1;\n            } else {\n                longest_streak = longest_streak.max(streak);\n                streak = 1;\n            }\n        } else {\n            streak = 1;\n        }\n        prev_date = Some(date);\n    }\n    longest_streak = longest_streak.max(streak);\n\n    (current_streak, longest_streak)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_source_all() {\n        let sources = Source::all();\n        assert_eq!(sources.len(), 9);\n        assert_eq!(sources[0], Source::OpenCode);\n        assert_eq!(sources[1], Source::Claude);\n        assert_eq!(sources[2], Source::Codex);\n        assert_eq!(sources[3], Source::Cursor);\n        assert_eq!(sources[4], Source::Gemini);\n        assert_eq!(sources[5], Source::Amp);\n        assert_eq!(sources[6], Source::Droid);\n        assert_eq!(sources[7], Source::OpenClaw);\n        assert_eq!(sources[8], Source::Pi);\n    }\n\n    #[test]\n    fn test_source_as_str() {\n        assert_eq!(Source::OpenCode.as_str(), \"OpenCode\");\n        assert_eq!(Source::Claude.as_str(), \"Claude\");\n        assert_eq!(Source::Codex.as_str(), \"Codex\");\n        assert_eq!(Source::Cursor.as_str(), \"Cursor\");\n        assert_eq!(Source::Gemini.as_str(), \"Gemini\");\n        assert_eq!(Source::Amp.as_str(), \"Amp\");\n        assert_eq!(Source::Droid.as_str(), \"Droid\");\n        assert_eq!(Source::OpenClaw.as_str(), \"OpenClaw\");\n        assert_eq!(Source::Pi.as_str(), \"Pi\");\n    }\n\n    #[test]\n    fn test_source_key() {\n        assert_eq!(Source::OpenCode.key(), '1');\n        assert_eq!(Source::Claude.key(), '2');\n        assert_eq!(Source::Codex.key(), '3');\n        assert_eq!(Source::Cursor.key(), '4');\n        assert_eq!(Source::Gemini.key(), '5');\n        assert_eq!(Source::Amp.key(), '6');\n        assert_eq!(Source::Droid.key(), '7');\n        assert_eq!(Source::OpenClaw.key(), '8');\n        assert_eq!(Source::Pi.key(), '9');\n    }\n\n    #[test]\n    fn test_source_from_key() {\n        assert_eq!(Source::from_key('1'), Some(Source::OpenCode));\n        assert_eq!(Source::from_key('2'), Some(Source::Claude));\n        assert_eq!(Source::from_key('3'), Some(Source::Codex));\n        assert_eq!(Source::from_key('4'), Some(Source::Cursor));\n        assert_eq!(Source::from_key('5'), Some(Source::Gemini));\n        assert_eq!(Source::from_key('6'), Some(Source::Amp));\n        assert_eq!(Source::from_key('7'), Some(Source::Droid));\n        assert_eq!(Source::from_key('8'), Some(Source::OpenClaw));\n        assert_eq!(Source::from_key('9'), Some(Source::Pi));\n        assert_eq!(Source::from_key('0'), None);\n        assert_eq!(Source::from_key('a'), None);\n    }\n\n    #[test]\n    fn test_token_breakdown_total() {\n        let breakdown = TokenBreakdown {\n            input: 100,\n            output: 200,\n            cache_read: 50,\n            cache_write: 25,\n            reasoning: 10,\n        };\n        assert_eq!(breakdown.total(), 385);\n    }\n\n    #[test]\n    fn test_token_breakdown_total_with_overflow() {\n        let breakdown = TokenBreakdown {\n            input: u64::MAX,\n            output: 1,\n            cache_read: 0,\n            cache_write: 0,\n            reasoning: 0,\n        };\n        // saturating_add should prevent overflow\n        assert_eq!(breakdown.total(), u64::MAX);\n    }\n\n    #[test]\n    fn test_token_breakdown_default() {\n        let breakdown = TokenBreakdown::default();\n        assert_eq!(breakdown.input, 0);\n        assert_eq!(breakdown.output, 0);\n        assert_eq!(breakdown.cache_read, 0);\n        assert_eq!(breakdown.cache_write, 0);\n        assert_eq!(breakdown.reasoning, 0);\n        assert_eq!(breakdown.total(), 0);\n    }\n\n    #[test]\n    fn test_data_loader_new() {\n        let loader = DataLoader::new(None);\n        assert!(loader._sessions_path.is_none());\n        assert!(loader.since.is_none());\n        assert!(loader.until.is_none());\n        assert!(loader.year.is_none());\n    }\n\n    #[test]\n    fn test_data_loader_with_filters() {\n        let loader = DataLoader::with_filters(\n            Some(PathBuf::from(\"/tmp/sessions\")),\n            Some(\"2024-01-01\".to_string()),\n            Some(\"2024-12-31\".to_string()),\n            Some(\"2024\".to_string()),\n        );\n        \n        assert_eq!(loader._sessions_path, Some(PathBuf::from(\"/tmp/sessions\")));\n        assert_eq!(loader.since, Some(\"2024-01-01\".to_string()));\n        assert_eq!(loader.until, Some(\"2024-12-31\".to_string()));\n        assert_eq!(loader.year, Some(\"2024\".to_string()));\n    }\n\n    #[test]\n    fn test_parse_date() {\n        assert_eq!(\n            parse_date(\"2024-01-15\"),\n            Some(NaiveDate::from_ymd_opt(2024, 1, 15).unwrap())\n        );\n        assert_eq!(\n            parse_date(\"2024-12-31\"),\n            Some(NaiveDate::from_ymd_opt(2024, 12, 31).unwrap())\n        );\n        assert_eq!(parse_date(\"invalid\"), None);\n        assert_eq!(parse_date(\"2024-13-01\"), None);\n        assert_eq!(parse_date(\"\"), None);\n    }\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":348},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","event.rs"],"content":"use std::sync::mpsc;\nuse std::thread;\nuse std::time::Duration;\n\nuse anyhow::Result;\nuse crossterm::event::{self, KeyEvent, MouseEvent};\n\npub enum Event {\n    Tick,\n    Key(KeyEvent),\n    Mouse(MouseEvent),\n    Resize(u16, u16),\n}\n\npub struct EventHandler {\n    rx: mpsc::Receiver\u003cEvent\u003e,\n}\n\nimpl EventHandler {\n    pub fn new(tick_rate: Duration) -\u003e Self {\n        let (tx, rx) = mpsc::channel();\n        let event_tx = tx.clone();\n\n        thread::spawn(move || loop {\n            if event::poll(tick_rate).unwrap_or(false) {\n                match event::read() {\n                    Ok(event::Event::Key(key)) =\u003e {\n                        if event_tx.send(Event::Key(key)).is_err() {\n                            break;\n                        }\n                    }\n                    Ok(event::Event::Mouse(mouse)) =\u003e {\n                        if event_tx.send(Event::Mouse(mouse)).is_err() {\n                            break;\n                        }\n                    }\n                    Ok(event::Event::Resize(w, h)) =\u003e {\n                        if event_tx.send(Event::Resize(w, h)).is_err() {\n                            break;\n                        }\n                    }\n                    _ =\u003e {}\n                }\n            } else if event_tx.send(Event::Tick).is_err() {\n                break;\n            }\n        });\n\n        drop(tx);\n        Self { rx }\n    }\n\n    pub fn next(\u0026mut self) -\u003e Result\u003cEvent\u003e {\n        Ok(self.rx.recv()?)\n    }\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":21},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","mod.rs"],"content":"mod app;\nmod cache;\npub mod config;\npub mod data;\nmod event;\npub mod settings;\nmod themes;\nmod ui;\n\npub use app::{App, Tab, TuiConfig};\npub use cache::{is_cache_stale, load_cached_data, save_cached_data};\npub use data::{DataLoader, Source, UsageData};\npub use event::{Event, EventHandler};\n\nuse std::collections::HashSet;\nuse std::io;\nuse std::sync::mpsc;\nuse std::sync::mpsc::TryRecvError;\nuse std::thread;\nuse std::time::Duration;\n\nuse anyhow::Result;\nuse crossterm::{\n    event::{DisableMouseCapture, EnableMouseCapture},\n    execute,\n    terminal::{disable_raw_mode, enable_raw_mode, EnterAlternateScreen, LeaveAlternateScreen},\n};\nuse ratatui::prelude::*;\n\npub fn run(\n    theme: \u0026str,\n    refresh: u64,\n    debug: bool,\n    sources: Option\u003cVec\u003cString\u003e\u003e,\n    since: Option\u003cString\u003e,\n    until: Option\u003cString\u003e,\n    year: Option\u003cString\u003e,\n    initial_tab: Option\u003cTab\u003e,\n) -\u003e Result\u003c()\u003e {\n    if debug {\n        let _ = tracing_subscriber::fmt()\n            .with_env_filter(\"debug\")\n            .try_init();\n    }\n\n    let config = TuiConfig {\n        theme: theme.to_string(),\n        refresh,\n        sessions_path: None,\n        sources: sources.clone(),\n        since: since.clone(),\n        until: until.clone(),\n        year: year.clone(),\n        initial_tab,\n    };\n\n    let mut enabled_sources = HashSet::new();\n    if let Some(ref cli_sources) = sources {\n        for source_str in cli_sources {\n            match source_str.as_str() {\n                \"opencode\" =\u003e enabled_sources.insert(Source::OpenCode),\n                \"claude\" =\u003e enabled_sources.insert(Source::Claude),\n                \"codex\" =\u003e enabled_sources.insert(Source::Codex),\n                \"cursor\" =\u003e enabled_sources.insert(Source::Cursor),\n                \"gemini\" =\u003e enabled_sources.insert(Source::Gemini),\n                \"amp\" =\u003e enabled_sources.insert(Source::Amp),\n                \"droid\" =\u003e enabled_sources.insert(Source::Droid),\n                \"openclaw\" =\u003e enabled_sources.insert(Source::OpenClaw),\n                \"pi\" =\u003e enabled_sources.insert(Source::Pi),\n                _ =\u003e false,\n            };\n        }\n    } else {\n        for source in Source::all() {\n            enabled_sources.insert(*source);\n        }\n    }\n\n    let cached_data = load_cached_data(\u0026enabled_sources);\n    let cache_is_stale = cached_data.is_some() \u0026\u0026 is_cache_stale(\u0026enabled_sources);\n    let has_cached_data = cached_data.is_some();\n\n    enable_raw_mode()?;\n    let mut stdout = io::stdout();\n\n    if let Err(e) = execute!(stdout, EnterAlternateScreen, EnableMouseCapture) {\n        let _ = disable_raw_mode();\n        return Err(e.into());\n    }\n\n    let backend = CrosstermBackend::new(stdout);\n    let terminal_result = Terminal::new(backend);\n    let mut terminal = match terminal_result {\n        Ok(t) =\u003e t,\n        Err(e) =\u003e {\n            restore_terminal_best_effort();\n            return Err(e.into());\n        }\n    };\n\n    let mut app = match App::new_with_cached_data(config, cached_data) {\n        Ok(a) =\u003e a,\n        Err(e) =\u003e {\n            restore_terminal(\u0026mut terminal);\n            return Err(e);\n        }\n    };\n\n    let (tx, rx) = mpsc::channel::\u003cResult\u003cUsageData\u003e\u003e();\n    let needs_background_load = !has_cached_data || cache_is_stale;\n\n    if needs_background_load {\n        app.set_background_loading(true);\n\n        let bg_sources: Vec\u003cSource\u003e = enabled_sources.iter().copied().collect();\n        let bg_since = since.clone();\n        let bg_until = until.clone();\n        let bg_year = year.clone();\n        let bg_enabled_sources = enabled_sources.clone();\n\n        thread::spawn(move || {\n            let loader = DataLoader::with_filters(None, bg_since, bg_until, bg_year);\n            let result = loader.load(\u0026bg_sources);\n\n            if let Ok(ref data) = result {\n                save_cached_data(data, \u0026bg_enabled_sources);\n            }\n\n            let _ = tx.send(result);\n        });\n    }\n\n    let mut events = EventHandler::new(Duration::from_millis(100));\n\n    let result = run_loop_with_background(\u0026mut terminal, \u0026mut app, \u0026mut events, rx);\n\n    restore_terminal(\u0026mut terminal);\n\n    result\n}\n\nfn restore_terminal_best_effort() {\n    let _ = execute!(io::stdout(), LeaveAlternateScreen, DisableMouseCapture);\n    let _ = disable_raw_mode();\n}\n\nfn restore_terminal(terminal: \u0026mut Terminal\u003cCrosstermBackend\u003cio::Stdout\u003e\u003e) {\n    let _ = disable_raw_mode();\n    let _ = execute!(\n        terminal.backend_mut(),\n        LeaveAlternateScreen,\n        DisableMouseCapture\n    );\n    let _ = terminal.show_cursor();\n}\n\nfn run_loop_with_background(\n    terminal: \u0026mut Terminal\u003cCrosstermBackend\u003cio::Stdout\u003e\u003e,\n    app: \u0026mut App,\n    events: \u0026mut EventHandler,\n    background_rx: mpsc::Receiver\u003cResult\u003cUsageData\u003e\u003e,\n) -\u003e Result\u003c()\u003e {\n    loop {\n        terminal.draw(|f| ui::render(f, app))?;\n\n        match background_rx.try_recv() {\n            Ok(result) =\u003e {\n                app.set_background_loading(false);\n                match result {\n                    Ok(data) =\u003e {\n                        app.update_data(data);\n                        app.set_status(\"Data loaded\");\n                    }\n                    Err(e) =\u003e {\n                        app.set_error(Some(e.to_string()));\n                        app.set_status(\u0026format!(\"Error: {}\", e));\n                    }\n                }\n            }\n            Err(TryRecvError::Disconnected) =\u003e {\n                // Only treat as error if we were still waiting for data\n                // After data is received, disconnect is expected (thread completed)\n                if app.background_loading {\n                    app.set_background_loading(false);\n                    app.set_error(Some(\"Background thread disconnected\".to_string()));\n                    app.set_status(\"Error: Background thread disconnected\");\n                }\n            }\n            Err(TryRecvError::Empty) =\u003e {\n                // No data available yet, continue\n            }\n        }\n\n        match events.next()? {\n            Event::Tick =\u003e {\n                app.on_tick();\n            }\n            Event::Key(key) =\u003e {\n                if app.handle_key_event(key) {\n                    break;\n                }\n            }\n            Event::Mouse(mouse) =\u003e {\n                app.handle_mouse_event(mouse);\n            }\n            Event::Resize(w, h) =\u003e {\n                app.handle_resize(w, h);\n            }\n        }\n\n        if app.should_quit {\n            break;\n        }\n    }\n    Ok(())\n}\n\npub fn test_data_loading() -\u003e Result\u003c()\u003e {\n    println!(\"Testing data loading...\");\n\n    let loader = DataLoader::new(None);\n    let all_sources = vec![\n        Source::OpenCode,\n        Source::Claude,\n        Source::Cursor,\n        Source::Gemini,\n        Source::Codex,\n        Source::Amp,\n        Source::Droid,\n        Source::OpenClaw,\n        Source::Pi,\n    ];\n\n    let data = loader.load(\u0026all_sources)?;\n\n    println!(\"Loaded {} models\", data.models.len());\n    println!(\"Total cost: ${:.2}\", data.total_cost);\n\n    println!(\"\\nAll models (source:model):\");\n    let mut models = data.models.clone();\n    models.sort_by(|a, b| {\n        let source_cmp = a.source.cmp(\u0026b.source);\n        if source_cmp == std::cmp::Ordering::Equal {\n            a.model.cmp(\u0026b.model)\n        } else {\n            source_cmp\n        }\n    });\n    for m in \u0026models {\n        println!(\"{}:{}\", m.source.to_lowercase(), m.model);\n    }\n\n    Ok(())\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":127},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","settings.rs"],"content":"use std::fs;\nuse std::path::PathBuf;\nuse std::time::Duration;\n\nuse anyhow::Result;\nuse serde::{Deserialize, Serialize};\n\nuse super::themes::ThemeName;\n\nconst DEFAULT_AUTO_REFRESH_MS: u64 = 60_000;\nconst MIN_AUTO_REFRESH_MS: u64 = 30_000;\nconst MAX_AUTO_REFRESH_MS: u64 = 3_600_000;\n\nconst DEFAULT_NATIVE_TIMEOUT_MS: u64 = 300_000;\nconst MIN_NATIVE_TIMEOUT_MS: u64 = 5_000;\nconst MAX_NATIVE_TIMEOUT_MS: u64 = 3_600_000;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\npub struct Settings {\n    #[serde(default = \"default_color_palette\")]\n    pub color_palette: String,\n    #[serde(default)]\n    pub auto_refresh_enabled: bool,\n    #[serde(default = \"default_auto_refresh_ms\")]\n    pub auto_refresh_ms: u64,\n    #[serde(default)]\n    pub include_unused_models: bool,\n    #[serde(default = \"default_native_timeout_ms\")]\n    pub native_timeout_ms: u64,\n}\n\nfn default_color_palette() -\u003e String {\n    \"blue\".to_string()\n}\n\nfn default_auto_refresh_ms() -\u003e u64 {\n    DEFAULT_AUTO_REFRESH_MS\n}\n\nfn default_native_timeout_ms() -\u003e u64 {\n    DEFAULT_NATIVE_TIMEOUT_MS\n}\n\nimpl Default for Settings {\n    fn default() -\u003e Self {\n        Self {\n            color_palette: default_color_palette(),\n            auto_refresh_enabled: false,\n            auto_refresh_ms: DEFAULT_AUTO_REFRESH_MS,\n            include_unused_models: false,\n            native_timeout_ms: DEFAULT_NATIVE_TIMEOUT_MS,\n        }\n    }\n}\n\nimpl Settings {\n    fn config_path() -\u003e Result\u003cPathBuf\u003e {\n        let config_dir = dirs::config_dir()\n            .ok_or_else(|| anyhow::anyhow!(\"Could not find config directory\"))?\n            .join(\"tokscale\");\n\n        if !config_dir.exists() {\n            fs::create_dir_all(\u0026config_dir)?;\n        }\n\n        Ok(config_dir.join(\"settings.json\"))\n    }\n\n    pub fn load() -\u003e Self {\n        Self::config_path()\n            .ok()\n            .and_then(|path| fs::read_to_string(path).ok())\n            .and_then(|content| serde_json::from_str(\u0026content).ok())\n            .map(|mut s: Settings| {\n                s.auto_refresh_ms = s\n                    .auto_refresh_ms\n                    .clamp(MIN_AUTO_REFRESH_MS, MAX_AUTO_REFRESH_MS);\n                s.native_timeout_ms = s\n                    .native_timeout_ms\n                    .clamp(MIN_NATIVE_TIMEOUT_MS, MAX_NATIVE_TIMEOUT_MS);\n                s\n            })\n            .unwrap_or_default()\n    }\n\n    pub fn save(\u0026self) -\u003e Result\u003c()\u003e {\n        let path = Self::config_path()?;\n        let content = serde_json::to_string_pretty(self)?;\n        fs::write(path, content)?;\n        Ok(())\n    }\n\n    pub fn theme_name(\u0026self) -\u003e ThemeName {\n        self.color_palette.parse().unwrap_or(ThemeName::Blue)\n    }\n\n    pub fn set_theme(\u0026mut self, theme: ThemeName) {\n        self.color_palette = theme.as_str().to_string();\n    }\n\n    pub fn get_auto_refresh_interval(\u0026self) -\u003e Option\u003cDuration\u003e {\n        if self.auto_refresh_enabled \u0026\u0026 self.auto_refresh_ms \u003e 0 {\n            Some(Duration::from_millis(self.auto_refresh_ms))\n        } else {\n            None\n        }\n    }\n\n    pub fn get_native_timeout(\u0026self) -\u003e Duration {\n        let timeout_ms = if let Ok(env_val) = std::env::var(\"TOKSCALE_NATIVE_TIMEOUT_MS\") {\n            env_val.parse::\u003cu64\u003e().unwrap_or(self.native_timeout_ms)\n        } else {\n            self.native_timeout_ms\n        };\n\n        let clamped = timeout_ms.clamp(MIN_NATIVE_TIMEOUT_MS, MAX_NATIVE_TIMEOUT_MS);\n        Duration::from_millis(clamped)\n    }\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":45},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","themes.rs"],"content":"use ratatui::style::Color;\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ThemeName {\n    Green,\n    Halloween,\n    Teal,\n    Blue,\n    Pink,\n    Purple,\n    Orange,\n    Monochrome,\n    YlGnBu,\n}\n\nimpl ThemeName {\n    pub fn all() -\u003e \u0026'static [ThemeName] {\n        \u0026[\n            ThemeName::Green,\n            ThemeName::Halloween,\n            ThemeName::Teal,\n            ThemeName::Blue,\n            ThemeName::Pink,\n            ThemeName::Purple,\n            ThemeName::Orange,\n            ThemeName::Monochrome,\n            ThemeName::YlGnBu,\n        ]\n    }\n\n    pub fn next(self) -\u003e ThemeName {\n        let themes = Self::all();\n        let idx = themes.iter().position(|\u0026t| t == self).unwrap_or(0);\n        themes[(idx + 1) % themes.len()]\n    }\n\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            ThemeName::Green =\u003e \"green\",\n            ThemeName::Halloween =\u003e \"halloween\",\n            ThemeName::Teal =\u003e \"teal\",\n            ThemeName::Blue =\u003e \"blue\",\n            ThemeName::Pink =\u003e \"pink\",\n            ThemeName::Purple =\u003e \"purple\",\n            ThemeName::Orange =\u003e \"orange\",\n            ThemeName::Monochrome =\u003e \"monochrome\",\n            ThemeName::YlGnBu =\u003e \"ylgnbu\",\n        }\n    }\n}\n\nimpl std::str::FromStr for ThemeName {\n    type Err = ();\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match s.to_lowercase().as_str() {\n            \"green\" =\u003e Ok(ThemeName::Green),\n            \"halloween\" =\u003e Ok(ThemeName::Halloween),\n            \"teal\" =\u003e Ok(ThemeName::Teal),\n            \"blue\" =\u003e Ok(ThemeName::Blue),\n            \"pink\" =\u003e Ok(ThemeName::Pink),\n            \"purple\" =\u003e Ok(ThemeName::Purple),\n            \"orange\" =\u003e Ok(ThemeName::Orange),\n            \"monochrome\" =\u003e Ok(ThemeName::Monochrome),\n            \"ylgnbu\" =\u003e Ok(ThemeName::YlGnBu),\n            _ =\u003e Err(()),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct Theme {\n    pub name: ThemeName,\n    pub colors: [Color; 5],\n    pub background: Color,\n    pub foreground: Color,\n    pub border: Color,\n    pub highlight: Color,\n    pub muted: Color,\n    pub accent: Color,\n    pub selection: Color,\n}\n\nimpl Theme {\n    pub fn from_name(name: ThemeName) -\u003e Self {\n        let colors = match name {\n            // Colors match frontend contribution graph palettes (higher grade = darker = more activity)\n            ThemeName::Green =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(155, 233, 168), // grade1: #9be9a8\n                Color::Rgb(64, 196, 99),   // grade2: #40c463\n                Color::Rgb(48, 161, 78),   // grade3: #30a14e\n                Color::Rgb(33, 110, 57),   // grade4: #216e39\n            ],\n            ThemeName::Halloween =\u003e [\n                Color::Rgb(22, 27, 34),   // grade0: empty\n                Color::Rgb(255, 238, 74), // grade1: #FFEE4A\n                Color::Rgb(255, 197, 1),  // grade2: #FFC501\n                Color::Rgb(254, 150, 0),  // grade3: #FE9600\n                Color::Rgb(3, 0, 28),     // grade4: #03001C\n            ],\n            ThemeName::Teal =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(126, 229, 229), // grade1: #7ee5e5\n                Color::Rgb(45, 197, 197),  // grade2: #2dc5c5\n                Color::Rgb(13, 158, 158),  // grade3: #0d9e9e\n                Color::Rgb(14, 109, 109),  // grade4: #0e6d6d\n            ],\n            ThemeName::Blue =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(121, 184, 255), // grade1: #79b8ff\n                Color::Rgb(56, 139, 253),  // grade2: #388bfd\n                Color::Rgb(31, 111, 235),  // grade3: #1f6feb\n                Color::Rgb(13, 65, 157),   // grade4: #0d419d\n            ],\n            ThemeName::Pink =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(240, 181, 210), // grade1: #f0b5d2\n                Color::Rgb(217, 97, 160),  // grade2: #d961a0\n                Color::Rgb(191, 75, 138),  // grade3: #bf4b8a\n                Color::Rgb(153, 40, 110),  // grade4: #99286e\n            ],\n            ThemeName::Purple =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(205, 180, 255), // grade1: #cdb4ff\n                Color::Rgb(163, 113, 247), // grade2: #a371f7\n                Color::Rgb(137, 87, 229),  // grade3: #8957e5\n                Color::Rgb(110, 64, 201),  // grade4: #6e40c9\n            ],\n            ThemeName::Orange =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(255, 214, 153), // grade1: #ffd699\n                Color::Rgb(255, 179, 71),  // grade2: #ffb347\n                Color::Rgb(255, 140, 0),   // grade3: #ff8c00\n                Color::Rgb(204, 85, 0),    // grade4: #cc5500\n            ],\n            ThemeName::Monochrome =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(158, 158, 158), // grade1: #9e9e9e\n                Color::Rgb(117, 117, 117), // grade2: #757575\n                Color::Rgb(66, 66, 66),    // grade3: #424242\n                Color::Rgb(33, 33, 33),    // grade4: #212121\n            ],\n            ThemeName::YlGnBu =\u003e [\n                Color::Rgb(22, 27, 34),    // grade0: empty\n                Color::Rgb(161, 218, 180), // grade1: #a1dab4\n                Color::Rgb(65, 182, 196),  // grade2: #41b6c4\n                Color::Rgb(44, 127, 184),  // grade3: #2c7fb8\n                Color::Rgb(37, 52, 148),   // grade4: #253494\n            ],\n        };\n\n        Self {\n            name,\n            colors,\n            background: Color::Rgb(13, 17, 23),\n            foreground: Color::Rgb(201, 209, 217),\n            border: Color::Rgb(48, 54, 61),\n            highlight: colors[4],\n            muted: Color::Rgb(139, 148, 158),\n            accent: Color::Cyan,\n            selection: Color::Rgb(48, 54, 61),\n        }\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":100},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","bar_chart.rs"],"content":"use ratatui::prelude::*;\n\nuse super::widgets::format_tokens;\nuse crate::tui::app::App;\n\n/// 8-level block characters for sub-cell precision (matching OpenTUI)\nconst BLOCKS: \u0026[char] = \u0026[' ', 'â–', 'â–‚', 'â–ƒ', 'â–„', 'â–…', 'â–†', 'â–‡', 'â–ˆ'];\n\nconst MONTH_NAMES: \u0026[\u0026str] = \u0026[\n    \"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\",\n];\n\n/// A single model's contribution to a bar\n#[derive(Debug, Clone)]\npub struct ModelSegment {\n    pub model_id: String,\n    pub tokens: u64,\n    pub color: Color,\n}\n\n/// Data for a single bar in the stacked chart\n#[derive(Debug, Clone)]\npub struct StackedBarData {\n    pub date: String,\n    pub models: Vec\u003cModelSegment\u003e,\n    pub total: u64,\n}\n\n/// Render a stacked bar chart where each bar shows model breakdown\npub fn render_stacked_bar_chart(frame: \u0026mut Frame, app: \u0026App, area: Rect, data: \u0026[StackedBarData]) {\n    if data.is_empty() {\n        return;\n    }\n\n    let is_very_narrow = app.is_very_narrow();\n    let y_label_width: u16 = if is_very_narrow { 6 } else { 7 };\n\n    let chart_width = area.width.saturating_sub(y_label_width) as usize;\n    let chart_height = area.height.saturating_sub(3) as usize;\n\n    if chart_width == 0 || chart_height == 0 {\n        return;\n    }\n\n    let max_value = data\n        .iter()\n        .map(|d| d.total as f64)\n        .fold(0.0_f64, |a, b| a.max(b))\n        .max(1.0);\n\n    let buf = frame.buffer_mut();\n    let bar_count = data.len();\n\n    let get_bar_width = |index: usize| -\u003e usize {\n        if bar_count == 0 {\n            return 1;\n        }\n        let start = (index * chart_width) / bar_count;\n        let end = ((index + 1) * chart_width) / bar_count;\n        (end - start).max(1)\n    };\n\n    // Title\n    let title = if is_very_narrow {\n        \"Tokens\"\n    } else {\n        \"Tokens per Day\"\n    };\n    let title_y = area.y;\n    for (i, ch) in title.chars().enumerate() {\n        let x = area.x + y_label_width + i as u16;\n        if x \u003c area.x + area.width {\n            buf[(x, title_y)]\n                .set_char(ch)\n                .set_style(Style::default().add_modifier(Modifier::BOLD));\n        }\n    }\n\n    // Render bars row by row (from top to bottom visually, which is high values to low)\n    for row_from_bottom in (0..chart_height).rev() {\n        let row_index = chart_height - 1 - row_from_bottom;\n        let y = area.y + 1 + row_index as u16;\n\n        // Y-axis label (only at top)\n        let y_label = if row_from_bottom == chart_height - 1 {\n            format_tokens(max_value as u64)\n        } else {\n            String::new()\n        };\n        let padded_label = format!(\"{:\u003ewidth$}â”‚\", y_label, width = (y_label_width - 1) as usize);\n        for (i, ch) in padded_label.chars().enumerate() {\n            let x = area.x + i as u16;\n            if x \u003c area.x + y_label_width {\n                buf[(x, y)]\n                    .set_char(ch)\n                    .set_style(Style::default().fg(app.theme.muted));\n            }\n        }\n\n        // Render each bar\n        let mut x_pos = area.x + y_label_width;\n        for (bar_index, bar_data) in data.iter().enumerate() {\n            let bar_width = get_bar_width(bar_index);\n\n            let row_threshold = ((row_from_bottom + 1) as f64 / chart_height as f64) * max_value;\n            let prev_threshold = (row_from_bottom as f64 / chart_height as f64) * max_value;\n            let threshold_diff = row_threshold - prev_threshold;\n\n            let total = bar_data.total as f64;\n\n            // Get the character and color for this cell using stacked model logic\n            let (ch, fg_color) = get_stacked_bar_content(\n                bar_data,\n                total,\n                row_threshold,\n                prev_threshold,\n                threshold_diff,\n                app.theme.muted,\n                app.theme.highlight,\n            );\n\n            for _ in 0..bar_width {\n                if x_pos \u003c area.x + area.width {\n                    buf[(x_pos, y)].set_char(ch).set_fg(fg_color);\n                    x_pos += 1;\n                }\n            }\n        }\n    }\n\n    // X-axis\n    let axis_y = area.y + 1 + chart_height as u16;\n    if axis_y \u003c area.y + area.height {\n        let zero_label = format!(\"{:\u003ewidth$}â”‚\", \"0\", width = (y_label_width - 1) as usize);\n        for (i, ch) in zero_label.chars().enumerate() {\n            let x = area.x + i as u16;\n            if x \u003c area.x + y_label_width {\n                buf[(x, axis_y)]\n                    .set_char(ch)\n                    .set_style(Style::default().fg(app.theme.muted));\n            }\n        }\n        for x in (area.x + y_label_width)..(area.x + area.width) {\n            buf[(x, axis_y)]\n                .set_char('â”€')\n                .set_style(Style::default().fg(app.theme.muted));\n        }\n    }\n\n    // X-axis labels\n    let label_y = axis_y + 1;\n    if label_y \u003c area.y + area.height \u0026\u0026 !data.is_empty() {\n        let num_labels = if is_very_narrow { 2 } else { 3 };\n        let label_interval = (bar_count / num_labels).max(1);\n\n        for i in (0..bar_count).step_by(label_interval) {\n            let date_str = \u0026data[i].date;\n\n            let label = if let Some((month_str, day_str)) = date_str.split_once('/') {\n                if let (Ok(month), Ok(day)) = (month_str.parse::\u003cusize\u003e(), day_str.parse::\u003cu32\u003e()) {\n                    if (1..=12).contains(\u0026month) {\n                        if is_very_narrow {\n                            format!(\"{}/{}\", month, day)\n                        } else {\n                            format!(\"{} {}\", MONTH_NAMES[month - 1], day)\n                        }\n                    } else {\n                        date_str.clone()\n                    }\n                } else {\n                    date_str.clone()\n                }\n            } else {\n                date_str.clone()\n            };\n\n            let bar_start_x = (i * chart_width) / bar_count;\n            let label_x = area.x + y_label_width + bar_start_x as u16;\n\n            for (j, ch) in label.chars().enumerate() {\n                let x = label_x + j as u16;\n                if x \u003c area.x + area.width {\n                    buf[(x, label_y)]\n                        .set_char(ch)\n                        .set_style(Style::default().fg(app.theme.muted));\n                }\n            }\n        }\n    }\n}\n\nfn get_stacked_bar_content(\n    bar_data: \u0026StackedBarData,\n    total: f64,\n    row_threshold: f64,\n    prev_threshold: f64,\n    threshold_diff: f64,\n    muted_color: Color,\n    fallback_color: Color,\n) -\u003e (char, Color) {\n    if total \u003c= prev_threshold {\n        return (' ', muted_color);\n    }\n\n    if bar_data.models.is_empty() {\n        return (' ', muted_color);\n    }\n\n    // Note: Sorting happens per cell render. If performance becomes an issue,\n    // consider pre-sorting the model list before calling this function.\n    let mut sorted_models: Vec\u003c\u0026ModelSegment\u003e = bar_data.models.iter().collect();\n    sorted_models.sort_by(|a, b| a.model_id.cmp(\u0026b.model_id));\n\n    let row_start = prev_threshold;\n    let row_end = row_threshold;\n\n    let mut current_height: f64 = 0.0;\n    let mut max_overlap: f64 = 0.0;\n    let mut best_color = sorted_models\n        .first()\n        .map(|m| m.color)\n        .unwrap_or(fallback_color);\n\n    for model in \u0026sorted_models {\n        let m_start = current_height;\n        let m_end = current_height + model.tokens as f64;\n        current_height += model.tokens as f64;\n\n        let overlap_start = m_start.max(row_start);\n        let overlap_end = m_end.min(row_end);\n        let overlap = (overlap_end - overlap_start).max(0.0);\n\n        if overlap \u003e max_overlap {\n            max_overlap = overlap;\n            best_color = model.color;\n        }\n    }\n\n    if total \u003e= row_threshold {\n        return (BLOCKS[8], best_color);\n    }\n\n    let ratio = if threshold_diff \u003e 0.0 {\n        (total - prev_threshold) / threshold_diff\n    } else {\n        1.0\n    };\n    let block_index = (ratio * 8.0).floor().clamp(1.0, 8.0) as usize;\n    (BLOCKS[block_index], best_color)\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":127},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","daily.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{\n    Block, Borders, Cell, Paragraph, Row, Scrollbar, ScrollbarOrientation, ScrollbarState, Table,\n};\n\nuse super::widgets::{format_cost, format_tokens};\nuse crate::tui::app::{App, SortDirection, SortField};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Daily Usage \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let visible_height = inner.height.saturating_sub(1) as usize;\n    app.max_visible_items = visible_height;\n\n    let daily = app.get_sorted_daily();\n    if daily.is_empty() {\n        let empty_msg = Paragraph::new(\"No daily usage data found. Press 'r' to refresh.\")\n            .style(Style::default().fg(app.theme.muted))\n            .alignment(Alignment::Center);\n        frame.render_widget(empty_msg, inner);\n        return;\n    }\n\n    let is_narrow = app.is_narrow();\n    let is_very_narrow = app.is_very_narrow();\n    let sort_field = app.sort_field;\n    let sort_direction = app.sort_direction;\n    let scroll_offset = app.scroll_offset;\n    let selected_index = app.selected_index;\n    let theme_accent = app.theme.accent;\n    let theme_selection = app.theme.selection;\n\n    let header_cells = if is_very_narrow {\n        vec![\"Date\", \"Cost\"]\n    } else if is_narrow {\n        vec![\"Date\", \"Tokens\", \"Cost\"]\n    } else {\n        vec![\n            \"Date\",\n            \"Input\",\n            \"Output\",\n            \"Cache Read\",\n            \"Cache Write\",\n            \"Total\",\n            \"Cost\",\n        ]\n    };\n\n    let sort_indicator = |field: SortField| -\u003e \u0026'static str {\n        if sort_field == field {\n            match sort_direction {\n                SortDirection::Ascending =\u003e \" â–²\",\n                SortDirection::Descending =\u003e \" â–¼\",\n            }\n        } else {\n            \"\"\n        }\n    };\n\n    let header = Row::new(\n        header_cells\n            .iter()\n            .enumerate()\n            .map(|(i, h)| {\n                let indicator = match (i, is_narrow, is_very_narrow) {\n                    (0, _, _) =\u003e sort_indicator(SortField::Date),\n                    (5, false, false) =\u003e sort_indicator(SortField::Tokens),\n                    (1, true, false) =\u003e sort_indicator(SortField::Tokens),\n                    (6, false, false) =\u003e sort_indicator(SortField::Cost),\n                    (2, true, false) =\u003e sort_indicator(SortField::Cost),\n                    (1, _, true) =\u003e sort_indicator(SortField::Cost),\n                    _ =\u003e \"\",\n                };\n                Cell::from(format!(\"{}{}\", h, indicator))\n            })\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n    )\n    .style(\n        Style::default()\n            .fg(theme_accent)\n            .add_modifier(Modifier::BOLD),\n    )\n    .height(1);\n\n    let daily_len = daily.len();\n    let start = scroll_offset.min(daily_len);\n    let end = (start + visible_height).min(daily_len);\n\n    if start \u003e= daily_len {\n        return;\n    }\n\n    let rows: Vec\u003cRow\u003e = daily[start..end]\n        .iter()\n        .enumerate()\n        .map(|(i, day)| {\n            let idx = i + start;\n            let is_selected = idx == selected_index;\n            let is_striped = idx % 2 == 1;\n\n            let cells: Vec\u003cCell\u003e = if is_very_narrow {\n                vec![\n                    Cell::from(day.date.format(\"%m/%d\").to_string()),\n                    Cell::from(format_cost(day.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else if is_narrow {\n                vec![\n                    Cell::from(day.date.format(\"%Y-%m-%d\").to_string()),\n                    Cell::from(format_tokens(day.tokens.total())),\n                    Cell::from(format_cost(day.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else {\n                vec![\n                    Cell::from(day.date.format(\"%Y-%m-%d\").to_string())\n                        .style(Style::default().add_modifier(Modifier::BOLD)),\n                    Cell::from(format_tokens(day.tokens.input))\n                        .style(Style::default().fg(Color::Rgb(100, 200, 100))),\n                    Cell::from(format_tokens(day.tokens.output))\n                        .style(Style::default().fg(Color::Rgb(200, 100, 100))),\n                    Cell::from(format_tokens(day.tokens.cache_read))\n                        .style(Style::default().fg(Color::Rgb(100, 150, 200))),\n                    Cell::from(format_tokens(day.tokens.cache_write))\n                        .style(Style::default().fg(Color::Rgb(200, 150, 100))),\n                    Cell::from(format_tokens(day.tokens.total())),\n                    Cell::from(format_cost(day.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            };\n\n            let row_style = if is_selected {\n                Style::default().bg(theme_selection)\n            } else if is_striped {\n                Style::default().bg(Color::Rgb(20, 24, 30))\n            } else {\n                Style::default()\n            };\n\n            Row::new(cells).style(row_style).height(1)\n        })\n        .collect();\n\n    let widths = if is_very_narrow {\n        vec![Constraint::Percentage(60), Constraint::Percentage(40)]\n    } else if is_narrow {\n        vec![\n            Constraint::Percentage(40),\n            Constraint::Percentage(30),\n            Constraint::Percentage(30),\n        ]\n    } else {\n        vec![\n            Constraint::Length(12),\n            Constraint::Length(10),\n            Constraint::Length(10),\n            Constraint::Length(12),\n            Constraint::Length(12),\n            Constraint::Length(10),\n            Constraint::Length(10),\n        ]\n    };\n\n    let table = Table::new(rows, widths)\n        .header(header)\n        .row_highlight_style(Style::default().bg(theme_selection));\n\n    frame.render_widget(table, inner);\n\n    if daily_len \u003e visible_height {\n        let scrollbar = Scrollbar::new(ScrollbarOrientation::VerticalRight)\n            .begin_symbol(Some(\"â–²\"))\n            .end_symbol(Some(\"â–¼\"));\n\n        let mut scrollbar_state = ScrollbarState::new(daily_len).position(scroll_offset);\n\n        frame.render_stateful_widget(\n            scrollbar,\n            area.inner(Margin {\n                horizontal: 0,\n                vertical: 1,\n            }),\n            \u0026mut scrollbar_state,\n        );\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":124},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","footer.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Paragraph};\n\nuse super::spinner::{get_phase_message, get_scanner_spans};\nuse super::widgets::{format_cost, format_tokens};\nuse crate::tui::app::{App, ClickAction, SortField, Tab};\nuse crate::tui::data::Source;\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    // Split into 3 rows: sources+sort, help text, status\n    let row_constraints = if inner.height \u003e= 3 {\n        vec![\n            Constraint::Length(1),\n            Constraint::Length(1),\n            Constraint::Length(1),\n        ]\n    } else if inner.height \u003e= 2 {\n        vec![Constraint::Length(1), Constraint::Length(1)]\n    } else {\n        vec![Constraint::Length(1)]\n    };\n\n    let rows = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints(row_constraints)\n        .split(inner);\n\n    render_main_row(frame, app, rows[0]);\n\n    if rows.len() \u003e= 2 {\n        render_help_row(frame, app, rows[1]);\n    }\n\n    if rows.len() \u003e= 3 {\n        render_status_row(frame, app, rows[2]);\n    }\n}\n\nfn render_main_row(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n\n    // Split into left (sources) and right (sort + totals)\n    let chunks = Layout::default()\n        .direction(Direction::Horizontal)\n        .constraints([Constraint::Percentage(55), Constraint::Percentage(45)])\n        .split(area);\n\n    // Left side: source badges\n    render_source_badges(frame, app, chunks[0]);\n\n    // Right side: scroll info | tokens | cost (models)\n    let mut right_spans: Vec\u003cSpan\u003e = Vec::new();\n\n    // Scroll position indicator for Overview tab\n    if app.current_tab == Tab::Overview {\n        let total_models = app.data.models.len();\n        if total_models \u003e app.max_visible_items \u0026\u0026 app.max_visible_items \u003e 0 {\n            let start = app.scroll_offset + 1;\n            let end = (app.scroll_offset + app.max_visible_items).min(total_models);\n            if !is_very_narrow {\n                right_spans.push(Span::styled(\n                    format!(\"â†“ {}-{} of {} \", start, end, total_models),\n                    Style::default().fg(app.theme.muted),\n                ));\n                right_spans.push(Span::styled(\"| \", Style::default().fg(app.theme.muted)));\n            }\n        }\n    }\n\n    // Total tokens\n    let total_tokens = app.data.total_tokens;\n    right_spans.push(Span::styled(\n        format_tokens(total_tokens),\n        Style::default().fg(Color::Cyan),\n    ));\n    if !is_very_narrow {\n        right_spans.push(Span::styled(\n            \" tokens\",\n            Style::default().fg(app.theme.muted),\n        ));\n    }\n\n    right_spans.push(Span::styled(\" | \", Style::default().fg(app.theme.muted)));\n\n    // Total cost\n    right_spans.push(Span::styled(\n        format_cost(app.data.total_cost),\n        Style::default()\n            .fg(Color::Green)\n            .add_modifier(Modifier::BOLD),\n    ));\n\n    // Model count\n    if !is_very_narrow {\n        right_spans.push(Span::styled(\n            format!(\" ({} models)\", app.data.models.len()),\n            Style::default().fg(app.theme.muted),\n        ));\n    }\n\n    let right_line = Line::from(right_spans);\n    let right_para = Paragraph::new(right_line).alignment(Alignment::Right);\n    frame.render_widget(right_para, chunks[1]);\n}\n\nfn render_source_badges(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let mut spans: Vec\u003cSpan\u003e = Vec::new();\n    let mut x_offset = area.x;\n    let is_very_narrow = app.is_very_narrow();\n\n    let source_labels = [\n        (Source::OpenCode, \"1\", \"OC\"),\n        (Source::Claude, \"2\", \"CC\"),\n        (Source::Codex, \"3\", \"CX\"),\n        (Source::Cursor, \"4\", \"CR\"),\n        (Source::Gemini, \"5\", \"GM\"),\n        (Source::Amp, \"6\", \"AM\"),\n        (Source::Droid, \"7\", \"DR\"),\n        (Source::OpenClaw, \"8\", \"CL\"),\n        (Source::Pi, \"9\", \"PI\"),\n    ];\n\n    for (source, key, short) in source_labels {\n        let enabled = app.enabled_sources.contains(\u0026source);\n        let indicator = if enabled { \"â—\" } else { \"â—‹\" };\n\n        let badge_text = if is_very_narrow {\n            format!(\"[{}{}]\", indicator, key)\n        } else {\n            format!(\"[{}{}:{}]\", indicator, key, short)\n        };\n        let badge_width = badge_text.chars().count() as u16;\n\n        let style = if enabled {\n            Style::default().fg(Color::Green)\n        } else {\n            Style::default().fg(app.theme.muted)\n        };\n\n        spans.push(Span::styled(badge_text, style));\n        spans.push(Span::raw(\" \"));\n\n        app.add_click_area(\n            Rect::new(x_offset, area.y, badge_width, 1),\n            ClickAction::Source(source),\n        );\n        x_offset += badge_width + 1;\n    }\n\n    // Sort buttons (if not very narrow)\n    if !is_very_narrow {\n        spans.push(Span::styled(\"| \", Style::default().fg(app.theme.muted)));\n\n        let sort_buttons = [\n            (SortField::Date, \"Date\"),\n            (SortField::Cost, \"Cost\"),\n            (SortField::Tokens, \"Tok\"),\n        ];\n\n        for (field, label) in sort_buttons {\n            let is_active = app.sort_field == field;\n            let style = if is_active {\n                Style::default()\n                    .fg(app.theme.foreground)\n                    .add_modifier(Modifier::BOLD)\n            } else {\n                Style::default().fg(app.theme.muted)\n            };\n\n            spans.push(Span::styled(label, style));\n            spans.push(Span::raw(\" \"));\n\n            let btn_width = label.len() as u16;\n            app.add_click_area(\n                Rect::new(x_offset + 2, area.y, btn_width, 1),\n                ClickAction::Sort(field),\n            );\n            x_offset += btn_width + 1;\n        }\n    }\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line);\n    frame.render_widget(paragraph, area);\n}\n\nfn render_help_row(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n\n    let spans = if is_very_narrow {\n        vec![\n            Span::styled(\"â†‘â†“\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"â†â†’\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"y\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"[p]\", Style::default().fg(Color::Magenta)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"[r]\", Style::default().fg(Color::Yellow)),\n            Span::styled(\"Â·\", Style::default().fg(app.theme.muted)),\n            Span::styled(\"q\", Style::default().fg(app.theme.muted)),\n        ]\n    } else {\n        vec![\n            Span::styled(\n                \"â†‘â†“ scroll â€¢ â†â†’/tab view â€¢ y copy â€¢ \",\n                Style::default().fg(app.theme.muted),\n            ),\n            Span::styled(\n                format!(\"[p:{}]\", app.theme.name.as_str()),\n                Style::default().fg(Color::Magenta),\n            ),\n            Span::styled(\" \", Style::default()),\n            Span::styled(\n                if app.auto_refresh {\n                    format!(\"[R:auto {}s]\", app.auto_refresh_interval.as_secs())\n                } else {\n                    \"[R:auto off]\".to_string()\n                },\n                Style::default().fg(if app.auto_refresh {\n                    Color::Green\n                } else {\n                    app.theme.muted\n                }),\n            ),\n            Span::styled(\" [-/+ interval] â€¢ \", Style::default().fg(app.theme.muted)),\n            Span::styled(\"[r:refresh]\", Style::default().fg(Color::Yellow)),\n            Span::styled(\" â€¢ e export â€¢ q quit\", Style::default().fg(app.theme.muted)),\n        ]\n    };\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line);\n    frame.render_widget(paragraph, area);\n}\n\nfn render_status_row(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let mut spans: Vec\u003cSpan\u003e = Vec::new();\n\n    if app.data.loading || app.background_loading {\n        let scanner_spans = get_scanner_spans(app.spinner_frame);\n        spans.extend(scanner_spans);\n        spans.push(Span::raw(\" \"));\n        spans.push(Span::styled(\n            get_phase_message(\"parsing-sources\"),\n            Style::default().fg(app.theme.muted),\n        ));\n    } else if let Some(ref msg) = app.status_message {\n        spans.push(Span::styled(\n            msg.clone(),\n            Style::default()\n                .fg(Color::Green)\n                .add_modifier(Modifier::BOLD),\n        ));\n    } else {\n        let elapsed = app.last_refresh.elapsed();\n        let ago = if elapsed.as_secs() \u003c 60 {\n            format!(\"{}s ago\", elapsed.as_secs())\n        } else if elapsed.as_secs() \u003c 3600 {\n            format!(\"{}m ago\", elapsed.as_secs() / 60)\n        } else {\n            format!(\"{}h ago\", elapsed.as_secs() / 3600)\n        };\n        spans.push(Span::styled(\n            format!(\"Last updated: {}\", ago),\n            Style::default().fg(app.theme.muted),\n        ));\n\n        if app.auto_refresh {\n            spans.push(Span::styled(\n                format!(\" â€¢ Auto: {}s\", app.auto_refresh_interval.as_secs()),\n                Style::default().fg(app.theme.muted),\n            ));\n        }\n    }\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line);\n    frame.render_widget(paragraph, area);\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":182},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","header.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Tabs};\n\nuse crate::tui::app::{App, ClickAction, Tab};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n\n    let titles: Vec\u003cLine\u003e = Tab::all()\n        .iter()\n        .map(|t| {\n            let name = if is_very_narrow {\n                t.short_name()\n            } else {\n                t.as_str()\n            };\n            let style = if *t == app.current_tab {\n                Style::default()\n                    .fg(app.theme.accent)\n                    .add_modifier(Modifier::BOLD)\n            } else {\n                Style::default().fg(app.theme.muted)\n            };\n            Line::from(Span::styled(name, style))\n        })\n        .collect();\n\n    let selected = Tab::all()\n        .iter()\n        .position(|t| *t == app.current_tab)\n        .unwrap_or(0);\n\n    let is_narrow = app.is_narrow();\n\n    let mut block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" tokscale \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .title_alignment(Alignment::Left)\n        .style(Style::default().bg(app.theme.background));\n\n    if !is_narrow {\n        block = block.title_top(\n            Line::from(vec![\n                Span::styled(\" | \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\"GitHub \", Style::default().fg(Color::Rgb(102, 102, 102))),\n            ])\n            .right_aligned(),\n        );\n    }\n\n    let tabs = Tabs::new(titles)\n        .block(block)\n        .select(selected)\n        .highlight_style(\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        )\n        .divider(Span::styled(\" â”‚ \", Style::default().fg(app.theme.border)));\n\n    frame.render_widget(tabs, area);\n\n    register_tab_click_areas(app, area);\n}\n\nfn register_tab_click_areas(app: \u0026mut App, area: Rect) {\n    let is_very_narrow = app.is_very_narrow();\n    let inner_x = area.x + 12;\n    let y = area.y + 1;\n    let mut x = inner_x;\n\n    for tab in Tab::all() {\n        let name_len = if is_very_narrow {\n            tab.short_name().len()\n        } else {\n            tab.as_str().len()\n        };\n        let width = name_len as u16 + 3;\n        app.add_click_area(Rect::new(x, y, width, 1), ClickAction::Tab(*tab));\n        x += width;\n    }\n}\n","traces":[{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":52},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","mod.rs"],"content":"mod bar_chart;\nmod daily;\nmod footer;\nmod header;\nmod models;\nmod overview;\npub mod spinner;\nmod stats;\nmod widgets;\n\nuse ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Paragraph};\n\nuse crate::tui::app::{App, Tab};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App) {\n    let area = frame.area();\n    if area.width == 0 || area.height == 0 {\n        return;\n    }\n\n    app.clear_click_areas();\n    app.handle_resize(area.width, area.height);\n\n    let chunks = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Length(3),\n            Constraint::Min(0),\n            Constraint::Length(5),\n        ])\n        .split(area);\n\n    header::render(frame, app, chunks[0]);\n\n    if app.data.loading \u0026\u0026 !app.background_loading {\n        render_loading(frame, app, chunks[1]);\n    } else if let Some(ref error) = app.data.error {\n        render_error(frame, app, chunks[1], error);\n    } else {\n        match app.current_tab {\n            Tab::Overview =\u003e overview::render(frame, app, chunks[1]),\n            Tab::Models =\u003e models::render(frame, app, chunks[1]),\n            Tab::Daily =\u003e daily::render(frame, app, chunks[1]),\n            Tab::Stats =\u003e stats::render(frame, app, chunks[1]),\n        }\n    }\n\n    footer::render(frame, app, chunks[2]);\n}\n\nfn render_loading(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let center = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Percentage(40),\n            Constraint::Length(3),\n            Constraint::Percentage(40),\n        ])\n        .split(inner)[1];\n\n    let mut spans = spinner::get_scanner_spans(app.spinner_frame);\n    spans.push(Span::raw(\"  \"));\n    spans.push(Span::styled(\n        spinner::get_phase_message(\"parsing-sources\"),\n        Style::default().fg(app.theme.muted),\n    ));\n\n    let line = Line::from(spans);\n    let paragraph = Paragraph::new(line).alignment(Alignment::Center);\n\n    frame.render_widget(paragraph, center);\n}\n\nfn render_error(frame: \u0026mut Frame, app: \u0026App, area: Rect, error: \u0026str) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let center = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Percentage(40),\n            Constraint::Length(3),\n            Constraint::Percentage(40),\n        ])\n        .split(inner)[1];\n\n    let text = format!(\"Error: {}\", error);\n    let paragraph = Paragraph::new(text)\n        .style(Style::default().fg(Color::Red))\n        .alignment(Alignment::Center);\n\n    frame.render_widget(paragraph, center);\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":65},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","models.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{\n    Block, Borders, Cell, Paragraph, Row, Scrollbar, ScrollbarOrientation, ScrollbarState, Table,\n};\n\nuse super::widgets::{\n    format_cost, format_tokens, get_model_color, get_provider_display_name, get_source_display_name,\n};\nuse crate::tui::app::{App, SortDirection, SortField};\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Models \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let visible_height = inner.height.saturating_sub(1) as usize;\n    app.max_visible_items = visible_height;\n\n    let is_narrow = app.is_narrow();\n    let is_very_narrow = app.is_very_narrow();\n    let sort_field = app.sort_field;\n    let sort_direction = app.sort_direction;\n    let scroll_offset = app.scroll_offset;\n    let selected_index = app.selected_index;\n    let theme_accent = app.theme.accent;\n    let theme_muted = app.theme.muted;\n    let theme_selection = app.theme.selection;\n\n    let models = app.get_sorted_models();\n    if models.is_empty() {\n        let empty_msg =\n            Paragraph::new(\"No usage data found. Press 'r' to refresh or toggle sources with 1-8.\")\n                .style(Style::default().fg(theme_muted))\n                .alignment(Alignment::Center);\n        frame.render_widget(empty_msg, inner);\n        return;\n    }\n\n    let header_cells = if is_very_narrow {\n        vec![\"Model\", \"Cost\"]\n    } else if is_narrow {\n        vec![\"Model\", \"Tokens\", \"Cost\"]\n    } else {\n        vec![\n            \"#\",\n            \"Model\",\n            \"Provider\",\n            \"Source\",\n            \"Input\",\n            \"Output\",\n            \"Cache Read\",\n            \"Cache Write\",\n            \"Total\",\n            \"Cost\",\n        ]\n    };\n\n    let sort_indicator = |field: SortField| -\u003e \u0026'static str {\n        if sort_field == field {\n            match sort_direction {\n                SortDirection::Ascending =\u003e \" â–²\",\n                SortDirection::Descending =\u003e \" â–¼\",\n            }\n        } else {\n            \"\"\n        }\n    };\n\n    let header = Row::new(\n        header_cells\n            .iter()\n            .enumerate()\n            .map(|(i, h)| {\n                let indicator = match i {\n                    8 if !is_narrow =\u003e sort_indicator(SortField::Tokens),\n                    9 if !is_narrow =\u003e sort_indicator(SortField::Cost),\n                    1 if is_very_narrow =\u003e sort_indicator(SortField::Cost),\n                    2 if is_narrow \u0026\u0026 !is_very_narrow =\u003e sort_indicator(SortField::Cost),\n                    1 if is_narrow \u0026\u0026 !is_very_narrow =\u003e sort_indicator(SortField::Tokens),\n                    _ =\u003e \"\",\n                };\n                Cell::from(format!(\"{}{}\", h, indicator))\n            })\n            .collect::\u003cVec\u003c_\u003e\u003e(),\n    )\n    .style(\n        Style::default()\n            .fg(theme_accent)\n            .add_modifier(Modifier::BOLD),\n    )\n    .height(1);\n\n    let models_len = models.len();\n    let start = scroll_offset.min(models_len.saturating_sub(1));\n    let end = (start + visible_height).min(models_len);\n\n    if start \u003e= models_len {\n        return;\n    }\n\n    let rows: Vec\u003cRow\u003e = models[start..end]\n        .iter()\n        .enumerate()\n        .map(|(i, model)| {\n            let idx = i + start;\n            let is_selected = idx == selected_index;\n            let is_striped = idx % 2 == 1;\n\n            let model_color = get_model_color(\u0026model.model);\n\n            let cells: Vec\u003cCell\u003e = if is_very_narrow {\n                vec![\n                    Cell::from(truncate(\u0026model.model, 15)).style(Style::default().fg(model_color)),\n                    Cell::from(format_cost(model.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else if is_narrow {\n                vec![\n                    Cell::from(truncate(\u0026model.model, 25)).style(Style::default().fg(model_color)),\n                    Cell::from(format_tokens(model.tokens.total())),\n                    Cell::from(format_cost(model.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            } else {\n                vec![\n                    Cell::from(format!(\"{}\", idx + 1)).style(Style::default().fg(theme_muted)),\n                    Cell::from(truncate(\u0026model.model, 30)).style(\n                        Style::default()\n                            .fg(model_color)\n                            .add_modifier(Modifier::BOLD),\n                    ),\n                    Cell::from(get_provider_display_name(\u0026model.provider)),\n                    Cell::from(get_source_display_name(\u0026model.source))\n                        .style(Style::default().fg(theme_muted)),\n                    Cell::from(format_tokens(model.tokens.input))\n                        .style(Style::default().fg(Color::Rgb(100, 200, 100))),\n                    Cell::from(format_tokens(model.tokens.output))\n                        .style(Style::default().fg(Color::Rgb(200, 100, 100))),\n                    Cell::from(format_tokens(model.tokens.cache_read))\n                        .style(Style::default().fg(Color::Rgb(100, 150, 200))),\n                    Cell::from(format_tokens(model.tokens.cache_write))\n                        .style(Style::default().fg(Color::Rgb(200, 150, 100))),\n                    Cell::from(format_tokens(model.tokens.total())),\n                    Cell::from(format_cost(model.cost)).style(Style::default().fg(Color::Green)),\n                ]\n            };\n\n            let row_style = if is_selected {\n                Style::default().bg(theme_selection)\n            } else if is_striped {\n                Style::default().bg(Color::Rgb(20, 24, 30))\n            } else {\n                Style::default()\n            };\n\n            Row::new(cells).style(row_style).height(1)\n        })\n        .collect();\n\n    let widths = if is_very_narrow {\n        vec![Constraint::Percentage(70), Constraint::Percentage(30)]\n    } else if is_narrow {\n        vec![\n            Constraint::Percentage(50),\n            Constraint::Percentage(25),\n            Constraint::Percentage(25),\n        ]\n    } else {\n        vec![\n            Constraint::Length(3),\n            Constraint::Min(20),\n            Constraint::Length(18),\n            Constraint::Length(14),\n            Constraint::Length(10),\n            Constraint::Length(10),\n            Constraint::Length(12),\n            Constraint::Length(12),\n            Constraint::Length(10),\n            Constraint::Length(10),\n        ]\n    };\n\n    let table = Table::new(rows, widths)\n        .header(header)\n        .row_highlight_style(Style::default().bg(theme_selection));\n\n    frame.render_widget(table, inner);\n\n    if models_len \u003e visible_height {\n        let scrollbar = Scrollbar::new(ScrollbarOrientation::VerticalRight)\n            .begin_symbol(Some(\"â–²\"))\n            .end_symbol(Some(\"â–¼\"));\n\n        let mut scrollbar_state = ScrollbarState::new(models_len).position(scroll_offset);\n\n        frame.render_stateful_widget(\n            scrollbar,\n            area.inner(Margin {\n                horizontal: 0,\n                vertical: 1,\n            }),\n            \u0026mut scrollbar_state,\n        );\n    }\n}\n\nfn truncate(s: \u0026str, max_chars: usize) -\u003e String {\n    if max_chars == 0 {\n        return String::new();\n    }\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        s.to_string()\n    } else if max_chars \u003c= 3 {\n        s.chars().take(max_chars).collect()\n    } else {\n        let head: String = s.chars().take(max_chars - 3).collect();\n        format!(\"{}...\", head)\n    }\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":145},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","overview.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{\n    Block, Borders, Paragraph, Scrollbar, ScrollbarOrientation, ScrollbarState,\n};\n\nuse super::bar_chart::{render_stacked_bar_chart, ModelSegment, StackedBarData};\nuse super::widgets::{format_tokens, get_model_color};\nuse crate::tui::app::App;\n\nstruct ModelRowData {\n    model: String,\n    tokens_input: u64,\n    tokens_output: u64,\n    tokens_cache_read: u64,\n    tokens_cache_write: u64,\n    cost: f64,\n}\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let safe_height = area.height.max(12) as usize;\n    let chart_height = (safe_height as f64 * 0.35).floor().max(5.0) as u16;\n    let legend_height = 1u16;\n\n    let chunks = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([\n            Constraint::Length(chart_height),\n            Constraint::Length(legend_height),\n            Constraint::Min(0),\n        ])\n        .split(area);\n\n    let list_area_height = chunks[2].height.saturating_sub(2);\n    let items_per_page = ((list_area_height / 2) as usize).max(1);\n    app.max_visible_items = items_per_page;\n\n    render_chart(frame, app, chunks[0]);\n    render_legend(frame, app, chunks[1]);\n    render_top_models(frame, app, chunks[2], items_per_page);\n}\n\nfn render_chart(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let daily = \u0026app.data.daily;\n    let mut sorted_daily: Vec\u003c_\u003e = daily.iter().collect();\n    sorted_daily.sort_by(|a, b| a.date.cmp(\u0026b.date));\n\n    let data: Vec\u003cStackedBarData\u003e = sorted_daily\n        .iter()\n        .rev()\n        .take(60)\n        .rev()\n        .map(|d| {\n            let date = d.date.format(\"%m/%d\").to_string();\n            let total = d.tokens.total();\n\n            let models: Vec\u003cModelSegment\u003e = d\n                .models\n                .iter()\n                .map(|(model_name, info)| ModelSegment {\n                    model_id: model_name.clone(),\n                    tokens: info.tokens.total(),\n                    color: get_model_color(model_name),\n                })\n                .collect();\n\n            StackedBarData {\n                date,\n                models,\n                total,\n            }\n        })\n        .collect();\n\n    render_stacked_bar_chart(frame, app, area, \u0026data);\n}\n\nfn render_legend(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let legend_limit = if app.is_narrow() { 3 } else { 5 };\n    let max_name_width = if app.is_narrow() { 12 } else { 18 };\n    let muted_color = app.theme.muted;\n\n    let top_models: Vec\u003c(String, Color)\u003e = app\n        .get_sorted_models()\n        .iter()\n        .take(legend_limit)\n        .map(|m| (m.model.clone(), get_model_color(\u0026m.model)))\n        .collect();\n\n    if top_models.is_empty() {\n        return;\n    }\n\n    let mut spans: Vec\u003cSpan\u003e = Vec::new();\n    for (i, (model_name, color)) in top_models.iter().enumerate() {\n        let name = truncate_string(model_name, max_name_width);\n\n        spans.push(Span::styled(\"â—\", Style::default().fg(*color)));\n        spans.push(Span::raw(format!(\" {}\", name)));\n\n        if i \u003c top_models.len() - 1 {\n            spans.push(Span::styled(\"  Â·\", Style::default().fg(muted_color)));\n        }\n    }\n\n    let legend_line = Line::from(spans);\n    let paragraph = Paragraph::new(legend_line);\n    frame.render_widget(paragraph, area);\n}\n\nfn render_top_models(frame: \u0026mut Frame, app: \u0026mut App, area: Rect, items_per_page: usize) {\n    use super::widgets::format_cost;\n    use crate::tui::app::SortField;\n\n    let theme_border = app.theme.border;\n    let theme_accent = app.theme.accent;\n    let theme_background = app.theme.background;\n    let theme_muted = app.theme.muted;\n    let theme_foreground = app.theme.foreground;\n    let theme_selection = app.theme.selection;\n    let scroll_offset = app.scroll_offset;\n    let selected_index = app.selected_index;\n    let is_narrow = app.is_narrow();\n    let is_very_narrow = app.is_very_narrow();\n    let sort_field = app.sort_field;\n    let total_cost = app.data.total_cost;\n\n    let models_data: Vec\u003cModelRowData\u003e = app\n        .get_sorted_models()\n        .iter()\n        .map(|m| ModelRowData {\n            model: m.model.clone(),\n            tokens_input: m.tokens.input,\n            tokens_output: m.tokens.output,\n            tokens_cache_read: m.tokens.cache_read,\n            tokens_cache_write: m.tokens.cache_write,\n            cost: m.cost,\n        })\n        .collect();\n\n    let title = if is_very_narrow {\n        \"Top Models\".to_string()\n    } else {\n        match sort_field {\n            SortField::Tokens =\u003e \"Models by Tokens\".to_string(),\n            _ =\u003e \"Models by Cost\".to_string(),\n        }\n    };\n\n    let title_right = if is_very_narrow {\n        format_cost(total_cost)\n    } else {\n        format!(\"Total: {}\", format_cost(total_cost))\n    };\n\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(theme_border))\n        .title(Span::styled(\n            format!(\" {} \", title),\n            Style::default()\n                .fg(theme_accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .title_top(\n            Line::from(Span::styled(\n                format!(\" {} \", title_right),\n                Style::default().fg(Color::Green),\n            ))\n            .right_aligned(),\n        )\n        .style(Style::default().bg(theme_background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    if models_data.is_empty() {\n        let empty = Paragraph::new(\"No data available\")\n            .style(Style::default().fg(theme_muted))\n            .alignment(Alignment::Center);\n        frame.render_widget(empty, inner);\n        return;\n    }\n\n    let total = models_data\n        .iter()\n        .map(|m| if m.cost.is_finite() { m.cost } else { 0.0 })\n        .sum::\u003cf64\u003e()\n        .max(0.01);\n    let models_len = models_data.len();\n    let start = scroll_offset.min(models_len);\n    let end = (start + items_per_page).min(models_len);\n    let max_name_width = if is_narrow { 20 } else { 35 };\n\n    if start \u003e= models_len {\n        return;\n    }\n\n    let mut y = inner.y;\n    for (i, model) in models_data[start..end].iter().enumerate() {\n        if y + 1 \u003e= inner.y + inner.height {\n            break;\n        }\n\n        let idx = i + start;\n        let is_selected = idx == selected_index;\n        let row_style = if is_selected {\n            Style::default().bg(theme_selection).fg(theme_foreground)\n        } else {\n            Style::default()\n        };\n\n        let model_color = get_model_color(\u0026model.model);\n        let name = truncate_string(\u0026model.model, max_name_width);\n        let percentage = if model.cost.is_finite() \u0026\u0026 total.is_finite() \u0026\u0026 total \u003e 0.0 {\n            (model.cost / total) * 100.0\n        } else {\n            0.0\n        };\n\n        let line1_area = Rect::new(inner.x, y, inner.width, 1);\n        frame.render_widget(Paragraph::new(\"\").style(row_style), line1_area);\n\n        let line1_spans = vec![\n            Span::styled(\"â—\", Style::default().fg(model_color)),\n            Span::styled(\n                format!(\" {}\", name),\n                Style::default()\n                    .fg(if is_selected {\n                        theme_foreground\n                    } else {\n                        model_color\n                    })\n                    .add_modifier(Modifier::BOLD),\n            ),\n            Span::styled(\n                format!(\" ({:.1}%)\", percentage),\n                Style::default().fg(theme_muted),\n            ),\n        ];\n        let line1 = Line::from(line1_spans);\n        let line1_para = Paragraph::new(line1).style(row_style);\n        frame.render_widget(line1_para, line1_area);\n\n        y += 1;\n        if y \u003e= inner.y + inner.height {\n            break;\n        }\n\n        let line2_area = Rect::new(inner.x, y, inner.width, 1);\n        frame.render_widget(Paragraph::new(\"\").style(row_style), line2_area);\n\n        let line2_spans = if is_narrow {\n            vec![\n                Span::raw(\"  \"),\n                Span::styled(\n                    format_tokens(model.tokens_input),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_output),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_read),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_write),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n            ]\n        } else {\n            vec![\n                Span::styled(\"  In: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_input),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\" Â· Out: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_output),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\" Â· CR: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_read),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n                Span::styled(\" Â· CW: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                Span::styled(\n                    format_tokens(model.tokens_cache_write),\n                    Style::default().fg(Color::Rgb(170, 170, 170)),\n                ),\n            ]\n        };\n\n        let line2 = Line::from(line2_spans);\n        let line2_para = Paragraph::new(line2).style(row_style);\n        frame.render_widget(line2_para, line2_area);\n\n        y += 1;\n    }\n\n    if models_len \u003e items_per_page {\n        let scrollbar = Scrollbar::new(ScrollbarOrientation::VerticalRight)\n            .begin_symbol(Some(\"â–²\"))\n            .end_symbol(Some(\"â–¼\"))\n            .track_symbol(Some(\"â”‚\"))\n            .thumb_symbol(\"â–ˆ\");\n\n        let mut scrollbar_state = ScrollbarState::new(models_len).position(scroll_offset);\n\n        frame.render_stateful_widget(\n            scrollbar,\n            inner.inner(Margin {\n                horizontal: 0,\n                vertical: 0,\n            }),\n            \u0026mut scrollbar_state,\n        );\n    }\n}\n\nfn truncate_string(s: \u0026str, max_chars: usize) -\u003e String {\n    if max_chars == 0 {\n        return String::new();\n    }\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        s.to_string()\n    } else if max_chars == 1 {\n        \"â€¦\".to_string()\n    } else {\n        let head: String = s.chars().take(max_chars - 1).collect();\n        format!(\"{}â€¦\", head)\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":212},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","spinner.rs"],"content":"use ratatui::prelude::*;\n\nconst WIDTH: usize = 8;\nconst HOLD_START: usize = 30;\nconst HOLD_END: usize = 9;\nconst TRAIL_LENGTH: usize = 4;\n\nconst TRAIL_COLORS: \u0026[Color] = \u0026[\n    Color::Rgb(0, 255, 255), // #00FFFF - cyan\n    Color::Rgb(0, 215, 215), // #00D7D7\n    Color::Rgb(0, 175, 175), // #00AFAF\n    Color::Rgb(0, 135, 135), // #008787\n];\nconst INACTIVE_COLOR: Color = Color::Rgb(68, 68, 68);\n\npub struct ScannerState {\n    pub position: usize,\n    pub forward: bool,\n}\n\npub fn get_scanner_state(frame: usize) -\u003e ScannerState {\n    let forward_frames = WIDTH;\n    let backward_frames = WIDTH - 1;\n    let total_cycle = forward_frames + HOLD_END + backward_frames + HOLD_START;\n    let normalized = frame % total_cycle;\n\n    if normalized \u003c forward_frames {\n        ScannerState {\n            position: normalized,\n            forward: true,\n        }\n    } else if normalized \u003c forward_frames + HOLD_END {\n        ScannerState {\n            position: WIDTH - 1,\n            forward: true,\n        }\n    } else if normalized \u003c forward_frames + HOLD_END + backward_frames {\n        ScannerState {\n            position: WIDTH - 2 - (normalized - forward_frames - HOLD_END),\n            forward: false,\n        }\n    } else {\n        ScannerState {\n            position: 0,\n            forward: false,\n        }\n    }\n}\n\npub fn get_scanner_spans(frame: usize) -\u003e Vec\u003cSpan\u003c'static\u003e\u003e {\n    let state = get_scanner_state(frame);\n    let mut spans = Vec::with_capacity(WIDTH);\n\n    for i in 0..WIDTH {\n        let distance = if state.forward {\n            if state.position \u003e= i {\n                state.position - i\n            } else {\n                usize::MAX\n            }\n        } else if i \u003e= state.position {\n            i - state.position\n        } else {\n            usize::MAX\n        };\n\n        let (ch, color) = if distance \u003c TRAIL_LENGTH {\n            ('â– ', TRAIL_COLORS[distance])\n        } else {\n            ('â¬', INACTIVE_COLOR)\n        };\n\n        spans.push(Span::styled(ch.to_string(), Style::default().fg(color)));\n    }\n\n    spans\n}\n\npub fn get_phase_message(phase: \u0026str) -\u003e \u0026'static str {\n    match phase {\n        \"idle\" =\u003e \"Initializing...\",\n        \"parsing-sources\" =\u003e \"Scanning session data...\",\n        \"loading-pricing\" =\u003e \"Loading pricing data...\",\n        \"finalizing-report\" =\u003e \"Finalizing report...\",\n        \"complete\" =\u003e \"Complete\",\n        _ =\u003e \"Loading data...\",\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","stats.rs"],"content":"use ratatui::prelude::*;\nuse ratatui::widgets::{Block, Borders, Paragraph};\n\nuse super::widgets::{\n    format_cost, format_tokens, get_model_color, get_source_color, get_source_display_name,\n};\nuse crate::tui::app::{App, ClickAction};\n\nconst CELL_WIDTH: u16 = 2;\nconst MONTH_LABELS: \u0026[\u0026str] = \u0026[\n    \"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\",\n];\nconst DAY_LABELS: \u0026[\u0026str] = \u0026[\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n\npub fn render(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let chunks = Layout::default()\n        .direction(Direction::Vertical)\n        .constraints([Constraint::Min(12), Constraint::Length(12)])\n        .split(area);\n\n    render_graph(frame, app, chunks[0]);\n\n    if app.selected_graph_cell.is_some() {\n        render_breakdown_panel(frame, app, chunks[1]);\n    } else {\n        render_stats_panel(frame, app, chunks[1]);\n    }\n}\n\nfn render_graph(frame: \u0026mut Frame, app: \u0026mut App, area: Rect) {\n    let theme_border = app.theme.border;\n    let theme_accent = app.theme.accent;\n    let theme_background = app.theme.background;\n    let theme_muted = app.theme.muted;\n    let theme_colors = app.theme.colors;\n    let selected_cell = app.selected_graph_cell;\n    let is_narrow = app.is_narrow();\n\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(theme_border))\n        .title(Span::styled(\n            \" Contribution Graph (52 weeks) \",\n            Style::default()\n                .fg(theme_accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(theme_background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let graph = match \u0026app.data.graph {\n        Some(g) =\u003e g.clone(),\n        None =\u003e return,\n    };\n\n    let label_width = if is_narrow { 2u16 } else { 4u16 };\n    let graph_start_x = inner.x + label_width;\n    let graph_start_y = inner.y + 2;\n\n    for (day_idx, label) in DAY_LABELS.iter().enumerate() {\n        if day_idx % 2 == 1 {\n            let y = graph_start_y + day_idx as u16;\n            if y \u003c inner.y + inner.height {\n                let display_label = if is_narrow { \"\" } else { *label };\n                let text = Paragraph::new(display_label).style(Style::default().fg(theme_muted));\n                frame.render_widget(text, Rect::new(inner.x, y, label_width, 1));\n            }\n        }\n    }\n\n    let max_weeks = (inner.width.saturating_sub(label_width) / CELL_WIDTH) as usize;\n    let weeks_to_show = graph.weeks.len().min(max_weeks);\n    let start_week = graph.weeks.len().saturating_sub(weeks_to_show);\n\n    let intensity_color = |intensity: f64| -\u003e Color {\n        let safe_intensity = if intensity.is_finite() {\n            intensity.clamp(0.0, 1.0)\n        } else {\n            0.0\n        };\n        let idx = match safe_intensity {\n            x if x \u003c= 0.0 =\u003e 0,\n            x if x \u003c 0.25 =\u003e 1,\n            x if x \u003c 0.50 =\u003e 2,\n            x if x \u003c 0.75 =\u003e 3,\n            _ =\u003e 4,\n        };\n        theme_colors[idx]\n    };\n\n    let mut click_areas_to_add: Vec\u003c(Rect, usize, usize)\u003e = Vec::new();\n\n    for (week_idx, week) in graph.weeks.iter().skip(start_week).enumerate() {\n        let x = graph_start_x + (week_idx as u16 * CELL_WIDTH);\n\n        for (day_idx, day_opt) in week.iter().enumerate() {\n            let y = graph_start_y + day_idx as u16;\n\n            if x \u003e= inner.x + inner.width || y \u003e= inner.y + inner.height {\n                continue;\n            }\n\n            let actual_week_idx = week_idx + start_week;\n            let is_selected = selected_cell == Some((actual_week_idx, day_idx));\n\n            let (cell_str, style) = match day_opt {\n                Some(day) =\u003e {\n                    let color = intensity_color(day.intensity);\n                    if is_selected {\n                        (\"â–“â–“\", Style::default().fg(Color::White).bg(color))\n                    } else {\n                        (\"â–ˆâ–ˆ\", Style::default().fg(color))\n                    }\n                }\n                None =\u003e {\n                    if is_selected {\n                        (\"â–“â–“\", Style::default().fg(Color::White).bg(theme_colors[0]))\n                    } else {\n                        (\"Â· \", Style::default().fg(Color::Rgb(102, 102, 102)))\n                    }\n                }\n            };\n\n            let cell = Paragraph::new(cell_str).style(style);\n            frame.render_widget(cell, Rect::new(x, y, CELL_WIDTH, 1));\n\n            click_areas_to_add.push((Rect::new(x, y, CELL_WIDTH, 1), actual_week_idx, day_idx));\n        }\n    }\n\n    for (rect, week, day) in click_areas_to_add {\n        app.add_click_area(rect, ClickAction::GraphCell { week, day });\n    }\n\n    let month_y = inner.y;\n    let mut current_month: Option\u003cusize\u003e = None;\n\n    for (week_idx, week) in graph.weeks.iter().skip(start_week).enumerate() {\n        if let Some(Some(day)) = week.first() {\n            let month = day\n                .date\n                .format(\"%m\")\n                .to_string()\n                .parse::\u003cusize\u003e()\n                .unwrap_or(1)\n                - 1;\n            if current_month != Some(month) {\n                current_month = Some(month);\n                let x = graph_start_x + (week_idx as u16 * CELL_WIDTH);\n                if x + 3 \u003c inner.x + inner.width \u0026\u0026 month \u003c MONTH_LABELS.len() {\n                    let label =\n                        Paragraph::new(MONTH_LABELS[month]).style(Style::default().fg(theme_muted));\n                    frame.render_widget(label, Rect::new(x, month_y, 3, 1));\n                }\n            }\n        }\n    }\n}\n\nfn render_stats_panel(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Stats \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let is_narrow = app.is_narrow();\n    let graph = \u0026app.data.graph;\n\n    let total_tokens: u64 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter_map(|d| d.as_ref())\n                .map(|d| d.tokens)\n                .sum()\n        })\n        .unwrap_or(0);\n\n    let total_cost: f64 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter_map(|d| d.as_ref())\n                .map(|d| d.cost)\n                .sum()\n        })\n        .unwrap_or(0.0);\n\n    let active_days: u32 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter_map(|d| d.as_ref())\n                .filter(|d| d.tokens \u003e 0)\n                .count() as u32\n        })\n        .unwrap_or(0);\n\n    let total_days: u32 = graph\n        .as_ref()\n        .map(|g| {\n            g.weeks\n                .iter()\n                .flat_map(|w| w.iter())\n                .filter(|d| d.is_some())\n                .count() as u32\n        })\n        .unwrap_or(365);\n\n    let favorite_model = app\n        .data\n        .models\n        .iter()\n        .max_by(|a, b| {\n            a.cost\n                .partial_cmp(\u0026b.cost)\n                .unwrap_or(std::cmp::Ordering::Equal)\n        })\n        .map(|m| m.model.as_str())\n        .unwrap_or(\"N/A\");\n\n    let model_color = get_model_color(favorite_model);\n    let sessions: u32 = app.data.models.iter().map(|m| m.session_count).sum();\n\n    let col1_width = if is_narrow { 18u16 } else { 30u16 };\n    let col2_x = inner.x + col1_width;\n\n    let mut y = inner.y;\n\n    let row1_label = if is_narrow {\n        \"Model:\"\n    } else {\n        \"Favorite model:\"\n    };\n    let row1 = Line::from(vec![\n        Span::styled(row1_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            truncate_model_name(favorite_model, if is_narrow { 15 } else { 30 }),\n            Style::default().fg(model_color),\n        ),\n    ]);\n    frame.render_widget(Paragraph::new(row1), Rect::new(inner.x, y, col1_width, 1));\n\n    let tokens_label = if is_narrow {\n        \"Tokens:\"\n    } else {\n        \"Total tokens:\"\n    };\n    let row1_col2 = Line::from(vec![\n        Span::styled(tokens_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format_tokens(total_tokens),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(\n        Paragraph::new(row1_col2),\n        Rect::new(col2_x, y, inner.width.saturating_sub(col1_width), 1),\n    );\n\n    y += 1;\n\n    let row2 = Line::from(vec![\n        Span::styled(\"Sessions:\", Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(sessions.to_string(), Style::default().fg(Color::Cyan)),\n    ]);\n    frame.render_widget(Paragraph::new(row2), Rect::new(inner.x, y, col1_width, 1));\n\n    let cost_label = if is_narrow { \"Cost:\" } else { \"Total cost:\" };\n    let row2_col2 = Line::from(vec![\n        Span::styled(cost_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(format_cost(total_cost), Style::default().fg(Color::Green)),\n    ]);\n    frame.render_widget(\n        Paragraph::new(row2_col2),\n        Rect::new(col2_x, y, inner.width.saturating_sub(col1_width), 1),\n    );\n\n    y += 1;\n\n    // Row 3: Current streak / Longest streak\n    let streak_label = if is_narrow {\n        \"Streak:\"\n    } else {\n        \"Current streak:\"\n    };\n    let row3 = Line::from(vec![\n        Span::styled(streak_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format!(\"{} days\", app.data.current_streak),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(Paragraph::new(row3), Rect::new(inner.x, y, col1_width, 1));\n\n    let longest_label = if is_narrow {\n        \"Max streak:\"\n    } else {\n        \"Longest streak:\"\n    };\n    let row3_col2 = Line::from(vec![\n        Span::styled(longest_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format!(\"{} days\", app.data.longest_streak),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(\n        Paragraph::new(row3_col2),\n        Rect::new(col2_x, y, inner.width.saturating_sub(col1_width), 1),\n    );\n\n    y += 1;\n\n    let active_label = if is_narrow { \"Active:\" } else { \"Active days:\" };\n    let active_days_line = Line::from(vec![\n        Span::styled(active_label, Style::default().fg(app.theme.muted)),\n        Span::raw(\" \"),\n        Span::styled(\n            format!(\"{}/{}\", active_days, total_days),\n            Style::default().fg(Color::Cyan),\n        ),\n    ]);\n    frame.render_widget(\n        Paragraph::new(active_days_line),\n        Rect::new(inner.x, y, col1_width, 1),\n    );\n\n    y += 2;\n\n    let legend_spans = vec![\n        Span::styled(\"Less \", Style::default().fg(app.theme.muted)),\n        Span::styled(\"Â· \", Style::default().fg(Color::Rgb(102, 102, 102))),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[1])),\n        Span::raw(\" \"),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[2])),\n        Span::raw(\" \"),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[3])),\n        Span::raw(\" \"),\n        Span::styled(\"â–ˆâ–ˆ\", Style::default().fg(app.theme.colors[4])),\n        Span::styled(\" More\", Style::default().fg(app.theme.muted)),\n    ];\n    let legend_line = Line::from(legend_spans);\n    frame.render_widget(\n        Paragraph::new(legend_line),\n        Rect::new(inner.x, y, inner.width, 1),\n    );\n\n    y += 2;\n\n    if !is_narrow {\n        let footer = Line::from(Span::styled(\n            format!(\n                \"Your total spending is ${:.2} on AI coding assistants!\",\n                total_cost\n            ),\n            Style::default()\n                .fg(Color::Yellow)\n                .add_modifier(Modifier::ITALIC),\n        ));\n        frame.render_widget(\n            Paragraph::new(footer),\n            Rect::new(inner.x, y, inner.width, 1),\n        );\n    }\n}\n\nfn render_breakdown_panel(frame: \u0026mut Frame, app: \u0026App, area: Rect) {\n    let block = Block::default()\n        .borders(Borders::ALL)\n        .border_style(Style::default().fg(app.theme.border))\n        .title(Span::styled(\n            \" Day Breakdown (ESC to close) \",\n            Style::default()\n                .fg(app.theme.accent)\n                .add_modifier(Modifier::BOLD),\n        ))\n        .style(Style::default().bg(app.theme.background));\n\n    let inner = block.inner(area);\n    frame.render_widget(block, area);\n\n    let (week_idx, day_idx) = match app.selected_graph_cell {\n        Some(cell) =\u003e cell,\n        None =\u003e return,\n    };\n\n    let graph = match \u0026app.data.graph {\n        Some(g) =\u003e g,\n        None =\u003e return,\n    };\n\n    let day = match graph\n        .weeks\n        .get(week_idx)\n        .and_then(|w| w.get(day_idx))\n        .and_then(|d| d.as_ref())\n    {\n        Some(d) =\u003e d,\n        None =\u003e {\n            let no_data = Paragraph::new(\"No data for this day\")\n                .style(Style::default().fg(app.theme.muted))\n                .alignment(Alignment::Center);\n            frame.render_widget(no_data, inner);\n            return;\n        }\n    };\n\n    let daily_usage = app.data.daily.iter().find(|d| d.date == day.date);\n\n    let mut lines = vec![\n        Line::from(vec![\n            Span::styled(\n                day.date.format(\"%a, %b %d, %Y\").to_string(),\n                Style::default()\n                    .fg(Color::White)\n                    .add_modifier(Modifier::BOLD),\n            ),\n            Span::raw(\"  \"),\n            Span::styled(format_tokens(day.tokens), Style::default().fg(Color::Cyan)),\n            Span::raw(\"  \"),\n            Span::styled(\n                format_cost(day.cost),\n                Style::default()\n                    .fg(Color::Green)\n                    .add_modifier(Modifier::BOLD),\n            ),\n        ]),\n        Line::from(\"\"),\n    ];\n\n    if let Some(daily) = daily_usage {\n        let mut grouped: std::collections::HashMap\u003c\n            String,\n            Vec\u003c(String, \u0026crate::tui::data::DailyModelInfo)\u003e,\n        \u003e = std::collections::HashMap::new();\n        for (model_name, model_info) in \u0026daily.models {\n            grouped\n                .entry(model_info.source.clone())\n                .or_default()\n                .push((model_name.clone(), model_info));\n        }\n\n        for (source, mut models) in grouped {\n            models.sort_by(|a, b| b.1.tokens.total().cmp(\u0026a.1.tokens.total()));\n\n            let source_color = get_source_color(\u0026source);\n            let source_name = get_source_display_name(\u0026source);\n            let model_count = models.len();\n            let plural = if model_count \u003e 1 { \"s\" } else { \"\" };\n\n            lines.push(Line::from(vec![\n                Span::styled(\n                    format!(\"â— {}\", source_name),\n                    Style::default()\n                        .fg(source_color)\n                        .add_modifier(Modifier::BOLD),\n                ),\n                Span::styled(\n                    format!(\" ({} model{})\", model_count, plural),\n                    Style::default().fg(app.theme.muted),\n                ),\n            ]));\n\n            for (model_name, model_info) in models {\n                let model_color = get_model_color(\u0026model_name);\n                lines.push(Line::from(vec![\n                    Span::raw(\"  \"),\n                    Span::styled(\"â—\", Style::default().fg(model_color)),\n                    Span::styled(\n                        format!(\" {}\", truncate_model_name(\u0026model_name, 25)),\n                        Style::default().fg(Color::White),\n                    ),\n                ]));\n\n                let is_narrow = app.is_narrow();\n                if is_narrow {\n                    lines.push(Line::from(vec![\n                        Span::styled(\"    \", Style::default()),\n                        Span::styled(\n                            format_tokens(model_info.tokens.input),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.output),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_read),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\"/\", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_write),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                    ]));\n                } else {\n                    lines.push(Line::from(vec![\n                        Span::styled(\"    In: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.input),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\" Â· Out: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.output),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\" Â· CR: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_read),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                        Span::styled(\" Â· CW: \", Style::default().fg(Color::Rgb(102, 102, 102))),\n                        Span::styled(\n                            format_tokens(model_info.tokens.cache_write),\n                            Style::default().fg(Color::Rgb(170, 170, 170)),\n                        ),\n                    ]));\n                }\n            }\n        }\n    } else {\n        lines.push(Line::from(Span::styled(\n            \"No detailed breakdown available\",\n            Style::default().fg(app.theme.muted),\n        )));\n    }\n\n    let paragraph = Paragraph::new(lines);\n    frame.render_widget(paragraph, inner);\n}\n\nfn truncate_model_name(s: \u0026str, max_chars: usize) -\u003e String {\n    if max_chars == 0 {\n        return String::new();\n    }\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        s.to_string()\n    } else if max_chars == 1 {\n        \"â€¦\".to_string()\n    } else {\n        let head: String = s.chars().take(max_chars - 1).collect();\n        format!(\"{}â€¦\", head)\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":378},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-cli","src","tui","ui","widgets.rs"],"content":"use ratatui::prelude::*;\n\nuse crate::tui::config::TokscaleConfig;\n\npub fn format_tokens_compact(tokens: u64) -\u003e String {\n    if tokens \u003e= 1_000_000_000 {\n        format!(\"{:.1}B\", tokens as f64 / 1_000_000_000.0)\n    } else if tokens \u003e= 1_000_000 {\n        format!(\"{:.1}M\", tokens as f64 / 1_000_000.0)\n    } else if tokens \u003e= 1_000 {\n        format!(\"{}K\", tokens / 1_000)\n    } else {\n        format_tokens_with_commas(tokens)\n    }\n}\n\npub fn format_tokens(tokens: u64) -\u003e String {\n    format_tokens_compact(tokens)\n}\n\npub fn format_tokens_with_commas(n: u64) -\u003e String {\n    let s = n.to_string();\n    let mut result = String::new();\n    for (i, c) in s.chars().rev().enumerate() {\n        if i \u003e 0 \u0026\u0026 i % 3 == 0 {\n            result.insert(0, ',');\n        }\n        result.insert(0, c);\n    }\n    result\n}\n\npub fn format_cost(cost: f64) -\u003e String {\n    if !cost.is_finite() || cost \u003c 0.0 {\n        return \"$0.00\".to_string();\n    }\n    if cost \u003e= 1000.0 {\n        format!(\"${:.1}K\", cost / 1000.0)\n    } else {\n        format!(\"${:.2}\", cost)\n    }\n}\n\npub fn get_model_color(model: \u0026str) -\u003e Color {\n    let provider = get_provider_from_model(model);\n    let config = TokscaleConfig::load();\n    if let Some(color) = config.get_provider_color(provider) {\n        return color;\n    }\n    match provider {\n        \"anthropic\" =\u003e Color::Rgb(218, 119, 86), // #DA7756 Claude brand coral\n        \"openai\" =\u003e Color::Rgb(16, 185, 129),    // #10B981\n        \"google\" =\u003e Color::Rgb(59, 130, 246),    // #3B82F6\n        \"cursor\" =\u003e Color::Rgb(139, 92, 246),    // #8B5CF6\n        \"deepseek\" =\u003e Color::Rgb(6, 182, 212),   // #06B6D4\n        \"xai\" =\u003e Color::Rgb(234, 179, 8),        // #EAB308\n        \"meta\" =\u003e Color::Rgb(99, 102, 241),      // #6366F1\n        _ =\u003e Color::Rgb(255, 255, 255),          // #FFFFFF (unknown)\n    }\n}\n\nfn get_provider_from_model(model: \u0026str) -\u003e \u0026'static str {\n    let model_lower = model.to_lowercase();\n\n    if model_lower.contains(\"claude\")\n        || model_lower.contains(\"sonnet\")\n        || model_lower.contains(\"opus\")\n        || model_lower.contains(\"haiku\")\n    {\n        \"anthropic\"\n    } else if model_lower.contains(\"gpt\")\n        || model_lower.starts_with(\"o1\")\n        || model_lower.starts_with(\"o3\")\n        || model_lower.contains(\"codex\")\n        || model_lower.contains(\"text-embedding\")\n        || model_lower.contains(\"dall-e\")\n        || model_lower.contains(\"whisper\")\n        || model_lower.contains(\"tts\")\n    {\n        \"openai\"\n    } else if model_lower.contains(\"gemini\") {\n        \"google\"\n    } else if model_lower.contains(\"deepseek\") {\n        \"deepseek\"\n    } else if model_lower.contains(\"grok\") {\n        \"xai\"\n    } else if model_lower.contains(\"llama\") {\n        \"meta\"\n    } else if model_lower.contains(\"mixtral\") {\n        \"mistral\"\n    } else if model_lower == \"auto\" || model_lower.contains(\"cursor\") {\n        \"cursor\"\n    } else {\n        \"unknown\"\n    }\n}\n\npub fn get_source_color(source: \u0026str) -\u003e Color {\n    let config = TokscaleConfig::load();\n    if let Some(color) = config.get_source_color(source) {\n        return color;\n    }\n    match source.to_lowercase().as_str() {\n        \"opencode\" =\u003e Color::Rgb(34, 197, 94), // #22c55e\n        \"claude\" =\u003e Color::Rgb(218, 119, 86),  // #DA7756 Claude brand coral\n        \"codex\" =\u003e Color::Rgb(59, 130, 246),   // #3b82f6\n        \"cursor\" =\u003e Color::Rgb(168, 85, 247),  // #a855f7\n        \"gemini\" =\u003e Color::Rgb(6, 182, 212),   // #06b6d4\n        \"amp\" =\u003e Color::Rgb(236, 72, 153),     // #EC4899\n        \"droid\" =\u003e Color::Rgb(16, 185, 129),   // #10b981\n        \"openclaw\" =\u003e Color::Rgb(239, 68, 68), // #ef4444\n        _ =\u003e Color::Rgb(136, 136, 136),        // #888888\n    }\n}\n\npub fn get_source_display_name(source: \u0026str) -\u003e String {\n    let config = TokscaleConfig::load();\n    if let Some(name) = config.get_source_display_name(source) {\n        return name.to_string();\n    }\n    match source.to_lowercase().as_str() {\n        \"opencode\" =\u003e \"OpenCode\".to_string(),\n        \"claude\" =\u003e \"Claude\".to_string(),\n        \"codex\" =\u003e \"Codex\".to_string(),\n        \"cursor\" =\u003e \"Cursor\".to_string(),\n        \"gemini\" =\u003e \"Gemini\".to_string(),\n        \"amp\" =\u003e \"Amp\".to_string(),\n        \"droid\" =\u003e \"Droid\".to_string(),\n        \"openclaw\" =\u003e \"ðŸ¦ž OpenClaw\".to_string(),\n        \"pi\" =\u003e \"Pi\".to_string(),\n        _ =\u003e source.to_string(),\n    }\n}\n\npub fn get_provider_display_name(provider: \u0026str) -\u003e String {\n    let config = TokscaleConfig::load();\n    if let Some(name) = config.get_provider_display_name(provider) {\n        return name.to_string();\n    }\n    match provider.to_lowercase().as_str() {\n        \"anthropic\" =\u003e \"Anthropic\".to_string(),\n        \"openai\" =\u003e \"OpenAI\".to_string(),\n        \"google\" =\u003e \"Google\".to_string(),\n        \"cursor\" =\u003e \"Cursor\".to_string(),\n        \"deepseek\" =\u003e \"DeepSeek\".to_string(),\n        \"xai\" =\u003e \"xAI\".to_string(),\n        \"meta\" =\u003e \"Meta\".to_string(),\n        \"mistral\" =\u003e \"Mistral\".to_string(),\n        \"cohere\" =\u003e \"Cohere\".to_string(),\n        \"opencode\" =\u003e \"OpenCode\".to_string(),\n        s if s.starts_with(\"github-cop\") || s.contains(\"copilot\") =\u003e \"GitHub Copilot\".to_string(),\n        _ =\u003e capitalize_first(provider),\n    }\n}\n\nfn capitalize_first(s: \u0026str) -\u003e String {\n    let mut chars = s.chars();\n    match chars.next() {\n        None =\u003e String::new(),\n        Some(first) =\u003e first.to_uppercase().chain(chars).collect(),\n    }\n}\n","traces":[{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":118},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","aggregator.rs"],"content":"//! Parallel aggregation of session data\n//!\n//! Uses rayon for parallel map-reduce operations.\n\nuse crate::sessions::UnifiedMessage;\nuse crate::{\n    DailyContribution, DailyTotals, DataSummary, GraphMeta, GraphResult, SourceContribution,\n    TokenBreakdown, YearSummary,\n};\nuse rayon::prelude::*;\nuse std::collections::HashMap;\n\n/// Aggregate messages into daily contributions\npub fn aggregate_by_date(messages: Vec\u003cUnifiedMessage\u003e) -\u003e Vec\u003cDailyContribution\u003e {\n    if messages.is_empty() {\n        return Vec::new();\n    }\n\n    // Estimate unique days (typically 1-365) - use message count / 10 as heuristic\n    let estimated_days = (messages.len() / 10).clamp(30, 400);\n\n    // Parallel aggregation using fold/reduce pattern\n    let daily_map: HashMap\u003cString, DayAccumulator\u003e = messages\n        .into_par_iter()\n        .fold(\n            || HashMap::with_capacity(estimated_days),\n            |mut acc: HashMap\u003cString, DayAccumulator\u003e, msg| {\n                let entry = acc.entry(msg.date.clone()).or_default();\n                entry.add_message(\u0026msg);\n                acc\n            },\n        )\n        .reduce(\n            || HashMap::with_capacity(estimated_days),\n            |mut a, b| {\n                for (date, acc) in b {\n                    a.entry(date).or_default().merge(acc);\n                }\n                a\n            },\n        );\n\n    // Convert to sorted vector with pre-allocated capacity\n    let mut contributions: Vec\u003cDailyContribution\u003e = Vec::with_capacity(daily_map.len());\n    contributions.extend(\n        daily_map\n            .into_iter()\n            .map(|(date, acc)| acc.into_contribution(date)),\n    );\n\n    // Sort by date\n    contributions.sort_by(|a, b| a.date.cmp(\u0026b.date));\n\n    // Calculate intensities based on max cost\n    calculate_intensities(\u0026mut contributions);\n\n    contributions\n}\n\n/// Calculate summary statistics\npub fn calculate_summary(contributions: \u0026[DailyContribution]) -\u003e DataSummary {\n    let total_tokens: i64 = contributions.iter().map(|c| c.totals.tokens).sum();\n    let total_cost: f64 = contributions.iter().map(|c| c.totals.cost).sum();\n    let active_days = contributions.iter().filter(|c| c.totals.tokens \u003e 0).count() as i32;\n    let max_cost = contributions\n        .iter()\n        .map(|c| c.totals.cost)\n        .fold(0.0, f64::max);\n\n    let mut sources_set = std::collections::HashSet::with_capacity(5);\n    let mut models_set = std::collections::HashSet::with_capacity(20);\n\n    for c in contributions {\n        for s in \u0026c.sources {\n            sources_set.insert(s.source.clone());\n            models_set.insert(s.model_id.clone());\n        }\n    }\n\n    DataSummary {\n        total_tokens,\n        total_cost,\n        total_days: contributions.len() as i32,\n        active_days,\n        average_per_day: if active_days \u003e 0 {\n            total_cost / active_days as f64\n        } else {\n            0.0\n        },\n        max_cost_in_single_day: max_cost,\n        sources: sources_set.into_iter().collect(),\n        models: models_set.into_iter().collect(),\n    }\n}\n\n/// Calculate year summaries\npub fn calculate_years(contributions: \u0026[DailyContribution]) -\u003e Vec\u003cYearSummary\u003e {\n    let mut years_map: HashMap\u003cString, YearAccumulator\u003e = HashMap::with_capacity(5);\n\n    for c in contributions {\n        // Guard against short/invalid date strings\n        if c.date.len() \u003c 4 {\n            eprintln!(\n                \"Warning: Skipping contribution with invalid date '{}' ({} tokens, ${:.4} cost)\",\n                c.date, c.totals.tokens, c.totals.cost\n            );\n            continue;\n        }\n        let year = \u0026c.date[0..4];\n        let entry = years_map.entry(year.to_string()).or_default();\n        entry.tokens += c.totals.tokens;\n        entry.cost += c.totals.cost;\n\n        if entry.start.is_empty() || c.date \u003c entry.start {\n            entry.start = c.date.clone();\n        }\n        if entry.end.is_empty() || c.date \u003e entry.end {\n            entry.end = c.date.clone();\n        }\n    }\n\n    let mut years: Vec\u003cYearSummary\u003e = Vec::with_capacity(years_map.len());\n    years.extend(years_map.into_iter().map(|(year, acc)| YearSummary {\n        year,\n        total_tokens: acc.tokens,\n        total_cost: acc.cost,\n        range_start: acc.start,\n        range_end: acc.end,\n    }));\n\n    years.sort_by(|a, b| a.year.cmp(\u0026b.year));\n    years\n}\n\n/// Generate complete graph result\npub fn generate_graph_result(\n    contributions: Vec\u003cDailyContribution\u003e,\n    processing_time_ms: u32,\n) -\u003e GraphResult {\n    let summary = calculate_summary(\u0026contributions);\n    let years = calculate_years(\u0026contributions);\n\n    let date_range_start = contributions\n        .first()\n        .map(|c| c.date.clone())\n        .unwrap_or_default();\n    let date_range_end = contributions\n        .last()\n        .map(|c| c.date.clone())\n        .unwrap_or_default();\n\n    GraphResult {\n        meta: GraphMeta {\n            generated_at: chrono::Utc::now().to_rfc3339(),\n            version: env!(\"CARGO_PKG_VERSION\").to_string(),\n            date_range_start,\n            date_range_end,\n            processing_time_ms,\n        },\n        summary,\n        years,\n        contributions,\n    }\n}\n\n// =============================================================================\n// Internal helpers\n// =============================================================================\n\nstruct DayAccumulator {\n    totals: DailyTotals,\n    token_breakdown: TokenBreakdown,\n    sources: HashMap\u003cString, SourceContribution\u003e,\n}\n\nimpl Default for DayAccumulator {\n    fn default() -\u003e Self {\n        Self {\n            totals: DailyTotals::default(),\n            token_breakdown: TokenBreakdown::default(),\n            sources: HashMap::with_capacity(8),\n        }\n    }\n}\n\nimpl DayAccumulator {\n    fn add_message(\u0026mut self, msg: \u0026UnifiedMessage) {\n        let total_tokens = msg\n            .tokens\n            .input\n            .saturating_add(msg.tokens.output)\n            .saturating_add(msg.tokens.cache_read)\n            .saturating_add(msg.tokens.cache_write)\n            .saturating_add(msg.tokens.reasoning);\n\n        self.totals.tokens = self.totals.tokens.saturating_add(total_tokens);\n        self.totals.cost += msg.cost;\n        self.totals.messages = self.totals.messages.saturating_add(1);\n\n        self.token_breakdown.input = self.token_breakdown.input.saturating_add(msg.tokens.input);\n        self.token_breakdown.output = self\n            .token_breakdown\n            .output\n            .saturating_add(msg.tokens.output);\n        self.token_breakdown.cache_read = self\n            .token_breakdown\n            .cache_read\n            .saturating_add(msg.tokens.cache_read);\n        self.token_breakdown.cache_write = self\n            .token_breakdown\n            .cache_write\n            .saturating_add(msg.tokens.cache_write);\n        self.token_breakdown.reasoning = self\n            .token_breakdown\n            .reasoning\n            .saturating_add(msg.tokens.reasoning);\n\n        // Update source contribution\n        let key = format!(\n            \"{}:{}\",\n            msg.source,\n            crate::normalize_model_for_grouping(\u0026msg.model_id)\n        );\n        let source = self\n            .sources\n            .entry(key)\n            .or_insert_with(|| SourceContribution {\n                source: msg.source.clone(),\n                model_id: crate::normalize_model_for_grouping(\u0026msg.model_id),\n                provider_id: msg.provider_id.clone(),\n                tokens: TokenBreakdown::default(),\n                cost: 0.0,\n                messages: 0,\n            });\n\n        // Merge provider_id if different provider contributes to same source+model\n        if !source.provider_id.split(\", \").any(|p| p == msg.provider_id) {\n            source.provider_id = format!(\"{}, {}\", source.provider_id, msg.provider_id);\n        }\n\n        source.tokens.input = source.tokens.input.saturating_add(msg.tokens.input);\n        source.tokens.output = source.tokens.output.saturating_add(msg.tokens.output);\n        source.tokens.cache_read = source\n            .tokens\n            .cache_read\n            .saturating_add(msg.tokens.cache_read);\n        source.tokens.cache_write = source\n            .tokens\n            .cache_write\n            .saturating_add(msg.tokens.cache_write);\n        source.tokens.reasoning = source.tokens.reasoning.saturating_add(msg.tokens.reasoning);\n        source.cost += msg.cost;\n        source.messages = source.messages.saturating_add(1);\n\n        // Normalize provider order for deterministic output\n        let mut providers: Vec\u003c\u0026str\u003e = source.provider_id.split(\", \").collect();\n        providers.sort_unstable();\n        providers.dedup();\n        source.provider_id = providers.join(\", \");\n    }\n\n    fn merge(\u0026mut self, other: DayAccumulator) {\n        self.totals.tokens = self.totals.tokens.saturating_add(other.totals.tokens);\n        self.totals.cost += other.totals.cost;\n        self.totals.messages = self.totals.messages.saturating_add(other.totals.messages);\n\n        self.token_breakdown.input = self\n            .token_breakdown\n            .input\n            .saturating_add(other.token_breakdown.input);\n        self.token_breakdown.output = self\n            .token_breakdown\n            .output\n            .saturating_add(other.token_breakdown.output);\n        self.token_breakdown.cache_read = self\n            .token_breakdown\n            .cache_read\n            .saturating_add(other.token_breakdown.cache_read);\n        self.token_breakdown.cache_write = self\n            .token_breakdown\n            .cache_write\n            .saturating_add(other.token_breakdown.cache_write);\n        self.token_breakdown.reasoning = self\n            .token_breakdown\n            .reasoning\n            .saturating_add(other.token_breakdown.reasoning);\n\n        for (key, source) in other.sources {\n            let entry = self\n                .sources\n                .entry(key)\n                .or_insert_with(|| SourceContribution {\n                    source: source.source.clone(),\n                    model_id: source.model_id.clone(),\n                    provider_id: source.provider_id.clone(),\n                    tokens: TokenBreakdown::default(),\n                    cost: 0.0,\n                    messages: 0,\n                });\n\n            // Merge provider_ids from parallel reduction\n            for provider in source.provider_id.split(\", \") {\n                if !entry.provider_id.split(\", \").any(|p| p == provider) {\n                    entry.provider_id = format!(\"{}, {}\", entry.provider_id, provider);\n                }\n            }\n\n            entry.tokens.input = entry.tokens.input.saturating_add(source.tokens.input);\n            entry.tokens.output = entry.tokens.output.saturating_add(source.tokens.output);\n            entry.tokens.cache_read = entry\n                .tokens\n                .cache_read\n                .saturating_add(source.tokens.cache_read);\n            entry.tokens.cache_write = entry\n                .tokens\n                .cache_write\n                .saturating_add(source.tokens.cache_write);\n            entry.tokens.reasoning = entry\n                .tokens\n                .reasoning\n                .saturating_add(source.tokens.reasoning);\n            entry.cost += source.cost;\n            entry.messages = entry.messages.saturating_add(source.messages);\n        }\n\n        // Normalize provider order for deterministic output\n        for entry in self.sources.values_mut() {\n            let mut providers: Vec\u003c\u0026str\u003e = entry.provider_id.split(\", \").collect();\n            providers.sort_unstable();\n            providers.dedup();\n            entry.provider_id = providers.join(\", \");\n        }\n    }\n\n    fn into_contribution(self, date: String) -\u003e DailyContribution {\n        let token_breakdown = TokenBreakdown {\n            input: self.token_breakdown.input.max(0),\n            output: self.token_breakdown.output.max(0),\n            cache_read: self.token_breakdown.cache_read.max(0),\n            cache_write: self.token_breakdown.cache_write.max(0),\n            reasoning: self.token_breakdown.reasoning.max(0),\n        };\n\n        let sources: Vec\u003cSourceContribution\u003e = self\n            .sources\n            .into_values()\n            .map(|mut s| {\n                s.tokens.input = s.tokens.input.max(0);\n                s.tokens.output = s.tokens.output.max(0);\n                s.tokens.cache_read = s.tokens.cache_read.max(0);\n                s.tokens.cache_write = s.tokens.cache_write.max(0);\n                s.tokens.reasoning = s.tokens.reasoning.max(0);\n                s.cost = s.cost.max(0.0);\n                s\n            })\n            .collect();\n\n        DailyContribution {\n            date,\n            totals: DailyTotals {\n                tokens: self.totals.tokens.max(0),\n                cost: self.totals.cost.max(0.0),\n                messages: self.totals.messages.max(0),\n            },\n            intensity: 0,\n            token_breakdown,\n            sources,\n        }\n    }\n}\n\n#[derive(Default)]\nstruct YearAccumulator {\n    tokens: i64,\n    cost: f64,\n    start: String,\n    end: String,\n}\n\nfn calculate_intensities(contributions: \u0026mut [DailyContribution]) {\n    let max_cost = contributions\n        .iter()\n        .map(|c| c.totals.cost)\n        .fold(0.0, f64::max);\n\n    if max_cost == 0.0 {\n        return;\n    }\n\n    for c in contributions.iter_mut() {\n        let ratio = c.totals.cost / max_cost;\n        c.intensity = if ratio \u003e= 0.75 {\n            4\n        } else if ratio \u003e= 0.5 {\n            3\n        } else if ratio \u003e= 0.25 {\n            2\n        } else if ratio \u003e 0.0 {\n            1\n        } else {\n            0\n        };\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::{DateTime, Utc};\n\n    // Helper function to create mock UnifiedMessage\n    fn mock_unified_message(\n        date: \u0026str,\n        tokens: i64,\n        cost: f64,\n        model: \u0026str,\n        source: \u0026str,\n    ) -\u003e UnifiedMessage {\n        // Parse date string to timestamp\n        let datetime = format!(\"{}T00:00:00Z\", date)\n            .parse::\u003cDateTime\u003cUtc\u003e\u003e()\n            .unwrap();\n        let timestamp = datetime.timestamp_millis();\n\n        UnifiedMessage {\n            source: source.to_string(),\n            model_id: model.to_string(),\n            provider_id: \"test-provider\".to_string(),\n            session_id: \"test-session\".to_string(),\n            timestamp,\n            date: date.to_string(),\n            tokens: TokenBreakdown {\n                input: tokens / 2,\n                output: tokens / 2,\n                cache_read: 0,\n                cache_write: 0,\n                reasoning: 0,\n            },\n            cost,\n            agent: None,\n            dedup_key: None,\n        }\n    }\n\n    #[test]\n    fn test_aggregate_by_date_empty() {\n        let messages = Vec::new();\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 0);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_single_message() {\n        let messages = vec![mock_unified_message(\n            \"2024-01-01\",\n            1000,\n            0.05,\n            \"claude-3-5-sonnet\",\n            \"opencode\",\n        )];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].date, \"2024-01-01\");\n        assert_eq!(result[0].totals.tokens, 1000);\n        assert_eq!(result[0].totals.cost, 0.05);\n        assert_eq!(result[0].totals.messages, 1);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_multiple_dates() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-02\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-01-03\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 3);\n\n        // Verify sorted by date\n        assert_eq!(result[0].date, \"2024-01-01\");\n        assert_eq!(result[1].date, \"2024-01-02\");\n        assert_eq!(result[2].date, \"2024-01-03\");\n\n        // Verify totals\n        assert_eq!(result[0].totals.tokens, 1000);\n        assert_eq!(result[1].totals.tokens, 2000);\n        assert_eq!(result[2].totals.tokens, 1500);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_same_date_aggregation() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-01-01\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].date, \"2024-01-01\");\n        assert_eq!(result[0].totals.tokens, 4500);\n        assert!((result[0].totals.cost - 0.23).abs() \u003c 0.0001);\n        assert_eq!(result[0].totals.messages, 3);\n    }\n\n    #[test]\n    fn test_aggregate_by_date_token_breakdown() {\n        let mut msg =\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\");\n        msg.tokens = TokenBreakdown {\n            input: 600,\n            output: 300,\n            cache_read: 50,\n            cache_write: 40,\n            reasoning: 10,\n        };\n\n        let result = aggregate_by_date(vec![msg]);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].token_breakdown.input, 600);\n        assert_eq!(result[0].token_breakdown.output, 300);\n        assert_eq!(result[0].token_breakdown.cache_read, 50);\n        assert_eq!(result[0].token_breakdown.cache_write, 40);\n        assert_eq!(result[0].token_breakdown.reasoning, 10);\n    }\n\n    #[test]\n    fn test_calculate_summary_empty() {\n        let contributions = Vec::new();\n        let summary = calculate_summary(\u0026contributions);\n\n        assert_eq!(summary.total_tokens, 0);\n        assert_eq!(summary.total_cost, 0.0);\n        assert_eq!(summary.total_days, 0);\n        assert_eq!(summary.active_days, 0);\n        assert_eq!(summary.average_per_day, 0.0);\n        assert_eq!(summary.max_cost_in_single_day, 0.0);\n    }\n\n    #[test]\n    fn test_calculate_summary_single_day() {\n        let messages = vec![mock_unified_message(\n            \"2024-01-01\",\n            1000,\n            0.05,\n            \"claude-3-5-sonnet\",\n            \"opencode\",\n        )];\n        let contributions = aggregate_by_date(messages);\n        let summary = calculate_summary(\u0026contributions);\n\n        assert_eq!(summary.total_tokens, 1000);\n        assert_eq!(summary.total_cost, 0.05);\n        assert_eq!(summary.total_days, 1);\n        assert_eq!(summary.active_days, 1);\n        assert_eq!(summary.average_per_day, 0.05);\n        assert_eq!(summary.max_cost_in_single_day, 0.05);\n    }\n\n    #[test]\n    fn test_calculate_summary_multiple_days() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-02\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-01-03\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let summary = calculate_summary(\u0026contributions);\n\n        assert_eq!(summary.total_tokens, 4500);\n        assert!((summary.total_cost - 0.23).abs() \u003c 0.0001);\n        assert_eq!(summary.total_days, 3);\n        assert_eq!(summary.active_days, 3);\n        assert!((summary.average_per_day - 0.23 / 3.0).abs() \u003c 0.0001);\n        assert!((summary.max_cost_in_single_day - 0.10).abs() \u003c 0.0001);\n    }\n\n    #[test]\n    fn test_calculate_summary_with_zero_token_days() {\n        let contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 0.05,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 0,\n                    cost: 0.0,\n                    messages: 0,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        let summary = calculate_summary(\u0026contributions);\n        assert_eq!(summary.total_days, 2);\n        assert_eq!(summary.active_days, 1);\n        assert!((summary.average_per_day - 0.05).abs() \u003c 0.0001);\n    }\n\n    #[test]\n    fn test_calculate_years_empty() {\n        let contributions = Vec::new();\n        let years = calculate_years(\u0026contributions);\n        assert_eq!(years.len(), 0);\n    }\n\n    #[test]\n    fn test_calculate_years_single_year() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-06-15\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-12-31\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let years = calculate_years(\u0026contributions);\n\n        assert_eq!(years.len(), 1);\n        assert_eq!(years[0].year, \"2024\");\n        assert_eq!(years[0].total_tokens, 4500);\n        assert!((years[0].total_cost - 0.23).abs() \u003c 0.0001);\n        assert_eq!(years[0].range_start, \"2024-01-01\");\n        assert_eq!(years[0].range_end, \"2024-12-31\");\n    }\n\n    #[test]\n    fn test_calculate_years_multiple_years() {\n        let messages = vec![\n            mock_unified_message(\"2023-12-31\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n            mock_unified_message(\"2024-06-15\", 1500, 0.08, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2025-01-01\", 3000, 0.15, \"gpt-4\", \"claude\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let years = calculate_years(\u0026contributions);\n\n        assert_eq!(years.len(), 3);\n\n        // Verify sorted by year\n        assert_eq!(years[0].year, \"2023\");\n        assert_eq!(years[1].year, \"2024\");\n        assert_eq!(years[2].year, \"2025\");\n\n        // Verify 2024 aggregation\n        assert_eq!(years[1].total_tokens, 3500);\n        assert!((years[1].total_cost - 0.18).abs() \u003c 0.0001);\n        assert_eq!(years[1].range_start, \"2024-01-01\");\n        assert_eq!(years[1].range_end, \"2024-06-15\");\n    }\n\n    #[test]\n    fn test_calculate_years_year_boundary() {\n        let messages = vec![\n            mock_unified_message(\"2024-12-31\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2025-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let years = calculate_years(\u0026contributions);\n\n        assert_eq!(years.len(), 2);\n        assert_eq!(years[0].year, \"2024\");\n        assert_eq!(years[0].total_tokens, 1000);\n        assert_eq!(years[1].year, \"2025\");\n        assert_eq!(years[1].total_tokens, 2000);\n    }\n\n    #[test]\n    fn test_calculate_years_invalid_date() {\n        let contributions = vec![DailyContribution {\n            date: \"abc\".to_string(), // Invalid date (less than 4 chars)\n            totals: DailyTotals {\n                tokens: 1000,\n                cost: 0.05,\n                messages: 1,\n            },\n            intensity: 0,\n            token_breakdown: TokenBreakdown::default(),\n            sources: Vec::new(),\n        }];\n\n        let years = calculate_years(\u0026contributions);\n        assert_eq!(years.len(), 0); // Should skip invalid dates\n    }\n\n    #[test]\n    fn test_generate_graph_result_empty() {\n        let contributions = Vec::new();\n        let result = generate_graph_result(contributions, 100);\n\n        assert_eq!(result.contributions.len(), 0);\n        assert_eq!(result.summary.total_tokens, 0);\n        assert_eq!(result.years.len(), 0);\n        assert_eq!(result.meta.processing_time_ms, 100);\n        assert_eq!(result.meta.date_range_start, \"\");\n        assert_eq!(result.meta.date_range_end, \"\");\n    }\n\n    #[test]\n    fn test_generate_graph_result_with_data() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-02\", 2000, 0.10, \"gpt-4\", \"claude\"),\n        ];\n        let contributions = aggregate_by_date(messages);\n        let result = generate_graph_result(contributions, 150);\n\n        assert_eq!(result.contributions.len(), 2);\n        assert_eq!(result.summary.total_tokens, 3000);\n        assert_eq!(result.years.len(), 1);\n        assert_eq!(result.meta.processing_time_ms, 150);\n        assert_eq!(result.meta.date_range_start, \"2024-01-01\");\n        assert_eq!(result.meta.date_range_end, \"2024-01-02\");\n        assert_eq!(result.meta.version, env!(\"CARGO_PKG_VERSION\"));\n    }\n\n    #[test]\n    fn test_calculate_intensities_empty() {\n        let mut contributions = Vec::new();\n        calculate_intensities(\u0026mut contributions);\n        assert_eq!(contributions.len(), 0);\n    }\n\n    #[test]\n    fn test_calculate_intensities_zero_cost() {\n        let mut contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 0.0,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 2000,\n                    cost: 0.0,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        calculate_intensities(\u0026mut contributions);\n        assert_eq!(contributions[0].intensity, 0);\n        assert_eq!(contributions[1].intensity, 0);\n    }\n\n    #[test]\n    fn test_calculate_intensities_levels() {\n        let mut contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 1.0, // 100% of max\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 800,\n                    cost: 0.8, // 80% of max (\u003e= 0.75)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-03\".to_string(),\n                totals: DailyTotals {\n                    tokens: 600,\n                    cost: 0.6, // 60% of max (\u003e= 0.5)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-04\".to_string(),\n                totals: DailyTotals {\n                    tokens: 300,\n                    cost: 0.3, // 30% of max (\u003e= 0.25)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-05\".to_string(),\n                totals: DailyTotals {\n                    tokens: 100,\n                    cost: 0.1, // 10% of max (\u003e 0.0)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        calculate_intensities(\u0026mut contributions);\n\n        assert_eq!(contributions[0].intensity, 4); // 100%\n        assert_eq!(contributions[1].intensity, 4); // 80%\n        assert_eq!(contributions[2].intensity, 3); // 60%\n        assert_eq!(contributions[3].intensity, 2); // 30%\n        assert_eq!(contributions[4].intensity, 1); // 10%\n    }\n\n    #[test]\n    fn test_calculate_intensities_boundary_values() {\n        let mut contributions = vec![\n            DailyContribution {\n                date: \"2024-01-01\".to_string(),\n                totals: DailyTotals {\n                    tokens: 1000,\n                    cost: 1.0,\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-02\".to_string(),\n                totals: DailyTotals {\n                    tokens: 750,\n                    cost: 0.75, // Exactly 0.75 (should be level 4)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-03\".to_string(),\n                totals: DailyTotals {\n                    tokens: 500,\n                    cost: 0.5, // Exactly 0.5 (should be level 3)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n            DailyContribution {\n                date: \"2024-01-04\".to_string(),\n                totals: DailyTotals {\n                    tokens: 250,\n                    cost: 0.25, // Exactly 0.25 (should be level 2)\n                    messages: 1,\n                },\n                intensity: 0,\n                token_breakdown: TokenBreakdown::default(),\n                sources: Vec::new(),\n            },\n        ];\n\n        calculate_intensities(\u0026mut contributions);\n\n        assert_eq!(contributions[0].intensity, 4);\n        assert_eq!(contributions[1].intensity, 4); // \u003e= 0.75\n        assert_eq!(contributions[2].intensity, 3); // \u003e= 0.5\n        assert_eq!(contributions[3].intensity, 2); // \u003e= 0.25\n    }\n\n    #[test]\n    fn test_aggregate_by_date_preserves_sources() {\n        let messages = vec![\n            mock_unified_message(\"2024-01-01\", 1000, 0.05, \"claude-3-5-sonnet\", \"opencode\"),\n            mock_unified_message(\"2024-01-01\", 2000, 0.10, \"gpt-4\", \"claude\"),\n        ];\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 1);\n        assert_eq!(result[0].sources.len(), 2);\n\n        // Verify both sources are present\n        let source_names: Vec\u003c\u0026str\u003e = result[0]\n            .sources\n            .iter()\n            .map(|s| s.source.as_str())\n            .collect();\n        assert!(source_names.contains(\u0026\"opencode\"));\n        assert!(source_names.contains(\u0026\"claude\"));\n    }\n\n    #[test]\n    fn test_aggregate_by_date_large_dataset() {\n        // Test with 100 messages across 10 days\n        let mut messages = Vec::new();\n        for day in 1..=10 {\n            for _msg in 0..10 {\n                let date = format!(\"2024-01-{:02}\", day);\n                messages.push(mock_unified_message(\n                    \u0026date,\n                    1000,\n                    0.05,\n                    \"claude-3-5-sonnet\",\n                    \"opencode\",\n                ));\n            }\n        }\n\n        let result = aggregate_by_date(messages);\n        assert_eq!(result.len(), 10);\n\n        // Each day should have 10 messages aggregated\n        for contribution in \u0026result {\n            assert_eq!(contribution.totals.messages, 10);\n            assert_eq!(contribution.totals.tokens, 10000);\n            assert!((contribution.totals.cost - 0.5).abs() \u003c 0.0001);\n        }\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":223},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","lib.rs"],"content":"#![deny(clippy::all)]\n\nmod aggregator;\nmod parser;\npub mod pricing;\npub mod scanner;\npub mod sessions;\n\npub use aggregator::*;\npub use parser::*;\npub use scanner::*;\npub use sessions::UnifiedMessage;\n\nuse rayon::prelude::*;\nuse std::collections::{HashMap, HashSet};\nuse std::path::{Path, PathBuf};\nuse std::time::Instant;\n\npub fn version() -\u003e String {\n    env!(\"CARGO_PKG_VERSION\").to_string()\n}\n\npub fn health_check() -\u003e String {\n    \"tokscale-core is healthy!\".to_string()\n}\n\npub fn normalize_model_for_grouping(model_id: \u0026str) -\u003e String {\n    let mut name = model_id.to_lowercase();\n\n    if name.len() \u003e 9 {\n        let potential_date = \u0026name[name.len() - 8..];\n        if potential_date.chars().all(|c| c.is_ascii_digit())\n            \u0026\u0026 name.as_bytes()[name.len() - 9] == b'-'\n        {\n            name = name[..name.len() - 9].to_string();\n        }\n    }\n\n    if name.contains(\"claude\") {\n        let chars: Vec\u003cchar\u003e = name.chars().collect();\n        let mut result = String::with_capacity(name.len());\n        for i in 0..chars.len() {\n            if chars[i] == '.'\n                \u0026\u0026 i \u003e 0\n                \u0026\u0026 i \u003c chars.len() - 1\n                \u0026\u0026 chars[i - 1].is_ascii_digit()\n                \u0026\u0026 chars[i + 1].is_ascii_digit()\n            {\n                result.push('-');\n            } else {\n                result.push(chars[i]);\n            }\n        }\n        name = result;\n    }\n\n    name\n}\n\n#[derive(Debug, Clone, PartialEq, serde::Serialize)]\npub enum GroupBy {\n    Model,\n    ClientModel,\n    ClientProviderModel,\n}\n\nimpl Default for GroupBy {\n    fn default() -\u003e Self {\n        GroupBy::ClientModel\n    }\n}\n\nimpl std::fmt::Display for GroupBy {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            GroupBy::Model =\u003e write!(f, \"model\"),\n            GroupBy::ClientModel =\u003e write!(f, \"client,model\"),\n            GroupBy::ClientProviderModel =\u003e write!(f, \"client,provider,model\"),\n        }\n    }\n}\n\nimpl std::str::FromStr for GroupBy {\n    type Err = String;\n\n    fn from_str(s: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        let normalized: String = s.split(',').map(|p| p.trim()).collect::\u003cVec\u003c_\u003e\u003e().join(\",\");\n        match normalized.to_lowercase().as_str() {\n            \"model\" =\u003e Ok(GroupBy::Model),\n            \"client,model\" | \"client-model\" =\u003e Ok(GroupBy::ClientModel),\n            \"client,provider,model\" | \"client-provider-model\" =\u003e Ok(GroupBy::ClientProviderModel),\n            _ =\u003e Err(format!(\n                \"Invalid group-by value: '{}'. Valid options: model, client,model, client,provider,model\",\n                s\n            )),\n        }\n    }\n}\n\n#[derive(Debug, Clone, Default, serde::Serialize)]\npub struct TokenBreakdown {\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub reasoning: i64,\n}\n\nimpl TokenBreakdown {\n    pub fn total(\u0026self) -\u003e i64 {\n        self.input + self.output + self.cache_read + self.cache_write + self.reasoning\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct ParsedMessage {\n    pub source: String,\n    pub model_id: String,\n    pub provider_id: String,\n    pub session_id: String,\n    pub timestamp: i64,\n    pub date: String,\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub reasoning: i64,\n    pub agent: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ParsedMessages {\n    pub messages: Vec\u003cParsedMessage\u003e,\n    pub opencode_count: i32,\n    pub claude_count: i32,\n    pub codex_count: i32,\n    pub gemini_count: i32,\n    pub amp_count: i32,\n    pub droid_count: i32,\n    pub openclaw_count: i32,\n    pub pi_count: i32,\n    pub processing_time_ms: u32,\n}\n\n#[derive(Debug, Clone)]\npub struct LocalParseOptions {\n    pub home_dir: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Default, serde::Serialize)]\npub struct DailyTotals {\n    pub tokens: i64,\n    pub cost: f64,\n    pub messages: i32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct SourceContribution {\n    pub source: String,\n    pub model_id: String,\n    pub provider_id: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub messages: i32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct DailyContribution {\n    pub date: String,\n    pub totals: DailyTotals,\n    pub intensity: u8,\n    pub token_breakdown: TokenBreakdown,\n    pub sources: Vec\u003cSourceContribution\u003e,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct YearSummary {\n    pub year: String,\n    pub total_tokens: i64,\n    pub total_cost: f64,\n    pub range_start: String,\n    pub range_end: String,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct DataSummary {\n    pub total_tokens: i64,\n    pub total_cost: f64,\n    pub total_days: i32,\n    pub active_days: i32,\n    pub average_per_day: f64,\n    pub max_cost_in_single_day: f64,\n    pub sources: Vec\u003cString\u003e,\n    pub models: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct GraphMeta {\n    pub generated_at: String,\n    pub version: String,\n    pub date_range_start: String,\n    pub date_range_end: String,\n    pub processing_time_ms: u32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct GraphResult {\n    pub meta: GraphMeta,\n    pub summary: DataSummary,\n    pub years: Vec\u003cYearSummary\u003e,\n    pub contributions: Vec\u003cDailyContribution\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ReportOptions {\n    pub home_dir: Option\u003cString\u003e,\n    pub sources: Option\u003cVec\u003cString\u003e\u003e,\n    pub since: Option\u003cString\u003e,\n    pub until: Option\u003cString\u003e,\n    pub year: Option\u003cString\u003e,\n    pub group_by: GroupBy,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct ModelUsage {\n    pub source: String,\n    pub merged_clients: Option\u003cString\u003e,\n    pub model: String,\n    pub provider: String,\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub reasoning: i64,\n    pub message_count: i32,\n    pub cost: f64,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct MonthlyUsage {\n    pub month: String,\n    pub models: Vec\u003cString\u003e,\n    pub input: i64,\n    pub output: i64,\n    pub cache_read: i64,\n    pub cache_write: i64,\n    pub message_count: i32,\n    pub cost: f64,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct ModelReport {\n    pub entries: Vec\u003cModelUsage\u003e,\n    pub total_input: i64,\n    pub total_output: i64,\n    pub total_cache_read: i64,\n    pub total_cache_write: i64,\n    pub total_messages: i32,\n    pub total_cost: f64,\n    pub processing_time_ms: u32,\n}\n\n#[derive(Debug, Clone, serde::Serialize)]\npub struct MonthlyReport {\n    pub entries: Vec\u003cMonthlyUsage\u003e,\n    pub total_cost: f64,\n    pub processing_time_ms: u32,\n}\n\npub fn get_home_dir_string(home_dir_option: \u0026Option\u003cString\u003e) -\u003e Result\u003cString, String\u003e {\n    home_dir_option\n        .clone()\n        .or_else(|| std::env::var(\"HOME\").ok())\n        .or_else(|| dirs::home_dir().map(|p| p.to_string_lossy().into_owned()))\n        .ok_or_else(|| {\n            \"HOME directory not specified and could not determine home directory\".to_string()\n        })\n}\n\nfn parse_all_messages_with_pricing(\n    home_dir: \u0026str,\n    sources: \u0026[String],\n    pricing: \u0026pricing::PricingService,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let scan_result = scanner::scan_all_sources(home_dir, sources);\n    let mut all_messages: Vec\u003cUnifiedMessage\u003e = Vec::new();\n\n    let opencode_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .opencode_files\n        .par_iter()\n        .filter_map(|path| {\n            let mut msg = sessions::opencode::parse_opencode_file(path)?;\n            msg.cost = pricing.calculate_cost(\n                \u0026msg.model_id,\n                msg.tokens.input,\n                msg.tokens.output,\n                msg.tokens.cache_read,\n                msg.tokens.cache_write,\n                msg.tokens.reasoning,\n            );\n            Some(msg)\n        })\n        .collect();\n    all_messages.extend(opencode_messages);\n\n    let claude_messages_raw: Vec\u003c(String, UnifiedMessage)\u003e = scan_result\n        .claude_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::claudecode::parse_claude_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    let dedup_key = msg.dedup_key.clone().unwrap_or_default();\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    (dedup_key, msg)\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n\n    let mut seen_keys: HashSet\u003cString\u003e = HashSet::new();\n    let claude_messages: Vec\u003cUnifiedMessage\u003e = claude_messages_raw\n        .into_iter()\n        .filter(|(key, _)| key.is_empty() || seen_keys.insert(key.clone()))\n        .map(|(_, msg)| msg)\n        .collect();\n    all_messages.extend(claude_messages);\n\n    let codex_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .codex_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::codex::parse_codex_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(codex_messages);\n\n    let gemini_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .gemini_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::gemini::parse_gemini_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output + msg.tokens.reasoning,\n                        0,\n                        0,\n                        0,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(gemini_messages);\n\n    let cursor_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .cursor_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::cursor::parse_cursor_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    let csv_cost = msg.cost;\n                    let calculated_cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg.cost = if calculated_cost \u003e 0.0 {\n                        calculated_cost\n                    } else {\n                        csv_cost\n                    };\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(cursor_messages);\n\n    let amp_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .amp_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::amp::parse_amp_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    let credits = msg.cost;\n                    let calculated_cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg.cost = if calculated_cost \u003e 0.0 {\n                        calculated_cost\n                    } else {\n                        credits\n                    };\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(amp_messages);\n\n    let droid_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .droid_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::droid::parse_droid_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(droid_messages);\n\n    let openclaw_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .openclaw_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::openclaw::parse_openclaw_index(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(openclaw_messages);\n\n    let pi_messages: Vec\u003cUnifiedMessage\u003e = scan_result\n        .pi_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::pi::parse_pi_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    msg.cost = pricing.calculate_cost(\n                        \u0026msg.model_id,\n                        msg.tokens.input,\n                        msg.tokens.output,\n                        msg.tokens.cache_read,\n                        msg.tokens.cache_write,\n                        msg.tokens.reasoning,\n                    );\n                    msg\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    all_messages.extend(pi_messages);\n\n    all_messages\n}\n\npub async fn get_model_report(options: ReportOptions) -\u003e Result\u003cModelReport, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"cursor\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let pricing = pricing::PricingService::get_or_init().await?;\n    let all_messages = parse_all_messages_with_pricing(\u0026home_dir, \u0026sources, \u0026pricing);\n\n    let filtered = filter_messages_for_report(all_messages, \u0026options);\n\n    let mut model_map: HashMap\u003cString, ModelUsage\u003e = HashMap::new();\n    let group_by = \u0026options.group_by;\n\n    for msg in filtered {\n        let normalized = normalize_model_for_grouping(\u0026msg.model_id);\n        let key = match group_by {\n            GroupBy::Model =\u003e normalized.clone(),\n            GroupBy::ClientModel =\u003e format!(\"{}:{}\", msg.source, normalized),\n            GroupBy::ClientProviderModel =\u003e {\n                format!(\"{}:{}:{}\", msg.source, msg.provider_id, normalized)\n            }\n        };\n        let entry = model_map.entry(key).or_insert_with(|| ModelUsage {\n            source: msg.source.clone(),\n            merged_clients: if *group_by == GroupBy::Model {\n                Some(msg.source.clone())\n            } else {\n                None\n            },\n            model: normalized.clone(),\n            provider: msg.provider_id.clone(),\n            input: 0,\n            output: 0,\n            cache_read: 0,\n            cache_write: 0,\n            reasoning: 0,\n            message_count: 0,\n            cost: 0.0,\n        });\n\n        if *group_by == GroupBy::Model {\n            if !entry.source.split(\", \").any(|s| s == msg.source) {\n                entry.source = format!(\"{}, {}\", entry.source, msg.source);\n            }\n\n            if let Some(merged_clients) = \u0026mut entry.merged_clients {\n                if !merged_clients.split(\", \").any(|s| s == msg.source) {\n                    *merged_clients = format!(\"{}, {}\", merged_clients, msg.source);\n                }\n            }\n        }\n\n        if *group_by != GroupBy::ClientProviderModel {\n            if !entry.provider.split(\", \").any(|p| p == msg.provider_id) {\n                entry.provider = format!(\"{}, {}\", entry.provider, msg.provider_id);\n            }\n        }\n\n        entry.input += msg.tokens.input;\n        entry.output += msg.tokens.output;\n        entry.cache_read += msg.tokens.cache_read;\n        entry.cache_write += msg.tokens.cache_write;\n        entry.reasoning += msg.tokens.reasoning;\n        entry.message_count += 1;\n        entry.cost += msg.cost;\n    }\n\n    let mut entries: Vec\u003cModelUsage\u003e = model_map\n        .into_values()\n        .map(|mut entry| {\n            // Normalize provider order for deterministic output\n            let mut providers: Vec\u003c\u0026str\u003e = entry.provider.split(\", \").collect();\n            providers.sort_unstable();\n            providers.dedup();\n            entry.provider = providers.join(\", \");\n            entry\n        })\n        .collect();\n    entries.sort_by(|a, b| match (a.cost.is_nan(), b.cost.is_nan()) {\n        (true, true) =\u003e std::cmp::Ordering::Equal,\n        (true, false) =\u003e std::cmp::Ordering::Greater,\n        (false, true) =\u003e std::cmp::Ordering::Less,\n        (false, false) =\u003e b\n            .cost\n            .partial_cmp(\u0026a.cost)\n            .unwrap_or(std::cmp::Ordering::Equal),\n    });\n\n    let total_input: i64 = entries.iter().map(|e| e.input).sum();\n    let total_output: i64 = entries.iter().map(|e| e.output).sum();\n    let total_cache_read: i64 = entries.iter().map(|e| e.cache_read).sum();\n    let total_cache_write: i64 = entries.iter().map(|e| e.cache_write).sum();\n    let total_messages: i32 = entries.iter().map(|e| e.message_count).sum();\n    let total_cost: f64 = entries.iter().map(|e| e.cost).sum();\n\n    Ok(ModelReport {\n        entries,\n        total_input,\n        total_output,\n        total_cache_read,\n        total_cache_write,\n        total_messages,\n        total_cost,\n        processing_time_ms: start.elapsed().as_millis() as u32,\n    })\n}\n\n#[derive(Default)]\nstruct MonthAggregator {\n    models: HashSet\u003cString\u003e,\n    input: i64,\n    output: i64,\n    cache_read: i64,\n    cache_write: i64,\n    message_count: i32,\n    cost: f64,\n}\n\npub async fn get_monthly_report(options: ReportOptions) -\u003e Result\u003cMonthlyReport, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"cursor\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let pricing = pricing::PricingService::get_or_init().await?;\n    let all_messages = parse_all_messages_with_pricing(\u0026home_dir, \u0026sources, \u0026pricing);\n\n    let filtered = filter_messages_for_report(all_messages, \u0026options);\n\n    let mut month_map: HashMap\u003cString, MonthAggregator\u003e = HashMap::new();\n\n    for msg in filtered {\n        let month = if msg.date.len() \u003e= 7 {\n            msg.date[..7].to_string()\n        } else {\n            continue;\n        };\n\n        let entry = month_map.entry(month).or_default();\n\n        entry\n            .models\n            .insert(normalize_model_for_grouping(\u0026msg.model_id));\n        entry.input += msg.tokens.input;\n        entry.output += msg.tokens.output;\n        entry.cache_read += msg.tokens.cache_read;\n        entry.cache_write += msg.tokens.cache_write;\n        entry.message_count += 1;\n        entry.cost += msg.cost;\n    }\n\n    let mut entries: Vec\u003cMonthlyUsage\u003e = month_map\n        .into_iter()\n        .map(|(month, agg)| MonthlyUsage {\n            month,\n            models: agg.models.into_iter().collect(),\n            input: agg.input,\n            output: agg.output,\n            cache_read: agg.cache_read,\n            cache_write: agg.cache_write,\n            message_count: agg.message_count,\n            cost: agg.cost,\n        })\n        .collect();\n\n    entries.sort_by(|a, b| a.month.cmp(\u0026b.month));\n\n    let total_cost: f64 = entries.iter().map(|e| e.cost).sum();\n\n    Ok(MonthlyReport {\n        entries,\n        total_cost,\n        processing_time_ms: start.elapsed().as_millis() as u32,\n    })\n}\n\npub async fn generate_graph(options: ReportOptions) -\u003e Result\u003cGraphResult, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"cursor\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let pricing = pricing::PricingService::get_or_init().await?;\n    let all_messages = parse_all_messages_with_pricing(\u0026home_dir, \u0026sources, \u0026pricing);\n\n    let filtered = filter_messages_for_report(all_messages, \u0026options);\n\n    let contributions = aggregator::aggregate_by_date(filtered);\n\n    let processing_time_ms = start.elapsed().as_millis() as u32;\n    let result = aggregator::generate_graph_result(contributions, processing_time_ms);\n\n    Ok(result)\n}\n\nfn filter_messages_for_report(\n    messages: Vec\u003cUnifiedMessage\u003e,\n    options: \u0026ReportOptions,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let mut filtered = messages;\n\n    if let Some(year) = \u0026options.year {\n        let year_prefix = format!(\"{}-\", year);\n        filtered.retain(|m| m.date.starts_with(\u0026year_prefix));\n    }\n\n    if let Some(since) = \u0026options.since {\n        filtered.retain(|m| m.date.as_str() \u003e= since.as_str());\n    }\n\n    if let Some(until) = \u0026options.until {\n        filtered.retain(|m| m.date.as_str() \u003c= until.as_str());\n    }\n\n    filtered\n}\n\nfn is_headless_path(path: \u0026Path, headless_roots: \u0026[PathBuf]) -\u003e bool {\n    headless_roots.iter().any(|root| path.starts_with(root))\n}\n\nfn apply_headless_agent(message: \u0026mut UnifiedMessage, is_headless: bool) {\n    if is_headless \u0026\u0026 message.agent.is_none() {\n        message.agent = Some(\"headless\".to_string());\n    }\n}\n\npub fn parse_local_sources(options: LocalParseOptions) -\u003e Result\u003cParsedMessages, String\u003e {\n    let start = Instant::now();\n\n    let home_dir = get_home_dir_string(\u0026options.home_dir)?;\n\n    let sources = options.sources.clone().unwrap_or_else(|| {\n        vec![\n            \"opencode\".to_string(),\n            \"claude\".to_string(),\n            \"codex\".to_string(),\n            \"gemini\".to_string(),\n            \"amp\".to_string(),\n            \"droid\".to_string(),\n            \"openclaw\".to_string(),\n            \"pi\".to_string(),\n        ]\n    });\n\n    let local_sources: Vec\u003cString\u003e = sources.into_iter().filter(|s| s != \"cursor\").collect();\n\n    let scan_result = scanner::scan_all_sources(\u0026home_dir, \u0026local_sources);\n    let headless_roots = scanner::headless_roots(\u0026home_dir);\n\n    let mut messages: Vec\u003cParsedMessage\u003e = Vec::new();\n\n    let opencode_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .opencode_files\n        .par_iter()\n        .filter_map(|path| {\n            let msg = sessions::opencode::parse_opencode_file(path)?;\n            Some(unified_to_parsed(\u0026msg))\n        })\n        .collect();\n    let opencode_count = opencode_msgs.len() as i32;\n    messages.extend(opencode_msgs);\n\n    let claude_msgs_raw: Vec\u003c(String, ParsedMessage)\u003e = scan_result\n        .claude_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::claudecode::parse_claude_file(path)\n                .into_iter()\n                .map(|msg| {\n                    let dedup_key = msg.dedup_key.clone().unwrap_or_default();\n                    (dedup_key, unified_to_parsed(\u0026msg))\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n\n    let mut seen_keys: HashSet\u003cString\u003e = HashSet::new();\n    let claude_msgs: Vec\u003cParsedMessage\u003e = claude_msgs_raw\n        .into_iter()\n        .filter(|(key, _)| key.is_empty() || seen_keys.insert(key.clone()))\n        .map(|(_, msg)| msg)\n        .collect();\n    let claude_count = claude_msgs.len() as i32;\n    messages.extend(claude_msgs);\n\n    let codex_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .codex_files\n        .par_iter()\n        .flat_map(|path| {\n            let is_headless = is_headless_path(path, \u0026headless_roots);\n            sessions::codex::parse_codex_file(path)\n                .into_iter()\n                .map(|mut msg| {\n                    apply_headless_agent(\u0026mut msg, is_headless);\n                    unified_to_parsed(\u0026msg)\n                })\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let codex_count = codex_msgs.len() as i32;\n    messages.extend(codex_msgs);\n\n    let gemini_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .gemini_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::gemini::parse_gemini_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let gemini_count = gemini_msgs.len() as i32;\n    messages.extend(gemini_msgs);\n\n    let amp_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .amp_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::amp::parse_amp_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let amp_count = amp_msgs.len() as i32;\n    messages.extend(amp_msgs);\n\n    let droid_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .droid_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::droid::parse_droid_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let droid_count = droid_msgs.len() as i32;\n    messages.extend(droid_msgs);\n\n    let openclaw_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .openclaw_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::openclaw::parse_openclaw_index(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let openclaw_count = openclaw_msgs.len() as i32;\n    messages.extend(openclaw_msgs);\n\n    let pi_msgs: Vec\u003cParsedMessage\u003e = scan_result\n        .pi_files\n        .par_iter()\n        .flat_map(|path| {\n            sessions::pi::parse_pi_file(path)\n                .into_iter()\n                .map(|msg| unified_to_parsed(\u0026msg))\n                .collect::\u003cVec\u003c_\u003e\u003e()\n        })\n        .collect();\n    let pi_count = pi_msgs.len() as i32;\n    messages.extend(pi_msgs);\n\n    let filtered = filter_parsed_messages(messages, \u0026options);\n\n    Ok(ParsedMessages {\n        messages: filtered,\n        opencode_count,\n        claude_count,\n        codex_count,\n        gemini_count,\n        amp_count,\n        droid_count,\n        openclaw_count,\n        pi_count,\n        processing_time_ms: start.elapsed().as_millis() as u32,\n    })\n}\n\nfn unified_to_parsed(msg: \u0026UnifiedMessage) -\u003e ParsedMessage {\n    ParsedMessage {\n        source: msg.source.clone(),\n        model_id: msg.model_id.clone(),\n        provider_id: msg.provider_id.clone(),\n        session_id: msg.session_id.clone(),\n        timestamp: msg.timestamp,\n        date: msg.date.clone(),\n        input: msg.tokens.input,\n        output: msg.tokens.output,\n        cache_read: msg.tokens.cache_read,\n        cache_write: msg.tokens.cache_write,\n        reasoning: msg.tokens.reasoning,\n        agent: msg.agent.clone(),\n    }\n}\n\nfn filter_parsed_messages(\n    messages: Vec\u003cParsedMessage\u003e,\n    options: \u0026LocalParseOptions,\n) -\u003e Vec\u003cParsedMessage\u003e {\n    let mut filtered = messages;\n\n    if let Some(year) = \u0026options.year {\n        let year_prefix = format!(\"{}-\", year);\n        filtered.retain(|m| m.date.starts_with(\u0026year_prefix));\n    }\n\n    if let Some(since) = \u0026options.since {\n        filtered.retain(|m| m.date.as_str() \u003e= since.as_str());\n    }\n\n    if let Some(until) = \u0026options.until {\n        filtered.retain(|m| m.date.as_str() \u003c= until.as_str());\n    }\n\n    filtered\n}\n\npub fn parsed_to_unified(msg: \u0026ParsedMessage, cost: f64) -\u003e UnifiedMessage {\n    UnifiedMessage {\n        source: msg.source.clone(),\n        model_id: msg.model_id.clone(),\n        provider_id: msg.provider_id.clone(),\n        session_id: msg.session_id.clone(),\n        timestamp: msg.timestamp,\n        date: msg.date.clone(),\n        tokens: TokenBreakdown {\n            input: msg.input,\n            output: msg.output,\n            cache_read: msg.cache_read,\n            cache_write: msg.cache_write,\n            reasoning: msg.reasoning,\n        },\n        cost,\n        agent: msg.agent.clone(),\n        dedup_key: None,\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::{normalize_model_for_grouping, GroupBy};\n    use std::str::FromStr;\n\n    #[test]\n    fn test_normalize_model_for_grouping() {\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4-5-20251101\"),\n            \"claude-opus-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4-5-20250929\"),\n            \"claude-sonnet-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4-20250514\"),\n            \"claude-sonnet-4\"\n        );\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4.5\"),\n            \"claude-opus-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4.5\"),\n            \"claude-sonnet-4-5\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4.6\"),\n            \"claude-opus-4-6\"\n        );\n\n        assert_eq!(normalize_model_for_grouping(\"gpt-5.2\"), \"gpt-5.2\");\n        assert_eq!(\n            normalize_model_for_grouping(\"gemini-2.5-pro\"),\n            \"gemini-2.5-pro\"\n        );\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4-5-high\"),\n            \"claude-opus-4-5-high\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4-5-thinking-high\"),\n            \"claude-opus-4-5-thinking-high\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-sonnet-4-5-high\"),\n            \"claude-sonnet-4-5-high\"\n        );\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-4-sonnet\"),\n            \"claude-4-sonnet\"\n        );\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-4-opus-thinking\"),\n            \"claude-4-opus-thinking\"\n        );\n\n        assert_eq!(normalize_model_for_grouping(\"big-pickle\"), \"big-pickle\");\n        assert_eq!(normalize_model_for_grouping(\"grok-code\"), \"grok-code\");\n\n        assert_eq!(\n            normalize_model_for_grouping(\"claude-opus-4.5-20251101\"),\n            \"claude-opus-4-5\"\n        );\n    }\n\n    #[test]\n    fn test_group_by_from_str_valid_values() {\n        assert_eq!(GroupBy::from_str(\"model\").unwrap(), GroupBy::Model);\n        assert_eq!(\n            GroupBy::from_str(\"client,model\").unwrap(),\n            GroupBy::ClientModel\n        );\n        assert_eq!(\n            GroupBy::from_str(\"client-model\").unwrap(),\n            GroupBy::ClientModel\n        );\n        assert_eq!(\n            GroupBy::from_str(\"client,provider,model\").unwrap(),\n            GroupBy::ClientProviderModel\n        );\n        assert_eq!(\n            GroupBy::from_str(\"client-provider-model\").unwrap(),\n            GroupBy::ClientProviderModel\n        );\n        assert!(GroupBy::from_str(\"unknown\").is_err());\n    }\n\n    #[test]\n    fn test_group_by_default_is_client_model() {\n        assert_eq!(GroupBy::default(), GroupBy::ClientModel);\n    }\n\n    #[test]\n    fn test_group_by_display_round_trips_with_from_str() {\n        let variants = [\n            GroupBy::Model,\n            GroupBy::ClientModel,\n            GroupBy::ClientProviderModel,\n        ];\n\n        for variant in variants {\n            let rendered = variant.to_string();\n            let parsed = GroupBy::from_str(\u0026rendered).unwrap();\n            assert_eq!(parsed, variant);\n        }\n    }\n\n    #[test]\n    fn test_group_by_from_str_whitespace_handling() {\n        assert_eq!(GroupBy::from_str(\"client, model\").unwrap(), GroupBy::ClientModel);\n        assert_eq!(GroupBy::from_str(\" model \").unwrap(), GroupBy::Model);\n        assert_eq!(GroupBy::from_str(\"client , provider , model\").unwrap(), GroupBy::ClientProviderModel);\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":16}},{"line":28,"address":[],"length":0,"stats":{"Line":48}},{"line":30,"address":[],"length":0,"stats":{"Line":16}},{"line":31,"address":[],"length":0,"stats":{"Line":42}},{"line":32,"address":[],"length":0,"stats":{"Line":118}},{"line":33,"address":[],"length":0,"stats":{"Line":12}},{"line":35,"address":[],"length":0,"stats":{"Line":12}},{"line":39,"address":[],"length":0,"stats":{"Line":16}},{"line":40,"address":[],"length":0,"stats":{"Line":48}},{"line":41,"address":[],"length":0,"stats":{"Line":48}},{"line":42,"address":[],"length":0,"stats":{"Line":229}},{"line":43,"address":[],"length":0,"stats":{"Line":217}},{"line":44,"address":[],"length":0,"stats":{"Line":4}},{"line":45,"address":[],"length":0,"stats":{"Line":8}},{"line":46,"address":[],"length":0,"stats":{"Line":8}},{"line":47,"address":[],"length":0,"stats":{"Line":8}},{"line":49,"address":[],"length":0,"stats":{"Line":4}},{"line":51,"address":[],"length":0,"stats":{"Line":639}},{"line":54,"address":[],"length":0,"stats":{"Line":24}},{"line":57,"address":[],"length":0,"stats":{"Line":16}},{"line":68,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":74,"address":[],"length":0,"stats":{"Line":3}},{"line":75,"address":[],"length":0,"stats":{"Line":3}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":86,"address":[],"length":0,"stats":{"Line":14}},{"line":87,"address":[],"length":0,"stats":{"Line":162}},{"line":88,"address":[],"length":0,"stats":{"Line":14}},{"line":89,"address":[],"length":0,"stats":{"Line":17}},{"line":90,"address":[],"length":0,"stats":{"Line":23}},{"line":91,"address":[],"length":0,"stats":{"Line":11}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":2}},{"line":275,"address":[],"length":0,"stats":{"Line":2}},{"line":277,"address":[],"length":0,"stats":{"Line":6}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":2}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":8}},{"line":290,"address":[],"length":0,"stats":{"Line":6}},{"line":292,"address":[],"length":0,"stats":{"Line":6}},{"line":293,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":605892}},{"line":296,"address":[],"length":0,"stats":{"Line":1817670}},{"line":297,"address":[],"length":0,"stats":{"Line":1339524}},{"line":298,"address":[],"length":0,"stats":{"Line":893016}},{"line":299,"address":[],"length":0,"stats":{"Line":893016}},{"line":300,"address":[],"length":0,"stats":{"Line":893016}},{"line":301,"address":[],"length":0,"stats":{"Line":893016}},{"line":302,"address":[],"length":0,"stats":{"Line":446508}},{"line":303,"address":[],"length":0,"stats":{"Line":446508}},{"line":305,"address":[],"length":0,"stats":{"Line":446508}},{"line":308,"address":[],"length":0,"stats":{"Line":6}},{"line":310,"address":[],"length":0,"stats":{"Line":6}},{"line":311,"address":[],"length":0,"stats":{"Line":2}},{"line":313,"address":[],"length":0,"stats":{"Line":1686}},{"line":314,"address":[],"length":0,"stats":{"Line":3368}},{"line":315,"address":[],"length":0,"stats":{"Line":1684}},{"line":316,"address":[],"length":0,"stats":{"Line":33058}},{"line":317,"address":[],"length":0,"stats":{"Line":125496}},{"line":318,"address":[],"length":0,"stats":{"Line":94122}},{"line":319,"address":[],"length":0,"stats":{"Line":62748}},{"line":320,"address":[],"length":0,"stats":{"Line":62748}},{"line":321,"address":[],"length":0,"stats":{"Line":62748}},{"line":322,"address":[],"length":0,"stats":{"Line":62748}},{"line":323,"address":[],"length":0,"stats":{"Line":31374}},{"line":324,"address":[],"length":0,"stats":{"Line":31374}},{"line":326,"address":[],"length":0,"stats":{"Line":31374}},{"line":328,"address":[],"length":0,"stats":{"Line":1684}},{"line":332,"address":[],"length":0,"stats":{"Line":6}},{"line":333,"address":[],"length":0,"stats":{"Line":6}},{"line":335,"address":[],"length":0,"stats":{"Line":165246}},{"line":336,"address":[],"length":0,"stats":{"Line":2}},{"line":338,"address":[],"length":0,"stats":{"Line":6}},{"line":340,"address":[],"length":0,"stats":{"Line":6}},{"line":341,"address":[],"length":0,"stats":{"Line":2}},{"line":343,"address":[],"length":0,"stats":{"Line":36}},{"line":344,"address":[],"length":0,"stats":{"Line":68}},{"line":345,"address":[],"length":0,"stats":{"Line":34}},{"line":346,"address":[],"length":0,"stats":{"Line":50}},{"line":347,"address":[],"length":0,"stats":{"Line":48}},{"line":348,"address":[],"length":0,"stats":{"Line":32}},{"line":349,"address":[],"length":0,"stats":{"Line":32}},{"line":350,"address":[],"length":0,"stats":{"Line":32}},{"line":351,"address":[],"length":0,"stats":{"Line":32}},{"line":352,"address":[],"length":0,"stats":{"Line":16}},{"line":353,"address":[],"length":0,"stats":{"Line":16}},{"line":355,"address":[],"length":0,"stats":{"Line":16}},{"line":357,"address":[],"length":0,"stats":{"Line":34}},{"line":360,"address":[],"length":0,"stats":{"Line":6}},{"line":362,"address":[],"length":0,"stats":{"Line":6}},{"line":363,"address":[],"length":0,"stats":{"Line":2}},{"line":365,"address":[],"length":0,"stats":{"Line":26}},{"line":366,"address":[],"length":0,"stats":{"Line":48}},{"line":367,"address":[],"length":0,"stats":{"Line":24}},{"line":368,"address":[],"length":0,"stats":{"Line":594}},{"line":369,"address":[],"length":0,"stats":{"Line":1710}},{"line":370,"address":[],"length":0,"stats":{"Line":1140}},{"line":371,"address":[],"length":0,"stats":{"Line":1140}},{"line":372,"address":[],"length":0,"stats":{"Line":570}},{"line":373,"address":[],"length":0,"stats":{"Line":570}},{"line":374,"address":[],"length":0,"stats":{"Line":570}},{"line":375,"address":[],"length":0,"stats":{"Line":570}},{"line":377,"address":[],"length":0,"stats":{"Line":570}},{"line":379,"address":[],"length":0,"stats":{"Line":24}},{"line":382,"address":[],"length":0,"stats":{"Line":6}},{"line":384,"address":[],"length":0,"stats":{"Line":6}},{"line":385,"address":[],"length":0,"stats":{"Line":2}},{"line":387,"address":[],"length":0,"stats":{"Line":4}},{"line":388,"address":[],"length":0,"stats":{"Line":4}},{"line":389,"address":[],"length":0,"stats":{"Line":2}},{"line":390,"address":[],"length":0,"stats":{"Line":10068}},{"line":391,"address":[],"length":0,"stats":{"Line":20132}},{"line":392,"address":[],"length":0,"stats":{"Line":30198}},{"line":393,"address":[],"length":0,"stats":{"Line":10066}},{"line":394,"address":[],"length":0,"stats":{"Line":10066}},{"line":395,"address":[],"length":0,"stats":{"Line":10066}},{"line":396,"address":[],"length":0,"stats":{"Line":10066}},{"line":397,"address":[],"length":0,"stats":{"Line":10066}},{"line":398,"address":[],"length":0,"stats":{"Line":10066}},{"line":400,"address":[],"length":0,"stats":{"Line":10066}},{"line":401,"address":[],"length":0,"stats":{"Line":5890}},{"line":403,"address":[],"length":0,"stats":{"Line":4176}},{"line":405,"address":[],"length":0,"stats":{"Line":10066}},{"line":407,"address":[],"length":0,"stats":{"Line":2}},{"line":410,"address":[],"length":0,"stats":{"Line":6}},{"line":412,"address":[],"length":0,"stats":{"Line":6}},{"line":413,"address":[],"length":0,"stats":{"Line":2}},{"line":415,"address":[],"length":0,"stats":{"Line":6}},{"line":416,"address":[],"length":0,"stats":{"Line":8}},{"line":417,"address":[],"length":0,"stats":{"Line":4}},{"line":418,"address":[],"length":0,"stats":{"Line":234}},{"line":419,"address":[],"length":0,"stats":{"Line":460}},{"line":420,"address":[],"length":0,"stats":{"Line":690}},{"line":421,"address":[],"length":0,"stats":{"Line":230}},{"line":422,"address":[],"length":0,"stats":{"Line":230}},{"line":423,"address":[],"length":0,"stats":{"Line":230}},{"line":424,"address":[],"length":0,"stats":{"Line":230}},{"line":425,"address":[],"length":0,"stats":{"Line":230}},{"line":426,"address":[],"length":0,"stats":{"Line":230}},{"line":428,"address":[],"length":0,"stats":{"Line":230}},{"line":429,"address":[],"length":0,"stats":{"Line":230}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":230}},{"line":435,"address":[],"length":0,"stats":{"Line":4}},{"line":438,"address":[],"length":0,"stats":{"Line":6}},{"line":440,"address":[],"length":0,"stats":{"Line":6}},{"line":441,"address":[],"length":0,"stats":{"Line":2}},{"line":443,"address":[],"length":0,"stats":{"Line":4}},{"line":444,"address":[],"length":0,"stats":{"Line":4}},{"line":445,"address":[],"length":0,"stats":{"Line":2}},{"line":446,"address":[],"length":0,"stats":{"Line":4}},{"line":447,"address":[],"length":0,"stats":{"Line":6}},{"line":448,"address":[],"length":0,"stats":{"Line":4}},{"line":449,"address":[],"length":0,"stats":{"Line":4}},{"line":450,"address":[],"length":0,"stats":{"Line":4}},{"line":451,"address":[],"length":0,"stats":{"Line":4}},{"line":452,"address":[],"length":0,"stats":{"Line":2}},{"line":453,"address":[],"length":0,"stats":{"Line":2}},{"line":455,"address":[],"length":0,"stats":{"Line":2}},{"line":457,"address":[],"length":0,"stats":{"Line":2}},{"line":460,"address":[],"length":0,"stats":{"Line":6}},{"line":462,"address":[],"length":0,"stats":{"Line":6}},{"line":463,"address":[],"length":0,"stats":{"Line":2}},{"line":465,"address":[],"length":0,"stats":{"Line":4}},{"line":466,"address":[],"length":0,"stats":{"Line":4}},{"line":467,"address":[],"length":0,"stats":{"Line":2}},{"line":468,"address":[],"length":0,"stats":{"Line":2526}},{"line":469,"address":[],"length":0,"stats":{"Line":7572}},{"line":470,"address":[],"length":0,"stats":{"Line":5048}},{"line":471,"address":[],"length":0,"stats":{"Line":5048}},{"line":472,"address":[],"length":0,"stats":{"Line":5048}},{"line":473,"address":[],"length":0,"stats":{"Line":5048}},{"line":474,"address":[],"length":0,"stats":{"Line":2524}},{"line":475,"address":[],"length":0,"stats":{"Line":2524}},{"line":477,"address":[],"length":0,"stats":{"Line":2524}},{"line":479,"address":[],"length":0,"stats":{"Line":2}},{"line":482,"address":[],"length":0,"stats":{"Line":6}},{"line":484,"address":[],"length":0,"stats":{"Line":6}},{"line":485,"address":[],"length":0,"stats":{"Line":2}},{"line":487,"address":[],"length":0,"stats":{"Line":8}},{"line":488,"address":[],"length":0,"stats":{"Line":12}},{"line":489,"address":[],"length":0,"stats":{"Line":6}},{"line":490,"address":[],"length":0,"stats":{"Line":26}},{"line":491,"address":[],"length":0,"stats":{"Line":60}},{"line":492,"address":[],"length":0,"stats":{"Line":40}},{"line":493,"address":[],"length":0,"stats":{"Line":40}},{"line":494,"address":[],"length":0,"stats":{"Line":40}},{"line":495,"address":[],"length":0,"stats":{"Line":40}},{"line":496,"address":[],"length":0,"stats":{"Line":20}},{"line":497,"address":[],"length":0,"stats":{"Line":20}},{"line":499,"address":[],"length":0,"stats":{"Line":20}},{"line":501,"address":[],"length":0,"stats":{"Line":6}},{"line":504,"address":[],"length":0,"stats":{"Line":6}},{"line":506,"address":[],"length":0,"stats":{"Line":2}},{"line":509,"address":[],"length":0,"stats":{"Line":4}},{"line":510,"address":[],"length":0,"stats":{"Line":4}},{"line":512,"address":[],"length":0,"stats":{"Line":6}},{"line":514,"address":[],"length":0,"stats":{"Line":10}},{"line":515,"address":[],"length":0,"stats":{"Line":2}},{"line":516,"address":[],"length":0,"stats":{"Line":4}},{"line":517,"address":[],"length":0,"stats":{"Line":4}},{"line":518,"address":[],"length":0,"stats":{"Line":4}},{"line":519,"address":[],"length":0,"stats":{"Line":4}},{"line":520,"address":[],"length":0,"stats":{"Line":4}},{"line":521,"address":[],"length":0,"stats":{"Line":4}},{"line":522,"address":[],"length":0,"stats":{"Line":4}},{"line":523,"address":[],"length":0,"stats":{"Line":4}},{"line":524,"address":[],"length":0,"stats":{"Line":4}},{"line":528,"address":[],"length":0,"stats":{"Line":4}},{"line":529,"address":[],"length":0,"stats":{"Line":10}},{"line":531,"address":[],"length":0,"stats":{"Line":8}},{"line":533,"address":[],"length":0,"stats":{"Line":6}},{"line":534,"address":[],"length":0,"stats":{"Line":4}},{"line":536,"address":[],"length":0,"stats":{"Line":2}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":6}},{"line":592,"address":[],"length":0,"stats":{"Line":2}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":4}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":10}},{"line":612,"address":[],"length":0,"stats":{"Line":10}},{"line":613,"address":[],"length":0,"stats":{"Line":10}},{"line":614,"address":[],"length":0,"stats":{"Line":10}},{"line":615,"address":[],"length":0,"stats":{"Line":10}},{"line":616,"address":[],"length":0,"stats":{"Line":10}},{"line":618,"address":[],"length":0,"stats":{"Line":2}},{"line":619,"address":[],"length":0,"stats":{"Line":4}},{"line":620,"address":[],"length":0,"stats":{"Line":4}},{"line":621,"address":[],"length":0,"stats":{"Line":4}},{"line":622,"address":[],"length":0,"stats":{"Line":4}},{"line":623,"address":[],"length":0,"stats":{"Line":4}},{"line":624,"address":[],"length":0,"stats":{"Line":4}},{"line":625,"address":[],"length":0,"stats":{"Line":4}},{"line":626,"address":[],"length":0,"stats":{"Line":2}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":671,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":708,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":2}},{"line":748,"address":[],"length":0,"stats":{"Line":4}},{"line":750,"address":[],"length":0,"stats":{"Line":3}},{"line":751,"address":[],"length":0,"stats":{"Line":2}},{"line":752,"address":[],"length":0,"stats":{"Line":730313}},{"line":755,"address":[],"length":0,"stats":{"Line":3}},{"line":756,"address":[],"length":0,"stats":{"Line":486876}},{"line":759,"address":[],"length":0,"stats":{"Line":2}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":2}},{"line":766,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":788,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":812,"address":[],"length":0,"stats":{"Line":0}},{"line":813,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":836,"address":[],"length":0,"stats":{"Line":0}},{"line":838,"address":[],"length":0,"stats":{"Line":0}},{"line":839,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":853,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":0}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[],"length":0,"stats":{"Line":0}},{"line":862,"address":[],"length":0,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":865,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":868,"address":[],"length":0,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":881,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":885,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":889,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":902,"address":[],"length":0,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":907,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":914,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":919,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[],"length":0,"stats":{"Line":0}},{"line":925,"address":[],"length":0,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":927,"address":[],"length":0,"stats":{"Line":0}},{"line":928,"address":[],"length":0,"stats":{"Line":0}},{"line":929,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":937,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":941,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":0}},{"line":957,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[],"length":0,"stats":{"Line":0}},{"line":961,"address":[],"length":0,"stats":{"Line":0}},{"line":962,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":966,"address":[],"length":0,"stats":{"Line":0}},{"line":969,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":977,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":988,"address":[],"length":0,"stats":{"Line":0}}],"covered":245,"coverable":508},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","parser.rs"],"content":"//! SIMD-accelerated JSON parser\n//!\n//! Uses simd-json for fast JSON parsing with SIMD instructions.\n\nuse std::fs;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Parse a JSON file using SIMD-accelerated parsing\npub fn parse_json_file\u003cT: serde::de::DeserializeOwned\u003e(path: \u0026Path) -\u003e Result\u003cT, ParseError\u003e {\n    let mut data = fs::read(path).map_err(|e| ParseError::IoError(e.to_string()))?;\n\n    simd_json::from_slice(\u0026mut data).map_err(|e| ParseError::JsonError(e.to_string()))\n}\n\n/// Parse a JSONL file (one JSON object per line)\npub fn parse_jsonl_file\u003cT, F\u003e(path: \u0026Path, mut process: F) -\u003e Result\u003c(), ParseError\u003e\nwhere\n    T: serde::de::DeserializeOwned,\n    F: FnMut(T),\n{\n    let file = fs::File::open(path).map_err(|e| ParseError::IoError(e.to_string()))?;\n    let reader = BufReader::new(file);\n\n    for line in reader.lines() {\n        let line = line.map_err(|e| ParseError::IoError(e.to_string()))?;\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        match simd_json::from_slice::\u003cT\u003e(\u0026mut bytes) {\n            Ok(value) =\u003e process(value),\n            Err(_) =\u003e continue, // Skip malformed lines (match TypeScript behavior)\n        }\n    }\n\n    Ok(())\n}\n\n/// Parse error types\n#[derive(Debug, thiserror::Error)]\npub enum ParseError {\n    #[error(\"IO error: {0}\")]\n    IoError(String),\n\n    #[error(\"JSON parse error: {0}\")]\n    JsonError(String),\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde::Deserialize;\n    use std::fs::File;\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    #[derive(Debug, Deserialize, PartialEq)]\n    struct TestStruct {\n        name: String,\n        value: i32,\n    }\n\n    #[derive(Debug, Deserialize, PartialEq)]\n    struct NestedStruct {\n        id: String,\n        data: InnerData,\n    }\n\n    #[derive(Debug, Deserialize, PartialEq)]\n    struct InnerData {\n        tokens: i64,\n        cost: f64,\n    }\n\n    #[test]\n    fn test_parse_json_file_simple() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"test.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(br#\"{\"name\": \"test\", \"value\": 42}\"#).unwrap();\n\n        let result: TestStruct = parse_json_file(\u0026file_path).unwrap();\n        assert_eq!(result.name, \"test\");\n        assert_eq!(result.value, 42);\n    }\n\n    #[test]\n    fn test_parse_json_file_nested() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"nested.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(br#\"{\"id\": \"session-001\", \"data\": {\"tokens\": 1000, \"cost\": 0.05}}\"#)\n            .unwrap();\n\n        let result: NestedStruct = parse_json_file(\u0026file_path).unwrap();\n        assert_eq!(result.id, \"session-001\");\n        assert_eq!(result.data.tokens, 1000);\n        assert_eq!(result.data.cost, 0.05);\n    }\n\n    #[test]\n    fn test_parse_json_file_unicode() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"unicode.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(r#\"{\"name\": \"í…ŒìŠ¤íŠ¸\", \"value\": 100}\"#.as_bytes())\n            .unwrap();\n\n        let result: TestStruct = parse_json_file(\u0026file_path).unwrap();\n        assert_eq!(result.name, \"í…ŒìŠ¤íŠ¸\");\n        assert_eq!(result.value, 100);\n    }\n\n    #[test]\n    fn test_parse_json_file_not_found() {\n        let result: Result\u003cTestStruct, _\u003e = parse_json_file(Path::new(\"/nonexistent/file.json\"));\n        assert!(matches!(result, Err(ParseError::IoError(_))));\n    }\n\n    #[test]\n    fn test_parse_json_file_invalid_json() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"invalid.json\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        file.write_all(b\"not valid json {\").unwrap();\n\n        let result: Result\u003cTestStruct, _\u003e = parse_json_file(\u0026file_path);\n        assert!(matches!(result, Err(ParseError::JsonError(_))));\n    }\n\n    #[test]\n    fn test_parse_json_file_empty() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"empty.json\");\n\n        File::create(\u0026file_path).unwrap();\n\n        let result: Result\u003cTestStruct, _\u003e = parse_json_file(\u0026file_path);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_basic() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"test.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, r#\"{{\"name\": \"first\", \"value\": 1}}\"#).unwrap();\n        writeln!(file, r#\"{{\"name\": \"second\", \"value\": 2}}\"#).unwrap();\n        writeln!(file, r#\"{{\"name\": \"third\", \"value\": 3}}\"#).unwrap();\n\n        let mut results: Vec\u003cTestStruct\u003e = Vec::new();\n        parse_jsonl_file(\u0026file_path, |item: TestStruct| {\n            results.push(item);\n        })\n        .unwrap();\n\n        assert_eq!(results.len(), 3);\n        assert_eq!(results[0].name, \"first\");\n        assert_eq!(results[1].value, 2);\n        assert_eq!(results[2].name, \"third\");\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_with_empty_lines() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"with_empty.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, r#\"{{\"name\": \"a\", \"value\": 1}}\"#).unwrap();\n        writeln!(file, \"\").unwrap(); // Empty line\n        writeln!(file, \"   \").unwrap(); // Whitespace only\n        writeln!(file, r#\"{{\"name\": \"b\", \"value\": 2}}\"#).unwrap();\n\n        let mut results: Vec\u003cTestStruct\u003e = Vec::new();\n        parse_jsonl_file(\u0026file_path, |item: TestStruct| {\n            results.push(item);\n        })\n        .unwrap();\n\n        assert_eq!(results.len(), 2);\n        assert_eq!(results[0].name, \"a\");\n        assert_eq!(results[1].name, \"b\");\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_with_malformed_lines() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"malformed.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, r#\"{{\"name\": \"good\", \"value\": 1}}\"#).unwrap();\n        writeln!(file, \"not valid json\").unwrap(); // Should be skipped\n        writeln!(file, r#\"{{\"incomplete\"#).unwrap(); // Should be skipped\n        writeln!(file, r#\"{{\"name\": \"also good\", \"value\": 2}}\"#).unwrap();\n\n        let mut results: Vec\u003cTestStruct\u003e = Vec::new();\n        parse_jsonl_file(\u0026file_path, |item: TestStruct| {\n            results.push(item);\n        })\n        .unwrap();\n\n        // Only valid lines should be parsed\n        assert_eq!(results.len(), 2);\n        assert_eq!(results[0].name, \"good\");\n        assert_eq!(results[1].name, \"also good\");\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_empty() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"empty.jsonl\");\n\n        File::create(\u0026file_path).unwrap();\n\n        let mut count = 0;\n        parse_jsonl_file(\u0026file_path, |_: TestStruct| {\n            count += 1;\n        })\n        .unwrap();\n\n        assert_eq!(count, 0);\n    }\n\n    #[test]\n    fn test_parse_jsonl_file_not_found() {\n        let result = parse_jsonl_file(Path::new(\"/nonexistent/file.jsonl\"), |_: TestStruct| {});\n        assert!(matches!(result, Err(ParseError::IoError(_))));\n    }\n\n    #[test]\n    fn test_parse_jsonl_large_file() {\n        let dir = TempDir::new().unwrap();\n        let file_path = dir.path().join(\"large.jsonl\");\n\n        let mut file = File::create(\u0026file_path).unwrap();\n        for i in 0..1000 {\n            writeln!(file, r#\"{{\"name\": \"item-{}\", \"value\": {}}}\"#, i, i).unwrap();\n        }\n\n        let mut count = 0;\n        parse_jsonl_file(\u0026file_path, |_: TestStruct| {\n            count += 1;\n        })\n        .unwrap();\n\n        assert_eq!(count, 1000);\n    }\n\n    #[test]\n    fn test_parse_error_display() {\n        let io_error = ParseError::IoError(\"file not found\".to_string());\n        assert!(io_error.to_string().contains(\"IO error\"));\n\n        let json_error = ParseError::JsonError(\"unexpected token\".to_string());\n        assert!(json_error.to_string().contains(\"JSON parse error\"));\n    }\n}\n","traces":[{"line":10,"address":[],"length":0,"stats":{"Line":6}},{"line":11,"address":[],"length":0,"stats":{"Line":26}},{"line":13,"address":[],"length":0,"stats":{"Line":19}},{"line":17,"address":[],"length":0,"stats":{"Line":6}},{"line":22,"address":[],"length":0,"stats":{"Line":26}},{"line":23,"address":[],"length":0,"stats":{"Line":15}},{"line":25,"address":[],"length":0,"stats":{"Line":1021}},{"line":26,"address":[],"length":0,"stats":{"Line":3033}},{"line":27,"address":[],"length":0,"stats":{"Line":2022}},{"line":28,"address":[],"length":0,"stats":{"Line":2022}},{"line":29,"address":[],"length":0,"stats":{"Line":2}},{"line":32,"address":[],"length":0,"stats":{"Line":3027}},{"line":33,"address":[],"length":0,"stats":{"Line":1009}},{"line":34,"address":[],"length":0,"stats":{"Line":2014}},{"line":35,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":5}}],"covered":16,"coverable":16},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","aliases.rs"],"content":"use once_cell::sync::Lazy;\nuse std::collections::HashMap;\n\nstatic MODEL_ALIASES: Lazy\u003cHashMap\u003c\u0026'static str, \u0026'static str\u003e\u003e = Lazy::new(|| {\n    let mut m = HashMap::new();\n    m.insert(\"big-pickle\", \"glm-4.7\");\n    m.insert(\"big pickle\", \"glm-4.7\");\n    m.insert(\"bigpickle\", \"glm-4.7\");\n    m.insert(\"k2p5\", \"kimi-k2-thinking\");\n    m.insert(\"k2-p5\", \"kimi-k2-thinking\");\n    m.insert(\"kimi-k2.5-thinking\", \"kimi-k2-thinking\");\n    m\n});\n\npub fn resolve_alias(model_id: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    MODEL_ALIASES.get(model_id.to_lowercase().as_str()).copied()\n}\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":3}},{"line":5,"address":[],"length":0,"stats":{"Line":6}},{"line":6,"address":[],"length":0,"stats":{"Line":6}},{"line":7,"address":[],"length":0,"stats":{"Line":12}},{"line":8,"address":[],"length":0,"stats":{"Line":12}},{"line":9,"address":[],"length":0,"stats":{"Line":12}},{"line":10,"address":[],"length":0,"stats":{"Line":12}},{"line":11,"address":[],"length":0,"stats":{"Line":12}},{"line":12,"address":[],"length":0,"stats":{"Line":3}},{"line":15,"address":[],"length":0,"stats":{"Line":225}},{"line":16,"address":[],"length":0,"stats":{"Line":900}}],"covered":11,"coverable":11},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","cache.rs"],"content":"use serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::path::PathBuf;\nuse std::time::SystemTime;\n\nconst CACHE_TTL_SECS: u64 = 3600;\n\npub fn get_cache_dir() -\u003e PathBuf {\n    dirs::cache_dir()\n        .unwrap_or_else(|| PathBuf::from(\"/tmp\"))\n        .join(\"tokscale\")\n}\n\npub fn get_cache_path(filename: \u0026str) -\u003e PathBuf {\n    get_cache_dir().join(filename)\n}\n\n#[derive(Serialize, Deserialize)]\npub struct CachedData\u003cT\u003e {\n    pub timestamp: u64,\n    pub data: T,\n}\n\npub fn load_cache\u003cT: for\u003c'de\u003e Deserialize\u003c'de\u003e\u003e(filename: \u0026str) -\u003e Option\u003cT\u003e {\n    let path = get_cache_path(filename);\n    let content = fs::read_to_string(\u0026path).ok()?;\n    let cached: CachedData\u003cT\u003e = serde_json::from_str(\u0026content).ok()?;\n\n    let now = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .ok()?\n        .as_secs();\n\n    if cached.timestamp \u003e now || now.saturating_sub(cached.timestamp) \u003e CACHE_TTL_SECS {\n        return None;\n    }\n\n    Some(cached.data)\n}\n\npub fn save_cache\u003cT: Serialize\u003e(filename: \u0026str, data: \u0026T) -\u003e Result\u003c(), std::io::Error\u003e {\n    let dir = get_cache_dir();\n    fs::create_dir_all(\u0026dir)?;\n\n    let now = SystemTime::now()\n        .duration_since(SystemTime::UNIX_EPOCH)\n        .unwrap_or(std::time::Duration::ZERO)\n        .as_secs();\n\n    let cached = CachedData {\n        timestamp: now,\n        data,\n    };\n    let content = serde_json::to_string(\u0026cached)?;\n\n    let final_path = get_cache_path(filename);\n    let nanos = std::time::SystemTime::now()\n        .duration_since(std::time::UNIX_EPOCH)\n        .map(|d| d.as_nanos() as u64)\n        .unwrap_or(0);\n    let tmp_filename = format!(\".{}.{}.{:x}.tmp\", filename, std::process::id(), nanos);\n    let tmp_path = dir.join(\u0026tmp_filename);\n\n    use std::io::Write;\n    let write_result = (|| {\n        let mut file = fs::File::create(\u0026tmp_path)?;\n        file.write_all(content.as_bytes())?;\n        file.sync_all()?;\n        fs::rename(\u0026tmp_path, \u0026final_path)\n    })();\n\n    if write_result.is_err() {\n        let _ = fs::remove_file(\u0026tmp_path);\n    }\n\n    write_result\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":4}},{"line":9,"address":[],"length":0,"stats":{"Line":4}},{"line":10,"address":[],"length":0,"stats":{"Line":4}},{"line":14,"address":[],"length":0,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":8}},{"line":24,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":12}},{"line":26,"address":[],"length":0,"stats":{"Line":16}},{"line":27,"address":[],"length":0,"stats":{"Line":20}},{"line":29,"address":[],"length":0,"stats":{"Line":8}},{"line":30,"address":[],"length":0,"stats":{"Line":4}},{"line":34,"address":[],"length":0,"stats":{"Line":12}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}}],"covered":13,"coverable":35},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","litellm.rs"],"content":"use super::cache;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\nconst CACHE_FILENAME: \u0026str = \"pricing-litellm.json\";\nconst PRICING_URL: \u0026str =\n    \"https://raw.githubusercontent.com/BerriAI/litellm/main/model_prices_and_context_window.json\";\nconst MAX_RETRIES: u32 = 3;\nconst INITIAL_BACKOFF_MS: u64 = 200;\n\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct ModelPricing {\n    pub input_cost_per_token: Option\u003cf64\u003e,\n    pub output_cost_per_token: Option\u003cf64\u003e,\n    pub cache_creation_input_token_cost: Option\u003cf64\u003e,\n    pub cache_read_input_token_cost: Option\u003cf64\u003e,\n}\n\npub type PricingDataset = HashMap\u003cString, ModelPricing\u003e;\n\npub fn load_cached() -\u003e Option\u003cPricingDataset\u003e {\n    cache::load_cache(CACHE_FILENAME)\n}\n\npub async fn fetch() -\u003e Result\u003cPricingDataset, reqwest::Error\u003e {\n    if let Some(cached) = load_cached() {\n        return Ok(cached);\n    }\n\n    let client = reqwest::Client::builder()\n        .timeout(std::time::Duration::from_secs(30))\n        .connect_timeout(std::time::Duration::from_secs(10))\n        .build()?;\n\n    let mut last_error: Option\u003creqwest::Error\u003e = None;\n\n    for attempt in 0..MAX_RETRIES {\n        match client.get(PRICING_URL).send().await {\n            Ok(response) =\u003e {\n                let status = response.status();\n\n                if status.is_server_error() || status == reqwest::StatusCode::TOO_MANY_REQUESTS {\n                    eprintln!(\n                        \"[tokscale] LiteLLM HTTP {} (attempt {}/{})\",\n                        status,\n                        attempt + 1,\n                        MAX_RETRIES\n                    );\n                    let _ = response.bytes().await;\n                    if attempt \u003c MAX_RETRIES - 1 {\n                        tokio::time::sleep(std::time::Duration::from_millis(\n                            INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                        ))\n                        .await;\n                    }\n                    continue;\n                }\n\n                if !status.is_success() {\n                    eprintln!(\"[tokscale] LiteLLM HTTP {}\", status);\n                    return Err(response.error_for_status().unwrap_err());\n                }\n\n                match response.json::\u003cPricingDataset\u003e().await {\n                    Ok(data) =\u003e {\n                        let _ = cache::save_cache(CACHE_FILENAME, \u0026data);\n                        return Ok(data);\n                    }\n                    Err(e) =\u003e {\n                        eprintln!(\"[tokscale] LiteLLM JSON parse failed: {}\", e);\n                        return Err(e);\n                    }\n                }\n            }\n            Err(e) =\u003e {\n                eprintln!(\n                    \"[tokscale] LiteLLM network error (attempt {}/{}): {}\",\n                    attempt + 1,\n                    MAX_RETRIES,\n                    e\n                );\n                last_error = Some(e);\n                if attempt \u003c MAX_RETRIES - 1 {\n                    tokio::time::sleep(std::time::Duration::from_millis(\n                        INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                    ))\n                    .await;\n                }\n            }\n        }\n    }\n\n    Err(last_error.expect(\"should have error after retries\"))\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":22,"address":[],"length":0,"stats":{"Line":4}},{"line":25,"address":[],"length":0,"stats":{"Line":4}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}}],"covered":5,"coverable":41},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","lookup.rs"],"content":"use super::{aliases, litellm::ModelPricing};\nuse std::collections::HashMap;\nuse std::sync::RwLock;\n\nconst PROVIDER_PREFIXES: \u0026[\u0026str] = \u0026[\n    \"openai/\",\n    \"anthropic/\",\n    \"google/\",\n    \"meta-llama/\",\n    \"mistralai/\",\n    \"deepseek/\",\n    \"qwen/\",\n    \"cohere/\",\n    \"perplexity/\",\n    \"x-ai/\",\n];\n\nconst ORIGINAL_PROVIDER_PREFIXES: \u0026[\u0026str] = \u0026[\n    \"x-ai/\",\n    \"xai/\",\n    \"anthropic/\",\n    \"openai/\",\n    \"google/\",\n    \"meta-llama/\",\n    \"mistralai/\",\n    \"deepseek/\",\n    \"z-ai/\",\n    \"qwen/\",\n    \"cohere/\",\n    \"perplexity/\",\n    \"moonshotai/\",\n];\n\nconst RESELLER_PROVIDER_PREFIXES: \u0026[\u0026str] = \u0026[\n    \"azure/\",\n    \"azure_ai/\",\n    \"bedrock/\",\n    \"vertex_ai/\",\n    \"together/\",\n    \"together_ai/\",\n    \"fireworks_ai/\",\n    \"groq/\",\n    \"openrouter/\",\n];\n\nconst FUZZY_BLOCKLIST: \u0026[\u0026str] = \u0026[\"auto\", \"mini\", \"chat\", \"base\"];\n\nconst MIN_FUZZY_MATCH_LEN: usize = 5;\n\n/// Minimum length for a model name candidate after prefix/suffix stripping.\n/// Prevents false positives like \"pro\" or \"flash\" being matched alone.\nconst MIN_MODEL_NAME_LEN: usize = 2;\n\n/// Maximum number of leading segments that can be treated as a routing prefix.\n/// Limits how aggressively we strip (e.g., \"a-b-claude-3\" strips at most \"a-b-\").\nconst MAX_PREFIX_STRIP_SEGMENTS: usize = 2;\n\n/// Maximum number of trailing segments that can be treated as a routing suffix.\n/// Handles tier suffixes (-high, -low) and variant suffixes (-thinking, -codex, -codex-max-xhigh).\nconst MAX_SUFFIX_STRIP_SEGMENTS: usize = 4;\n\n#[derive(Clone)]\nstruct CachedResult {\n    pricing: ModelPricing,\n    source: String,\n    matched_key: String,\n}\n\npub struct PricingLookup {\n    litellm: HashMap\u003cString, ModelPricing\u003e,\n    openrouter: HashMap\u003cString, ModelPricing\u003e,\n    litellm_keys: Vec\u003cString\u003e,\n    openrouter_keys: Vec\u003cString\u003e,\n    litellm_lower: HashMap\u003cString, String\u003e,\n    openrouter_lower: HashMap\u003cString, String\u003e,\n    openrouter_model_part: HashMap\u003cString, String\u003e,\n    lookup_cache: RwLock\u003cHashMap\u003cString, Option\u003cCachedResult\u003e\u003e\u003e,\n}\n\npub struct LookupResult {\n    pub pricing: ModelPricing,\n    pub source: String,\n    pub matched_key: String,\n}\n\nimpl PricingLookup {\n    pub fn new(\n        litellm: HashMap\u003cString, ModelPricing\u003e,\n        openrouter: HashMap\u003cString, ModelPricing\u003e,\n    ) -\u003e Self {\n        let mut litellm_keys: Vec\u003cString\u003e = litellm.keys().cloned().collect();\n        litellm_keys.sort_by_key(|k| std::cmp::Reverse(k.len()));\n\n        let mut openrouter_keys: Vec\u003cString\u003e = openrouter.keys().cloned().collect();\n        openrouter_keys.sort_by_key(|k| std::cmp::Reverse(k.len()));\n\n        let mut litellm_lower = HashMap::with_capacity(litellm.len());\n        for key in \u0026litellm_keys {\n            litellm_lower.insert(key.to_lowercase(), key.clone());\n        }\n\n        let mut openrouter_lower = HashMap::with_capacity(openrouter.len());\n        let mut openrouter_model_part = HashMap::with_capacity(openrouter.len());\n        for key in \u0026openrouter_keys {\n            let lower = key.to_lowercase();\n            openrouter_lower.insert(lower.clone(), key.clone());\n            if let Some(model_part) = lower.split('/').next_back() {\n                if model_part != lower {\n                    openrouter_model_part.insert(model_part.to_string(), key.clone());\n                }\n            }\n        }\n\n        Self {\n            litellm,\n            openrouter,\n            litellm_keys,\n            openrouter_keys,\n            litellm_lower,\n            openrouter_lower,\n            openrouter_model_part,\n            lookup_cache: RwLock::new(HashMap::with_capacity(64)),\n        }\n    }\n\n    pub fn lookup(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(cached) = self\n            .lookup_cache\n            .read()\n            .ok()\n            .and_then(|c| c.get(model_id).cloned())\n        {\n            return cached.map(|c| LookupResult {\n                pricing: c.pricing,\n                source: c.source,\n                matched_key: c.matched_key,\n            });\n        }\n\n        let result = self.lookup_with_source(model_id, None);\n\n        if let Ok(mut cache) = self.lookup_cache.write() {\n            cache.insert(\n                model_id.to_string(),\n                result.as_ref().map(|r| CachedResult {\n                    pricing: r.pricing.clone(),\n                    source: r.source.clone(),\n                    matched_key: r.matched_key.clone(),\n                }),\n            );\n        }\n\n        result\n    }\n\n    pub fn lookup_with_source(\n        \u0026self,\n        model_id: \u0026str,\n        force_source: Option\u003c\u0026str\u003e,\n    ) -\u003e Option\u003cLookupResult\u003e {\n        let canonical = aliases::resolve_alias(model_id).unwrap_or(model_id);\n        let lower = canonical.to_lowercase();\n\n        // Helper to perform lookup with the given source constraint\n        let do_lookup = |id: \u0026str| match force_source {\n            Some(\"litellm\") =\u003e self.lookup_litellm_only(id),\n            Some(\"openrouter\") =\u003e self.lookup_openrouter_only(id),\n            _ =\u003e self.lookup_auto(id),\n        };\n\n        // 1. Try direct lookup\n        if let Some(result) = do_lookup(\u0026lower) {\n            return Some(result);\n        }\n\n        // 2. Try stripping unknown suffixes (e.g., -thinking, -high, -codex)\n        if let Some(result) = try_strip_unknown_suffix(\u0026lower, do_lookup) {\n            return Some(result);\n        }\n\n        // 3. Try stripping unknown prefixes (e.g., antigravity-, myplugin-)\n        //    For each prefix candidate, also try suffix stripping\n        if let Some(result) = try_strip_unknown_prefix(\u0026lower, do_lookup) {\n            return Some(result);\n        }\n\n        None\n    }\n\n    fn lookup_auto(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(result) = self.exact_match_litellm(model_id) {\n            return Some(result);\n        }\n\n        if let Some(result) = self.exact_match_openrouter(model_id) {\n            return Some(result);\n        }\n\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n            if let Some(result) = self.exact_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n\n        if let Some(normalized) = normalize_model_name(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026normalized) {\n                return Some(result);\n            }\n            if let Some(result) = self.exact_match_openrouter(\u0026normalized) {\n                return Some(result);\n            }\n        }\n\n        if let Some(result) = self.prefix_match_litellm(model_id) {\n            return Some(result);\n        }\n        if let Some(result) = self.prefix_match_openrouter(model_id) {\n            return Some(result);\n        }\n\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.prefix_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n            if let Some(result) = self.prefix_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n\n        if !is_fuzzy_eligible(model_id) {\n            return None;\n        }\n\n        let litellm_result = self.fuzzy_match_litellm(model_id);\n        let openrouter_result = self.fuzzy_match_openrouter(model_id);\n\n        match (\u0026litellm_result, \u0026openrouter_result) {\n            (Some(l), Some(o)) =\u003e {\n                let l_is_original = is_original_provider(\u0026l.matched_key);\n                let o_is_original = is_original_provider(\u0026o.matched_key);\n                let l_is_reseller = is_reseller_provider(\u0026l.matched_key);\n                let o_is_reseller = is_reseller_provider(\u0026o.matched_key);\n\n                if o_is_original \u0026\u0026 !l_is_original {\n                    return openrouter_result;\n                }\n                if l_is_original \u0026\u0026 !o_is_original {\n                    return litellm_result;\n                }\n                if !l_is_reseller \u0026\u0026 o_is_reseller {\n                    return litellm_result;\n                }\n                if !o_is_reseller \u0026\u0026 l_is_reseller {\n                    return openrouter_result;\n                }\n                litellm_result\n            }\n            (Some(_), None) =\u003e litellm_result,\n            (None, Some(_)) =\u003e openrouter_result,\n            (None, None) =\u003e None,\n        }\n    }\n\n    fn lookup_litellm_only(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(result) = self.exact_match_litellm(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(normalized) = normalize_model_name(model_id) {\n            if let Some(result) = self.exact_match_litellm(\u0026normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(result) = self.prefix_match_litellm(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.prefix_match_litellm(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if is_fuzzy_eligible(model_id) {\n            if let Some(result) = self.fuzzy_match_litellm(model_id) {\n                return Some(result);\n            }\n        }\n        None\n    }\n\n    fn lookup_openrouter_only(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(result) = self.exact_match_openrouter(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.exact_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(normalized) = normalize_model_name(model_id) {\n            if let Some(result) = self.exact_match_openrouter(\u0026normalized) {\n                return Some(result);\n            }\n        }\n        if let Some(result) = self.prefix_match_openrouter(model_id) {\n            return Some(result);\n        }\n        if let Some(version_normalized) = normalize_version_separator(model_id) {\n            if let Some(result) = self.prefix_match_openrouter(\u0026version_normalized) {\n                return Some(result);\n            }\n        }\n        if is_fuzzy_eligible(model_id) {\n            if let Some(result) = self.fuzzy_match_openrouter(model_id) {\n                return Some(result);\n            }\n        }\n        None\n    }\n\n    fn exact_match_litellm(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        let key = self.litellm_lower.get(model_id)?;\n        let pricing = self.litellm.get(key)?;\n        Some(LookupResult {\n            pricing: pricing.clone(),\n            source: \"LiteLLM\".into(),\n            matched_key: key.clone(),\n        })\n    }\n\n    fn exact_match_openrouter(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        if let Some(key) = self.openrouter_lower.get(model_id) {\n            if let Some(pricing) = self.openrouter.get(key) {\n                return Some(LookupResult {\n                    pricing: pricing.clone(),\n                    source: \"OpenRouter\".into(),\n                    matched_key: key.clone(),\n                });\n            }\n        }\n        if let Some(key) = self.openrouter_model_part.get(model_id) {\n            if let Some(pricing) = self.openrouter.get(key) {\n                return Some(LookupResult {\n                    pricing: pricing.clone(),\n                    source: \"OpenRouter\".into(),\n                    matched_key: key.clone(),\n                });\n            }\n        }\n        None\n    }\n\n    fn prefix_match_litellm(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        for prefix in PROVIDER_PREFIXES {\n            let key = format!(\"{}{}\", prefix, model_id);\n            if let Some(litellm_key) = self.litellm_lower.get(\u0026key) {\n                if let Some(pricing) = self.litellm.get(litellm_key) {\n                    return Some(LookupResult {\n                        pricing: pricing.clone(),\n                        source: \"LiteLLM\".into(),\n                        matched_key: litellm_key.clone(),\n                    });\n                }\n            }\n        }\n        None\n    }\n\n    fn prefix_match_openrouter(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        for prefix in PROVIDER_PREFIXES {\n            let key = format!(\"{}{}\", prefix, model_id);\n            if let Some(or_key) = self.openrouter_lower.get(\u0026key) {\n                if let Some(pricing) = self.openrouter.get(or_key) {\n                    return Some(LookupResult {\n                        pricing: pricing.clone(),\n                        source: \"OpenRouter\".into(),\n                        matched_key: or_key.clone(),\n                    });\n                }\n            }\n        }\n        None\n    }\n\n    fn fuzzy_match_litellm(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        let family = extract_model_family(model_id);\n        let mut family_matches_list: Vec\u003c\u0026String\u003e = Vec::new();\n\n        for key in \u0026self.litellm_keys {\n            let lower_key = key.to_lowercase();\n            if family_matches(\u0026lower_key, \u0026family) \u0026\u0026 contains_model_id(\u0026lower_key, model_id) {\n                family_matches_list.push(key);\n            }\n        }\n\n        if let Some(result) = select_best_match(\u0026family_matches_list, \u0026self.litellm, \"LiteLLM\") {\n            return Some(result);\n        }\n\n        let mut all_matches: Vec\u003c\u0026String\u003e = Vec::new();\n        for key in \u0026self.litellm_keys {\n            let lower_key = key.to_lowercase();\n            if contains_model_id(\u0026lower_key, model_id) {\n                all_matches.push(key);\n            }\n        }\n\n        select_best_match(\u0026all_matches, \u0026self.litellm, \"LiteLLM\")\n    }\n\n    fn fuzzy_match_openrouter(\u0026self, model_id: \u0026str) -\u003e Option\u003cLookupResult\u003e {\n        let family = extract_model_family(model_id);\n        let mut family_matches_list: Vec\u003c\u0026String\u003e = Vec::new();\n\n        for key in \u0026self.openrouter_keys {\n            let lower_key = key.to_lowercase();\n            let model_part = lower_key.split('/').next_back().unwrap_or(\u0026lower_key);\n            if family_matches(model_part, \u0026family) \u0026\u0026 contains_model_id(model_part, model_id) {\n                family_matches_list.push(key);\n            }\n        }\n\n        if let Some(result) =\n            select_best_match(\u0026family_matches_list, \u0026self.openrouter, \"OpenRouter\")\n        {\n            return Some(result);\n        }\n\n        let mut all_matches: Vec\u003c\u0026String\u003e = Vec::new();\n        for key in \u0026self.openrouter_keys {\n            let lower_key = key.to_lowercase();\n            let model_part = lower_key.split('/').next_back().unwrap_or(\u0026lower_key);\n            if contains_model_id(model_part, model_id) {\n                all_matches.push(key);\n            }\n        }\n\n        select_best_match(\u0026all_matches, \u0026self.openrouter, \"OpenRouter\")\n    }\n\n    pub fn calculate_cost(\n        \u0026self,\n        model_id: \u0026str,\n        input: i64,\n        output: i64,\n        cache_read: i64,\n        cache_write: i64,\n        reasoning: i64,\n    ) -\u003e f64 {\n        let result = match self.lookup(model_id) {\n            Some(r) =\u003e r,\n            None =\u003e return 0.0,\n        };\n\n        let p = \u0026result.pricing;\n        let safe_price =\n            |opt: Option\u003cf64\u003e| opt.filter(|v| v.is_finite() \u0026\u0026 *v \u003e= 0.0).unwrap_or(0.0);\n\n        // Clamp negative tokens to 0 to prevent negative costs\n        let input_clamped = input.max(0) as f64;\n        let output_clamped = output.max(0).saturating_add(reasoning.max(0)) as f64;\n        let cache_read_clamped = cache_read.max(0) as f64;\n        let cache_write_clamped = cache_write.max(0) as f64;\n\n        let input_cost = input_clamped * safe_price(p.input_cost_per_token);\n        let output_cost = output_clamped * safe_price(p.output_cost_per_token);\n        let cache_read_cost = cache_read_clamped * safe_price(p.cache_read_input_token_cost);\n        let cache_write_cost = cache_write_clamped * safe_price(p.cache_creation_input_token_cost);\n\n        input_cost + output_cost + cache_read_cost + cache_write_cost\n    }\n}\n\nfn extract_model_family(model_id: \u0026str) -\u003e String {\n    let lower = model_id.to_lowercase();\n\n    if lower.contains(\"gpt-5\") {\n        return \"gpt-5\".into();\n    }\n    if lower.contains(\"gpt-4.1\") {\n        return \"gpt-4.1\".into();\n    }\n    if lower.contains(\"gpt-4o\") {\n        return \"gpt-4o\".into();\n    }\n    if lower.contains(\"gpt-4\") {\n        return \"gpt-4\".into();\n    }\n    if lower.contains(\"o3\") {\n        return \"o3\".into();\n    }\n    if lower.contains(\"o4\") {\n        return \"o4\".into();\n    }\n\n    if lower.contains(\"opus\") {\n        return \"opus\".into();\n    }\n    if lower.contains(\"sonnet\") {\n        return \"sonnet\".into();\n    }\n    if lower.contains(\"haiku\") {\n        return \"haiku\".into();\n    }\n    if lower.contains(\"claude\") {\n        return \"claude\".into();\n    }\n\n    if lower.contains(\"gemini-3\") {\n        return \"gemini-3\".into();\n    }\n    if lower.contains(\"gemini-2.5\") {\n        return \"gemini-2.5\".into();\n    }\n    if lower.contains(\"gemini-2\") {\n        return \"gemini-2\".into();\n    }\n    if lower.contains(\"gemini\") {\n        return \"gemini\".into();\n    }\n\n    if lower.contains(\"llama\") {\n        return \"llama\".into();\n    }\n    if lower.contains(\"mistral\") {\n        return \"mistral\".into();\n    }\n    if lower.contains(\"deepseek\") {\n        return \"deepseek\".into();\n    }\n    if lower.contains(\"qwen\") {\n        return \"qwen\".into();\n    }\n\n    lower\n        .split(['-', '_', '.'])\n        .next()\n        .unwrap_or(\u0026lower)\n        .to_string()\n}\n\nfn family_matches(key: \u0026str, family: \u0026str) -\u003e bool {\n    if family.is_empty() {\n        return true;\n    }\n    key.contains(family)\n}\n\nfn contains_model_id(key: \u0026str, model_id: \u0026str) -\u003e bool {\n    if let Some(pos) = key.find(model_id) {\n        let before_ok = pos == 0 || !key[..pos].chars().last().unwrap().is_alphanumeric();\n        let after_pos = pos + model_id.len();\n        let after_ok =\n            after_pos == key.len() || !key[after_pos..].chars().next().unwrap().is_alphanumeric();\n        before_ok \u0026\u0026 after_ok\n    } else {\n        false\n    }\n}\n\nfn normalize_model_name(model_id: \u0026str) -\u003e Option\u003cString\u003e {\n    let lower = model_id.to_lowercase();\n\n    if lower.contains(\"opus\") {\n        if lower.contains(\"4.5\") || lower.contains(\"4-5\") {\n            return Some(\"claude-opus-4-5\".into());\n        } else if lower.contains(\"4\") {\n            return Some(\"claude-opus-4\".into());\n        }\n    }\n    if lower.contains(\"sonnet\") {\n        if lower.contains(\"4.5\") || lower.contains(\"4-5\") {\n            return Some(\"claude-sonnet-4-5\".into());\n        } else if lower.contains(\"4\") \u0026\u0026 !lower.contains(\"3.\") \u0026\u0026 !lower.contains(\"3-\") {\n            return Some(\"claude-sonnet-4\".into());\n        } else if lower.contains(\"3.7\") || lower.contains(\"3-7\") {\n            return Some(\"claude-3-7-sonnet\".into());\n        } else if lower.contains(\"3.5\") || lower.contains(\"3-5\") {\n            return Some(\"claude-3.5-sonnet\".into());\n        }\n    }\n    if lower.contains(\"haiku\") {\n        if lower.contains(\"4.5\") || lower.contains(\"4-5\") {\n            return Some(\"claude-haiku-4-5\".into());\n        } else if lower.contains(\"3.5\") || lower.contains(\"3-5\") {\n            return Some(\"claude-3.5-haiku\".into());\n        }\n    }\n\n    None\n}\n\nfn normalize_version_separator(model_id: \u0026str) -\u003e Option\u003cString\u003e {\n    let mut result = String::with_capacity(model_id.len());\n    let chars: Vec\u003cchar\u003e = model_id.chars().collect();\n    let mut changed = false;\n\n    for i in 0..chars.len() {\n        if chars[i] == '-'\n            \u0026\u0026 i \u003e 0\n            \u0026\u0026 i \u003c chars.len() - 1\n            \u0026\u0026 chars[i - 1].is_ascii_digit()\n            \u0026\u0026 chars[i + 1].is_ascii_digit()\n        {\n            let is_multi_digit_before = i \u003e= 2 \u0026\u0026 chars[i - 2].is_ascii_digit();\n            let is_multi_digit_after = i + 2 \u003c chars.len() \u0026\u0026 chars[i + 2].is_ascii_digit();\n            let looks_like_date = is_multi_digit_before || is_multi_digit_after;\n\n            if looks_like_date {\n                result.push(chars[i]);\n            } else {\n                result.push('.');\n                changed = true;\n            }\n        } else {\n            result.push(chars[i]);\n        }\n    }\n\n    if changed {\n        Some(result)\n    } else {\n        None\n    }\n}\n\nfn is_fuzzy_eligible(model_id: \u0026str) -\u003e bool {\n    if model_id.len() \u003c MIN_FUZZY_MATCH_LEN {\n        return false;\n    }\n    !FUZZY_BLOCKLIST.contains(\u0026model_id)\n}\n\n/// Attempts to find a model by progressively stripping trailing segments.\n/// Handles arbitrary suffixes (e.g., \"claude-sonnet-4-5-thinking\" â†’ \"claude-sonnet-4-5\").\n/// This replaces the hardcoded TIER_SUFFIXES and FALLBACK_SUFFIXES approach.\nfn try_strip_unknown_suffix\u003cF\u003e(model_id: \u0026str, do_lookup: F) -\u003e Option\u003cLookupResult\u003e\nwhere\n    F: Fn(\u0026str) -\u003e Option\u003cLookupResult\u003e,\n{\n    let parts: Vec\u003c\u0026str\u003e = model_id.split('-').collect();\n\n    if parts.len() \u003c 2 {\n        return None;\n    }\n\n    let max_strip = std::cmp::min(parts.len() - 1, MAX_SUFFIX_STRIP_SEGMENTS);\n\n    for strip in 1..=max_strip {\n        let candidate: String = parts[..parts.len() - strip].join(\"-\");\n\n        if candidate.len() \u003e= MIN_MODEL_NAME_LEN {\n            if let Some(result) = do_lookup(\u0026candidate) {\n                return Some(result);\n            }\n        }\n    }\n\n    None\n}\n\n/// Attempts to find a model by progressively stripping leading segments.\n/// Handles arbitrary routing prefixes (e.g., \"myplugin-claude-3.5-sonnet\" â†’ \"claude-3.5-sonnet\").\n/// This replaces the hardcoded STRIPPED_PREFIXES approach.\nfn try_strip_unknown_prefix\u003cF\u003e(model_id: \u0026str, do_lookup: F) -\u003e Option\u003cLookupResult\u003e\nwhere\n    F: Fn(\u0026str) -\u003e Option\u003cLookupResult\u003e,\n{\n    let parts: Vec\u003c\u0026str\u003e = model_id.split('-').collect();\n\n    if parts.len() \u003c 2 {\n        return None;\n    }\n\n    let max_skip = std::cmp::min(parts.len() - 1, MAX_PREFIX_STRIP_SEGMENTS);\n\n    for skip in 1..=max_skip {\n        let candidate: String = parts[skip..].join(\"-\");\n\n        if candidate.len() \u003e= MIN_MODEL_NAME_LEN {\n            // Try candidate directly\n            if let Some(result) = do_lookup(\u0026candidate) {\n                return Some(result);\n            }\n\n            // Try candidate with suffix stripping\n            if let Some(result) = try_strip_unknown_suffix(\u0026candidate, \u0026do_lookup) {\n                return Some(result);\n            }\n        }\n    }\n\n    None\n}\n\nfn is_original_provider(key: \u0026str) -\u003e bool {\n    let lower = key.to_lowercase();\n    ORIGINAL_PROVIDER_PREFIXES\n        .iter()\n        .any(|prefix| lower.starts_with(prefix))\n}\n\nfn is_reseller_provider(key: \u0026str) -\u003e bool {\n    let lower = key.to_lowercase();\n    RESELLER_PROVIDER_PREFIXES\n        .iter()\n        .any(|prefix| lower.starts_with(prefix))\n}\n\nfn select_best_match(\n    matches: \u0026[\u0026String],\n    dataset: \u0026HashMap\u003cString, ModelPricing\u003e,\n    source: \u0026str,\n) -\u003e Option\u003cLookupResult\u003e {\n    if matches.is_empty() {\n        return None;\n    }\n\n    if let Some(key) = matches.iter().find(|k| is_original_provider(k)) {\n        if let Some(pricing) = dataset.get(*key) {\n            return Some(LookupResult {\n                pricing: pricing.clone(),\n                source: source.into(),\n                matched_key: (*key).clone(),\n            });\n        }\n    }\n\n    if let Some(key) = matches.iter().find(|k| !is_reseller_provider(k)) {\n        if let Some(pricing) = dataset.get(*key) {\n            return Some(LookupResult {\n                pricing: pricing.clone(),\n                source: source.into(),\n                matched_key: (*key).clone(),\n            });\n        }\n    }\n\n    let key = matches[0];\n    dataset.get(key).map(|pricing| LookupResult {\n        pricing: pricing.clone(),\n        source: source.into(),\n        matched_key: key.clone(),\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    /// Mock LiteLLM data matching real API responses for OpenCode Zen models\n    fn mock_litellm() -\u003e HashMap\u003cString, ModelPricing\u003e {\n        let mut m = HashMap::new();\n\n        // === GPT-4 models (baseline) ===\n        m.insert(\n            \"gpt-4o\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000025),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(0.00000125),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-4o-mini\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000015),\n                output_cost_per_token: Some(0.0000006),\n                cache_read_input_token_cost: Some(0.000000075),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-4-turbo\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00001),\n                output_cost_per_token: Some(0.00003),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: GPT-5 family ===\n        m.insert(\n            \"gpt-5.2\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000175),\n                output_cost_per_token: Some(0.000014),\n                cache_read_input_token_cost: Some(1.75e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5.1\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5.1-codex\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5.1-codex-max\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5-codex\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"gpt-5-nano\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(5e-8),\n                output_cost_per_token: Some(4e-7),\n                cache_read_input_token_cost: Some(5e-9),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Claude family (LiteLLM entries) ===\n        m.insert(\n            \"claude-3-5-sonnet-20241022\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(0.0000003),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"claude-sonnet-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(3e-7),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"claude-haiku-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000001),\n                output_cost_per_token: Some(0.000005),\n                cache_read_input_token_cost: Some(1e-7),\n                cache_creation_input_token_cost: Some(0.00000125),\n            },\n        );\n        m.insert(\n            \"bedrock/us.anthropic.claude-3-5-haiku-20241022-v1:0\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(8e-7),\n                output_cost_per_token: Some(0.000004),\n                cache_read_input_token_cost: Some(8e-8),\n                cache_creation_input_token_cost: Some(0.000001),\n            },\n        );\n        m.insert(\n            \"claude-opus-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000005),\n                output_cost_per_token: Some(0.000025),\n                cache_read_input_token_cost: Some(5e-7),\n                cache_creation_input_token_cost: Some(0.00000625),\n            },\n        );\n        m.insert(\n            \"claude-opus-4-1\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000015),\n                output_cost_per_token: Some(0.000075),\n                cache_read_input_token_cost: Some(0.0000015),\n                cache_creation_input_token_cost: Some(0.00001875),\n            },\n        );\n\n        // === OpenCode Zen: Gemini family (LiteLLM entries) ===\n        m.insert(\n            \"openrouter/google/gemini-3-pro-preview\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000002),\n                output_cost_per_token: Some(0.000012),\n                cache_read_input_token_cost: Some(2e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"vertex_ai/gemini-3-flash-preview\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(5e-7),\n                output_cost_per_token: Some(0.000003),\n                cache_read_input_token_cost: Some(5e-8),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Grok (LiteLLM entry) ===\n        m.insert(\n            \"xai/grok-code-fast-1-0825\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(2e-7),\n                output_cost_per_token: Some(0.0000015),\n                cache_read_input_token_cost: Some(2e-8),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m.insert(\n            \"azure_ai/grok-code-fast-1\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000035),\n                output_cost_per_token: Some(0.0000175),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"bedrock/anthropic.claude-sonnet-4\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(3e-7),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"vertex_ai/gemini-2.5-pro\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.000005),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"google/gemini-2.5-pro\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.000005),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m\n    }\n\n    /// Mock OpenRouter data matching real API responses for OpenCode Zen models\n    fn mock_openrouter() -\u003e HashMap\u003cString, ModelPricing\u003e {\n        let mut m = HashMap::new();\n\n        // === Baseline models ===\n        m.insert(\n            \"openai/gpt-4o\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000025),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(0.00000125),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Claude (OpenRouter entries) ===\n        m.insert(\n            \"anthropic/claude-sonnet-4\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000003),\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: Some(3e-7),\n                cache_creation_input_token_cost: Some(0.00000375),\n            },\n        );\n        m.insert(\n            \"anthropic/claude-opus-4-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000005),\n                output_cost_per_token: Some(0.000025),\n                cache_read_input_token_cost: Some(0.0000005),\n                cache_creation_input_token_cost: Some(0.00000625),\n            },\n        );\n        m.insert(\n            \"anthropic/claude-3.5-haiku\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(8e-7),\n                output_cost_per_token: Some(0.000004),\n                cache_read_input_token_cost: Some(8e-8),\n                cache_creation_input_token_cost: Some(0.000001),\n            },\n        );\n\n        // === OpenCode Zen: GLM family ===\n        m.insert(\n            \"z-ai/glm-4.7\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4e-7),\n                output_cost_per_token: Some(0.0000015),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"z-ai/glm-4.6\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(3.9e-7),\n                output_cost_per_token: Some(0.0000019),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m.insert(\n            \"moonshotai/kimi-k2\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4.56e-7),\n                output_cost_per_token: Some(0.00000184),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"moonshotai/kimi-k2.5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4.5e-7),\n                output_cost_per_token: Some(0.0000025),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        m.insert(\n            \"moonshotai/kimi-k2-thinking\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(4e-7),\n                output_cost_per_token: Some(0.00000175),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // === OpenCode Zen: Qwen family ===\n        m.insert(\n            \"qwen/qwen3-coder\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(2.2e-7),\n                output_cost_per_token: Some(9.5e-7),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        m\n    }\n\n    fn create_lookup() -\u003e PricingLookup {\n        PricingLookup::new(mock_litellm(), mock_openrouter())\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GPT-5 FAMILY\n    // All models from https://opencode.ai/docs/zen/\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_gpt_5_2() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.2\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.2\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_1() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_1_codex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_1_codex_max() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex-max\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex-max\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_codex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5-codex\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gpt_5_nano() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5-nano\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5-nano\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - CLAUDE FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_claude_sonnet_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_sonnet_4() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4\").unwrap();\n        assert_eq!(result.matched_key, \"anthropic/claude-sonnet-4\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_haiku_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-haiku-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-haiku-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_3_5_haiku() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-3-5-haiku\").unwrap();\n        assert_eq!(result.matched_key, \"anthropic/claude-3.5-haiku\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_3_5_haiku_with_dot() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-3.5-haiku\").unwrap();\n        assert_eq!(result.matched_key, \"anthropic/claude-3.5-haiku\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_opus_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-opus-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_claude_opus_4_1() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-opus-4-1\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-1\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GLM FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_glm_4_7_free() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.7-free\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_glm_4_6() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.6\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.6\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_glm_4_7_with_hyphen() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4-7\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_glm_4_6_with_hyphen() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4-6\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.6\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_big_pickle() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"big-pickle\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GEMINI FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_gemini_3_pro() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-pro\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_opencode_zen_gemini_3_flash() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-flash\").unwrap();\n        assert_eq!(result.matched_key, \"vertex_ai/gemini-3-flash-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - KIMI FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_kimi_k2() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_kimi_k2_thinking() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2-thinking\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2-thinking\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_kimi_k2_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2.5\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2.5\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_opencode_zen_kimi_k2_5_free() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"kimi-k2.5-free\").unwrap();\n        assert_eq!(result.matched_key, \"moonshotai/kimi-k2.5\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - QWEN FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_qwen3_coder() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"qwen3-coder\").unwrap();\n        assert_eq!(result.matched_key, \"qwen/qwen3-coder\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    // =========================================================================\n    // OPENCODE ZEN MODELS - GROK FAMILY\n    // =========================================================================\n\n    #[test]\n    fn test_opencode_zen_grok_code() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"grok-code\").unwrap();\n        assert_eq!(result.matched_key, \"xai/grok-code-fast-1-0825\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    // =========================================================================\n    // BASELINE / LEGACY TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_exact_match_litellm() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_exact_match_openrouter() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"z-ai/glm-4.7\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_openrouter_model_part_match() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.7\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_tier_suffix_low() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex-low\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_high() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-4o-high\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_free() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"glm-4.7-free\").unwrap();\n        assert_eq!(result.matched_key, \"z-ai/glm-4.7\");\n        assert_eq!(result.source, \"OpenRouter\");\n    }\n\n    #[test]\n    fn test_tier_suffix_xhigh() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.2-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.2\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_xhigh_codex_max() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.1-codex-max-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.1-codex-max\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_normalize_opus_4_5() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"opus-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_blocklist_auto() {\n        let lookup = create_lookup();\n        assert!(lookup.lookup(\"auto\").is_none());\n    }\n\n    #[test]\n    fn test_blocklist_mini() {\n        let lookup = create_lookup();\n        assert!(lookup.lookup(\"mini\").is_none());\n    }\n\n    #[test]\n    fn test_force_source_litellm() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup_with_source(\"gpt-4o\", Some(\"litellm\"))\n            .unwrap();\n        assert_eq!(result.source, \"LiteLLM\");\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_force_source_openrouter() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup_with_source(\"gpt-4o\", Some(\"openrouter\"))\n            .unwrap();\n        assert_eq!(result.source, \"OpenRouter\");\n        assert_eq!(result.matched_key, \"openai/gpt-4o\");\n    }\n\n    #[test]\n    fn test_case_insensitive() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"GPT-4O\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_fuzzy_match_gemini() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-pro\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_tier_suffix_with_fuzzy() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-3-pro-high\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n    }\n\n    #[test]\n    fn test_nonexistent_model() {\n        let lookup = create_lookup();\n        assert!(lookup.lookup(\"nonexistent-model-xyz\").is_none());\n    }\n\n    #[test]\n    fn test_fallback_suffix_lookup() {\n        // Create a lookup with only the base model (no -codex variant)\n        let mut litellm = HashMap::new();\n        litellm.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n        // Note: gpt-5-codex is NOT in the pricing data\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n\n        // Looking up gpt-5-codex should fall back to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n\n        // Looking up gpt-5-codex-max should also fall back to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex-max\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_fallback_suffix_with_tier_suffix() {\n        // Test that tier suffix + fallback suffix both work together\n        let mut litellm = HashMap::new();\n        litellm.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: Some(1.25e-7),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n\n        // gpt-5-codex-high should strip -high first, then fall back from gpt-5-codex to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex-high\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n\n        // gpt-5-codex-max-xhigh should strip -xhigh first, then fall back from gpt-5-codex-max to gpt-5\n        let result = lookup.lookup(\"gpt-5-codex-max-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_fallback_suffix_prefers_exact_match() {\n        // If the exact model exists, it should be used (no fallback)\n        let mut litellm = HashMap::new();\n        litellm.insert(\n            \"gpt-5\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.00000125),\n                output_cost_per_token: Some(0.00001),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n        litellm.insert(\n            \"gpt-5-codex\".into(),\n            ModelPricing {\n                input_cost_per_token: Some(0.000002), // Different price to verify which one is used\n                output_cost_per_token: Some(0.000015),\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n\n        // Should use the exact match, not fall back\n        let result = lookup.lookup(\"gpt-5-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5-codex\");\n        assert_eq!(result.pricing.input_cost_per_token, Some(0.000002));\n    }\n\n    #[test]\n    fn test_normalize_version_separator() {\n        assert_eq!(\n            normalize_version_separator(\"glm-4-7\"),\n            Some(\"glm-4.7\".into())\n        );\n        assert_eq!(\n            normalize_version_separator(\"glm-4-6\"),\n            Some(\"glm-4.6\".into())\n        );\n        assert_eq!(\n            normalize_version_separator(\"claude-3-5-haiku\"),\n            Some(\"claude-3.5-haiku\".into())\n        );\n        assert_eq!(\n            normalize_version_separator(\"gpt-5-1-codex\"),\n            Some(\"gpt-5.1-codex\".into())\n        );\n        assert_eq!(normalize_version_separator(\"gpt-4o\"), None);\n        assert_eq!(normalize_version_separator(\"claude-sonnet\"), None);\n        assert_eq!(normalize_version_separator(\"big-pickle\"), None);\n    }\n\n    #[test]\n    fn test_normalize_version_separator_preserves_dates() {\n        assert_eq!(normalize_version_separator(\"2024-11-20\"), None);\n        assert_eq!(normalize_version_separator(\"model-2024-11-20\"), None);\n        assert_eq!(\n            normalize_version_separator(\"claude-3-5-sonnet-20241022\"),\n            Some(\"claude-3.5-sonnet-20241022\".into())\n        );\n        assert_eq!(normalize_version_separator(\"sonnet-20241022\"), None);\n        assert_eq!(normalize_version_separator(\"model-20241022-v1\"), None);\n    }\n\n    #[test]\n    fn test_is_fuzzy_eligible() {\n        assert!(!is_fuzzy_eligible(\"auto\"));\n        assert!(!is_fuzzy_eligible(\"mini\"));\n        assert!(!is_fuzzy_eligible(\"chat\"));\n        assert!(!is_fuzzy_eligible(\"base\"));\n        assert!(!is_fuzzy_eligible(\"abc\"));\n        assert!(is_fuzzy_eligible(\"gpt-4o\"));\n        assert!(is_fuzzy_eligible(\"claude\"));\n    }\n\n    // =========================================================================\n    // PROVIDER PREFERENCE TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_provider_preference_grok_prefers_xai_over_azure() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"grok-code\").unwrap();\n        assert_eq!(result.matched_key, \"xai/grok-code-fast-1-0825\");\n        assert_eq!(result.source, \"LiteLLM\");\n        assert!(!result.matched_key.starts_with(\"azure\"));\n    }\n\n    /// Test that documents the exact before/after behavior for grok-code provider preference.\n    /// This test explicitly verifies that the original provider (xai/) is preferred over resellers (azure_ai/).\n    #[test]\n    fn test_grok_code_prefers_xai_over_azure() {\n        // =========================================================================\n        // BEFORE FIX: grok-code â†’ azure_ai/grok-code-fast-1 ($3.50/$17.50) âŒ reseller\n        // AFTER FIX:  grok-code â†’ xai/grok-code-fast-1-0825 ($0.20/$1.50) âœ… original provider\n        //\n        // The azure_ai/ prefix indicates a reseller (Azure AI marketplace), which typically\n        // has higher prices. The xai/ prefix indicates the original provider (X.AI/Grok),\n        // which offers lower direct pricing. Our lookup should prefer the original provider.\n        // =========================================================================\n\n        let mut litellm = HashMap::new();\n\n        // Reseller entry: azure_ai/ prefix with higher prices ($3.50/$17.50 per 1M tokens)\n        litellm.insert(\n            \"azure_ai/grok-code-fast-1\".to_string(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000035),  // $3.50/1M tokens\n                output_cost_per_token: Some(0.0000175), // $17.50/1M tokens\n                cache_read_input_token_cost: None,\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        // Original provider entry: xai/ prefix with lower prices ($0.20/$1.50 per 1M tokens)\n        litellm.insert(\n            \"xai/grok-code-fast-1-0825\".to_string(),\n            ModelPricing {\n                input_cost_per_token: Some(0.0000002),  // $0.20/1M tokens\n                output_cost_per_token: Some(0.0000015), // $1.50/1M tokens\n                cache_read_input_token_cost: Some(0.00000002),\n                cache_creation_input_token_cost: None,\n            },\n        );\n\n        let lookup = PricingLookup::new(litellm, HashMap::new());\n        let result = lookup.lookup(\"grok-code\").unwrap();\n\n        // Must prefer xai (original provider) over azure_ai (reseller)\n        assert!(\n            result.matched_key.starts_with(\"xai/\"),\n            \"Expected xai/ prefix (original provider) but got: {}. \\\n             The lookup should prefer original providers over resellers.\",\n            result.matched_key\n        );\n        assert_eq!(\n            result.matched_key, \"xai/grok-code-fast-1-0825\",\n            \"Should match the xai/grok-code-fast-1-0825 entry, not azure_ai/grok-code-fast-1\"\n        );\n\n        // Verify we got the lower price (original provider)\n        let pricing = \u0026result.pricing;\n        assert!(\n            pricing.input_cost_per_token.unwrap() \u003c 0.000001,\n            \"Input cost should be ~$0.20/1M (0.0000002), not ~$3.50/1M (reseller price)\"\n        );\n        assert!(\n            pricing.output_cost_per_token.unwrap() \u003c 0.000005,\n            \"Output cost should be ~$1.50/1M (0.0000015), not ~$17.50/1M (reseller price)\"\n        );\n    }\n\n    #[test]\n    fn test_provider_preference_gemini_prefers_google_over_vertex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gemini-2.5-pro\").unwrap();\n        assert_eq!(result.matched_key, \"google/gemini-2.5-pro\");\n        assert_eq!(result.source, \"LiteLLM\");\n        assert!(!result.matched_key.starts_with(\"vertex_ai\"));\n    }\n\n    #[test]\n    fn test_is_original_provider() {\n        assert!(is_original_provider(\"xai/grok-code\"));\n        assert!(is_original_provider(\"anthropic/claude-3\"));\n        assert!(is_original_provider(\"openai/gpt-4\"));\n        assert!(is_original_provider(\"google/gemini\"));\n        assert!(is_original_provider(\"x-ai/grok\"));\n        assert!(!is_original_provider(\"azure_ai/grok\"));\n        assert!(!is_original_provider(\"bedrock/anthropic\"));\n        assert!(!is_original_provider(\"vertex_ai/gemini\"));\n        assert!(!is_original_provider(\"unknown-provider/model\"));\n    }\n\n    #[test]\n    fn test_is_reseller_provider() {\n        assert!(is_reseller_provider(\"azure_ai/grok-code\"));\n        assert!(is_reseller_provider(\"azure/openai/gpt-4\"));\n        assert!(is_reseller_provider(\"bedrock/anthropic.claude\"));\n        assert!(is_reseller_provider(\"vertex_ai/gemini\"));\n        assert!(is_reseller_provider(\"together_ai/llama\"));\n        assert!(is_reseller_provider(\"groq/llama\"));\n        assert!(!is_reseller_provider(\"xai/grok\"));\n        assert!(!is_reseller_provider(\"anthropic/claude\"));\n        assert!(!is_reseller_provider(\"openai/gpt-4\"));\n    }\n\n    // =========================================================================\n    // COST CALCULATION TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_calculate_cost_gpt_5_2() {\n        let lookup = create_lookup();\n        // 1M input, 500K output tokens\n        let cost = lookup.calculate_cost(\"gpt-5.2\", 1_000_000, 500_000, 0, 0, 0);\n        // input: 1M * 0.00000175 = 1.75, output: 500K * 0.000014 = 7.0\n        assert!((cost - 8.75).abs() \u003c 0.001);\n    }\n\n    #[test]\n    fn test_calculate_cost_claude_sonnet_4_5() {\n        let lookup = create_lookup();\n        // 100K input, 50K output, 200K cache read\n        let cost = lookup.calculate_cost(\"claude-sonnet-4-5\", 100_000, 50_000, 200_000, 0, 0);\n        // input: 100K * 0.000003 = 0.30, output: 50K * 0.000015 = 0.75, cache: 200K * 3e-7 = 0.06\n        assert!((cost - 1.11).abs() \u003c 0.001);\n    }\n\n    #[test]\n    fn test_calculate_cost_unknown_model() {\n        let lookup = create_lookup();\n        let cost = lookup.calculate_cost(\"nonexistent-model\", 1_000_000, 500_000, 0, 0, 0);\n        assert_eq!(cost, 0.0);\n    }\n\n    // =========================================================================\n    // INTELLIGENT PREFIX/SUFFIX STRIPPING TESTS\n    // =========================================================================\n\n    #[test]\n    fn test_antigravity_prefix_gemini_3_flash() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gemini-3-flash\").unwrap();\n        assert_eq!(result.matched_key, \"vertex_ai/gemini-3-flash-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_gemini_3_pro() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gemini-3-pro\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_with_tier_suffix() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gemini-3-pro-high\").unwrap();\n        assert_eq!(result.matched_key, \"openrouter/google/gemini-3-pro-preview\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_claude() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-claude-sonnet-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_gpt() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"antigravity-gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n        assert_eq!(result.source, \"LiteLLM\");\n    }\n\n    #[test]\n    fn test_antigravity_prefix_case_insensitive() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"Antigravity-gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_antigravity_cost_calculation() {\n        let lookup = create_lookup();\n        let cost_with_prefix =\n            lookup.calculate_cost(\"antigravity-gpt-5.2\", 1_000_000, 500_000, 0, 0, 0);\n        let cost_without_prefix = lookup.calculate_cost(\"gpt-5.2\", 1_000_000, 500_000, 0, 0, 0);\n        assert!((cost_with_prefix - cost_without_prefix).abs() \u003c 0.001);\n        assert!(cost_with_prefix \u003e 0.0);\n    }\n\n    // New tests for intelligent detection\n\n    #[test]\n    fn test_unknown_prefix_generic() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"myplugin-gpt-4o\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_unknown_prefix_two_segments() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"router-v2-claude-sonnet-4-5\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_unknown_suffix_thinking() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5-thinking\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_unknown_suffix_two_segments() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-opus-4-5-thinking-pro\").unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n    }\n\n    #[test]\n    fn test_prefix_and_suffix_combined() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup(\"antigravity-claude-opus-4-5-thinking\")\n            .unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n    }\n\n    #[test]\n    fn test_prefix_and_suffix_with_tier() {\n        let lookup = create_lookup();\n        let result = lookup\n            .lookup(\"antigravity-claude-opus-4-5-thinking-high\")\n            .unwrap();\n        assert_eq!(result.matched_key, \"claude-opus-4-5\");\n    }\n\n    #[test]\n    fn test_no_false_positive_valid_model() {\n        let lookup = create_lookup();\n        // gpt-4o-mini is a valid model, should NOT strip \"gpt\"\n        let result = lookup.lookup(\"gpt-4o-mini\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o-mini\");\n    }\n\n    #[test]\n    fn test_suffix_strip_high() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5-high\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_suffix_strip_xhigh() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"claude-sonnet-4-5-xhigh\").unwrap();\n        assert_eq!(result.matched_key, \"claude-sonnet-4-5\");\n    }\n\n    #[test]\n    fn test_suffix_strip_low() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-4o-low\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-4o\");\n    }\n\n    #[test]\n    fn test_suffix_strip_codex() {\n        let lookup = create_lookup();\n        let result = lookup.lookup(\"gpt-5.2-codex\").unwrap();\n        assert_eq!(result.matched_key, \"gpt-5.2\");\n    }\n}\n","traces":[{"line":87,"address":[],"length":0,"stats":{"Line":73}},{"line":91,"address":[],"length":0,"stats":{"Line":438}},{"line":92,"address":[],"length":0,"stats":{"Line":185770}},{"line":94,"address":[],"length":0,"stats":{"Line":438}},{"line":95,"address":[],"length":0,"stats":{"Line":21874}},{"line":97,"address":[],"length":0,"stats":{"Line":292}},{"line":98,"address":[],"length":0,"stats":{"Line":13431}},{"line":99,"address":[],"length":0,"stats":{"Line":26716}},{"line":102,"address":[],"length":0,"stats":{"Line":292}},{"line":103,"address":[],"length":0,"stats":{"Line":292}},{"line":104,"address":[],"length":0,"stats":{"Line":1203}},{"line":105,"address":[],"length":0,"stats":{"Line":2260}},{"line":106,"address":[],"length":0,"stats":{"Line":6780}},{"line":107,"address":[],"length":0,"stats":{"Line":2260}},{"line":108,"address":[],"length":0,"stats":{"Line":2260}},{"line":109,"address":[],"length":0,"stats":{"Line":5650}},{"line":122,"address":[],"length":0,"stats":{"Line":73}},{"line":126,"address":[],"length":0,"stats":{"Line":491382}},{"line":127,"address":[],"length":0,"stats":{"Line":982541}},{"line":128,"address":[],"length":0,"stats":{"Line":491382}},{"line":131,"address":[],"length":0,"stats":{"Line":1965528}},{"line":133,"address":[],"length":0,"stats":{"Line":982318}},{"line":134,"address":[],"length":0,"stats":{"Line":488074}},{"line":135,"address":[],"length":0,"stats":{"Line":488074}},{"line":136,"address":[],"length":0,"stats":{"Line":488074}},{"line":140,"address":[],"length":0,"stats":{"Line":1115}},{"line":142,"address":[],"length":0,"stats":{"Line":446}},{"line":143,"address":[],"length":0,"stats":{"Line":446}},{"line":144,"address":[],"length":0,"stats":{"Line":446}},{"line":145,"address":[],"length":0,"stats":{"Line":669}},{"line":146,"address":[],"length":0,"stats":{"Line":416}},{"line":147,"address":[],"length":0,"stats":{"Line":416}},{"line":148,"address":[],"length":0,"stats":{"Line":416}},{"line":153,"address":[],"length":0,"stats":{"Line":223}},{"line":156,"address":[],"length":0,"stats":{"Line":225}},{"line":161,"address":[],"length":0,"stats":{"Line":1125}},{"line":162,"address":[],"length":0,"stats":{"Line":675}},{"line":165,"address":[],"length":0,"stats":{"Line":558}},{"line":166,"address":[],"length":0,"stats":{"Line":5}},{"line":167,"address":[],"length":0,"stats":{"Line":4}},{"line":168,"address":[],"length":0,"stats":{"Line":993}},{"line":172,"address":[],"length":0,"stats":{"Line":383}},{"line":173,"address":[],"length":0,"stats":{"Line":158}},{"line":177,"address":[],"length":0,"stats":{"Line":176}},{"line":178,"address":[],"length":0,"stats":{"Line":42}},{"line":183,"address":[],"length":0,"stats":{"Line":60}},{"line":184,"address":[],"length":0,"stats":{"Line":10}},{"line":187,"address":[],"length":0,"stats":{"Line":15}},{"line":190,"address":[],"length":0,"stats":{"Line":331}},{"line":191,"address":[],"length":0,"stats":{"Line":762}},{"line":192,"address":[],"length":0,"stats":{"Line":100}},{"line":195,"address":[],"length":0,"stats":{"Line":506}},{"line":196,"address":[],"length":0,"stats":{"Line":44}},{"line":199,"address":[],"length":0,"stats":{"Line":209}},{"line":200,"address":[],"length":0,"stats":{"Line":44}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":47}},{"line":204,"address":[],"length":0,"stats":{"Line":3}},{"line":208,"address":[],"length":0,"stats":{"Line":227}},{"line":209,"address":[],"length":0,"stats":{"Line":109}},{"line":210,"address":[],"length":0,"stats":{"Line":23}},{"line":212,"address":[],"length":0,"stats":{"Line":50}},{"line":213,"address":[],"length":0,"stats":{"Line":10}},{"line":217,"address":[],"length":0,"stats":{"Line":303}},{"line":218,"address":[],"length":0,"stats":{"Line":1}},{"line":220,"address":[],"length":0,"stats":{"Line":300}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":150}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":150}},{"line":234,"address":[],"length":0,"stats":{"Line":15}},{"line":237,"address":[],"length":0,"stats":{"Line":540}},{"line":238,"address":[],"length":0,"stats":{"Line":540}},{"line":240,"address":[],"length":0,"stats":{"Line":270}},{"line":241,"address":[],"length":0,"stats":{"Line":34}},{"line":242,"address":[],"length":0,"stats":{"Line":51}},{"line":243,"address":[],"length":0,"stats":{"Line":51}},{"line":244,"address":[],"length":0,"stats":{"Line":51}},{"line":245,"address":[],"length":0,"stats":{"Line":51}},{"line":247,"address":[],"length":0,"stats":{"Line":34}},{"line":248,"address":[],"length":0,"stats":{"Line":11}},{"line":250,"address":[],"length":0,"stats":{"Line":12}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":12}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":12}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":6}},{"line":261,"address":[],"length":0,"stats":{"Line":10}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":108}},{"line":267,"address":[],"length":0,"stats":{"Line":1}},{"line":268,"address":[],"length":0,"stats":{"Line":3}},{"line":269,"address":[],"length":0,"stats":{"Line":1}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":1}},{"line":298,"address":[],"length":0,"stats":{"Line":3}},{"line":299,"address":[],"length":0,"stats":{"Line":1}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":397}},{"line":328,"address":[],"length":0,"stats":{"Line":1588}},{"line":329,"address":[],"length":0,"stats":{"Line":496}},{"line":330,"address":[],"length":0,"stats":{"Line":124}},{"line":331,"address":[],"length":0,"stats":{"Line":372}},{"line":332,"address":[],"length":0,"stats":{"Line":372}},{"line":333,"address":[],"length":0,"stats":{"Line":124}},{"line":337,"address":[],"length":0,"stats":{"Line":274}},{"line":338,"address":[],"length":0,"stats":{"Line":549}},{"line":339,"address":[],"length":0,"stats":{"Line":3}},{"line":340,"address":[],"length":0,"stats":{"Line":1}},{"line":341,"address":[],"length":0,"stats":{"Line":3}},{"line":342,"address":[],"length":0,"stats":{"Line":3}},{"line":343,"address":[],"length":0,"stats":{"Line":1}},{"line":347,"address":[],"length":0,"stats":{"Line":603}},{"line":348,"address":[],"length":0,"stats":{"Line":171}},{"line":349,"address":[],"length":0,"stats":{"Line":57}},{"line":350,"address":[],"length":0,"stats":{"Line":171}},{"line":351,"address":[],"length":0,"stats":{"Line":171}},{"line":352,"address":[],"length":0,"stats":{"Line":57}},{"line":356,"address":[],"length":0,"stats":{"Line":216}},{"line":359,"address":[],"length":0,"stats":{"Line":151}},{"line":360,"address":[],"length":0,"stats":{"Line":1503}},{"line":361,"address":[],"length":0,"stats":{"Line":3006}},{"line":362,"address":[],"length":0,"stats":{"Line":3007}},{"line":363,"address":[],"length":0,"stats":{"Line":3}},{"line":364,"address":[],"length":0,"stats":{"Line":1}},{"line":365,"address":[],"length":0,"stats":{"Line":3}},{"line":366,"address":[],"length":0,"stats":{"Line":3}},{"line":367,"address":[],"length":0,"stats":{"Line":1}},{"line":372,"address":[],"length":0,"stats":{"Line":150}},{"line":375,"address":[],"length":0,"stats":{"Line":150}},{"line":376,"address":[],"length":0,"stats":{"Line":1500}},{"line":377,"address":[],"length":0,"stats":{"Line":3000}},{"line":378,"address":[],"length":0,"stats":{"Line":3000}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":150}},{"line":391,"address":[],"length":0,"stats":{"Line":135}},{"line":392,"address":[],"length":0,"stats":{"Line":405}},{"line":393,"address":[],"length":0,"stats":{"Line":405}},{"line":395,"address":[],"length":0,"stats":{"Line":188682}},{"line":396,"address":[],"length":0,"stats":{"Line":377094}},{"line":397,"address":[],"length":0,"stats":{"Line":582839}},{"line":398,"address":[],"length":0,"stats":{"Line":370}},{"line":402,"address":[],"length":0,"stats":{"Line":432}},{"line":403,"address":[],"length":0,"stats":{"Line":27}},{"line":406,"address":[],"length":0,"stats":{"Line":324}},{"line":407,"address":[],"length":0,"stats":{"Line":144824}},{"line":408,"address":[],"length":0,"stats":{"Line":289432}},{"line":409,"address":[],"length":0,"stats":{"Line":434148}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":432}},{"line":417,"address":[],"length":0,"stats":{"Line":135}},{"line":418,"address":[],"length":0,"stats":{"Line":405}},{"line":419,"address":[],"length":0,"stats":{"Line":405}},{"line":421,"address":[],"length":0,"stats":{"Line":17455}},{"line":422,"address":[],"length":0,"stats":{"Line":34640}},{"line":423,"address":[],"length":0,"stats":{"Line":86600}},{"line":424,"address":[],"length":0,"stats":{"Line":54077}},{"line":425,"address":[],"length":0,"stats":{"Line":70}},{"line":429,"address":[],"length":0,"stats":{"Line":17}},{"line":430,"address":[],"length":0,"stats":{"Line":405}},{"line":432,"address":[],"length":0,"stats":{"Line":17}},{"line":435,"address":[],"length":0,"stats":{"Line":354}},{"line":436,"address":[],"length":0,"stats":{"Line":13528}},{"line":437,"address":[],"length":0,"stats":{"Line":26820}},{"line":438,"address":[],"length":0,"stats":{"Line":67050}},{"line":439,"address":[],"length":0,"stats":{"Line":40230}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":472}},{"line":447,"address":[],"length":0,"stats":{"Line":491315}},{"line":456,"address":[],"length":0,"stats":{"Line":1470848}},{"line":457,"address":[],"length":0,"stats":{"Line":976436}},{"line":458,"address":[],"length":0,"stats":{"Line":3097}},{"line":461,"address":[],"length":0,"stats":{"Line":976436}},{"line":462,"address":[],"length":0,"stats":{"Line":488218}},{"line":463,"address":[],"length":0,"stats":{"Line":11287329}},{"line":466,"address":[],"length":0,"stats":{"Line":976436}},{"line":467,"address":[],"length":0,"stats":{"Line":2441090}},{"line":468,"address":[],"length":0,"stats":{"Line":976436}},{"line":469,"address":[],"length":0,"stats":{"Line":976436}},{"line":471,"address":[],"length":0,"stats":{"Line":1464654}},{"line":472,"address":[],"length":0,"stats":{"Line":1464654}},{"line":473,"address":[],"length":0,"stats":{"Line":1464654}},{"line":474,"address":[],"length":0,"stats":{"Line":1464654}},{"line":476,"address":[],"length":0,"stats":{"Line":488218}},{"line":480,"address":[],"length":0,"stats":{"Line":270}},{"line":481,"address":[],"length":0,"stats":{"Line":810}},{"line":483,"address":[],"length":0,"stats":{"Line":270}},{"line":484,"address":[],"length":0,"stats":{"Line":116}},{"line":486,"address":[],"length":0,"stats":{"Line":212}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":212}},{"line":490,"address":[],"length":0,"stats":{"Line":20}},{"line":492,"address":[],"length":0,"stats":{"Line":202}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":202}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":202}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":202}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":202}},{"line":506,"address":[],"length":0,"stats":{"Line":40}},{"line":508,"address":[],"length":0,"stats":{"Line":182}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":182}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":182}},{"line":516,"address":[],"length":0,"stats":{"Line":112}},{"line":518,"address":[],"length":0,"stats":{"Line":126}},{"line":519,"address":[],"length":0,"stats":{"Line":8}},{"line":521,"address":[],"length":0,"stats":{"Line":122}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":122}},{"line":525,"address":[],"length":0,"stats":{"Line":12}},{"line":528,"address":[],"length":0,"stats":{"Line":116}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":116}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":116}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":116}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":348}},{"line":542,"address":[],"length":0,"stats":{"Line":232}},{"line":544,"address":[],"length":0,"stats":{"Line":116}},{"line":548,"address":[],"length":0,"stats":{"Line":205867}},{"line":549,"address":[],"length":0,"stats":{"Line":411734}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":617601}},{"line":555,"address":[],"length":0,"stats":{"Line":164491}},{"line":556,"address":[],"length":0,"stats":{"Line":329202}},{"line":557,"address":[],"length":0,"stats":{"Line":1172}},{"line":558,"address":[],"length":0,"stats":{"Line":660}},{"line":559,"address":[],"length":0,"stats":{"Line":220}},{"line":560,"address":[],"length":0,"stats":{"Line":947}},{"line":561,"address":[],"length":0,"stats":{"Line":440}},{"line":563,"address":[],"length":0,"stats":{"Line":164271}},{"line":567,"address":[],"length":0,"stats":{"Line":184}},{"line":568,"address":[],"length":0,"stats":{"Line":552}},{"line":570,"address":[],"length":0,"stats":{"Line":184}},{"line":571,"address":[],"length":0,"stats":{"Line":34}},{"line":572,"address":[],"length":0,"stats":{"Line":12}},{"line":573,"address":[],"length":0,"stats":{"Line":6}},{"line":574,"address":[],"length":0,"stats":{"Line":6}},{"line":577,"address":[],"length":0,"stats":{"Line":166}},{"line":578,"address":[],"length":0,"stats":{"Line":48}},{"line":579,"address":[],"length":0,"stats":{"Line":11}},{"line":580,"address":[],"length":0,"stats":{"Line":22}},{"line":581,"address":[],"length":0,"stats":{"Line":4}},{"line":582,"address":[],"length":0,"stats":{"Line":10}},{"line":583,"address":[],"length":0,"stats":{"Line":10}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":141}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":141}},{"line":599,"address":[],"length":0,"stats":{"Line":349}},{"line":600,"address":[],"length":0,"stats":{"Line":1396}},{"line":601,"address":[],"length":0,"stats":{"Line":1745}},{"line":602,"address":[],"length":0,"stats":{"Line":698}},{"line":604,"address":[],"length":0,"stats":{"Line":5301}},{"line":605,"address":[],"length":0,"stats":{"Line":4952}},{"line":606,"address":[],"length":0,"stats":{"Line":629}},{"line":607,"address":[],"length":0,"stats":{"Line":1258}},{"line":608,"address":[],"length":0,"stats":{"Line":1258}},{"line":609,"address":[],"length":0,"stats":{"Line":420}},{"line":611,"address":[],"length":0,"stats":{"Line":124}},{"line":612,"address":[],"length":0,"stats":{"Line":141}},{"line":613,"address":[],"length":0,"stats":{"Line":89}},{"line":615,"address":[],"length":0,"stats":{"Line":35}},{"line":616,"address":[],"length":0,"stats":{"Line":12}},{"line":618,"address":[],"length":0,"stats":{"Line":54}},{"line":619,"address":[],"length":0,"stats":{"Line":27}},{"line":622,"address":[],"length":0,"stats":{"Line":14763}},{"line":626,"address":[],"length":0,"stats":{"Line":349}},{"line":627,"address":[],"length":0,"stats":{"Line":27}},{"line":629,"address":[],"length":0,"stats":{"Line":322}},{"line":633,"address":[],"length":0,"stats":{"Line":157}},{"line":634,"address":[],"length":0,"stats":{"Line":157}},{"line":635,"address":[],"length":0,"stats":{"Line":20}},{"line":637,"address":[],"length":0,"stats":{"Line":274}},{"line":643,"address":[],"length":0,"stats":{"Line":78}},{"line":647,"address":[],"length":0,"stats":{"Line":390}},{"line":649,"address":[],"length":0,"stats":{"Line":78}},{"line":650,"address":[],"length":0,"stats":{"Line":13}},{"line":653,"address":[],"length":0,"stats":{"Line":195}},{"line":655,"address":[],"length":0,"stats":{"Line":153}},{"line":656,"address":[],"length":0,"stats":{"Line":616}},{"line":658,"address":[],"length":0,"stats":{"Line":88}},{"line":659,"address":[],"length":0,"stats":{"Line":131}},{"line":660,"address":[],"length":0,"stats":{"Line":43}},{"line":665,"address":[],"length":0,"stats":{"Line":22}},{"line":671,"address":[],"length":0,"stats":{"Line":25}},{"line":675,"address":[],"length":0,"stats":{"Line":125}},{"line":677,"address":[],"length":0,"stats":{"Line":25}},{"line":678,"address":[],"length":0,"stats":{"Line":9}},{"line":681,"address":[],"length":0,"stats":{"Line":48}},{"line":683,"address":[],"length":0,"stats":{"Line":38}},{"line":684,"address":[],"length":0,"stats":{"Line":110}},{"line":686,"address":[],"length":0,"stats":{"Line":22}},{"line":688,"address":[],"length":0,"stats":{"Line":29}},{"line":689,"address":[],"length":0,"stats":{"Line":9}},{"line":693,"address":[],"length":0,"stats":{"Line":23}},{"line":694,"address":[],"length":0,"stats":{"Line":1}},{"line":699,"address":[],"length":0,"stats":{"Line":6}},{"line":702,"address":[],"length":0,"stats":{"Line":230}},{"line":703,"address":[],"length":0,"stats":{"Line":690}},{"line":704,"address":[],"length":0,"stats":{"Line":230}},{"line":706,"address":[],"length":0,"stats":{"Line":7577}},{"line":709,"address":[],"length":0,"stats":{"Line":78}},{"line":710,"address":[],"length":0,"stats":{"Line":234}},{"line":711,"address":[],"length":0,"stats":{"Line":78}},{"line":713,"address":[],"length":0,"stats":{"Line":1902}},{"line":716,"address":[],"length":0,"stats":{"Line":496}},{"line":721,"address":[],"length":0,"stats":{"Line":992}},{"line":722,"address":[],"length":0,"stats":{"Line":452}},{"line":725,"address":[],"length":0,"stats":{"Line":488}},{"line":726,"address":[],"length":0,"stats":{"Line":78}},{"line":727,"address":[],"length":0,"stats":{"Line":26}},{"line":728,"address":[],"length":0,"stats":{"Line":78}},{"line":729,"address":[],"length":0,"stats":{"Line":78}},{"line":730,"address":[],"length":0,"stats":{"Line":26}},{"line":735,"address":[],"length":0,"stats":{"Line":117}},{"line":736,"address":[],"length":0,"stats":{"Line":33}},{"line":737,"address":[],"length":0,"stats":{"Line":11}},{"line":738,"address":[],"length":0,"stats":{"Line":33}},{"line":739,"address":[],"length":0,"stats":{"Line":33}},{"line":740,"address":[],"length":0,"stats":{"Line":11}},{"line":745,"address":[],"length":0,"stats":{"Line":14}},{"line":746,"address":[],"length":0,"stats":{"Line":28}},{"line":747,"address":[],"length":0,"stats":{"Line":14}},{"line":748,"address":[],"length":0,"stats":{"Line":14}},{"line":749,"address":[],"length":0,"stats":{"Line":14}}],"covered":306,"coverable":372},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","mod.rs"],"content":"pub mod aliases;\npub mod cache;\npub mod litellm;\npub mod lookup;\npub mod openrouter;\n\nuse lookup::{LookupResult, PricingLookup};\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse tokio::sync::OnceCell;\n\npub use litellm::ModelPricing;\n\nstatic PRICING_SERVICE: OnceCell\u003cArc\u003cPricingService\u003e\u003e = OnceCell::const_new();\n\npub struct PricingService {\n    lookup: PricingLookup,\n}\n\nimpl PricingService {\n    pub fn new(\n        litellm_data: HashMap\u003cString, ModelPricing\u003e,\n        openrouter_data: HashMap\u003cString, ModelPricing\u003e,\n    ) -\u003e Self {\n        Self {\n            lookup: PricingLookup::new(litellm_data, openrouter_data),\n        }\n    }\n\n    async fn fetch_inner() -\u003e Result\u003cSelf, String\u003e {\n        let (litellm_result, openrouter_data) =\n            tokio::join!(litellm::fetch(), openrouter::fetch_all_mapped());\n\n        let litellm_data = litellm_result.map_err(|e| e.to_string())?;\n\n        Ok(Self::new(litellm_data, openrouter_data))\n    }\n\n    pub async fn get_or_init() -\u003e Result\u003cArc\u003cPricingService\u003e, String\u003e {\n        PRICING_SERVICE\n            .get_or_try_init(|| async { Self::fetch_inner().await.map(Arc::new) })\n            .await\n            .map(Arc::clone)\n    }\n\n    pub fn lookup_with_source(\n        \u0026self,\n        model_id: \u0026str,\n        force_source: Option\u003c\u0026str\u003e,\n    ) -\u003e Option\u003cLookupResult\u003e {\n        self.lookup.lookup_with_source(model_id, force_source)\n    }\n\n    pub fn calculate_cost(\n        \u0026self,\n        model_id: \u0026str,\n        input: i64,\n        output: i64,\n        cache_read: i64,\n        cache_write: i64,\n        reasoning: i64,\n    ) -\u003e f64 {\n        self.lookup\n            .calculate_cost(model_id, input, output, cache_read, cache_write, reasoning)\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":30,"address":[],"length":0,"stats":{"Line":4}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":32,"address":[],"length":0,"stats":{"Line":6}},{"line":34,"address":[],"length":0,"stats":{"Line":6}},{"line":36,"address":[],"length":0,"stats":{"Line":4}},{"line":39,"address":[],"length":0,"stats":{"Line":4}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":12}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":491310}},{"line":63,"address":[],"length":0,"stats":{"Line":491310}},{"line":64,"address":[],"length":0,"stats":{"Line":3439170}}],"covered":15,"coverable":17},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","pricing","openrouter.rs"],"content":"use super::cache;\nuse super::litellm::ModelPricing;\nuse serde::Deserialize;\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse tokio::sync::Semaphore;\n\nconst CACHE_FILENAME: \u0026str = \"pricing-openrouter.json\";\nconst MODELS_URL: \u0026str = \"https://openrouter.ai/api/v1/models\";\nconst MAX_RETRIES: u32 = 3;\nconst INITIAL_BACKOFF_MS: u64 = 200;\nconst MAX_CONCURRENT_REQUESTS: usize = 10;\n\n/// Structs for `/api/v1/models` endpoint (list all models).\n\n#[derive(Deserialize)]\nstruct ModelListPricing {\n    prompt: String,\n    completion: String,\n}\n\n#[derive(Deserialize)]\nstruct ModelListItem {\n    id: String,\n    pricing: Option\u003cModelListPricing\u003e,\n}\n\n#[derive(Deserialize)]\nstruct ModelsListResponse {\n    data: Vec\u003cModelListItem\u003e,\n}\n\n/// Structs for `/api/v1/models/{id}/endpoints` endpoint (author pricing).\n\n#[derive(Deserialize)]\nstruct EndpointPricing {\n    prompt: String,\n    completion: String,\n    #[serde(default)]\n    input_cache_read: Option\u003cString\u003e,\n    #[serde(default)]\n    input_cache_write: Option\u003cString\u003e,\n}\n\n#[derive(Deserialize)]\nstruct Endpoint {\n    provider_name: String,\n    pricing: EndpointPricing,\n}\n\n#[derive(Deserialize)]\nstruct EndpointData {\n    #[allow(dead_code)]\n    id: String,\n    endpoints: Vec\u003cEndpoint\u003e,\n}\n\n#[derive(Deserialize)]\nstruct EndpointsResponse {\n    data: EndpointData,\n}\n\n/// Model ID prefix to provider name mapping.\n///\n/// Translates model ID prefixes like `z-ai` to their corresponding\n/// provider names in the endpoints API, such as `Z.AI`.\nfn get_author_provider_name(model_id: \u0026str) -\u003e Option\u003c\u0026'static str\u003e {\n    let prefix = model_id.split('/').next()?;\n\n    match prefix.to_lowercase().as_str() {\n        \"z-ai\" =\u003e Some(\"Z.AI\"),\n        \"x-ai\" =\u003e Some(\"xAI\"),\n        \"anthropic\" =\u003e Some(\"Anthropic\"),\n        \"openai\" =\u003e Some(\"OpenAI\"),\n        \"google\" =\u003e Some(\"Google\"),\n        \"meta-llama\" =\u003e Some(\"Meta\"),\n        \"mistralai\" =\u003e Some(\"Mistral\"),\n        \"deepseek\" =\u003e Some(\"DeepSeek\"),\n        \"qwen\" =\u003e Some(\"Alibaba\"),\n        \"cohere\" =\u003e Some(\"Cohere\"),\n        \"perplexity\" =\u003e Some(\"Perplexity\"),\n        \"moonshotai\" =\u003e Some(\"Moonshot AI\"),\n        _ =\u003e None,\n    }\n}\n\npub fn load_cached() -\u003e Option\u003cHashMap\u003cString, ModelPricing\u003e\u003e {\n    cache::load_cache(CACHE_FILENAME)\n}\n\nfn parse_price(s: \u0026str) -\u003e Option\u003cf64\u003e {\n    s.trim()\n        .parse::\u003cf64\u003e()\n        .ok()\n        .filter(|v| v.is_finite() \u0026\u0026 *v \u003e= 0.0)\n}\n\nasync fn fetch_author_pricing(\n    client: Arc\u003creqwest::Client\u003e,\n    model_id: String,\n    semaphore: Arc\u003cSemaphore\u003e,\n    fallback_pricing: Option\u003cModelPricing\u003e,\n) -\u003e Option\u003c(String, ModelPricing)\u003e {\n    let _permit = semaphore.acquire().await.ok()?;\n\n    let author_name = match get_author_provider_name(\u0026model_id) {\n        Some(name) =\u003e name,\n        None =\u003e return fallback_pricing.map(|p| (model_id, p)),\n    };\n\n    let url = format!(\"https://openrouter.ai/api/v1/models/{}/endpoints\", model_id);\n\n    let response = match client\n        .get(\u0026url)\n        .header(\"Content-Type\", \"application/json\")\n        .send()\n        .await\n    {\n        Ok(r) =\u003e r,\n        Err(_) =\u003e {\n            return fallback_pricing.map(|p| (model_id, p));\n        }\n    };\n\n    if !response.status().is_success() {\n        return fallback_pricing.map(|p| (model_id, p));\n    }\n\n    let data: EndpointsResponse = match response.json().await {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e {\n            return fallback_pricing.map(|p| (model_id, p));\n        }\n    };\n\n    // Find the endpoint from the author provider\n    let author_endpoint = match data\n        .data\n        .endpoints\n        .iter()\n        .find(|e| e.provider_name == author_name)\n    {\n        Some(ep) =\u003e ep,\n        None =\u003e {\n            return fallback_pricing.map(|p| (model_id, p));\n        }\n    };\n\n    let input_cost = parse_price(\u0026author_endpoint.pricing.prompt);\n    let output_cost = parse_price(\u0026author_endpoint.pricing.completion);\n\n    if input_cost.is_none() || output_cost.is_none() {\n        return fallback_pricing.map(|p| (model_id, p));\n    }\n\n    let pricing = ModelPricing {\n        input_cost_per_token: input_cost,\n        output_cost_per_token: output_cost,\n        cache_read_input_token_cost: author_endpoint\n            .pricing\n            .input_cache_read\n            .as_ref()\n            .and_then(|s| parse_price(s)),\n        cache_creation_input_token_cost: author_endpoint\n            .pricing\n            .input_cache_write\n            .as_ref()\n            .and_then(|s| parse_price(s)),\n    };\n\n    Some((model_id, pricing))\n}\n\n/// Fetch all models and get author pricing for each\npub async fn fetch_all_models() -\u003e HashMap\u003cString, ModelPricing\u003e {\n    if let Some(cached) = load_cached() {\n        return cached;\n    }\n\n    let client = Arc::new(\n        reqwest::Client::builder()\n            .timeout(std::time::Duration::from_secs(30))\n            .connect_timeout(std::time::Duration::from_secs(10))\n            .build()\n            .unwrap_or_default(),\n    );\n\n    let mut last_error: Option\u003cString\u003e = None;\n\n    let models_with_fallback: Vec\u003c(String, Option\u003cModelPricing\u003e)\u003e = 'retry: {\n        for attempt in 0..MAX_RETRIES {\n            let response = match client\n                .get(MODELS_URL)\n                .header(\"Content-Type\", \"application/json\")\n                .send()\n                .await\n            {\n                Ok(r) =\u003e r,\n                Err(e) =\u003e {\n                    last_error = Some(format!(\"network error: {}\", e));\n                    if attempt \u003c MAX_RETRIES - 1 {\n                        tokio::time::sleep(std::time::Duration::from_millis(\n                            INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                        ))\n                        .await;\n                    }\n                    continue;\n                }\n            };\n\n            let status = response.status();\n            if status.is_server_error() || status == reqwest::StatusCode::TOO_MANY_REQUESTS {\n                last_error = Some(format!(\"HTTP {}\", status));\n                let _ = response.bytes().await;\n                if attempt \u003c MAX_RETRIES - 1 {\n                    tokio::time::sleep(std::time::Duration::from_millis(\n                        INITIAL_BACKOFF_MS * (1 \u003c\u003c attempt),\n                    ))\n                    .await;\n                }\n                continue;\n            }\n\n            if !status.is_success() {\n                eprintln!(\"[tokscale] OpenRouter models API returned {}\", status);\n                break 'retry Vec::new();\n            }\n\n            let data: ModelsListResponse = match response.json().await {\n                Ok(d) =\u003e d,\n                Err(e) =\u003e {\n                    eprintln!(\"[tokscale] OpenRouter models JSON parse failed: {}\", e);\n                    break 'retry Vec::new();\n                }\n            };\n\n            break 'retry data\n                .data\n                .into_iter()\n                .map(|m| {\n                    let fallback = m.pricing.and_then(|p| {\n                        let input = parse_price(\u0026p.prompt)?;\n                        let output = parse_price(\u0026p.completion)?;\n                        Some(ModelPricing {\n                            input_cost_per_token: Some(input),\n                            output_cost_per_token: Some(output),\n                            cache_read_input_token_cost: None,\n                            cache_creation_input_token_cost: None,\n                        })\n                    });\n                    (m.id, fallback)\n                })\n                .collect();\n        }\n\n        if let Some(err) = \u0026last_error {\n            eprintln!(\n                \"[tokscale] OpenRouter fetch failed after {} retries: {}\",\n                MAX_RETRIES, err\n            );\n        }\n        Vec::new()\n    };\n\n    if models_with_fallback.is_empty() {\n        return HashMap::new();\n    }\n\n    let models_with_authors: Vec\u003c(String, Option\u003cModelPricing\u003e)\u003e = models_with_fallback\n        .into_iter()\n        .filter(|(id, _)| get_author_provider_name(id).is_some())\n        .collect();\n\n    let semaphore = Arc::new(Semaphore::new(MAX_CONCURRENT_REQUESTS));\n\n    let mut handles = Vec::with_capacity(models_with_authors.len());\n\n    for (model_id, fallback) in models_with_authors {\n        let client = Arc::clone(\u0026client);\n        let sem = Arc::clone(\u0026semaphore);\n\n        let handle =\n            tokio::spawn(\n                async move { fetch_author_pricing(client, model_id, sem, fallback).await },\n            );\n\n        handles.push(handle);\n    }\n\n    // Collect results\n    let mut result = HashMap::new();\n\n    for handle in handles {\n        if let Ok(Some((model_id, pricing))) = handle.await {\n            result.insert(model_id, pricing);\n        }\n    }\n\n    if !result.is_empty() {\n        let _ = cache::save_cache(CACHE_FILENAME, \u0026result);\n    }\n\n    result\n}\n\npub async fn fetch_all_mapped() -\u003e HashMap\u003cString, ModelPricing\u003e {\n    fetch_all_models().await\n}\n","traces":[{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":2}},{"line":88,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":4}},{"line":176,"address":[],"length":0,"stats":{"Line":4}},{"line":177,"address":[],"length":0,"stats":{"Line":2}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":4}},{"line":307,"address":[],"length":0,"stats":{"Line":2}}],"covered":7,"coverable":134},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","scanner.rs"],"content":"//! Parallel file scanner for session directories\n//!\n//! Uses walkdir with rayon for parallel directory traversal.\n\nuse rayon::prelude::*;\nuse std::path::PathBuf;\nuse walkdir::WalkDir;\n\n/// Session source type\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum SessionType {\n    OpenCode,\n    Claude,\n    Codex,\n    Gemini,\n    Cursor,\n    Amp,\n    Droid,\n    OpenClaw,\n    Pi,\n}\n\n/// Result of scanning all session directories\n#[derive(Debug, Default)]\npub struct ScanResult {\n    pub opencode_files: Vec\u003cPathBuf\u003e,\n    pub claude_files: Vec\u003cPathBuf\u003e,\n    pub codex_files: Vec\u003cPathBuf\u003e,\n    pub gemini_files: Vec\u003cPathBuf\u003e,\n    pub cursor_files: Vec\u003cPathBuf\u003e,\n    pub amp_files: Vec\u003cPathBuf\u003e,\n    pub droid_files: Vec\u003cPathBuf\u003e,\n    pub openclaw_files: Vec\u003cPathBuf\u003e,\n    pub pi_files: Vec\u003cPathBuf\u003e,\n}\n\nimpl ScanResult {\n    /// Get total number of files found\n    pub fn total_files(\u0026self) -\u003e usize {\n        self.opencode_files.len()\n            + self.claude_files.len()\n            + self.codex_files.len()\n            + self.gemini_files.len()\n            + self.cursor_files.len()\n            + self.amp_files.len()\n            + self.droid_files.len()\n            + self.openclaw_files.len()\n            + self.pi_files.len()\n    }\n\n    /// Get all files as a single vector\n    pub fn all_files(\u0026self) -\u003e Vec\u003c(SessionType, PathBuf)\u003e {\n        let mut result = Vec::with_capacity(self.total_files());\n\n        for path in \u0026self.opencode_files {\n            result.push((SessionType::OpenCode, path.clone()));\n        }\n        for path in \u0026self.claude_files {\n            result.push((SessionType::Claude, path.clone()));\n        }\n        for path in \u0026self.codex_files {\n            result.push((SessionType::Codex, path.clone()));\n        }\n        for path in \u0026self.gemini_files {\n            result.push((SessionType::Gemini, path.clone()));\n        }\n        for path in \u0026self.cursor_files {\n            result.push((SessionType::Cursor, path.clone()));\n        }\n        for path in \u0026self.amp_files {\n            result.push((SessionType::Amp, path.clone()));\n        }\n        for path in \u0026self.droid_files {\n            result.push((SessionType::Droid, path.clone()));\n        }\n        for path in \u0026self.openclaw_files {\n            result.push((SessionType::OpenClaw, path.clone()));\n        }\n        for path in \u0026self.pi_files {\n            result.push((SessionType::Pi, path.clone()));\n        }\n\n        result\n    }\n}\n\npub fn headless_roots(home_dir: \u0026str) -\u003e Vec\u003cPathBuf\u003e {\n    if let Ok(path) = std::env::var(\"TOKSCALE_HEADLESS_DIR\") {\n        return vec![PathBuf::from(path)];\n    }\n\n    let mut roots = Vec::new();\n    roots.push(PathBuf::from(format!(\n        \"{}/.config/tokscale/headless\",\n        home_dir\n    )));\n\n    let mac_root = PathBuf::from(format!(\n        \"{}/Library/Application Support/tokscale/headless\",\n        home_dir\n    ));\n    roots.push(mac_root);\n\n    roots\n}\n\n/// Scan a single directory for session files\npub fn scan_directory(root: \u0026str, pattern: \u0026str) -\u003e Vec\u003cPathBuf\u003e {\n    if !std::path::Path::new(root).exists() {\n        return Vec::new();\n    }\n\n    WalkDir::new(root)\n        .into_iter()\n        .par_bridge()\n        .filter_map(|e| e.ok())\n        .filter(|e| {\n            let path = e.path();\n            if !path.is_file() {\n                return false;\n            }\n\n            let file_name = path.file_name().and_then(|n| n.to_str()).unwrap_or(\"\");\n\n            let is_in_archive_dir = path.components().any(|c| {\n                c.as_os_str()\n                    .to_string_lossy()\n                    .eq_ignore_ascii_case(\"archive\")\n            });\n\n            match pattern {\n                \"*.json\" =\u003e file_name.ends_with(\".json\"),\n                \"*.jsonl\" =\u003e file_name.ends_with(\".jsonl\"),\n                \"*.csv\" =\u003e file_name.ends_with(\".csv\"),\n                \"usage*.csv\" =\u003e {\n                    if is_in_archive_dir {\n                        return false;\n                    }\n\n                    if file_name == \"usage.csv\" {\n                        return true;\n                    }\n\n                    // Accept only per-account files: usage.\u003caccount\u003e.csv\n                    if !file_name.starts_with(\"usage.\") || !file_name.ends_with(\".csv\") {\n                        return false;\n                    }\n\n                    // Exclude legacy backups like usage.backup-\u003cts\u003e.csv\n                    if file_name.starts_with(\"usage.backup\") {\n                        return false;\n                    }\n\n                    true\n                }\n                \"session-*.json\" =\u003e {\n                    file_name.starts_with(\"session-\") \u0026\u0026 file_name.ends_with(\".json\")\n                }\n                \"T-*.json\" =\u003e file_name.starts_with(\"T-\") \u0026\u0026 file_name.ends_with(\".json\"),\n                \"*.settings.json\" =\u003e file_name.ends_with(\".settings.json\"),\n                \"sessions.json\" =\u003e file_name == \"sessions.json\",\n                _ =\u003e false,\n            }\n        })\n        .map(|e| e.path().to_path_buf())\n        .collect()\n}\n\n/// Scan all session source directories in parallel\npub fn scan_all_sources(home_dir: \u0026str, sources: \u0026[String]) -\u003e ScanResult {\n    let mut result = ScanResult::default();\n\n    let include_all = sources.is_empty();\n    let include_opencode = include_all || sources.iter().any(|s| s == \"opencode\");\n    let include_claude = include_all || sources.iter().any(|s| s == \"claude\");\n    let include_codex = include_all || sources.iter().any(|s| s == \"codex\");\n    let include_gemini = include_all || sources.iter().any(|s| s == \"gemini\");\n    let include_cursor = include_all || sources.iter().any(|s| s == \"cursor\");\n    let include_amp = include_all || sources.iter().any(|s| s == \"amp\");\n    let include_droid = include_all || sources.iter().any(|s| s == \"droid\");\n    let include_openclaw = include_all || sources.iter().any(|s| s == \"openclaw\");\n    let include_pi = include_all || sources.iter().any(|s| s == \"pi\");\n\n    let headless_roots = headless_roots(home_dir);\n\n    // Define scan tasks\n    let mut tasks: Vec\u003c(SessionType, String, \u0026str)\u003e = Vec::new();\n\n    if include_opencode {\n        // OpenCode: ~/.local/share/opencode/storage/message/*/*.json\n        let xdg_data =\n            std::env::var(\"XDG_DATA_HOME\").unwrap_or_else(|_| format!(\"{}/.local/share\", home_dir));\n        let opencode_path = format!(\"{}/opencode/storage/message\", xdg_data);\n        tasks.push((SessionType::OpenCode, opencode_path, \"*.json\"));\n    }\n\n    if include_claude {\n        // Claude: ~/.claude/projects/**/*.jsonl\n        let claude_path = format!(\"{}/.claude/projects\", home_dir);\n        tasks.push((SessionType::Claude, claude_path, \"*.jsonl\"));\n    }\n\n    if include_codex {\n        // Codex: ~/.codex/sessions/**/*.jsonl\n        let codex_home =\n            std::env::var(\"CODEX_HOME\").unwrap_or_else(|_| format!(\"{}/.codex\", home_dir));\n        let codex_path = format!(\"{}/sessions\", codex_home);\n        tasks.push((SessionType::Codex, codex_path, \"*.jsonl\"));\n\n        // Codex headless: \u003cheadless_root\u003e/codex/*.jsonl\n        for root in \u0026headless_roots {\n            let codex_headless_path = root.join(\"codex\");\n            let path = codex_headless_path.to_string_lossy().to_string();\n            tasks.push((SessionType::Codex, path, \"*.jsonl\"));\n        }\n    }\n\n    if include_gemini {\n        // Gemini: ~/.gemini/tmp/*/chats/session-*.json\n        let gemini_path = format!(\"{}/.gemini/tmp\", home_dir);\n        tasks.push((SessionType::Gemini, gemini_path, \"session-*.json\"));\n    }\n\n    if include_cursor {\n        // Cursor: ~/.config/tokscale/cursor-cache/*.csv (migrated from ~/.tokscale)\n        let cursor_path = format!(\"{}/.config/tokscale/cursor-cache\", home_dir);\n        // Only scan Cursor usage CSVs to avoid counting unrelated CSVs.\n        tasks.push((SessionType::Cursor, cursor_path, \"usage*.csv\"));\n    }\n\n    if include_amp {\n        // Amp: ~/.local/share/amp/threads/T-*.json\n        let xdg_data =\n            std::env::var(\"XDG_DATA_HOME\").unwrap_or_else(|_| format!(\"{}/.local/share\", home_dir));\n        let amp_path = format!(\"{}/amp/threads\", xdg_data);\n        tasks.push((SessionType::Amp, amp_path, \"T-*.json\"));\n    }\n\n    if include_droid {\n        // Droid: ~/.factory/sessions/*.settings.json\n        let droid_path = format!(\"{}/.factory/sessions\", home_dir);\n        tasks.push((SessionType::Droid, droid_path, \"*.settings.json\"));\n    }\n\n    if include_openclaw {\n        // Current path\n        let openclaw_path = format!(\"{}/.openclaw/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, openclaw_path, \"sessions.json\"));\n        // Legacy paths (Clawd -\u003e Moltbot -\u003e OpenClaw rebrand history)\n        let clawdbot_path = format!(\"{}/.clawdbot/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, clawdbot_path, \"sessions.json\"));\n        let moltbot_path = format!(\"{}/.moltbot/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, moltbot_path, \"sessions.json\"));\n        let moldbot_path = format!(\"{}/.moldbot/agents\", home_dir);\n        tasks.push((SessionType::OpenClaw, moldbot_path, \"sessions.json\"));\n    }\n\n    if include_pi {\n        // Pi (badlogic/pi-mono): ~/.pi/agent/sessions/**/*.jsonl\n        let pi_path = format!(\"{}/.pi/agent/sessions\", home_dir);\n        tasks.push((SessionType::Pi, pi_path, \"*.jsonl\"));\n    }\n\n    // Execute scans in parallel\n    let scan_results: Vec\u003c(SessionType, Vec\u003cPathBuf\u003e)\u003e = tasks\n        .into_par_iter()\n        .map(|(session_type, path, pattern)| {\n            let files = scan_directory(\u0026path, pattern);\n            (session_type, files)\n        })\n        .collect();\n\n    // Aggregate results\n    for (session_type, files) in scan_results {\n        match session_type {\n            SessionType::OpenCode =\u003e result.opencode_files.extend(files),\n            SessionType::Claude =\u003e result.claude_files.extend(files),\n            SessionType::Codex =\u003e result.codex_files.extend(files),\n            SessionType::Gemini =\u003e result.gemini_files.extend(files),\n            SessionType::Cursor =\u003e result.cursor_files.extend(files),\n            SessionType::Amp =\u003e result.amp_files.extend(files),\n            SessionType::Droid =\u003e result.droid_files.extend(files),\n            SessionType::OpenClaw =\u003e result.openclaw_files.extend(files),\n            SessionType::Pi =\u003e result.pi_files.extend(files),\n        }\n    }\n\n    result\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serial_test::serial;\n    use std::fs::{self, File};\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    fn restore_env(var: \u0026str, previous: Option\u003cString\u003e) {\n        match previous {\n            Some(value) =\u003e std::env::set_var(var, value),\n            None =\u003e std::env::remove_var(var),\n        }\n    }\n\n    #[test]\n    fn test_scan_result_total_files() {\n        let result = ScanResult {\n            opencode_files: vec![PathBuf::from(\"a.json\"), PathBuf::from(\"b.json\")],\n            claude_files: vec![PathBuf::from(\"c.jsonl\")],\n            codex_files: vec![],\n            gemini_files: vec![PathBuf::from(\"d.json\")],\n            cursor_files: vec![],\n            amp_files: vec![],\n            droid_files: vec![],\n            openclaw_files: vec![],\n            pi_files: vec![PathBuf::from(\"e.jsonl\")],\n        };\n        assert_eq!(result.total_files(), 5);\n    }\n\n    #[test]\n    fn test_scan_result_all_files() {\n        let result = ScanResult {\n            opencode_files: vec![PathBuf::from(\"a.json\")],\n            claude_files: vec![PathBuf::from(\"b.jsonl\")],\n            codex_files: vec![PathBuf::from(\"c.jsonl\")],\n            gemini_files: vec![PathBuf::from(\"d.json\")],\n            cursor_files: vec![PathBuf::from(\"e.csv\")],\n            amp_files: vec![],\n            droid_files: vec![],\n            openclaw_files: vec![],\n            pi_files: vec![PathBuf::from(\"f.jsonl\")],\n        };\n\n        let all = result.all_files();\n        assert_eq!(all.len(), 6);\n        assert_eq!(all[0], (SessionType::OpenCode, PathBuf::from(\"a.json\")));\n        assert_eq!(all[1], (SessionType::Claude, PathBuf::from(\"b.jsonl\")));\n        assert_eq!(all[2], (SessionType::Codex, PathBuf::from(\"c.jsonl\")));\n        assert_eq!(all[3], (SessionType::Gemini, PathBuf::from(\"d.json\")));\n        assert_eq!(all[4], (SessionType::Cursor, PathBuf::from(\"e.csv\")));\n        assert_eq!(all[5], (SessionType::Pi, PathBuf::from(\"f.jsonl\")));\n    }\n\n    #[test]\n    fn test_scan_result_empty() {\n        let result = ScanResult::default();\n        assert_eq!(result.total_files(), 0);\n        assert!(result.all_files().is_empty());\n    }\n\n    #[test]\n    fn test_session_type_equality() {\n        assert_eq!(SessionType::OpenCode, SessionType::OpenCode);\n        assert_ne!(SessionType::OpenCode, SessionType::Claude);\n    }\n\n    #[test]\n    fn test_scan_directory_json_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        // Create test files\n        File::create(path.join(\"test1.json\")).unwrap();\n        File::create(path.join(\"test2.json\")).unwrap();\n        File::create(path.join(\"data.txt\")).unwrap();\n        File::create(path.join(\"other.jsonl\")).unwrap();\n\n        let json_files = scan_directory(path.to_str().unwrap(), \"*.json\");\n        assert_eq!(json_files.len(), 2);\n        assert!(json_files.iter().all(|p| p.extension().unwrap() == \"json\"));\n    }\n\n    #[test]\n    fn test_scan_directory_jsonl_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        File::create(path.join(\"session.jsonl\")).unwrap();\n        File::create(path.join(\"log.jsonl\")).unwrap();\n        File::create(path.join(\"data.json\")).unwrap();\n\n        let jsonl_files = scan_directory(path.to_str().unwrap(), \"*.jsonl\");\n        assert_eq!(jsonl_files.len(), 2);\n        assert!(jsonl_files\n            .iter()\n            .all(|p| p.extension().unwrap() == \"jsonl\"));\n    }\n\n    #[test]\n    fn test_scan_directory_session_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        File::create(path.join(\"session-001.json\")).unwrap();\n        File::create(path.join(\"session-abc.json\")).unwrap();\n        File::create(path.join(\"other.json\")).unwrap();\n        File::create(path.join(\"session.json\")).unwrap(); // Shouldn't match\n\n        let session_files = scan_directory(path.to_str().unwrap(), \"session-*.json\");\n        assert_eq!(session_files.len(), 2);\n        assert!(session_files.iter().all(|p| {\n            let name = p.file_name().unwrap().to_str().unwrap();\n            name.starts_with(\"session-\") \u0026\u0026 name.ends_with(\".json\")\n        }));\n    }\n\n    #[test]\n    fn test_scan_directory_nested() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        // Create nested structure\n        let sub1 = path.join(\"project1\");\n        let sub2 = path.join(\"project2\");\n        fs::create_dir_all(\u0026sub1).unwrap();\n        fs::create_dir_all(\u0026sub2).unwrap();\n\n        File::create(sub1.join(\"session.json\")).unwrap();\n        File::create(sub2.join(\"session.json\")).unwrap();\n        File::create(path.join(\"root.json\")).unwrap();\n\n        let files = scan_directory(path.to_str().unwrap(), \"*.json\");\n        assert_eq!(files.len(), 3);\n    }\n\n    #[test]\n    fn test_scan_directory_csv_pattern() {\n        let dir = TempDir::new().unwrap();\n        let path = dir.path();\n\n        File::create(path.join(\"usage.csv\")).unwrap();\n        File::create(path.join(\"data.csv\")).unwrap();\n        File::create(path.join(\"other.json\")).unwrap();\n\n        let csv_files = scan_directory(path.to_str().unwrap(), \"*.csv\");\n        assert_eq!(csv_files.len(), 2);\n        assert!(csv_files.iter().all(|p| p.extension().unwrap() == \"csv\"));\n    }\n\n    #[test]\n    fn test_scan_directory_nonexistent() {\n        let files = scan_directory(\"/nonexistent/path/that/does/not/exist\", \"*.json\");\n        assert!(files.is_empty());\n    }\n\n    #[test]\n    fn test_scan_directory_empty() {\n        let dir = TempDir::new().unwrap();\n        let files = scan_directory(dir.path().to_str().unwrap(), \"*.json\");\n        assert!(files.is_empty());\n    }\n\n    fn setup_mock_opencode_dir(base: \u0026std::path::Path) {\n        let opencode_path = base.join(\".local/share/opencode/storage/message/proj1\");\n        fs::create_dir_all(\u0026opencode_path).unwrap();\n        let mut file = File::create(opencode_path.join(\"msg_001.json\")).unwrap();\n        file.write_all(b\"{}\").unwrap();\n    }\n\n    fn setup_mock_claude_dir(base: \u0026std::path::Path) {\n        let claude_path = base.join(\".claude/projects/myproject\");\n        fs::create_dir_all(\u0026claude_path).unwrap();\n        let mut file = File::create(claude_path.join(\"conversation.jsonl\")).unwrap();\n        file.write_all(b\"\").unwrap();\n    }\n\n    fn setup_mock_codex_dir(base: \u0026std::path::Path) {\n        let codex_path = base.join(\".codex/sessions\");\n        fs::create_dir_all(\u0026codex_path).unwrap();\n        let mut file = File::create(codex_path.join(\"session.jsonl\")).unwrap();\n        file.write_all(b\"\").unwrap();\n    }\n\n    fn setup_mock_gemini_dir(base: \u0026std::path::Path) {\n        let gemini_path = base.join(\".gemini/tmp/123/chats\");\n        fs::create_dir_all(\u0026gemini_path).unwrap();\n        let mut file = File::create(gemini_path.join(\"session-abc.json\")).unwrap();\n        file.write_all(b\"{}\").unwrap();\n    }\n\n    #[test]\n    #[serial]\n    fn test_headless_roots_default() {\n        let previous = std::env::var(\"TOKSCALE_HEADLESS_DIR\").ok();\n        std::env::remove_var(\"TOKSCALE_HEADLESS_DIR\");\n\n        let home = \"/tmp/tokscale-test-home\";\n        let roots = headless_roots(home);\n        let config_root = PathBuf::from(format!(\"{}/.config/tokscale/headless\", home));\n        let mac_root = PathBuf::from(format!(\n            \"{}/Library/Application Support/tokscale/headless\",\n            home\n        ));\n\n        assert_eq!(roots.len(), 2);\n        assert!(roots.contains(\u0026config_root));\n        assert!(roots.contains(\u0026mac_root));\n\n        restore_env(\"TOKSCALE_HEADLESS_DIR\", previous);\n    }\n\n    #[test]\n    #[serial]\n    fn test_headless_roots_override() {\n        let previous = std::env::var(\"TOKSCALE_HEADLESS_DIR\").ok();\n        std::env::set_var(\"TOKSCALE_HEADLESS_DIR\", \"/custom/headless\");\n\n        let roots = headless_roots(\"/tmp/home\");\n        assert_eq!(roots, vec![PathBuf::from(\"/custom/headless\")]);\n\n        restore_env(\"TOKSCALE_HEADLESS_DIR\", previous);\n    }\n\n    #[test]\n    #[serial]\n    fn test_scan_all_sources_opencode() {\n        let previous_xdg = std::env::var(\"XDG_DATA_HOME\").ok();\n\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_opencode_dir(home);\n\n        // Set XDG_DATA_HOME for the test\n        std::env::set_var(\"XDG_DATA_HOME\", home.join(\".local/share\"));\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"opencode\".to_string()]);\n        assert_eq!(result.opencode_files.len(), 1);\n        assert!(result.claude_files.is_empty());\n        assert!(result.codex_files.is_empty());\n        assert!(result.gemini_files.is_empty());\n\n        restore_env(\"XDG_DATA_HOME\", previous_xdg);\n    }\n\n    #[test]\n    fn test_scan_all_sources_claude() {\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_claude_dir(home);\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"claude\".to_string()]);\n        assert_eq!(result.claude_files.len(), 1);\n        assert!(result.opencode_files.is_empty());\n    }\n\n    #[test]\n    fn test_scan_all_sources_gemini() {\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_gemini_dir(home);\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"gemini\".to_string()]);\n        assert_eq!(result.gemini_files.len(), 1);\n        assert!(result.opencode_files.is_empty());\n    }\n\n    #[test]\n    fn test_scan_all_sources_multiple() {\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n\n        setup_mock_claude_dir(home);\n        setup_mock_gemini_dir(home);\n\n        let result = scan_all_sources(\n            home.to_str().unwrap(),\n            \u0026[\"claude\".to_string(), \"gemini\".to_string()],\n        );\n\n        assert_eq!(result.claude_files.len(), 1);\n        assert_eq!(result.gemini_files.len(), 1);\n        assert!(result.opencode_files.is_empty());\n        assert!(result.codex_files.is_empty());\n    }\n\n    #[test]\n    #[serial]\n    fn test_scan_all_sources_headless_paths() {\n        let previous_headless = std::env::var(\"TOKSCALE_HEADLESS_DIR\").ok();\n        std::env::remove_var(\"TOKSCALE_HEADLESS_DIR\");\n\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n\n        let mac_root = home\n            .join(\"Library\")\n            .join(\"Application Support\")\n            .join(\"tokscale\")\n            .join(\"headless\");\n\n        fs::create_dir_all(mac_root.join(\"codex\")).unwrap();\n        File::create(mac_root.join(\"codex\").join(\"codex.jsonl\")).unwrap();\n\n        let result = scan_all_sources(\n            home.to_str().unwrap(),\n            \u0026[\n                \"claude\".to_string(),\n                \"codex\".to_string(),\n                \"gemini\".to_string(),\n            ],\n        );\n\n        assert!(result.claude_files.is_empty());\n        assert_eq!(result.codex_files.len(), 1);\n        assert!(result.gemini_files.is_empty());\n\n        restore_env(\"TOKSCALE_HEADLESS_DIR\", previous_headless);\n    }\n\n    #[test]\n    #[serial]\n    fn test_scan_all_sources_codex_with_env() {\n        let previous_codex = std::env::var(\"CODEX_HOME\").ok();\n\n        let dir = TempDir::new().unwrap();\n        let home = dir.path();\n        setup_mock_codex_dir(home);\n\n        // Set CODEX_HOME environment variable\n        std::env::set_var(\"CODEX_HOME\", home.join(\".codex\"));\n\n        let result = scan_all_sources(home.to_str().unwrap(), \u0026[\"codex\".to_string()]);\n        assert_eq!(result.codex_files.len(), 1);\n\n        restore_env(\"CODEX_HOME\", previous_codex);\n    }\n}\n","traces":[{"line":39,"address":[],"length":0,"stats":{"Line":4}},{"line":40,"address":[],"length":0,"stats":{"Line":40}},{"line":41,"address":[],"length":0,"stats":{"Line":32}},{"line":42,"address":[],"length":0,"stats":{"Line":28}},{"line":43,"address":[],"length":0,"stats":{"Line":24}},{"line":44,"address":[],"length":0,"stats":{"Line":20}},{"line":45,"address":[],"length":0,"stats":{"Line":16}},{"line":46,"address":[],"length":0,"stats":{"Line":12}},{"line":47,"address":[],"length":0,"stats":{"Line":8}},{"line":48,"address":[],"length":0,"stats":{"Line":4}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":8}},{"line":55,"address":[],"length":0,"stats":{"Line":4}},{"line":56,"address":[],"length":0,"stats":{"Line":4}},{"line":58,"address":[],"length":0,"stats":{"Line":4}},{"line":59,"address":[],"length":0,"stats":{"Line":4}},{"line":61,"address":[],"length":0,"stats":{"Line":4}},{"line":62,"address":[],"length":0,"stats":{"Line":4}},{"line":64,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":4}},{"line":68,"address":[],"length":0,"stats":{"Line":4}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":4}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":83,"address":[],"length":0,"stats":{"Line":2}},{"line":87,"address":[],"length":0,"stats":{"Line":10}},{"line":88,"address":[],"length":0,"stats":{"Line":11}},{"line":89,"address":[],"length":0,"stats":{"Line":3}},{"line":92,"address":[],"length":0,"stats":{"Line":18}},{"line":93,"address":[],"length":0,"stats":{"Line":36}},{"line":98,"address":[],"length":0,"stats":{"Line":27}},{"line":102,"address":[],"length":0,"stats":{"Line":27}},{"line":104,"address":[],"length":0,"stats":{"Line":9}},{"line":108,"address":[],"length":0,"stats":{"Line":48}},{"line":109,"address":[],"length":0,"stats":{"Line":48}},{"line":110,"address":[],"length":0,"stats":{"Line":13}},{"line":113,"address":[],"length":0,"stats":{"Line":70}},{"line":116,"address":[],"length":0,"stats":{"Line":1288391}},{"line":117,"address":[],"length":0,"stats":{"Line":644213}},{"line":118,"address":[],"length":0,"stats":{"Line":1932534}},{"line":119,"address":[],"length":0,"stats":{"Line":644178}},{"line":120,"address":[],"length":0,"stats":{"Line":35714}},{"line":123,"address":[],"length":0,"stats":{"Line":4867712}},{"line":125,"address":[],"length":0,"stats":{"Line":7905045}},{"line":126,"address":[],"length":0,"stats":{"Line":12159306}},{"line":127,"address":[],"length":0,"stats":{"Line":12159306}},{"line":128,"address":[],"length":0,"stats":{"Line":6079653}},{"line":131,"address":[],"length":0,"stats":{"Line":608464}},{"line":132,"address":[],"length":0,"stats":{"Line":1820260}},{"line":133,"address":[],"length":0,"stats":{"Line":6828}},{"line":134,"address":[],"length":0,"stats":{"Line":441}},{"line":135,"address":[],"length":0,"stats":{"Line":432}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":2}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":430}},{"line":157,"address":[],"length":0,"stats":{"Line":136}},{"line":159,"address":[],"length":0,"stats":{"Line":406}},{"line":160,"address":[],"length":0,"stats":{"Line":394}},{"line":161,"address":[],"length":0,"stats":{"Line":764}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":1215367}},{"line":170,"address":[],"length":0,"stats":{"Line":8}},{"line":171,"address":[],"length":0,"stats":{"Line":16}},{"line":173,"address":[],"length":0,"stats":{"Line":24}},{"line":174,"address":[],"length":0,"stats":{"Line":54}},{"line":175,"address":[],"length":0,"stats":{"Line":52}},{"line":176,"address":[],"length":0,"stats":{"Line":60}},{"line":177,"address":[],"length":0,"stats":{"Line":66}},{"line":178,"address":[],"length":0,"stats":{"Line":70}},{"line":179,"address":[],"length":0,"stats":{"Line":74}},{"line":180,"address":[],"length":0,"stats":{"Line":78}},{"line":181,"address":[],"length":0,"stats":{"Line":82}},{"line":182,"address":[],"length":0,"stats":{"Line":86}},{"line":184,"address":[],"length":0,"stats":{"Line":24}},{"line":187,"address":[],"length":0,"stats":{"Line":24}},{"line":189,"address":[],"length":0,"stats":{"Line":8}},{"line":191,"address":[],"length":0,"stats":{"Line":3}},{"line":192,"address":[],"length":0,"stats":{"Line":8}},{"line":193,"address":[],"length":0,"stats":{"Line":6}},{"line":194,"address":[],"length":0,"stats":{"Line":12}},{"line":197,"address":[],"length":0,"stats":{"Line":13}},{"line":199,"address":[],"length":0,"stats":{"Line":15}},{"line":200,"address":[],"length":0,"stats":{"Line":20}},{"line":203,"address":[],"length":0,"stats":{"Line":8}},{"line":205,"address":[],"length":0,"stats":{"Line":4}},{"line":206,"address":[],"length":0,"stats":{"Line":11}},{"line":207,"address":[],"length":0,"stats":{"Line":8}},{"line":208,"address":[],"length":0,"stats":{"Line":16}},{"line":211,"address":[],"length":0,"stats":{"Line":20}},{"line":212,"address":[],"length":0,"stats":{"Line":24}},{"line":213,"address":[],"length":0,"stats":{"Line":32}},{"line":214,"address":[],"length":0,"stats":{"Line":32}},{"line":218,"address":[],"length":0,"stats":{"Line":13}},{"line":220,"address":[],"length":0,"stats":{"Line":15}},{"line":221,"address":[],"length":0,"stats":{"Line":20}},{"line":224,"address":[],"length":0,"stats":{"Line":10}},{"line":226,"address":[],"length":0,"stats":{"Line":6}},{"line":228,"address":[],"length":0,"stats":{"Line":8}},{"line":231,"address":[],"length":0,"stats":{"Line":8}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":6}},{"line":235,"address":[],"length":0,"stats":{"Line":4}},{"line":236,"address":[],"length":0,"stats":{"Line":8}},{"line":239,"address":[],"length":0,"stats":{"Line":10}},{"line":241,"address":[],"length":0,"stats":{"Line":6}},{"line":242,"address":[],"length":0,"stats":{"Line":8}},{"line":245,"address":[],"length":0,"stats":{"Line":10}},{"line":247,"address":[],"length":0,"stats":{"Line":6}},{"line":248,"address":[],"length":0,"stats":{"Line":10}},{"line":250,"address":[],"length":0,"stats":{"Line":6}},{"line":251,"address":[],"length":0,"stats":{"Line":10}},{"line":252,"address":[],"length":0,"stats":{"Line":6}},{"line":253,"address":[],"length":0,"stats":{"Line":10}},{"line":254,"address":[],"length":0,"stats":{"Line":6}},{"line":255,"address":[],"length":0,"stats":{"Line":8}},{"line":258,"address":[],"length":0,"stats":{"Line":10}},{"line":260,"address":[],"length":0,"stats":{"Line":6}},{"line":261,"address":[],"length":0,"stats":{"Line":8}},{"line":265,"address":[],"length":0,"stats":{"Line":24}},{"line":267,"address":[],"length":0,"stats":{"Line":49}},{"line":268,"address":[],"length":0,"stats":{"Line":164}},{"line":269,"address":[],"length":0,"stats":{"Line":41}},{"line":274,"address":[],"length":0,"stats":{"Line":90}},{"line":275,"address":[],"length":0,"stats":{"Line":41}},{"line":276,"address":[],"length":0,"stats":{"Line":9}},{"line":277,"address":[],"length":0,"stats":{"Line":15}},{"line":278,"address":[],"length":0,"stats":{"Line":36}},{"line":279,"address":[],"length":0,"stats":{"Line":15}},{"line":280,"address":[],"length":0,"stats":{"Line":6}},{"line":281,"address":[],"length":0,"stats":{"Line":6}},{"line":282,"address":[],"length":0,"stats":{"Line":6}},{"line":283,"address":[],"length":0,"stats":{"Line":24}},{"line":284,"address":[],"length":0,"stats":{"Line":6}},{"line":288,"address":[],"length":0,"stats":{"Line":8}}],"covered":137,"coverable":147},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","amp.rs"],"content":"//! Amp (Sourcegraph) session parser\n//!\n//! Parses JSON files from ~/.local/share/amp/threads/\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::path::Path;\n\n/// Amp usage event from usageLedger\n#[derive(Debug, Deserialize)]\npub struct AmpUsageEvent {\n    pub timestamp: Option\u003cString\u003e,\n    pub model: Option\u003cString\u003e,\n    pub credits: Option\u003cf64\u003e,\n    pub tokens: Option\u003cAmpTokens\u003e,\n    #[serde(rename = \"operationType\")]\n    pub _operation_type: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpTokens {\n    pub input: Option\u003ci64\u003e,\n    pub output: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheReadInputTokens\")]\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheCreationInputTokens\")]\n    pub cache_creation_input_tokens: Option\u003ci64\u003e,\n}\n\n/// Amp message usage (per-message, more detailed)\n#[derive(Debug, Deserialize)]\npub struct AmpMessageUsage {\n    pub model: Option\u003cString\u003e,\n    #[serde(rename = \"inputTokens\")]\n    pub input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"outputTokens\")]\n    pub output_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheReadInputTokens\")]\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheCreationInputTokens\")]\n    pub cache_creation_input_tokens: Option\u003ci64\u003e,\n    pub credits: Option\u003cf64\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpMessage {\n    pub role: Option\u003cString\u003e,\n    #[serde(rename = \"messageId\")]\n    pub message_id: Option\u003ci64\u003e,\n    pub usage: Option\u003cAmpMessageUsage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpUsageLedger {\n    pub events: Option\u003cVec\u003cAmpUsageEvent\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct AmpThread {\n    pub id: Option\u003cString\u003e,\n    pub created: Option\u003ci64\u003e,\n    pub messages: Option\u003cVec\u003cAmpMessage\u003e\u003e,\n    #[serde(rename = \"usageLedger\")]\n    pub usage_ledger: Option\u003cAmpUsageLedger\u003e,\n}\n\n/// Get provider from model name\nfn get_provider_from_model(model: \u0026str) -\u003e \u0026'static str {\n    let model_lower = model.to_lowercase();\n    if model_lower.contains(\"claude\")\n        || model_lower.contains(\"opus\")\n        || model_lower.contains(\"sonnet\")\n        || model_lower.contains(\"haiku\")\n    {\n        return \"anthropic\";\n    }\n    if model_lower.contains(\"gpt\") || model_lower.contains(\"o1\") || model_lower.contains(\"o3\") {\n        return \"openai\";\n    }\n    if model_lower.contains(\"gemini\") {\n        return \"google\";\n    }\n    if model_lower.contains(\"grok\") {\n        return \"xai\";\n    }\n    \"anthropic\" // Default for Amp\n}\n\n/// Parse an Amp thread JSON file\npub fn parse_amp_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let content = match std::fs::read(path) {\n        Ok(c) =\u003e c,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = content;\n    let thread: AmpThread = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(t) =\u003e t,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let thread_id = thread.id.clone().unwrap_or_else(|| {\n        path.file_stem()\n            .and_then(|s| s.to_str())\n            .unwrap_or(\"unknown\")\n            .to_string()\n    });\n\n    let mut messages = Vec::new();\n\n    // Prefer usageLedger.events (cleaner aggregated data)\n    if let Some(ledger) = thread.usage_ledger {\n        if let Some(events) = ledger.events {\n            for event in events {\n                let model = match event.model {\n                    Some(m) =\u003e m,\n                    None =\u003e continue,\n                };\n\n                let timestamp = event\n                    .timestamp\n                    .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n                    .map(|dt| dt.timestamp_millis())\n                    .unwrap_or(0);\n\n                if timestamp == 0 {\n                    continue;\n                }\n\n                let tokens = event.tokens.unwrap_or(AmpTokens {\n                    input: Some(0),\n                    output: Some(0),\n                    cache_read_input_tokens: Some(0),\n                    cache_creation_input_tokens: Some(0),\n                });\n\n                messages.push(UnifiedMessage::new(\n                    \"amp\",\n                    \u0026model,\n                    get_provider_from_model(\u0026model),\n                    thread_id.clone(),\n                    timestamp,\n                    TokenBreakdown {\n                        input: tokens.input.unwrap_or(0).max(0),\n                        output: tokens.output.unwrap_or(0).max(0),\n                        cache_read: tokens.cache_read_input_tokens.unwrap_or(0).max(0),\n                        cache_write: tokens.cache_creation_input_tokens.unwrap_or(0).max(0),\n                        reasoning: 0,\n                    },\n                    event.credits.unwrap_or(0.0).max(0.0),\n                ));\n            }\n            if !messages.is_empty() {\n                return messages;\n            }\n        }\n    }\n\n    // Fallback: parse from individual message usage\n    let created = thread.created.unwrap_or(0);\n    if let Some(thread_messages) = thread.messages {\n        for msg in thread_messages {\n            if msg.role.as_deref() != Some(\"assistant\") {\n                continue;\n            }\n\n            let usage = match msg.usage {\n                Some(u) =\u003e u,\n                None =\u003e continue,\n            };\n\n            let model = match usage.model {\n                Some(m) =\u003e m,\n                None =\u003e continue,\n            };\n\n            // Approximate timestamp from created + messageId offset\n            let message_id = msg.message_id.unwrap_or(0);\n            let timestamp = created + (message_id * 1000);\n\n            messages.push(UnifiedMessage::new(\n                \"amp\",\n                \u0026model,\n                get_provider_from_model(\u0026model),\n                thread_id.clone(),\n                timestamp,\n                TokenBreakdown {\n                    input: usage.input_tokens.unwrap_or(0).max(0),\n                    output: usage.output_tokens.unwrap_or(0).max(0),\n                    cache_read: usage.cache_read_input_tokens.unwrap_or(0).max(0),\n                    cache_write: usage.cache_creation_input_tokens.unwrap_or(0).max(0),\n                    reasoning: 0,\n                },\n                usage.credits.unwrap_or(0.0).max(0.0),\n            ));\n        }\n    }\n\n    messages\n}\n","traces":[{"line":69,"address":[],"length":0,"stats":{"Line":230}},{"line":70,"address":[],"length":0,"stats":{"Line":690}},{"line":71,"address":[],"length":0,"stats":{"Line":230}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":230}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":4}},{"line":92,"address":[],"length":0,"stats":{"Line":8}},{"line":93,"address":[],"length":0,"stats":{"Line":8}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":8}},{"line":98,"address":[],"length":0,"stats":{"Line":12}},{"line":99,"address":[],"length":0,"stats":{"Line":8}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":16}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":8}},{"line":113,"address":[],"length":0,"stats":{"Line":6}},{"line":114,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":232}},{"line":116,"address":[],"length":0,"stats":{"Line":460}},{"line":117,"address":[],"length":0,"stats":{"Line":460}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":460}},{"line":122,"address":[],"length":0,"stats":{"Line":230}},{"line":123,"address":[],"length":0,"stats":{"Line":920}},{"line":124,"address":[],"length":0,"stats":{"Line":690}},{"line":127,"address":[],"length":0,"stats":{"Line":230}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":920}},{"line":132,"address":[],"length":0,"stats":{"Line":460}},{"line":133,"address":[],"length":0,"stats":{"Line":460}},{"line":134,"address":[],"length":0,"stats":{"Line":230}},{"line":135,"address":[],"length":0,"stats":{"Line":230}},{"line":138,"address":[],"length":0,"stats":{"Line":690}},{"line":140,"address":[],"length":0,"stats":{"Line":230}},{"line":141,"address":[],"length":0,"stats":{"Line":460}},{"line":142,"address":[],"length":0,"stats":{"Line":460}},{"line":143,"address":[],"length":0,"stats":{"Line":230}},{"line":144,"address":[],"length":0,"stats":{"Line":230}},{"line":145,"address":[],"length":0,"stats":{"Line":920}},{"line":146,"address":[],"length":0,"stats":{"Line":920}},{"line":147,"address":[],"length":0,"stats":{"Line":920}},{"line":148,"address":[],"length":0,"stats":{"Line":460}},{"line":149,"address":[],"length":0,"stats":{"Line":230}},{"line":151,"address":[],"length":0,"stats":{"Line":690}},{"line":154,"address":[],"length":0,"stats":{"Line":2}},{"line":155,"address":[],"length":0,"stats":{"Line":2}},{"line":161,"address":[],"length":0,"stats":{"Line":6}},{"line":162,"address":[],"length":0,"stats":{"Line":4}},{"line":163,"address":[],"length":0,"stats":{"Line":2}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":2}}],"covered":45,"coverable":85},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","claudecode.rs"],"content":"//! Claude Code session parser\n//!\n//! Parses JSONL files from ~/.claude/projects/\n\nuse super::utils::{\n    extract_i64, extract_string, file_modified_timestamp_ms, parse_timestamp_value,\n};\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse serde_json::Value;\nuse std::collections::HashSet;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Claude Code entry structure (from JSONL files)\n#[derive(Debug, Deserialize)]\npub struct ClaudeEntry {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    pub timestamp: Option\u003cString\u003e,\n    pub message: Option\u003cClaudeMessage\u003e,\n    /// Request ID for deduplication (used with message.id)\n    #[serde(rename = \"requestId\")]\n    pub request_id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ClaudeMessage {\n    pub model: Option\u003cString\u003e,\n    pub usage: Option\u003cClaudeUsage\u003e,\n    /// Message ID for deduplication (used with requestId)\n    pub id: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ClaudeUsage {\n    pub input_tokens: Option\u003ci64\u003e,\n    pub output_tokens: Option\u003ci64\u003e,\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n    pub cache_creation_input_tokens: Option\u003ci64\u003e,\n}\n\n/// Parse a Claude Code JSONL file\npub fn parse_claude_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string();\n\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    if path.extension().and_then(|s| s.to_str()) == Some(\"json\") {\n        let json_messages = parse_claude_headless_json(path, \u0026session_id, fallback_timestamp);\n        if !json_messages.is_empty() {\n            return json_messages;\n        }\n    }\n\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n    let mut processed_hashes: HashSet\u003cString\u003e = HashSet::new();\n    let mut headless_state = ClaudeHeadlessState::default();\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut handled = false;\n        let mut bytes = trimmed.as_bytes().to_vec();\n        if let Ok(entry) = simd_json::from_slice::\u003cClaudeEntry\u003e(\u0026mut bytes) {\n            // Only process assistant messages with usage data\n            if entry.entry_type == \"assistant\" {\n                let message = match entry.message {\n                    Some(m) =\u003e m,\n                    None =\u003e continue,\n                };\n\n                // Build dedup key for global deduplication (messageId:requestId composite)\n                let dedup_key = match (\u0026message.id, \u0026entry.request_id) {\n                    (Some(msg_id), Some(req_id)) =\u003e {\n                        let hash = format!(\"{}:{}\", msg_id, req_id);\n                        if !processed_hashes.insert(hash.clone()) {\n                            continue;\n                        }\n                        Some(hash)\n                    }\n                    _ =\u003e None,\n                };\n\n                let usage = match message.usage {\n                    Some(u) =\u003e u,\n                    None =\u003e continue,\n                };\n\n                let model = match message.model {\n                    Some(m) =\u003e m,\n                    None =\u003e continue,\n                };\n\n                let timestamp = entry\n                    .timestamp\n                    .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n                    .map(|dt| dt.timestamp_millis())\n                    .unwrap_or(fallback_timestamp);\n\n                messages.push(UnifiedMessage::new_with_dedup(\n                    \"claude\",\n                    model,\n                    \"anthropic\",\n                    session_id.clone(),\n                    timestamp,\n                    TokenBreakdown {\n                        input: usage.input_tokens.unwrap_or(0).max(0),\n                        output: usage.output_tokens.unwrap_or(0).max(0),\n                        cache_read: usage.cache_read_input_tokens.unwrap_or(0).max(0),\n                        cache_write: usage.cache_creation_input_tokens.unwrap_or(0).max(0),\n                        reasoning: 0,\n                    },\n                    0.0,\n                    dedup_key,\n                ));\n                handled = true;\n            }\n        }\n\n        if handled {\n            continue;\n        }\n\n        if let Some(message) = process_claude_headless_line(\n            trimmed,\n            \u0026session_id,\n            \u0026mut headless_state,\n            fallback_timestamp,\n        ) {\n            messages.push(message);\n        }\n    }\n\n    if let Some(message) =\n        finalize_headless_state(\u0026mut headless_state, \u0026session_id, fallback_timestamp)\n    {\n        messages.push(message);\n    }\n\n    messages\n}\n\n#[derive(Default)]\nstruct ClaudeHeadlessState {\n    model: Option\u003cString\u003e,\n    input: i64,\n    output: i64,\n    cache_read: i64,\n    cache_write: i64,\n    timestamp_ms: Option\u003ci64\u003e,\n}\n\nfn parse_claude_headless_json(\n    path: \u0026Path,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let data = match std::fs::read(path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data;\n    let value: Value = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(v) =\u003e v,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut messages = Vec::new();\n    if let Some(message) = extract_claude_headless_message(\u0026value, session_id, fallback_timestamp) {\n        messages.push(message);\n    }\n\n    messages\n}\n\nfn process_claude_headless_line(\n    line: \u0026str,\n    session_id: \u0026str,\n    state: \u0026mut ClaudeHeadlessState,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let mut bytes = line.as_bytes().to_vec();\n    let value: Value = simd_json::from_slice(\u0026mut bytes).ok()?;\n\n    let event_type = value.get(\"type\").and_then(|val| val.as_str()).unwrap_or(\"\");\n    let mut completed_message: Option\u003cUnifiedMessage\u003e = None;\n\n    match event_type {\n        \"message_start\" =\u003e {\n            completed_message = finalize_headless_state(state, session_id, fallback_timestamp);\n\n            state.model = extract_claude_model(\u0026value);\n            state.timestamp_ms = extract_claude_timestamp(\u0026value).or(state.timestamp_ms);\n            if let Some(usage) = value\n                .get(\"message\")\n                .and_then(|msg| msg.get(\"usage\"))\n                .or_else(|| value.get(\"usage\"))\n            {\n                update_claude_usage(state, usage);\n            }\n        }\n        \"message_delta\" =\u003e {\n            if let Some(usage) = value\n                .get(\"usage\")\n                .or_else(|| value.get(\"delta\").and_then(|delta| delta.get(\"usage\")))\n            {\n                update_claude_usage(state, usage);\n            }\n        }\n        \"message_stop\" =\u003e {\n            completed_message = finalize_headless_state(state, session_id, fallback_timestamp);\n        }\n        _ =\u003e {\n            if let Some(message) =\n                extract_claude_headless_message(\u0026value, session_id, fallback_timestamp)\n            {\n                completed_message = Some(message);\n            }\n        }\n    }\n\n    completed_message\n}\n\nfn extract_claude_headless_message(\n    value: \u0026Value,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let usage = value\n        .get(\"usage\")\n        .or_else(|| value.get(\"message\").and_then(|msg| msg.get(\"usage\")))?;\n    let model = extract_claude_model(value)?;\n    let timestamp = extract_claude_timestamp(value).unwrap_or(fallback_timestamp);\n\n    Some(UnifiedMessage::new(\n        \"claude\",\n        model,\n        \"anthropic\",\n        session_id.to_string(),\n        timestamp,\n        TokenBreakdown {\n            input: extract_i64(usage.get(\"input_tokens\")).unwrap_or(0).max(0),\n            output: extract_i64(usage.get(\"output_tokens\")).unwrap_or(0).max(0),\n            cache_read: extract_i64(usage.get(\"cache_read_input_tokens\"))\n                .unwrap_or(0)\n                .max(0),\n            cache_write: extract_i64(usage.get(\"cache_creation_input_tokens\"))\n                .unwrap_or(0)\n                .max(0),\n            reasoning: 0,\n        },\n        0.0,\n    ))\n}\n\nfn extract_claude_model(value: \u0026Value) -\u003e Option\u003cString\u003e {\n    extract_string(value.get(\"model\")).or_else(|| {\n        value\n            .get(\"message\")\n            .and_then(|msg| extract_string(msg.get(\"model\")))\n    })\n}\n\nfn extract_claude_timestamp(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    value\n        .get(\"timestamp\")\n        .or_else(|| value.get(\"created_at\"))\n        .or_else(|| value.get(\"message\").and_then(|msg| msg.get(\"created_at\")))\n        .and_then(parse_timestamp_value)\n}\n\nfn update_claude_usage(state: \u0026mut ClaudeHeadlessState, usage: \u0026Value) {\n    if let Some(input) = extract_i64(usage.get(\"input_tokens\")) {\n        state.input = state.input.max(input);\n    }\n    if let Some(output) = extract_i64(usage.get(\"output_tokens\")) {\n        state.output = state.output.max(output);\n    }\n    if let Some(cache_read) = extract_i64(usage.get(\"cache_read_input_tokens\")) {\n        state.cache_read = state.cache_read.max(cache_read);\n    }\n    if let Some(cache_write) = extract_i64(usage.get(\"cache_creation_input_tokens\")) {\n        state.cache_write = state.cache_write.max(cache_write);\n    }\n}\n\nfn finalize_headless_state(\n    state: \u0026mut ClaudeHeadlessState,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let model = state.model.clone()?;\n    let timestamp = state.timestamp_ms.unwrap_or(fallback_timestamp);\n    if state.input == 0 \u0026\u0026 state.output == 0 \u0026\u0026 state.cache_read == 0 \u0026\u0026 state.cache_write == 0 {\n        *state = ClaudeHeadlessState::default();\n        return None;\n    }\n\n    let message = UnifiedMessage::new(\n        \"claude\",\n        model,\n        \"anthropic\",\n        session_id.to_string(),\n        timestamp,\n        TokenBreakdown {\n            input: state.input.max(0),\n            output: state.output.max(0),\n            cache_read: state.cache_read.max(0),\n            cache_write: state.cache_write.max(0),\n            reasoning: 0,\n        },\n        0.0,\n    );\n\n    *state = ClaudeHeadlessState::default();\n    Some(message)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n    use tempfile::NamedTempFile;\n\n    fn create_test_file(content: \u0026str) -\u003e NamedTempFile {\n        let mut file = NamedTempFile::new().unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n        file\n    }\n\n    #[test]\n    fn test_deduplication_skips_duplicate_entries() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:02.000Z\",\"requestId\":\"req_002\",\"message\":{\"id\":\"msg_002\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":200,\"output_tokens\":100}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(\n            messages.len(),\n            2,\n            \"Should deduplicate to 2 messages (first duplicate skipped)\"\n        );\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[1].tokens.input, 200);\n    }\n\n    #[test]\n    fn test_deduplication_allows_same_message_different_request() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"requestId\":\"req_002\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":150,\"output_tokens\":75}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(\n            messages.len(),\n            2,\n            \"Different requestId should not be deduplicated\"\n        );\n    }\n\n    #[test]\n    fn test_entries_without_dedup_fields_still_processed() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"message\":{\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"message\":{\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":200,\"output_tokens\":100}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(\n            messages.len(),\n            2,\n            \"Entries without messageId/requestId should still be processed\"\n        );\n    }\n\n    #[test]\n    fn test_user_messages_ignored() {\n        let content = r#\"{\"type\":\"user\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"message\":{\"content\":\"Hello\"}}\n{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:01.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":100,\"output_tokens\":50}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1, \"User messages should be ignored\");\n        assert_eq!(messages[0].tokens.input, 100);\n    }\n\n    #[test]\n    fn test_token_breakdown_parsing() {\n        let content = r#\"{\"type\":\"assistant\",\"timestamp\":\"2024-12-01T10:00:00.000Z\",\"requestId\":\"req_001\",\"message\":{\"id\":\"msg_001\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":1000,\"output_tokens\":500,\"cache_read_input_tokens\":200,\"cache_creation_input_tokens\":100}}}\"#;\n\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].tokens.input, 1000);\n        assert_eq!(messages[0].tokens.output, 500);\n        assert_eq!(messages[0].tokens.cache_read, 200);\n        assert_eq!(messages[0].tokens.cache_write, 100);\n        assert_eq!(messages[0].tokens.reasoning, 0);\n    }\n\n    #[test]\n    fn test_headless_json_output() {\n        let content = r#\"{\"type\":\"message\",\"message\":{\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":120,\"output_tokens\":60,\"cache_read_input_tokens\":10}}}\"#;\n        let file = tempfile::Builder::new().suffix(\".json\").tempfile().unwrap();\n        std::fs::write(file.path(), content).unwrap();\n\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"claude-3-5-sonnet\");\n        assert_eq!(messages[0].tokens.input, 120);\n        assert_eq!(messages[0].tokens.output, 60);\n        assert_eq!(messages[0].tokens.cache_read, 10);\n    }\n\n    #[test]\n    fn test_headless_stream_output() {\n        let content = r#\"{\"type\":\"message_start\",\"timestamp\":\"2025-01-01T00:00:00Z\",\"message\":{\"id\":\"msg_1\",\"model\":\"claude-3-5-sonnet\",\"usage\":{\"input_tokens\":200,\"cache_read_input_tokens\":20,\"cache_creation_input_tokens\":5}}}\n{\"type\":\"message_delta\",\"usage\":{\"output_tokens\":80}}\n{\"type\":\"message_stop\"}\"#;\n        let file = create_test_file(content);\n        let messages = parse_claude_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"claude-3-5-sonnet\");\n        assert_eq!(messages[0].tokens.input, 200);\n        assert_eq!(messages[0].tokens.output, 80);\n        assert_eq!(messages[0].tokens.cache_read, 20);\n        assert_eq!(messages[0].tokens.cache_write, 5);\n    }\n}\n","traces":[{"line":45,"address":[],"length":0,"stats":{"Line":1691}},{"line":46,"address":[],"length":0,"stats":{"Line":3382}},{"line":48,"address":[],"length":0,"stats":{"Line":5073}},{"line":52,"address":[],"length":0,"stats":{"Line":5073}},{"line":54,"address":[],"length":0,"stats":{"Line":10134}},{"line":55,"address":[],"length":0,"stats":{"Line":5}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":3380}},{"line":62,"address":[],"length":0,"stats":{"Line":3380}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":5070}},{"line":67,"address":[],"length":0,"stats":{"Line":3380}},{"line":68,"address":[],"length":0,"stats":{"Line":5070}},{"line":69,"address":[],"length":0,"stats":{"Line":3380}},{"line":71,"address":[],"length":0,"stats":{"Line":185277}},{"line":72,"address":[],"length":0,"stats":{"Line":363794}},{"line":73,"address":[],"length":0,"stats":{"Line":363794}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":363794}},{"line":78,"address":[],"length":0,"stats":{"Line":363794}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":363794}},{"line":83,"address":[],"length":0,"stats":{"Line":545691}},{"line":84,"address":[],"length":0,"stats":{"Line":363794}},{"line":86,"address":[],"length":0,"stats":{"Line":181897}},{"line":87,"address":[],"length":0,"stats":{"Line":127098}},{"line":88,"address":[],"length":0,"stats":{"Line":127098}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":158480}},{"line":94,"address":[],"length":0,"stats":{"Line":115594}},{"line":95,"address":[],"length":0,"stats":{"Line":115594}},{"line":96,"address":[],"length":0,"stats":{"Line":173391}},{"line":97,"address":[],"length":0,"stats":{"Line":32167}},{"line":99,"address":[],"length":0,"stats":{"Line":25630}},{"line":101,"address":[],"length":0,"stats":{"Line":5752}},{"line":104,"address":[],"length":0,"stats":{"Line":62764}},{"line":105,"address":[],"length":0,"stats":{"Line":62764}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":62764}},{"line":110,"address":[],"length":0,"stats":{"Line":62764}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":62764}},{"line":115,"address":[],"length":0,"stats":{"Line":31382}},{"line":116,"address":[],"length":0,"stats":{"Line":125528}},{"line":117,"address":[],"length":0,"stats":{"Line":94146}},{"line":118,"address":[],"length":0,"stats":{"Line":62764}},{"line":120,"address":[],"length":0,"stats":{"Line":94146}},{"line":122,"address":[],"length":0,"stats":{"Line":31382}},{"line":124,"address":[],"length":0,"stats":{"Line":62764}},{"line":125,"address":[],"length":0,"stats":{"Line":31382}},{"line":126,"address":[],"length":0,"stats":{"Line":31382}},{"line":127,"address":[],"length":0,"stats":{"Line":125528}},{"line":128,"address":[],"length":0,"stats":{"Line":125528}},{"line":129,"address":[],"length":0,"stats":{"Line":125528}},{"line":130,"address":[],"length":0,"stats":{"Line":62764}},{"line":131,"address":[],"length":0,"stats":{"Line":31382}},{"line":134,"address":[],"length":0,"stats":{"Line":31382}},{"line":136,"address":[],"length":0,"stats":{"Line":31382}},{"line":140,"address":[],"length":0,"stats":{"Line":149730}},{"line":141,"address":[],"length":0,"stats":{"Line":31382}},{"line":145,"address":[],"length":0,"stats":{"Line":236696}},{"line":146,"address":[],"length":0,"stats":{"Line":236696}},{"line":147,"address":[],"length":0,"stats":{"Line":118348}},{"line":148,"address":[],"length":0,"stats":{"Line":118348}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":5070}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":1690}},{"line":173,"address":[],"length":0,"stats":{"Line":1}},{"line":178,"address":[],"length":0,"stats":{"Line":2}},{"line":179,"address":[],"length":0,"stats":{"Line":2}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":2}},{"line":184,"address":[],"length":0,"stats":{"Line":3}},{"line":185,"address":[],"length":0,"stats":{"Line":2}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":2}},{"line":190,"address":[],"length":0,"stats":{"Line":5}},{"line":191,"address":[],"length":0,"stats":{"Line":2}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":118348}},{"line":203,"address":[],"length":0,"stats":{"Line":355044}},{"line":204,"address":[],"length":0,"stats":{"Line":591740}},{"line":206,"address":[],"length":0,"stats":{"Line":946784}},{"line":207,"address":[],"length":0,"stats":{"Line":355044}},{"line":209,"address":[],"length":0,"stats":{"Line":118348}},{"line":210,"address":[],"length":0,"stats":{"Line":118348}},{"line":211,"address":[],"length":0,"stats":{"Line":5}},{"line":213,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":3}},{"line":215,"address":[],"length":0,"stats":{"Line":2}},{"line":217,"address":[],"length":0,"stats":{"Line":3}},{"line":218,"address":[],"length":0,"stats":{"Line":1}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":223,"address":[],"length":0,"stats":{"Line":118347}},{"line":224,"address":[],"length":0,"stats":{"Line":2}},{"line":226,"address":[],"length":0,"stats":{"Line":1}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":231,"address":[],"length":0,"stats":{"Line":118347}},{"line":232,"address":[],"length":0,"stats":{"Line":4}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":355035}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":118348}},{"line":246,"address":[],"length":0,"stats":{"Line":118346}},{"line":251,"address":[],"length":0,"stats":{"Line":118347}},{"line":253,"address":[],"length":0,"stats":{"Line":668729}},{"line":254,"address":[],"length":0,"stats":{"Line":3}},{"line":255,"address":[],"length":0,"stats":{"Line":5}},{"line":257,"address":[],"length":0,"stats":{"Line":2}},{"line":258,"address":[],"length":0,"stats":{"Line":1}},{"line":259,"address":[],"length":0,"stats":{"Line":2}},{"line":260,"address":[],"length":0,"stats":{"Line":1}},{"line":261,"address":[],"length":0,"stats":{"Line":3}},{"line":262,"address":[],"length":0,"stats":{"Line":2}},{"line":263,"address":[],"length":0,"stats":{"Line":1}},{"line":264,"address":[],"length":0,"stats":{"Line":6}},{"line":265,"address":[],"length":0,"stats":{"Line":6}},{"line":266,"address":[],"length":0,"stats":{"Line":4}},{"line":267,"address":[],"length":0,"stats":{"Line":2}},{"line":268,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":4}},{"line":270,"address":[],"length":0,"stats":{"Line":1}},{"line":271,"address":[],"length":0,"stats":{"Line":1}},{"line":272,"address":[],"length":0,"stats":{"Line":1}},{"line":274,"address":[],"length":0,"stats":{"Line":1}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":10}},{"line":280,"address":[],"length":0,"stats":{"Line":2}},{"line":281,"address":[],"length":0,"stats":{"Line":2}},{"line":282,"address":[],"length":0,"stats":{"Line":8}},{"line":286,"address":[],"length":0,"stats":{"Line":2}},{"line":287,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":4}},{"line":290,"address":[],"length":0,"stats":{"Line":7}},{"line":291,"address":[],"length":0,"stats":{"Line":2}},{"line":294,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":6}},{"line":296,"address":[],"length":0,"stats":{"Line":2}},{"line":298,"address":[],"length":0,"stats":{"Line":6}},{"line":299,"address":[],"length":0,"stats":{"Line":2}},{"line":301,"address":[],"length":0,"stats":{"Line":6}},{"line":302,"address":[],"length":0,"stats":{"Line":2}},{"line":304,"address":[],"length":0,"stats":{"Line":6}},{"line":305,"address":[],"length":0,"stats":{"Line":2}},{"line":309,"address":[],"length":0,"stats":{"Line":1692}},{"line":314,"address":[],"length":0,"stats":{"Line":5076}},{"line":315,"address":[],"length":0,"stats":{"Line":4}},{"line":316,"address":[],"length":0,"stats":{"Line":1}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":1}},{"line":325,"address":[],"length":0,"stats":{"Line":2}},{"line":326,"address":[],"length":0,"stats":{"Line":1}},{"line":327,"address":[],"length":0,"stats":{"Line":1}},{"line":328,"address":[],"length":0,"stats":{"Line":3}},{"line":329,"address":[],"length":0,"stats":{"Line":3}},{"line":330,"address":[],"length":0,"stats":{"Line":3}},{"line":331,"address":[],"length":0,"stats":{"Line":1}},{"line":332,"address":[],"length":0,"stats":{"Line":1}},{"line":337,"address":[],"length":0,"stats":{"Line":2}},{"line":338,"address":[],"length":0,"stats":{"Line":1}}],"covered":150,"coverable":164},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","codex.rs"],"content":"//! Codex CLI session parser\n//!\n//! Parses JSONL files from ~/.codex/sessions/\n//! Note: This parser has stateful logic to track model and delta calculations.\n\nuse super::utils::{\n    extract_i64, extract_string, file_modified_timestamp_ms, parse_timestamp_value,\n};\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse serde_json::Value;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Codex entry structure (from JSONL files)\n#[derive(Debug, Deserialize)]\npub struct CodexEntry {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    pub timestamp: Option\u003cString\u003e,\n    pub payload: Option\u003cCodexPayload\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct CodexPayload {\n    #[serde(rename = \"type\")]\n    pub payload_type: Option\u003cString\u003e,\n    pub model: Option\u003cString\u003e,\n    pub model_name: Option\u003cString\u003e,\n    pub info: Option\u003cCodexInfo\u003e,\n    pub source: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct CodexInfo {\n    pub model: Option\u003cString\u003e,\n    pub model_name: Option\u003cString\u003e,\n    pub last_token_usage: Option\u003cCodexTokenUsage\u003e,\n    pub total_token_usage: Option\u003cCodexTokenUsage\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct CodexTokenUsage {\n    pub input_tokens: Option\u003ci64\u003e,\n    pub output_tokens: Option\u003ci64\u003e,\n    pub cached_input_tokens: Option\u003ci64\u003e,\n    pub cache_read_input_tokens: Option\u003ci64\u003e,\n}\n\n/// Parse a Codex JSONL file with stateful tracking\npub fn parse_codex_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string();\n\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n\n    // Stateful tracking\n    let mut current_model: Option\u003cString\u003e = None;\n    let mut previous_totals: Option\u003c(i64, i64, i64)\u003e = None; // (input, output, cached)\n    let mut session_is_headless = false;\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut handled = false;\n        let mut bytes = trimmed.as_bytes().to_vec();\n        if let Ok(entry) = simd_json::from_slice::\u003cCodexEntry\u003e(\u0026mut bytes) {\n            if let Some(payload) = entry.payload {\n                // Check session_meta for headless exec sessions\n                if entry.entry_type == \"session_meta\" \u0026\u0026 payload.source.as_deref() == Some(\"exec\") {\n                    session_is_headless = true;\n                }\n                // Extract model from turn_context\n                if entry.entry_type == \"turn_context\" {\n                    current_model = extract_model(\u0026payload);\n                    handled = true;\n                }\n\n                // Process token_count events\n                if entry.entry_type == \"event_msg\"\n                    \u0026\u0026 payload.payload_type.as_deref() == Some(\"token_count\")\n                {\n                    // Try to extract model from payload\n                    if let Some(model) = extract_model(\u0026payload) {\n                        current_model = Some(model);\n                    }\n\n                    let info = match payload.info {\n                        Some(i) =\u003e i,\n                        None =\u003e continue,\n                    };\n\n                    // Try to extract model from info\n                    if let Some(model) = info.model.clone().or(info.model_name.clone()) {\n                        current_model = Some(model);\n                    }\n\n                    let model = current_model\n                        .clone()\n                        .unwrap_or_else(|| \"unknown\".to_string());\n\n                    // Calculate delta tokens\n                    // Note: OpenAI's input_tokens INCLUDES cached tokens (they are a subset).\n                    // We subtract cached from input to avoid double-counting when aggregating.\n                    let (input, output, cached) = if let Some(last) = \u0026info.last_token_usage {\n                        let total_input = last.input_tokens.unwrap_or(0);\n                        let cached = last\n                            .cached_input_tokens\n                            .or(last.cache_read_input_tokens)\n                            .unwrap_or(0);\n                        (\n                            total_input.saturating_sub(cached),\n                            last.output_tokens.unwrap_or(0),\n                            cached,\n                        )\n                    } else if let (Some(total), Some(prev)) =\n                        (\u0026info.total_token_usage, \u0026previous_totals)\n                    {\n                        let curr_input = total.input_tokens.unwrap_or(0);\n                        let curr_output = total.output_tokens.unwrap_or(0);\n                        let curr_cached = total\n                            .cached_input_tokens\n                            .or(total.cache_read_input_tokens)\n                            .unwrap_or(0);\n\n                        let delta_input = (curr_input - prev.0).max(0);\n                        let delta_cached = (curr_cached - prev.2).max(0);\n                        (\n                            (delta_input - delta_cached).max(0),\n                            (curr_output - prev.1).max(0),\n                            delta_cached,\n                        )\n                    } else {\n                        continue;\n                    };\n\n                    // Update previous totals\n                    if let Some(total) = \u0026info.total_token_usage {\n                        previous_totals = Some((\n                            total.input_tokens.unwrap_or(0),\n                            total.output_tokens.unwrap_or(0),\n                            total\n                                .cached_input_tokens\n                                .or(total.cache_read_input_tokens)\n                                .unwrap_or(0),\n                        ));\n                    }\n\n                    // Skip empty deltas\n                    if input == 0 \u0026\u0026 output == 0 \u0026\u0026 cached == 0 {\n                        continue;\n                    }\n\n                    let timestamp = entry\n                        .timestamp\n                        .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n                        .map(|dt| dt.timestamp_millis())\n                        .unwrap_or(fallback_timestamp);\n\n                    let agent = if session_is_headless {\n                        Some(\"headless\".to_string())\n                    } else {\n                        None\n                    };\n\n                    messages.push(UnifiedMessage::new_with_agent(\n                        \"codex\",\n                        model,\n                        \"openai\",\n                        session_id.clone(),\n                        timestamp,\n                        TokenBreakdown {\n                            input: input.max(0),\n                            output: output.max(0),\n                            cache_read: cached.max(0),\n                            cache_write: 0,\n                            reasoning: 0,\n                        },\n                        0.0,\n                        agent,\n                    ));\n                    handled = true;\n                }\n            }\n\n            // Mark session_meta as handled (even if payload was processed above)\n            if entry.entry_type == \"session_meta\" {\n                handled = true;\n            }\n        }\n\n        if handled {\n            continue;\n        }\n\n        if let Some(msg) =\n            parse_codex_headless_line(trimmed, \u0026session_id, \u0026mut current_model, fallback_timestamp)\n        {\n            let mut msg = msg;\n            if session_is_headless \u0026\u0026 msg.agent.is_none() {\n                msg.agent = Some(\"headless\".to_string());\n            }\n            messages.push(msg);\n        }\n    }\n\n    messages\n}\n\nfn extract_model(payload: \u0026CodexPayload) -\u003e Option\u003cString\u003e {\n    payload\n        .model\n        .clone()\n        .or(payload.model_name.clone())\n        .or(payload.info.as_ref().and_then(|i| i.model.clone()))\n        .or(payload.info.as_ref().and_then(|i| i.model_name.clone()))\n        .filter(|m| !m.is_empty())\n}\n\nstruct CodexHeadlessUsage {\n    input: i64,\n    output: i64,\n    cached: i64,\n    model: Option\u003cString\u003e,\n    timestamp_ms: Option\u003ci64\u003e,\n}\n\nfn parse_codex_headless_line(\n    line: \u0026str,\n    session_id: \u0026str,\n    current_model: \u0026mut Option\u003cString\u003e,\n    fallback_timestamp: i64,\n) -\u003e Option\u003cUnifiedMessage\u003e {\n    let mut bytes = line.as_bytes().to_vec();\n    let value: Value = simd_json::from_slice(\u0026mut bytes).ok()?;\n\n    if let Some(model) = extract_model_from_value(\u0026value) {\n        *current_model = Some(model);\n    }\n\n    let usage = extract_headless_usage(\u0026value)?;\n    let model = usage\n        .model\n        .or_else(|| current_model.clone())\n        .unwrap_or_else(|| \"unknown\".to_string());\n    let timestamp = usage.timestamp_ms.unwrap_or(fallback_timestamp);\n\n    if usage.input == 0 \u0026\u0026 usage.output == 0 \u0026\u0026 usage.cached == 0 {\n        return None;\n    }\n\n    Some(UnifiedMessage::new(\n        \"codex\",\n        model,\n        \"openai\",\n        session_id.to_string(),\n        timestamp,\n        TokenBreakdown {\n            input: usage.input.max(0),\n            output: usage.output.max(0),\n            cache_read: usage.cached.max(0),\n            cache_write: 0,\n            reasoning: 0,\n        },\n        0.0,\n    ))\n}\n\nfn extract_headless_usage(value: \u0026Value) -\u003e Option\u003cCodexHeadlessUsage\u003e {\n    let usage = value\n        .get(\"usage\")\n        .or_else(|| value.get(\"data\").and_then(|data| data.get(\"usage\")))\n        .or_else(|| value.get(\"result\").and_then(|data| data.get(\"usage\")))\n        .or_else(|| value.get(\"response\").and_then(|data| data.get(\"usage\")))?;\n\n    let input_tokens = extract_i64(usage.get(\"input_tokens\"))\n        .or_else(|| extract_i64(usage.get(\"prompt_tokens\")))\n        .or_else(|| extract_i64(usage.get(\"input\")))\n        .unwrap_or(0);\n    let output_tokens = extract_i64(usage.get(\"output_tokens\"))\n        .or_else(|| extract_i64(usage.get(\"completion_tokens\")))\n        .or_else(|| extract_i64(usage.get(\"output\")))\n        .unwrap_or(0);\n    let cached_tokens = extract_i64(usage.get(\"cached_input_tokens\"))\n        .or_else(|| extract_i64(usage.get(\"cache_read_input_tokens\")))\n        .or_else(|| extract_i64(usage.get(\"cached_tokens\")))\n        .unwrap_or(0);\n\n    let model = extract_model_from_value(value)\n        .or_else(|| value.get(\"data\").and_then(extract_model_from_value));\n    let timestamp_ms = extract_timestamp_from_value(value);\n\n    Some(CodexHeadlessUsage {\n        input: input_tokens.saturating_sub(cached_tokens),\n        output: output_tokens,\n        cached: cached_tokens,\n        model,\n        timestamp_ms,\n    })\n}\n\nfn extract_model_from_value(value: \u0026Value) -\u003e Option\u003cString\u003e {\n    extract_string(value.get(\"model\"))\n        .or_else(|| extract_string(value.get(\"model_name\")))\n        .or_else(|| {\n            value\n                .get(\"data\")\n                .and_then(|data| extract_string(data.get(\"model\")))\n        })\n        .or_else(|| {\n            value\n                .get(\"data\")\n                .and_then(|data| extract_string(data.get(\"model_name\")))\n        })\n        .or_else(|| {\n            value\n                .get(\"response\")\n                .and_then(|data| extract_string(data.get(\"model\")))\n        })\n}\n\nfn extract_timestamp_from_value(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    value\n        .get(\"timestamp\")\n        .or_else(|| value.get(\"time\"))\n        .or_else(|| value.get(\"created_at\"))\n        .or_else(|| value.get(\"data\").and_then(|data| data.get(\"timestamp\")))\n        .and_then(parse_timestamp_value)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n    use tempfile::NamedTempFile;\n\n    fn create_test_file(content: \u0026str) -\u003e NamedTempFile {\n        let mut file = NamedTempFile::new().unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n        file\n    }\n\n    #[test]\n    fn test_headless_usage_line() {\n        let content = r#\"{\"type\":\"turn.completed\",\"model\":\"gpt-4o-mini\",\"usage\":{\"input_tokens\":120,\"cached_input_tokens\":20,\"output_tokens\":30}}\"#;\n        let file = create_test_file(content);\n\n        let messages = parse_codex_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-4o-mini\");\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[0].tokens.output, 30);\n        assert_eq!(messages[0].tokens.cache_read, 20);\n    }\n\n    #[test]\n    fn test_headless_usage_nested_data() {\n        let content = r#\"{\"type\":\"result\",\"data\":{\"model_name\":\"gpt-4o\",\"usage\":{\"input_tokens\":50,\"cached_input_tokens\":5,\"output_tokens\":12}}}\"#;\n        let file = create_test_file(content);\n\n        let messages = parse_codex_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-4o\");\n        assert_eq!(messages[0].tokens.input, 45);\n        assert_eq!(messages[0].tokens.output, 12);\n        assert_eq!(messages[0].tokens.cache_read, 5);\n    }\n\n    #[test]\n    fn test_session_meta_exec_marks_headless() {\n        let line1 = r#\"{\"timestamp\":\"2026-01-01T00:00:00Z\",\"type\":\"session_meta\",\"payload\":{\"originator\":\"codex_exec\",\"source\":\"exec\"}}\"#;\n        let line2 = r#\"{\"timestamp\":\"2026-01-01T00:00:01Z\",\"type\":\"event_msg\",\"payload\":{\"type\":\"token_count\",\"info\":{\"last_token_usage\":{\"input_tokens\":10,\"cached_input_tokens\":2,\"output_tokens\":3}}}}\"#;\n        let content = format!(\"{}\\n{}\", line1, line2);\n        let file = create_test_file(\u0026content);\n\n        let messages = parse_codex_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].agent.as_deref(), Some(\"headless\"));\n    }\n}\n","traces":[{"line":52,"address":[],"length":0,"stats":{"Line":37}},{"line":53,"address":[],"length":0,"stats":{"Line":74}},{"line":54,"address":[],"length":0,"stats":{"Line":74}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":74}},{"line":60,"address":[],"length":0,"stats":{"Line":111}},{"line":64,"address":[],"length":0,"stats":{"Line":111}},{"line":66,"address":[],"length":0,"stats":{"Line":111}},{"line":67,"address":[],"length":0,"stats":{"Line":74}},{"line":70,"address":[],"length":0,"stats":{"Line":111}},{"line":71,"address":[],"length":0,"stats":{"Line":111}},{"line":72,"address":[],"length":0,"stats":{"Line":74}},{"line":74,"address":[],"length":0,"stats":{"Line":356}},{"line":75,"address":[],"length":0,"stats":{"Line":564}},{"line":76,"address":[],"length":0,"stats":{"Line":564}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":564}},{"line":81,"address":[],"length":0,"stats":{"Line":564}},{"line":82,"address":[],"length":0,"stats":{"Line":52}},{"line":85,"address":[],"length":0,"stats":{"Line":460}},{"line":86,"address":[],"length":0,"stats":{"Line":690}},{"line":87,"address":[],"length":0,"stats":{"Line":338}},{"line":88,"address":[],"length":0,"stats":{"Line":214}},{"line":90,"address":[],"length":0,"stats":{"Line":112}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":116}},{"line":95,"address":[],"length":0,"stats":{"Line":30}},{"line":96,"address":[],"length":0,"stats":{"Line":10}},{"line":100,"address":[],"length":0,"stats":{"Line":106}},{"line":101,"address":[],"length":0,"stats":{"Line":49}},{"line":104,"address":[],"length":0,"stats":{"Line":21}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":38}},{"line":109,"address":[],"length":0,"stats":{"Line":34}},{"line":110,"address":[],"length":0,"stats":{"Line":4}},{"line":114,"address":[],"length":0,"stats":{"Line":68}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":34}},{"line":120,"address":[],"length":0,"stats":{"Line":19}},{"line":125,"address":[],"length":0,"stats":{"Line":85}},{"line":126,"address":[],"length":0,"stats":{"Line":51}},{"line":127,"address":[],"length":0,"stats":{"Line":34}},{"line":128,"address":[],"length":0,"stats":{"Line":17}},{"line":129,"address":[],"length":0,"stats":{"Line":34}},{"line":132,"address":[],"length":0,"stats":{"Line":68}},{"line":133,"address":[],"length":0,"stats":{"Line":34}},{"line":134,"address":[],"length":0,"stats":{"Line":17}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":49}},{"line":159,"address":[],"length":0,"stats":{"Line":16}},{"line":160,"address":[],"length":0,"stats":{"Line":48}},{"line":161,"address":[],"length":0,"stats":{"Line":48}},{"line":162,"address":[],"length":0,"stats":{"Line":32}},{"line":163,"address":[],"length":0,"stats":{"Line":32}},{"line":164,"address":[],"length":0,"stats":{"Line":32}},{"line":165,"address":[],"length":0,"stats":{"Line":16}},{"line":170,"address":[],"length":0,"stats":{"Line":17}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":34}},{"line":175,"address":[],"length":0,"stats":{"Line":17}},{"line":176,"address":[],"length":0,"stats":{"Line":68}},{"line":177,"address":[],"length":0,"stats":{"Line":51}},{"line":178,"address":[],"length":0,"stats":{"Line":34}},{"line":180,"address":[],"length":0,"stats":{"Line":34}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":16}},{"line":186,"address":[],"length":0,"stats":{"Line":51}},{"line":188,"address":[],"length":0,"stats":{"Line":17}},{"line":190,"address":[],"length":0,"stats":{"Line":34}},{"line":191,"address":[],"length":0,"stats":{"Line":17}},{"line":192,"address":[],"length":0,"stats":{"Line":17}},{"line":193,"address":[],"length":0,"stats":{"Line":51}},{"line":194,"address":[],"length":0,"stats":{"Line":51}},{"line":195,"address":[],"length":0,"stats":{"Line":17}},{"line":196,"address":[],"length":0,"stats":{"Line":17}},{"line":197,"address":[],"length":0,"stats":{"Line":17}},{"line":200,"address":[],"length":0,"stats":{"Line":17}},{"line":202,"address":[],"length":0,"stats":{"Line":17}},{"line":207,"address":[],"length":0,"stats":{"Line":109}},{"line":208,"address":[],"length":0,"stats":{"Line":5}},{"line":212,"address":[],"length":0,"stats":{"Line":226}},{"line":213,"address":[],"length":0,"stats":{"Line":32}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":217,"address":[],"length":0,"stats":{"Line":776}},{"line":219,"address":[],"length":0,"stats":{"Line":4}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":6}},{"line":227,"address":[],"length":0,"stats":{"Line":37}},{"line":230,"address":[],"length":0,"stats":{"Line":31}},{"line":231,"address":[],"length":0,"stats":{"Line":31}},{"line":232,"address":[],"length":0,"stats":{"Line":31}},{"line":234,"address":[],"length":0,"stats":{"Line":93}},{"line":235,"address":[],"length":0,"stats":{"Line":158}},{"line":236,"address":[],"length":0,"stats":{"Line":158}},{"line":237,"address":[],"length":0,"stats":{"Line":51}},{"line":248,"address":[],"length":0,"stats":{"Line":194}},{"line":254,"address":[],"length":0,"stats":{"Line":582}},{"line":255,"address":[],"length":0,"stats":{"Line":848}},{"line":257,"address":[],"length":0,"stats":{"Line":76}},{"line":258,"address":[],"length":0,"stats":{"Line":2}},{"line":261,"address":[],"length":0,"stats":{"Line":216}},{"line":262,"address":[],"length":0,"stats":{"Line":4}},{"line":263,"address":[],"length":0,"stats":{"Line":2}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":265,"address":[],"length":0,"stats":{"Line":2}},{"line":266,"address":[],"length":0,"stats":{"Line":8}},{"line":268,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":4}},{"line":273,"address":[],"length":0,"stats":{"Line":2}},{"line":274,"address":[],"length":0,"stats":{"Line":4}},{"line":275,"address":[],"length":0,"stats":{"Line":2}},{"line":276,"address":[],"length":0,"stats":{"Line":6}},{"line":277,"address":[],"length":0,"stats":{"Line":4}},{"line":278,"address":[],"length":0,"stats":{"Line":2}},{"line":279,"address":[],"length":0,"stats":{"Line":6}},{"line":280,"address":[],"length":0,"stats":{"Line":6}},{"line":281,"address":[],"length":0,"stats":{"Line":2}},{"line":282,"address":[],"length":0,"stats":{"Line":2}},{"line":283,"address":[],"length":0,"stats":{"Line":2}},{"line":285,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":72}},{"line":290,"address":[],"length":0,"stats":{"Line":74}},{"line":292,"address":[],"length":0,"stats":{"Line":287}},{"line":293,"address":[],"length":0,"stats":{"Line":282}},{"line":294,"address":[],"length":0,"stats":{"Line":352}},{"line":296,"address":[],"length":0,"stats":{"Line":8}},{"line":297,"address":[],"length":0,"stats":{"Line":2}},{"line":298,"address":[],"length":0,"stats":{"Line":2}},{"line":300,"address":[],"length":0,"stats":{"Line":8}},{"line":301,"address":[],"length":0,"stats":{"Line":2}},{"line":302,"address":[],"length":0,"stats":{"Line":2}},{"line":304,"address":[],"length":0,"stats":{"Line":8}},{"line":305,"address":[],"length":0,"stats":{"Line":2}},{"line":306,"address":[],"length":0,"stats":{"Line":2}},{"line":309,"address":[],"length":0,"stats":{"Line":6}},{"line":310,"address":[],"length":0,"stats":{"Line":2}},{"line":311,"address":[],"length":0,"stats":{"Line":6}},{"line":313,"address":[],"length":0,"stats":{"Line":2}},{"line":314,"address":[],"length":0,"stats":{"Line":8}},{"line":315,"address":[],"length":0,"stats":{"Line":4}},{"line":316,"address":[],"length":0,"stats":{"Line":4}},{"line":317,"address":[],"length":0,"stats":{"Line":2}},{"line":318,"address":[],"length":0,"stats":{"Line":2}},{"line":322,"address":[],"length":0,"stats":{"Line":74}},{"line":323,"address":[],"length":0,"stats":{"Line":222}},{"line":324,"address":[],"length":0,"stats":{"Line":290}},{"line":325,"address":[],"length":0,"stats":{"Line":146}},{"line":326,"address":[],"length":0,"stats":{"Line":72}},{"line":327,"address":[],"length":0,"stats":{"Line":72}},{"line":328,"address":[],"length":0,"stats":{"Line":78}},{"line":330,"address":[],"length":0,"stats":{"Line":146}},{"line":331,"address":[],"length":0,"stats":{"Line":72}},{"line":332,"address":[],"length":0,"stats":{"Line":72}},{"line":333,"address":[],"length":0,"stats":{"Line":78}},{"line":335,"address":[],"length":0,"stats":{"Line":144}},{"line":336,"address":[],"length":0,"stats":{"Line":70}},{"line":337,"address":[],"length":0,"stats":{"Line":70}},{"line":338,"address":[],"length":0,"stats":{"Line":70}},{"line":342,"address":[],"length":0,"stats":{"Line":2}},{"line":343,"address":[],"length":0,"stats":{"Line":2}},{"line":345,"address":[],"length":0,"stats":{"Line":6}},{"line":346,"address":[],"length":0,"stats":{"Line":6}},{"line":347,"address":[],"length":0,"stats":{"Line":10}},{"line":348,"address":[],"length":0,"stats":{"Line":2}}],"covered":158,"coverable":178},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","cursor.rs"],"content":"//! Cursor IDE session parser\n//!\n//! Parses CSV files from the Cursor usage export API.\n//! CSV files are cached locally at ~/.config/tokscale/cursor-cache/*.csv\n//! (legacy single-account cache uses usage.csv; additional accounts may use usage.\u003caccount\u003e.csv)\n//!\n//! CSV Format (actual from API):\n//! Date,Kind,Model,Max Mode,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse std::path::Path;\n\nfn account_id_from_cursor_cache_path(path: \u0026Path) -\u003e String {\n    let file_name = path\n        .file_name()\n        .and_then(|n| n.to_str())\n        .unwrap_or(\"usage.csv\");\n\n    if file_name == \"usage.csv\" {\n        return \"active\".to_string();\n    }\n\n    if let Some(stem) = file_name\n        .strip_prefix(\"usage.\")\n        .and_then(|s| s.strip_suffix(\".csv\"))\n    {\n        // Keep it simple/ASCII. The CLI already sanitizes file names.\n        let cleaned = stem\n            .chars()\n            .map(|c| {\n                if c.is_ascii_alphanumeric() || c == '-' || c == '_' || c == '.' {\n                    c\n                } else {\n                    '-'\n                }\n            })\n            .collect::\u003cString\u003e();\n        if cleaned.is_empty() {\n            return \"unknown\".to_string();\n        }\n        return cleaned;\n    }\n\n    \"unknown\".to_string()\n}\n\n/// Provider inference from model name\nfn infer_provider(model: \u0026str) -\u003e \u0026'static str {\n    let lower = model.to_lowercase();\n\n    if lower.contains(\"claude\")\n        || lower.contains(\"sonnet\")\n        || lower.contains(\"opus\")\n        || lower.contains(\"haiku\")\n    {\n        \"anthropic\"\n    } else if lower.contains(\"gpt\") || lower.contains(\"o1\") || lower.contains(\"o3\") {\n        \"openai\"\n    } else if lower.contains(\"gemini\") {\n        \"google\"\n    } else if lower.contains(\"deepseek\") {\n        \"deepseek\"\n    } else if lower.contains(\"llama\") || lower.contains(\"mixtral\") {\n        \"meta\"\n    } else {\n        \"cursor\"\n    }\n}\n\n/// Parse a cost string like \"$0.50\" or \"0.50\" to f64\n/// Returns 0.0 for empty strings, NaN values, or invalid formats\nfn parse_cost(cost_str: \u0026str) -\u003e f64 {\n    let cleaned = cost_str.replace(['$', ','], \"\");\n    let trimmed = cleaned.trim();\n\n    // Handle empty or NaN values\n    if trimmed.is_empty() || trimmed.eq_ignore_ascii_case(\"nan\") {\n        return 0.0;\n    }\n\n    trimmed.parse().unwrap_or(0.0)\n}\n\n/// Parse a Cursor usage CSV file\n///\n/// Handles both formats:\n/// - New: Date,Kind,Model,Max Mode,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost\n/// - Old: Date,Model,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost,Cost to you\npub fn parse_cursor_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let content = match std::fs::read_to_string(path) {\n        Ok(c) =\u003e c,\n        Err(_) =\u003e return vec![],\n    };\n\n    let mut messages = Vec::new();\n    let mut lines = content.lines();\n\n    // Parse header line to determine column indices\n    let header = match lines.next() {\n        Some(h) =\u003e h,\n        None =\u003e return vec![],\n    };\n\n    // Verify this is a valid Cursor CSV\n    if !header.contains(\"Date\") || !header.contains(\"Model\") {\n        return vec![];\n    }\n\n    // Detect format by checking for \"Kind\" column\n    let header_fields: Vec\u003c\u0026str\u003e = parse_csv_line(header);\n    let has_kind_column = header_fields.iter().any(|f| f.trim() == \"Kind\");\n\n    // Column indices based on format\n    let (\n        model_idx,\n        input_cache_write_idx,\n        input_no_cache_idx,\n        cache_read_idx,\n        output_idx,\n        cost_idx,\n    ) = if has_kind_column {\n        // New format: Date,Kind,Model,Max Mode,Input (w/ Cache Write),...\n        (2, 4, 5, 6, 7, 9)\n    } else {\n        // Old format: Date,Model,Input (w/ Cache Write),...\n        (1, 2, 3, 4, 5, 7)\n    };\n\n    let account_id = account_id_from_cursor_cache_path(path);\n\n    for line in lines {\n        if line.trim().is_empty() {\n            continue;\n        }\n\n        // Parse CSV line (simple parsing, handles quoted fields)\n        let fields: Vec\u003c\u0026str\u003e = parse_csv_line(line);\n\n        // Need at least enough columns for the format\n        let min_fields = cost_idx + 1;\n        if fields.len() \u003c min_fields {\n            continue;\n        }\n\n        let date_str = fields[0].trim().trim_matches('\"');\n        let model = fields[model_idx].trim().trim_matches('\"');\n        let input_with_cache_write: i64 = fields[input_cache_write_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let input_without_cache_write: i64 = fields[input_no_cache_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let cache_read: i64 = fields[cache_read_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let output_tokens: i64 = fields[output_idx]\n            .trim()\n            .trim_matches('\"')\n            .parse()\n            .unwrap_or(0);\n        let cost_str = fields[cost_idx].trim().trim_matches('\"');\n        let cost = parse_cost(cost_str);\n\n        // Skip empty or errored entries\n        if model.is_empty() {\n            continue;\n        }\n\n        // Parse timestamp from date string\n        let timestamp = parse_date_to_timestamp(date_str);\n        if timestamp == 0 {\n            continue;\n        }\n\n        // Cache write = input_with_cache_write - input_without_cache_write\n        let cache_write = (input_with_cache_write - input_without_cache_write).max(0);\n        // Input tokens = input_without_cache_write\n        let input = input_without_cache_write;\n\n        messages.push(UnifiedMessage::new(\n            \"cursor\",\n            model,\n            infer_provider(model),\n            format!(\"cursor-{}-{}\", account_id, date_str),\n            timestamp,\n            TokenBreakdown {\n                input: input.max(0),\n                output: output_tokens.max(0),\n                cache_read: cache_read.max(0),\n                cache_write, // Already clamped above with .max(0)\n                reasoning: 0,\n            },\n            cost.max(0.0),\n        ));\n    }\n\n    messages\n}\n\n/// Simple CSV line parser that handles quoted fields\nfn parse_csv_line(line: \u0026str) -\u003e Vec\u003c\u0026str\u003e {\n    let mut fields = Vec::new();\n    let mut start = 0;\n    let mut in_quotes = false;\n    let bytes = line.as_bytes();\n\n    for (i, \u0026byte) in bytes.iter().enumerate() {\n        match byte {\n            b'\"' =\u003e in_quotes = !in_quotes,\n            b',' if !in_quotes =\u003e {\n                fields.push(\u0026line[start..i]);\n                start = i + 1;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    // Add the last field\n    if start \u003c= line.len() {\n        fields.push(\u0026line[start..]);\n    }\n\n    fields\n}\n\n/// Parse a date string to Unix milliseconds timestamp\nfn parse_date_to_timestamp(date_str: \u0026str) -\u003e i64 {\n    use chrono::{NaiveDate, NaiveDateTime, TimeZone, Utc};\n\n    // Try ISO 8601 format with milliseconds: \"2025-02-05T12:00:00.123Z\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%S%.3fZ\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try ISO 8601 format with time: \"2025-02-05T12:00:00Z\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%SZ\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try ISO 8601 format with milliseconds without Z: \"2025-02-05T12:00:00.123\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%S%.3f\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try ISO 8601 format with time without Z: \"2025-02-05T12:00:00\"\n    if let Ok(dt) = NaiveDateTime::parse_from_str(date_str, \"%Y-%m-%dT%H:%M:%S\") {\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    // Try date only format: \"2025-02-05\"\n    if let Ok(date) = NaiveDate::parse_from_str(date_str, \"%Y-%m-%d\") {\n        let dt = date.and_hms_opt(12, 0, 0).unwrap(); // Noon UTC\n        return Utc.from_utc_datetime(\u0026dt).timestamp_millis();\n    }\n\n    0\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_infer_provider() {\n        assert_eq!(infer_provider(\"claude-3-sonnet\"), \"anthropic\");\n        assert_eq!(infer_provider(\"gpt-4o\"), \"openai\");\n        assert_eq!(infer_provider(\"gemini-pro\"), \"google\");\n        assert_eq!(infer_provider(\"deepseek-coder\"), \"deepseek\");\n        assert_eq!(infer_provider(\"llama-3\"), \"meta\");\n        assert_eq!(infer_provider(\"unknown-model\"), \"cursor\");\n    }\n\n    #[test]\n    fn test_parse_cost() {\n        assert_eq!(parse_cost(\"$0.50\"), 0.50);\n        assert_eq!(parse_cost(\"0.50\"), 0.50);\n        assert_eq!(parse_cost(\"$1,234.56\"), 1234.56);\n        assert_eq!(parse_cost(\"\"), 0.0);\n        assert_eq!(parse_cost(\"NaN\"), 0.0);\n        assert_eq!(parse_cost(\"nan\"), 0.0);\n        assert_eq!(parse_cost(\"  \"), 0.0);\n    }\n\n    #[test]\n    fn test_parse_csv_line() {\n        let line = \"2025-02-01,gpt-4o,10,5,0,15,30,$0.10,$0.10\";\n        let fields = parse_csv_line(line);\n        assert_eq!(fields.len(), 9);\n        assert_eq!(fields[0], \"2025-02-01\");\n        assert_eq!(fields[1], \"gpt-4o\");\n        assert_eq!(fields[8], \"$0.10\");\n    }\n\n    #[test]\n    fn test_parse_date_to_timestamp() {\n        // ISO with milliseconds and Z (new Cursor format)\n        let ts = parse_date_to_timestamp(\"2025-11-13T18:36:05.846Z\");\n        assert!(ts \u003e 0);\n\n        // ISO with Z\n        let ts = parse_date_to_timestamp(\"2025-02-05T12:00:00Z\");\n        assert!(ts \u003e 0);\n\n        // Date only\n        let ts = parse_date_to_timestamp(\"2025-02-05\");\n        assert!(ts \u003e 0);\n\n        // Invalid\n        let ts = parse_date_to_timestamp(\"invalid\");\n        assert_eq!(ts, 0);\n    }\n\n    #[test]\n    fn test_parse_cursor_csv_sample_old_format() {\n        let csv = \"Date,Model,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost,Cost to you\n2025-02-01,gpt-4o,10,5,0,15,30,$0.10,$0.10\n2025-02-02,gpt-4o-mini,0,0,0,5,5,$0.05,$0.05\";\n\n        let temp_dir = tempfile::TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"usage.csv\");\n        std::fs::write(\u0026file_path, csv).unwrap();\n\n        let messages = parse_cursor_file(\u0026file_path);\n        assert_eq!(messages.len(), 2);\n\n        assert_eq!(messages[0].source, \"cursor\");\n        assert_eq!(messages[0].model_id, \"gpt-4o\");\n        assert_eq!(messages[0].provider_id, \"openai\");\n        assert_eq!(messages[0].tokens.input, 5);\n        assert_eq!(messages[0].tokens.output, 15);\n        assert_eq!(messages[0].tokens.cache_write, 5); // 10 - 5\n        assert!((messages[0].cost - 0.10).abs() \u003c 0.001);\n\n        assert_eq!(messages[1].model_id, \"gpt-4o-mini\");\n    }\n\n    #[test]\n    fn test_parse_cursor_csv_sample_new_format() {\n        // Real format from Cursor API\n        let csv = r#\"Date,Kind,Model,Max Mode,Input (w/ Cache Write),Input (w/o Cache Write),Cache Read,Output Tokens,Total Tokens,Cost\n\"2025-11-13T18:36:05.846Z\",\"Included\",\"auto\",\"No\",\"28342\",\"775\",\"105891\",\"21282\",\"156290\",\"0.19\"\n\"2025-11-13T13:35:04.658Z\",\"On-Demand\",\"gpt-5-codex\",\"No\",\"0\",\"8263\",\"66964\",\"1612\",\"76839\",\"0.03\"\"#;\n\n        let temp_dir = tempfile::TempDir::new().unwrap();\n        let file_path = temp_dir.path().join(\"usage.csv\");\n        std::fs::write(\u0026file_path, csv).unwrap();\n\n        let messages = parse_cursor_file(\u0026file_path);\n        assert_eq!(messages.len(), 2);\n\n        // First message: auto model\n        assert_eq!(messages[0].source, \"cursor\");\n        assert_eq!(messages[0].model_id, \"auto\");\n        assert_eq!(messages[0].provider_id, \"cursor\"); // unknown model -\u003e cursor\n        assert_eq!(messages[0].tokens.input, 775);\n        assert_eq!(messages[0].tokens.output, 21282);\n        assert_eq!(messages[0].tokens.cache_read, 105891);\n        assert_eq!(messages[0].tokens.cache_write, 28342 - 775); // 27567\n        assert!((messages[0].cost - 0.19).abs() \u003c 0.001);\n\n        // Second message: gpt-5-codex\n        assert_eq!(messages[1].model_id, \"gpt-5-codex\");\n        assert_eq!(messages[1].provider_id, \"openai\"); // gpt -\u003e openai\n        assert_eq!(messages[1].tokens.input, 8263);\n        assert_eq!(messages[1].tokens.cache_read, 66964);\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":8}},{"line":17,"address":[],"length":0,"stats":{"Line":12}},{"line":20,"address":[],"length":0,"stats":{"Line":4}},{"line":21,"address":[],"length":0,"stats":{"Line":8}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":10076}},{"line":50,"address":[],"length":0,"stats":{"Line":30228}},{"line":52,"address":[],"length":0,"stats":{"Line":10076}},{"line":53,"address":[],"length":0,"stats":{"Line":4763}},{"line":54,"address":[],"length":0,"stats":{"Line":4763}},{"line":55,"address":[],"length":0,"stats":{"Line":4763}},{"line":57,"address":[],"length":0,"stats":{"Line":5313}},{"line":58,"address":[],"length":0,"stats":{"Line":11165}},{"line":59,"address":[],"length":0,"stats":{"Line":1840}},{"line":60,"address":[],"length":0,"stats":{"Line":2923}},{"line":61,"address":[],"length":0,"stats":{"Line":105}},{"line":62,"address":[],"length":0,"stats":{"Line":2818}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":5633}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":67,"address":[],"length":0,"stats":{"Line":2816}},{"line":73,"address":[],"length":0,"stats":{"Line":10077}},{"line":74,"address":[],"length":0,"stats":{"Line":50385}},{"line":75,"address":[],"length":0,"stats":{"Line":20154}},{"line":78,"address":[],"length":0,"stats":{"Line":50379}},{"line":79,"address":[],"length":0,"stats":{"Line":3518}},{"line":82,"address":[],"length":0,"stats":{"Line":19677}},{"line":90,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":8}},{"line":92,"address":[],"length":0,"stats":{"Line":8}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":8}},{"line":97,"address":[],"length":0,"stats":{"Line":8}},{"line":100,"address":[],"length":0,"stats":{"Line":8}},{"line":101,"address":[],"length":0,"stats":{"Line":8}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":8}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":16}},{"line":112,"address":[],"length":0,"stats":{"Line":42}},{"line":116,"address":[],"length":0,"stats":{"Line":4}},{"line":117,"address":[],"length":0,"stats":{"Line":4}},{"line":118,"address":[],"length":0,"stats":{"Line":4}},{"line":119,"address":[],"length":0,"stats":{"Line":4}},{"line":120,"address":[],"length":0,"stats":{"Line":4}},{"line":121,"address":[],"length":0,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":4}},{"line":124,"address":[],"length":0,"stats":{"Line":3}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":12}},{"line":132,"address":[],"length":0,"stats":{"Line":10074}},{"line":133,"address":[],"length":0,"stats":{"Line":20140}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":40280}},{"line":141,"address":[],"length":0,"stats":{"Line":20140}},{"line":142,"address":[],"length":0,"stats":{"Line":20140}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":30210}},{"line":147,"address":[],"length":0,"stats":{"Line":30210}},{"line":148,"address":[],"length":0,"stats":{"Line":30210}},{"line":153,"address":[],"length":0,"stats":{"Line":30210}},{"line":158,"address":[],"length":0,"stats":{"Line":30210}},{"line":163,"address":[],"length":0,"stats":{"Line":30210}},{"line":168,"address":[],"length":0,"stats":{"Line":30210}},{"line":169,"address":[],"length":0,"stats":{"Line":30210}},{"line":172,"address":[],"length":0,"stats":{"Line":20140}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":30210}},{"line":178,"address":[],"length":0,"stats":{"Line":10070}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":30210}},{"line":185,"address":[],"length":0,"stats":{"Line":20140}},{"line":187,"address":[],"length":0,"stats":{"Line":30210}},{"line":189,"address":[],"length":0,"stats":{"Line":10070}},{"line":190,"address":[],"length":0,"stats":{"Line":20140}},{"line":191,"address":[],"length":0,"stats":{"Line":10070}},{"line":192,"address":[],"length":0,"stats":{"Line":10070}},{"line":193,"address":[],"length":0,"stats":{"Line":10070}},{"line":194,"address":[],"length":0,"stats":{"Line":30210}},{"line":195,"address":[],"length":0,"stats":{"Line":30210}},{"line":196,"address":[],"length":0,"stats":{"Line":20140}},{"line":197,"address":[],"length":0,"stats":{"Line":10070}},{"line":198,"address":[],"length":0,"stats":{"Line":10070}},{"line":200,"address":[],"length":0,"stats":{"Line":20140}},{"line":204,"address":[],"length":0,"stats":{"Line":4}},{"line":208,"address":[],"length":0,"stats":{"Line":10075}},{"line":209,"address":[],"length":0,"stats":{"Line":20150}},{"line":210,"address":[],"length":0,"stats":{"Line":20150}},{"line":211,"address":[],"length":0,"stats":{"Line":20150}},{"line":212,"address":[],"length":0,"stats":{"Line":30225}},{"line":214,"address":[],"length":0,"stats":{"Line":1993105}},{"line":215,"address":[],"length":0,"stats":{"Line":91155}},{"line":216,"address":[],"length":0,"stats":{"Line":201360}},{"line":217,"address":[],"length":0,"stats":{"Line":181342}},{"line":218,"address":[],"length":0,"stats":{"Line":362684}},{"line":219,"address":[],"length":0,"stats":{"Line":90671}},{"line":221,"address":[],"length":0,"stats":{"Line":689409}},{"line":226,"address":[],"length":0,"stats":{"Line":30225}},{"line":227,"address":[],"length":0,"stats":{"Line":30225}},{"line":230,"address":[],"length":0,"stats":{"Line":10075}},{"line":234,"address":[],"length":0,"stats":{"Line":10074}},{"line":238,"address":[],"length":0,"stats":{"Line":30218}},{"line":239,"address":[],"length":0,"stats":{"Line":30210}},{"line":243,"address":[],"length":0,"stats":{"Line":8}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":8}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":8}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":11}},{"line":259,"address":[],"length":0,"stats":{"Line":12}},{"line":260,"address":[],"length":0,"stats":{"Line":9}},{"line":263,"address":[],"length":0,"stats":{"Line":1}}],"covered":103,"coverable":124},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","droid.rs"],"content":"//! Droid (Factory.ai) session parser\n//!\n//! Parses JSON files from ~/.factory/sessions/\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Droid settings.json structure\n#[derive(Debug, Deserialize)]\npub struct DroidSettingsJson {\n    pub model: Option\u003cString\u003e,\n    #[serde(rename = \"providerLock\")]\n    pub provider_lock: Option\u003cString\u003e,\n    #[serde(rename = \"providerLockTimestamp\")]\n    pub provider_lock_timestamp: Option\u003cString\u003e,\n    #[serde(rename = \"tokenUsage\")]\n    pub token_usage: Option\u003cDroidTokenUsage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct DroidTokenUsage {\n    #[serde(rename = \"inputTokens\")]\n    pub input_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"outputTokens\")]\n    pub output_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheCreationTokens\")]\n    pub cache_creation_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheReadTokens\")]\n    pub cache_read_tokens: Option\u003ci64\u003e,\n    #[serde(rename = \"thinkingTokens\")]\n    pub thinking_tokens: Option\u003ci64\u003e,\n}\n\n/// Normalize model name from Droid's custom format\n/// e.g., \"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\" -\u003e \"claude-opus-4-5-thinking-0\"\n/// e.g., \"gemini-2.5-pro\" -\u003e \"gemini-2-5-pro\"\n/// e.g., \"Claude-Sonnet-4-[Anthropic]\" -\u003e \"claude-sonnet-4\"\nfn normalize_model_name(model: \u0026str) -\u003e String {\n    // Remove \"custom:\" prefix if present\n    let mut normalized = model.strip_prefix(\"custom:\").unwrap_or(model).to_string();\n\n    // Handle bracket notation like \"Claude-Opus-4.5-Thinking-[Anthropic]-0\"\n    // Remove [anything] patterns (like TypeScript's .replace(/\\[.*?\\]/g, \"\"))\n    let mut result = String::new();\n    let mut in_bracket = false;\n\n    for ch in normalized.chars() {\n        match ch {\n            '[' =\u003e in_bracket = true,\n            ']' =\u003e in_bracket = false,\n            _ if !in_bracket =\u003e result.push(ch),\n            _ =\u003e {}\n        }\n    }\n\n    normalized = result;\n\n    // Remove trailing hyphens only (like TypeScript's .replace(/-+$/, \"\"))\n    // NOTE: Do NOT remove trailing digits - TypeScript keeps them\n    normalized = normalized.trim_end_matches('-').to_string();\n\n    // Convert to lowercase (like TypeScript's .toLowerCase())\n    normalized = normalized.to_lowercase();\n\n    // Replace dots with hyphens (like TypeScript's .replace(/\\./g, \"-\"))\n    normalized = normalized.replace('.', \"-\");\n\n    // Collapse multiple consecutive hyphens into one (like TypeScript's .replace(/-+/g, \"-\"))\n    let mut collapsed = String::new();\n    let mut last_was_hyphen = false;\n    for ch in normalized.chars() {\n        if ch == '-' {\n            if !last_was_hyphen {\n                collapsed.push(ch);\n            }\n            last_was_hyphen = true;\n        } else {\n            collapsed.push(ch);\n            last_was_hyphen = false;\n        }\n    }\n\n    collapsed\n}\n\nfn get_provider_from_model(model: \u0026str) -\u003e \u0026'static str {\n    let lower = model.to_lowercase();\n\n    if lower.contains(\"claude\")\n        || lower.contains(\"anthropic\")\n        || lower.contains(\"opus\")\n        || lower.contains(\"sonnet\")\n        || lower.contains(\"haiku\")\n    {\n        return \"anthropic\";\n    }\n    if lower.contains(\"gpt\")\n        || lower.contains(\"openai\")\n        || lower.contains(\"o1\")\n        || lower.contains(\"o3\")\n    {\n        return \"openai\";\n    }\n    if lower.contains(\"gemini\") || lower.contains(\"google\") {\n        return \"google\";\n    }\n    if lower.contains(\"grok\") {\n        return \"xai\";\n    }\n\n    \"unknown\"\n}\n\n/// Get default model name based on provider when model field is missing\nfn get_default_model_from_provider(provider: \u0026str) -\u003e String {\n    match provider.to_lowercase().as_str() {\n        \"anthropic\" =\u003e \"claude-unknown\".to_string(),\n        \"openai\" =\u003e \"gpt-unknown\".to_string(),\n        \"google\" =\u003e \"gemini-unknown\".to_string(),\n        \"xai\" =\u003e \"grok-unknown\".to_string(),\n        _ =\u003e format!(\"{}-unknown\", provider),\n    }\n}\n\n/// Try to extract model name from JSONL file's system-reminder\n/// Looks for pattern: \"Model: Claude Opus 4.5 Thinking [Anthropic]\"\nfn extract_model_from_jsonl(jsonl_path: \u0026Path) -\u003e Option\u003cString\u003e {\n    let file = std::fs::File::open(jsonl_path).ok()?;\n    let reader = BufReader::new(file);\n\n    // Scan more lines for parity with TypeScript which reads entire file\n    // Cap at 500 lines to avoid performance issues with very large files\n    for line in reader.lines().take(500) {\n        let line = line.ok()?;\n        // Look for Model: pattern in system-reminder\n        if let Some(pos) = line.find(\"Model:\") {\n            let after_model = \u0026line[pos + 6..];\n            // Extract until [ or end of string/newline\n            let model_part: String = after_model\n                .chars()\n                .take_while(|\u0026c| c != '[' \u0026\u0026 c != '\\\\' \u0026\u0026 c != '\"')\n                .collect();\n            let model_name = model_part.trim();\n            if !model_name.is_empty() {\n                return Some(normalize_model_name(model_name));\n            }\n        }\n    }\n\n    None\n}\n\n/// Parse a Droid settings.json file\npub fn parse_droid_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let data = match std::fs::read(path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data;\n    let settings: DroidSettingsJson = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(s) =\u003e s,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    // Skip if no token usage data\n    let usage = match settings.token_usage {\n        Some(u) =\u003e u,\n        None =\u003e return Vec::new(),\n    };\n\n    // Calculate total tokens to check if any were used\n    let total_tokens = usage.input_tokens.unwrap_or(0)\n        + usage.output_tokens.unwrap_or(0)\n        + usage.cache_creation_tokens.unwrap_or(0)\n        + usage.cache_read_tokens.unwrap_or(0)\n        + usage.thinking_tokens.unwrap_or(0);\n\n    if total_tokens == 0 {\n        return Vec::new();\n    }\n\n    // Extract session ID from filename (e.g., \"uuid.settings.json\" -\u003e \"uuid\")\n    let session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string()\n        .replace(\".settings\", \"\");\n\n    // Get model and provider\n    let provider = settings.provider_lock.clone().unwrap_or_else(|| {\n        get_provider_from_model(settings.model.as_deref().unwrap_or(\"\")).to_string()\n    });\n\n    let model = if let Some(m) = settings.model {\n        normalize_model_name(\u0026m)\n    } else {\n        // Try to extract from JSONL file\n        let jsonl_path = path\n            .to_str()\n            .map(|s| s.replace(\".settings.json\", \".jsonl\"))\n            .map(std::path::PathBuf::from);\n\n        if let Some(ref jsonl) = jsonl_path {\n            extract_model_from_jsonl(jsonl)\n                .unwrap_or_else(|| get_default_model_from_provider(\u0026provider))\n        } else {\n            get_default_model_from_provider(\u0026provider)\n        }\n    };\n\n    // Get timestamp from providerLockTimestamp or file mtime\n    let timestamp = settings\n        .provider_lock_timestamp\n        .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n        .map(|dt| dt.timestamp_millis())\n        .or_else(|| {\n            std::fs::metadata(path)\n                .ok()\n                .and_then(|m| m.modified().ok())\n                .map(|t| {\n                    t.duration_since(std::time::UNIX_EPOCH)\n                        .map(|d| d.as_millis() as i64)\n                        .unwrap_or(0)\n                })\n        })\n        .unwrap_or(0);\n\n    if timestamp == 0 {\n        return Vec::new();\n    }\n\n    vec![UnifiedMessage::new(\n        \"droid\",\n        model,\n        provider,\n        session_id,\n        timestamp,\n        TokenBreakdown {\n            input: usage.input_tokens.unwrap_or(0).max(0),\n            output: usage.output_tokens.unwrap_or(0).max(0),\n            cache_read: usage.cache_read_tokens.unwrap_or(0).max(0),\n            cache_write: usage.cache_creation_tokens.unwrap_or(0).max(0),\n            reasoning: usage.thinking_tokens.unwrap_or(0).max(0),\n        },\n        0.0,\n    )]\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_normalize_model_name_custom_prefix() {\n        // TypeScript keeps trailing digits: \"claude-opus-4-5-thinking-0\"\n        assert_eq!(\n            normalize_model_name(\"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\"),\n            \"claude-opus-4-5-thinking-0\"\n        );\n    }\n\n    #[test]\n    fn test_normalize_model_name_simple() {\n        // Dots become hyphens: \"gemini-2.5-pro\" -\u003e \"gemini-2-5-pro\"\n        assert_eq!(normalize_model_name(\"gemini-2.5-pro\"), \"gemini-2-5-pro\");\n    }\n\n    #[test]\n    fn test_normalize_model_name_brackets() {\n        // TypeScript keeps trailing digits: \"claude-sonnet-4\"\n        assert_eq!(\n            normalize_model_name(\"Claude-Sonnet-4-[Anthropic]\"),\n            \"claude-sonnet-4\"\n        );\n    }\n\n    #[test]\n    fn test_get_provider_from_model() {\n        assert_eq!(get_provider_from_model(\"claude-3-sonnet\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"opus-4\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"sonnet-4\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"haiku-3\"), \"anthropic\");\n        assert_eq!(get_provider_from_model(\"gpt-4o\"), \"openai\");\n        assert_eq!(get_provider_from_model(\"o1-preview\"), \"openai\");\n        assert_eq!(get_provider_from_model(\"o3-mini\"), \"openai\");\n        assert_eq!(get_provider_from_model(\"gemini-pro\"), \"google\");\n        assert_eq!(get_provider_from_model(\"grok-2\"), \"xai\");\n        assert_eq!(get_provider_from_model(\"unknown-model\"), \"unknown\");\n    }\n\n    #[test]\n    fn test_get_default_model_from_provider() {\n        assert_eq!(\n            get_default_model_from_provider(\"anthropic\"),\n            \"claude-unknown\"\n        );\n        assert_eq!(get_default_model_from_provider(\"openai\"), \"gpt-unknown\");\n        assert_eq!(get_default_model_from_provider(\"google\"), \"gemini-unknown\");\n        assert_eq!(get_default_model_from_provider(\"xai\"), \"grok-unknown\");\n        assert_eq!(get_default_model_from_provider(\"custom\"), \"custom-unknown\");\n    }\n\n    #[test]\n    fn test_parse_droid_settings_structure() {\n        let json = r#\"{\n            \"model\": \"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\",\n            \"providerLock\": \"anthropic\",\n            \"providerLockTimestamp\": \"2024-12-26T12:00:00Z\",\n            \"tokenUsage\": {\n                \"inputTokens\": 1234,\n                \"outputTokens\": 567,\n                \"cacheCreationTokens\": 89,\n                \"cacheReadTokens\": 12,\n                \"thinkingTokens\": 34\n            }\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let settings: DroidSettingsJson = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(\n            settings.model,\n            Some(\"custom:Claude-Opus-4.5-Thinking-[Anthropic]-0\".to_string())\n        );\n        assert_eq!(settings.provider_lock, Some(\"anthropic\".to_string()));\n\n        let usage = settings.token_usage.unwrap();\n        assert_eq!(usage.input_tokens, Some(1234));\n        assert_eq!(usage.output_tokens, Some(567));\n        assert_eq!(usage.cache_creation_tokens, Some(89));\n        assert_eq!(usage.cache_read_tokens, Some(12));\n        assert_eq!(usage.thinking_tokens, Some(34));\n    }\n}\n","traces":[{"line":41,"address":[],"length":0,"stats":{"Line":5}},{"line":43,"address":[],"length":0,"stats":{"Line":25}},{"line":47,"address":[],"length":0,"stats":{"Line":10}},{"line":48,"address":[],"length":0,"stats":{"Line":10}},{"line":50,"address":[],"length":0,"stats":{"Line":132}},{"line":51,"address":[],"length":0,"stats":{"Line":123}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":420}},{"line":55,"address":[],"length":0,"stats":{"Line":18}},{"line":59,"address":[],"length":0,"stats":{"Line":10}},{"line":63,"address":[],"length":0,"stats":{"Line":15}},{"line":66,"address":[],"length":0,"stats":{"Line":10}},{"line":69,"address":[],"length":0,"stats":{"Line":15}},{"line":72,"address":[],"length":0,"stats":{"Line":10}},{"line":73,"address":[],"length":0,"stats":{"Line":10}},{"line":74,"address":[],"length":0,"stats":{"Line":109}},{"line":75,"address":[],"length":0,"stats":{"Line":104}},{"line":76,"address":[],"length":0,"stats":{"Line":37}},{"line":77,"address":[],"length":0,"stats":{"Line":36}},{"line":79,"address":[],"length":0,"stats":{"Line":19}},{"line":81,"address":[],"length":0,"stats":{"Line":255}},{"line":82,"address":[],"length":0,"stats":{"Line":85}},{"line":86,"address":[],"length":0,"stats":{"Line":5}},{"line":89,"address":[],"length":0,"stats":{"Line":10}},{"line":90,"address":[],"length":0,"stats":{"Line":30}},{"line":92,"address":[],"length":0,"stats":{"Line":10}},{"line":93,"address":[],"length":0,"stats":{"Line":9}},{"line":94,"address":[],"length":0,"stats":{"Line":9}},{"line":95,"address":[],"length":0,"stats":{"Line":8}},{"line":96,"address":[],"length":0,"stats":{"Line":7}},{"line":98,"address":[],"length":0,"stats":{"Line":4}},{"line":100,"address":[],"length":0,"stats":{"Line":6}},{"line":101,"address":[],"length":0,"stats":{"Line":5}},{"line":102,"address":[],"length":0,"stats":{"Line":5}},{"line":103,"address":[],"length":0,"stats":{"Line":4}},{"line":105,"address":[],"length":0,"stats":{"Line":3}},{"line":107,"address":[],"length":0,"stats":{"Line":5}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":2}},{"line":111,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":5}},{"line":119,"address":[],"length":0,"stats":{"Line":5}},{"line":120,"address":[],"length":0,"stats":{"Line":7}},{"line":121,"address":[],"length":0,"stats":{"Line":6}},{"line":122,"address":[],"length":0,"stats":{"Line":5}},{"line":123,"address":[],"length":0,"stats":{"Line":4}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":158,"address":[],"length":0,"stats":{"Line":4}},{"line":159,"address":[],"length":0,"stats":{"Line":4}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":4}},{"line":164,"address":[],"length":0,"stats":{"Line":6}},{"line":165,"address":[],"length":0,"stats":{"Line":4}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":4}},{"line":171,"address":[],"length":0,"stats":{"Line":4}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":14}},{"line":177,"address":[],"length":0,"stats":{"Line":8}},{"line":178,"address":[],"length":0,"stats":{"Line":6}},{"line":179,"address":[],"length":0,"stats":{"Line":4}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":2}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":4}},{"line":189,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":8}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":6}},{"line":200,"address":[],"length":0,"stats":{"Line":4}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":4}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":8}},{"line":220,"address":[],"length":0,"stats":{"Line":6}},{"line":221,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":4}},{"line":239,"address":[],"length":0,"stats":{"Line":2}},{"line":240,"address":[],"length":0,"stats":{"Line":2}},{"line":241,"address":[],"length":0,"stats":{"Line":2}},{"line":242,"address":[],"length":0,"stats":{"Line":2}},{"line":243,"address":[],"length":0,"stats":{"Line":2}},{"line":244,"address":[],"length":0,"stats":{"Line":8}},{"line":245,"address":[],"length":0,"stats":{"Line":8}},{"line":246,"address":[],"length":0,"stats":{"Line":8}},{"line":247,"address":[],"length":0,"stats":{"Line":8}},{"line":248,"address":[],"length":0,"stats":{"Line":4}}],"covered":85,"coverable":118},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","gemini.rs"],"content":"//! Gemini CLI session parser\n//!\n//! Parses JSON session files from ~/.gemini/tmp/*/chats/session-*.json\n\nuse super::utils::{\n    extract_i64, extract_string, file_modified_timestamp_ms, parse_timestamp_value,\n};\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse serde_json::Value;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Gemini session structure\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GeminiSession {\n    #[serde(rename = \"sessionId\")]\n    pub session_id: String,\n    #[serde(rename = \"projectHash\")]\n    pub project_hash: String,\n    #[serde(rename = \"startTime\")]\n    pub start_time: String,\n    #[serde(rename = \"lastUpdated\")]\n    pub last_updated: String,\n    pub messages: Vec\u003cGeminiMessage\u003e,\n}\n\n/// Gemini message structure\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GeminiMessage {\n    pub id: String,\n    pub timestamp: Option\u003cString\u003e,\n    #[serde(rename = \"type\")]\n    pub message_type: String,\n    pub content: Option\u003cString\u003e,\n    pub tokens: Option\u003cGeminiTokens\u003e,\n    pub model: Option\u003cString\u003e,\n}\n\n/// Gemini token structure\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GeminiTokens {\n    pub input: Option\u003ci64\u003e,\n    pub output: Option\u003ci64\u003e,\n    pub cached: Option\u003ci64\u003e,\n    pub thoughts: Option\u003ci64\u003e,\n    pub tool: Option\u003ci64\u003e,\n    pub total: Option\u003ci64\u003e,\n}\n\n/// Parse a Gemini session file\npub fn parse_gemini_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    if path.extension().and_then(|s| s.to_str()) == Some(\"jsonl\") {\n        return parse_gemini_headless_jsonl(path, fallback_timestamp);\n    }\n\n    let data = match std::fs::read(path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data.clone();\n    if let Ok(session) = simd_json::from_slice::\u003cGeminiSession\u003e(\u0026mut bytes) {\n        return parse_gemini_session(session, fallback_timestamp);\n    }\n\n    let mut bytes = data;\n    if let Ok(value) = simd_json::from_slice::\u003cValue\u003e(\u0026mut bytes) {\n        let session_id = path\n            .file_stem()\n            .and_then(|s| s.to_str())\n            .unwrap_or(\"unknown\")\n            .to_string();\n        let messages = parse_gemini_headless_value(\u0026value, \u0026session_id, fallback_timestamp);\n        if !messages.is_empty() {\n            return messages;\n        }\n    }\n\n    parse_gemini_headless_jsonl(path, fallback_timestamp)\n}\n\nfn parse_gemini_session(session: GeminiSession, fallback_timestamp: i64) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let mut messages = Vec::new();\n    let session_id = session.session_id.clone();\n\n    for msg in session.messages {\n        // Only process gemini messages with token data\n        if msg.message_type != \"gemini\" {\n            continue;\n        }\n\n        let tokens = match msg.tokens {\n            Some(t) =\u003e t,\n            None =\u003e continue,\n        };\n\n        let model = match msg.model {\n            Some(m) =\u003e m,\n            None =\u003e continue,\n        };\n\n        let timestamp = msg\n            .timestamp\n            .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n            .map(|dt| dt.timestamp_millis())\n            .unwrap_or(fallback_timestamp);\n\n        messages.push(UnifiedMessage::new(\n            \"gemini\",\n            model,\n            \"google\",\n            session_id.clone(),\n            timestamp,\n            TokenBreakdown {\n                input: tokens.input.unwrap_or(0).max(0),\n                output: tokens.output.unwrap_or(0).max(0),\n                cache_read: tokens.cached.unwrap_or(0).max(0),\n                cache_write: 0,\n                reasoning: tokens.thoughts.unwrap_or(0).max(0),\n            },\n            0.0,\n        ));\n    }\n\n    messages\n}\n\nfn parse_gemini_headless_jsonl(path: \u0026Path, fallback_timestamp: i64) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut session_id = path\n        .file_stem()\n        .and_then(|s| s.to_str())\n        .unwrap_or(\"unknown\")\n        .to_string();\n    let mut current_model: Option\u003cString\u003e = None;\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        let value: Value = match simd_json::from_slice(\u0026mut bytes) {\n            Ok(v) =\u003e v,\n            Err(_) =\u003e continue,\n        };\n\n        let event_type = value.get(\"type\").and_then(|val| val.as_str()).unwrap_or(\"\");\n        if event_type == \"init\" {\n            if let Some(model) = extract_string(value.get(\"model\")) {\n                current_model = Some(model);\n            }\n            if let Some(id) =\n                extract_string(value.get(\"session_id\").or_else(|| value.get(\"sessionId\")))\n            {\n                session_id = id;\n            }\n            continue;\n        }\n\n        let stats = value\n            .get(\"stats\")\n            .or_else(|| value.get(\"result\").and_then(|result| result.get(\"stats\")));\n        if let Some(stats) = stats {\n            let timestamp = extract_timestamp_from_value(\u0026value).unwrap_or(fallback_timestamp);\n            messages.extend(build_messages_from_stats(\n                stats,\n                current_model.clone(),\n                \u0026session_id,\n                timestamp,\n            ));\n        }\n    }\n\n    messages\n}\n\nfn parse_gemini_headless_value(\n    value: \u0026Value,\n    session_id: \u0026str,\n    fallback_timestamp: i64,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let stats = match value\n        .get(\"stats\")\n        .or_else(|| value.get(\"result\").and_then(|result| result.get(\"stats\")))\n    {\n        Some(s) =\u003e s,\n        None =\u003e return Vec::new(),\n    };\n\n    let model_hint = extract_string(value.get(\"model\"));\n    let timestamp = extract_timestamp_from_value(value).unwrap_or(fallback_timestamp);\n\n    build_messages_from_stats(stats, model_hint, session_id, timestamp)\n}\n\nfn build_messages_from_stats(\n    stats: \u0026Value,\n    model_hint: Option\u003cString\u003e,\n    session_id: \u0026str,\n    timestamp: i64,\n) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let usages = extract_gemini_usages(stats, model_hint);\n    usages\n        .into_iter()\n        .map(|usage| {\n            UnifiedMessage::new(\n                \"gemini\",\n                usage.model,\n                \"google\",\n                session_id.to_string(),\n                timestamp,\n                TokenBreakdown {\n                    input: usage.input.max(0),\n                    output: usage.output.max(0),\n                    cache_read: usage.cached.max(0),\n                    cache_write: 0,\n                    reasoning: usage.reasoning.max(0),\n                },\n                0.0,\n            )\n        })\n        .collect()\n}\n\nstruct GeminiHeadlessUsage {\n    model: String,\n    input: i64,\n    output: i64,\n    cached: i64,\n    reasoning: i64,\n}\n\nfn extract_gemini_usages(stats: \u0026Value, model_hint: Option\u003cString\u003e) -\u003e Vec\u003cGeminiHeadlessUsage\u003e {\n    if let Some(models) = stats.get(\"models\").and_then(|val| val.as_object()) {\n        let mut usages = Vec::new();\n        for (model, data) in models {\n            let tokens = match data.get(\"tokens\") {\n                Some(t) =\u003e t,\n                None =\u003e continue,\n            };\n            let input = extract_i64(tokens.get(\"prompt\"))\n                .or_else(|| extract_i64(tokens.get(\"input\")))\n                .or_else(|| extract_i64(tokens.get(\"input_tokens\")))\n                .unwrap_or(0);\n            let output = extract_i64(tokens.get(\"candidates\"))\n                .or_else(|| extract_i64(tokens.get(\"output\")))\n                .or_else(|| extract_i64(tokens.get(\"output_tokens\")))\n                .unwrap_or(0);\n            let cached = extract_i64(tokens.get(\"cached\"))\n                .or_else(|| extract_i64(tokens.get(\"cached_tokens\")))\n                .unwrap_or(0);\n            let reasoning = extract_i64(tokens.get(\"thoughts\"))\n                .or_else(|| extract_i64(tokens.get(\"reasoning\")))\n                .unwrap_or(0);\n\n            if input == 0 \u0026\u0026 output == 0 \u0026\u0026 cached == 0 \u0026\u0026 reasoning == 0 {\n                continue;\n            }\n\n            usages.push(GeminiHeadlessUsage {\n                model: model.clone(),\n                input,\n                output,\n                cached,\n                reasoning,\n            });\n        }\n\n        if !usages.is_empty() {\n            return usages;\n        }\n    }\n\n    let input = extract_i64(stats.get(\"input_tokens\"))\n        .or_else(|| extract_i64(stats.get(\"prompt_tokens\")))\n        .unwrap_or(0);\n    let output = extract_i64(stats.get(\"output_tokens\"))\n        .or_else(|| extract_i64(stats.get(\"candidates_tokens\")))\n        .unwrap_or(0);\n    let cached = extract_i64(stats.get(\"cached_tokens\")).unwrap_or(0);\n    let reasoning = extract_i64(stats.get(\"thoughts_tokens\"))\n        .or_else(|| extract_i64(stats.get(\"reasoning_tokens\")))\n        .unwrap_or(0);\n\n    if input == 0 \u0026\u0026 output == 0 \u0026\u0026 cached == 0 \u0026\u0026 reasoning == 0 {\n        return Vec::new();\n    }\n\n    vec![GeminiHeadlessUsage {\n        model: model_hint.unwrap_or_else(|| \"unknown\".to_string()),\n        input,\n        output,\n        cached,\n        reasoning,\n    }]\n}\n\nfn extract_timestamp_from_value(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    value\n        .get(\"timestamp\")\n        .or_else(|| value.get(\"created_at\"))\n        .and_then(parse_timestamp_value)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n\n    #[test]\n    fn test_parse_gemini_structure() {\n        let json = r#\"{\n            \"sessionId\": \"ses_123\",\n            \"projectHash\": \"abc123\",\n            \"startTime\": \"2025-06-15T12:00:00Z\",\n            \"lastUpdated\": \"2025-06-15T12:30:00Z\",\n            \"messages\": [\n                {\n                    \"id\": \"msg_1\",\n                    \"timestamp\": \"2025-06-15T12:00:00Z\",\n                    \"type\": \"user\",\n                    \"content\": \"Hello\"\n                },\n                {\n                    \"id\": \"msg_2\",\n                    \"timestamp\": \"2025-06-15T12:01:00Z\",\n                    \"type\": \"gemini\",\n                    \"content\": \"Hi there!\",\n                    \"model\": \"gemini-2.0-flash\",\n                    \"tokens\": {\n                        \"input\": 10,\n                        \"output\": 20,\n                        \"cached\": 5,\n                        \"thoughts\": 0,\n                        \"tool\": 0,\n                        \"total\": 35\n                    }\n                }\n            ]\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let session: GeminiSession = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(session.messages.len(), 2);\n        assert_eq!(\n            session.messages[1].model,\n            Some(\"gemini-2.0-flash\".to_string())\n        );\n    }\n\n    #[test]\n    fn test_parse_headless_json() {\n        let json = r#\"{\"response\":\"Hi\",\"stats\":{\"models\":{\"gemini-2.5-pro\":{\"tokens\":{\"prompt\":12,\"candidates\":34,\"cached\":5,\"thoughts\":2}}}}}\"#;\n        let file = tempfile::Builder::new().suffix(\".json\").tempfile().unwrap();\n        std::fs::write(file.path(), json).unwrap();\n\n        let messages = parse_gemini_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gemini-2.5-pro\");\n        assert_eq!(messages[0].tokens.input, 12);\n        assert_eq!(messages[0].tokens.output, 34);\n        assert_eq!(messages[0].tokens.cache_read, 5);\n        assert_eq!(messages[0].tokens.reasoning, 2);\n    }\n\n    #[test]\n    fn test_parse_headless_stream_jsonl() {\n        let content = r#\"{\"type\":\"init\",\"model\":\"gemini-2.5-pro\",\"session_id\":\"session-1\"}\n{\"type\":\"result\",\"stats\":{\"input_tokens\":10,\"output_tokens\":20}}\"#;\n        let mut file = tempfile::Builder::new()\n            .suffix(\".jsonl\")\n            .tempfile()\n            .unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n\n        let messages = parse_gemini_file(file.path());\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gemini-2.5-pro\");\n        assert_eq!(messages[0].tokens.input, 10);\n        assert_eq!(messages[0].tokens.output, 20);\n    }\n}\n","traces":[{"line":56,"address":[],"length":0,"stats":{"Line":26}},{"line":57,"address":[],"length":0,"stats":{"Line":78}},{"line":59,"address":[],"length":0,"stats":{"Line":156}},{"line":60,"address":[],"length":0,"stats":{"Line":3}},{"line":63,"address":[],"length":0,"stats":{"Line":50}},{"line":64,"address":[],"length":0,"stats":{"Line":50}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":75}},{"line":69,"address":[],"length":0,"stats":{"Line":49}},{"line":70,"address":[],"length":0,"stats":{"Line":72}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":3}},{"line":80,"address":[],"length":0,"stats":{"Line":5}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":24}},{"line":90,"address":[],"length":0,"stats":{"Line":48}},{"line":91,"address":[],"length":0,"stats":{"Line":72}},{"line":93,"address":[],"length":0,"stats":{"Line":760}},{"line":95,"address":[],"length":0,"stats":{"Line":736}},{"line":96,"address":[],"length":0,"stats":{"Line":166}},{"line":99,"address":[],"length":0,"stats":{"Line":1140}},{"line":100,"address":[],"length":0,"stats":{"Line":1140}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":1140}},{"line":105,"address":[],"length":0,"stats":{"Line":1140}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":1140}},{"line":110,"address":[],"length":0,"stats":{"Line":570}},{"line":111,"address":[],"length":0,"stats":{"Line":2280}},{"line":112,"address":[],"length":0,"stats":{"Line":1710}},{"line":113,"address":[],"length":0,"stats":{"Line":1140}},{"line":115,"address":[],"length":0,"stats":{"Line":1710}},{"line":117,"address":[],"length":0,"stats":{"Line":570}},{"line":119,"address":[],"length":0,"stats":{"Line":1140}},{"line":120,"address":[],"length":0,"stats":{"Line":570}},{"line":121,"address":[],"length":0,"stats":{"Line":570}},{"line":122,"address":[],"length":0,"stats":{"Line":2280}},{"line":123,"address":[],"length":0,"stats":{"Line":2280}},{"line":124,"address":[],"length":0,"stats":{"Line":2280}},{"line":125,"address":[],"length":0,"stats":{"Line":570}},{"line":126,"address":[],"length":0,"stats":{"Line":1140}},{"line":132,"address":[],"length":0,"stats":{"Line":24}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":143,"address":[],"length":0,"stats":{"Line":3}},{"line":146,"address":[],"length":0,"stats":{"Line":3}},{"line":147,"address":[],"length":0,"stats":{"Line":3}},{"line":148,"address":[],"length":0,"stats":{"Line":2}},{"line":150,"address":[],"length":0,"stats":{"Line":4}},{"line":151,"address":[],"length":0,"stats":{"Line":4}},{"line":152,"address":[],"length":0,"stats":{"Line":4}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":4}},{"line":157,"address":[],"length":0,"stats":{"Line":4}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":6}},{"line":162,"address":[],"length":0,"stats":{"Line":6}},{"line":163,"address":[],"length":0,"stats":{"Line":4}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":16}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":4}},{"line":170,"address":[],"length":0,"stats":{"Line":1}},{"line":172,"address":[],"length":0,"stats":{"Line":1}},{"line":173,"address":[],"length":0,"stats":{"Line":4}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":3}},{"line":184,"address":[],"length":0,"stats":{"Line":6}},{"line":185,"address":[],"length":0,"stats":{"Line":4}},{"line":186,"address":[],"length":0,"stats":{"Line":2}},{"line":187,"address":[],"length":0,"stats":{"Line":3}},{"line":188,"address":[],"length":0,"stats":{"Line":1}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":203,"address":[],"length":0,"stats":{"Line":1}},{"line":204,"address":[],"length":0,"stats":{"Line":1}},{"line":206,"address":[],"length":0,"stats":{"Line":2}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":4}},{"line":211,"address":[],"length":0,"stats":{"Line":5}},{"line":213,"address":[],"length":0,"stats":{"Line":5}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":8}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":2}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":4}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":232,"address":[],"length":0,"stats":{"Line":2}},{"line":233,"address":[],"length":0,"stats":{"Line":6}},{"line":234,"address":[],"length":0,"stats":{"Line":6}},{"line":235,"address":[],"length":0,"stats":{"Line":6}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":237,"address":[],"length":0,"stats":{"Line":2}},{"line":253,"address":[],"length":0,"stats":{"Line":2}},{"line":254,"address":[],"length":0,"stats":{"Line":9}},{"line":255,"address":[],"length":0,"stats":{"Line":2}},{"line":256,"address":[],"length":0,"stats":{"Line":3}},{"line":257,"address":[],"length":0,"stats":{"Line":2}},{"line":258,"address":[],"length":0,"stats":{"Line":2}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":4}},{"line":262,"address":[],"length":0,"stats":{"Line":1}},{"line":263,"address":[],"length":0,"stats":{"Line":1}},{"line":265,"address":[],"length":0,"stats":{"Line":4}},{"line":266,"address":[],"length":0,"stats":{"Line":1}},{"line":267,"address":[],"length":0,"stats":{"Line":1}},{"line":269,"address":[],"length":0,"stats":{"Line":4}},{"line":270,"address":[],"length":0,"stats":{"Line":1}},{"line":272,"address":[],"length":0,"stats":{"Line":4}},{"line":273,"address":[],"length":0,"stats":{"Line":1}},{"line":276,"address":[],"length":0,"stats":{"Line":1}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":3}},{"line":281,"address":[],"length":0,"stats":{"Line":3}},{"line":282,"address":[],"length":0,"stats":{"Line":2}},{"line":283,"address":[],"length":0,"stats":{"Line":2}},{"line":284,"address":[],"length":0,"stats":{"Line":1}},{"line":285,"address":[],"length":0,"stats":{"Line":1}},{"line":289,"address":[],"length":0,"stats":{"Line":1}},{"line":290,"address":[],"length":0,"stats":{"Line":1}},{"line":294,"address":[],"length":0,"stats":{"Line":4}},{"line":295,"address":[],"length":0,"stats":{"Line":1}},{"line":297,"address":[],"length":0,"stats":{"Line":4}},{"line":298,"address":[],"length":0,"stats":{"Line":1}},{"line":300,"address":[],"length":0,"stats":{"Line":5}},{"line":301,"address":[],"length":0,"stats":{"Line":4}},{"line":302,"address":[],"length":0,"stats":{"Line":4}},{"line":305,"address":[],"length":0,"stats":{"Line":1}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":1}},{"line":310,"address":[],"length":0,"stats":{"Line":2}},{"line":311,"address":[],"length":0,"stats":{"Line":1}},{"line":312,"address":[],"length":0,"stats":{"Line":1}},{"line":313,"address":[],"length":0,"stats":{"Line":1}},{"line":314,"address":[],"length":0,"stats":{"Line":1}},{"line":318,"address":[],"length":0,"stats":{"Line":2}},{"line":319,"address":[],"length":0,"stats":{"Line":2}},{"line":321,"address":[],"length":0,"stats":{"Line":6}},{"line":322,"address":[],"length":0,"stats":{"Line":2}}],"covered":141,"coverable":153},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","mod.rs"],"content":"//! Session parsers for different AI coding assistant formats\n//!\n//! Each source has its own parser that converts to a unified message format.\n\npub mod amp;\npub mod claudecode;\npub mod codex;\npub mod cursor;\npub mod droid;\npub mod gemini;\npub mod openclaw;\npub mod opencode;\npub mod pi;\npub(crate) mod utils;\n\nuse crate::TokenBreakdown;\n\n#[derive(Debug, Clone)]\npub struct UnifiedMessage {\n    pub source: String,\n    pub model_id: String,\n    pub provider_id: String,\n    pub session_id: String,\n    pub timestamp: i64,\n    pub date: String,\n    pub tokens: TokenBreakdown,\n    pub cost: f64,\n    pub agent: Option\u003cString\u003e,\n    pub dedup_key: Option\u003cString\u003e,\n}\n\npub fn normalize_agent_name(agent: \u0026str) -\u003e String {\n    let agent_lower = agent.to_lowercase();\n\n    if agent_lower.contains(\"plan\") {\n        if agent_lower.contains(\"omo\") || agent_lower.contains(\"sisyphus\") {\n            return \"Planner-Sisyphus\".to_string();\n        }\n        return agent.to_string();\n    }\n\n    if agent_lower == \"omo\" || agent_lower == \"sisyphus\" {\n        return \"Sisyphus\".to_string();\n    }\n\n    agent.to_string()\n}\n\nimpl UnifiedMessage {\n    pub fn new(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n    ) -\u003e Self {\n        Self::new_full(\n            source,\n            model_id,\n            provider_id,\n            session_id,\n            timestamp,\n            tokens,\n            cost,\n            None,\n            None,\n        )\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    pub fn new_with_agent(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n        agent: Option\u003cString\u003e,\n    ) -\u003e Self {\n        Self::new_full(\n            source,\n            model_id,\n            provider_id,\n            session_id,\n            timestamp,\n            tokens,\n            cost,\n            agent,\n            None,\n        )\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    pub fn new_with_dedup(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n        dedup_key: Option\u003cString\u003e,\n    ) -\u003e Self {\n        Self::new_full(\n            source,\n            model_id,\n            provider_id,\n            session_id,\n            timestamp,\n            tokens,\n            cost,\n            None,\n            dedup_key,\n        )\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    fn new_full(\n        source: impl Into\u003cString\u003e,\n        model_id: impl Into\u003cString\u003e,\n        provider_id: impl Into\u003cString\u003e,\n        session_id: impl Into\u003cString\u003e,\n        timestamp: i64,\n        tokens: TokenBreakdown,\n        cost: f64,\n        agent: Option\u003cString\u003e,\n        dedup_key: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let date = timestamp_to_date(timestamp);\n        Self {\n            source: source.into(),\n            model_id: model_id.into(),\n            provider_id: provider_id.into(),\n            session_id: session_id.into(),\n            timestamp,\n            date,\n            tokens,\n            cost,\n            agent,\n            dedup_key,\n        }\n    }\n}\n\n/// Convert Unix milliseconds timestamp to YYYY-MM-DD date string\nfn timestamp_to_date(timestamp_ms: i64) -\u003e String {\n    use chrono::{TimeZone, Utc};\n\n    let datetime = Utc.timestamp_millis_opt(timestamp_ms);\n    match datetime {\n        chrono::LocalResult::Single(dt) =\u003e dt.format(\"%Y-%m-%d\").to_string(),\n        _ =\u003e String::new(),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_timestamp_to_date() {\n        // 2025-06-16 12:00:00 UTC (1750075200 seconds since epoch)\n        let ts = 1750075200000_i64;\n        let date = timestamp_to_date(ts);\n        assert_eq!(date, \"2025-06-16\");\n    }\n\n    #[test]\n    fn test_timestamp_to_date_epoch() {\n        // Unix epoch: 1970-01-01\n        let ts = 0_i64;\n        let date = timestamp_to_date(ts);\n        assert_eq!(date, \"1970-01-01\");\n    }\n\n    #[test]\n    fn test_timestamp_to_date_recent() {\n        // 2024-12-01 00:00:00 UTC\n        let ts = 1733011200000_i64;\n        let date = timestamp_to_date(ts);\n        assert_eq!(date, \"2024-12-01\");\n    }\n\n    #[test]\n    fn test_unified_message_creation() {\n        let tokens = TokenBreakdown {\n            input: 100,\n            output: 50,\n            cache_read: 0,\n            cache_write: 0,\n            reasoning: 0,\n        };\n\n        let msg = UnifiedMessage::new(\n            \"opencode\",\n            \"claude-3-5-sonnet\",\n            \"anthropic\",\n            \"test-session-id\",\n            1733011200000,\n            tokens,\n            0.05,\n        );\n\n        assert_eq!(msg.source, \"opencode\");\n        assert_eq!(msg.model_id, \"claude-3-5-sonnet\");\n        assert_eq!(msg.session_id, \"test-session-id\");\n        assert_eq!(msg.date, \"2024-12-01\");\n        assert_eq!(msg.cost, 0.05);\n        assert_eq!(msg.agent, None);\n    }\n\n    #[test]\n    fn test_normalize_agent_name() {\n        assert_eq!(normalize_agent_name(\"OmO\"), \"Sisyphus\");\n        assert_eq!(normalize_agent_name(\"Sisyphus\"), \"Sisyphus\");\n        assert_eq!(normalize_agent_name(\"omo\"), \"Sisyphus\");\n        assert_eq!(normalize_agent_name(\"sisyphus\"), \"Sisyphus\");\n\n        assert_eq!(normalize_agent_name(\"OmO-Plan\"), \"Planner-Sisyphus\");\n        assert_eq!(normalize_agent_name(\"Planner-Sisyphus\"), \"Planner-Sisyphus\");\n        assert_eq!(normalize_agent_name(\"omo-plan\"), \"Planner-Sisyphus\");\n\n        assert_eq!(normalize_agent_name(\"explore\"), \"explore\");\n        assert_eq!(normalize_agent_name(\"CustomAgent\"), \"CustomAgent\");\n    }\n}\n","traces":[{"line":32,"address":[],"length":0,"stats":{"Line":446517}},{"line":33,"address":[],"length":0,"stats":{"Line":1339551}},{"line":35,"address":[],"length":0,"stats":{"Line":446517}},{"line":36,"address":[],"length":0,"stats":{"Line":8100}},{"line":37,"address":[],"length":0,"stats":{"Line":510}},{"line":39,"address":[],"length":0,"stats":{"Line":7620}},{"line":42,"address":[],"length":0,"stats":{"Line":874490}},{"line":43,"address":[],"length":0,"stats":{"Line":201656}},{"line":46,"address":[],"length":0,"stats":{"Line":683248}},{"line":50,"address":[],"length":0,"stats":{"Line":13428}},{"line":60,"address":[],"length":0,"stats":{"Line":13428}},{"line":61,"address":[],"length":0,"stats":{"Line":13428}},{"line":62,"address":[],"length":0,"stats":{"Line":13428}},{"line":63,"address":[],"length":0,"stats":{"Line":13428}},{"line":64,"address":[],"length":0,"stats":{"Line":13428}},{"line":65,"address":[],"length":0,"stats":{"Line":13428}},{"line":66,"address":[],"length":0,"stats":{"Line":13428}},{"line":67,"address":[],"length":0,"stats":{"Line":13428}},{"line":68,"address":[],"length":0,"stats":{"Line":13428}},{"line":73,"address":[],"length":0,"stats":{"Line":446526}},{"line":84,"address":[],"length":0,"stats":{"Line":446526}},{"line":85,"address":[],"length":0,"stats":{"Line":446526}},{"line":86,"address":[],"length":0,"stats":{"Line":446526}},{"line":87,"address":[],"length":0,"stats":{"Line":446526}},{"line":88,"address":[],"length":0,"stats":{"Line":446526}},{"line":89,"address":[],"length":0,"stats":{"Line":446526}},{"line":90,"address":[],"length":0,"stats":{"Line":446526}},{"line":91,"address":[],"length":0,"stats":{"Line":446526}},{"line":92,"address":[],"length":0,"stats":{"Line":446526}},{"line":97,"address":[],"length":0,"stats":{"Line":31382}},{"line":108,"address":[],"length":0,"stats":{"Line":31382}},{"line":109,"address":[],"length":0,"stats":{"Line":31382}},{"line":110,"address":[],"length":0,"stats":{"Line":31382}},{"line":111,"address":[],"length":0,"stats":{"Line":31382}},{"line":112,"address":[],"length":0,"stats":{"Line":31382}},{"line":113,"address":[],"length":0,"stats":{"Line":31382}},{"line":114,"address":[],"length":0,"stats":{"Line":31382}},{"line":115,"address":[],"length":0,"stats":{"Line":31382}},{"line":116,"address":[],"length":0,"stats":{"Line":31382}},{"line":121,"address":[],"length":0,"stats":{"Line":491336}},{"line":132,"address":[],"length":0,"stats":{"Line":1474008}},{"line":134,"address":[],"length":0,"stats":{"Line":1474008}},{"line":135,"address":[],"length":0,"stats":{"Line":1474008}},{"line":136,"address":[],"length":0,"stats":{"Line":1474008}},{"line":137,"address":[],"length":0,"stats":{"Line":1474008}},{"line":149,"address":[],"length":0,"stats":{"Line":491339}},{"line":152,"address":[],"length":0,"stats":{"Line":1965356}},{"line":153,"address":[],"length":0,"stats":{"Line":491339}},{"line":154,"address":[],"length":0,"stats":{"Line":1965356}},{"line":155,"address":[],"length":0,"stats":{"Line":0}}],"covered":49,"coverable":50},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","openclaw.rs"],"content":"//! OpenClaw session parser\n//!\n//! Parses JSONL files from ~/.openclaw/ or ~/.clawdbot/\n//! Uses sessions.json index to find actual session file paths\n\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::collections::HashMap;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n#[derive(Debug, Deserialize)]\nstruct SessionIndex {\n    #[serde(flatten)]\n    sessions: HashMap\u003cString, SessionEntry\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct SessionEntry {\n    #[serde(rename = \"sessionId\")]\n    session_id: String,\n    #[serde(rename = \"sessionFile\")]\n    session_file: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawEntry {\n    #[serde(rename = \"type\")]\n    entry_type: String,\n    message: Option\u003cOpenClawMessage\u003e,\n    #[serde(rename = \"modelId\")]\n    model_id: Option\u003cString\u003e,\n    provider: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawMessage {\n    role: Option\u003cString\u003e,\n    usage: Option\u003cOpenClawUsage\u003e,\n    timestamp: Option\u003ci64\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawUsage {\n    input: Option\u003ci64\u003e,\n    output: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheRead\")]\n    cache_read: Option\u003ci64\u003e,\n    #[serde(rename = \"cacheWrite\")]\n    cache_write: Option\u003ci64\u003e,\n    #[serde(rename = \"totalTokens\")]\n    #[allow(dead_code)]\n    total_tokens: Option\u003ci64\u003e,\n    cost: Option\u003cOpenClawCost\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OpenClawCost {\n    total: Option\u003cf64\u003e,\n}\n\npub fn parse_openclaw_index(index_path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let data = match std::fs::read(index_path) {\n        Ok(d) =\u003e d,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut bytes = data;\n    let index: SessionIndex = match simd_json::from_slice(\u0026mut bytes) {\n        Ok(i) =\u003e i,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let mut all_messages = Vec::new();\n\n    for (_key, entry) in index.sessions {\n        if let Some(session_file) = entry.session_file {\n            let session_path = Path::new(\u0026session_file);\n            if session_path.exists() {\n                let messages = parse_openclaw_session(session_path, \u0026entry.session_id);\n                all_messages.extend(messages);\n            }\n        }\n    }\n\n    all_messages\n}\n\nfn parse_openclaw_session(session_path: \u0026Path, session_id: \u0026str) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(session_path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    // Get file modification time as fallback for missing timestamps\n    let file_mtime_ms = std::fs::metadata(session_path)\n        .and_then(|m| m.modified())\n        .ok()\n        .and_then(|t| t.duration_since(std::time::UNIX_EPOCH).ok())\n        .map(|d| d.as_millis() as i64)\n        .unwrap_or(0);\n\n    let reader = BufReader::new(file);\n    let mut messages = Vec::new();\n    let mut current_model: Option\u003cString\u003e = None;\n    let mut current_provider: Option\u003cString\u003e = None;\n\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        let entry: OpenClawEntry = match simd_json::from_slice(\u0026mut bytes) {\n            Ok(e) =\u003e e,\n            Err(_) =\u003e continue,\n        };\n\n        match entry.entry_type.as_str() {\n            \"model_change\" =\u003e {\n                if let Some(model) = entry.model_id {\n                    current_model = Some(model);\n                }\n                if let Some(provider) = entry.provider {\n                    current_provider = Some(provider);\n                }\n            }\n            \"message\" =\u003e {\n                if let Some(msg) = entry.message {\n                    if msg.role.as_deref() != Some(\"assistant\") {\n                        continue;\n                    }\n\n                    let usage = match msg.usage {\n                        Some(u) =\u003e u,\n                        None =\u003e continue,\n                    };\n\n                    let model = match \u0026current_model {\n                        Some(m) =\u003e m.clone(),\n                        None =\u003e continue,\n                    };\n\n                    let provider = current_provider\n                        .clone()\n                        .unwrap_or_else(|| \"unknown\".to_string());\n                    let timestamp = msg.timestamp.unwrap_or(file_mtime_ms);\n                    let cost = usage.cost.and_then(|c| c.total).unwrap_or(0.0);\n\n                    messages.push(UnifiedMessage::new(\n                        \"openclaw\",\n                        model,\n                        provider,\n                        session_id.to_string(),\n                        timestamp,\n                        TokenBreakdown {\n                            input: usage.input.unwrap_or(0).max(0),\n                            output: usage.output.unwrap_or(0).max(0),\n                            cache_read: usage.cache_read.unwrap_or(0).max(0),\n                            cache_write: usage.cache_write.unwrap_or(0).max(0),\n                            reasoning: 0,\n                        },\n                        cost.max(0.0),\n                    ));\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    messages\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs::File;\n    use std::io::Write;\n    use tempfile::TempDir;\n\n    fn create_test_session(dir: \u0026TempDir, filename: \u0026str, content: \u0026str) -\u003e String {\n        let path = dir.path().join(filename);\n        let mut file = File::create(\u0026path).unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        path.to_string_lossy().to_string()\n    }\n\n    #[test]\n    fn test_parse_openclaw_session_with_model_change() {\n        let dir = TempDir::new().unwrap();\n        let content = r#\"{\"type\":\"model_change\",\"id\":\"abc\",\"provider\":\"openai-codex\",\"modelId\":\"gpt-5.2\"}\n{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":200,\"totalTokens\":350,\"cost\":{\"total\":0.05}},\"timestamp\":1700000000000}}\"#;\n\n        let session_path = create_test_session(\u0026dir, \"session.jsonl\", content);\n        let messages = parse_openclaw_session(Path::new(\u0026session_path), \"test-session\");\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-5.2\");\n        assert_eq!(messages[0].provider_id, \"openai-codex\");\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[0].tokens.output, 50);\n        assert_eq!(messages[0].tokens.cache_read, 200);\n        assert_eq!(messages[0].cost, 0.05);\n    }\n\n    #[test]\n    fn test_parse_openclaw_session_user_messages_ignored() {\n        let dir = TempDir::new().unwrap();\n        let content = r#\"{\"type\":\"model_change\",\"provider\":\"anthropic\",\"modelId\":\"claude-3.5-sonnet\"}\n{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"user\",\"content\":[{\"type\":\"text\",\"text\":\"hello\"}]}}\n{\"type\":\"message\",\"id\":\"msg2\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":50,\"output\":25},\"timestamp\":1700000000000}}\"#;\n\n        let session_path = create_test_session(\u0026dir, \"session.jsonl\", content);\n        let messages = parse_openclaw_session(Path::new(\u0026session_path), \"test-session\");\n\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].tokens.input, 50);\n    }\n\n    #[test]\n    fn test_parse_openclaw_session_no_model_change() {\n        let dir = TempDir::new().unwrap();\n        let content = r#\"{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":100,\"output\":50},\"timestamp\":1700000000000}}\"#;\n\n        let session_path = create_test_session(\u0026dir, \"session.jsonl\", content);\n        let messages = parse_openclaw_session(Path::new(\u0026session_path), \"test-session\");\n\n        assert_eq!(messages.len(), 0);\n    }\n\n    #[test]\n    fn test_parse_openclaw_index() {\n        let dir = TempDir::new().unwrap();\n\n        let session_content = r#\"{\"type\":\"model_change\",\"provider\":\"anthropic\",\"modelId\":\"claude-3.5-sonnet\"}\n{\"type\":\"message\",\"id\":\"msg1\",\"message\":{\"role\":\"assistant\",\"content\":[],\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":0,\"cacheWrite\":0},\"timestamp\":1700000000000}}\"#;\n        let session_path = create_test_session(\u0026dir, \"session-abc.jsonl\", session_content);\n\n        let index_content = format!(\n            r#\"{{\n            \"agent:main:main\": {{\n                \"sessionId\": \"abc-123\",\n                \"sessionFile\": \"{}\"\n            }}\n        }}\"#,\n            session_path.replace('\\\\', \"\\\\\\\\\")\n        );\n\n        let index_path = dir.path().join(\"sessions.json\");\n        let mut file = File::create(\u0026index_path).unwrap();\n        file.write_all(index_content.as_bytes()).unwrap();\n\n        let messages = parse_openclaw_index(\u0026index_path);\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"claude-3.5-sonnet\");\n        assert_eq!(messages[0].session_id, \"abc-123\");\n    }\n}\n","traces":[{"line":63,"address":[],"length":0,"stats":{"Line":3}},{"line":64,"address":[],"length":0,"stats":{"Line":6}},{"line":65,"address":[],"length":0,"stats":{"Line":6}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":6}},{"line":70,"address":[],"length":0,"stats":{"Line":9}},{"line":71,"address":[],"length":0,"stats":{"Line":6}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":6}},{"line":77,"address":[],"length":0,"stats":{"Line":661}},{"line":78,"address":[],"length":0,"stats":{"Line":656}},{"line":79,"address":[],"length":0,"stats":{"Line":981}},{"line":80,"address":[],"length":0,"stats":{"Line":981}},{"line":81,"address":[],"length":0,"stats":{"Line":1635}},{"line":82,"address":[],"length":0,"stats":{"Line":654}},{"line":87,"address":[],"length":0,"stats":{"Line":3}},{"line":90,"address":[],"length":0,"stats":{"Line":330}},{"line":91,"address":[],"length":0,"stats":{"Line":660}},{"line":92,"address":[],"length":0,"stats":{"Line":660}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":990}},{"line":98,"address":[],"length":0,"stats":{"Line":990}},{"line":100,"address":[],"length":0,"stats":{"Line":1320}},{"line":101,"address":[],"length":0,"stats":{"Line":990}},{"line":104,"address":[],"length":0,"stats":{"Line":990}},{"line":105,"address":[],"length":0,"stats":{"Line":660}},{"line":106,"address":[],"length":0,"stats":{"Line":990}},{"line":107,"address":[],"length":0,"stats":{"Line":990}},{"line":109,"address":[],"length":0,"stats":{"Line":7496}},{"line":110,"address":[],"length":0,"stats":{"Line":13672}},{"line":111,"address":[],"length":0,"stats":{"Line":13672}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":13672}},{"line":116,"address":[],"length":0,"stats":{"Line":13672}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":20508}},{"line":121,"address":[],"length":0,"stats":{"Line":20508}},{"line":122,"address":[],"length":0,"stats":{"Line":13672}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":6836}},{"line":127,"address":[],"length":0,"stats":{"Line":6836}},{"line":128,"address":[],"length":0,"stats":{"Line":243}},{"line":129,"address":[],"length":0,"stats":{"Line":81}},{"line":131,"address":[],"length":0,"stats":{"Line":243}},{"line":132,"address":[],"length":0,"stats":{"Line":81}},{"line":135,"address":[],"length":0,"stats":{"Line":6755}},{"line":136,"address":[],"length":0,"stats":{"Line":11122}},{"line":137,"address":[],"length":0,"stats":{"Line":5561}},{"line":138,"address":[],"length":0,"stats":{"Line":2609}},{"line":141,"address":[],"length":0,"stats":{"Line":5904}},{"line":142,"address":[],"length":0,"stats":{"Line":5904}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":5479}},{"line":147,"address":[],"length":0,"stats":{"Line":7581}},{"line":148,"address":[],"length":0,"stats":{"Line":425}},{"line":151,"address":[],"length":0,"stats":{"Line":5054}},{"line":153,"address":[],"length":0,"stats":{"Line":2527}},{"line":154,"address":[],"length":0,"stats":{"Line":10108}},{"line":155,"address":[],"length":0,"stats":{"Line":10108}},{"line":157,"address":[],"length":0,"stats":{"Line":7581}},{"line":159,"address":[],"length":0,"stats":{"Line":2527}},{"line":160,"address":[],"length":0,"stats":{"Line":2527}},{"line":161,"address":[],"length":0,"stats":{"Line":5054}},{"line":162,"address":[],"length":0,"stats":{"Line":2527}},{"line":163,"address":[],"length":0,"stats":{"Line":2527}},{"line":164,"address":[],"length":0,"stats":{"Line":10108}},{"line":165,"address":[],"length":0,"stats":{"Line":10108}},{"line":166,"address":[],"length":0,"stats":{"Line":10108}},{"line":167,"address":[],"length":0,"stats":{"Line":5054}},{"line":168,"address":[],"length":0,"stats":{"Line":2527}},{"line":170,"address":[],"length":0,"stats":{"Line":5054}},{"line":174,"address":[],"length":0,"stats":{"Line":1194}},{"line":178,"address":[],"length":0,"stats":{"Line":330}}],"covered":66,"coverable":73},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","opencode.rs"],"content":"//! OpenCode session parser\n//!\n//! Parses individual JSON files from ~/.local/share/opencode/storage/message/\n\nuse super::{normalize_agent_name, UnifiedMessage};\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::path::Path;\n\n/// OpenCode message structure (from JSON files)\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct OpenCodeMessage {\n    pub id: String,\n    #[serde(rename = \"sessionID\")]\n    pub session_id: String,\n    pub role: String,\n    #[serde(rename = \"modelID\")]\n    pub model_id: Option\u003cString\u003e,\n    #[serde(rename = \"providerID\")]\n    pub provider_id: Option\u003cString\u003e,\n    pub cost: Option\u003cf64\u003e,\n    pub tokens: Option\u003cOpenCodeTokens\u003e,\n    pub time: OpenCodeTime,\n    pub agent: Option\u003cString\u003e,\n    pub mode: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct OpenCodeTokens {\n    pub input: i64,\n    pub output: i64,\n    pub reasoning: Option\u003ci64\u003e,\n    pub cache: OpenCodeCache,\n}\n\n#[derive(Debug, Deserialize)]\npub struct OpenCodeCache {\n    pub read: i64,\n    pub write: i64,\n}\n\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct OpenCodeTime {\n    pub created: f64, // Unix timestamp in milliseconds (as float)\n    pub completed: Option\u003cf64\u003e,\n}\n\npub fn parse_opencode_file(path: \u0026Path) -\u003e Option\u003cUnifiedMessage\u003e {\n    let data = std::fs::read(path).ok()?;\n    let mut bytes = data;\n\n    let msg: OpenCodeMessage = simd_json::from_slice(\u0026mut bytes).ok()?;\n\n    if msg.role != \"assistant\" {\n        return None;\n    }\n\n    let tokens = msg.tokens?;\n    let model_id = msg.model_id?;\n    let agent_or_mode = msg.mode.or(msg.agent);\n    let agent = agent_or_mode.map(|a| normalize_agent_name(\u0026a));\n\n    Some(UnifiedMessage::new_with_agent(\n        \"opencode\",\n        model_id,\n        msg.provider_id.unwrap_or_else(|| \"unknown\".to_string()),\n        msg.session_id.clone(),\n        msg.time.created as i64,\n        TokenBreakdown {\n            input: tokens.input.max(0),\n            output: tokens.output.max(0),\n            cache_read: tokens.cache.read.max(0),\n            cache_write: tokens.cache.write.max(0),\n            reasoning: tokens.reasoning.unwrap_or(0).max(0),\n        },\n        msg.cost.unwrap_or(0.0).max(0.0),\n        agent,\n    ))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_opencode_structure() {\n        let json = r#\"{\n            \"id\": \"msg_123\",\n            \"sessionID\": \"ses_456\",\n            \"role\": \"assistant\",\n            \"modelID\": \"claude-sonnet-4\",\n            \"providerID\": \"anthropic\",\n            \"cost\": 0.05,\n            \"tokens\": {\n                \"input\": 1000,\n                \"output\": 500,\n                \"reasoning\": 100,\n                \"cache\": { \"read\": 200, \"write\": 50 }\n            },\n            \"time\": { \"created\": 1700000000000.0 }\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let msg: OpenCodeMessage = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(msg.model_id, Some(\"claude-sonnet-4\".to_string()));\n        assert_eq!(msg.tokens.unwrap().input, 1000);\n        assert_eq!(msg.agent, None);\n    }\n\n    #[test]\n    fn test_parse_opencode_with_agent() {\n        let json = r#\"{\n            \"id\": \"msg_123\",\n            \"sessionID\": \"ses_456\",\n            \"role\": \"assistant\",\n            \"modelID\": \"claude-sonnet-4\",\n            \"providerID\": \"anthropic\",\n            \"agent\": \"OmO\",\n            \"cost\": 0.05,\n            \"tokens\": {\n                \"input\": 1000,\n                \"output\": 500,\n                \"reasoning\": 100,\n                \"cache\": { \"read\": 200, \"write\": 50 }\n            },\n            \"time\": { \"created\": 1700000000000.0 }\n        }\"#;\n\n        let mut bytes = json.as_bytes().to_vec();\n        let msg: OpenCodeMessage = simd_json::from_slice(\u0026mut bytes).unwrap();\n\n        assert_eq!(msg.agent, Some(\"OmO\".to_string()));\n    }\n\n    #[test]\n    fn test_negative_values_clamped_to_zero() {\n        use std::io::Write;\n\n        let json = r#\"{\n            \"id\": \"msg_negative\",\n            \"sessionID\": \"ses_negative\",\n            \"role\": \"assistant\",\n            \"modelID\": \"claude-sonnet-4\",\n            \"providerID\": \"anthropic\",\n            \"cost\": -0.05,\n            \"tokens\": {\n                \"input\": -100,\n                \"output\": -50,\n                \"reasoning\": -25,\n                \"cache\": { \"read\": -200, \"write\": -10 }\n            },\n            \"time\": { \"created\": 1700000000000.0 }\n        }\"#;\n\n        let mut temp_file = tempfile::Builder::new().suffix(\".json\").tempfile().unwrap();\n        temp_file.write_all(json.as_bytes()).unwrap();\n\n        let result = parse_opencode_file(temp_file.path());\n        assert!(result.is_some(), \"Should parse file with negative values\");\n\n        let msg = result.unwrap();\n        assert_eq!(msg.tokens.input, 0, \"Negative input should be clamped to 0\");\n        assert_eq!(\n            msg.tokens.output, 0,\n            \"Negative output should be clamped to 0\"\n        );\n        assert_eq!(\n            msg.tokens.cache_read, 0,\n            \"Negative cache_read should be clamped to 0\"\n        );\n        assert_eq!(\n            msg.tokens.cache_write, 0,\n            \"Negative cache_write should be clamped to 0\"\n        );\n        assert_eq!(\n            msg.tokens.reasoning, 0,\n            \"Negative reasoning should be clamped to 0\"\n        );\n        assert!(\n            msg.cost \u003e= 0.0,\n            \"Negative cost should be clamped to 0.0, got {}\",\n            msg.cost\n        );\n    }\n}\n","traces":[{"line":50,"address":[],"length":0,"stats":{"Line":605891}},{"line":51,"address":[],"length":0,"stats":{"Line":2423564}},{"line":52,"address":[],"length":0,"stats":{"Line":1211782}},{"line":54,"address":[],"length":0,"stats":{"Line":3029449}},{"line":56,"address":[],"length":0,"stats":{"Line":605885}},{"line":57,"address":[],"length":0,"stats":{"Line":159376}},{"line":60,"address":[],"length":0,"stats":{"Line":893018}},{"line":61,"address":[],"length":0,"stats":{"Line":893018}},{"line":62,"address":[],"length":0,"stats":{"Line":1786036}},{"line":63,"address":[],"length":0,"stats":{"Line":2232543}},{"line":65,"address":[],"length":0,"stats":{"Line":446509}},{"line":67,"address":[],"length":0,"stats":{"Line":446509}},{"line":68,"address":[],"length":0,"stats":{"Line":893018}},{"line":69,"address":[],"length":0,"stats":{"Line":893018}},{"line":70,"address":[],"length":0,"stats":{"Line":446509}},{"line":71,"address":[],"length":0,"stats":{"Line":446509}},{"line":72,"address":[],"length":0,"stats":{"Line":1339527}},{"line":73,"address":[],"length":0,"stats":{"Line":1339527}},{"line":74,"address":[],"length":0,"stats":{"Line":1339527}},{"line":75,"address":[],"length":0,"stats":{"Line":1339527}},{"line":76,"address":[],"length":0,"stats":{"Line":893018}},{"line":78,"address":[],"length":0,"stats":{"Line":1339527}},{"line":79,"address":[],"length":0,"stats":{"Line":446509}}],"covered":23,"coverable":23},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","pi.rs"],"content":"//! Pi (badlogic/pi-mono) session parser\n//!\n//! Parses JSONL files from ~/.pi/agent/sessions/\u003cencoded-cwd\u003e/*.jsonl\n\nuse super::utils::file_modified_timestamp_ms;\nuse super::UnifiedMessage;\nuse crate::TokenBreakdown;\nuse serde::Deserialize;\nuse std::io::{BufRead, BufReader};\nuse std::path::Path;\n\n/// Pi session header (first line of JSONL)\n#[derive(Debug, Deserialize)]\npub struct PiSessionHeader {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    pub id: String,\n    #[allow(dead_code)]\n    pub timestamp: Option\u003cString\u003e,\n    #[allow(dead_code)]\n    pub cwd: Option\u003cString\u003e,\n}\n\n/// Pi session entry (subsequent lines of JSONL)\n#[derive(Debug, Deserialize)]\npub struct PiSessionEntry {\n    #[serde(rename = \"type\")]\n    pub entry_type: String,\n    #[allow(dead_code)]\n    pub id: Option\u003cString\u003e,\n    #[serde(rename = \"parentId\")]\n    #[allow(dead_code)]\n    pub parent_id: Option\u003cString\u003e,\n    pub timestamp: Option\u003cString\u003e,\n    pub message: Option\u003cPiMessage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PiMessage {\n    pub role: Option\u003cString\u003e,\n    pub usage: Option\u003cPiUsage\u003e,\n    pub model: Option\u003cString\u003e,\n    pub provider: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(rename_all = \"camelCase\")]\npub struct PiUsage {\n    pub input: Option\u003ci64\u003e,\n    pub output: Option\u003ci64\u003e,\n    pub cache_read: Option\u003ci64\u003e,\n    pub cache_write: Option\u003ci64\u003e,\n    #[allow(dead_code)]\n    pub total_tokens: Option\u003ci64\u003e,\n}\n\n/// Parse a Pi JSONL session file\npub fn parse_pi_file(path: \u0026Path) -\u003e Vec\u003cUnifiedMessage\u003e {\n    let file = match std::fs::File::open(path) {\n        Ok(f) =\u003e f,\n        Err(_) =\u003e return Vec::new(),\n    };\n\n    let fallback_timestamp = file_modified_timestamp_ms(path);\n\n    let reader = BufReader::new(file);\n    let mut messages: Vec\u003cUnifiedMessage\u003e = Vec::new();\n\n    let mut session_id: Option\u003cString\u003e = None;\n    for line in reader.lines() {\n        let line = match line {\n            Ok(l) =\u003e l,\n            Err(_) =\u003e continue,\n        };\n\n        let trimmed = line.trim();\n        if trimmed.is_empty() {\n            continue;\n        }\n\n        if session_id.is_none() {\n            let mut bytes = trimmed.as_bytes().to_vec();\n            let header = match simd_json::from_slice::\u003cPiSessionHeader\u003e(\u0026mut bytes) {\n                Ok(h) =\u003e h,\n                Err(_) =\u003e return Vec::new(),\n            };\n\n            if header.entry_type != \"session\" {\n                return Vec::new();\n            }\n            session_id = Some(header.id);\n            continue;\n        }\n\n        let mut bytes = trimmed.as_bytes().to_vec();\n        let entry = match simd_json::from_slice::\u003cPiSessionEntry\u003e(\u0026mut bytes) {\n            Ok(e) =\u003e e,\n            Err(_) =\u003e continue,\n        };\n\n        if entry.entry_type != \"message\" {\n            continue;\n        }\n\n        let message = match entry.message {\n            Some(m) =\u003e m,\n            None =\u003e continue,\n        };\n\n        if message.role.as_deref() != Some(\"assistant\") {\n            continue;\n        }\n\n        let usage = match message.usage {\n            Some(u) =\u003e u,\n            None =\u003e continue,\n        };\n\n        let model = match message.model {\n            Some(m) =\u003e m,\n            None =\u003e continue,\n        };\n\n        let provider = match message.provider {\n            Some(p) =\u003e p,\n            None =\u003e continue,\n        };\n\n        let timestamp = entry\n            .timestamp\n            .and_then(|ts| chrono::DateTime::parse_from_rfc3339(\u0026ts).ok())\n            .map(|dt| dt.timestamp_millis())\n            .unwrap_or(fallback_timestamp);\n\n        messages.push(UnifiedMessage::new(\n            \"pi\",\n            model,\n            provider,\n            session_id.clone().unwrap_or_else(|| \"unknown\".to_string()),\n            timestamp,\n            TokenBreakdown {\n                input: usage.input.unwrap_or(0).max(0),\n                output: usage.output.unwrap_or(0).max(0),\n                cache_read: usage.cache_read.unwrap_or(0).max(0),\n                cache_write: usage.cache_write.unwrap_or(0).max(0),\n                reasoning: 0,\n            },\n            0.0,\n        ));\n    }\n\n    messages\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::io::Write;\n    use tempfile::NamedTempFile;\n\n    fn create_test_file(content: \u0026str) -\u003e NamedTempFile {\n        let mut file = NamedTempFile::new().unwrap();\n        file.write_all(content.as_bytes()).unwrap();\n        file.flush().unwrap();\n        file\n    }\n\n    #[test]\n    fn test_parse_pi_jsonl_valid_assistant_message() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_001\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\n{\"type\":\"message\",\"id\":\"msg_001\",\"parentId\":null,\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"assistant\",\"model\":\"claude-3-5-sonnet\",\"provider\":\"anthropic\",\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":10,\"cacheWrite\":5,\"totalTokens\":165}}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].source, \"pi\");\n        assert_eq!(messages[0].session_id, \"pi_ses_001\");\n        assert_eq!(messages[0].model_id, \"claude-3-5-sonnet\");\n        assert_eq!(messages[0].provider_id, \"anthropic\");\n        assert_eq!(messages[0].tokens.input, 100);\n        assert_eq!(messages[0].tokens.output, 50);\n        assert_eq!(messages[0].tokens.cache_read, 10);\n        assert_eq!(messages[0].tokens.cache_write, 5);\n    }\n\n    #[test]\n    fn test_parse_pi_skips_non_assistant_messages() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_002\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\n{\"type\":\"message\",\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"user\",\"model\":\"claude-3-5-sonnet\",\"provider\":\"anthropic\",\"usage\":{\"input\":100,\"output\":50,\"cacheRead\":0,\"cacheWrite\":0,\"totalTokens\":150}}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert!(messages.is_empty());\n    }\n\n    #[test]\n    fn test_parse_pi_skips_missing_usage() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_003\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\n{\"type\":\"message\",\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"assistant\",\"model\":\"claude-3-5-sonnet\",\"provider\":\"anthropic\"}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert!(messages.is_empty());\n    }\n\n    #[test]\n    fn test_parse_pi_skips_malformed_json_lines() {\n        // given\n        let content = r#\"{\"type\":\"session\",\"id\":\"pi_ses_004\",\"timestamp\":\"2026-01-01T00:00:00.000Z\",\"cwd\":\"/tmp\"}\nnot valid json\n{\"type\":\"message\",\"timestamp\":\"2026-01-01T00:00:01.000Z\",\"message\":{\"role\":\"assistant\",\"model\":\"gpt-4o-mini\",\"provider\":\"openai\",\"usage\":{\"input\":10,\"output\":5,\"cacheRead\":0,\"cacheWrite\":0,\"totalTokens\":15}}}\"#;\n        let file = create_test_file(content);\n\n        // when\n        let messages = parse_pi_file(file.path());\n\n        // then\n        assert_eq!(messages.len(), 1);\n        assert_eq!(messages[0].model_id, \"gpt-4o-mini\");\n        assert_eq!(messages[0].provider_id, \"openai\");\n    }\n}\n","traces":[{"line":58,"address":[],"length":0,"stats":{"Line":10}},{"line":59,"address":[],"length":0,"stats":{"Line":20}},{"line":60,"address":[],"length":0,"stats":{"Line":20}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":30}},{"line":66,"address":[],"length":0,"stats":{"Line":30}},{"line":67,"address":[],"length":0,"stats":{"Line":30}},{"line":69,"address":[],"length":0,"stats":{"Line":30}},{"line":70,"address":[],"length":0,"stats":{"Line":81}},{"line":71,"address":[],"length":0,"stats":{"Line":122}},{"line":72,"address":[],"length":0,"stats":{"Line":122}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":122}},{"line":77,"address":[],"length":0,"stats":{"Line":122}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":122}},{"line":82,"address":[],"length":0,"stats":{"Line":30}},{"line":83,"address":[],"length":0,"stats":{"Line":20}},{"line":84,"address":[],"length":0,"stats":{"Line":20}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":10}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":20}},{"line":92,"address":[],"length":0,"stats":{"Line":10}},{"line":95,"address":[],"length":0,"stats":{"Line":153}},{"line":96,"address":[],"length":0,"stats":{"Line":101}},{"line":97,"address":[],"length":0,"stats":{"Line":100}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":50}},{"line":102,"address":[],"length":0,"stats":{"Line":10}},{"line":105,"address":[],"length":0,"stats":{"Line":80}},{"line":106,"address":[],"length":0,"stats":{"Line":80}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":40}},{"line":111,"address":[],"length":0,"stats":{"Line":17}},{"line":114,"address":[],"length":0,"stats":{"Line":45}},{"line":115,"address":[],"length":0,"stats":{"Line":44}},{"line":116,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":44}},{"line":120,"address":[],"length":0,"stats":{"Line":44}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":44}},{"line":125,"address":[],"length":0,"stats":{"Line":44}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":44}},{"line":130,"address":[],"length":0,"stats":{"Line":22}},{"line":131,"address":[],"length":0,"stats":{"Line":88}},{"line":132,"address":[],"length":0,"stats":{"Line":66}},{"line":133,"address":[],"length":0,"stats":{"Line":44}},{"line":135,"address":[],"length":0,"stats":{"Line":66}},{"line":137,"address":[],"length":0,"stats":{"Line":22}},{"line":138,"address":[],"length":0,"stats":{"Line":22}},{"line":139,"address":[],"length":0,"stats":{"Line":66}},{"line":140,"address":[],"length":0,"stats":{"Line":22}},{"line":141,"address":[],"length":0,"stats":{"Line":22}},{"line":142,"address":[],"length":0,"stats":{"Line":88}},{"line":143,"address":[],"length":0,"stats":{"Line":88}},{"line":144,"address":[],"length":0,"stats":{"Line":88}},{"line":145,"address":[],"length":0,"stats":{"Line":44}},{"line":146,"address":[],"length":0,"stats":{"Line":22}},{"line":152,"address":[],"length":0,"stats":{"Line":10}}],"covered":53,"coverable":61},{"path":["/","Users","junhoyeo","tokscale-2","crates","tokscale-core","src","sessions","utils.rs"],"content":"//! Shared parsing helpers for session logs.\n\nuse serde_json::Value;\nuse std::path::Path;\nuse std::time::SystemTime;\n\npub(crate) fn extract_i64(value: Option\u003c\u0026Value\u003e) -\u003e Option\u003ci64\u003e {\n    value.and_then(|val| {\n        val.as_i64()\n            .or_else(|| val.as_u64().map(|v| v as i64))\n            .or_else(|| val.as_str().and_then(|s| s.parse::\u003ci64\u003e().ok()))\n    })\n}\n\npub(crate) fn extract_string(value: Option\u003c\u0026Value\u003e) -\u003e Option\u003cString\u003e {\n    value.and_then(|val| val.as_str().map(|s| s.to_string()))\n}\n\npub(crate) fn parse_timestamp_value(value: \u0026Value) -\u003e Option\u003ci64\u003e {\n    if let Some(ts) = value.as_str() {\n        return parse_timestamp_str(ts);\n    }\n\n    let numeric = value\n        .as_i64()\n        .or_else(|| value.as_u64().map(|v| v as i64))?;\n    // Heuristic: values \u003e= 1e12 are treated as milliseconds, smaller values as seconds.\n    if numeric \u003e= 1_000_000_000_000 {\n        Some(numeric)\n    } else {\n        Some(numeric * 1000)\n    }\n}\n\npub(crate) fn parse_timestamp_str(value: \u0026str) -\u003e Option\u003ci64\u003e {\n    if let Ok(dt) = chrono::DateTime::parse_from_rfc3339(value) {\n        return Some(dt.timestamp_millis());\n    }\n\n    if let Ok(numeric) = value.parse::\u003ci64\u003e() {\n        if numeric \u003e= 1_000_000_000_000 {\n            return Some(numeric);\n        }\n        return Some(numeric * 1000);\n    }\n\n    None\n}\n\npub(crate) fn file_modified_timestamp_ms(path: \u0026Path) -\u003e i64 {\n    std::fs::metadata(path)\n        .and_then(|meta| meta.modified())\n        .ok()\n        .and_then(|time| time.duration_since(SystemTime::UNIX_EPOCH).ok())\n        .map(|duration| duration.as_millis() as i64)\n        .unwrap_or_else(|| chrono::Utc::now().timestamp_millis())\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":27}},{"line":8,"address":[],"length":0,"stats":{"Line":73}},{"line":9,"address":[],"length":0,"stats":{"Line":38}},{"line":10,"address":[],"length":0,"stats":{"Line":19}},{"line":11,"address":[],"length":0,"stats":{"Line":19}},{"line":15,"address":[],"length":0,"stats":{"Line":157}},{"line":16,"address":[],"length":0,"stats":{"Line":354}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":20,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":2}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":1764}},{"line":51,"address":[],"length":0,"stats":{"Line":3528}},{"line":52,"address":[],"length":0,"stats":{"Line":5292}},{"line":54,"address":[],"length":0,"stats":{"Line":7056}},{"line":55,"address":[],"length":0,"stats":{"Line":5292}},{"line":56,"address":[],"length":0,"stats":{"Line":1764}}],"covered":19,"coverable":29},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","ref-cast-1857e63b21a95446","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","ref-cast-7939b7e7acc3e71e","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde-665f6ab63001e214","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde-dde27930001b779e","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde_core-09521bb1b8098d69","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","serde_core-8eddb0ff265402db","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","thiserror-4d0e29a2b88c31e4","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","aarch64-apple-darwin","release","build","thiserror-e309592d4eb83dc1","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","ref-cast-78f9f9ca79b61740","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","ref-cast-eb37870212ac28fd","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde-10a694e452197c04","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde-e3c3562ee00ca109","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde_core-487cb66012287aa7","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","serde_core-498164a011434064","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","thiserror-65d3345fc07e6d75","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","debug","build","thiserror-b9b7135a3bfc1f54","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","ref-cast-d880b57f0fb530d4","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private25 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","serde-0c575a0a454094dd","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\nuse serde_core::__private228 as serde_core_private;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","serde_core-1e62b028c28d8306","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private228 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","junhoyeo","tokscale-2","packages","core","target","release","build","thiserror-718e39c79d0a4b8a","out","private.rs"],"content":"#[doc(hidden)]\npub mod __private17 {\n    #[doc(hidden)]\n    pub use crate::private::*;\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, 'ðŸŒ™'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = 'ðŸŒ™';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = 'â˜€ï¸';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = 'ðŸŒ™';
    }
  });
})();
</script>
</body>
</html>